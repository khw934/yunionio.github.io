<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloudpods –
虚拟机</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/</link><description>Recent content in 虚拟机 on Cloudpods</description><generator>Hugo -- gohugo.io</generator><lastBuildDate>Fri, 19 Jul 2019 10:26:40 +0800</lastBuildDate><atom:link href="https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: 新建本地IDC虚拟机</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/create/</link><pubDate>Fri, 19 Jul 2019 15:22:33 +0800</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/create/</guid><description>
&lt;h3 id="前提条件">前提条件&lt;/h3>
&lt;ul>
&lt;li>如需创建内置私有云虚拟机，请确保环境中存在启用状态的宿主机。&lt;/li>
&lt;li>如需创建VMware平台虚拟机，请确保环境中已添加了VMware账号。&lt;/li>
&lt;/ul>
&lt;h3 id="climc操作">climc操作&lt;/h3>
&lt;p>&lt;code>climc server-create&lt;/code> 命令提供创建云主机的操作。 Cloudpods 可以同时管理多个私有云和公有云，不同供应商有各自的认证方式，在创建云主机之前需要做一些不同的准备工作。&lt;/p>
&lt;p>创建机器命令为 &lt;code>server-create&lt;/code>，可以使用 &lt;code>climc server-create --help&lt;/code> 查看创建 server 的所有参数，常用的参数如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">参数名称&lt;/th>
&lt;th style="text-align:center">类型&lt;/th>
&lt;th style="text-align:center">作用&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;ncpu&lt;/td>
&lt;td style="text-align:center">int&lt;/td>
&lt;td style="text-align:center">虚拟机 cpu 个数&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;disk&lt;/td>
&lt;td style="text-align:center">[]string&lt;/td>
&lt;td style="text-align:center">指定创建的系统盘镜像，指定多次表示虚拟机创建多块磁盘&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;net&lt;/td>
&lt;td style="text-align:center">[]string&lt;/td>
&lt;td style="text-align:center">指定虚拟机使用的网络，指定多次将在虚拟机里面添加多个网卡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;allow-delete&lt;/td>
&lt;td style="text-align:center">bool&lt;/td>
&lt;td style="text-align:center">允许删除虚拟机&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;auto-start&lt;/td>
&lt;td style="text-align:center">bool&lt;/td>
&lt;td style="text-align:center">创建完自动启动&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;password&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">设置虚拟机密码&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;tenant&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">创建到指定的项目&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;prefer-region&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">创建到指定的 region&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;prefer-zone&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">创建到指定的 zone&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;prefer-host&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">创建到指定的 host&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ol>
&lt;li>名称、内存或者套餐类型在创建主机时必须使用;&lt;/li>
&lt;li>系统盘的镜像通过 &lt;code>image-list&lt;/code> 或者 &lt;code>cached-image-list&lt;/code>，公有云的镜像列表通过 &lt;code>cached-image-list&lt;/code> 接口查询，参考: &lt;a href="../../../../function_principle/onpremise/glance/sysimage/show/#%E6%9F%A5%E8%AF%A2%E9%95%9C%E5%83%8F">查询镜像&lt;/a>;&lt;/li>
&lt;/ol>
&lt;/div>
&lt;p>下面以举例的方式创建机器：&lt;/p>
&lt;p>待创建规格:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>名称&lt;/th>
&lt;th>平台&lt;/th>
&lt;th>套餐&lt;/th>
&lt;th>内存&lt;/th>
&lt;th>cpu&lt;/th>
&lt;th>系统盘&lt;/th>
&lt;th>网络&lt;/th>
&lt;th>其他&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>vm1&lt;/td>
&lt;td>kvm&lt;/td>
&lt;td>-&lt;/td>
&lt;td>4g&lt;/td>
&lt;td>4&lt;/td>
&lt;td>centos7.qcow2 60g&lt;/td>
&lt;td>net1&lt;/td>
&lt;td>2块数据盘， 一块100g ext4 挂载到 /opt，另外一块 50g xfs 挂载到 /data; 自动启动&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>vm2&lt;/td>
&lt;td>esxi&lt;/td>
&lt;td>-&lt;/td>
&lt;td>2g&lt;/td>
&lt;td>2&lt;/td>
&lt;td>ubuntu18.04.qcow2 100g&lt;/td>
&lt;td>net2&lt;/td>
&lt;td>允许删除&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>vm3&lt;/td>
&lt;td>opnstack&lt;/td>
&lt;td>t2.nano&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;td>centos6.qcow2&lt;/td>
&lt;td>net3&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 创建 kvm vm1&lt;/span>
$ climc server-create --hypervisor kvm --disk centos7.qcow2:60g --disk 100g:ext4:/opt --disk 50g:xfs:/data --ncpu &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span> --net net1 --auto-start vm1 --mem-spec 4g
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="主机名表达式举例说明">主机名表达式举例说明&lt;/h3>
&lt;p>主机（包括虚拟机和裸金属）名称支持表达式，表达式格式为：${变量名}，变量名需要小写。如${host}，则虚拟机名称显示为创建虚拟机的宿主机的名称；${region}-${zone}，则显示为区域名-可用区名称等。&lt;/p>
&lt;p>支持的变量名如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>变量名&lt;/th>
&lt;th>举例&lt;/th>
&lt;th>说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>brand&lt;/td>
&lt;td>aliyun&lt;/td>
&lt;td>品牌&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>charge_type&lt;/td>
&lt;td>postpaid&lt;/td>
&lt;td>计费方式&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloud_env&lt;/td>
&lt;td>onpremise/public/private&lt;/td>
&lt;td>用于区分本地IDC、私有云和公有云平台&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloudregion_id&lt;/td>
&lt;td>default&lt;/td>
&lt;td>区域id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cpu&lt;/td>
&lt;td>1&lt;/td>
&lt;td>CPU数量&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>host&lt;/td>
&lt;td>gobuild&lt;/td>
&lt;td>主机名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>host_id&lt;/td>
&lt;td>16f49f8a-88cc-4715-8870-f78130196fa9&lt;/td>
&lt;td>主机id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ip_addr&lt;/td>
&lt;td>192.168.1.1&lt;/td>
&lt;td>IP地址&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>mem&lt;/td>
&lt;td>1024&lt;/td>
&lt;td>内存&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>os_distribution&lt;/td>
&lt;td>操作系统&lt;/td>
&lt;td>CentOS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>os_type&lt;/td>
&lt;td>Linux&lt;/td>
&lt;td>操作系统类型&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>os_version&lt;/td>
&lt;td>6.9&lt;/td>
&lt;td>操作系统版本&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>owner_tenant&lt;/td>
&lt;td>system&lt;/td>
&lt;td>项目&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>owner_tenant_id&lt;/td>
&lt;td>d56f5c37e36a42b782d7f32b19497c4c&lt;/td>
&lt;td>项目id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>provider&lt;/td>
&lt;td>OpenStack&lt;/td>
&lt;td>提供方&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>region&lt;/td>
&lt;td>Default&lt;/td>
&lt;td>区域&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>region_id&lt;/td>
&lt;td>kvm&lt;/td>
&lt;td>虚拟化方式&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>res_name&lt;/td>
&lt;td>server&lt;/td>
&lt;td>资源类别&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>template_id&lt;/td>
&lt;td>5199f56b-01c2-425c-8e29-0179d283e4a3&lt;/td>
&lt;td>模板id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>zone&lt;/td>
&lt;td>zone1&lt;/td>
&lt;td>可用区&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>zone_id&lt;/td>
&lt;td>00f3f3c6-1d16-4053-81f1-4cb092f418f5&lt;/td>
&lt;td>可用区id&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>Docs: 登录虚拟机</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/connect/</link><pubDate>Fri, 19 Jul 2019 17:38:36 +0800</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/connect/</guid><description>
&lt;p>创建好虚拟机后，登录的方式大概分为以下几种：&lt;/p>
&lt;ul>
&lt;li>ssh: linux 通用，要求虚拟机网络可达;&lt;/li>
&lt;li>rdp: windows 远程桌面，要求虚拟机网络可达；可通过RDP对应的客户端连接Windows操作系统的虚拟机。&lt;/li>
&lt;li>vnc: vnc 链接，对虚拟机网络没有要求，只要能链接云平台 vnc proxy 即可;&lt;/li>
&lt;/ul>
&lt;h2 id="climc操作">climc操作&lt;/h2>
&lt;p>针对以上的链接方式，我们提供以下接口链接云虚拟机：&lt;/p>
&lt;h3 id="远程终端">远程终端&lt;/h3>
&lt;p>&lt;code>climc webconsole-server&lt;/code> 命令提供通过 vnc或spice协议 连接虚拟机，该方式对裸金属服务器不可用。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc webconsole-server &amp;lt;server_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ssh远程终端">SSH远程终端&lt;/h3>
&lt;p>查询 server 的 ip&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 可通过 server-list --search --details 的方式找到虚拟机的 ip&lt;/span>
$ climc server-list --search &amp;lt;server_name&amp;gt; --details
&lt;span style="color:#8f5902;font-style:italic"># 或者通过 server-show &amp;lt;server_id&amp;gt; 的方式得到 ip&lt;/span>
$ climc server-show &amp;lt;server_name&amp;gt; &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep ip
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ips &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10.168.222.226 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>查询 server 的登录信息&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-logininfo &amp;lt;server_name&amp;gt;
+----------+-----------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Field &lt;span style="color:#000;font-weight:bold">|&lt;/span> Value &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------+-----------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> password &lt;span style="color:#000;font-weight:bold">|&lt;/span> @2aWXB6AmCbV &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> updated &lt;span style="color:#000;font-weight:bold">|&lt;/span> 2019-07-03T10:00:20.801716Z &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> username &lt;span style="color:#000;font-weight:bold">|&lt;/span> root &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------+-----------------------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ssh 登录&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ssh root@10.168.222.226
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过 webconsole 登录&lt;/p>
&lt;pre>&lt;code>$ climc webconsole-ssh 10.168.222.226
https://console.yunion.cn/web-console?access_token=y7bjpBwtvJHLHpwOUMzNVvsYiAgY1vskIuVwB-aINfH4mm8MsZqwxKSfHqm2pCvY6O8bBA%3D%3D&amp;amp;api_server=https%3A%2F%2Foffice.yunion.io&amp;amp;protocol=tty
&lt;/code>&lt;/pre>&lt;p>在浏览器打开 webconsole 放回的 url ，就会到对应虚拟机的登录界面&lt;/p>
&lt;p>&lt;img src="../../images/webssh.png" alt="">&lt;/p></description></item><item><title>Docs: 删除</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/delete/</link><pubDate>Fri, 19 Jul 2019 17:32:09 +0800</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/delete/</guid><description>
&lt;h2 id="climc操作">climc操作&lt;/h2>
&lt;h3 id="解除删除保护">解除删除保护&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-update --delete &lt;span style="color:#204a87">enable&lt;/span> &amp;lt;server_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="删除">删除&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 删除至回收站&lt;/span>
$ climc server-delete &amp;lt;server_id&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 彻底删除&lt;/span>
$ climc server-delete -f &amp;lt;server_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: qga 使用介绍</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/qga/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/qga/</guid><description>
&lt;h2 id="功能介绍">功能介绍&lt;/h2>
&lt;p>使用 &lt;a href="https://wiki.qemu.org/Features/GuestAgent">qemu guest agent&lt;/a> 来操作虚拟机或者查看虚拟机的信息。&lt;/p>
&lt;h2 id="安装部署">安装部署&lt;/h2>
&lt;p>不同版本的操作系统安装方式不同，启动方式不同，以下列出一些操作系统安装方式。&lt;/p>
&lt;h3 id="linux-安装启动">linux 安装启动&lt;/h3>
&lt;pre>&lt;code>安装：
Debian : apt-get install qemu-guest-agent
Ubuntu : apt-get install qemu-guest-agent
Alpine : apk add qemu-guest-agent
Arch Linux : pacman -S qemu-guest-agent
Kali Linux : apt-get install qemu-guest-agent
Fedora :dnf install qemu-guest-agent-2
Raspbian : apt-get install qemu-guest-agent
systemd 启动或其他启动方式:
systemctl enable --now qemu-guest-agent
启动完成后可以在虚机内查看到 qemu-ga 的进程
例如 centos7 下，ps 可以看到 qemu-ga进程启动，并且禁用了一下命令:
/usr/bin/qemu-ga --method=virtio-serial --path=/dev/virtio-ports/org.qemu.guest_agent.0 --blacklist=guest-file-open,guest-file-close,guest-file-read,guest-file-write,guest-file-seek,guest-file-flush,guest-exec,guest-exec-status -F/etc/qemu-ga/fsfreeze-hook
centos7 下 blacklist 配置是在 /etc/sysconfig/qemu-ga 下面
$ cat /etc/sysconfig/qemu-ga | grep BLACKLIST_RPC
BLACKLIST_RPC=guest-file-open,guest-file-close,guest-file-read,guest-file-write,guest-file-seek,guest-file-flush,guest-exec,guest-exec-status
&lt;/code>&lt;/pre>&lt;h3 id="windows-安装启动">windows 安装启动&lt;/h3>
&lt;p>windows 需要挂载 virtio-win 的 iso, 打开 iso 找到 guest-agent 目录 安装对应的 guest-agent.&lt;/p>
&lt;h2 id="使用介绍">使用介绍&lt;/h2>
&lt;p>执行 qga 命令需要确保虚机为 running(运行中) 的状态。若虚机内 guest-agent 未安装，则执行的命令会超时失败。&lt;/p>
&lt;h3 id="执行任意-qga-命令">执行任意 qga 命令&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-qga-command --help
Usage: climc server-qga-command &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--help&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &amp;lt;ID&amp;gt; &amp;lt;COMMAND&amp;gt;
Qga-Command server
Positional arguments:
&amp;lt;ID&amp;gt;
ID or name of the server
&amp;lt;COMMAND&amp;gt;
qga &lt;span style="color:#204a87">command&lt;/span>
Optional arguments:
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--help&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Print usage and this &lt;span style="color:#204a87">help&lt;/span> message and exit.
&lt;span style="color:#8f5902;font-style:italic"># 例如执行 guest-info 命令来获取 qga 的信息，包括 qga 版本，qga 支持的命令信息。&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 这是一个有用的命令来获取虚机内的 qga 支持和禁用了哪些操作。&lt;/span>
$ climc server-qga-command test-server &lt;span style="color:#4e9a06">&amp;#39;{&amp;#34;execute&amp;#34;: &amp;#34;guest-info&amp;#34;}&amp;#39;&lt;/span>
supported_commands:
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-sync-delimited
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-sync
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-suspend-ram
success-response: &lt;span style="color:#204a87">false&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-suspend-hybrid
success-response: &lt;span style="color:#204a87">false&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-suspend-disk
success-response: &lt;span style="color:#204a87">false&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-shutdown
success-response: &lt;span style="color:#204a87">false&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-set-vcpus
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-set-user-password
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-set-time
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-set-memory-blocks
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-ping
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-network-get-interfaces
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-info
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-get-vcpus
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-get-users
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-get-timezone
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-get-time
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-get-osinfo
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-get-memory-blocks
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-get-memory-block-info
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-get-host-name
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-get-fsinfo
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-fstrim
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-fsfreeze-thaw
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-fsfreeze-status
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-fsfreeze-freeze-list
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-fsfreeze-freeze
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-file-write
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-file-seek
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-file-read
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-file-open
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-file-flush
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-file-close
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-exec-status
success-response: &lt;span style="color:#204a87">true&lt;/span>
- enabled: &lt;span style="color:#204a87">true&lt;/span>
name: guest-exec
success-response: &lt;span style="color:#204a87">true&lt;/span>
version: 2.11.1
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="qga-设置密码">qga 设置密码&lt;/h2>
&lt;p>cloudpods 封装了 qga 设置密码的操作。
云平台会对密码的强度校验，并且会将设置完的密码加密后保存在元数据中以供后续查询。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-qga-set-password --help
Usage: climc server-qga-set-password &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--help&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &amp;lt;ID&amp;gt; &amp;lt;USERNAME&amp;gt; &amp;lt;PASSWORD&amp;gt;
Qga-Set-Password server
Positional arguments:
&amp;lt;ID&amp;gt;
ID or name of the server
&amp;lt;USERNAME&amp;gt;
Which user to &lt;span style="color:#204a87">set&lt;/span> password
&amp;lt;PASSWORD&amp;gt;
Password content
Optional arguments:
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--help&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Print usage and this &lt;span style="color:#204a87">help&lt;/span> message and exit.
&lt;span style="color:#8f5902;font-style:italic"># eg:&lt;/span>
climc server-qga-set-password test-server root testPassword@1234
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 迁移相关</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/migrate/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/migrate/</guid><description>
&lt;h2 id="介绍">介绍&lt;/h2>
&lt;p>目前迁移功能主要用于 Cloudpods 内置私有云的虚拟机上，该功能用于将虚拟机迁移到其他宿主机上面。当未指定宿主机时，系统将自动选择宿主机。&lt;/p>
&lt;p>迁移的方式分为“冷迁移”和“热迁移”，区别如下：&lt;/p>
&lt;ul>
&lt;li>冷迁移：在虚拟机&lt;strong>关机的状态&lt;/strong>下，将虚拟机磁盘从源宿主机拷贝到目标宿主机。&lt;/li>
&lt;li>热迁移：在虚拟机&lt;strong>运行的状态&lt;/strong>下，将虚拟机的磁盘以及内存状态同步到目标宿主机，当两边数据同步后，再将虚拟机切换到目标宿主机。&lt;/li>
&lt;/ul>
&lt;p>热迁移和冷迁移比起来，能够在不关机，保证业务运行的情况下，将虚拟机从一台宿主机迁移到另一台宿主机。&lt;/p>
&lt;p>但热迁移默认要求目标宿主机和源宿主机的 CPU 型号与 CPU microcode 一致，可以通过以下命令查看 CPU 的型号和 microcode：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ cat /proc/cpuinfo &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -e &lt;span style="color:#4e9a06">&amp;#39;model name&amp;#39;&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#39;microcode&amp;#39;&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> sort &lt;span style="color:#000;font-weight:bold">|&lt;/span> uniq
microcode : 0x42e
model name : Intel&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>R&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> Xeon&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>R&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> CPU E5-2650 v2 @ 2.60GHz
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="climc">Climc&lt;/h2>
&lt;h3 id="冷迁移">冷迁移&lt;/h3>
&lt;p>虚拟机在关机状态下，可以执行冷迁移操作。&lt;/p>
&lt;h4 id="查看冷迁移帮助信息">查看冷迁移帮助信息&lt;/h4>
&lt;p>冷迁移的命令为 &lt;code>climc server-migrate&lt;/code>，通过下面的命令可以查看参数的说明和帮助信息：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-migrate --help
Usage: climc server-migrate &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--auto-start&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--rescue-mode&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--prefer-host PREFER_HOST&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &amp;lt;ID&amp;gt;
Migrate server
Positional arguments:
&amp;lt;ID&amp;gt;
ID of server
Optional arguments:
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--auto-start&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Server auto start after migrate
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--rescue-mode&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Migrate server in rescue mode, all disks must reside on shared storage
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--prefer-host PREFER_HOST&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Server migration prefer host id or name
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="冷迁移举例">冷迁移举例&lt;/h4>
&lt;ul>
&lt;li>对已经关机的虚拟机 vm1 进行迁移&lt;/li>
&lt;/ul>
&lt;pre>&lt;code># 先查看虚拟机的信息
$ climc server-list --search vm1 --details
# 执行随机迁移
$ climc server-migrate vm1
# 迁移过程中虚拟机会处于 migrating 的状态
$ climc server-list --search vm1
# 迁移完成后虚拟机状态变为 ready，并且可以发现宿主机信息也发生了变化
$ climc server-list --search vm1 --details
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>迁移到指定宿主机&lt;/li>
&lt;/ul>
&lt;pre>&lt;code># 先列出平台的 kvm 宿主机
$ climc host-list --hypervisor kvm
# 然后指定宿主机名称或者 id 迁移
$ climc server-migrate --prefer-host xxx vm1
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>迁移后自动启动虚拟机&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>$ climc server-migrate --auto-start vm1
$ climc server-migrate --auto-start --prefer-host xxx vm1
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>rescue mode 迁移：当宿主机完全宕机，虚拟机所有的磁盘都使用共享存储（ceph 等分布式块存储）的情况下，可以通过 rescue mode 把元数据迁移到另外的宿主机，然后启动&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-migrate --rescue-mode &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --auto-start &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host &lt;span style="color:#000">$host_name&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> &lt;span style="color:#000">$vm_name&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="热迁移">热迁移&lt;/h3>
&lt;p>虚拟机在运行状态进行的迁移叫做热迁移，热迁移的速度会比冷迁移慢，因为设计磁盘和内存等状态的同步，但好处是在不关机的状态下进行迁移，基本上对虚拟机上运行的业务没有影响。&lt;/p>
&lt;h4 id="查看热迁移帮助信息">查看热迁移帮助信息&lt;/h4>
&lt;p>热迁移的命令为 &lt;code>climc server-live-migrate&lt;/code>，通过下面的命令查看帮助信息：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-live-migrate --help
Usage: climc server-live-migrate &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--skip-cpu-check&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--skip-kernel-check&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--enable-tls&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--quickly-finish&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--max-bandwidth-mb MAX_BANDWIDTH_MB&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--keep-dest-guest-on-failed&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--help&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--prefer-host PREFER_HOST&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &amp;lt;ID&amp;gt;
Live-Migrate server
Positional arguments:
&amp;lt;ID&amp;gt;
ID of server
Optional arguments:
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--skip-cpu-check&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Skip check CPU mode of the target host
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--skip-kernel-check&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Skip target kernel version check
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--enable-tls&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Enable tls migration
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--quickly-finish&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
quickly finish, fix downtime after a few rounds of memory synchronization
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--max-bandwidth-mb MAX_BANDWIDTH_MB&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
live migrate downtime, unit MB
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--keep-dest-guest-on-failed&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">do&lt;/span> not delete dest guest on migrate failed, &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> debug
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--help&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Print usage and this &lt;span style="color:#204a87">help&lt;/span> message and exit.
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--prefer-host PREFER_HOST&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Server migration prefer host id or name
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="热迁移举例">热迁移举例&lt;/h4>
&lt;ul>
&lt;li>对虚拟机 vm1 进行热迁移，目标宿主机随机选择&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-live-migrate vm1
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>热迁移默认要求目标宿主机和虚拟机当前所在的宿主机 CPU 、内核版本等一致， 如果不一致该宿主机则会被调度器过滤掉，如果环境里面实在没有 CPU 一致的目标宿主机，可以使用 &lt;code>--skip-cpu-check&lt;/code> 绕过 CPU 的检查。默认不限制热迁移的带宽。默认 Downtime 最大是 300ms。&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-live-migrate --skip-cpu-check vm1
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>指定 vm1 热迁移到目标宿主机 host1 ，并且绕过 CPU 检查&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-live-migrate &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host host1 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --skip-cpu-check &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> vm1
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>指定 vm1 热迁移到目标宿主机 host1 ，并且绕过 CPU 检查，并且限制热迁移带宽(最低 100 MB/s)&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-live-migrate &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host host1 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --skip-cpu-check &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --max-bandwidth-mb &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> vm1
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>指定 vm1 热迁移到目标宿主机 host1 ，并且绕过 CPU 检查，并且限制热迁移带宽和打开快速收敛。快速收敛是让虚机内存拷贝一定轮次后调整热迁移 downtime 让热迁移完成最后一次拷贝。&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-live-migrate &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host host1 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --skip-cpu-check &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --max-bandwidth-mb &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --quickly-finish &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> vm1
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="宿主机宕机自动迁移">宿主机宕机自动迁移&lt;/h3>
&lt;h4 id="原理">原理&lt;/h4>
&lt;p>宿主机宕机自动迁移会自动检测宿主机的在线状况，当控制器（region）检测到宿主机离线，则会自动将宿主机上使用共享存储的虚拟机在别的宿主机上启动起来。宿主机宕机检测原理是 host会维持 etcd 上的一个 key (路径为：/onecloud/kvm/host/health/&amp;lt;host_id&amp;gt;)，region会watch这个key，一旦host离线，这个key会超时删除，region检测到这个事件后，开始把host上的共享存储主机强制迁移到别的宿主机。&lt;/p>
&lt;h4 id="开启宕机自动迁移">开启宕机自动迁移&lt;/h4>
&lt;p>通过如下步骤开启宕机自动迁移：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc host-auto-migrate-on-host-down --help
Usage: climc host-auto-migrate-on-host-down &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--auto-migrate-on-host-shutdown &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>enable,disable&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--help&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--auto-migrate-on-host-down &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>enable,disable&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span> &amp;lt;ID&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 分为宕机自动迁移和关机自动迁移，要打开关机自动迁移必须同时打开宕机自动迁移&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 只打开宕机自动迁移&lt;/span>
$ climc host-auto-migrate-on-host-down --auto-migrate-on-host-down &lt;span style="color:#204a87">enable&lt;/span> &amp;lt;host_id&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 同时打开关机自动迁移和宕机自动迁移&lt;/span>
$ climc host-auto-migrate-on-host-down --auto-migrate-on-host-down &lt;span style="color:#204a87">enable&lt;/span> --auto-migrate-on-host-shutdown &lt;span style="color:#204a87">enable&lt;/span> &amp;lt;host_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: GPU 相关</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/gpu/</link><pubDate>Fri, 19 Jul 2019 18:32:40 +0800</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/gpu/</guid><description>
&lt;p>目前仅支持 Cloudpods kvm 虚拟机使用 GPU，使用的 PCI Passthrough 的方式将宿主机上的 Nvidia/AMD GPU 透传给虚拟机使用。&lt;/p>
&lt;h2 id="climc">Climc&lt;/h2>
&lt;h3 id="创建-gpu-云主机">创建 GPU 云主机&lt;/h3>
&lt;ul>
&lt;li>查询 gpu 列表&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc isolated-device-list --gpu
+--------------------------------------+----------+---------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Dev_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Model &lt;span style="color:#000;font-weight:bold">|&lt;/span> Addr &lt;span style="color:#000;font-weight:bold">|&lt;/span> Vendor_device_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host_id &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+---------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 273f4f72-06b6-49aa-8456-4beceec44997 &lt;span style="color:#000;font-weight:bold">|&lt;/span> GPU-HPC &lt;span style="color:#000;font-weight:bold">|&lt;/span> GeForce GTX &lt;span style="color:#0000cf;font-weight:bold">1050&lt;/span> Ti &lt;span style="color:#000;font-weight:bold">|&lt;/span> 41:00.0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10de:1c82 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 3bce9607-2597-469f-8d9b-977345456739 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> a77333e9-08d9-45c6-87eb-a7d8d902c5f5 &lt;span style="color:#000;font-weight:bold">|&lt;/span> GPU-HPC &lt;span style="color:#000;font-weight:bold">|&lt;/span> Quadro FX &lt;span style="color:#0000cf;font-weight:bold">580&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> 05:00.0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10de:0659 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 3bce9607-2597-469f-8d9b-977345456739 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+---------------------+---------+------------------+--------------------------------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>创建 server&lt;/li>
&lt;/ul>
&lt;p>server-create 中的 &lt;code>--isolated-device&lt;/code> 参数指定透传的设备到云主机，可以重复使用多次，透传多个 gpu 到云主机，但要求透传到同一云主机的 gpu 必须在同一宿主机。其余创建参数和创建普通云主机是一样的。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-create --hypervisor kvm --isolated-device 273f4f72-06b6-49aa-8456-4beceec44997 ...
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="查询-gpu-云主机">查询 GPU 云主机&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-list --gpu
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="关联-gpu">关联 GPU&lt;/h3>
&lt;p>如果云主机所在的宿主机有可用的 gpu，在主机关机的情况下，可以通过 &lt;code>server-attach-isolated-device&lt;/code> 命令将 gpu 和云主机关联起来，下次主机启动后就可以使用该 gpu 。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-attach-isolated-device &amp;lt;server_id&amp;gt; &amp;lt;device_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="卸载-gpu">卸载 GPU&lt;/h3>
&lt;p>如果云主机关联了 gpu，可以通过 &lt;code>server-detach-isolated-device&lt;/code> 卸载主机的某一 gpu。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-detach-isolated-device &amp;lt;server_id&amp;gt; &amp;lt;device_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: USB 透传</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/usb-passthrough/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/usb-passthrough/</guid><description>
&lt;p>支持版本：&amp;gt;=3.8&lt;/p>
&lt;p>目前只有内置私有云平台的虚拟机可以使用宿主机上的 USB 设备。前提条件是宿主机需要有 &lt;code>lsusb&lt;/code> 这个工具，如果没有请安装 &lt;code>usbutils&lt;/code> 这个包。&lt;/p>
&lt;h2 id="配置宿主机">配置宿主机&lt;/h2>
&lt;p>查看宿主机上的 USB 设备，命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ lsusb
Bus &lt;span style="color:#0000cf;font-weight:bold">002&lt;/span> Device 002: ID 0951:1666 Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50
Bus &lt;span style="color:#0000cf;font-weight:bold">002&lt;/span> Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus &lt;span style="color:#0000cf;font-weight:bold">001&lt;/span> Device 002: ID 0627:0001 Adomax Technology Co., Ltd
Bus &lt;span style="color:#0000cf;font-weight:bold">001&lt;/span> Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
&lt;/code>&lt;/pre>&lt;/div>&lt;p>默认情况下宿主机透传 USB 设备功能是禁用的，需要在 &lt;code>/etc/yunion/host.conf&lt;/code> 配置文件里面设置 &lt;code>disable_usb: false&lt;/code> 。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ vim /etc/yunion/host.conf
...
disable_usb: &lt;span style="color:#204a87">false&lt;/span>
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>假设宿主机 hostname 为 &lt;code>oc-node-1&lt;/code>，然后重启宿主机服务，登录到控制节点，执行下面的命令：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 先找到对应的宿主机服务&lt;/span>
$ kubectl get pods -n onecloud -o wide &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep host &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep oc-node-1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> egrep -v &lt;span style="color:#4e9a06">&amp;#39;deployer|image&amp;#39;&lt;/span>
default-host-59k76 3/3 Running &lt;span style="color:#0000cf;font-weight:bold">7&lt;/span> 3d22h 192.168.121.21 oc-node-1 &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 删除宿主机上的 pod ，等待重建&lt;/span>
$ kubectl delete pods -n onecloud default-host-59k76
pod &lt;span style="color:#4e9a06">&amp;#34;default-host-59k76&amp;#34;&lt;/span> deleted
&lt;span style="color:#8f5902;font-style:italic"># 查看新创建的 host 服务&lt;/span>
$ kubectl get pods -n onecloud -o wide &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep host &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep oc-node-1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> egrep -v &lt;span style="color:#4e9a06">&amp;#39;deployer|image&amp;#39;&lt;/span>
default-host-6cl8w 3/3 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 17s 192.168.121.21 oc-node-1 &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 确保该服务变成 Running ，然后到云平台查看透传 USB 设备&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果宿主机很多，也可以使用 &lt;code>kubectl -n rollout restart daemonset default-host&lt;/code> 命令来重启所有宿主机上的 host 服务。&lt;/p>
&lt;h2 id="查看-usb-透传设备">查看 USB 透传设备&lt;/h2>
&lt;h3 id="climc-命令行查看透传设备">climc 命令行查看透传设备&lt;/h3>
&lt;p>使用命令行 &lt;code>climc isolated-device-list --details&lt;/code> 查看设备：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc isolated-device-list --details
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+--------------------------+----------+-------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Dev_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Model &lt;span style="color:#000;font-weight:bold">|&lt;/span> Addr &lt;span style="color:#000;font-weight:bold">|&lt;/span> Vendor_device_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host &lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest_status &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+--------------------------+----------+-------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 1541047f-0203-488a-8226-2de740da061f &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Adomax Technology Co., Ltd &lt;span style="color:#000;font-weight:bold">|&lt;/span> 001:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0627:0001 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span> oc-node-1-192-168-121-21 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> a3fa9bd4-236c-4c5b-8056-f7afa807138d &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 002:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0951:1666 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span> oc-node-1-192-168-121-21 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+--------------------------+----------+-------+--------------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="web界面查看透传设备">web界面查看透传设备&lt;/h3>
&lt;ol>
&lt;li>在透传设备页面，可以查看到宿主机上的USB透传设备。&lt;/li>
&lt;/ol>
&lt;p>现在云平台就有了宿主机 oc-node-1 上的 USB 透传设备，接下来就可以把这些设备给虚拟机使用。&lt;/p>
&lt;h2 id="虚拟机挂载-usb">虚拟机挂载 USB&lt;/h2>
&lt;p>USB 可以在虚拟机运行状态下挂载进去，可以在前端的透传设备列表那里把 USB 挂载到虚拟机里面，一个虚拟机可关联多个USB透传设备。但是一个USB透传设备仅可被一个虚拟机使用。&lt;/p>
&lt;h3 id="web界面挂载usb">web界面挂载USB&lt;/h3>
&lt;p>&lt;strong>在虚拟机页面挂载USB透传设备&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/li>
&lt;li>单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;实例设置-设置USB透传&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置USB透传对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>是否绑定：选择绑定USB透传设备。&lt;/li>
&lt;li>USB设备：当启用绑定USB透传设备后，显示该项，并选择具体的透传设备。&lt;/li>
&lt;li>自动启动：挂载USB设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，挂载或取消挂载USB透传设备。&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>在透传设备页面关联虚拟机&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在透传设备页面，单击USB类型透传设备右侧操作列 &lt;strong>&lt;em>&amp;ldquo;关联虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 按钮，弹出关联虚拟机对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>选择虚拟机：选择需要关联透传设备的虚拟机。&lt;/li>
&lt;li>自动启动：挂载USB设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，为USB透传设备关联虚拟机。&lt;/li>
&lt;/ol>
&lt;h3 id="climc命令行挂载usb设备">Climc命令行挂载USB设备&lt;/h3>
&lt;p>对应命令行操作如下 &lt;code>climc server-attach-isolated-device $server_id $device_id&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 比如虚拟机名称为 testvm，透传设备 id 为 a3fa9bd4-236c-4c5b-8056-f7afa807138d&lt;/span>
$ climc server-attach-isolated-device testvm a3fa9bd4-236c-4c5b-8056-f7afa807138d
&lt;span style="color:#8f5902;font-style:italic"># 然后登录到 testvm 虚拟机里面，执行 lsusb 就能看到宿主机的 USB 设备&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@testvm ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># lsusb&lt;/span>
Bus &lt;span style="color:#0000cf;font-weight:bold">002&lt;/span> Device 002: ID 0951:1666 Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="虚拟机卸载-usb">虚拟机卸载 USB&lt;/h2>
&lt;p>USB 可以在虚拟机运行状态下卸载 USB ，可以在前端的透传设备列表那里卸载 USB 对应的虚拟机。&lt;/p>
&lt;h3 id="web界面卸载usb">web界面卸载USB&lt;/h3>
&lt;p>&lt;strong>在虚拟机页面卸载USB透传设备&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/li>
&lt;li>单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;实例设置-设置USB透传&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置USB透传对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>是否绑定：关闭绑定USB透传设备。&lt;/li>
&lt;li>自动启动：挂载USB设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，挂载或取消挂载USB透传设备。&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>在透传设备页面取消关联虚拟机&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在透传设备页面，单击USB类型透传设备右侧操作列 &lt;strong>&lt;em>&amp;ldquo;取消关联虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 按钮，弹出关联虚拟机对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>自动启动：卸载USB设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，USB透传设备取消关联虚拟机。&lt;/li>
&lt;/ol>
&lt;h3 id="climc命令卸载usb">Climc命令卸载USB&lt;/h3>
&lt;p>对应命令行操作如下 &lt;code>climc server-detach-isolated-device $server_id $device_id&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 比如虚拟机名称为 testvm，透传设备 id 为 a3fa9bd4-236c-4c5b-8056-f7afa807138d&lt;/span>
$ climc server-detach-isolated-device testvm a3fa9bd4-236c-4c5b-8056-f7afa807138d
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="宿主机刷新设备">宿主机刷新设备&lt;/h2>
&lt;p>有些情况会频繁在宿主机上插拔 USB 设备，这样会导致云平台记录的 USB 设备信息和宿主机上的实际设备信息不一致，可以使用下面的命令 &lt;code>climc host-probe-isolated-devices $host_id&lt;/code> 进行设备信息同步：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 假设宿主机名称为 oc-node-1-192-168-121-21，看下目前的设备列表&lt;/span>
$ lsusb
Bus &lt;span style="color:#0000cf;font-weight:bold">002&lt;/span> Device 002: ID 0951:1666 Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50
Bus &lt;span style="color:#0000cf;font-weight:bold">001&lt;/span> Device 002: ID 0627:0001 Adomax Technology Co., Ltd
&lt;span style="color:#8f5902;font-style:italic"># 对应云平台的设备列表是一致的&lt;/span>
$ climc isolated-device-list --host oc-node-1-192-168-121-21
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Dev_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Model &lt;span style="color:#000;font-weight:bold">|&lt;/span> Addr &lt;span style="color:#000;font-weight:bold">|&lt;/span> Vendor_device_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host_id &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 1541047f-0203-488a-8226-2de740da061f &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Adomax Technology Co., Ltd &lt;span style="color:#000;font-weight:bold">|&lt;/span> 001:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0627:0001 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> a3fa9bd4-236c-4c5b-8056-f7afa807138d &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 002:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0951:1666 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;span style="color:#8f5902;font-style:italic"># 从上面看到有两个 USB 设备列表，然后我把 Kingston U 盘拔掉&lt;/span>
$ lsusb
Bus &lt;span style="color:#0000cf;font-weight:bold">001&lt;/span> Device 002: ID 0627:0001 Adomax Technology Co., Ltd
&lt;span style="color:#8f5902;font-style:italic"># 执行命令同步当前宿主机设备信息&lt;/span>
$ climc host-probe-isolated-devices oc-node-1-192-168-121-21
&lt;span style="color:#8f5902;font-style:italic"># 再查看设备列表就只有一个了，Kingston U 盘记录已经被删掉&lt;/span>
$ climc isolated-device-list --host oc-node-1-192-168-121-21
+--------------------------------------+----------+----------------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Dev_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Model &lt;span style="color:#000;font-weight:bold">|&lt;/span> Addr &lt;span style="color:#000;font-weight:bold">|&lt;/span> Vendor_device_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host_id &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+----------------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> fa3cdbbd-7c54-4d2a-87cd-9362aa590a7d &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Adomax Technology Co., Ltd &lt;span style="color:#000;font-weight:bold">|&lt;/span> 001:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0627:0001 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+----------------------------+---------+------------------+--------------------------------------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="指定usb控制器">指定USB控制器&lt;/h2>
&lt;p>默认采用qemu-xhci的USB控制器，该控制器支持版本为USB 3.0，向下兼容2.0。对于老版本的操作系统，例如 Windows Server 2008 R2，不识别USB 3.0的控制器，此时需要改为USB 2.0的控制器 usb-ehci。可以通过一下climc命令行更改虚拟机使用的USB控制器：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">climc server-set-qemu-params &amp;lt;sid&amp;gt; --usb-controller-type &amp;lt;usb-ehci&lt;span style="color:#000;font-weight:bold">|&lt;/span>qemu-xhci&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>更改后，请请重启虚拟机。&lt;/p></description></item><item><title>Docs: 串口COM透传</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/com-passthrough/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/com-passthrough/</guid><description>
&lt;p>本文介绍如何将宿主机的串口（COM）透传到虚拟机内使用。&lt;/p>
&lt;h2 id="配置宿主机">配置宿主机&lt;/h2>
&lt;p>查看宿主机上的 COM 设备，采用命令 setserial 查看：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 查看板载串口设备&lt;/span>
$ sudo setserial -g /dev/ttyS&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>0123&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
/dev/ttyS0, UART: 16550A, Port: 0x03f8, IRQ: &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span>
/dev/ttyS1, UART: 16550A, Port: 0x1020, IRQ: &lt;span style="color:#0000cf;font-weight:bold">18&lt;/span>
/dev/ttyS2, UART: unknown, Port: 0x03e8, IRQ: &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span>
/dev/ttyS3, UART: unknown, Port: 0x02e8, IRQ: &lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 查看USB串口&lt;/span>
$ sudo setserial -g /dev/ttyUSB&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>01&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
/dev/ttyUSB0, UART: unknown, Port: 0x0000, IRQ: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>找到宿主机上待透传的串口设备路径，例如 /dev/ttyUSB0&lt;/p>
&lt;p>在QEMU增加如下命令行参数将该串口设备传入虚拟机：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">-chardev tty,path&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/dev/ttyUSB0,id&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>hostusbserial
-device pci-serial,chardev&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>hostusbserial
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过如下climc命令为指定宿主机设置以上命令行参数：&lt;/p>
&lt;pre>&lt;code>climc server-add-extra-options &amp;lt;sid&amp;gt; chardev tty,path=/dev/ttyUSB0,id=hostusbserial
climc server-add-extra-options &amp;lt;sid&amp;gt; device pci-serial,chardev=hostusbserial
&lt;/code>&lt;/pre>&lt;p>重启该虚拟机，在虚拟机详情页面查看命令行参数中是否增加了以上参数。&lt;/p></description></item><item><title>Docs: 迁移磁盘存储</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/change-disk-storge/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/change-disk-storge/</guid><description>
&lt;p>在 v3.9.4 版本后可以把虚拟机的磁盘迁移到另一个存储，应用场景如下：&lt;/p>
&lt;ul>
&lt;li>Ceph RBD 磁盘迁移到本地存储&lt;/li>
&lt;li>本地磁盘迁移到 Ceph 存储&lt;/li>
&lt;li>Ceph RBD 磁盘迁移到另一个 Ceph 存储&lt;/li>
&lt;/ul>
&lt;p>另外限制条件如下：&lt;/p>
&lt;ul>
&lt;li>互相迁移的两个存储必须挂载到虚拟机所在的宿主机&lt;/li>
&lt;/ul>
&lt;p>假设环境中一台名叫 x86-node01-11-10-1-180-11 的宿主机分别挂载了一个 Ceph 存储和一个本地存储，用下面的命令可以查训到这台宿主机上挂载的存储：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc host-storage-list --host x86-node01-11-10-1-180-11 --details
+----------------------------------+----------------------------+-----------+---------------+----------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> Mount_point &lt;span style="color:#000;font-weight:bold">|&lt;/span> Capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Used_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Waste_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+---------------+----------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> wz_rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd:rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">241013618&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1556480&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> host_10.1.180.11_local_storage_0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> /opt/cloud/workspace/disks &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">681664&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">696320&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+---------------+----------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过上面的 &lt;code>climc host-storage-list&lt;/code> 命令找到 x86-node01-11-10-1-180-11 这台宿主机上面有 2 个存储，Ceph RBD 存储为 wz_rbd，本地存储为 host_10.1.180.11_local_storage_0 。&lt;/p>
&lt;h2 id="ceph-rbd-磁盘迁移到本地存储">Ceph RBD 磁盘迁移到本地存储&lt;/h2>
&lt;p>下面命令测试创建一台虚拟机到 wz_rbd Ceph 存储，然后把磁盘迁移到 host_10.1.180.11_local_storage_0 本地存储。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 首先创建一个名为 tvm-wz 虚拟机，磁盘使用 rbd，指定创建到宿主机&lt;/span>
$ climc server-create --disk CentOS-7.6.1810-20190430.qcow2:rbd &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --net vm-test-net &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --mem-spec 1g &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --ncpu &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --allow-delete &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --auto-start &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host x86-node01-11-10-1-180-11 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> tvm-wz
&lt;span style="color:#8f5902;font-style:italic"># 查看虚拟机的磁盘信息&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 找到对应的磁盘名称为 vdisk-tvm-wz-1636100820075603665&lt;/span>
$ climc server-disk-list --server tvm --details
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm-wz&lt;span style="color:#000;font-weight:bold">|&lt;/span> 65ca88b1-186f-440a-8930-b4914e62cb3d &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-tvm-wz-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 查看磁盘 vdisk-tvm-wz-1636100820075603665 所在的存储为 h3c_blockpool1&lt;/span>
$ climc disk-show vdisk-tvm-wz-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep storage
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> wz_rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在已经创建好使用 wz_rbd Ceph 存储的虚拟机了，接下来把这个 tvm-wz 虚拟机的 vdisk-tvm-wz-1636100820075603665 磁盘迁移到本地存储，命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 将虚拟机关机才能进行磁盘迁移存储&lt;/span>
$ climc server-stop tvm-wz
&lt;span style="color:#8f5902;font-style:italic"># 执行下面的 server-change-disk-storage 命令把 tvm 虚拟机的 vdisk-tvm-1636100820075603665 磁盘迁移到本地存储&lt;/span>
$ climc server-change-disk-storage tvm-wz vdisk-tvm-wz-1636100820075603665 host_10.1.180.11_local_storage_0
&lt;span style="color:#8f5902;font-style:italic"># 然后查看虚拟机的状态，磁盘迁移存储虚拟机会处于 disk_change_storage 的状态&lt;/span>
$ climc server-list --search tvm-wz --details
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 329bfce5-135f-4113-861e-bd44b8aaf9e0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm-wz &lt;span style="color:#000;font-weight:bold">|&lt;/span> postpaid &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10.2.18.252 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> disk_change_storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1024&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> Default &lt;span style="color:#000;font-weight:bold">|&lt;/span> default &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 等待虚拟机状态变为 ready 表示迁移完毕&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 然后再查看虚拟机的磁盘为 vdisk-tvm-wz-1636103786977105704&lt;/span>
$ climc server-disk-list --server tvm-wz --details
+--------+--------------------------------------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------+--------------------------------------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm-wz &lt;span style="color:#000;font-weight:bold">|&lt;/span> 61e4f0e4-597a-4aa9-8cde-0369879b9236 &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-tvm-wz-1636103786977105704 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">local&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------+--------------------------------------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 查看新的磁盘 vdisk-tvm-wz-1636103786977105704 的存储，发现已经变为本地存储了&lt;/span>
$ climc disk-show vdisk-tvm-wz-1636103786977105704 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep storage
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> host_10.1.180.11_local_storage_0 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> 4484274b-8483-4166-8e3f-f3c37c4b4997 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">local&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="本地磁盘迁移到-ceph-rbd-存储">本地磁盘迁移到 Ceph RBD 存储&lt;/h2>
&lt;p>还是利用之前创建好的 tvm-wz 虚拟机，现在虚拟机的磁盘为本地的 vdisk-tvm-wz-1636103786977105704 磁盘，执行下面的命令把该磁盘迁移到 wz_rbd Ceph 存储。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 迁移本地磁盘到 wz_rbd&lt;/span>
$ climc server-change-disk-storage tvm-wz vdisk-tvm-wz-1636103786977105704 wz_rbd
&lt;span style="color:#8f5902;font-style:italic"># 等待迁移完成后，再执行之前的命令查看先在虚拟机的磁盘，发现已经使用 wz_rbd 存储了&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 新的磁盘为 vdisk-tvm-wz-1636104909252150575&lt;/span>
$ climc server-disk-list --server tvm-wz --details
+--------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm-wz &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-tvm-wz-1636104909252150575 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
$ climc disk-show vdisk-tvm-wz-1636104909252150575 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep storage
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> wz_rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> 061342a6-8f5a-4bc6-8757-8bb6c12bda83 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>测试迁移完成后，把虚拟机开机，能够正常启动，并且里面没有数据丢失，就没有问题。&lt;/p>
&lt;h2 id="ceph-rbd-磁盘迁移到另一个-ceph-存储">Ceph RBD 磁盘迁移到另一个 Ceph 存储&lt;/h2>
&lt;h3 id="两个-ceph-集群接口兼容">两个 Ceph 集群接口兼容&lt;/h3>
&lt;p>&lt;strong>注意&lt;/strong>：这种方法适用于源 Ceph 和目标 Ceph 集群兼容的情况，依赖的 rbd 动态库一致才行，不然会失败。&lt;/p>
&lt;p>假设环境中有另外一个叫做 wz_rbd 的 Ceph 存储，下面命令测试创建一台虚拟机到 h3c_blockpool1 Ceph 存储，然后把磁盘迁移到一个名为 wz_rbd 的 Ceph 存储。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 首先创建一个名为 tvm 虚拟机，磁盘使用 rbd，指定创建到宿主机&lt;/span>
$ climc server-create --disk CentOS-7.6.1810-20190430.qcow2:rbd &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --net vm-test-net &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --mem-spec 1g &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --ncpu &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --allow-delete &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --auto-start &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host x86-node03-13-10-1-180-13 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> tvm
&lt;span style="color:#8f5902;font-style:italic"># 查看虚拟机的磁盘信息&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 找到对应的磁盘名称为 vdisk-tvm-1636100820075603665&lt;/span>
$ climc server-disk-list --server tvm --details
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm &lt;span style="color:#000;font-weight:bold">|&lt;/span> 65ca88b1-186f-440a-8930-b4914e62cb3d &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-tvm-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 查看磁盘 vdisk-tvm-1636100820075603665 所在的存储为 h3c_blockpool1&lt;/span>
$ climc disk-show vdisk-tvm-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep storage
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> h3c_blockpool1 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0bf0cf3c-8cc8-47bb-8d1e-ab97f103e267 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在已经创建好使用 h3c_blockpool1 Ceph 存储的虚拟机了，接下来把这个 tvm 虚拟机的 vdisk-tvm-1636100820075603665 磁盘迁移到另一个 Ceph 存储 wz_rbd，命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 首先需要把 wz_rbd 存储挂载到虚拟机所在的宿主机 x86-node03-13-10-1-180-13&lt;/span>
$ climc host-storage-attach x86-node03-13-10-1-180-13 wz_rbd
&lt;span style="color:#8f5902;font-style:italic"># 查看宿主机上挂载的存储，会发现多一块存储 wz_rbd&lt;/span>
$ climc host-storage-list --host x86-node03-13-10-1-180-13 --details
+----------------------------------+----------------------------+-----------+---------------+----------------+---------------+----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> Mount_point &lt;span style="color:#000;font-weight:bold">|&lt;/span> Capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Used_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Waste_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Free_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> cmtbound &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+---------------+----------------+---------------+----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> wz_rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd:rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">241018691&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1525760&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">239462208&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> h3c_blockpool1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd:.HDDdisk.rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">192653544&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">122880&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">192530656&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> host_10.1.180.13_local_storage_0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> /opt/cloud/workspace/disks &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">681664&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">61440&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">620224&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+---------------+----------------+---------------+----------+
&lt;span style="color:#8f5902;font-style:italic"># 将虚拟机关机才能进行磁盘迁移存储&lt;/span>
$ climc server-stop tvm
&lt;span style="color:#8f5902;font-style:italic"># 执行下面的 server-change-disk-storage 命令把 tvm 虚拟机的 vdisk-tvm-1636100820075603665 磁盘迁移到 wz_rbd 存储&lt;/span>
$ climc server-change-disk-storage tvm vdisk-tvm-1636100820075603665 wz_rbd
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="两个-ceph-集群不兼容">两个 Ceph 集群不兼容&lt;/h3>
&lt;p>如果两个 Ceph 集群不兼容，比如一边用的开源 Ceph 集群，另外一边用的是商业 Ceph 集群，两套集群的动态库不一致就无法把两个 Ceph 存储挂载到平台的一台宿主机上。&lt;/p>
&lt;p>遇到这种情况可以采取一个利用 NFS 存储作为中转的变通解决方案，假设 host1 计算节点挂载了 Ceph1，上面有台虚拟机 vm 使用了 Ceph1，要把 vm 迁移到 host2 的 Ceph2 集群里面，步骤如下：&lt;/p>
&lt;ol>
&lt;li>自己搭建一个 NFS 服务，在云平台前端创建 NFS 存储&lt;/li>
&lt;li>然后在平台前端把这个 NFS 存储分别挂载到 host1 和 host2&lt;/li>
&lt;li>把 host1 上的 vm 调用 server-change-disk-storage 把 Ceph1 里面的磁盘迁移到 NFS 存储&lt;/li>
&lt;li>然后调用 server-migrate 命令或者去前段进行迁移操作，把 vm 迁移到 host2&lt;/li>
&lt;li>最后再调用 server-change-disk-storage 把 host2 上的 vm 磁盘迁移到 Ceph2&lt;/li>
&lt;/ol>
&lt;p>接下来是操作的命令行步骤：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 假设 NFS 服务器的地址为 172.16.254.124&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 共享的目录为 /opt/nfs_data&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 在平台创建对应的 nfs-store 存储&lt;/span>
$ climc storage-create --storage-type nfs &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --capacity &lt;span style="color:#0000cf;font-weight:bold">1024000&lt;/span> &lt;span style="color:#4e9a06">\ &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 容量根据实际情况填写&lt;/span>
--nfs-host 172.16.254.124 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --nfs-shared-dir &lt;span style="color:#4e9a06">&amp;#39;/opt/nfs_data&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> nfs-store zone0
&lt;span style="color:#8f5902;font-style:italic"># 然后把 nfs-store 挂载到 host1 和 host2 的 /opt/nfs_share 目录&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 需要登录 host1 和 host2 创建 /opt/nfs_share 目录&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@host1&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> $ mkdir -p /opt/nfs_share
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@host2&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> $ mkdir -p /opt/nfs_share
&lt;span style="color:#8f5902;font-style:italic"># 在平台挂载 nfs-store 到 host1 和 host2 &lt;/span>
$ climc host-storage-attach --mount-point /opt/nfs_share host1 nfs-store
$ climc host-storage-attach --mount-point /opt/nfs_share host2 nfs-store
&lt;span style="color:#8f5902;font-style:italic"># 把 host1 上的 vm 磁盘改为 nfs-store&lt;/span>
$ climc server-disk-list --server vm --details
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> vm&lt;span style="color:#000;font-weight:bold">|&lt;/span> 65ca88b1-186f-440a-8930-b4914e62cb3d &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-vm-wz-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 执行下面的 server-change-disk-storage 命令把 vm 虚拟机的磁盘迁移到 nfs-store&lt;/span>
$ climc server-change-disk-storage vm vdisk-vm-wz-1636100820075603665 nfs-store
&lt;span style="color:#8f5902;font-style:italic"># 等待虚拟机 vm 状态变为 ready 后&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 再把虚拟机迁移到 host2&lt;/span>
$ climc server-migrate --prefer-host host2 vm
&lt;span style="color:#8f5902;font-style:italic"># 然后再调用 server-change-disk-storage 把 vm 虚拟机磁盘迁移到 ceph2 存储&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 找到现在磁盘为 vdisk-vm-1636100820075603665，发现类型 Storage_type 为 nfs&lt;/span>
$ climc server-disk-list --server vm --details
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> vm&lt;span style="color:#000;font-weight:bold">|&lt;/span> 65ca88b1-186f-440a-8930-b4914e62cb3d &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-vm-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> nfs &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 查看宿主机 host2 上挂载的存储&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 发现有 nfs-store 和 ceph2&lt;/span>
$ climc host-storage-list --host host2 --details
+----------------------------------+----------------------------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> Mount_point &lt;span style="color:#000;font-weight:bold">|&lt;/span> Capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ceph2 &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd:rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">241018691&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> nfs &lt;span style="color:#000;font-weight:bold">|&lt;/span> /opt/nfs_share &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1024000&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">122880&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> host_10.1.180.13_local_storage_0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> /opt/cloud/workspace/disks &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">681664&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------++
&lt;span style="color:#8f5902;font-style:italic"># 把虚拟机 vm 磁盘迁移到 ceph2&lt;/span>
$ climc server-change-disk-storage vm vdisk-vm-1636100820075603665 ceph2
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="其他注意事项">其他注意事项&lt;/h2>
&lt;ul>
&lt;li>更改存储的旧磁盘会删除到回收站，会占用实际的物理空间，如果确定这些旧的磁盘不使用了，可以在回收站里面清理。&lt;/li>
&lt;/ul>
&lt;h2 id="磁盘更改存储的原理">磁盘更改存储的原理&lt;/h2>
&lt;p>目前磁盘更改存储底层使用了 &lt;code>qemu-img convert&lt;/code> 的命令来进行磁盘底层存储变更，在云平台执行了 &lt;code>climc server-change-disk-storage&lt;/code> 命令后，可以登录到虚拟机所在的宿主机，执行下面的命令，就可以看到这个 &lt;code>qemu-img convert&lt;/code> 的进程：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ps faux &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep qemu-img &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep convert
root &lt;span style="color:#0000cf;font-weight:bold">3701532&lt;/span> 13.8 0.1 &lt;span style="color:#0000cf;font-weight:bold">1516864&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">102056&lt;/span> ? Ssl 17:35 0:00 &lt;span style="color:#4e9a06">\_&lt;/span> /usr/local/qemu-2.12.1/bin/qemu-img convert -f qcow2 -O raw /opt/cloud/workspace/disks/61e4f0e4-597a-4aa9-8cde-0369879b9236 rbd:rbd/d55671c1-ec1b-4c2c-87cb-aa4aa517744e:mon_host&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>172.16.2.31&lt;span style="color:#4e9a06">\;&lt;/span>172.16.2.32&lt;span style="color:#4e9a06">\;&lt;/span>172.16.2.33:key&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>AQBBi1RhiSvXChAAnFzGrpAGM5N8dWb3rTdQwQ&lt;span style="color:#4e9a06">\=\=&lt;/span>:rados_osd_op_timeout&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1200:client_mount_timeout&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>120:rados_mon_op_timeout&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">5&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: libvirt 管理虚机导入</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/import/</link><pubDate>Tue, 26 Nov 2019 16:57:43 +0800</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/import/</guid><description>
&lt;p>支持将libvirt管理的虚拟机导入到 Cloudpods平台。&lt;/p>
&lt;h2 id="注意事项">注意事项&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>首先需要在libvirt管理的宿主机上安装我们的计算节点&lt;/p>
&lt;/li>
&lt;li>
&lt;p>安装好计算节点后需要添加的虚拟机的网络到控制节点&lt;/p>
&lt;/li>
&lt;li>
&lt;p>确保libvirt服务关闭&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="相关操作">相关操作&lt;/h2>
&lt;ul>
&lt;li>准备好需要导入虚拟机的信息文件&lt;code>servers.yaml&lt;/code>， 格式如下:&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>hosts:
- host_ip: 10.168.222.137
xml_file_path: /etc/libvirt/qemu
monitor_path: /var/lib/libvirt/qemu
servers:
- mac: 52:54:00:4A:19:AF
ip: 10.168.222.53
- mac: 52:54:00:4A:19:CC
ip: 10.168.222.54
- host_ip: 10.168.222.130
xml_file_path: /etc/libvirt/qemu
monitor_path: /var/lib/libvirt/qemu
servers:
- mac: 53:54:00:4A:19:EC
ip: 11.168.222.50
- mac: 53:54:00:4A:19:EE
ip: 11.168.222.51
&lt;/code>&lt;/pre>&lt;pre>&lt;code>- `host_ip` 是要导入的宿主机的ip
- `xml_file_path`是libvirt存储虚拟机xml文件的路径，
- `monitor_path`是libvirt存储虚拟机monitor socket文件的路径，
- `servers`是需要导入的虚拟机，里面描述了虚拟机的ip和mac对应关系
&lt;/code>&lt;/pre>
&lt;hr>
&lt;ul>
&lt;li>执行 climc servers-import-from-libvirt 开始导入&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 导入前确认libvirt服务关闭&lt;/span>
$ climc servers-import-from-libvirt servers.yaml
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 修改磁盘驱动</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/change_disk_driver/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/change_disk_driver/</guid><description>
&lt;h2 id="介绍">介绍&lt;/h2>
&lt;p>默认情况下，虚拟机的磁盘驱动是 scsi 的，这种驱动在 Linux 虚拟机内部看到的磁盘就是 &amp;lsquo;/dev/sd&amp;rsquo; 开头的块设备。可以通过一些命令设置磁盘的驱动，比如 Windows 虚拟机在没有安装 virtio 驱动的时候，只能使用 ide 驱动的方式启动。&lt;/p>
&lt;h2 id="查看虚拟机磁盘驱动">查看虚拟机磁盘驱动&lt;/h2>
&lt;p>首先通过 server-disk-list 命令查看虚拟机所有磁盘的驱动，比如虚拟机的名称是 vm1 。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># server-disk-list 命令查看虚拟机和关联磁盘的关系&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># --details: 显示详细信息&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># --server: 指定对应的虚拟机名称或者 ID&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># --scope system: 表示显示系统里面所有资源&lt;/span>
$ climc server-disk-list --details --server vm1 --scope system
+--------------------------------------+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 84090287-9dc5-4d6b-854d-24f99ad6f170 &lt;span style="color:#000;font-weight:bold">|&lt;/span> vm1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 968d9285-6353-4bce-8a6f-bf540efad3f5 &lt;span style="color:#000;font-weight:bold">|&lt;/span> data-disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">10240&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> data &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">local&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 84090287-9dc5-4d6b-854d-24f99ad6f170 &lt;span style="color:#000;font-weight:bold">|&lt;/span> vm1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 5448ea7d-5c64-47a2-847d-06060e187a47 &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-vm1-1624970026002516731 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">local&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中 Index 为 0 表示虚拟机的第一块磁盘，对应到 Linux 系统里面的 &amp;lsquo;/dev/sda&amp;rsquo;，Driver 表示对应驱动为 scsi，Disk_type 为 sys 表示系统盘。&lt;/p>
&lt;p>Index 为 1 表示第二块磁盘，对应 Linux 系统里面的 &amp;lsquo;/dev/sdb&amp;rsquo;，驱动也为 scsi ，Disk_type 为 data 表示数据盘。&lt;/p>
&lt;h2 id="修改驱动">修改驱动&lt;/h2>
&lt;p>通过 server-disk-update 命令更新虚拟机上的磁盘驱动。&lt;/p>
&lt;p>先看下 server-disk-update 命令的帮助信息。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-disk-update --help
Usage: climc server-disk-update &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--cache &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>writethrough,none,writeback&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--aio &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>native,threads&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--index INDEX&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--driver &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>virtio,ide,scsi,pvscsi&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span> &amp;lt;SERVER&amp;gt; &amp;lt;DISK&amp;gt;
Update details of a virtual disk of a virtual server
Positional arguments:
&amp;lt;SERVER&amp;gt;
ID or Name of server
&amp;lt;DISK&amp;gt;
ID or Name of Disk
Optional arguments:
&lt;span style="color:#8f5902;font-style:italic"># 对应 qemu/kvm 虚拟机磁盘 cache mode&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--cache &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>writethrough,none,writeback&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span>
Cache mode of vDisk
&lt;span style="color:#8f5902;font-style:italic"># 对应 qemu/kvm 虚拟机磁盘的 aio&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--aio &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>native,threads&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span>
Asynchronous IO mode of vDisk
&lt;span style="color:#8f5902;font-style:italic"># 磁盘索引顺序&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--index INDEX&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Index of vDisk
&lt;span style="color:#8f5902;font-style:italic"># 对应 qemu/kvm 虚拟机磁盘 driver&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--driver &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>virtio,ide,scsi,pvscsi&lt;span style="color:#ce5c00;font-weight:bold">}]&lt;/span>
Driver of vDisk
&lt;/code>&lt;/pre>&lt;/div>&lt;p>从帮助信息可以看到支持的 driver 为 virtio, ide, scsi 或者 pvscsi ，请根据自己的需要进行选择。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 把虚拟机 vm1 的系统盘 5448ea7d-5c64-47a2-847d-06060e187a47 驱动改为 virtio&lt;/span>
$ climc server-disk-update --driver virtio vm1 5448ea7d-5c64-47a2-847d-06060e187a47
&lt;span style="color:#8f5902;font-style:italic"># 查看记录，发现已经改成 virtio 了&lt;/span>
$ climc server-disk-list --details --server vm1 --scope system &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep 5448ea7d-5c64-47a2-847d-06060e187a47
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 84090287-9dc5-4d6b-854d-24f99ad6f170 &lt;span style="color:#000;font-weight:bold">|&lt;/span> vm1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 5448ea7d-5c64-47a2-847d-06060e187a47 &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-vm1-1624970026002516731 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> virtio &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">local&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>修改了磁盘驱动后，需要重启虚拟机才能生效，使用 server-stop 和 server-start 命令重启虚拟机 vm1 。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 停止虚拟机&lt;/span>
$ climc server-stop vm1
&lt;span style="color:#8f5902;font-style:italic"># 调用 server-list 查看虚拟机状态，等到状态变为 ready&lt;/span>
$ climc server-list --search vm1 --scope system
+--------------------------------------+------+--------------+---------+------------+-----------+-----------+-----------------------------+------------+---------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Billing_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> vcpu_count &lt;span style="color:#000;font-weight:bold">|&lt;/span> vmem_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Secgrp_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Created_at &lt;span style="color:#000;font-weight:bold">|&lt;/span> Hypervisor &lt;span style="color:#000;font-weight:bold">|&lt;/span> os_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> is_system &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+------+--------------+---------+------------+-----------+-----------+-----------------------------+------------+---------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 84090287-9dc5-4d6b-854d-24f99ad6f170 &lt;span style="color:#000;font-weight:bold">|&lt;/span> vm1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> postpaid &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1024&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> default &lt;span style="color:#000;font-weight:bold">|&lt;/span> 2021-06-29T12:33:45.000000Z &lt;span style="color:#000;font-weight:bold">|&lt;/span> kvm &lt;span style="color:#000;font-weight:bold">|&lt;/span> Linux &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+------+--------------+---------+------------+-----------+-----------+-----------------------------+------------+---------+-----------+
&lt;span style="color:#8f5902;font-style:italic"># 启动虚拟机&lt;/span>
$ climc server-start vm1
&lt;span style="color:#8f5902;font-style:italic"># 之后再重复查看虚拟机状态，知道变为 running&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后通过前端的 vnc 或者 ssh 登录虚拟机，用 lsblk 之类的磁盘工具查看磁盘，发现里面的磁盘块设备名称已经从 &amp;lsquo;/dev/sda&amp;rsquo; 变成 &amp;lsquo;/dev/vda&amp;rsquo; 了。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>cloudroot@vm1 ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>$ lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sr0 11:0 &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 1024M &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> rom
vda 253:0 &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 30G &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> disk
├─vda1 253:1 &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 1M &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> part
├─vda2 253:2 &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 512M &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> part /boot
└─vda3 253:3 &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 29.5G &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> part /
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 性能测试</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/perf-test/</link><pubDate>Fri, 19 Jul 2019 17:38:36 +0800</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/perf-test/</guid><description>
&lt;h3 id="cpu和内存性能测试">CPU和内存性能测试&lt;/h3>
&lt;h4 id="测试环境">测试环境&lt;/h4>
&lt;p>操作系统: CentOS 7
云平台版本: &amp;gt;= v3.7.7
宿主机: Dell PowerEdge R730xd
- CPU: Intel(R) Xeon(R) CPU E5-2678 v3 @ 2.50GHz
- 内存: DDR4 2133 MHz 256GB (16GB x 16)
- 磁盘: 机械盘 20TB PERC H730P Mini (RAID 10)
- 网卡: 10000Mb/s&lt;/p>
&lt;h4 id="安装测试软件">安装测试软件&lt;/h4>
&lt;p>测试工具:&lt;/p>
&lt;ul>
&lt;li>UnixBench: 测试虚拟机CPU性能&lt;/li>
&lt;li>mbw: 测试内存性能&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 安装 UnixBench&lt;/span>
$ yum install -y git gcc autoconf gcc-c++ &lt;span style="color:#204a87">time&lt;/span> perl-Time-HiRes
$ git clone https://github.com/kdlucas/byte-unixbench.git
&lt;span style="color:#8f5902;font-style:italic"># 安装 mbw&lt;/span>
$ git clone https://github.com/raas/mbw.git &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#204a87">cd&lt;/span> mbw
$ make &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> ./mbw &lt;span style="color:#0000cf;font-weight:bold">512&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="cpu-测试">CPU 测试&lt;/h4>
&lt;p>测试命令:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ &lt;span style="color:#204a87">cd&lt;/span> byte-unixbench/UnixBench
$ ./Run -c &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> whetstone-double dhry2reg fsdisk
&lt;/code>&lt;/pre>&lt;/div>&lt;p>结论:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>指标&lt;/th>
&lt;th>物理机&lt;/th>
&lt;th>虚拟机&lt;/th>
&lt;th>虚拟化开销（物理机-虚拟机/ 物理机）&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Dhrystone&lt;/td>
&lt;td>34839728.4 lps&lt;/td>
&lt;td>33964545.0 lps&lt;/td>
&lt;td>2.5%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Double-Precision Whetstone&lt;/td>
&lt;td>4368.3 MWIPS&lt;/td>
&lt;td>4244.3 MWIPS&lt;/td>
&lt;td>2.8%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>File Copy&lt;/td>
&lt;td>1825548.4 KBps&lt;/td>
&lt;td>1788048.3 KBps&lt;/td>
&lt;td>2.1%&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="内存测试">内存测试&lt;/h4>
&lt;p>结论:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>指标&lt;/th>
&lt;th>物理机&lt;/th>
&lt;th>虚拟机&lt;/th>
&lt;th>虚拟化开销（物理机-虚拟机/物理机）&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>MEMCPY AVG&lt;/td>
&lt;td>7578.348 MiB/s&lt;/td>
&lt;td>6254.520 MiB/s&lt;/td>
&lt;td>1.7%&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="本地存储io测试">本地存储IO测试&lt;/h3>
&lt;h4 id="测试方法">测试方法&lt;/h4>
&lt;p>采用fio，分别用如下场景和命令测试：&lt;/p>
&lt;ul>
&lt;li>4KB随机读&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>random-read --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>randread --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4k --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">16&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>4KB随机写&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>random-write --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>randwrite --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4k --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">16&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --end_fsync&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>4K顺序读&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>random-read --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#204a87">read&lt;/span> --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4k --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">16&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>4K顺序写&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>random-write --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>write --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4k --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">16&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --end_fsync&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>1MB顺序读&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>seq-read --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#204a87">read&lt;/span> --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1m --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>16g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>1MB顺序写&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>seq-write --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>write --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1m --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>16g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --end_fsync&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="测试环境-1">测试环境&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>物理机&lt;/p>
&lt;p>OS: CentOS Linux release 7.9.2009 (Core)
内核：3.10.0-1062.4.3.el7.yn20191203.x86_64
CPU: Intel(R) Xeon(R) CPU E5-2678 v3 @ 2.50GHz
内存：256G
RAID控制器：Broadcom / LSI MegaRAID SAS-3 3108
RAID Level: RAID10&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Linxu 虚拟机&lt;/p>
&lt;p>OS: CentOS Linux release 7.6.1810 (Core)
内核：3.10.0-957.12.1.el7.x86_64
配置：4核CPU4G内存30G系统盘100G数据盘&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Windows 虚拟机&lt;/p>
&lt;p>OS: Windows Server 2008 R2 Datacenter 6.1
配置：4核CPU4G内存40G系统盘100G数据盘&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="测试结果">测试结果&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>场景&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">随机读&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">随机写&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">顺序读&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">顺序写&lt;/th>
&lt;th style="text-align:right">1MB&lt;/th>
&lt;th style="text-align:left">顺序读&lt;/th>
&lt;th style="text-align:right">1MB&lt;/th>
&lt;th style="text-align:left">顺序写&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>物理机&lt;/td>
&lt;td style="text-align:right">195&lt;/td>
&lt;td style="text-align:left">782KiB/s&lt;/td>
&lt;td style="text-align:right">7349&lt;/td>
&lt;td style="text-align:left">28.7MiB/s&lt;/td>
&lt;td style="text-align:right">22.1k&lt;/td>
&lt;td style="text-align:left">86.3MiB/s&lt;/td>
&lt;td style="text-align:right">24.5k&lt;/td>
&lt;td style="text-align:left">95.8MiB/s&lt;/td>
&lt;td style="text-align:right">1055&lt;/td>
&lt;td style="text-align:left">1056MiB/s&lt;/td>
&lt;td style="text-align:right">1117&lt;/td>
&lt;td style="text-align:left">1118MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Linux 虚拟机&lt;/td>
&lt;td style="text-align:right">245&lt;/td>
&lt;td style="text-align:left">981KiB/s&lt;/td>
&lt;td style="text-align:right">6096&lt;/td>
&lt;td style="text-align:left">23.8MiB/s&lt;/td>
&lt;td style="text-align:right">9458&lt;/td>
&lt;td style="text-align:left">36.9MiB/s&lt;/td>
&lt;td style="text-align:right">6278&lt;/td>
&lt;td style="text-align:left">24.5MiB/s&lt;/td>
&lt;td style="text-align:right">979&lt;/td>
&lt;td style="text-align:left">980MiB/s&lt;/td>
&lt;td style="text-align:right">1058&lt;/td>
&lt;td style="text-align:left">1059MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=none)&lt;/td>
&lt;td style="text-align:right">(126%)&lt;/td>
&lt;td style="text-align:left">(125%)&lt;/td>
&lt;td style="text-align:right">(83%)&lt;/td>
&lt;td style="text-align:left">(83%)&lt;/td>
&lt;td style="text-align:right">(43%)&lt;/td>
&lt;td style="text-align:left">(43%)&lt;/td>
&lt;td style="text-align:right">(26%)&lt;/td>
&lt;td style="text-align:left">(26%)&lt;/td>
&lt;td style="text-align:right">(93%)&lt;/td>
&lt;td style="text-align:left">(93%)&lt;/td>
&lt;td style="text-align:right">(95%)&lt;/td>
&lt;td style="text-align:left">(95%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Linux 虚拟机&lt;/td>
&lt;td style="text-align:right">243&lt;/td>
&lt;td style="text-align:left">973KiB/s&lt;/td>
&lt;td style="text-align:right">7483&lt;/td>
&lt;td style="text-align:left">29.2MiB/s&lt;/td>
&lt;td style="text-align:right">11.5k&lt;/td>
&lt;td style="text-align:left">44.9MiB/s&lt;/td>
&lt;td style="text-align:right">7271&lt;/td>
&lt;td style="text-align:left">28.4MiB/s&lt;/td>
&lt;td style="text-align:right">958&lt;/td>
&lt;td style="text-align:left">959MiB/s&lt;/td>
&lt;td style="text-align:right">1052&lt;/td>
&lt;td style="text-align:left">1052MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=none,queues=4)&lt;/td>
&lt;td style="text-align:right">(125%)&lt;/td>
&lt;td style="text-align:left">(124%)&lt;/td>
&lt;td style="text-align:right">(102%)&lt;/td>
&lt;td style="text-align:left">(102%)&lt;/td>
&lt;td style="text-align:right">(52%)&lt;/td>
&lt;td style="text-align:left">(52%)&lt;/td>
&lt;td style="text-align:right">(30%)&lt;/td>
&lt;td style="text-align:left">(30%)&lt;/td>
&lt;td style="text-align:right">(91%)&lt;/td>
&lt;td style="text-align:left">(91%)&lt;/td>
&lt;td style="text-align:right">(94%)&lt;/td>
&lt;td style="text-align:left">(94%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Linux 虚拟机&lt;/td>
&lt;td style="text-align:right">13.0k&lt;/td>
&lt;td style="text-align:left">54.5MiB/s&lt;/td>
&lt;td style="text-align:right">8360&lt;/td>
&lt;td style="text-align:left">32.7MiB/s&lt;/td>
&lt;td style="text-align:right">13.1k&lt;/td>
&lt;td style="text-align:left">51.3MiB/s&lt;/td>
&lt;td style="text-align:right">8976&lt;/td>
&lt;td style="text-align:left">35.1MiB/s&lt;/td>
&lt;td style="text-align:right">2550&lt;/td>
&lt;td style="text-align:left">2551MiB/s&lt;/td>
&lt;td style="text-align:right">1045&lt;/td>
&lt;td style="text-align:left">1046MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=writeback)&lt;/td>
&lt;td style="text-align:right">(6667%)&lt;/td>
&lt;td style="text-align:left">(6969%)&lt;/td>
&lt;td style="text-align:right">(114%)&lt;/td>
&lt;td style="text-align:left">(114%)&lt;/td>
&lt;td style="text-align:right">(59%)&lt;/td>
&lt;td style="text-align:left">(59%)&lt;/td>
&lt;td style="text-align:right">(37%)&lt;/td>
&lt;td style="text-align:left">(37%)&lt;/td>
&lt;td style="text-align:right">(242%)&lt;/td>
&lt;td style="text-align:left">(242%)&lt;/td>
&lt;td style="text-align:right">(94%)&lt;/td>
&lt;td style="text-align:left">(94%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Linux 虚拟机&lt;/td>
&lt;td style="text-align:right">28.7k&lt;/td>
&lt;td style="text-align:left">112MiB/s&lt;/td>
&lt;td style="text-align:right">12.2k&lt;/td>
&lt;td style="text-align:left">47.5MiB/s&lt;/td>
&lt;td style="text-align:right">29.6k&lt;/td>
&lt;td style="text-align:left">116MiB/s&lt;/td>
&lt;td style="text-align:right">11.2k&lt;/td>
&lt;td style="text-align:left">43.8MiB/s&lt;/td>
&lt;td style="text-align:right">2931&lt;/td>
&lt;td style="text-align:left">2932MiB/s&lt;/td>
&lt;td style="text-align:right">1220&lt;/td>
&lt;td style="text-align:left">1220MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=writeback,queues=4)&lt;/td>
&lt;td style="text-align:right">(14718%)&lt;/td>
&lt;td style="text-align:left">(14322%)&lt;/td>
&lt;td style="text-align:right">(166%)&lt;/td>
&lt;td style="text-align:left">(166%)&lt;/td>
&lt;td style="text-align:right">(134%)&lt;/td>
&lt;td style="text-align:left">(134%)&lt;/td>
&lt;td style="text-align:right">(46%)&lt;/td>
&lt;td style="text-align:left">(46%)&lt;/td>
&lt;td style="text-align:right">(278%)&lt;/td>
&lt;td style="text-align:left">(278%)&lt;/td>
&lt;td style="text-align:right">(109%)&lt;/td>
&lt;td style="text-align:left">(109%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 虚拟机&lt;/td>
&lt;td style="text-align:right">2811&lt;/td>
&lt;td style="text-align:left">11.0MiB/s&lt;/td>
&lt;td style="text-align:right">6002&lt;/td>
&lt;td style="text-align:left">23.4MiB/s&lt;/td>
&lt;td style="text-align:right">11.8k&lt;/td>
&lt;td style="text-align:left">46.1MiB/s&lt;/td>
&lt;td style="text-align:right">4289&lt;/td>
&lt;td style="text-align:left">16.8MiB/s&lt;/td>
&lt;td style="text-align:right">1009&lt;/td>
&lt;td style="text-align:left">1009MiB/s&lt;/td>
&lt;td style="text-align:right">685&lt;/td>
&lt;td style="text-align:left">686MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=none)&lt;/td>
&lt;td style="text-align:right">(1441%)&lt;/td>
&lt;td style="text-align:left">(1407%)&lt;/td>
&lt;td style="text-align:right">(82%)&lt;/td>
&lt;td style="text-align:left">(82%)&lt;/td>
&lt;td style="text-align:right">(53%)&lt;/td>
&lt;td style="text-align:left">(53%)&lt;/td>
&lt;td style="text-align:right">(18%)&lt;/td>
&lt;td style="text-align:left">(18%)&lt;/td>
&lt;td style="text-align:right">(96%)&lt;/td>
&lt;td style="text-align:left">(96%)&lt;/td>
&lt;td style="text-align:right">(61%)&lt;/td>
&lt;td style="text-align:left">(61%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 虚拟机&lt;/td>
&lt;td style="text-align:right">2794&lt;/td>
&lt;td style="text-align:left">10.9MiB/s&lt;/td>
&lt;td style="text-align:right">7448&lt;/td>
&lt;td style="text-align:left">29.1MiB/s&lt;/td>
&lt;td style="text-align:right">21.1k&lt;/td>
&lt;td style="text-align:left">82.6MiB/s&lt;/td>
&lt;td style="text-align:right">25.5k&lt;/td>
&lt;td style="text-align:left">99.7MiB/s&lt;/td>
&lt;td style="text-align:right">930&lt;/td>
&lt;td style="text-align:left">930MiB/s&lt;/td>
&lt;td style="text-align:right">1013&lt;/td>
&lt;td style="text-align:left">1014MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=none,queues=4)&lt;/td>
&lt;td style="text-align:right">(1432%)&lt;/td>
&lt;td style="text-align:left">(1394%)&lt;/td>
&lt;td style="text-align:right">(101%)&lt;/td>
&lt;td style="text-align:left">(101%)&lt;/td>
&lt;td style="text-align:right">(95%)&lt;/td>
&lt;td style="text-align:left">(96%)&lt;/td>
&lt;td style="text-align:right">(104%)&lt;/td>
&lt;td style="text-align:left">(104%)&lt;/td>
&lt;td style="text-align:right">(88%)&lt;/td>
&lt;td style="text-align:left">(88%)&lt;/td>
&lt;td style="text-align:right">(91%)&lt;/td>
&lt;td style="text-align:left">(91%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 虚拟机&lt;/td>
&lt;td style="text-align:right">2483&lt;/td>
&lt;td style="text-align:left">9935KiB/s&lt;/td>
&lt;td style="text-align:right">7430&lt;/td>
&lt;td style="text-align:left">29.0MiB/s&lt;/td>
&lt;td style="text-align:right">10.9k&lt;/td>
&lt;td style="text-align:left">42.8MiB/s&lt;/td>
&lt;td style="text-align:right">13.6k&lt;/td>
&lt;td style="text-align:left">53.0MiB/s&lt;/td>
&lt;td style="text-align:right">1993&lt;/td>
&lt;td style="text-align:left">1994MiB/s&lt;/td>
&lt;td style="text-align:right">920&lt;/td>
&lt;td style="text-align:left">920MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=writeback)&lt;/td>
&lt;td style="text-align:right">(1273%)&lt;/td>
&lt;td style="text-align:left">(1270%)&lt;/td>
&lt;td style="text-align:right">(101%)&lt;/td>
&lt;td style="text-align:left">(101%)&lt;/td>
&lt;td style="text-align:right">(49%)&lt;/td>
&lt;td style="text-align:left">(50%)&lt;/td>
&lt;td style="text-align:right">(56%)&lt;/td>
&lt;td style="text-align:left">(55%)&lt;/td>
&lt;td style="text-align:right">(189%)&lt;/td>
&lt;td style="text-align:left">(189%)&lt;/td>
&lt;td style="text-align:right">(82%)&lt;/td>
&lt;td style="text-align:left">(82%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 虚拟机&lt;/td>
&lt;td style="text-align:right">4520&lt;/td>
&lt;td style="text-align:left">17.7MiB/s&lt;/td>
&lt;td style="text-align:right">18.8k&lt;/td>
&lt;td style="text-align:left">73.6MiB/s&lt;/td>
&lt;td style="text-align:right">23.3k&lt;/td>
&lt;td style="text-align:left">90.8MiB/s&lt;/td>
&lt;td style="text-align:right">21.8k&lt;/td>
&lt;td style="text-align:left">85.1MiB/s&lt;/td>
&lt;td style="text-align:right">2628&lt;/td>
&lt;td style="text-align:left">2628MiB/s&lt;/td>
&lt;td style="text-align:right">1191&lt;/td>
&lt;td style="text-align:left">1192MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=writeback,queues=4)&lt;/td>
&lt;td style="text-align:right">(2317%)&lt;/td>
&lt;td style="text-align:left">(2263%)&lt;/td>
&lt;td style="text-align:right">(2558%)&lt;/td>
&lt;td style="text-align:left">(2564%)&lt;/td>
&lt;td style="text-align:right">(105%)&lt;/td>
&lt;td style="text-align:left">(105%)&lt;/td>
&lt;td style="text-align:right">(89%)&lt;/td>
&lt;td style="text-align:left">(89%)&lt;/td>
&lt;td style="text-align:right">(249%)&lt;/td>
&lt;td style="text-align:left">(249%)&lt;/td>
&lt;td style="text-align:right">(106%)&lt;/td>
&lt;td style="text-align:left">(106%)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="测试结论">测试结论&lt;/h4>
&lt;ol>
&lt;li>和物理机相比，在4KB随机读写，1MB顺序读写方面，有10%左右的虚拟化开销。可以认为虚拟机性能和物理机相当。由于缓存的作用，虚拟机性能在某些场景甚至超过物理机。&lt;/li>
&lt;li>开启writeback和多队列之后，写性能有明显加速&lt;/li>
&lt;li>在4KB顺序读写性能方面，虚拟机仅有物理机的一半性能。这是因为磁盘采用thin provision方式，虚拟机内的顺序读写转换到物理机其实是随机读写。为了改善虚拟机4KB顺序读写性能，需要将虚拟磁盘文件进行预分配。这样虚拟机内的顺序读写在物理机也是顺序读写。&lt;/li>
&lt;/ol>
&lt;h3 id="共享存储cephio性能测试">共享存储(ceph)IO性能测试&lt;/h3>
&lt;h4 id="测试环境-2">测试环境&lt;/h4>
&lt;p>1、宿主机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.9.2009 (Core)
内核：3.10.0-1062.4.3.el7.yn20191203.x86_64
CPU: Intel(R) Xeon(R) CPU E5-2678 v3 @ 2.50GHz
内存：256GB
&lt;/code>&lt;/pre>
&lt;p>2、虚拟机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.6.1810 (Core)
内核：3.10.0-957.12.1.el7.x86_64
配置：4核CPU4G内存30G系统盘100G数据盘
&lt;/code>&lt;/pre>
&lt;p>3、Ceph存储配置&lt;/p>
&lt;pre>&lt;code>网卡：2x10G双光口存储网 + 2x10G双光口接入网
磁盘：全闪SSD
&lt;/code>&lt;/pre>
&lt;h4 id="测试数据">测试数据&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>场景&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">随机读&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">随机写&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">顺序读&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">顺序写&lt;/th>
&lt;th style="text-align:right">1MB&lt;/th>
&lt;th style="text-align:left">顺序读&lt;/th>
&lt;th style="text-align:right">1MB&lt;/th>
&lt;th style="text-align:left">顺序写&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cache=none&lt;/td>
&lt;td style="text-align:right">1054&lt;/td>
&lt;td style="text-align:left">4217KiB/s&lt;/td>
&lt;td style="text-align:right">405&lt;/td>
&lt;td style="text-align:left">1622KiB/s&lt;/td>
&lt;td style="text-align:right">1864&lt;/td>
&lt;td style="text-align:left">7456KiB/s&lt;/td>
&lt;td style="text-align:right">552&lt;/td>
&lt;td style="text-align:left">2209KiB/s&lt;/td>
&lt;td style="text-align:right">159&lt;/td>
&lt;td style="text-align:left">159MiB/s&lt;/td>
&lt;td style="text-align:right">163&lt;/td>
&lt;td style="text-align:left">164MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cache=none,queues=4&lt;/td>
&lt;td style="text-align:right">1152&lt;/td>
&lt;td style="text-align:left">4608KiB/s&lt;/td>
&lt;td style="text-align:right">441&lt;/td>
&lt;td style="text-align:left">1767KiB/s&lt;/td>
&lt;td style="text-align:right">2066&lt;/td>
&lt;td style="text-align:left">8265KiB/s&lt;/td>
&lt;td style="text-align:right">368&lt;/td>
&lt;td style="text-align:left">1472KiB/s&lt;/td>
&lt;td style="text-align:right">168&lt;/td>
&lt;td style="text-align:left">169MiB/s&lt;/td>
&lt;td style="text-align:right">168&lt;/td>
&lt;td style="text-align:left">168MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cache=writeback&lt;/td>
&lt;td style="text-align:right">978&lt;/td>
&lt;td style="text-align:left">3913KiB/s&lt;/td>
&lt;td style="text-align:right">9425&lt;/td>
&lt;td style="text-align:left">36.8MiB/s&lt;/td>
&lt;td style="text-align:right">1623&lt;/td>
&lt;td style="text-align:left">6494KiB/s&lt;/td>
&lt;td style="text-align:right">10.7k&lt;/td>
&lt;td style="text-align:left">41.7MiB/s&lt;/td>
&lt;td style="text-align:right">149&lt;/td>
&lt;td style="text-align:left">149MiB/s&lt;/td>
&lt;td style="text-align:right">474&lt;/td>
&lt;td style="text-align:left">474MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cache=writeback,queues=4&lt;/td>
&lt;td style="text-align:right">1071&lt;/td>
&lt;td style="text-align:left">4284KiB/s&lt;/td>
&lt;td style="text-align:right">12.6k&lt;/td>
&lt;td style="text-align:left">49.3MiB/s&lt;/td>
&lt;td style="text-align:right">1711&lt;/td>
&lt;td style="text-align:left">6848KiB/s&lt;/td>
&lt;td style="text-align:right">15.1k&lt;/td>
&lt;td style="text-align:left">59.1MiB/s&lt;/td>
&lt;td style="text-align:right">161&lt;/td>
&lt;td style="text-align:left">161MiB/s&lt;/td>
&lt;td style="text-align:right">475&lt;/td>
&lt;td style="text-align:left">475MiB/s&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="测试结论-1">测试结论&lt;/h4>
&lt;ol>
&lt;li>开启writeback和多队列能够明显提升写性能&lt;/li>
&lt;li>读性能比较难优化，可以调高虚拟机内的 read ahead 缓存（blockdev &amp;ndash;setra /dev/sda）&lt;/li>
&lt;li>Ceph并未把网络打满，也未能用满SSD的性能，性能瓶颈感觉还是在软件层面&lt;/li>
&lt;/ol>
&lt;h3 id="网络测试">网络测试&lt;/h3>
&lt;h4 id="测试条件">测试条件&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>默认情况下虚拟机有流量限制，需要在前端或者用命令行工具 &lt;code>climc server-change-bandwidth&lt;/code> 把带宽改为 0 ，表示取消限速。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>默认情况下，VPC虚拟机的EIP也有带宽限制（默认30Mbps），也需要在前端，或者用climc修改限制为0，表示取消限制。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h4 id="测试方法-1">测试方法:&lt;/h4>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 找一台机器运行 iperf server 模式，假设 ip 是 10.127.100.3&lt;/span>
$ iperf3 -s --bind 10.127.100.3
&lt;span style="color:#8f5902;font-style:italic"># 在另外一台机器作为 iperf client 模式连接 server&lt;/span>
$ iperf3 -c 10.127.100.3 -t &lt;span style="color:#0000cf;font-weight:bold">30&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>以上重复执行三次，取最好的一次。&lt;/p>
&lt;h4 id="经典网络性能测试">经典网络性能测试&lt;/h4>
&lt;h5 id="环境">环境&lt;/h5>
&lt;p>1、宿主机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.9.2009 (Core)
内核：3.10.0-1062.4.3.el7.yn20191203.x86_64
CPU: Intel(R) Xeon(R) CPU E5-2678 v3 @ 2.50GHz
内存：256GB
&lt;/code>&lt;/pre>
&lt;p>2、虚拟机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.6.1810 (Core)
内核：3.10.0-957.12.1.el7.x86_64
配置：2核CPU 2G内存 30G系统盘
&lt;/code>&lt;/pre>
&lt;h5 id="结论">结论&lt;/h5>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>源 \ 目的&lt;/th>
&lt;th>物理机&lt;/th>
&lt;th>虚拟机&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>物理机&lt;/td>
&lt;td>8.35 Gbps (100%)&lt;/td>
&lt;td>8.40 Gbps (101%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>虚拟机&lt;/td>
&lt;td>8.41 Gbps (101%)&lt;/td>
&lt;td>8.33 Gbps (99.7%)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>说明：饱和流量测试，网路虚拟化开销很低（1%量级）。&lt;/p>
&lt;h4 id="vpc网络性能测试">VPC网络性能测试&lt;/h4>
&lt;h5 id="测试环境-3">测试环境&lt;/h5>
&lt;p>1、宿主机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.7.1908 (Core)
内核：5.4.130-1.yn20210710.el7.x86_64
CPU: Intel(R) Xeon(R) Gold 5218R CPU @ 2.10GHz
内存：256GB
&lt;/code>&lt;/pre>
&lt;p>2、虚拟机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.8.2003
内核：3.10.0-1127.el7.x86_64
配置：2核CPU 2G内存 30G系统盘
&lt;/code>&lt;/pre>
&lt;h5 id="结论-1">结论&lt;/h5>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>场景&lt;/th>
&lt;th>物理机到物理机&lt;/th>
&lt;th>虚拟机到虚拟机&lt;/th>
&lt;th>虚拟机EIP到虚拟机EIP&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>性能 (Gbps)&lt;/td>
&lt;td>9.19 (100%)&lt;/td>
&lt;td>8.96 (97%)&lt;/td>
&lt;td>5.83 (63%)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>说明：饱和流量情况下，网络虚拟化开销很低（3%量级）。由于转换路径较长，EIP的性能要差很多（36%损耗）。&lt;/p></description></item><item><title>Docs: 内存大页(Hugepage)</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/hugepage/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/hugepage/</guid><description>
&lt;p>内置私有云支持虚拟机使用内存大页（Hugepage）。使用内存大页有助于减少内存碎片，提高虚拟机访问内存效率，从而提高虚拟机性能。&lt;/p>
&lt;p>通过设置每台宿主机的配置(/etc/yunion/host.conf) hugepages_option 来关闭或开启大页，该选项的值有三个：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>disable: 不开启大页支持&lt;/p>
&lt;/li>
&lt;li>
&lt;p>transparent：开启透明大页支持，该选项为默认选项。启用透明大页支持后，操作系统会尽力而为地为虚拟机使用大页内存，并且自动地将虚拟机的普通内存合并为大页内存。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>native：开启原生大页内存支持，这种模式需要显式地分配大页内存池，并且虚拟机使用的内存需要预先从大页内存池中预留分配，并作为参数传递给虚拟机使用。这种方式能够保证内存的连续性，可以分配1G的大页内存，提供最佳的性能。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>使用透明大页支持比较方便，只需要设置 hugepages_option 为 transparent。但这种方式无法使用1G的大页，并且并不保证虚拟机总是使用大页内存。&lt;/p>
&lt;h2 id="开启native大页内存">开启native大页内存&lt;/h2>
&lt;p>通过 ocboot 部署的环境默认会安装 &lt;code>oc-hugetlb-gigantic-pages.service&lt;/code> 服务，可使用 &lt;code>systemctl status oc-hugetlb-gigantic-pages.service&lt;/code> 查看&lt;/p>
&lt;h3 id="部署时开启大页">部署时开启大页&lt;/h3>
&lt;p>ocboot config.yaml 中设置 enable_hugepage 为 true，宿主机为 x86_64架构，且内存超过 30G时生效，预留内存为总内存的10%，最大预留20G内存。&lt;/p>
&lt;pre>&lt;code> as_host: true
# 虚拟机强行作为 OneCloud 私有云计算节点（默认为 false）。开启此项时，请确保as_host: true
as_host_on_vm: true
# 是否宿主机开启大页内存(宿主机为 x86_64架构，且内存超过 30G时生效，预留内存为总内存的10%，最大预留20G内存)
enable_hugepage: false
&lt;/code>&lt;/pre>&lt;h3 id="部署完成后想开启大页">部署完成后想开启大页&lt;/h3>
&lt;p>环境部署完成后想启用native大页：&lt;/p>
&lt;p>1、设置/etc/yunion/host.conf的hugepages_options 为 native&lt;/p>
&lt;p>2、重启宿主机&lt;/p>
&lt;p>重启后，查看如下参数，确认1GB大页内存是否预留成功&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ cat /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages
&lt;span style="color:#0000cf;font-weight:bold">110&lt;/span>
$ cat /sys/kernel/mm/hugepages/hugepages-1048576kB/free_hugepages
&lt;span style="color:#0000cf;font-weight:bold">110&lt;/span>
$ free -h
total used free shared buff/cache available
Mem: 125G 113G 7.6G 4.5M 4.5G 11G
Swap: 0B 0B 0B
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置预留内存">配置预留内存&lt;/h3>
&lt;p>默认情况下预留内存是宿主机当前内存的 %10，最大不超过 20G，如果想要手动配置宿主机的预留内存，则可以通过设置 RESERVED_MEM 来配置。&lt;/p>
&lt;pre>&lt;code>[Unit]
Description=OC HugeTLB Gigantic Pages Reservation
DefaultDependencies=no
Before=dev-hugepages.mount
ConditionPathExists=/sys/kernel/mm/hugepages
ConditionKernelCommandLine=hugepagesz=1G
[Service]
Type=oneshot
RemainAfterExit=yes
# Environment=&amp;quot;RESERVED_MEM=24&amp;quot; # 可配置的 RESERVED_MEM
ExecStart=/usr/lib/systemd/oc-hugetlb-reserve-pages.sh
[Install]
WantedBy=sysinit.targe
&lt;/code>&lt;/pre></description></item><item><title>Docs: 调试QEMU参数</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/customize/</link><pubDate>Fri, 19 Jul 2019 18:32:40 +0800</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/customize/</guid><description>
&lt;p>本文介绍如何调试 Cloudpods KVM虚拟机的配置参数。&lt;/p>
&lt;h2 id="hahahugoshortcode-s1-hbhb-kvm虚拟机的配置存储位置一般在宿主机的-optcloudworkspaceservers-下该位置可以修改-etcyunionhostconf-的-servers_path">Cloudpods KVM虚拟机的配置存储位置一般在宿主机的 /opt/cloud/workspace/servers 下，该位置可以修改 /etc/yunion/host.conf 的 servers_path&lt;/h2>
&lt;p>在 servers 目录下，每个虚拟机ID的目录存储了该虚拟机相关的配置文件，主要的文件有：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">3114&lt;/span> May &lt;span style="color:#0000cf;font-weight:bold">17&lt;/span> 10:53 desc
-rwx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">344&lt;/span> Jun &lt;span style="color:#0000cf;font-weight:bold">22&lt;/span> 10:07 &lt;span style="color:#204a87;font-weight:bold">if&lt;/span>-down-br0-vnet222-252.sh
-rwx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">1074&lt;/span> Jun &lt;span style="color:#0000cf;font-weight:bold">22&lt;/span> 10:07 &lt;span style="color:#204a87;font-weight:bold">if&lt;/span>-up-br0-vnet222-252.sh
-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">2810&lt;/span> Jun &lt;span style="color:#0000cf;font-weight:bold">22&lt;/span> 10:07 startvm
-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">661&lt;/span> Jun &lt;span style="color:#0000cf;font-weight:bold">22&lt;/span> 10:07 stopvm
&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中，startvm 为启动虚拟机的脚本文件，包含了该虚拟机启动的所有命令行参数，可以修改该文件的qemu启动参数来实现调试qemu启动参数的目的。&lt;/p>
&lt;p>一般步骤为：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>停止虚拟机&lt;/p>
&lt;/li>
&lt;li>
&lt;p>修改该虚拟机的startvm脚本参数&lt;/p>
&lt;/li>
&lt;li>
&lt;p>以root身份启动虚拟机：sh startvm&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在前端，对虚拟机执行“同步状态”的操作&lt;/p>
&lt;/li>
&lt;li>
&lt;p>同步状态后，前端显示该虚拟机为运行状态，即可查看该虚拟机的vnc终端，以及进行其他控制操作&lt;/p>
&lt;/li>
&lt;/ol></description></item><item><title>Docs: 清除虚拟机记录</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/purge/</link><pubDate>Thu, 11 Nov 2021 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/purge/</guid><description>
&lt;p>以虚拟机Id为 a77d4f36-5484-47d9-8f12-26c7f0dd48f3 进行举例&lt;/p>
&lt;h4 id="1-查找虚拟机的宿主机id">1. 查找虚拟机的宿主机Id&lt;/h4>
&lt;pre>&lt;code>$ climc server-show a77d4f36-5484-47d9-8f12-26c7f0dd48f3 | grep host_id
| host_id | 84c82f1f-7b25-4260-8996-58d60e79ef7d
&lt;/code>&lt;/pre>&lt;h4 id="2-禁用虚拟机所在的宿主机">2. 禁用虚拟机所在的宿主机&lt;/h4>
&lt;pre>&lt;code>$ climc host-disable 84c82f1f-7b25-4260-8996-58d60e79ef7d
+--------------------------------------+------------------+-------------------+---------------+---------+---------+-------------+--------+----------------+---------+--------------+-----------------+--------------+---------------------+----------+------------+-----------+------------+--------------------+-------------------+------------------+------------+----------+--------------+-----------+-------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-----------+----------------+--------------+
| ID | Name | Access_mac | Access_ip | Status | enabled | host_status | Guests | Running_guests | storage | storage_used | storage_virtual | storage_free | storage_commit_rate | mem_size | mem_commit | cpu_count | cpu_commit | cpu_commit_rate | mem_commit_rate | cpu_commit_bound | node_count | sn | storage_type | host_type | version | schedtags | storage_size | domain_id | project_domain | public_scope |
+--------------------------------------+------------------+-------------------+---------------+---------+---------+-------------+--------+----------------+---------+--------------+-----------------+--------------+---------------------+----------+------------+-----------+------------+--------------------+-------------------+------------------+------------+----------+--------------+-----------+-------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-----------+----------------+--------------+
| 84c82f1f-7b25-4260-8996-58d60e79ef7d | office-03-host01 | 6c:0b:84:0c:e8:44 | 192.168.222.3 | running | false | online | 37 | 21 | 7381235 | 3332096 | 7381235 | 4049139 | 0.45 | 128703 | 95232 | 24 | 73 | 3.0416666666666665 | 0.803896575301993 | 8 | 2 | PC0169QS | rotate | cloudpods | hotfix/qj-cleanup-openvswitch-conf(d7f77fff821092421) | [{&amp;quot;id&amp;quot;:&amp;quot;a9c14466-e63d-46c9-80f4-52a14945b9d5&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;container&amp;quot;,&amp;quot;res_name&amp;quot;:&amp;quot;schedtag&amp;quot;},{&amp;quot;id&amp;quot;:&amp;quot;01fa585c-c670-4b2e-83bd-9070ac7a37d7&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;wcl-test-避免使用&amp;quot;,&amp;quot;res_name&amp;quot;:&amp;quot;schedtag&amp;quot;}] | 7569007 | default | Default | none |
+--------------------------------------+------------------+-------------------+---------------+---------+---------+-------------+--------+----------------+---------+--------------+-----------------+--------------+---------------------+----------+------------+-----------+------------+--------------------+-------------------+------------------+------------+----------+--------------+-----------+-------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-----------+----------------+--------------+
*** Total: 1 ***
&lt;/code>&lt;/pre>&lt;h4 id="3-禁用虚拟机删除保护">3. 禁用虚拟机删除保护&lt;/h4>
&lt;pre>&lt;code>$ climc server-update --delete enable a77d4f36-5484-47d9-8f12-26c7f0dd48f3
+--------------------------------------+---------+--------------+----------------+-------+---------+------------+-----------+------------+--------------------------------------+-----------------------------+------------+---------+------------------+--------+-----------+
| ID | Name | Billing_type | IPs | Disk | Status | vcpu_count | vmem_size | Secgroup | Secgrp_id | Created_at | Hypervisor | os_type | Host | Tenant | is_system |
+--------------------------------------+---------+--------------+----------------+-------+---------+------------+-----------+------------+--------------------------------------+-----------------------------+------------+---------+------------------+--------+-----------+
| a77d4f36-5484-47d9-8f12-26c7f0dd48f3 | zy-test | postpaid | 192.168.10.245 | 30720 | unknown | 2 | 2048 | Default-19 | b48ea3b1-4e3c-4303-8bfe-5bb2223fdc45 | 2021-09-16T07:29:28.000000Z | cloudpods | Linux | office-03-host01 | system | false |
+--------------------------------------+---------+--------------+----------------+-------+---------+------------+-----------+------------+--------------------------------------+-----------------------------+------------+---------+------------------+--------+-----------+
*** Total: 1 ***
&lt;/code>&lt;/pre>&lt;h4 id="4-清理虚拟机数据库记录">4. 清理虚拟机数据库记录&lt;/h4>
&lt;pre>&lt;code>$ climc server-purge a77d4f36-5484-47d9-8f12-26c7f0dd48f3
+--------------------------------------+---------+--------------+----------------+-------+--------------+------------+-----------+------------+--------------------------------------+-----------------------------+------------+---------+------------------+--------+-----------+
| ID | Name | Billing_type | IPs | Disk | Status | vcpu_count | vmem_size | Secgroup | Secgrp_id | Created_at | Hypervisor | os_type | Host | Tenant | is_system |
+--------------------------------------+---------+--------------+----------------+-------+--------------+------------+-----------+------------+--------------------------------------+-----------------------------+------------+---------+------------------+--------+-----------+
| a77d4f36-5484-47d9-8f12-26c7f0dd48f3 | zy-test | postpaid | 192.168.10.245 | 30720 | start_delete | 2 | 2048 | Default-19 | b48ea3b1-4e3c-4303-8bfe-5bb2223fdc45 | 2021-09-16T07:29:28.000000Z | cloudpods | Linux | office-03-host01 | system | false |
+--------------------------------------+---------+--------------+----------------+-------+--------------+------------+-----------+------------+--------------------------------------+-----------------------------+------------+---------+------------------+--------+-----------+
*** Total: 1 ***
&lt;/code>&lt;/pre>&lt;h4 id="5-启用宿主机">5. 启用宿主机&lt;/h4>
&lt;pre>&lt;code>$ climc host-enable 84c82f1f-7b25-4260-8996-58d60e79ef7d
+--------------------------------------+------------------+-------------------+---------------+---------+---------+-------------+--------+----------------+---------+--------------+-----------------+--------------+---------------------+----------+------------+-----------+------------+--------------------+-------------------+------------------+------------+----------+--------------+-----------+-------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-----------+----------------+--------------+
| ID | Name | Access_mac | Access_ip | Status | enabled | host_status | Guests | Running_guests | storage | storage_used | storage_virtual | storage_free | storage_commit_rate | mem_size | mem_commit | cpu_count | cpu_commit | cpu_commit_rate | mem_commit_rate | cpu_commit_bound | node_count | sn | storage_type | host_type | version | schedtags | storage_size | domain_id | project_domain | public_scope |
+--------------------------------------+------------------+-------------------+---------------+---------+---------+-------------+--------+----------------+---------+--------------+-----------------+--------------+---------------------+----------+------------+-----------+------------+--------------------+-------------------+------------------+------------+----------+--------------+-----------+-------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-----------+----------------+--------------+
| 84c82f1f-7b25-4260-8996-58d60e79ef7d | office-03-host01 | 6c:0b:84:0c:e8:44 | 192.168.222.3 | running | true | online | 36 | 21 | 7381235 | 3301376 | 7381235 | 4079859 | 0.45 | 128703 | 95232 | 24 | 73 | 3.0416666666666665 | 0.803896575301993 | 8 | 2 | PC0169QS | rotate | cloudpods | hotfix/qj-cleanup-openvswitch-conf(d7f77fff821092421) | [{&amp;quot;id&amp;quot;:&amp;quot;a9c14466-e63d-46c9-80f4-52a14945b9d5&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;container&amp;quot;,&amp;quot;res_name&amp;quot;:&amp;quot;schedtag&amp;quot;},{&amp;quot;id&amp;quot;:&amp;quot;01fa585c-c670-4b2e-83bd-9070ac7a37d7&amp;quot;,&amp;quot;name&amp;quot;:&amp;quot;wcl-test-避免使用&amp;quot;,&amp;quot;res_name&amp;quot;:&amp;quot;schedtag&amp;quot;}] | 7569007 | default | Default | none |
+--------------------------------------+------------------+-------------------+---------------+---------+---------+-------------+--------+----------------+---------+--------------+-----------------+--------------+---------------------+----------+------------+-----------+------------+--------------------+-------------------+------------------+------------+----------+--------------+-----------+-------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------+-----------+----------------+--------------+
*** Total: 1 ***
&lt;/code>&lt;/pre></description></item><item><title>Docs: 虚拟机时钟</title><link>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/time/</link><pubDate>Mon, 10 Oct 2022 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org//v3.9/zh/docs/function_principle/onpremise/vminstance/time/</guid><description>
&lt;p>虚拟机时钟由虚拟设备&lt;code>-rtc base=utc,clock=host,driftfix=none&lt;/code>，虚拟机硬件基准时钟基于宿主机的UTC时间。&lt;/p>
&lt;p>因此，虚拟机需要配置其硬件时钟为UTC时间，如果没有正确配置，则容易出现虚拟机时间不准的情况。&lt;/p>
&lt;p>下面介绍虚拟机配置硬件时钟为UTC时间的方法。&lt;/p>
&lt;h3 id="linux系统">Linux系统&lt;/h3>
&lt;p>修改/etc/adjtime，将第三行设置为UTC&lt;/p>
&lt;h3 id="windows系统">Windows系统&lt;/h3>
&lt;p>运行regedit，打开注册表，在HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TimeZoneInformation下，右键新建New &amp;gt; DWORD (32-bit) Value，命名为RealTimeIsUniversal，键值为1。&lt;/p></description></item></channel></rss>