"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[9666],{38336:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>d});var r=n(74848),t=n(28453);const o={sidebar_position:14},c="\u5b9a\u4f4d\u540e\u7aef\u4ee3\u7801",i={id:"development/loc-api-model",title:"\u5b9a\u4f4d\u540e\u7aef\u4ee3\u7801",description:"\u4ecb\u7ecd\u5982\u4f55\u4ece\u524d\u7aefAPI\u8bf7\u6c42\u5b9a\u4f4d\u5230\u540e\u7aef\u4ee3\u7801\u3002",source:"@site/docs/development/loc-api-model.md",sourceDirName:"development",slug:"/development/loc-api-model",permalink:"/v3.10/en/docs/development/loc-api-model",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/development/loc-api-model.md",tags:[],version:"current",sidebarPosition:14,frontMatter:{sidebar_position:14},sidebar:"tutorialSidebar",previous:{title:"Ceph \u5bf9\u63a5",permalink:"/v3.10/en/docs/development/ceph"},next:{title:"\u6dfb\u52a0\u4e00\u4e2aAPI\u7684\u8fc7\u7a0b",permalink:"/v3.10/en/docs/development/add-api"}},a={},d=[{value:"\u67e5\u770b\u524d\u7aef\u8bf7\u6c42",id:"\u67e5\u770b\u524d\u7aef\u8bf7\u6c42",level:2}];function l(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h1,{id:"\u5b9a\u4f4d\u540e\u7aef\u4ee3\u7801",children:"\u5b9a\u4f4d\u540e\u7aef\u4ee3\u7801"}),"\n",(0,r.jsx)(s.p,{children:"\u4ecb\u7ecd\u5982\u4f55\u4ece\u524d\u7aefAPI\u8bf7\u6c42\u5b9a\u4f4d\u5230\u540e\u7aef\u4ee3\u7801\u3002"}),"\n",(0,r.jsx)(s.h2,{id:"\u67e5\u770b\u524d\u7aef\u8bf7\u6c42",children:"\u67e5\u770b\u524d\u7aef\u8bf7\u6c42"}),"\n",(0,r.jsx)(s.p,{children:"\u8fd9\u91cc\u4ee5\u865a\u62df\u673a\u4e3e\u4f8b"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"\u6253\u5f00\u865a\u62df\u673a\u5217\u8868\u754c\u9762"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{src:n(66991).A+"",width:"3016",height:"1666"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"\u53f3\u952e\u6253\u5f00\u68c0\u67e5\u5e76\u5207\u6362\u5230Network"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{src:n(63378).A+"",width:"3016",height:"1340"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"\u70b9\u51fb\u5237\u65b0\u5e76\u67e5\u770b\u7f51\u7edc\u8bf7\u6c42"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{src:n(53096).A+"",width:"3016",height:"1666"})}),"\n",(0,r.jsxs)(s.p,{children:["\u8fd9\u91cc\u770b\u5230API\u8bf7\u6c42\u662f GET ",(0,r.jsx)(s.a,{href:"https://office.ioito.com/api/v2/servers",children:"https://office.ioito.com/api/v2/servers"})," \u5176\u4ed6\u8bf7\u6c42\u53ef\u4ee5\u67e5\u770b\u4e0b",(0,r.jsx)(s.a,{href:"./backend-framework/#model-dispatcher",children:"API\u8bf7\u6c42\u65b9\u6cd5"})]}),"\n",(0,r.jsx)(s.p,{children:"\u53ef\u4ee5\u786e\u5b9a\u662f\u8bf7\u6c42\u7684\u662fservers\u8d44\u6e90"}),"\n",(0,r.jsx)(s.h1,{id:"\u901a\u8fc7\u8d44\u6e90\u540d\u79f0\u5b9a\u4f4d\u4ee3\u7801",children:"\u901a\u8fc7\u8d44\u6e90\u540d\u79f0\u5b9a\u4f4d\u4ee3\u7801"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'# \u8fdb\u5165\u5230cloudpods\u6e90\u7801\u76ee\u5f55\n$ cd cloudpods\n\n# \u901a\u8fc7\u5173\u952e\u5b57\'servers\'\u67e5\u627e\n$ grep -r \'servers\' pkg/mcclient/modules\npkg/mcclient/modules/compute/mod_servers.go:    Servers = ServerManager{modules.NewComputeManager("server", "servers",\npkg/mcclient/modules/compute/mod_skus.go:       ServerSkus = ServerSkusManager{modules.NewComputeManager("serversku", "serverskus",\n\n\n# \u53ef\u4ee5\u770b\u5230servers\u5c5e\u4e8ecompute(region)\u670d\u52a1,\u73b0\u5728\u5230compute\u670d\u52a1\u7684\u6a21\u578b\u91cc\u9762\u641c\u7d22servers\u5173\u952e\u5b57\n$ grep -r \'servers\' pkg/compute/models\npkg/compute/models/loadbalanceragents.go:       servers = ["{{ .telegraf.haproxy_input_stats_socket }}"]\npkg/compute/models/skus.go:                     "serverskus_tbl",\npkg/compute/models/skus.go:                     "serversku",\npkg/compute/models/skus.go:                     "serverskus",\npkg/compute/models/skus.go:             return httperrors.NewNotEmptyError("now allow to delete inuse instance_type.please remove related servers first: %s", self.Name)\npkg/compute/models/skus.go:             return httperrors.NewNotEmptyError("instance_type used by servers")\npkg/compute/models/skus.go:     lockman.LockRawObject(ctx, "serverskus", region.Id)\npkg/compute/models/skus.go:     defer lockman.ReleaseRawObject(ctx, "serverskus", region.Id)\npkg/compute/models/skus.go:     lockman.LockRawObject(ctx, "serverskus", region.Id)\npkg/compute/models/skus.go:     defer lockman.ReleaseRawObject(ctx, "serverskus", region.Id)\npkg/compute/models/guests.go:// +onecloud:swagger-gen-model-plural=servers\npkg/compute/models/guests.go:                   "servers",\npkg/compute/models/guests.go:           // fake delete expired prepaid servers\npkg/compute/models/groups.go:                   return nil, errors.Wrapf(httperrors.ErrInvalidStatus, "inconsistent networkId for member servers")\npkg/compute/models/hosts.go:                    "__on_host_down":              "shutdown-servers",\npkg/compute/models/hosts.go:            _, err := self.Request(ctx, userCred, "POST", "/hosts/shutdown-servers-on-host-down",\npkg/compute/models/hosts.go:                    db.OpsLog.LogEvent(host, db.ACT_HOST_DOWN, fmt.Sprintf("migrate servers failed %s", err), userCred)\npkg/compute/models/keypairs.go:         return httperrors.NewNotEmptyError("Cannot delete keypair used by servers")\npkg/compute/models/disks.go:            return httperrors.NewNotEmptyError("Virtual disk %s(%s) used by virtual servers", self.Name, self.Id)\npkg/compute/models/guest_actions.go:    url := fmt.Sprintf("%s/servers/%s/monitor", host.ManagerUri, self.Id)\npkg/compute/models/guest_actions.go:    taskData.Set("servers", jsonutils.Marshal(host.Servers))\n\n# \u4ece\u4e0a\u53ef\u4ee5\u770b\u5230\u53ea\u6709 pkg/compute/models/guests.go \u6587\u4ef6\u6709\u5b8c\u6574\u7684 servers \u5173\u952e\u5b57, \u53ef\u4ee5\u786e\u5b9a\u4ee3\u7801\u5c31\u4f4d\u4e8e\u6b64\u6587\u4ef6\n# \u6211\u4eec\u8be6\u7ec6\u4ecb\u7ecd\u4e0bguests.go\u6587\u4ef6\n$ cat pkg/compute/models/guests.go | grep \'"servers"\' -A 7 -B 6\nfunc init() {\n        GuestManager = &SGuestManager{\n                SVirtualResourceBaseManager: db.NewVirtualResourceBaseManager(\n                        SGuest{},\n                        "guests_tbl",\n                        "server",\n                        "servers",\n                ),\n                SRecordChecksumResourceBaseManager: *db.NewRecordChecksumResourceBaseManager(),\n        }\n        GuestManager.SetVirtualObject(GuestManager)\n        GuestManager.SetAlias("guest", "guests")\n        GuestManager.NameRequireAscii = false\n}\n\n# \u4ece\u4e0a\u9762\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u521d\u59cb\u5316\u4e86\u865a\u62df\u673a\u7684Manager, \u865a\u62df\u673a\u6570\u636e\u662f\u5b58\u50a8\u5728\u6570\u636e\u5e93guests_tbl\u8fd9\u4e2a\u8868\u91cc\u9762\n'})}),"\n",(0,r.jsx)(s.h1,{id:"\u7279\u6b8aapi\u8bf7\u6c42\u8bf4\u660e",children:"\u7279\u6b8aAPI\u8bf7\u6c42\u8bf4\u660e"}),"\n",(0,r.jsxs)(s.p,{children:["\u5927\u90e8\u5206\u8bf7\u6c42\u90fd\u53ef\u4ee5\u4ece\u4e0a\u9762\u7684\u65b9\u6cd5\u627e\u5230\u540e\u7aef\u4ee3\u7801, \u4f46\u90e8\u5206API\u8bf7\u6c42\u662f\u7531\u7f51\u5173\u76f4\u63a5\u6ce8\u518c\u7684\n\u8fd9\u7c7b\u7684API\u9700\u8981\u67e5\u770b",(0,r.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg/apigateway",children:"API\u7f51\u5173"}),"\u4ee3\u7801"]}),"\n",(0,r.jsx)(s.p,{children:"\u8fd9\u91cc\u4ee5RPC API\u4e3e\u4f8b\u8bf4\u660e"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["\u70b9\u51fb\u83b7\u53d6\u865a\u62df\u673a\u5bc6\u7801\u67e5\u770bapi\u8bf7\u6c42\n",(0,r.jsx)(s.img,{src:n(48625).A+"",width:"3018",height:"1614"})]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"# \u641c\u5bfbrpc\u5173\u952e\u5b57\n$ grep -r 'rpc' pkg/apigateway/handler\npkg/apigateway/handler/rpc.go:  h.AddByMethod(GET, mf, NewHP(RpcHandler, APIVer, \"rpc\"))\npkg/apigateway/handler/rpc.go:  h.AddByMethod(POST, mf, NewHP(RpcHandler, APIVer, \"rpc\"))\n\n\n# \u901a\u8fc7\u67e5\u770bAPI\u7f51\u5173RpcHandler\u6e90\u7801\u53ef\u77e5, RPC\u8bf7\u6c42\u662f\u4f9d\u9760\u53cd\u5c04\u8c03\u7528mcclient\u6a21\u578b\u4e2d\u7684GetXXX\u6216DoXXX\u5b9e\u73b0\u7684\n# \u8fd9\u91cc\u7684XXX\u662f\u9a7c\u5cf0\u547d\u540d\n# \u8fd9\u91cc\u770b\u5230\u662fGET\u8bf7\u6c42\uff0c\u56e0\u6b64\u53ef\u4ee5\u77e5\u9053\u662f\u8c03\u7528\u4e86servers\u91cc\u9762\u7684GetLoginInfo\n# \u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u987a\u5229\u627e\u5230\u76f8\u5173\u7684\u5b9e\u73b0\n$ grep -r 'GetLoginInfo' pkg/mcclient/modules/compute\npkg/mcclient/modules/compute/mod_servers.go:func (this *ServerManager) GetLoginInfo(s *mcclient.ClientSession, id string, params jsonutils.JSONObject) (jsonutils.JSONObject, error) {\npkg/mcclient/modules/compute/mod_hosts.go:func (this *HostManager) GetLoginInfo(s *mcclient.ClientSession, id string, params jsonutils.JSONObject) (jsonutils.JSONObject, error) {\npkg/mcclient/modules/compute/mod_dbinstanceaccounts.go:func (this *SDBInstanceAccountManager) GetLoginInfo(s *mcclient.ClientSession, id string, params jsonutils.JSONObject) (jsonutils.JSONObject, error) {\npkg/mcclient/modules/compute/mod_elasticcache.go:func (self *ElasticCacheManager) GetLoginInfo(s *mcclient.ClientSession, id string, params jsonutils.JSONObject) (jsonutils.JSONObject, error) {\npkg/mcclient/modules/compute/mod_elasticcache.go:func (self *ElasticCacheAccountManager) GetLoginInfo(s *mcclient.ClientSession, id string, params jsonutils.JSONObject) (jsonutils.JSONObject, error) {\n"})})]})}function p(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},53096:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/vms-api-eff4e68f0bfe91e282453f9f578de4d0.png"},63378:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/vms-network-02b9eddd6d216e962d4cfa6a31659da3.png"},48625:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/vms-rpc-4a671c55ef5547ad0423293bd423e3c5.png"},66991:(e,s,n)=>{n.d(s,{A:()=>r});const r=n.p+"assets/images/vms-dd64fdbb376d7587c713fa0504260513.png"},28453:(e,s,n)=>{n.d(s,{R:()=>c,x:()=>i});var r=n(96540);const t={},o=r.createContext(t);function c(e){const s=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),r.createElement(o.Provider,{value:s},e.children)}}}]);