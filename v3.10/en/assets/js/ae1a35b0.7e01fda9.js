"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[5813],{91869:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var s=t(74848),r=t(28453);const o={sidebar_position:3},i="\u524d\u7aef\u4f7f\u7528 HTTP",l={id:"operations/fe/web-use-http",title:"\u524d\u7aef\u4f7f\u7528 HTTP",description:"\u4ecb\u7ecd\u5982\u4f55\u914d\u7f6e\u524d\u7aef\u8bbf\u95ee\u534f\u8bae\u4e3a HTTP",source:"@site/docs/operations/fe/web-use-http.md",sourceDirName:"operations/fe",slug:"/operations/fe/web-use-http",permalink:"/v3.10/en/docs/operations/fe/web-use-http",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/operations/fe/web-use-http.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"nginx \u914d\u7f6e",permalink:"/v3.10/en/docs/operations/fe/behindnginx"},next:{title:"\u524d\u7aef\u53cc\u5411\u8ba4\u8bc1\u914d\u7f6e",permalink:"/v3.10/en/docs/operations/fe/traefik-mutual-tls"}},c={},d=[{value:"\u7f16\u8f91 onecloudcluster spec",id:"\u7f16\u8f91-onecloudcluster-spec",level:2},{value:"\u5220\u9664\u65e7\u7684 web configmap",id:"\u5220\u9664\u65e7\u7684-web-configmap",level:2},{value:"\u91cd\u542f web \u7ec4\u4ef6",id:"\u91cd\u542f-web-\u7ec4\u4ef6",level:2},{value:"\u66f4\u65b0 ingress",id:"\u66f4\u65b0-ingress",level:2},{value:"\u914d\u7f6e traefik ingress controller",id:"\u914d\u7f6e-traefik-ingress-controller",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"\u524d\u7aef\u4f7f\u7528-http",children:"\u524d\u7aef\u4f7f\u7528 HTTP"}),"\n",(0,s.jsx)(n.p,{children:"\u4ecb\u7ecd\u5982\u4f55\u914d\u7f6e\u524d\u7aef\u8bbf\u95ee\u534f\u8bae\u4e3a HTTP"}),"\n",(0,s.jsx)(n.p,{children:"\u5e73\u53f0\u90e8\u7f72\u540e\u9ed8\u8ba4\u6253\u5f00\u4e86 TLS \u670d\u52a1\u7aef(\u5355\u5411)\u8ba4\u8bc1\uff0c\u4f7f\u7528 HTTPS \u534f\u8bae\u8fdb\u884c\u6d4f\u89c8\u5668\u8bbf\u95ee\u524d\u7aef\u754c\u9762\u3002\u672c\u6587\u4ecb\u7ecd\u5982\u4f55\u914d\u7f6e\u4f7f\u7528 HTTP \u534f\u8bae\u8bbf\u95ee\u524d\u7aef\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u7f16\u8f91-onecloudcluster-spec",children:"\u7f16\u8f91 onecloudcluster spec"}),"\n",(0,s.jsx)(n.p,{children:"\u9996\u5148\u9700\u8981\u7f16\u8f91 oc.spec.web.useHTTP \u5c5e\u6027\uff0c\u8be5\u5c5e\u6027\u9ed8\u8ba4\u4e3a false \uff0c\u9700\u8981\u8bbe\u7f6e\u4e3a true \uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl edit oc -n onecloud\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u641c useHTTP \u5173\u952e\u5b57\uff0c\u8fdb\u884c\u5982\u4e0b\u7f16\u8f91\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:"   spec:\n     web:\n@@ -1122,7 +1122,7 @@\n         key: node-role.kubernetes.io/master\n       - effect: NoSchedule\n         key: node-role.kubernetes.io/controlplane\n-      useHTTP: false\n+      useHTTP: true\n     webconsole:\n       affinity:\n         nodeAffinity:\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u5220\u9664\u65e7\u7684-web-configmap",children:"\u5220\u9664\u65e7\u7684 web configmap"}),"\n",(0,s.jsx)(n.p,{children:"web \u7ec4\u4ef6\u7684 configmap \u5176\u5b9e\u662f\u4e00\u4e2a nginx \u914d\u7f6e\uff0c\u8be5\u914d\u7f6e\u4e0d\u4f1a\u91cd\u65b0\u751f\u6210\uff0c\u9700\u8981\u5220\u9664\u540e\u7531 operator \u65b0\u5efa\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# \u5220\u9664 web \u7ec4\u4ef6\u7684 configmap\n$ kubectl delete configmap -n onecloud $(kubectl get configmap -n onecloud | grep web | grep -v console | awk '{print $1}')\nconfigmap \"default-web\" deleted\n\n# \u7b49\u5f85 15s \u540e\uff0c\u8be5 configmap \u4f1a\u65b0\u5efa\uff0c\u67e5\u770b\u751f\u6210\u7684\u5185\u5bb9\n$ kubectl get configmap -n onecloud $(kubectl get configmap -n onecloud | grep web | grep -v console | awk '{print $1}')\nNAME          DATA   AGE\ndefault-web   1      28s\n\n# \u67e5\u770b\u5176\u4e2d\u662f\u5426\u6709 80 \u7aef\u53e3\u914d\u7f6e\uff0c\u6709\u7684\u8bdd\u5c31\u6ca1\u6709\u95ee\u9898\u4e86\n$ kubectl get configmap -n onecloud $(kubectl get configmap -n onecloud | grep web | grep -v console | awk '{print $1}') -o yaml | grep 'listen 80'\n        listen 80 default_server;\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u91cd\u542f-web-\u7ec4\u4ef6",children:"\u91cd\u542f web \u7ec4\u4ef6"}),"\n",(0,s.jsx)(n.p,{children:"\u66f4\u65b0\u5b8c web \u7ec4\u4ef6\u7684 configmap \u540e\uff0c\u9700\u8981\u91cd\u542f web \u7ec4\u4ef6\u7684 deployment \uff0c\u547d\u4ee4\u4e3a\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# \u91cd\u542f web deployment\n$ kubectl rollout restart deployment -n onecloud $(kubectl get deployment -n onecloud | grep web | grep -v console | awk '{print $1}')\ndeployment.extensions/default-web restarted\n\n# \u7b49\u5f85 pod \u53d8\u4e3a Running\n$ kubectl get pods -n onecloud | grep web | grep -v console\ndefault-web-5bfb6c578b-mdh9w                        3/3     Running                 0          58s\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u66f4\u65b0-ingress",children:"\u66f4\u65b0 ingress"}),"\n",(0,s.jsx)(n.p,{children:"web \u7ec4\u4ef6\u7684 service \u662f\u4f7f\u7528 ingress \u66b4\u9732\u51fa\u53bb\u7684\uff0cingress \u9ed8\u8ba4\u4e5f\u4e0d\u4f1a\u5237\u65b0\uff0c\u9700\u8981\u5220\u9664\u518d\u6b21\u521b\u5efa\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl delete ingress -n onecloud $(kubectl get ingress -n onecloud | grep web | awk '{print $1}')\ningress.extensions \"default-web\" deleted\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u67e5\u770b\u91cd\u5efa\u7684 ingress \u89c4\u5219\uff0c\u5df2\u7ecf\u8def\u7531\u5230 80 \u7aef\u53e3\u5373\u53ef\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'$ kubectl get ingress -n onecloud $(kubectl get ingress -n onecloud | grep web | awk \'{print $1}\') -o yaml | grep -i port\n    onecloud.yunion.io/last-applied-configuration: \'{"rules":[{"http":{"paths":[{"backend":{"serviceName":"default-web","servicePort":80},"path":"/"}]}}],"tls":[{"secretName":"default-certs"}]}\'\n          servicePort: 80\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u914d\u7f6e-traefik-ingress-controller",children:"\u914d\u7f6e traefik ingress controller"}),"\n",(0,s.jsx)(n.p,{children:"\u5982\u679c\u662f\u4f7f\u7528 helm \u90e8\u7f72\u7684\u96c6\u7fa4\uff0c\u5c31\u4e0d\u7528\u6267\u884c\u8be5\u6b65\u9aa4\u4e86\uff0cingress controller \u7684\u5b9e\u73b0\u548c\u5177\u4f53\u7684 k8s \u90e8\u7f72\u5e73\u53f0\u6709\u5173\uff0c\u73b0\u5728 web \u670d\u52a1\u5df2\u7ecf\u662f\u4f7f\u7528 HTTP \u534f\u8bae\u4e86\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u4e0b\u9762\u7684\u6b65\u9aa4\u4ec5\u9002\u7528\u4e8e\u4f7f\u7528 ocboot \u90e8\u7f72\u7684\u5e73\u53f0\uff0c\u9700\u8981\u8bbe\u7f6e traefik ingress controller \uff0c\u628a http \u91cd\u5b9a\u5411\u5230 https \u8fd9\u4e2a\u914d\u7f6e\u5173\u6389\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl edit configmaps -n kube-system traefik-ingress-lb\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6ce8\u91ca\u6389 entryPoints.http.redirect \u914d\u7f6e\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:'@@ -14,8 +14,8 @@\n     [entryPoints]\n       [entryPoints.http]\n         address = ":80"\n-        [entryPoints.http.redirect]\n-        entryPoint = "https"\n+        #[entryPoints.http.redirect]\n+        #entryPoint = "https"\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u91cd\u542f traefik ingress controller\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl delete pods -n kube-system $(kubectl get pods -n kube-system | grep traefik-ingress-controller | awk '{print $1}')\npod \"traefik-ingress-controller-xkmct\" deleted\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u81f3\u6b64 HTTP \u6240\u6709\u914d\u7f6e\u5b8c\u6210\u3002"})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>l});var s=t(96540);const r={},o=s.createContext(r);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);