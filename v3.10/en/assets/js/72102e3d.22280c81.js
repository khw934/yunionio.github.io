"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[2703],{33e3:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>i,default:()=>u,frontMatter:()=>l,metadata:()=>a,toc:()=>c});var t=n(85893),r=n(11151);const l={sidebar_position:8},i="\u540e\u7aef\u670d\u52a1\u6846\u67b6",a={id:"development/backend-framework",title:"\u540e\u7aef\u670d\u52a1\u6846\u67b6",description:"\u4ecb\u7ecd\u4e91\u5e73\u53f0\u540e\u7aef\u670d\u52a1\u6240\u7528\u7684\u6846\u67b6\u548c\u76f8\u5173\u5e93\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u5efa\u8bae\u5148\u9605\u8bfb \u5f00\u53d1\u624b\u518c/\u670d\u52a1\u7ec4\u4ef6\u4ecb\u7ecd \u4e86\u89e3\u5404\u4e2a\u670d\u52a1\u5927\u6982\u7684\u529f\u80fd\u3002",source:"@site/docs/development/backend-framework.md",sourceDirName:"development",slug:"/development/backend-framework",permalink:"/v3.10/en/docs/development/backend-framework",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/development/backend-framework.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8},sidebar:"tutorialSidebar",previous:{title:"\u6dfb\u52a0\u9009\u9879\u652f\u6301\u5916\u8868\u67e5\u8be2",permalink:"/v3.10/en/docs/development/extra-order"},next:{title:"\u8d44\u6e90\u6a21\u578b",permalink:"/v3.10/en/docs/development/resource-model"}},d={},c=[{value:"\u540e\u7aef\u670d\u52a1\u6846\u67b6",id:"\u540e\u7aef\u670d\u52a1\u6846\u67b6-1",level:2},{value:"Cloudpods \u4ee3\u7801\u7ed3\u6784",id:"cloudpods-\u4ee3\u7801\u7ed3\u6784",level:2},{value:"\u8ba4\u8bc1\u90e8\u5206",id:"\u8ba4\u8bc1\u90e8\u5206",level:2},{value:"Model Dispatcher",id:"model-dispatcher",level:2},{value:"\u6570\u636e\u5e93 ORM \u6a21\u578b",id:"\u6570\u636e\u5e93-orm-\u6a21\u578b",level:2},{value:"\u4e3e\u4f8b",id:"\u4e3e\u4f8b",level:3},{value:"\u6570\u636e\u5e93\u9501",id:"\u6570\u636e\u5e93\u9501",level:2},{value:"\u4e3e\u4f8b",id:"\u4e3e\u4f8b-1",level:3},{value:"worker\u961f\u5217\u7ba1\u7406",id:"worker\u961f\u5217\u7ba1\u7406",level:2},{value:"Task \u673a\u5236",id:"task-\u673a\u5236",level:2},{value:"\u4e3e\u4f8b",id:"\u4e3e\u4f8b-2",level:3},{value:"\u5982\u4f55\u589e\u52a0\u4e00\u4e2a\u65b0\u7684\u670d\u52a1",id:"\u5982\u4f55\u589e\u52a0\u4e00\u4e2a\u65b0\u7684\u670d\u52a1",level:2}];function o(e){const s={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"\u540e\u7aef\u670d\u52a1\u6846\u67b6",children:"\u540e\u7aef\u670d\u52a1\u6846\u67b6"}),"\n",(0,t.jsxs)(s.p,{children:["\u4ecb\u7ecd\u4e91\u5e73\u53f0\u540e\u7aef\u670d\u52a1\u6240\u7528\u7684\u6846\u67b6\u548c\u76f8\u5173\u5e93\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u5efa\u8bae\u5148\u9605\u8bfb ",(0,t.jsx)(s.a,{href:"./intro-services",children:"\u5f00\u53d1\u624b\u518c/\u670d\u52a1\u7ec4\u4ef6\u4ecb\u7ecd"})," \u4e86\u89e3\u5404\u4e2a\u670d\u52a1\u5927\u6982\u7684\u529f\u80fd\u3002"]}),"\n",(0,t.jsx)(s.h2,{id:"\u540e\u7aef\u670d\u52a1\u6846\u67b6-1",children:"\u540e\u7aef\u670d\u52a1\u6846\u67b6"}),"\n",(0,t.jsx)(s.p,{children:"keystone, region, glance \u7b49\u540e\u7aef\u670d\u52a1\uff0c\u90fd\u662f\u7528\u7684\u540c\u4e00\u5957\u540e\u7aef\u670d\u52a1\u6846\u67b6\uff0c\u8fd9\u4e2a\u6846\u67b6\u662f\u6211\u4eec\u81ea\u5df1\u5b9a\u4e49\u5b9e\u73b0\u7684\uff0c\u6838\u5fc3\u6a21\u5757\u5982\u4e0b:"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{src:n(12519).Z+"",width:"1495",height:"546"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"REST API: \u8d1f\u8d23\u89e3\u6790\u5ba2\u6237\u7aef\u53d1\u9001\u7684 CRUD http \u8bf7\u6c42\uff0c\u5c06\u4e0d\u540c\u7684\u8bf7\u6c42\u5bf9\u5e94\u5230 Model Dispatcher \u6a21\u5757\u3002"}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Model Dispatcher: \u5c06\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u5206\u53d1\u5230\u5bf9\u5e94\u8d44\u6e90\u7684\u4e1a\u52a1\u64cd\u4f5c\u3002"}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Model: \u5b9a\u4e49\u4e91\u5e73\u53f0\u5404\u79cd\u8d44\u6e90\uff0c\u4f1a\u8fdb\u884c\u6570\u636e\u5e93\u8bfb\u5199\u76f8\u5173\u64cd\u4f5c\uff0c\u5982\u679c\u5177\u4f53\u4e1a\u52a1\u9700\u8981\u8fdb\u884c\u8017\u65f6\u64cd\u4f5c\uff0c\u4f1a\u901a\u8fc7 Task \u673a\u5236\u6765\u6267\u884c\u8017\u65f6\u4efb\u52a1\u3002"}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"Task: \u540e\u53f0\u5904\u7406\u5f02\u6b65\u8017\u65f6\u4efb\u52a1\u7684\u6a21\u5757\uff0c\u4f1a\u901a\u8fc7\u66f4\u65b0 Model \u7684\u72b6\u6001\u6765\u66f4\u65b0\u4efb\u52a1\u7684\u6267\u884c\u7ed3\u679c\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"cloudpods-\u4ee3\u7801\u7ed3\u6784",children:"Cloudpods \u4ee3\u7801\u7ed3\u6784"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/build",children:"build"}),": \u6253\u5305rpm\u811a\u672c"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/cmd",children:"cmd"}),": \u53ef\u6267\u884cbinary\u5165\u53e3\u7a0b\u5e8f"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg",children:"pkg"}),": \u5e93","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg/appsrv",children:"appsrv"}),": \u901a\u7528http\u670d\u52a1\u6846\u67b6"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg/cloudcommon",children:"cloudcommon"}),": \u4e91\u5e73\u53f0\u670d\u52a1\u6846\u67b6\uff0c\u57fa\u4e8eappsrv\u6269\u5c55","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg/cloudcommon/options",children:"cloudcommon/options"}),": \u901a\u7528options"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg/cloudcommon/app",children:"cloudcommon/app"}),": \u901a\u7528\u670d\u52a1\u521d\u59cb\u5316\u4ee3\u7801"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg/cloudcommon/db",children:"cloudcommon/db"}),": Model dispatcher\u548cModels\u7684\u57fa\u7840\u5b9e\u73b0"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg/cloudcommon/db/lockman",children:"cloudcommon/db/lockman"}),": \u9501\u5b9e\u73b0"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg/cloudcommon/db/taskman",children:"cloudcommon/db/taskman"}),": \u5f02\u6b65\u4efb\u52a1\u6846\u67b6"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"\u8ba4\u8bc1\u90e8\u5206",children:"\u8ba4\u8bc1\u90e8\u5206"}),"\n",(0,t.jsx)(s.p,{children:(0,t.jsx)(s.img,{src:n(25356).Z+"",width:"587",height:"318"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u53d1\u8d77\u8bf7\u6c42\u524d\uff0c\u9700\u8981\u4ecekeystone\u83b7\u5f97token"}),"\n",(0,t.jsx)(s.li,{children:"\u5ba2\u6237\u7aef\u901a\u8fc7\u643a\u5e26\u7528\u6237\u540d\u5bc6\u7801\u8c03\u7528keystone\u7684/v3/auth/tokens\u63a5\u53e3\u83b7\u5f97token"}),"\n",(0,t.jsx)(s.li,{children:"\u5ba2\u6237\u7aef\u5411\u670d\u52a1\u53d1\u8d77\u7684\u6bcf\u6b21API\u8bf7\u6c42\u90fd\u4f1a\u5728HTTP\u5934\u643a\u5e26\u8be5token\uff0c\u6bd4\u5982: X-Auth-Token: {token}"}),"\n",(0,t.jsx)(s.li,{children:"\u540e\u7aef\u670d\u52a1\u5411keystone\u9a8c\u8bc1\u8be5token\uff0c\u83b7\u5f97\u7528\u6237\u7684\u8eab\u4efd\u4fe1\u606f\uff0c\u6267\u884c\u540e\u7eedAPI\u7684\u6d41\u7a0b"}),"\n",(0,t.jsx)(s.li,{children:"\u6bcf\u4e2a\u670d\u52a1\u90fd\u6709\u4e00\u4e2akeystone\u6ce8\u518c\u7684\u670d\u52a1\u7528\u6237\u8d26\u53f7\uff08user/password)\uff0c\u5e76\u4e14\u4ee5admin\u89d2\u8272\u52a0\u5165system\u9879\u76ee"}),"\n",(0,t.jsx)(s.li,{children:"\u670d\u52a1\u542f\u52a8\u540e\uff0c\u4f1a\u5411keystone\u53d1\u8d77\u8ba4\u8bc1\uff0c\u83b7\u5f97admin token"}),"\n",(0,t.jsx)(s.li,{children:"\u7528\u6237\u901a\u8fc7API\u8bbf\u95ee\u670d\u52a1\u65f6\uff0c\u5c06\u5728header\u643a\u5e26token"}),"\n",(0,t.jsx)(s.li,{children:"\u4f7f\u7528\u8fd9\u4e2aadmin token\u8bbf\u95eekeystone\u7684token\u9a8c\u8bc1\u63a5\u53e3\uff0c\u9a8c\u8bc1\u8fd9\u4e2atoken\uff0c\u83b7\u5f97\u7528\u6237\u7684\u8eab\u4efd\u4fe1\u606f"}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"model-dispatcher",children:"Model Dispatcher"}),"\n",(0,t.jsx)(s.p,{children:"\u628a REST API \u548c Manager/Model \u7684\u65b9\u6cd5\u8fdb\u884c\u4e00\u4e00\u6620\u5c04"}),"\n",(0,t.jsxs)(s.table,{children:[(0,t.jsx)(s.thead,{children:(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.th,{children:"REST API \u8bf7\u6c42"}),(0,t.jsx)(s.th,{children:"API \u529f\u80fd"}),(0,t.jsx)(s.th,{children:"\u5bf9\u5e94\u5bf9\u8c61"}),(0,t.jsx)(s.th,{children:"\u6846\u67b6\u65b9\u6cd5"}),(0,t.jsx)(s.th,{children:"\u8bf4\u660e"})]})}),(0,t.jsxs)(s.tbody,{children:[(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"GET /$resources"}),(0,t.jsx)(s.td,{children:"\u5217\u8868"}),(0,t.jsx)(s.td,{children:"Manager"}),(0,t.jsx)(s.td,{children:"ListItemFilter"}),(0,t.jsx)(s.td,{children:"\u8fc7\u6ee4"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"-"}),(0,t.jsx)(s.td,{}),(0,t.jsx)(s.td,{children:"Manager"}),(0,t.jsx)(s.td,{children:"GetCustomizeColumns"}),(0,t.jsx)(s.td,{children:"\u83b7\u5f97\u6269\u5c55\u5b57\u6bb5\u7684\u4fe1\u606f"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"GET /<resources>/<property>"}),(0,t.jsxs)(s.td,{children:["\u83b7\u5f97",(0,t.jsx)(s.em,{children:"\u8be5\u7c7b\u8d44\u6e90"}),"\u7279\u5b9a\u5c5e\u6027"]}),(0,t.jsx)(s.td,{children:"Manager"}),(0,t.jsx)(s.td,{children:"GetProperty<Property>"}),(0,t.jsxs)(s.td,{children:["\u83b7\u5f97",(0,t.jsx)(s.em,{children:"\u8be5\u7c7b\u8d44\u6e90"}),"\u7684\u7279\u5b9a\u5c5e\u6027"]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"GET /<resources>/<res_id>"}),(0,t.jsxs)(s.td,{children:["\u83b7\u5f97",(0,t.jsx)(s.em,{children:"\u67d0\u4e2a\u8d44\u6e90"}),"\u8be6\u60c5"]}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"GetExtraDetails"}),(0,t.jsx)(s.td,{children:"\u83b7\u53d6\u6269\u5c55\u5b57\u6bb5\u7684\u4fe1\u606f"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"GET /<resources>/<res_id>/<spec>"}),(0,t.jsxs)(s.td,{children:["\u83b7\u5f97",(0,t.jsx)(s.em,{children:"\u67d0\u4e2a\u8d44\u6e90"}),"\u7279\u5b9a\u5c5e\u6027"]}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"GetDetails<Spec>"}),(0,t.jsxs)(s.td,{children:["\u83b7\u53d6",(0,t.jsx)(s.em,{children:"\u67d0\u4e2a\u8d44\u6e90"}),"\u7684\u7279\u5b9a\u5c5e\u6027"]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"POST /<resources>"}),(0,t.jsx)(s.td,{children:"\u65b0\u5efa\u8d44\u6e90"}),(0,t.jsx)(s.td,{children:"Manager"}),(0,t.jsx)(s.td,{children:"ValidateCreateData"}),(0,t.jsx)(s.td,{children:"\u6821\u9a8c\u548c\u5904\u7406\u521b\u5efa\u7684\u6570\u636e"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"-"}),(0,t.jsx)(s.td,{}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"CustomizeCreate"}),(0,t.jsx)(s.td,{children:"\u81ea\u5b9a\u4e49\u7684\u521b\u5efa\u64cd\u4f5c"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"-"}),(0,t.jsx)(s.td,{}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"PostCreate"}),(0,t.jsx)(s.td,{children:"\u521b\u5efa\u540e\u7684hook"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"-"}),(0,t.jsx)(s.td,{}),(0,t.jsx)(s.td,{children:"Manager"}),(0,t.jsx)(s.td,{children:"OnCreateComplete"}),(0,t.jsx)(s.td,{children:"\u521b\u5efa\u5b8c\u6210\u7684hook"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"POST /<resources>/<action>"}),(0,t.jsxs)(s.td,{children:["\u5bf9",(0,t.jsx)(s.em,{children:"\u8be5\u7c7b\u8d44\u6e90"}),"\u6267\u884c\u64cd\u4f5c"]}),(0,t.jsx)(s.td,{children:"Manager"}),(0,t.jsx)(s.td,{children:"Perform<Action>"}),(0,t.jsxs)(s.td,{children:["\u5bf9",(0,t.jsx)(s.em,{children:"\u8be5\u7c7b\u8d44\u6e90"}),"\u6267\u884c\u7279\u5b9a\u64cd\u4f5c"]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"POST /<resources>/<res_id>/<action>"}),(0,t.jsxs)(s.td,{children:["\u5bf9",(0,t.jsx)(s.em,{children:"\u67d0\u4e2a\u8d44\u6e90"}),"\u6267\u884c\u64cd\u4f5c"]}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"Perform<Action>"}),(0,t.jsxs)(s.td,{children:["\u5bf9",(0,t.jsx)(s.em,{children:"\u67d0\u4e2a\u8d44\u6e90"}),"\u6267\u884c\u7279\u5b9a\u64cd\u4f5c"]})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"PUT /<resources>/<res_id>"}),(0,t.jsxs)(s.td,{children:["\u66f4\u65b0",(0,t.jsx)(s.em,{children:"\u67d0\u4e2a\u8d44\u6e90"}),"\u7684\u5c5e\u6027"]}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"ValidateUpdateData"}),(0,t.jsx)(s.td,{children:"\u6821\u9a8c\u548c\u5904\u7406\u66f4\u65b0\u64cd\u4f5c\u7684\u6570\u636e"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"-"}),(0,t.jsx)(s.td,{}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"PreUpdate"}),(0,t.jsx)(s.td,{children:"\u81ea\u5b9a\u4e49\u7684\u521b\u5efa\u64cd\u4f5c"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"-"}),(0,t.jsx)(s.td,{}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"PostUpdate"}),(0,t.jsx)(s.td,{children:"\u521b\u5efa\u540e\u7684hook"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"DELETE /<resources>/<res_id>"}),(0,t.jsxs)(s.td,{children:["\u5220\u9664",(0,t.jsx)(s.em,{children:"\u67d0\u4e2a\u8d44\u6e90"})]}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"CustomizeDelete"}),(0,t.jsx)(s.td,{children:"\u81ea\u5b9a\u4e49\u7684\u5220\u9664\u64cd\u4f5c"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"-"}),(0,t.jsx)(s.td,{}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"PreDelete"}),(0,t.jsx)(s.td,{children:"\u5220\u9664\u524d\u7684hook"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"-"}),(0,t.jsx)(s.td,{}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"Delete"}),(0,t.jsx)(s.td,{children:"\u6267\u884c\u5220\u9664\u64cd\u4f5c"})]}),(0,t.jsxs)(s.tr,{children:[(0,t.jsx)(s.td,{children:"-"}),(0,t.jsx)(s.td,{}),(0,t.jsx)(s.td,{children:"Model"}),(0,t.jsx)(s.td,{children:"PostDelete"}),(0,t.jsx)(s.td,{children:"\u5220\u9664\u540e\u7684hook"})]})]})]}),"\n",(0,t.jsxs)(s.p,{children:["\u5177\u4f53 restful \u8bf7\u6c42\u7684\u7ed1\u5b9a\u51fd\u6570\u5728: ",(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/blob/master/pkg/appsrv/dispatcher/dispatcher.go#L33",children:"pkg/appsrv/dispatcher/dispatcher.go"})," \u6587\u4ef6\u4e2d\u7684 ",(0,t.jsx)(s.strong,{children:"AddModelDispatcher"})," \u51fd\u6570\u3002"]}),"\n",(0,t.jsx)(s.h2,{id:"\u6570\u636e\u5e93-orm-\u6a21\u578b",children:"\u6570\u636e\u5e93 ORM \u6a21\u578b"}),"\n",(0,t.jsxs)(s.p,{children:["\u4ee3\u7801\u4f4d\u4e8e ",(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/tree/master/pkg/cloudcommon/db",children:"cloudcommon/db"})]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\u63a5\u53e3","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"IModelManager: \u5bf9\u5e94\u8d44\u6e90\u5728\u6570\u636e\u5e93\u91cc\u9762\u7684\u8868"}),"\n",(0,t.jsx)(s.li,{children:"IModel: \u5bf9\u5e94\u8d44\u6e90\u5728\u6570\u636e\u5e93\u91cc\u9762\u7684\u5355\u6761\u6570\u636e"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\u6570\u636e\u7ed3\u6784","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["SResourceBase: \u57fa\u7840\u8d44\u6e90","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["SStandaloneResourceBase: \u57fa\u7840\u8bbe\u65bd\u7684\u7269\u7406\u8d44\u6e90\uff0c\u6ca1\u6709\u5177\u4f53ownerId\u7684\u8d44\u6e90\uff0c\u5982zone, host","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["SVirtualResourceBase: \u865a\u62df\u8d44\u6e90\uff0c\u5982\u865a\u62df\u673a\uff08guest)","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["SSharableVirtualResourceBase: \u865a\u62df\u7684\u53ef\u4ee5\u5171\u4eab\u7684\u865a\u62df\u8d44\u6e90\uff0c\u5982disk, network","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"SAdminSharableVirtualInfoBase: \u7ba1\u7406\u914d\u7f6e\u7528\u7684\u53ef\u5171\u4eab\u865a\u62df\u8d44\u6e90\uff0c\u5982security group"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.li,{children:"SJointResourceBase: \u8054\u5408\u6570\u636e\u7c7b\u578b\uff0c\u5982\u865a\u62df\u7f51\u5361\u662f\u865a\u62df\u673a\u548c\u7f51\u7edc\u7684\u8054\u5408\uff0c\u865a\u62df\u78c1\u76d8\u6302\u5728\uff1a\u865a\u62df\u673a\u548c\u865a\u62df\u78c1\u76d8\u7684\u8054\u5408"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"\u4e3e\u4f8b",children:"\u4e3e\u4f8b"}),"\n",(0,t.jsxs)(s.p,{children:["\u7528\u865a\u62df\u673a\u7684 model \u6765\u4e3e\u4f8b\uff0c\u4ee3\u7801\u5728: ",(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/blob/master/pkg/compute/models/guests.go",children:"pkg/compute/models/guests.go"}),"\u3002"]}),"\n",(0,t.jsx)(s.p,{children:"GuestManager \u5bf9\u5e94\u6570\u636e\u5e93\u91cc\u9762\u7684 guests_tbl\uff0c\u8be5\u5bf9\u8c61\u5d4c\u5957 db.SVirtualResourceBaseManager \u8868\u793a\u662f\u865a\u62df\u8d44\u6e90\u7684 Manager\uff0c\u8fd9\u6837\u4f1a\u9ed8\u8ba4\u5b9e\u73b0 db.IModelManager \u63a5\u53e3\uff0c\u7136\u540e\u6839\u636e\u4e1a\u52a1\u9700\u8981\u91cd\u5199\u4e00\u4e9b\u65b9\u6cd5\u4f1a\u6bd4\u8f83\u65b9\u4fbf\u3002"}),"\n",(0,t.jsx)(s.p,{children:"SGuest \u5bf9\u5e94 guests_tbl \u6570\u636e\u5e93\u91cc\u9762\u7684\u6bcf\u4e00\u884c\u6570\u636e\uff0c\u7531 GuestManager \u7ba1\u7406\uff0c\u5d4c\u5957 db.SVirtualResourceBase \u7ed3\u6784\uff0c\u9ed8\u8ba4\u5c31\u4f1a\u6709\u865a\u62df\u8d44\u6e90\u6240\u9700\u8981\u7684\u8868\u7ed3\u6784\uff0c\u7136\u540e\u518d\u5b9a\u4e49\u4e00\u4e9b\u865a\u62df\u673a\u72ec\u6709\u7684\u5c5e\u6027\u6bd4\u5982 VcpuCount \u8868\u793a cpu \u6838\u6570\uff0cVmemSize \u8868\u793a\u5185\u5b58\u5927\u5c0f\u3002 \u5728\u4ee3\u7801\u62bd\u8c61\u540e\u8868\u793a\u865a\u62df\u673a\u5b9e\u4f8b\uff0c\u8be5\u5bf9\u8c61\u4f1a\u7ed1\u5b9a\u5bf9\u865a\u62df\u673a\u5177\u4f53\u7684\u4e1a\u52a1\u64cd\u4f5c\u5b9e\u73b0\u51fd\u6570\u3002"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-go",children:'import "yunion.io/x/cloudpods/pkg/cloudcommon/db"\n\n......\n\ntype SGuestManager struct {\n\tdb.SVirtualResourceBaseManager\n}\n\nvar GuestManager *SGuestManager\n\nfunc init() {\n\tGuestManager = &SGuestManager{\n\t\tSVirtualResourceBaseManager: db.NewVirtualResourceBaseManager(\n\t\t\tSGuest{},\n\t\t\t"guests_tbl",\n\t\t\t"server",\n\t\t\t"servers",\n\t\t),\n\t}\n\tGuestManager.SetVirtualObject(GuestManager)\n\tGuestManager.SetAlias("guest", "guests")\n}\n\ntype SGuest struct {\n\tdb.SVirtualResourceBase\n\n\tdb.SExternalizedResourceBase\n\n\tSBillingResourceBase\n\n\tVcpuCount int `nullable:"false" default:"1" list:"user" create:"optional"` // Column(TINYINT, nullable=False, default=1)\n\tVmemSize  int `nullable:"false" list:"user" create:"required"`             // Column(Integer, nullable=False)\n\n\tBootOrder string `width:"8" charset:"ascii" nullable:"true" default:"cdn" list:"user" update:"user" create:"optional"` // Column(VARCHAR(8, charset=\'ascii\'), nullable=True, default=\'cdn\')\n\n\tDisableDelete    tristate.TriState `nullable:"false" default:"true" list:"user" update:"user" create:"optional"`           // Column(Boolean, nullable=False, default=True)\n\tShutdownBehavior string            `width:"16" charset:"ascii" default:"stop" list:"user" update:"user" create:"optional"` // Column(VARCHAR(16, charset=\'ascii\'), default=SHUTDOWN_STOP)\n\n\tKeypairId string `width:"36" charset:"ascii" nullable:"true" list:"user" create:"optional"` // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\n\tHostId       string `width:"36" charset:"ascii" nullable:"true" list:"admin" get:"admin" index:"true"` // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\tBackupHostId string `width:"36" charset:"ascii" nullable:"true" list:"user" get:"user"`\n\n\tVga     string `width:"36" charset:"ascii" nullable:"true" list:"user" update:"user" create:"optional"` // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\tVdi     string `width:"36" charset:"ascii" nullable:"true" list:"user" update:"user" create:"optional"` // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\tMachine string `width:"36" charset:"ascii" nullable:"true" list:"user" update:"user" create:"optional"` // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\tBios    string `width:"36" charset:"ascii" nullable:"true" list:"user" update:"user" create:"optional"` // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\tOsType  string `width:"36" charset:"ascii" nullable:"true" list:"user" update:"user" create:"optional"` // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\n\tFlavorId string `width:"36" charset:"ascii" nullable:"true" list:"user" create:"optional"` // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\n\tSecgrpId      string `width:"36" charset:"ascii" nullable:"true" get:"user" create:"optional"` // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\tAdminSecgrpId string `width:"36" charset:"ascii" nullable:"true" get:"admin"`                  // Column(VARCHAR(36, charset=\'ascii\'), nullable=True)\n\n\tHypervisor string `width:"16" charset:"ascii" nullable:"false" default:"kvm" list:"user" create:"required"` // Column(VARCHAR(16, charset=\'ascii\'), nullable=False, default=HYPERVISOR_DEFAULT)\n\n\tInstanceType string `width:"64" charset:"ascii" nullable:"true" list:"user" create:"optional"`\n}\n......\n'})}),"\n",(0,t.jsx)(s.h2,{id:"\u6570\u636e\u5e93\u9501",children:"\u6570\u636e\u5e93\u9501"}),"\n",(0,t.jsx)(s.p,{children:"\u4ee3\u7801\u4f4d\u4e8e cloudcommon/db/lockman:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"LockClass/ReleaseClass: \u9501\u4f4f\u4e00\u7c7b\u5b9e\u4f8b\uff0c\u4e00\u822c\u521b\u5efa\u8d44\u6e90\u65f6\u5019\u9700\u8981\u9501"}),"\n",(0,t.jsx)(s.li,{children:"LockObject/ReleaseObject: \u9501\u4f4f\u4e00\u4e2a\u5b9e\u4f8b\uff0c\u4e00\u822c\u4fee\u6539\u8d44\u6e90\u5b9e\u4f8b\u662f\u9700\u8981\u9501"}),"\n",(0,t.jsx)(s.li,{children:"LockRawObject/RelaseRawObject: \u901a\u7528\u7684\u9501"}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"\u4e3e\u4f8b-1",children:"\u4e3e\u4f8b"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/blob/master/pkg/cloudcommon/db/db_dispatcher.go#L900",children:"pkg/cloudcommon/db/db_dispatcher.go"})," \u91cc\u9762\u7684 DoCreate \u51fd\u6570\u4f1a\u521b\u5efa\u5bf9\u5e94 Model \u7684\u5bf9\u8c61\u5e76\u63d2\u5165\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u52a0\u9501\u3002"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-go",children:"func DoCreate(manager IModelManager, ctx context.Context, userCred mcclient.TokenCredential, query jsonutils.JSONObject, data jsonutils.JSONObject, ownerId mcclient.IIdentityProvider) (IModel, error) {\n    lockman.LockClass(ctx, manager, GetLockClassKey(manager, ownerId))\n    defer lockman.ReleaseClass(ctx, manager, GetLockClassKey(manager, ownerId))\n\n    return doCreateItem(manager, ctx, userCred, ownerId, nil, data)\n}\n"})}),"\n",(0,t.jsx)(s.h2,{id:"worker\u961f\u5217\u7ba1\u7406",children:"worker\u961f\u5217\u7ba1\u7406"}),"\n",(0,t.jsx)(s.p,{children:"\u4e3a\u4e86\u907f\u514d\u4e0d\u53ef\u9884\u671f\u7684\u5e76\u53d1\u5ea6\uff0c\u6240\u6709\u5f02\u6b65\u6267\u884c\u7684\u4ee3\u7801\u90fd\u5e94\u8be5\u5728worker\u5185\u6267\u884c\uff0c\u4ee5\u4fbf\u4e8e\u7ba1\u7406\u5e76\u53d1\u5ea6\u3002"}),"\n",(0,t.jsx)(s.p,{children:"\u4ee3\u7801\u4f4d\u4e8e appsrv/workers.go"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-go",children:"workerman := appsrv.NewWorkerManager(name, parallel_cnt, \u2026)\nworkerman.Run(func() {\u2026}, nil, nil)\n"})}),"\n",(0,t.jsx)(s.h2,{id:"task-\u673a\u5236",children:"Task \u673a\u5236"}),"\n",(0,t.jsx)(s.p,{children:"\u4e91\u5e73\u53f0\u7684\u5f02\u6b65\u8017\u65f6\u4efb\u52a1\u4f1a\u653e\u5728 Task \u673a\u5236\u91cc\u9762\u53bb\u6267\u884c\uff0c\u6bd4\u5982\u521b\u5efa\u865a\u62df\u673a\u64cd\u4f5c\uff0c\u7528\u6237\u63d0\u4ea4\u4e86\u8bf7\u6c42\uff0cregion \u63a7\u5236\u5668\u6821\u9a8c\u53c2\u6570\u5408\u683c\u540e\uff0c\u4f1a\u8bb0\u5f55\u6570\u636e\u5230\u6570\u636e\u5e93\uff0c\u7136\u540e\u9a6c\u4e0a\u8fd4\u56de\u5ba2\u6237\u7aef\u5bf9\u5e94\u7684\u865a\u62df\u673a\u8bb0\u5f55\uff0c\u4e0e\u6b64\u540c\u65f6\uff0c\u4f1a\u5f00\u59cb\u6267\u884c\u521b\u5efa\u865a\u62df\u673a\u7684 task\uff0c\u8fd9\u4e2a task \u4f1a\u7acb\u5373\u5728\u540e\u53f0\u6267\u884c\uff0c\u4f1a\u901a\u8fc7\u66f4\u65b0\u865a\u62df\u673a SGuest model \u7684\u72b6\u6001\u548c\u8bb0\u5f55\u64cd\u4f5c\u65e5\u5fd7\u6765\u8868\u793a\u6267\u884c\u7684\u6210\u529f\u6216\u5931\u8d25\u3002"}),"\n",(0,t.jsxs)(s.p,{children:["task \u4e5f\u662f\u8bb0\u5f55\u5728\u6570\u636e\u5e93 tasks_tbl \u91cc\u9762\u7684\u8bb0\u5f55\uff0c\u5bf9\u5e94\u7684\u5b9a\u4e49\u5728: ",(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/blob/master/pkg/cloudcommon/db/taskman/tasks.go",children:"pkg/cloudcommon/db/taskman/tasks.go"})," \u91cc\u9762\uff0c\u6570\u636e\u7ed3\u6784\u5982\u4e0b:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-go",children:'type STaskManager struct {\n    db.SResourceBaseManager\n    \n}\n\nvar TaskManager *STaskManager\n\nfunc init() {\nTaskManager = &STaskManager{\n        SResourceBaseManager: db.NewResourceBaseManager(STask{}, "tasks_tbl", "task", "tasks")\n}\n    TaskManager.SetVirtualObject(TaskManager)\n    \n}\n\ntype STask struct {\n    db.SResourceBase\n\n    Id string `width:"36" charset:"ascii" primary:"true" list:"user"` // Column(VARCHAR(36, charset=\'ascii\'), primary_key=True, default=get_uuid)\n\n    ObjName  string                   `width:"128" charset:"utf8" nullable:"false" list:"user"`               //  Column(VARCHAR(128, charset=\'utf8\'), nullable=False)\n    ObjId    string                   `width:"128" charset:"ascii" nullable:"false" list:"user" index:"true"` // Column(VARCHAR(ID_LENGTH, charset=\'ascii\'), nullable=False)\n    TaskName string                   `width:"64" charset:"ascii" nullable:"false" list:"user"`               // Column(VARCHAR(64, charset=\'ascii\'), nullable=False)\n    UserCred mcclient.TokenCredential `width:"1024" charset:"utf8" nullable:"false" get:"user"`               // Column(VARCHAR(1024, charset=\'ascii\'), nullable=False)\n    OwnerCred string `width:"512" charset:"ascii" nullable:"true"` // Column(VARCHAR (512, charset=\'ascii\'), nullable=True)\n    Params *jsonutils.JSONDict `charset:"utf8" length:"medium" nullable:"false" get:"user"` // Column(MEDIUMTEXT(charset=\'ascii\'), nullable=False)\n\n    Stage string `width:"64" charset:"ascii" nullable:"false" default:"on_init" list:"user"` // Column(VARCHAR(64, charset=\'ascii\'), nullable=False, default=\'on_init\')\n\n    taskObject  db.IStandaloneModel   `ignore:"true"`\n    taskObjects []db.IStandaloneModel `ignore:"true"`\n}\n'})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Id: STask \u91cc\u9762\u7684 Id \u662f\u8be5 task \u8bb0\u5f55\u7684 Id"}),"\n",(0,t.jsx)(s.li,{children:"ObjId: \u5bf9\u5e94\u8d44\u6e90\u5bf9\u8c61\u7684 Id\uff0c\u7528\u4e8e\u8bb0\u5f55\u6267\u884c\u8be5 task \u7684\u5bf9\u5e94\u64cd\u4f5c\u7684\u8d44\u6e90\uff0c\u6bd4\u5982\u67d0\u53f0\u865a\u62df\u673a\u3001\u78c1\u76d8\u7684 Id"}),"\n",(0,t.jsx)(s.li,{children:"UserCred: \u5b58\u50a8\u6267\u884c task \u7684\u7528\u6237\u4fe1\u606f"}),"\n",(0,t.jsx)(s.li,{children:"Params: \u6267\u884c task \u7684\u53c2\u6570"}),"\n",(0,t.jsx)(s.li,{children:"TaskName: \u5bf9\u5e94 task \u7684\u540d\u79f0"}),"\n",(0,t.jsx)(s.li,{children:"Stage: task \u6267\u884c\u7684\u9636\u6bb5\uff0c\u9ed8\u8ba4\u4e3a OnInit"}),"\n"]}),"\n",(0,t.jsx)(s.h3,{id:"\u4e3e\u4f8b-2",children:"\u4e3e\u4f8b"}),"\n",(0,t.jsx)(s.p,{children:"\u4ee5\u865a\u62df\u673a\u5173\u673a\u8fd9\u4e2a\u64cd\u4f5c\u6765\u4e3e\u4f8b:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\u5ba2\u6237\u7aef\u53d1\u8d77 POST /servers/<server_id>/stop \u8bf7\u6c42\u540e\uff0c\u901a\u8fc7\u670d\u52a1\u6846\u67b6\u4f1a\u6267\u884c ",(0,t.jsx)(s.code,{children:"func (self *SGuest) PerformStop"})," \u51fd\u6570\uff0c\u4ee3\u7801\u7247\u6bb5\u5982\u4e0b(\u4f4d\u4e8e: ",(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/blob/2003c44264f1a244f32fd0584e7ce0d23df78705/pkg/compute/models/guest_actions.go#L2357",children:"pkg/compute/models/guest_actions.go"}),"):"]}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-go",children:'func (self *SGuest) PerformStop(ctx context.Context, userCred mcclient.TokenCredential, query jsonutils.JSONObject,\n\tdata jsonutils.JSONObject) (jsonutils.JSONObject, error) {\n\t// XXX if is force, force stop guest\n\tvar isForce = jsonutils.QueryBoolean(data, "is_force", false)\n\tif isForce || utils.IsInStringArray(self.Status, []string{api.VM_RUNNING, api.VM_STOP_FAILED}) {\n\t\treturn nil, self.StartGuestStopTask(ctx, userCred, isForce, "")\n\t} else {\n\t\treturn nil, httperrors.NewInvalidStatusError("Cannot stop server in status %s", self.Status)\n\t}\n}\n'})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"SGuest \u4f1a\u6267\u884c self.StartGuestStopTask \u51fd\u6570\uff0c\u8be5\u51fd\u6570\u4f1a\u53bb\u8c03\u7528\u865a\u62df\u673a\u4e0d\u540c\u7684 Driver \u6267\u884c\u5173\u673a\u64cd\u4f5c"}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-go",children:'// pkg/compute/models/guest_actions.go\nfunc (self *SGuest) StartGuestStopTask(ctx context.Context, userCred mcclient.TokenCredential, isForce bool, parentTaskId string) error {\n\t\t......\n\t\treturn self.GetDriver().StartGuestStopTask(self, ctx, userCred, params, parentTaskId)\n}\n\n// pkg/compute/guestdrivers/virtualization.go\nimport "yunion.io/x/cloudpods/pkg/cloudcommon/db/taskman"\n......\nfunc (self *SVirtualizedGuestDriver) StartGuestStopTask(guest *models.SGuest, ctx context.Context, userCred mcclient.TokenCredential, params *jsonutils.JSONDict, parentTaskId string) error {\n    task, err := taskman.TaskManager.NewTask(ctx, "GuestStopTask", guest, userCred, params, parentTaskId, "", nil)\n    if err != nil {\n        return err\n    }\n    task.ScheduleRun(nil)\n    return nil\n}\n......\n'})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:'taskman.TaskManager.NewTask(ctx, "GuestStopTask", ...)'})," \u8fd9\u91cc\u9762\u7684 GuestStopTask \u5bf9\u5e94 ",(0,t.jsx)(s.a,{href:"https://github.com/yunionio/cloudpods/blob/master/pkg/compute/tasks/guest_stop_task.go",children:"pkg/compute/tasks/guest_stop_task.go"})," \u91cc\u9762\u7684 GuestStopTask\uff0c\u662f\u901a\u8fc7 taskman \u91cc\u9762\u7ef4\u62a4\u7684\u4e00\u4e2a map \u67e5\u627e\u7684\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.strong,{children:"task.ScheduleRun(nil)"})," \u4f1a\u5f00\u59cb\u6267\u884c\u5bf9\u5e94\u7684 Task\uff0c\u9ed8\u8ba4\u4f1a\u4ece task \u7684\u9ed8\u8ba4 Stage OnInit \u51fd\u6570\u5f00\u59cb\u6267\u884c\uff0c\u6240\u4ee5\u901a\u8fc7 task \u673a\u5236\u5c31\u4f1a\u6267\u884c\u5230 GuestStopTask.OnInit \u51fd\u6570\u3002OnInit \u51fd\u6570\u6700\u7ec8\u4f1a\u8c03\u7528\u5bf9\u5e94\u865a\u62df\u673a\u7684 driver \u6267\u884c RequestStopOnHost \u51fd\u6570\u5e76\u66f4\u65b0\u8bbe\u7f6e\u81ea\u5df1\u7684 Stage \u4e3a OnMasterStopTaskComplete\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsx)(s.p,{children:"\u5bf9\u4e8e\u865a\u62df\u673a\u6765\u8bf4 RequestStopOnHost \u51fd\u6570\u4f1a\u8bf7\u6c42\u865a\u62df\u673a\u6240\u5728\u7684 host agent \u5173\u95ed\u865a\u62df\u673a\uff0c\u5173\u673a\u6210\u529f\u540e\u4f1a\u56de\u8c03 region task \u6846\u67b6\uff0c\u8be5\u6846\u67b6\u4f1a\u6839\u636e taskId \u4ece\u6570\u636e\u5e93 load \u56de\u6765 GuestStopTask\uff0c\u63a5\u7740\u5b83\u8bbe\u7f6e\u7684 Stage OnMasterStopTaskComplete \u6267\u884c\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.admonition,{type:"tip",children:(0,t.jsx)(s.p,{children:"\u8fd9\u91cc\u5931\u8d25\u4f1a\u81ea\u52a8\u8c03\u7528 OnGuestStopTaskCompleteFailed \u51fd\u6570\uff0c\u6240\u4ee5\u7f16\u5199\u5bf9\u5e94 task stage \u51fd\u6570\u65f6\u5982\u679c\u5199 <OnSometingComplete> \u51fd\u6570\u65f6\uff0c\u5fc5\u987b\u4e5f\u540c\u65f6\u5199 <OnSometingCompleteFailed> \u51fd\u6570\u6765\u5904\u7406\u5931\u8d25\u60c5\u51b5\u3002"})}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"\u5982\u679c\u6210\u529f\u5173\u673a\uff0cOnMasterStopTaskComplete \u8c03\u7528 OnGuestStopTaskComplete \u51fd\u6570\uff0c\u8be5\u51fd\u6570\u4f1a\u628a\u865a\u62df\u673a\u7684\u72b6\u6001\u8bbe\u7f6e\u4e3a ready\uff0c\u5e76\u8bb0\u5f55\u4e00\u6761\u5173\u673a\u64cd\u4f5c\u65e5\u5fd7\uff1b\u5982\u679c\u5931\u8d25\u4f1a\u8c03\u7528 OnGuestStopTaskCompleteFailed \u51fd\u6570\uff0c\u8be5\u51fd\u6570\u4f1a\u865a\u62df\u673a\u72b6\u6001\u8bbe\u7f6e\u4e3a\u5173\u673a\u5931\u8d25\uff0c\u5e76\u8bb0\u5f55\u5931\u8d25\u7684\u539f\u56e0\u3002"}),"\n"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-go",children:'func (self *GuestStopTask) OnInit(ctx context.Context, obj db.IStandaloneModel, data jsonutils.JSONObject) {\n    guest := obj.(*models.SGuest)\n    db.OpsLog.LogEvent(guest, db.ACT_STOPPING, nil, self.UserCred)\n    self.stopGuest(ctx, guest)\n}\n\nfunc (self *GuestStopTask) stopGuest(ctx context.Context, guest *models.SGuest) {\n    host := guest.GetHost()\n    if host == nil {\n        self.OnGuestStopTaskCompleteFailed(ctx, guest, jsonutils.NewString("no associated host"))\n        return\n    }\n    if !self.IsSubtask() {\n        guest.SetStatus(self.UserCred, api.VM_STOPPING, "")\n    }\n    self.SetStage("OnMasterStopTaskComplete", nil)\n    err := guest.GetDriver().RequestStopOnHost(ctx, guest, host, self)\n    ......\n}\n\nfunc (self *GuestStopTask) OnMasterStopTaskComplete(ctx context.Context, guest *models.SGuest, data jsonutils.JSONObject) {\n      ......\n      self.OnGuestStopTaskComplete(ctx, guest, data)\n}\n\nfunc (self *GuestStopTask) OnMasterStopTaskCompleteFailed(ctx context.Context, obj db.IStandaloneModel, reason jsonutils.JSONObject) {\n    guest := obj.(*models.SGuest)\n    self.OnGuestStopTaskCompleteFailed(ctx, guest, reason)\n}\n\nfunc (self *GuestStopTask) OnGuestStopTaskComplete(ctx context.Context, guest *models.SGuest, data jsonutils.JSONObject) {\n    ......\n    guest.SetStatus(self.UserCred, api.VM_READY, "")\n    ......\n    logclient.AddActionLogWithStartable(self, guest, logclient.ACT_VM_STOP, "", self.Us\nerCred, true)\n}\n\nfunc (self *GuestStopTask) OnGuestStopTaskCompleteFailed(ctx context.Context, guest *models.SGuest, reason jsonutils.JSONObject) {\n    ......\n    db.OpsLog.LogEvent(guest, db.ACT_STOP_FAIL, reason.String(), self.UserCred)\n    self.SetStageFailed(ctx, reason.String())\n    logclient.AddActionLogWithStartable(self, guest, logclient.ACT_VM_STOP, reason.String(), self.UserCred, false)\n}\n'})}),"\n",(0,t.jsx)(s.h2,{id:"\u5982\u4f55\u589e\u52a0\u4e00\u4e2a\u65b0\u7684\u670d\u52a1",children:"\u5982\u4f55\u589e\u52a0\u4e00\u4e2a\u65b0\u7684\u670d\u52a1"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"\u5728keystone\u6ce8\u518c\u4e00\u4e2a\u670d\u52a1\u542f\u7528\u7528\u7684\u8d26\u6237"}),"\n",(0,t.jsx)(s.li,{children:"\u5728keystone\u6ce8\u518cservice\u548cendpoint"}),"\n",(0,t.jsx)(s.li,{children:"\u53c2\u8003 cloudpods/pkg/logger\u5b9e\u73b0\u670d\u52a1\u4ee3\u7801"}),"\n",(0,t.jsx)(s.li,{children:"\u4e3a\u670d\u52a1\u51c6\u5907\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u5305\u542b\u4ee5\u4e0b\u57fa\u7840\u4fe1\u606f"}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["\u5047\u8bbe\u670d\u52a1\u540d\u4e3a svc\uff0c\u7528\u6237\u548c\u5bc6\u7801\u4e3a svcuser, svcuserpassword\uff0c\u670d\u52a1\u76d1\u542c\u5730\u5740\u4e3a: ",(0,t.jsx)(s.a,{href:"http://localhost:8866",children:"http://localhost:8866"}),", region \u4e3a LocalTest\uff0c\u5bf9\u5e94\u64cd\u4f5c\u5982\u4e0b:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"# \u521b\u5efa service\n$ climc service-create --enabled svc svc\n# \u521b\u5efa endpoint\uff0c\u5bf9\u5e94\u7684 service \u4e3a svc\n$ climc endpoint-create svc LocalTest internal http://localhost:8866\n# \u521b\u5efa user\n$ climc user-create --password svcuserpassword --enabled svcuser\n# \u628a user \u52a0\u5165 system \u9879\u76ee\n$ climc project-add-user system svcuser admin\n"})}),"\n",(0,t.jsx)(s.p,{children:"\u914d\u7f6e\u4fe1\u606f\u5982\u4e0b"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-yaml",children:"region: LocalTest\nport: 8866\nauth_url: https://<keystone_url>:35357/v3\nadmin_user: svcuser\nadmin_password: svcuserpassword\nadmin_tenant_name: system\n"})})]})}function u(e={}){const{wrapper:s}={...(0,r.a)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},25356:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/auth_framework-1a3cd306d872c4b743dc6d5a63d0fcfe.png"},12519:(e,s,n)=>{n.d(s,{Z:()=>t});const t=n.p+"assets/images/service_framework-a69e1a799c54e555e9bb947161241445.png"},11151:(e,s,n)=>{n.d(s,{Z:()=>a,a:()=>i});var t=n(67294);const r={},l=t.createContext(r);function i(e){const s=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(l.Provider,{value:s},e.children)}}}]);