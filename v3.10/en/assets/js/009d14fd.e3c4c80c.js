"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[7821],{39167:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>m,contentTitle:()=>x,default:()=>f,frontMatter:()=>g,metadata:()=>b,toc:()=>j});var r=n(74848),t=n(28453),i=n(28541);function s(e){let{fieldKey:o}=e;return(0,r.jsx)("code",{children:(0,i.c)(o)})}function c(){return(0,r.jsx)(s,{fieldKey:"release_version"})}var l=n(14902),a=n(21312);function d(){const e=(0,i.c)("pre_release_version");return(0,r.jsx)(l.A,{language:"bash",children:(0,a.T)({id:"GetClusterVersion.useKubectlGetVersion",message:"# \u4f7f\u7528 kubectl \u83b7\u5f97\u5f53\u524d\u96c6\u7fa4\u7684\u7248\u672c"})+"\n$ kubectl -n onecloud get onecloudclusters default -o=jsonpath='{.spec.version}'"+`\n${e} # `+(0,a.T)({id:"GetClusterVersion.resultVersion",message:"\u53d1\u73b0\u5f53\u524d\u7248\u672c\u4e3a "})+e})}var h=n(41571),u=n(59462);function p(){const e=(0,i.c)("release_version"),o=(0,a.T)({id:"OcbootUpdate.PRIMARY_MASTER_HOST_explation",message:"\u662f\u6307\u90e8\u7f72\u96c6\u7fa4\u7684\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684 ip \u5730\u5740\uff0c\u9700\u8981\u672c\u673a\u80fd\u591f\u4f7f\u7528 ssh \u5bc6\u94a5\u767b\u5f55\u4e0a\u53bb\u3002"});return(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{children:[(0,r.jsx)("strong",{children:"PRIMARY_MASTER_HOST"})," ",o]}),(0,r.jsx)(l.A,{language:"bash",children:`$ ./ocboot.py upgrade <PRIMARY_MASTER_HOST> ${e}`})]})}const g={edition:"ce",sidebar_position:1},x="Upgrading with ocboot",b={id:"operations/upgrading/ocboot-upgrade",title:"Upgrading with ocboot",description:"This article introduces how to upgrade the service version to a specific version with ocboot.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/operations/upgrading/ocboot-upgrade.mdx",sourceDirName:"operations/upgrading",slug:"/operations/upgrading/ocboot-upgrade",permalink:"/v3.10/en/docs/operations/upgrading/ocboot-upgrade",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/operations/upgrading/ocboot-upgrade.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{edition:"ce",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Upgrade",permalink:"/v3.10/en/docs/operations/upgrading/"},next:{title:"Upgrading through docker compose",permalink:"/v3.10/en/docs/operations/upgrading/docker-compose-upgrade"}},m={},j=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"View current version",id:"view-current-version",level:2},{value:"Clone ocboot tool",id:"clone-ocboot-tool",level:2},{value:"Update ocboot code",id:"update-ocboot-code",level:2},{value:"Upgrade service components",id:"upgrade-service-components",level:2},{value:"Prerequisites",id:"prerequisites-1",level:3},{value:"Execute upgrade commands",id:"execute-upgrade-commands",level:3},{value:"View upgrade progress",id:"view-upgrade-progress",level:3},{value:"Instructions for Downgrading",id:"instructions-for-downgrading",level:2},{value:"Executing the Rollback",id:"executing-the-rollback",level:3},{value:"Rollback Operation",id:"rollback-operation",level:2}];function v(e){const o={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(o.h1,{id:"upgrading-with-ocboot",children:"Upgrading with ocboot"}),"\n",(0,r.jsx)(o.p,{children:"This article introduces how to upgrade the service version to a specific version with ocboot."}),"\n",(0,r.jsxs)(o.admonition,{type:"tip",children:[(0,r.jsx)(o.p,{children:"ocboot can only upgrade environments deployed with ocboot. If your environment was deployed with docker-compose, please refer to this document for upgrading:"}),(0,r.jsxs)(o.ul,{children:["\n",(0,r.jsx)(o.li,{children:(0,r.jsx)(o.a,{href:"./docker-compose-upgrade",children:"Upgrading with docker-compose"})}),"\n"]})]}),"\n",(0,r.jsx)(o.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsx)(o.p,{children:"It is recommended to upgrade to adjacent versions, such as upgrading from v3.8.x to v3.10.x with the following steps:"}),"\n",(0,r.jsxs)(o.ol,{children:["\n",(0,r.jsx)(o.li,{children:"v3.8.x => v3.9.x"}),"\n",(0,r.jsx)(o.li,{children:"v3.9.x => v3.10.x"}),"\n"]}),"\n",(0,r.jsx)(o.p,{children:"In general, the upgrade steps are as follows:"}),"\n",(0,r.jsxs)(o.p,{children:["Use the ",(0,r.jsx)(o.a,{href:"https://github.com/yunionio/ocboot",children:"ocboot"})," tool we wrote to upgrade. This tool mainly calls ",(0,r.jsx)(o.code,{children:"ansible"})," to upgrade all nodes in the cluster."]}),"\n","\n",(0,r.jsxs)(o.ol,{children:["\n",(0,r.jsxs)(o.li,{children:["Use git to pull the latest code of ",(0,r.jsx)(o.a,{href:"https://github.com/yunionio/ocboot",children:"ocboot"})," and switch to the tag of ",(0,r.jsx)(c,{}),"."]}),"\n",(0,r.jsxs)(o.li,{children:["Use the ",(0,r.jsx)(o.code,{children:"./ocboot.py upgrade"})," command in ",(0,r.jsx)(o.a,{href:"https://github.com/yunionio/ocboot",children:"ocboot"})," for version upgrade."]}),"\n"]}),"\n",(0,r.jsx)(o.h2,{id:"view-current-version",children:"View current version"}),"\n",(0,r.jsx)(o.p,{children:"You can use kubectl to view the current version of the cluster."}),"\n","\n",(0,r.jsx)(d,{}),"\n",(0,r.jsx)(o.h2,{id:"clone-ocboot-tool",children:"Clone ocboot tool"}),"\n",(0,r.jsx)(o.p,{children:"If you already have the ocboot tool locally, skip this step and update the code to the corresponding branch."}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"# Install ansible locally\n$ python3 -m pip install --upgrade pip setuptools wheel\n$ python3 -m pip install 'ansible<=9.0.0' paramiko\n"})}),"\n",(0,r.jsx)(o.p,{children:"Clone the ocboot tool to your local environment."}),"\n","\n",(0,r.jsx)(h.A,{}),"\n",(0,r.jsx)(o.h2,{id:"update-ocboot-code",children:"Update ocboot code"}),"\n","\n",(0,r.jsx)(u.A,{}),"\n",(0,r.jsx)(o.h2,{id:"upgrade-service-components",children:"Upgrade service components"}),"\n",(0,r.jsx)(o.h3,{id:"prerequisites-1",children:"Prerequisites"}),"\n",(0,r.jsx)(o.p,{children:"The principle of updating services is to remotely log in to the first control node of the cluster without password via local ssh, obtain the information of all nodes, and then execute playbook updates through ansible. Therefore, the following requirements must be met:"}),"\n",(0,r.jsxs)(o.ol,{children:["\n",(0,r.jsxs)(o.li,{children:["The local machine can ssh remotely to ",(0,r.jsx)(o.code,{children:"PRIMARY_MASTER_HOST"}),"."]}),"\n",(0,r.jsxs)(o.li,{children:[(0,r.jsx)(o.code,{children:"PRIMARY_MASTER_HOST"})," can ssh log in to other nodes in the cluster without password."]}),"\n"]}),"\n",(0,r.jsxs)(o.p,{children:["If password-free login is not set up, use the command ",(0,r.jsx)(o.code,{children:"ssh-copy-id -i ~/.ssh/id_rsa.pub root@PRIMARY_MASTER_HOST"})," to distribute the public key to the corresponding nodes in your own environment."]}),"\n",(0,r.jsxs)(o.p,{children:["You can check the version number for upgrade from the ",(0,r.jsx)(o.a,{href:"../../development/changelog/release-3_10/",children:"CHANGELOG 3.10 page"}),"."]}),"\n",(0,r.jsx)(o.h3,{id:"execute-upgrade-commands",children:"Execute upgrade commands"}),"\n",(0,r.jsx)(o.p,{children:"The following command upgrades ocboot-related services to higher versions, which will take a long time because of pulling docker images. Please be patient."}),"\n","\n",(0,r.jsx)(p,{}),"\n",(0,r.jsxs)(o.p,{children:["In addition, you can use ",(0,r.jsx)(o.code,{children:"./ocboot.py upgrade --help"})," to view other optional parameters."]}),"\n",(0,r.jsxs)(o.ul,{children:["\n",(0,r.jsxs)(o.li,{children:[(0,r.jsx)(o.code,{children:"--user"})," specifies other ssh users"]}),"\n",(0,r.jsxs)(o.li,{children:[(0,r.jsx)(o.code,{children:"--port"})," specifies ssh port"]}),"\n",(0,r.jsxs)(o.li,{children:[(0,r.jsx)(o.code,{children:"--key-file"})," specifies another ssh private key"]}),"\n",(0,r.jsxs)(o.li,{children:[(0,r.jsx)(o.code,{children:"--as-bastion"})," lets ",(0,r.jsx)(o.code,{children:"PRIMARY_MASTER_HOST"})," act as a bastion machine deployed on the host machine of the intranet"]}),"\n"]}),"\n",(0,r.jsx)(o.h3,{id:"view-upgrade-progress",children:"View upgrade progress"}),"\n",(0,r.jsxs)(o.p,{children:["You can log in to ",(0,r.jsx)(o.code,{children:"PRIMARY_MASTER_HOST"})," during the upgrade process to use ",(0,r.jsx)(o.code,{children:"kubectl"})," to check the upgrade status of the corresponding pods."]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"$ kubectl get pods -n onecloud --watch\n"})}),"\n",(0,r.jsx)(o.h2,{id:"instructions-for-downgrading",children:"Instructions for Downgrading"}),"\n",(0,r.jsx)(o.p,{children:"If there are any issues with the upgraded function or bugs, you can use the following command to regress and rollback."}),"\n",(0,r.jsxs)(o.admonition,{type:"warning",children:[(0,r.jsxs)(o.ul,{children:["\n",(0,r.jsx)(o.li,{children:"There are generally no problems with downgrading minor versions, such as downgrading from v3.10.7 to v3.10.6."}),"\n",(0,r.jsx)(o.li,{children:"There may be issues with cross-version downgrades, such as downgrading from v3.10.7 to v3.9.15."}),"\n"]}),(0,r.jsxs)(o.p,{children:["If you encounter any issues, please ",(0,r.jsx)(o.a,{href:"https://github.com/yunionio/cloudpods/issues",children:"submit an issue at GitHub"})," or ",(0,r.jsx)(o.a,{href:"../../contact/",children:"contact us"})," for help."]})]}),"\n",(0,r.jsx)(o.h3,{id:"executing-the-rollback",children:"Executing the Rollback"}),"\n",(0,r.jsx)(o.p,{children:"The rollback works by modifying the image version of each service. For example, if the current version is v3.10.7 and you want to revert to v3.10.6, execute the following command on the first control node:"}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"$ /opt/yunion/bin/ocadm cluster update --version v3.10.6 --wait\n"})}),"\n",(0,r.jsx)(o.p,{children:"Rollback will pull new images. You can open another window, log in to the first control node, and use the following command to check the update status of each pod."}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"$ kubectl -n onecloud get pods -w\n"})}),"\n",(0,r.jsx)(o.h2,{id:"rollback-operation",children:"Rollback Operation"}),"\n",(0,r.jsxs)(o.p,{children:["Since version v3.9.7, ocboot backups the deployment of the operator and the yaml file of onecloudcluster to ",(0,r.jsx)(o.code,{children:"/opt/yunion/ocboot/_upgrade/"})," each time it upgrades the cluster service, making it easier to manually rollback components in the future."]}),"\n",(0,r.jsx)(o.p,{children:"In case the upgrade fails, or you want to revert to the previous version after the upgrade, use the following steps:555555"}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"# View the upgrade backup directory in /opt/yunion/ocboot/_upgrade/\n# The subdirectory inside is named after the upgrade time\n$ ls /opt/yunion/ocboot/_upgrade/\n2023.02.20-10:10:07\n\n# For example, if you want to revert to the version before 2023.02.20-10:10:07, perform the following steps.\n$ cd /opt/yunion/ocboot/_upgrade/2023.02.20-10\\:10\\:07/\n# View the relevant yaml file\n$ ls -lh\n-rw-r--r-- 1 root root  61K Feb 20 10:10 oc.yml # oc.yaml is the description file for onecloudcluster\n-rw-r--r-- 1 root root 3.9K Feb 20 10:10 operator.yml # operator.yaml is the description file for operator deployment\n\n# Rollback operator first\n$ kubectl apply -f operator.yml\ndeployment.extensions/onecloud-operator configured\n# Wait until the newly created operator is Running. If it is in the ContainerCreating state, wait a while.\n$ kubectl get pods -n onecloud | grep operator\nonecloud-operator-5557d86d74-7s5sl                   1/1     Running   0          2s\n\n# Then rollback onecloudcluster\n$ kubectl apply -f oc.yml\n"})})]})}function f(e={}){const{wrapper:o}={...(0,t.R)(),...e.components};return o?(0,r.jsx)(o,{...e,children:(0,r.jsx)(v,{...e})}):v(e)}},41571:(e,o,n)=>{n.d(o,{A:()=>c});var r=n(14902),t=n(21312),i=n(28541),s=n(74848);function c(){const e=(0,t.T)({id:"OcbootClone.downloadComment",message:"# \u4e0b\u8f7d ocboot \u5de5\u5177\u5230\u672c\u5730",description:"locally download comment"}),o=(0,i.c)("release_branch");return(0,s.jsx)("div",{children:(0,s.jsx)(r.A,{language:"bash",children:e+`\n$ git clone -b ${o} https://github.com/yunionio/ocboot && cd ./ocboot`})})}},59462:(e,o,n)=>{n.d(o,{A:()=>s});var r=n(14902),t=n(28541),i=n(74848);function s(){const e=(0,t.c)("release_version");return(0,i.jsx)(r.A,{language:"bash",children:`$ git fetch\n$ git checkout ${e}`})}},28541:(e,o,n)=>{n.d(o,{c:()=>t});var r=n(44586);function t(e){const{siteConfig:o}=(0,r.A)();return o.customFields[e]}},67332:(e,o,n)=>{n.d(o,{A:()=>i});n(96540);var r=n(52830),t=n(74848);function i(e){const o={...e};return o?.code?.length>2&&(o.code=o.code.split("\n").map((e=>e.length>2&&"$ "===e.substring(0,2)?e.substring(2):e)).join("\n")),(0,t.jsx)(t.Fragment,{children:(0,t.jsx)(r.A,{...o})})}}}]);