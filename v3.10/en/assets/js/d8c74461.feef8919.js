"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[6718],{86495:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>h,default:()=>f,frontMatter:()=>r,metadata:()=>c,toc:()=>l});var i=t(74848),s=t(28453);const o=t.p+"assets/images/singleport-0a498050c1c38f46f755af5b3ca2eb73.png",a=t.p+"assets/images/singleportvlan-02d382cc004177a0739d00ced2766454.png",r={sidebar_position:90},h="Typical Network Configuration",c={id:"guides/onpremise/network/examples",title:"Typical Network Configuration",description:"This article introduces several typical private cloud network configurations.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/guides/onpremise/network/examples.mdx",sourceDirName:"guides/onpremise/network",slug:"/guides/onpremise/network/examples",permalink:"/v3.10/en/docs/guides/onpremise/network/examples",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/guides/onpremise/network/examples.mdx",tags:[],version:"current",sidebarPosition:90,frontMatter:{sidebar_position:90},sidebar:"tutorialSidebar",previous:{title:"\u7f51\u5361\u9644\u5c5eIP(SubIPs)",permalink:"/v3.10/en/docs/guides/onpremise/network/subips"},next:{title:"\u591a\u4e91\u7ba1\u7406",permalink:"/v3.10/en/docs/guides/cmp/"}},u={},l=[{value:"(Single NIC Classic Network) computing node single NIC, virtual machine using Multi-VLAN classic network",id:"single-nic-classic-network-computing-node-single-nic-virtual-machine-using-multi-vlan-classic-network",level:2},{value:"VPC Configuration",id:"vpc-configuration",level:3},{value:"Layer-2 Network Configuration",id:"layer-2-network-configuration",level:3},{value:"IP Subnet Configuration",id:"ip-subnet-configuration",level:3},{value:"Host Configuration",id:"host-configuration",level:3},{value:"How to configure if the host management port uses a VLAN ID other than 1 and the switch does not support setting the default VLAN ID for TRUNK port?",id:"how-to-configure-if-the-host-management-port-uses-a-vlan-id-other-than-1-and-the-switch-does-not-support-setting-the-default-vlan-id-for-trunk-port",level:4},{value:"EIP Configuration",id:"eip-configuration",level:3},{value:"(Single NIC VPC Network) computing node single NIC, virtual machine using VPC network",id:"single-nic-vpc-network-computing-node-single-nic-virtual-machine-using-vpc-network",level:2},{value:"Host Network Configuration",id:"host-network-configuration",level:3},{value:"Virtual Machine Network Configuration",id:"virtual-machine-network-configuration",level:3},{value:"EIP Configuration",id:"eip-configuration-1",level:3},{value:"EIP Gateway Routing ConfigurationTo use EIP, you also need to add an IP subnet for EIP under the platform bcast0 (Note that the EIP subnet should avoid being in the same subnet as the host&#39;s management IP, that is, the network address needs to be different. For example, if the host&#39;s management NIC is 10.168.22.2/24, then the EIP subnet is 10.168.23.0/24). Add a static route for the EIP subnet on the switch, with the NextHop set to the management port IP address of the first host in the ALL IN ONE deployment.",id:"eip-gateway-routing-configurationto-use-eip-you-also-need-to-add-an-ip-subnet-for-eip-under-the-platform-bcast0-note-that-the-eip-subnet-should-avoid-being-in-the-same-subnet-as-the-hosts-management-ip-that-is-the-network-address-needs-to-be-different-for-example-if-the-hosts-management-nic-is-1016822224-then-the-eip-subnet-is-1016823024-add-a-static-route-for-the-eip-subnet-on-the-switch-with-the-nexthop-set-to-the-management-port-ip-address-of-the-first-host-in-the-all-in-one-deployment",level:4},{value:"(Dual NIC Classic Network) Compute node with two NICs, virtual machines use Multi-VLAN Classic Network",id:"dual-nic-classic-network-compute-node-with-two-nics-virtual-machines-use-multi-vlan-classic-network",level:2},{value:"VPC Configuration",id:"vpc-configuration-1",level:3},{value:"Layer-2 Network Configuration",id:"layer-2-network-configuration-1",level:3},{value:"IP Subnet Configuration",id:"ip-subnet-configuration-1",level:3},{value:"Host Configuration",id:"host-configuration-1",level:3},{value:"EIP Configuration",id:"eip-configuration-2",level:3},{value:"(Dual NIC VPC Network) Compute node with two NICs, virtual machines use VPC Network",id:"dual-nic-vpc-network-compute-node-with-two-nics-virtual-machines-use-vpc-network",level:2},{value:"Host Network Configuration",id:"host-network-configuration-1",level:3},{value:"Virtual Machine Network Configuration",id:"virtual-machine-network-configuration-1",level:3},{value:"EIP Configuration",id:"eip-configuration-3",level:3},{value:"EIP Gateway Routing Configuration",id:"eip-gateway-routing-configuration",level:4}];function d(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"typical-network-configuration",children:"Typical Network Configuration"}),"\n",(0,i.jsx)(n.p,{children:"This article introduces several typical private cloud network configurations."}),"\n",(0,i.jsx)(n.h2,{id:"single-nic-classic-network-computing-node-single-nic-virtual-machine-using-multi-vlan-classic-network",children:"(Single NIC Classic Network) computing node single NIC, virtual machine using Multi-VLAN classic network"}),"\n",(0,i.jsx)(n.p,{children:"In this scenario, each computing node only has one NIC (which can be Bonding) that serves both as a management port and a business port. The business traffic between virtual machines is forwarded by the host to the Layer 3 switch."}),"\n","\n",(0,i.jsx)("img",{src:o,width:"400"}),"\n",(0,i.jsx)(n.h3,{id:"vpc-configuration",children:"VPC Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.em,{children:"Default"})," VPC."]}),"\n",(0,i.jsx)(n.h3,{id:"layer-2-network-configuration",children:"Layer-2 Network Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Create a layer-2 network ",(0,i.jsx)(n.em,{children:"bcast0"})," in ",(0,i.jsx)(n.em,{children:"Default"})," VPC."]}),"\n",(0,i.jsx)(n.h3,{id:"ip-subnet-configuration",children:"IP Subnet Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Create at least 2 IP subnets in the layer-2 network ",(0,i.jsx)(n.em,{children:"bcast0"}),", one of which is used for the host management port and needs to include the IP of the host management port. The other subnet is used for the virtual machine. More IP subnets can be configured for virtual machines, and these virtual machines can be configured with different VLAN IDs (VLAN IDs other than 1). The gateway and corresponding VLAN of these IP subnets need to be configured on the Layer 3 switch connected to the physical machine."]}),"\n",(0,i.jsx)(n.h3,{id:"host-configuration",children:"Host Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The host port on the switch needs to be configured in trunk mode, and the ",(0,i.jsx)(n.em,{children:"default"})," VLAN ID must be used for the host management port. By default, the VLAN ID is 1. But currently, the switch also supports setting a VLAN ID other than 1 for the TRUNK port. Please refer to the switch configuration manual for details."]}),"\n",(0,i.jsx)(n.p,{children:"The networks configuration of the host.conf file:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"networks:\n- <host_ifname>/br0/<host_management_ip>\n"})}),"\n",(0,i.jsx)(n.p,{children:"For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"networks:\n- eth0/br0/10.168.20.2\n"})}),"\n",(0,i.jsx)(n.h4,{id:"how-to-configure-if-the-host-management-port-uses-a-vlan-id-other-than-1-and-the-switch-does-not-support-setting-the-default-vlan-id-for-trunk-port",children:"How to configure if the host management port uses a VLAN ID other than 1 and the switch does not support setting the default VLAN ID for TRUNK port?"}),"\n","\n",(0,i.jsx)("img",{src:a,width:"400"}),"\n",(0,i.jsx)(n.p,{children:"A VLAN subinterface needs to be set up for the host, and the host uses this VLAN subinterface as the management port, and the virtual machine switch needs to be bridged to the main interface. Take the host main interface bond0 and the VLAN ID of the host management port 3001 as an example:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Configure VLAN subinterface bond0.3001 for the host, as follows:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# /etc/sysconfig/network-scripts/ifcfg-bond0.3001\nVLAN=yes\nNAME=bond0.3001\nDEVICE=bond0.3001\nIPADDR=<management_ip>\nPREFIX=<prefix>\nDEFROUTE=yes\nONBOOT=yes\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Modify /etc/yunion/host.conf and set it as follows:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"listen_interface: bond0.3001\nnetworks:\n- bond0/br0/bcast0\n"})}),"\n",(0,i.jsx)(n.p,{children:"Note that in this configuration, virtual machines cannot use the same VLAN ID as the host (in this case, 3001)."}),"\n",(0,i.jsx)(n.h3,{id:"eip-configuration",children:"EIP Configuration"}),"\n",(0,i.jsx)(n.p,{children:"In classic network mode, external entities can directly access virtual machine IPs without configuring EIP."}),"\n",(0,i.jsx)(n.h2,{id:"single-nic-vpc-network-computing-node-single-nic-virtual-machine-using-vpc-network",children:"(Single NIC VPC Network) computing node single NIC, virtual machine using VPC network"}),"\n",(0,i.jsx)(n.p,{children:"In this scenario, each computing node host has only one NIC as the management port. The management port also carries business traffic, but the business traffic between virtual machines is encapsulated by the OVN Geneve tunnel."}),"\n",(0,i.jsx)(n.h3,{id:"host-network-configuration",children:"Host Network Configuration"}),"\n",(0,i.jsx)(n.p,{children:"The host's management port still accesses the classic network."}),"\n",(0,i.jsxs)(n.p,{children:["Create a layer-2 network ",(0,i.jsx)(n.em,{children:"bcast0"})," in ",(0,i.jsx)(n.em,{children:"Default"})," VPC, and in this layer-2 network, configure the IP subnet used by the host management port."]}),"\n",(0,i.jsxs)(n.p,{children:["The host.conf networks configuration is the same as the ",(0,i.jsx)(n.em,{children:"Single NIC Classic Network"})," mode."]}),"\n",(0,i.jsx)(n.p,{children:"For example, if the host IP subnet is 10.128.26.2, the configuration is also:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"networks:\n- eth0/br0/10.128.26.2\n"})}),"\n",(0,i.jsx)(n.h3,{id:"virtual-machine-network-configuration",children:"Virtual Machine Network Configuration"}),"\n",(0,i.jsx)(n.p,{children:"The virtual machine's network is managed by VPC. Users can create any VPC and allocate any IP subnet in the VPC. IP subnets between different VPCs are isolated from each other and cannot be accessed. IP subnets within the same VPC are not isolated from each other."}),"\n",(0,i.jsx)(n.h3,{id:"eip-configuration-1",children:"EIP Configuration"}),"\n",(0,i.jsx)(n.p,{children:"In this mode, EIP needs to be configured to access virtual machines in the VPC from outside the cloud platform."}),"\n",(0,i.jsx)(n.p,{children:"The simplest EIP configuration is to select a host, modify /etc/yunion/host.conf, and set sdn_enable_eip_man to true. For more specific configuration methods, please refer to the documentation. The first host installed in the ALL IN ONE mode automatically enables sdn_enable_eip_man."}),"\n",(0,i.jsx)(n.h4,{id:"eip-gateway-routing-configurationto-use-eip-you-also-need-to-add-an-ip-subnet-for-eip-under-the-platform-bcast0-note-that-the-eip-subnet-should-avoid-being-in-the-same-subnet-as-the-hosts-management-ip-that-is-the-network-address-needs-to-be-different-for-example-if-the-hosts-management-nic-is-1016822224-then-the-eip-subnet-is-1016823024-add-a-static-route-for-the-eip-subnet-on-the-switch-with-the-nexthop-set-to-the-management-port-ip-address-of-the-first-host-in-the-all-in-one-deployment",children:"EIP Gateway Routing ConfigurationTo use EIP, you also need to add an IP subnet for EIP under the platform bcast0 (Note that the EIP subnet should avoid being in the same subnet as the host's management IP, that is, the network address needs to be different. For example, if the host's management NIC is 10.168.22.2/24, then the EIP subnet is 10.168.23.0/24). Add a static route for the EIP subnet on the switch, with the NextHop set to the management port IP address of the first host in the ALL IN ONE deployment."}),"\n",(0,i.jsx)(n.h2,{id:"dual-nic-classic-network-compute-node-with-two-nics-virtual-machines-use-multi-vlan-classic-network",children:"(Dual NIC Classic Network) Compute node with two NICs, virtual machines use Multi-VLAN Classic Network"}),"\n",(0,i.jsx)(n.p,{children:"In this scenario, each compute node has two NICs, one for management and the other for business. Business traffic between virtual machines is forwarded by a Layer 3 switch that connects to the host's business NIC. However, some virtual machines need to connect to the management NIC."}),"\n",(0,i.jsx)(n.h3,{id:"vpc-configuration-1",children:"VPC Configuration"}),"\n",(0,i.jsx)(n.p,{children:"Use the Default VPC."}),"\n",(0,i.jsx)(n.h3,{id:"layer-2-network-configuration-1",children:"Layer-2 Network Configuration"}),"\n",(0,i.jsx)(n.p,{children:"Create two Layer-2 networks in the Default VPC: bcast0 (management) and bcast1 (business)."}),"\n",(0,i.jsx)(n.h3,{id:"ip-subnet-configuration-1",children:"IP Subnet Configuration"}),"\n",(0,i.jsx)(n.p,{children:"Create at least two IP subnets on bcast0, with one IP subnet used for the host's management NIC, which needs to include the host's management NIC IP address. The other subnet is used for virtual machines that require a connection to the management network."}),"\n",(0,i.jsx)(n.p,{children:"Create 1 or more IP subnets on bcast1 for virtual machine use, and these subnets can be configured with different VLAN IDs (VLAN ID other than 1). The gateways and corresponding VLANs for these subnets need to be configured on the corresponding Layer 3 switches connected to the physical machine."}),"\n",(0,i.jsx)(n.h3,{id:"host-configuration-1",children:"Host Configuration"}),"\n",(0,i.jsx)(n.p,{children:"The host's management NIC needs to be configured with a management IP address and set to Access mode on the switch."}),"\n",(0,i.jsx)(n.p,{children:"The host's business NIC does not need to be configured with an IP address, but the business NIC needs to be configured in Trunk mode on the switch."}),"\n",(0,i.jsx)(n.p,{children:"The host's /etc/yunion/host.conf file needs to have two entries, one for the management NIC and one for the business NIC:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"networks:\n- <host_ifname0>/br0/<host_management_ip>\n- <host_ifname1>/br1/bcast1\n"})}),"\n",(0,i.jsx)(n.p,{children:"For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"networks:\n- eth0/br0/10.168.20.2\n- eth1/br1/bcast1\n"})}),"\n",(0,i.jsx)(n.h3,{id:"eip-configuration-2",children:"EIP Configuration"}),"\n",(0,i.jsx)(n.p,{children:"In this mode, virtual machines' IPs can be directly accessed from the outside without the need to configure EIP."}),"\n",(0,i.jsx)(n.h2,{id:"dual-nic-vpc-network-compute-node-with-two-nics-virtual-machines-use-vpc-network",children:"(Dual NIC VPC Network) Compute node with two NICs, virtual machines use VPC Network"}),"\n",(0,i.jsx)(n.p,{children:"In this scenario, each compute node's host has two NICs: one for management, which carries management traffic, and another for business, which carries business traffic. Business traffic between virtual machines is encapsulated in an ovn-geneve tunnel, and then forwarded through the host's business NIC."}),"\n",(0,i.jsx)(n.h3,{id:"host-network-configuration-1",children:"Host Network Configuration"}),"\n",(0,i.jsx)(n.p,{children:"Similarly, the host's management NIC uses a classic network. You need to configure a Layer-2 network bcast0 under Default VPC, and configure the IP subnet used by the host's management NIC under that Layer-2 network."}),"\n",(0,i.jsx)(n.p,{children:"For example, the host's IP subnet is 10.128.26.2. The host's /etc/yunion/host.conf configuration should be:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"networks:\n- eth0/br0/10.128.26.2\n"})}),"\n",(0,i.jsx)(n.p,{children:"Also, the host's business NIC needs to be configured with an IP address, and the IP used by the business NIC should not be in the same Layer-2 network as the IP used by the management NIC."}),"\n",(0,i.jsx)(n.p,{children:"To ensure ovn traffic between virtual machines is forwarded through the business NIC, you need to configure the ovn_encap_ip in /etc/yunion/host.conf to the IP address of the host's business NIC."}),"\n",(0,i.jsx)(n.p,{children:"For example, if the host's management NIC IP is 10.128.26.2/24 and the business NIC IP is 10.129.26.2/24, the /etc/yunion/host.conf file should be configured as follows:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"ovn_encap_ip: 10.129.26.2\nnetworks:\n- eth0/br0/10.128.26.2\n- eth1/br1/10.129.26.2\n"})}),"\n",(0,i.jsx)(n.p,{children:"After the configuration is complete, ovn traffic between virtual machines will be encapsulated as geneve traffic, with source and destination IP addresses being in the business network range. Network intercommunication between business NICs is not affected by business NIC VLAN mode, whether TRUNK or Access."}),"\n",(0,i.jsx)(n.h3,{id:"virtual-machine-network-configuration-1",children:"Virtual Machine Network Configuration"}),"\n",(0,i.jsx)(n.p,{children:"Similarly, in this mode, the virtual machine network is managed by the VPC Network, and users can create VPCs and assign any IP subnet in VPC. IP subnets between different VPCs are isolated and cannot be accessed. IP subnets in the same VPC are not isolated. As the ovn_encap_ip is configured to the host's business NIC IP address, ovn traffic between virtual machines is forwarded through the host's business NIC."}),"\n",(0,i.jsx)(n.h3,{id:"eip-configuration-3",children:"EIP Configuration"}),"\n",(0,i.jsx)(n.p,{children:"In VPC network mode, you need to configure EIP for external access to specific internal virtual machines. Similarly, EIP gateway and subnet need to be configured."}),"\n",(0,i.jsx)(n.h4,{id:"eip-gateway-routing-configuration",children:"EIP Gateway Routing Configuration"}),"\n",(0,i.jsx)(n.p,{children:"Unlike the Single NIC VPC Network case, in order to ensure EIP traffic also passes through the business NIC, the following two configurations need to be met:"}),"\n",(0,i.jsx)(n.p,{children:"When configuring NextHop for the EIP subnet, on the switch, it is necessary to use the IP address of the node's business NIC on which the EIP gateway is located as the NextHop IP (to ensure that the incoming traffic to the EIP traffic goes through the business NIC).* On the node where the EIP gateway is located, the business port needs to be set as the default route for outbound traffic. (Ensure that the traffic flowing out of the EIP goes through the business port)"})]})}function f(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var i=t(96540);const s={},o=i.createContext(s);function a(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);