"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[6800],{34726:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>p,frontMatter:()=>r,metadata:()=>a,toc:()=>i});var t=o(85893),s=o(11151);const r={sidebar_position:2},c="\u7cfb\u7edf\u81ea\u52a8\u5907\u4efd",a={id:"operations/ha/auto-backup",title:"\u7cfb\u7edf\u81ea\u52a8\u5907\u4efd",description:"\u4ecb\u7ecd\u5982\u4f55\u7cfb\u7edf\u81ea\u52a8\u5907\u4efd\u6570\u636e\u5e93\u3001k8s oc/deployment\u3001ETCD\u5185\u5bb9\u3002",source:"@site/docs/operations/ha/auto-backup.md",sourceDirName:"operations/ha",slug:"/operations/ha/auto-backup",permalink:"/v3.10/en/docs/operations/ha/auto-backup",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/operations/ha/auto-backup.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"\u9ad8\u53ef\u7528\u96c6\u7fa4",permalink:"/v3.10/en/docs/operations/ha/ha-cluster"},next:{title:"\u63a7\u5236\u8282\u70b9\u66ff\u6362\u6d41\u7a0b",permalink:"/v3.10/en/docs/operations/ha/replace"}},l={},i=[{value:"\u81ea\u52a8\u5907\u4efd\u4e91\u7ba1\u7cfb\u7edf\u7684\u6570\u636e\u5e93\u3001K8s \u914d\u7f6e\u3001etcd \u5feb\u7167",id:"\u81ea\u52a8\u5907\u4efd\u4e91\u7ba1\u7cfb\u7edf\u7684\u6570\u636e\u5e93k8s-\u914d\u7f6eetcd-\u5feb\u7167",level:2},{value:"\u624b\u5de5\u6062\u590d\u5907\u4efd\u7684\u6570\u636e\u5e93\u548ck8s\u914d\u7f6e",id:"\u624b\u5de5\u6062\u590d\u5907\u4efd\u7684\u6570\u636e\u5e93\u548ck8s\u914d\u7f6e",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"\u7cfb\u7edf\u81ea\u52a8\u5907\u4efd",children:"\u7cfb\u7edf\u81ea\u52a8\u5907\u4efd"}),"\n",(0,t.jsx)(n.p,{children:"\u4ecb\u7ecd\u5982\u4f55\u7cfb\u7edf\u81ea\u52a8\u5907\u4efd\u6570\u636e\u5e93\u3001k8s oc/deployment\u3001ETCD\u5185\u5bb9\u3002"}),"\n",(0,t.jsx)(n.h2,{id:"\u81ea\u52a8\u5907\u4efd\u4e91\u7ba1\u7cfb\u7edf\u7684\u6570\u636e\u5e93k8s-\u914d\u7f6eetcd-\u5feb\u7167",children:"\u81ea\u52a8\u5907\u4efd\u4e91\u7ba1\u7cfb\u7edf\u7684\u6570\u636e\u5e93\u3001K8s \u914d\u7f6e\u3001etcd \u5feb\u7167"}),"\n",(0,t.jsx)(n.p,{children:"\u672c\u547d\u4ee4\u4e3a\u6307\u5b9a\u7684\u7cfb\u7edf\u589e\u52a0\u81ea\u52a8\u5907\u4efd\u4e91\u7ba1\u7cfb\u7edf\u7684\u6570\u636e\u5e93\u3001K8s \u914d\u7f6e\u3001etcd \u5feb\u7167\u7684\u529f\u80fd\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"usage: ocboot.py auto-backup [-h] [--user SSH_USER]\n                             [--key-file SSH_PRIVATE_FILE] [--port SSH_PORT]\n                             [--backup-path BACKUP_PATH] [--light]\n                             [--max-backups MAX_BACKUPS]\n                             [--max-disk-percentage MAX_DISK_PERCENTAGE]\n                             TARGET_NODE_HOSTS [TARGET_NODE_HOSTS ...]\n\npositional arguments:\n  TARGET_NODE_HOSTS     target nodes\n\noptional arguments:\n  -h, --help            show this help message and exit\n  --user SSH_USER, -u SSH_USER\n                        target host ssh user (default: root)\n  --key-file SSH_PRIVATE_FILE, -k SSH_PRIVATE_FILE\n                        target host ssh private key file (default:\n                        /root/.ssh/id_rsa)\n  --port SSH_PORT, -p SSH_PORT\n                        target host host ssh port (default: 22)\n  --backup-path BACKUP_PATH\n                        backup path, default: /opt/yunion/backup\n  --light               ignore yunionmeter and yunionlogger database; ignore\n                        tables start with 'opslog' and 'task'.\n  --max-backups MAX_BACKUPS\n                        how many backups to keep. default: 10\n  --max-disk-percentage MAX_DISK_PERCENTAGE\n                        the max usage percentage of the disk on which the\n                        backup will be done allowed to perform backup. the\n                        backup job will not work when the disk's usage is\n                        above the threshold. default: 75(%).\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u4e0b\u9762\u4ecb\u7ecd\u5404\u4e2a\u53c2\u6570\u7684\u4f5c\u7528\u548c\u6ce8\u610f\u4e8b\u9879"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"TARGET_NODE_HOSTS"}),"\uff0c\u6b64\u5904\u586b\u5199\u9700\u8981\u90e8\u7f72\u81ea\u52a8\u5907\u4efd\u7684",(0,t.jsx)(n.strong,{children:"\u63a7\u5236\u8282\u70b9"}),"\u7684IP\u3002\u5982\u679c\u6709\u591a\u4e2a\u63a7\u5236\u8282\u70b9\uff0c\u53ea\u9700\u8f93\u5165\u5176\u4e2d\u4e4b\u4e00\u5373\u53ef\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"--user"}),", ",(0,t.jsx)(n.code,{children:"--key-file"}),", ",(0,t.jsx)(n.code,{children:"--port"}),"\u8fd9\u4e9b\u53c2\u6570\u662f\u767b\u5f55\u5907\u4efd\u673a\u5668\u7684ssh\u914d\u7f6e\u3002\u4e00\u822c\u9ed8\u8ba4\u7528\u6237\u540d",(0,t.jsx)(n.code,{children:"root"}),"\u3001\u7aef\u53e3\u53f7",(0,t.jsx)(n.code,{children:"22"}),"\u3002\u5982\u679c\u81ea\u5b9a\u4e49\uff0c\u53ef\u4ee5\u5728",(0,t.jsx)(n.code,{children:"$HOME/.ssh/config"}),"\u91cc\u914d\u7f6e\u3002\u8bf7\u786e\u4fdd\u5f53\u524d\u673a\u5668\u53ef\u4ee5\u514d\u5bc6\u767b\u5f55\u5230\u6240\u8f93\u5165\u7684",(0,t.jsx)(n.code,{children:"TARGET_NODE_HOSTS"}),"\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"--backup-path"}),"\uff0c\u5907\u4efd\u8def\u5f84\u3002\u9ed8\u8ba4\u4e3a",(0,t.jsx)(n.code,{children:"/opt/yunion/backup"}),"\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"--max-disk-percentage"}),"\u5141\u8bb8\u7684\u6700\u5927\u78c1\u76d8\u4f7f\u7528\u7387\u3002\u9ed8\u8ba4\u4e3a",(0,t.jsx)(n.code,{children:"75%"}),"\u3002\u5907\u4efd\u8fc7\u7a0b\u4f1a\u68c0\u6d4b\u6240\u8f93\u5165\u7684",(0,t.jsx)(n.code,{children:"--backup-path"}),"\u6240\u5728\u78c1\u76d8\u7684\u4f7f\u7528\u7387\u3002\u5982\u679c\u5df2\u7ecf\u8fbe\u5230\u5141\u8bb8\u7684\u6700\u5927\u78c1\u76d8\u4f7f\u7528\u7387\uff0c\u5c31\u4f1a\u505c\u6b62\u5907\u4efd\uff0c\u4ee5\u514d\u5907\u4efd\u6587\u4ef6\u6253\u6ee1\u78c1\u76d8\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"--light"}),"\u662f\u5426\u4e3a\u8f7b\u91cf\u5907\u4efd\u3002\u9ed8\u8ba4\u4e3a",(0,t.jsx)(n.code,{children:"\u5426"}),"\uff0c\u5373\uff0c\u5168\u91cf\u5907\u4efd\u3002\u8f7b\u91cf\u5907\u4efd\u4e0e\u5168\u91cf\u5907\u4efd\u7684\u533a\u522b\u662f\u67d0\u4e9b\uff08\u901a\u5e38\u53ef\u4ee5\u81ea\u7531\u5220\u9664\u7684\uff09\u4e1a\u52a1\u65e5\u5fd7\u3002\u5efa\u8bae\u65e5\u5e38\u53ea\u9009\u8f7b\u91cf\u5907\u4efd\uff0c\u4ee5\u8282\u7ea6\u78c1\u76d8\u3001\u52a0\u901f\u5907\u4efd\u8fc7\u7a0b\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"--max-backups"}),"\u4fdd\u7559\u7684\u5907\u4efd\u6b21\u6570\u3002\u9ed8\u8ba4\u4fdd\u7559\u6700\u65b0\u768410\u6b21\u5907\u4efd\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u624b\u5de5\u6062\u590d\u5907\u4efd\u7684\u6570\u636e\u5e93\u548ck8s\u914d\u7f6e",children:"\u624b\u5de5\u6062\u590d\u5907\u4efd\u7684\u6570\u636e\u5e93\u548ck8s\u914d\u7f6e"}),"\n",(0,t.jsx)(n.p,{children:"ssh\u767b\u9646\u63a7\u5236\u8282\u70b9\uff0c\u8fdb\u5165\u5907\u4efd\u76ee\u5f55\uff0c\u4ee52023-05-28\u7684\u5907\u4efd\u4e3a\u4f8b\uff0c\u6062\u590d\u547d\u4ee4\u5982\u4e0b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"[root@controller ~]# cd /opt/yunion/backup/\n[root@controller backup]# tar -xzvf onecloud.bkup.20230528-000001.tar.gz\n[root@controller backup]# cd 20230528-000001/\n[root@controller 20230528-000001]# ll\ntotal 181548\n-rw------- 1 root root 185819168 May 28 00:00 etcd_snapshot_20230528-000001.db\n-rw-r--r-- 1 root root     74493 May 28 00:00 oc.20230528-000001.yml\n-rw-r--r-- 1 root root      3241 May 28 00:00 onecloud-operator.20230528-000001.yml\n\n# \u6062\u590d\u6570\u636e\u5e93\n[root@controller 20230528-000001]# pv onecloud.sql.20230528-000001.gz | gunzip | mysql -uroot -p$MYSQL_PASSWD -h $MYSQL_HOST\n\n# \u6062\u590dk8s\u5404\u7ec4\u4ef6\u670d\u52a1\n[root@controller 20230528-000001]# kubectl apply -f oc.20230528-000001.yml\n[root@controller 20230528-000001]# kubectl apply -f onecloud-operator.20230528-000001.yml\n"})})]})}function p(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},11151:(e,n,o)=>{o.d(n,{Z:()=>a,a:()=>c});var t=o(67294);const s={},r=t.createContext(s);function c(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);