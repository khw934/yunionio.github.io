"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[7410],{74279:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>v,frontMatter:()=>t,metadata:()=>d,toc:()=>o});var a=i(85893),s=i(11151);const t={sidebar_position:2},r="vGPU",d={id:"guides/onpremise/vminstance/passthrough/vgpu",title:"vGPU",description:"vGPU\u662f\u4e00\u79cdGPU\u865a\u62df\u5316\u6280\u672f,\u5b83\u53ef\u4ee5\u5c06\u5355\u4e2a\u7269\u7406GPU\u865a\u62df\u5316\u4e3a\u591a\u4e2a\u865a\u62dfGPU\u5b9e\u4f8b,\u4ee5\u4f9b\u591a\u4e2a\u865a\u62df\u673a\u540c\u65f6\u4f7f\u7528\u3002",source:"@site/docs/guides/onpremise/vminstance/passthrough/vgpu.md",sourceDirName:"guides/onpremise/vminstance/passthrough",slug:"/guides/onpremise/vminstance/passthrough/vgpu",permalink:"/v3.10/docs/guides/onpremise/vminstance/passthrough/vgpu",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/guides/onpremise/vminstance/passthrough/vgpu.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"GPU \u900f\u4f20",permalink:"/v3.10/docs/guides/onpremise/vminstance/passthrough/gpu"},next:{title:"\u7f51\u5361SR-IOV",permalink:"/v3.10/docs/guides/onpremise/vminstance/passthrough/sriov"}},c={},o=[{value:"AMD vGPU \u914d\u7f6e",id:"amd-vgpu-\u914d\u7f6e",level:2},{value:"NVIDIA vGPU \u914d\u7f6e",id:"nvidia-vgpu-\u914d\u7f6e",level:2},{value:"NVIDIA vGPU \u865a\u673a\u914d\u7f6e",id:"nvidia-vgpu-\u865a\u673a\u914d\u7f6e",level:3},{value:"\u53c2\u8003\u8fde\u63a5",id:"\u53c2\u8003\u8fde\u63a5",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"vgpu",children:"vGPU"}),"\n",(0,a.jsx)(n.p,{children:"vGPU\u662f\u4e00\u79cdGPU\u865a\u62df\u5316\u6280\u672f,\u5b83\u53ef\u4ee5\u5c06\u5355\u4e2a\u7269\u7406GPU\u865a\u62df\u5316\u4e3a\u591a\u4e2a\u865a\u62dfGPU\u5b9e\u4f8b,\u4ee5\u4f9b\u591a\u4e2a\u865a\u62df\u673a\u540c\u65f6\u4f7f\u7528\u3002"}),"\n",(0,a.jsx)(n.p,{children:"NVIDIA \u548c AMD \u90fd\u63d0\u4f9b\u4e86\u865a\u62df GPU\uff08vgpu\uff09\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u4f46\u5b83\u4eec\u5728\u5b9e\u73b0\u65b9\u5f0f\u4e0a\u6709\u4e00\u4e9b\u4e0d\u540c\u4e4b\u5904\u3002"}),"\n",(0,a.jsx)(n.p,{children:"NVIDIA vGPU \u5b9e\u73b0\u65b9\u5f0f\uff1a"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"NVIDIA vGPU \u662f\u57fa\u4e8e NVIDIA \u7684 GRID \u6280\u672f\u5b9e\u73b0\u7684\uff0c\u5b83\u4f7f\u7528 NVIDIA \u7684\u7269\u7406 GPU \u5e76\u5c06\u5176\u5212\u5206\u4e3a\u591a\u4e2a\u865a\u62df GPU\uff0c\u6bcf\u4e2a\u865a\u62df GPU \u90fd\u53ef\u4ee5\u88ab\u5206\u914d\u7ed9\u4e00\u4e2a\u72ec\u7acb\u7684\u865a\u62df\u673a\u5b9e\u4f8b\u3002"}),"\n",(0,a.jsx)(n.li,{children:"NVIDIA vGPU \u4f7f\u7528\u4e13\u6709\u7684\u865a\u62df GPU \u7ba1\u7406\u8f6f\u4ef6\uff08\u5982NVIDIA Virtual GPU Manager\uff09\uff0c\u8be5\u8f6f\u4ef6\u5728\u7269\u7406 GPU \u4e0a\u521b\u5efa\u548c\u7ba1\u7406\u865a\u62df GPU\uff0c\u5e76\u5206\u914d\u7ed9\u865a\u62df\u673a\u4f7f\u7528\u3002"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"AMD vGPU \u5b9e\u73b0\u65b9\u5f0f\uff1a"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"AMD vGPU \u662f\u57fa\u4e8e AMD \u7684 SR-IOV\uff08Single Root I/O Virtualization\uff09\u6280\u672f\u5b9e\u73b0\u7684\uff0c\u5b83\u901a\u8fc7\u786c\u4ef6\u8f85\u52a9\u865a\u62df\u5316\u6280\u672f\u5c06\u7269\u7406 GPU \u5206\u5272\u4e3a\u591a\u4e2a\u865a\u62df GPU\u3002"}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"amd-vgpu-\u914d\u7f6e",children:"AMD vGPU \u914d\u7f6e"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# \u67e5\u770b AMD GPU \u8bbe\u5907PCI\u914d\u7f6e\u7a7a\u95f4\uff0c\u786e\u8ba4\u6253\u5f00 SR-IOV\n$ lspci -k -s 04:00.0 -v\n04:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Tonga XT GL [FirePro S7150] (prog-if 00 [VGA controller])\n        Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] Device 030c\n        Flags: bus master, fast devsel, latency 0, IRQ 209, NUMA node 0\n        Memory at 3bfe0000000 (64-bit, prefetchable) [size=256M]\n        Memory at 3bff4000000 (64-bit, prefetchable) [size=2M]\n        I/O ports at 2000 [size=256]\n        Memory at 95c00000 (32-bit, non-prefetchable) [size=256K]\n        Expansion ROM at 95c40000 [disabled] [size=128K]\n        Capabilities: [48] Vendor Specific Information: Len=08 <?>\n        Capabilities: [50] Power Management version 3\n        Capabilities: [58] Express Legacy Endpoint, MSI 00\n        Capabilities: [a0] MSI: Enable+ Count=1/4 Maskable+ 64bit+\n        Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 <?>\n        Capabilities: [150] Advanced Error Reporting\n        Capabilities: [200] #15\n        Capabilities: [270] #19\n        Capabilities: [2b0] Address Translation Service (ATS)\n        Capabilities: [2c0] Page Request Interface (PRI)\n        Capabilities: [2d0] Process Address Space ID (PASID)\n        Capabilities: [328] Alternative Routing-ID Interpretation (ARI)\n        Capabilities: [330] Single Root I/O Virtualization (SR-IOV) ### \u6253\u5f00\u4e86 SR-IOV\n        Capabilities: [400] Vendor Specific Information: ID=0002 Rev=1 Len=070 <?>\n        Kernel modules: amdgpu\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5bbf\u4e3b\u673a\u4e0aAMD vGPU\u9700\u8981\u5b89\u88c5 GIM \u9a71\u52a8\uff0c\u53c2\u8003\uff1a ",(0,a.jsx)(n.a,{href:"https://github.com/GPUOpen-LibrariesAndSDKs/MxGPU-Virtualization#how-to-load",children:"https://github.com/GPUOpen-LibrariesAndSDKs/MxGPU-Virtualization#how-to-load"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ git clone https://github.com/GPUOpen-LibrariesAndSDKs/MxGPU-Virtualization.git && cd MxGPU-Virtualization/drv\n$ make && make install\n\n# \u4fee\u6539\u9a71\u52a8\u7981\u7528 amdgpu \u9a71\u52a8\n$ vi /etc/modprobe.d/blacklist.conf\nblacklist amdgpu\nblacklist amdkfd\n\n# \u914d\u7f6e VF \u6570\u91cf\n$ cat /etc/gim_config\nfb_option=0\nsched_option=0\nvf_num=2 # vf \u6570\u91cf\npf_fb=0\nvf_fb=0\nsched_interval=0\nsched_interval_us=0\nfb_clear=0\n$ modprobe gim\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u4fee\u6539 /etc/yunion/host.conf \u914d\u7f6e AMD vGPU\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ vi /etc/yunion/host.conf\nAMDVgpuPFs:\n- 04:00.0 # AMD GPU PCI \u5730\u5740\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u91cd\u542f host-agent \u670d\u52a1\u3002"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ kubectl -n onecloud rollout restart ds default-host\n"})}),"\n",(0,a.jsx)(n.h2,{id:"nvidia-vgpu-\u914d\u7f6e",children:"NVIDIA vGPU \u914d\u7f6e"}),"\n",(0,a.jsx)(n.p,{children:"NVIDIA \u9700\u8981\u5b89\u88c5 GRID \u9a71\u52a8(\u9a71\u52a8\u5728NVIDIA\u5b98\u7f51\u9700\u8981\u4f01\u4e1a\u6ce8\u518c\u624d\u80fd\u4e0b\u8f7d):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ ./NVIDIA-Linux-x86_64-510.85.03-vgpu-kvm.run\n\n# \u5b89\u88c5\u597d\u540e\u91cd\u542f\u670d\u52a1\u5668\n# \u67e5\u770b\u662f\u5426\u52a0\u8f7d nvidia vgpu \u9a71\u52a8\n# \u5185\u6838\u9700\u8981\u652f\u6301 vfio \u4e0e vfio-mdev\n$ lsmod | grep nvidia\nnvidia_vgpu_vfio       53248  19\nnvidia              39120896  273\nmdev                   24576  2 vfio_mdev,nvidia_vgpu_vfio\ndrm                   491520  4 drm_kms_helper,drm_vram_helper,nvidia,ttm\nvfio                   32768  7 vfio_mdev,nvidia_vgpu_vfio,vfio_iommu_type1,vfio_pci\n\n# \u67e5\u770b nvidia vgpu \u7ba1\u7406\u670d\u52a1\u72b6\u6001\n$ systemctl status nvidia-vgpu-mgr.service\n\n# \u914d\u7f6e vGPU\n# cd /sys/class/mdev_bus/domain\\:bus\\:slot.function/mdev_supported_types, eg:\n$ cd /sys/class/mdev_bus/0000:82:00.0/mdev_supported_types && ls\nnvidia-156  nvidia-241  nvidia-284  nvidia-286  nvidia-46  nvidia-48  nvidia-50  nvidia-52  nvidia-54  nvidia-56  nvidia-58  nvidia-60  nvidia-62\nnvidia-215  nvidia-283  nvidia-285  nvidia-287  nvidia-47  nvidia-49  nvidia-51  nvidia-53  nvidia-55  nvidia-57  nvidia-59  nvidia-61\n\n# \u8fd9\u4e9b\u76ee\u5f55\u4ee3\u8868\u4e0d\u540c\u7684 vGPU \u7c7b\u578b\uff0c\u67e5\u770b nvidia-46 \u8be6\u7ec6\u63cf\u8ff0\n$ ls nvidia-46\navailable_instances  create               description          device_api           devices/             name\n$ cat nvidia-46/description\nnum_heads=4, frl_config=60, framebuffer=1024M, max_resolution=5120x2880, max_instance=24\n$ cat nvidia-46/name\nGRID P40-1Q\n$ cat nvidia-46/available_instances\n22\n"})}),"\n",(0,a.jsx)(n.p,{children:"NVIDIA\u5b98\u7f51\u63cf\u8ff0\u5982\u4e0b\uff1a"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"available_instances\nThis file contains the number of instances of this vGPU type that can still be created. This file is updated any time a vGPU of this type is created on or removed from the physical GPU."}),"\n",(0,a.jsx)(n.li,{children:"create\nThis file is used for creating a vGPU instance. A vGPU instance is created by writing the UUID of the vGPU to this file. The file is write only."}),"\n",(0,a.jsx)(n.li,{children:"description\nThis file contains the following details of the vGPU type:\nThe maximum number of virtual display heads that the vGPU type supports\nThe frame rate limiter (FRL) configuration in frames per second\nThe frame buffer size in Mbytes\nThe maximum resolution per display head\nThe maximum number of vGPU instances per physical GPU\nFor example:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ cat description\nnum_heads=4, frl_config=60, framebuffer=2048M, max_resolution=4096x2160, max_instance=4\n- device_api\nThis file contains the string vfio_pci to indicate that a vGPU is a PCI device.\n- devices\nThis directory contains all the mdev devices that are created for the vGPU type. For example:\n$ ll devices\ntotal 0\nlrwxrwxrwx 1 root root 0 Dec  6 01:52 aa618089-8b16-4d01-a136-25a0f3c73123 -> ../../../aa618089-8b16-4d01-a136-25a0f3c73123\n- name\nThis file contains the name of the vGPU type. For example:\n$ cat name\nGRID M10-2Q\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u914d\u7f6e vGPU\uff0ceg:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# \u751f\u6210 uuid \u683c\u5f0f\u7684\u5b57\u7b26\u4e32\u7528\u4e8e\u914d\u7f6e vGPU id\n$ uuidgen\n070bcb42-18fc-4971-9aa9-67f5ee1281c3\n$ echo 070bcb42-18fc-4971-9aa9-67f5ee1281c3 > nvidia-46/create\n# \u5982\u679c\u9700\u8981\u6301\u4e45\u5316\u7684\u8bdd\u9700\u8981\u914d\u7f6e\u5230 /etc/rc.local \u4e2d\uff1a\necho "echo 070bcb42-18fc-4971-9aa9-67f5ee1281c3 > /sys/class/mdev_bus/0000:82:00.0/mdev_supported_types/nvidia-46/create" >> /etc/rc.local\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u914d\u7f6e /etc/yunion/host.conf"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"nvidia_vgpu_pfs:\n- 82:00.0\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u91cd\u542f host-agent \u670d\u52a1"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ kubectl -n onecloud rollout restart ds default-host\n"})}),"\n",(0,a.jsx)(n.h3,{id:"nvidia-vgpu-\u865a\u673a\u914d\u7f6e",children:"NVIDIA vGPU \u865a\u673a\u914d\u7f6e"}),"\n",(0,a.jsx)(n.p,{children:"\u865a\u673a\u5185\u5b89\u88c5 GIRD \u9a71\u52a8"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'\u7981\u7528 nouveau \u9a71\u52a8\n$ cat /etc/modprobe.d/blacklist-nouveau.conf\nblacklist nouveau\noptions nouveau modeset=0\n$ ./NVIDIA-Linux-x86_64-510.85.02-grid.run\n# \u67e5\u770b nvidia-gridd \u670d\u52a1\u72b6\u6001\n$ systemctl status nvidia-gridd \n# \u914d\u7f6e license server \u5730\u5740\n$ cp /etc/nvidia/gridd.conf.template /etc/nvidia/gridd.conf\n$ vi /etc/nvidia/gridd.conf # \u6309\u9700\u914d\u7f6e\n# Description: Set License Server Address\n# Data type: string\n# Format:  "<address>"\nServerAddress= example.com # license server \u5730\u5740\n\n# Description: Set License Server port number\n# Data type: integer\n# Format:  <port>, default is 7070\nServerPort=7070 # license server \u7aef\u53e3\n\n# Description: Set Feature to be enabled\n# Data type: integer\n# Possible values:\n#    0 => for unlicensed state\n#    1 => for NVIDIA vGPU (Optional, autodetected as per vGPU type)\n#    2 => for NVIDIA RTX Virtual Workstation\n#    4 => for NVIDIA Virtual Compute Server\n# All other values reserved\nFeatureType=1 # \n\n$ systemctl restart nvidia-gridd\n$ nvidia-smi -q\n    vGPU Software Licensed Product\n        Product Name                      : NVIDIA RTX Virtual Workstation\n        License Status                    : Licensed (Expiry: 2023-8-14 13:47:59 GMT) # license \u72b6\u6001\u4e3a licensed\n'})}),"\n",(0,a.jsx)(n.h2,{id:"\u53c2\u8003\u8fde\u63a5",children:"\u53c2\u8003\u8fde\u63a5"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/GPUOpen-LibrariesAndSDKs/MxGPU-Virtualization#how-to-load",children:"https://github.com/GPUOpen-LibrariesAndSDKs/MxGPU-Virtualization#how-to-load"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://docs.nvidia.com/grid/latest/grid-vgpu-user-guide/index.html#creating-vgpu-device-red-hat-el-kvm",children:"https://docs.nvidia.com/grid/latest/grid-vgpu-user-guide/index.html#creating-vgpu-device-red-hat-el-kvm"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://cloud-atlas.readthedocs.io/zh_CN/latest/kvm/vgpu/vgpu_quickstart.html",children:"https://cloud-atlas.readthedocs.io/zh_CN/latest/kvm/vgpu/vgpu_quickstart.html"})}),"\n"]})]})}function v(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},11151:(e,n,i)=>{i.d(n,{Z:()=>d,a:()=>r});var a=i(67294);const s={},t=a.createContext(s);function r(e){const n=a.useContext(t);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),a.createElement(t.Provider,{value:n},e.children)}}}]);