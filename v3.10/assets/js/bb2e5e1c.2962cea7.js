"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[924],{9066:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>r});var t=i(85893),o=i(11151);const s={sidebar_position:3},l="\u7f51\u5361SR-IOV",c={id:"guides/onpremise/vminstance/passthrough/sriov",title:"\u7f51\u5361SR-IOV",description:"\u4ecb\u7ecd SR-IOV \u7f51\u5361\u900f\u4f20\u4e0e OVS Offload \u786c\u4ef6\u5378\u8f7d\u4f7f\u7528\u65b9\u5f0f\u3002",source:"@site/docs/guides/onpremise/vminstance/passthrough/sriov.md",sourceDirName:"guides/onpremise/vminstance/passthrough",slug:"/guides/onpremise/vminstance/passthrough/sriov",permalink:"/v3.10/docs/guides/onpremise/vminstance/passthrough/sriov",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/guides/onpremise/vminstance/passthrough/sriov.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"vGPU",permalink:"/v3.10/docs/guides/onpremise/vminstance/passthrough/vgpu"},next:{title:"\u81ea\u5b9a\u4e49PCI\u8bbe\u5907\u900f\u4f20",permalink:"/v3.10/docs/guides/onpremise/vminstance/passthrough/custom-pci-devices"}},a={},r=[{value:"SR-IOV \u4ecb\u7ecd",id:"sr-iov-\u4ecb\u7ecd",level:2},{value:"\u5bbf\u4e3b\u673a\u5f00\u542f SR-IOV",id:"\u5bbf\u4e3b\u673a\u5f00\u542f-sr-iov",level:3},{value:"Mellanox \u7f51\u5361\u914d\u7f6e",id:"mellanox-\u7f51\u5361\u914d\u7f6e",level:4},{value:"host-agent \u542f\u7528 SR-IOV",id:"host-agent-\u542f\u7528-sr-iov",level:3},{value:"OVS Offload",id:"ovs-offload",level:2},{value:"\u5b89\u88c5 OFED\u9a71\u52a8\uff0c\u914d\u7f6e SRIOV VF",id:"\u5b89\u88c5-ofed\u9a71\u52a8\u914d\u7f6e-sriov-vf",level:3},{value:"host-agent \u542f\u7528 SR-IOV",id:"host-agent-\u542f\u7528-sr-iov-1",level:3},{value:"Mellanox CX6 \u4ee5\u4e0b(CX5/CX4) \u5173\u95ed\u5b89\u5168\u7ec4",id:"mellanox-cx6-\u4ee5\u4e0bcx5cx4-\u5173\u95ed\u5b89\u5168\u7ec4",level:4},{value:"\u914d\u7f6e host.conf",id:"\u914d\u7f6e-hostconf",level:3},{value:"offload \u7f51\u5361\u914d\u7f6e bond",id:"offload-\u7f51\u5361\u914d\u7f6e-bond",level:3},{value:"\u865a\u62df\u673a\u914d\u7f6e",id:"\u865a\u62df\u673a\u914d\u7f6e",level:2},{value:"\u5e38\u89c1\u95ee\u9898",id:"\u5e38\u89c1\u95ee\u9898",level:2},{value:"\u5982\u4f55\u9a8c\u8bc1\u4e00\u4e2aPCI\u8bbe\u5907\u652f\u6301SR-IOV\uff1f",id:"\u5982\u4f55\u9a8c\u8bc1\u4e00\u4e2apci\u8bbe\u5907\u652f\u6301sr-iov",level:4},{value:"\u5982\u4f55\u9a8c\u8bc1OVS Offload\u662f\u5426\u751f\u6548",id:"\u5982\u4f55\u9a8c\u8bc1ovs-offload\u662f\u5426\u751f\u6548",level:4}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.a)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.h1,{id:"\u7f51\u5361sr-iov",children:"\u7f51\u5361SR-IOV"}),"\n",(0,t.jsx)(e.p,{children:"\u4ecb\u7ecd SR-IOV \u7f51\u5361\u900f\u4f20\u4e0e OVS Offload \u786c\u4ef6\u5378\u8f7d\u4f7f\u7528\u65b9\u5f0f\u3002"}),"\n",(0,t.jsx)(e.h2,{id:"sr-iov-\u4ecb\u7ecd",children:"SR-IOV \u4ecb\u7ecd"}),"\n",(0,t.jsx)(e.p,{children:"SR-IOV \u6280\u672f\u662f\u4e00\u79cd\u57fa\u4e8e\u786c\u4ef6\u7684\u865a\u62df\u5316\u89e3\u51b3\u65b9\u6848\uff0c\u53ef\u63d0\u9ad8\u6027\u80fd\u548c\u53ef\u4f38\u7f29\u6027\u3002SR-IOV \u6807\u51c6\u5141\u8bb8\u5728\u865a\u62df\u673a\u4e4b\u95f4\u9ad8\u6548\u5171\u4eab PCIe\uff08Peripheral Component Interconnect Express\uff0c\u5feb\u901f\u5916\u8bbe\u7ec4\u4ef6\u4e92\u8fde\uff09\u8bbe\u5907\uff0c\u5e76\u4e14\u5b83\u662f\u5728\u786c\u4ef6\u4e2d\u5b9e\u73b0\u7684\uff0c\u53ef\u4ee5\u83b7\u5f97\u80fd\u591f\u4e0e\u672c\u673a\u6027\u80fd\u5ab2\u7f8e\u7684 I/O \u6027\u80fd\u3002SR-IOV \u89c4\u8303\u5b9a\u4e49\u4e86\u65b0\u7684\u6807\u51c6\uff0c\u6839\u636e\u8be5\u6807\u51c6\uff0c\u521b\u5efa\u7684\u65b0\u8bbe\u5907\u53ef\u5141\u8bb8\u5c06\u865a\u62df\u673a\u76f4\u63a5\u8fde\u63a5\u5230 I/O \u8bbe\u5907\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["SR-IOV \u89c4\u8303\u7531 PCI-SIG \u5728 ",(0,t.jsx)(e.a,{href:"http://www.pcisig.com",children:"http://www.pcisig.com"})," \u4e0a\u8fdb\u884c\u5b9a\u4e49\u548c\u7ef4\u62a4\u3002"]}),"\n",(0,t.jsx)(e.p,{children:"SR-IOV \u4e2d\u7684\u4e24\u79cd\u65b0\u529f\u80fd\u7c7b\u578b\u662f\uff1a"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u7269\u7406\u529f\u80fd (Physical Function, PF)\n\u7528\u4e8e\u652f\u6301 SR-IOV \u529f\u80fd\u7684 PCI \u529f\u80fd\uff0c\u5982 SR-IOV \u89c4\u8303\u4e2d\u5b9a\u4e49\u3002PF \u5305\u542b SR-IOV \u529f\u80fd\u7ed3\u6784\uff0c\u7528\u4e8e\u7ba1\u7406 SR-IOV \u529f\u80fd\u3002PF \u662f\u5168\u529f\u80fd\u7684 PCIe \u529f\u80fd\uff0c\u53ef\u4ee5\u50cf\u5176\u4ed6\u4efb\u4f55 PCIe \u8bbe\u5907\u4e00\u6837\u8fdb\u884c\u53d1\u73b0\u3001\u7ba1\u7406\u548c\u5904\u7406\u3002PF \u62e5\u6709\u5b8c\u5168\u914d\u7f6e\u8d44\u6e90\uff0c\u53ef\u4ee5\u7528\u4e8e\u914d\u7f6e\u6216\u63a7\u5236 PCIe \u8bbe\u5907\u3002"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u865a\u62df\u529f\u80fd (Virtual Function, VF)\n\u4e0e\u7269\u7406\u529f\u80fd\u5173\u8054\u7684\u4e00\u79cd\u529f\u80fd\u3002VF \u662f\u4e00\u79cd\u8f7b\u91cf\u7ea7 PCIe \u529f\u80fd\uff0c\u53ef\u4ee5\u4e0e\u7269\u7406\u529f\u80fd\u4ee5\u53ca\u4e0e\u540c\u4e00\u7269\u7406\u529f\u80fd\u5173\u8054\u7684\u5176\u4ed6 VF \u5171\u4eab\u4e00\u4e2a\u6216\u591a\u4e2a\u7269\u7406\u8d44\u6e90\u3002VF \u4ec5\u5141\u8bb8\u62e5\u6709\u7528\u4e8e\u5176\u81ea\u8eab\u884c\u4e3a\u7684\u914d\u7f6e\u8d44\u6e90\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u5bbf\u4e3b\u673a\u5f00\u542f-sr-iov",children:"\u5bbf\u4e3b\u673a\u5f00\u542f SR-IOV"}),"\n",(0,t.jsx)(e.p,{children:"\u9664\u4e86\u5e38\u89c4\u7684PCI/PCIe\u8bbe\u5907\u900f\u4f20\u8bbe\u7f6e\u5916\uff0c\u8fd8\u9700\u786e\u4fddSR-IOV\u5728\u5bbf\u4e3b\u673aBIOS\u542f\u7528\uff0c\u5e76\u4e14\u9700\u8981\u5bf9\u8bbe\u5907\u7684VF\u8fdb\u884c\u5fc5\u8981\u7684\u5185\u6838\u8bbe\u7f6e\uff0c\u5177\u4f53\u65b9\u6cd5\u5982\u4e0b\uff1a"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"BIOS \u4e2d\u6253\u5f00\u8bbe\u5907 SR-IOV \u529f\u80fd(\u6839\u636e\u673a\u578b\u548c\u8bbe\u5907\u7684\u578b\u53f7\u4e0d\u540c\uff0c\u5177\u4f53\u64cd\u4f5c\u65b9\u5f0f\u4e5f\u53ef\u80fd\u4e0d\u4e00\u6837\uff0c\u5177\u4f53\u53c2\u8003\u5b9e\u9645\u673a\u578b\u914d\u7f6e)\u3002"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u5728\u5bbf\u4e3b\u673a\u8282\u70b9\u4e0a\u6253\u5f00 Virtual Functions"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'# \u5bf9\u4e8e\u4e0d\u540c\u7684\u7f51\u5361\u578b\u53f7\u6253\u5f00\u7684\u65b9\u5f0f\u4e5f\u4e0d\u4e00\u6837\uff0c\u4e0b\u9762\u4ee5 Intel I350 \u7f51\u5361\u4e3a\u4f8b\uff0c\u8bbe\u7f6e 7 \u4e2a Virtual Function(\u7f51\u5361\u652f\u6301\u7684 virtual function \u6570\u91cf\u4e5f\u662f\u4e0d\u4e00\u6837\u7684\uff0c\u9700\u8981\u6839\u636e\u5177\u4f53\u7f51\u5361\u652f\u6301\u7684\u6570\u91cf\u6765\u914d\u7f6e)\n# \u5728 grub cmdline \u4e2d\u52a0\u4e0a igb.max_vfs=7\nGRUB_CMDLINE_LINUX="...... igb.max_vfs=7"\n# \u91cd\u65b0\u751f\u6210 grub \u5f15\u5bfc\u914d\u7f6e\u6587\u4ef6\n$ grub2-mkconfig -o /boot/grub2/grub.cfg\n'})}),"\n",(0,t.jsx)(e.h4,{id:"mellanox-\u7f51\u5361\u914d\u7f6e",children:"Mellanox \u7f51\u5361\u914d\u7f6e"}),"\n",(0,t.jsx)(e.p,{children:"Mellanox \u7f51\u5361\u9700\u8981\u5b89\u88c5 MLNX_OFED \u9a71\u52a8\uff0c\u53c2\u8003\u5176\u5b98\u65b9\u6587\u6863\uff1a"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://enterprise-support.nvidia.com/s/article/howto-install-mlnx-ofed-driver",children:"https://enterprise-support.nvidia.com/s/article/howto-install-mlnx-ofed-driver"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://docs.nvidia.com/networking/display/MLNXOFEDv461000/Installing+Mellanox+OFED",children:"https://docs.nvidia.com/networking/display/MLNXOFEDv461000/Installing+Mellanox+OFED"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/",children:"https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/"})}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# \u6ce8\u610f\u8981\u4f7f\u7528 gcc \u9ad8\u7248\u672c\n$ yum install centos-release-scl\n$ yum install -y devtoolset-9\n$ scl enable devtoolset-9 bash\n# \u4e0b\u8f7d\u5bf9\u5e94\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u7684 iso\uff0c\u6ce8\u610f\u533a\u5206 centos7.x\n# \u53ef\u5728 nvidia \u63d0\u4f9b\u7684\u9a71\u52a8\u7f51\u7ad9\u4e0a\u4e0b\u8f7d: https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/\n# \u53ef\u5728 nvidia \u63d0\u4f9b\u7684\u9a71\u52a8\u7f51\u7ad9\u4e0a\u4e0b\u8f7d: https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/\n$ wget https://content.mellanox.com/ofed/MLNX_OFED-5.8-1.1.2.1/MLNX_OFED_LINUX-5.8-1.1.2.1-rhel7.9-x86_64.iso\n$ mount -o loop MLNX_OFED_LINUX-5.8-1.1.2.1-rhel7.9-x86_64.iso /mnt\n$ cd /mnt\n# \u7b49\u5f85\u7f16\u8bd1\n$ ./mlnxofedinstall --add-kernel-support\nRestart needed for updates to take effect.\nLog File: /tmp/ZXf5cnZzxo\nReal log file: /tmp/MLNX_OFED_LINUX.62574.logs/fw_update.log\nYou may need to update your initramfs before next boot. To do that, run:\n \n   dracut -f\nTo load the new driver, run:\n/etc/init.d/openibd restart\n \n$ dracut -f\n$ /etc/init.d/openibd restart\n\n$ mst start\n# \u914d\u7f6eSRIOV VF\u6570\u91cf, \u91cd\u542f\u751f\u6548, \u5177\u4f53\u8bbe\u5907\u540d\u79f0\u67e5\u770b mst status -v\n$ mlxconfig -d /dev/mst/mt4119_pciconf0 set SRIOV_EN=1 NUM_OF_VFS=64\n$ reboot\n"})}),"\n",(0,t.jsxs)(e.ol,{start:"5",children:["\n",(0,t.jsx)(e.li,{children:"\u8bbe\u7f6e\u597d\u540e\u91cd\u542f\u5bbf\u4e3b\u673a\uff0c\u67e5\u770b /proc/cmdline \u786e\u8ba4\u914d\u7f6e\u751f\u6548\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"host-agent-\u542f\u7528-sr-iov",children:"host-agent \u542f\u7528 SR-IOV"}),"\n",(0,t.jsx)(e.p,{children:"\u767b\u9646\u5230\u5bf9\u5e94\u7684\u5bbf\u4e3b\u673a\u8282\u70b9"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# SR-IOV \u9ed8\u8ba4\u662f\u4e0d\u542f\u7528\u7684\uff0c\u9700\u8981\u4fee\u6539 host-agent \u914d\u7f6e\n# \u914d\u7f6e SR-IOV \u5bf9\u5e94\u7684\u7f51\u7edc eg:\n$ vi /etc/yunion/host.conf\nnetworks:\n- eth1/br0/192.168.100.111\n- eth2/br1/bcast0\n# networks\u5305\u542b\u4e86\u4e24\u79cd\u914d\u7f6e\u65b9\u5f0f\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u7269\u7406\u7f51\u5361\u540d\u79f0\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f\u7f51\u6865\u540d\u79f0\uff0c\n# \u7b2c\u4e09\u4e2a\u53c2\u6570\u6709\u4e24\u79cd\uff0c\u4e00\u79cd\u662f ip \u5730\u5740\uff0c\u53e6\u5916\u4e00\u79cd\u662f wire\uff0c\u5bf9\u4e8e\u4e0d\u60f3\u914d\u7f6e ip\u5730\u5740\u7684\u7f51\u5361\u53ef\u4ee5\u4f7f\u7528 wire \u5c5e\u6027\uff0cwire \u4ee3\u8868\u7684\u662f\u8fd9\u4e2a\u7f51\u5361\u6240\u5728\u7684\u4e8c\u5c42\u7f51\u7edc\u3002\nsriov_nics:\n- eth2\n# \u4e3a eth2 \u7f51\u5361\u6253\u5f00 sriov\n\n"})}),"\n",(0,t.jsxs)(e.p,{children:["\u4fee\u6539\u5b8c\u6210\u540e\u91cd\u542f host-agent \u670d\u52a1: ",(0,t.jsx)(e.code,{children:"kubectl rollout restart ds default-host"}),", \u91cd\u542f\u5b8c\u6210\u7b49\u5f85 host-agent \u670d\u52a1\u542f\u52a8\u6210\u529f\u540e\u53ef\u4ee5\u5728\u63a7\u5236\u8282\u70b9\u4f7f\u7528 climc \u67e5\u770b\u914d\u7f6e\u7684 VF \u7f51\u5361."]}),"\n",(0,t.jsx)(e.p,{children:"e.g.:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# \u4f8b\u5982 I350 Ethernet Controller Virtual Function \u5c31\u662f\u6211\u4eec\u672c\u6b21\u914d\u7f6e\u7684 VF \u7f51\u5361\u3002\n$ climc isolated-device-list\n+--------------------------------------+----------+-------------------------------------------+---------+------------------+--------------------------------------+--------------------------------------+\n|                  ID                  | Dev_type |                   Model                   |  Addr   | Vendor_device_id |               Host_id                |               Guest_id               |\n+--------------------------------------+----------+-------------------------------------------+---------+------------------+--------------------------------------+--------------------------------------+\n| 37b2fe7b-f202-428e-8c34-35ccdac82852 | NIC      | ConnectX-5 Virtual Function               | 0a:01.1 | 15b3:1018        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| 9a0f2b3a-b372-4e37-840f-60427d026479 | NIC      | ConnectX-5 Virtual Function               | 0a:01.0 | 15b3:1018        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| 37b54017-4da3-44a6-8ffe-056ffc9e853b | NIC      | ConnectX-5 Virtual Function               | 0a:00.7 | 15b3:1018        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| 74558948-f5e9-453b-86d6-89c6bc00c710 | NIC      | ConnectX-5 Virtual Function               | 0a:00.6 | 15b3:1018        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| 75df24b3-c27a-49bb-8cf7-385c9f0d2385 | NIC      | ConnectX-5 Virtual Function               | 0a:00.5 | 15b3:1018        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| 17841618-c3e7-43f6-805a-23d2adbcd70c | NIC      | ConnectX-5 Virtual Function               | 0a:00.4 | 15b3:1018        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| 51627e5a-22af-40ee-8af5-dc1971bf89c9 | NIC      | ConnectX-5 Virtual Function               | 0a:00.3 | 15b3:1018        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| f794eba5-fbe7-4bcd-880a-4082523f5c94 | NIC      | ConnectX-5 Virtual Function               | 0a:00.2 | 15b3:1018        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| 10266e05-8d34-4594-81ca-64afbd365ee7 | NIC      | I350 Ethernet Controller Virtual Function | 03:13.0 | 8086:1520        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| a837b5ca-d3ee-4cd8-8de5-447b3ab274d0 | NIC      | I350 Ethernet Controller Virtual Function | 03:12.4 | 8086:1520        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| fab303c9-5dbb-4b85-8df9-fada299622f4 | NIC      | I350 Ethernet Controller Virtual Function | 03:12.0 | 8086:1520        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| f2cb8fd5-aa26-46a7-8dc2-2eca2b77a887 | NIC      | I350 Ethernet Controller Virtual Function | 03:11.4 | 8086:1520        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| b2933d5c-9a3a-45ff-8c80-15ac3291f5c9 | NIC      | I350 Ethernet Controller Virtual Function | 03:11.0 | 8086:1520        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| b22e6511-c70b-440c-8c05-6d1041ae7661 | NIC      | I350 Ethernet Controller Virtual Function | 03:10.4 | 8086:1520        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n| f523f12a-82bf-45a3-80cf-94d5a9649665 | NIC      | I350 Ethernet Controller Virtual Function | 03:10.0 | 8086:1520        | c48b1b8b-28a3-453a-863f-ddf7c62bcfe2 |                                      |\n+--------------------------------------+----------+-------------------------------------------+---------+------------------+--------------------------------------+--------------------------------------+\n***  Total: 24 Pages: 2 Limit: 15 Offset: 0 Page: 1  ***\n\n# \u4f7f\u7528 VF \u7f51\u5361\u521b\u5efa\u865a\u673a\uff0cnetdesc\u4e2d\u53ef\u4ee5\u6307\u5b9a sriov-nic-model \u6216\u8005\u6307\u5b9a sriov-nic-id\n$ climc server-create --disk ae0de3e9-dd45-458e-83b2-4dbc48d70234 \\\n                      --net 'sriov-nic-model=I350 Ethernet Controller Virtual Function' \\\n                      --ncpu 2 --mem-spec 4G wyq-test-sriov-nic --auto-start\n\n# \u6302\u8f7d VF \u7f51\u5361\n$ climc server-attach-network c15a5a99-75ea-4b8c-8c7a-521e5f980db4 \\\n                              'sriov-nic-model=I350 Ethernet Controller Virtual Function:8056e77e-dc14-44b5-8ef9-e43aff344c0d'\n\n"})}),"\n",(0,t.jsx)(e.h2,{id:"ovs-offload",children:"OVS Offload"}),"\n",(0,t.jsx)(e.p,{children:"OVS Offload \u662f\u90e8\u5206\u5382\u5546\u57fa\u4e8e SR-IOV \u5b9e\u73b0\u7684\u4e00\u79cdOpenvSwitch\u6570\u636e\u8f6c\u53d1\u786c\u4ef6\u5378\u8f7d\u7684\u6280\u672f\uff1b\u5982\u679c\u786c\u4ef6\u652f\u6301 OVS Offload, \u5219\u80fd\u591f\u8ba9 OVS \u6570\u636e\u9762\u5378\u8f7d\u5230\u7f51\u5361\u4e0a\uff0cOVS \u63a7\u5236\u9762\u4e0d\u7528\u505a\u4efb\u4f55\u66f4\u6539\u3002"}),"\n",(0,t.jsx)(e.p,{children:"OVS Offload \u7684\u57fa\u7840\u914d\u7f6e\u4f9d\u8d56\u4e8e SR-IOV \u7684\u914d\u7f6e\uff0c\u786e\u4fdd\u5bbf\u4e3b\u673a\u5df2\u7ecf\u6253\u5f00\u4e86 SR-IOV\u3002\u7136\u540e\u9700\u8981\u5b89\u88c5\u5f00\u542f OVS Offload \u5fc5\u8981\u7684\u4f9d\u8d56\uff0c\u5982 Mellanox \u7f51\u5361\u9700\u8981\u5b89\u88c5 MLNX_OFED \u9a71\u52a8\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u76ee\u524d\uff0cMellanox\u7684Connext-6\u7cfb\u5217\u7f51\u5361\u652f\u6301OVS Offload\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"\u5b89\u88c5-ofed\u9a71\u52a8\u914d\u7f6e-sriov-vf",children:"\u5b89\u88c5 OFED\u9a71\u52a8\uff0c\u914d\u7f6e SRIOV VF"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"# \u6ce8\u610f\u8981\u4f7f\u7528 gcc \u9ad8\u7248\u672c\n$ yum install centos-release-scl\n$ yum install -y devtoolset-9\n$ scl enable devtoolset-9 bash\n# \u4e0b\u8f7d\u5bf9\u5e94\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u7684 iso\uff0c\u6ce8\u610f\u533a\u5206 centos7.x\n# \u53ef\u5728 nvidia \u63d0\u4f9b\u7684\u9a71\u52a8\u7f51\u7ad9\u4e0a\u4e0b\u8f7d: https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/\n$ wget https://content.mellanox.com/ofed/MLNX_OFED-5.8-1.1.2.1/MLNX_OFED_LINUX-5.8-1.1.2.1-rhel7.9-x86_64.iso\n$ mount -o loop MLNX_OFED_LINUX-5.8-1.1.2.1-rhel7.9-x86_64.iso /mnt\n$ cd /mnt\n# \u7b49\u5f85\u7f16\u8bd1\n$ ./mlnxofedinstall --add-kernel-support\nRestart needed for updates to take effect.\nLog File: /tmp/ZXf5cnZzxo\nReal log file: /tmp/MLNX_OFED_LINUX.62574.logs/fw_update.log\nYou may need to update your initramfs before next boot. To do that, run:\n \n   dracut -f\nTo load the new driver, run:\n/etc/init.d/openibd restart\n \n$ dracut -f\n$ /etc/init.d/openibd restart\n\n$ mst start\n# \u914d\u7f6eSRIOV VF\u6570\u91cf, \u91cd\u542f\u751f\u6548, \u5177\u4f53\u8bbe\u5907\u540d\u79f0\u67e5\u770b mst status -v\n$ mlxconfig -d /dev/mst/mt4119_pciconf0 set SRIOV_EN=1 NUM_OF_VFS=64\n$ reboot\n"})}),"\n",(0,t.jsx)(e.p,{children:"Mellanox \u7f51\u5361\u5b89\u88c5 MLNX_OFED \u9a71\u52a8\u53c2\u8003\uff1a"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://enterprise-support.nvidia.com/s/article/howto-install-mlnx-ofed-driver",children:"https://enterprise-support.nvidia.com/s/article/howto-install-mlnx-ofed-driver"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://docs.nvidia.com/networking/display/MLNXOFEDv461000/Installing+Mellanox+OFED",children:"https://docs.nvidia.com/networking/display/MLNXOFEDv461000/Installing+Mellanox+OFED"})}),"\n",(0,t.jsx)(e.li,{children:(0,t.jsx)(e.a,{href:"https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/",children:"https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/"})}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"Mellanox \u914d\u7f6e\u53c2\u8003\u6587\u6863\uff1a"}),"\n",(0,t.jsx)(e.p,{children:(0,t.jsx)(e.a,{href:"https://docs.nvidia.com/networking/display/MLNXOFEDv471001/OVS+Offload+Using+ASAP2+Direct#OVSOffloadUsingASAP2Direct-Overview",children:"https://docs.nvidia.com/networking/display/MLNXOFEDv471001/OVS+Offload+Using+ASAP2+Direct#OVSOffloadUsingASAP2Direct-Overview"})}),"\n",(0,t.jsx)(e.h3,{id:"host-agent-\u542f\u7528-sr-iov-1",children:"host-agent \u542f\u7528 SR-IOV"}),"\n",(0,t.jsx)(e.p,{children:"\u5b89\u88c5\u597d OFED\u9a71\u52a8\u540e\u914d\u7f6e\u5e73\u53f0\u542f\u7528 offload \u7f51\u5361"}),"\n",(0,t.jsx)(e.h4,{id:"mellanox-cx6-\u4ee5\u4e0bcx5cx4-\u5173\u95ed\u5b89\u5168\u7ec4",children:"Mellanox CX6 \u4ee5\u4e0b(CX5/CX4) \u5173\u95ed\u5b89\u5168\u7ec4"}),"\n",(0,t.jsx)(e.p,{children:"Mellanox CX6 \u4ee5\u4e0b ovs offload \u5bf9 connection tracking \u652f\u6301\u7684\u4e0d\u597d\uff0c\u6240\u4ee5\u9700\u8981\u5173\u95ed\u5b89\u5168\u7ec4\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"$ kubectl -n onecloud edit cm default-host\ndisable_security_group: true # \u6539\u4e3a true\n"})}),"\n",(0,t.jsx)(e.h3,{id:"\u914d\u7f6e-hostconf",children:"\u914d\u7f6e host.conf"}),"\n",(0,t.jsx)(e.p,{children:"\u767b\u9646\u5230\u5bf9\u5e94\u7684\u5bbf\u4e3b\u673a\u8282\u70b9"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# SR-IOV \u9ed8\u8ba4\u662f\u4e0d\u542f\u7528\u7684\uff0c\u9700\u8981\u4fee\u6539 host-agent \u914d\u7f6e\n# \u914d\u7f6e SR-IOV \u5bf9\u5e94\u7684\u7f51\u7edc eg:\n$ vi /etc/yunion/host.conf\nnetworks:\n- eth1/br0/192.168.100.111\n- eth2/br1/bcast0\n# networks\u5305\u542b\u4e86\u4e24\u79cd\u914d\u7f6e\u65b9\u5f0f\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u7269\u7406\u7f51\u5361\u540d\u79f0\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f\u7f51\u6865\u540d\u79f0\uff0c\n# \u7b2c\u4e09\u4e2a\u53c2\u6570\u6709\u4e24\u79cd\uff0c\u4e00\u79cd\u662f ip \u5730\u5740\uff0c\u53e6\u5916\u4e00\u79cd\u662f wire\uff0c\u5bf9\u4e8e\u4e0d\u60f3\u914d\u7f6e ip\u5730\u5740\u7684\u7f51\u5361\u53ef\u4ee5\u4f7f\u7528 wire \u5c5e\u6027\uff0cwire \u4ee3\u8868\u7684\u662f\u8fd9\u4e2a\u7f51\u5361\u6240\u5728\u7684\u4e8c\u5c42\u7f51\u7edc\u3002\novs_offload_nics:\n- eth2\n# \u4e3a eth2 \u7f51\u5361\u6253\u5f00 ovs offload\n"})}),"\n",(0,t.jsxs)(e.p,{children:["\u4fee\u6539\u5b8c\u6210\u540e\u91cd\u542f host-agent \u670d\u52a1: ",(0,t.jsx)(e.code,{children:"kubectl rollout restart ds default-host"}),",\u5728\u4f7f\u7528\u4e0a\u4e0e SR-IOV \u4e00\u81f4\u3002"]}),"\n",(0,t.jsx)(e.h3,{id:"offload-\u7f51\u5361\u914d\u7f6e-bond",children:"offload \u7f51\u5361\u914d\u7f6e bond"}),"\n",(0,t.jsx)(e.p,{children:"Mellanox \u7f51\u5361\u652f\u6301\u7684 bond \u6a21\u5f0f\u4e3a:"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Active-Backup (mode 1)"}),"\n",(0,t.jsx)(e.li,{children:"XOR           (mode 2)"}),"\n",(0,t.jsx)(e.li,{children:"LACP          (mode 4)"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u5728 offload \u6a21\u5f0f\u4e0b\uff0c\u6765\u81ea\u4e24\u4e2a PF \u7684\u6570\u636e\u5305\u53ef\u4ee5\u8f6c\u53d1\u5230\u4efb\u4f55\u4e00\u4e2aVF\uff0c\u6765\u81ea VF \u7684\u6d41\u91cf\u53ef\u4ee5\u6839\u636e bond \u72b6\u6001\u8f6c\u53d1\u5230\u4e24\u4e2a\u7aef\u53e3\u3002\n\u8fd9\u610f\u5473\u7740\uff0c\u5728 Active-Backup \u6a21\u5f0f\u4e0b\uff0c\u53ea\u8981\u6709\u4e00\u4e2a PF active\uff0c\u6765\u81ea\u4efb\u4f55 VF \u7684\u6d41\u91cf\u90fd\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a PF \u53d1\u9001\u3002\n\u5728 XOR \u6216 LACP \u6a21\u5f0f\u4e0b\uff0c\u5982\u679c\u4e24\u4e2a PF \u90fd active\uff0c\u6765\u81ea VF \u7684\u6d41\u91cf\u5c06\u5728\u8fd9\u4e24\u4e2a PF \u4e4b\u95f4\u5206\u914d\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u5177\u4f53Bond\u914d\u7f6e\u65b9\u6cd5\u8bf7\u53c2\u8003\u5176\u4ed6\u6587\u6863\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u7f51\u5361\u914d\u7f6e\u597d bond \u540e\u4fee\u6539 host.conf \u914d\u7f6e\u6587\u4ef6\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"$ vi /etc/yunion/host.conf\nnetworks:\n- bond0/br1/bcast0 # bond0 \u4e3abond\u53e3\u540d\u79f0\n......\novs_offload_nics:\n- bond0\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u865a\u62df\u673a\u914d\u7f6e",children:"\u865a\u62df\u673a\u914d\u7f6e"}),"\n",(0,t.jsx)(e.p,{children:"SR-IOV\u900f\u4f20\u5230\u865a\u62df\u673a\u540e\uff0c\u5bf9\u865a\u62df\u673a\u8868\u73b0\u4e3a\u540c\u578b\u53f7\u7684\u7269\u7406\u7f51\u5361\uff0c\u5bf9\u4e8eMellanox\u7684\u7f51\u5361\uff0c\u4e5f\u5efa\u8bae\u5b89\u88c5\u5b98\u65b9\u7684OFED\u9a71\u52a8\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{children:"$ wget https://content.mellanox.com/ofed/MLNX_OFED-5.8-1.1.2.1/MLNX_OFED_LINUX-5.8-1.1.2.1-rhel7.9-x86_64.iso\n$ mount -o loop MLNX_OFED_LINUX-5.8-1.1.2.1-rhel7.9-x86_64.iso /mnt\n$ cd /mnt\n$ ./mlnxofedinstall\n$ dracut -f\n$ /etc/init.d/openibd restart\n$ reboot\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u5e38\u89c1\u95ee\u9898",children:"\u5e38\u89c1\u95ee\u9898"}),"\n",(0,t.jsx)(e.h4,{id:"\u5982\u4f55\u9a8c\u8bc1\u4e00\u4e2apci\u8bbe\u5907\u652f\u6301sr-iov",children:"\u5982\u4f55\u9a8c\u8bc1\u4e00\u4e2aPCI\u8bbe\u5907\u652f\u6301SR-IOV\uff1f"}),"\n",(0,t.jsx)(e.p,{children:"\u6267\u884c\u547d\u4ee4\u5982\u4e0b\u547d\u4ee4\uff0c\u67e5\u770b\u8bbe\u5907\u7684 capabilities \u4e2d\u662f\u5426\u5305\u542b\u4e86 SR-IOV\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:"# lspci -v -s 01:00.0\n01:00.0 Ethernet controller: Mellanox Technologies MT2894 Family [ConnectX-6 Lx]\n\tSubsystem: Mellanox Technologies Device 0001\n\tPhysical Slot: 4\n\tFlags: bus master, fast devsel, latency 0, IRQ 60, NUMA node 0\n\tMemory at ea000000 (64-bit, prefetchable) [size=32M]\n\tExpansion ROM at f0300000 [disabled] [size=1M]\n\tCapabilities: [60] Express Endpoint, MSI 00\n\tCapabilities: [48] Vital Product Data\n\tCapabilities: [9c] MSI-X: Enable+ Count=64 Masked-\n\tCapabilities: [c0] Vendor Specific Information: Len=18 <?>\n\tCapabilities: [40] Power Management version 3\n\tCapabilities: [100] Advanced Error Reporting\n\tCapabilities: [150] Alternative Routing-ID Interpretation (ARI)\n\tCapabilities: [180] Single Root I/O Virtualization (SR-IOV)\n\tCapabilities: [1c0] #19\n\tCapabilities: [230] Access Control Services\n\tCapabilities: [320] #27\n\tCapabilities: [370] #26\n\tCapabilities: [420] #25\n\tKernel driver in use: mlx5_core\n\tKernel modules: mlx5_core\n"})}),"\n",(0,t.jsx)(e.h4,{id:"\u5982\u4f55\u9a8c\u8bc1ovs-offload\u662f\u5426\u751f\u6548",children:"\u5982\u4f55\u9a8c\u8bc1OVS Offload\u662f\u5426\u751f\u6548"}),"\n",(0,t.jsx)(e.p,{children:"\u9996\u5148\uff0c\u786e\u8ba4OpenvSwitch\u5728\u63a7\u5236\u9762\u5df2\u7ecf\u6253\u5f00\u786c\u4ef6\u5378\u8f7d\u7279\u6027\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'$ ovs-vsctl list Open_vSwitch . | grep other_config\n## \u8f93\u51fa\u5185\u5bb9\u9700\u8981\u5305\u542bhw-offload="true"\nother_config        : {hw-offload="true"}\n'})}),"\n",(0,t.jsxs)(e.p,{children:["\u5176\u6b21\uff0c\u6267\u884c  ",(0,t.jsx)(e.code,{children:"ovs-appctl dpctl/dump-flows type=offloaded"})," \u67e5\u770b\u5378\u8f7d\u5230\u786c\u4ef6\u8f6c\u53d1\u8868\u7684\u6d41\u8868\uff0c\u5982\u679c\u786c\u4ef6\u5378\u8f7d\u672a\u751f\u6548\uff0c\u5219\u8f93\u51fa\u4e3a\u7a7a\u3002"]})]})}function h(n={}){const{wrapper:e}={...(0,o.a)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(d,{...n})}):d(n)}},11151:(n,e,i)=>{i.d(e,{Z:()=>c,a:()=>l});var t=i(67294);const o={},s=t.createContext(o);function l(n){const e=t.useContext(s);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:l(n.components),t.createElement(s.Provider,{value:e},n.children)}}}]);