<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloudpods –
资源纳管</title><link>https://www.cloudpods.org/zh/docs/development/resource_sync/</link><description>Recent content in 资源纳管 on Cloudpods</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://www.cloudpods.org/zh/docs/development/resource_sync/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: 新资源接入</title><link>https://www.cloudpods.org/zh/docs/development/resource_sync/new_resource/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/development/resource_sync/new_resource/</guid><description>
&lt;p>本文以阿里云ElasticSearch为例(cloudpods从v3.8开始支持)，介绍如何纳管ElasticSearch&lt;/p>
&lt;h2 id="git-diff-参考同时会有腾讯云对接">git diff 参考(同时会有腾讯云对接)&lt;/h2>
&lt;p>&lt;a href="https://github.com/yunionio/cloudpods/pull/11595/files">https://github.com/yunionio/cloudpods/pull/11595/files&lt;/a>&lt;/p>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">说明&lt;/h4>
自v3.10开始, cloudpods对于各个云的操作都将移至&lt;a href="https://github.com/yunionio/cloudmux">cloudmux&lt;/a>仓库, pkg/cloudprovider及pkg/multicloud的改动需要到&lt;strong>cloudmux&lt;/strong>进行
&lt;/div>
&lt;h2 id="定义-elasticsearch-接口">定义 ElasticSearch 接口&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/cloudprovider/resources.go 文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 文件末尾追加&lt;/span>
&lt;span style="color:#204a87">type&lt;/span> ICloudElasticSearch interface &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 说明: 同步时，可以仅定义一些基础的信息，先将资源同步下来&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 后面再根据资属性，往资源加相应的接口或操作&lt;/span>
IVirtualResource
IBillingResource
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="实现阿里云的基础数据结构">实现阿里云的基础数据结构&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 创建 pkg/multicloud/aliyun/elastic_search.go 文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 填充阿里云ElasticSearch基础数据结构&lt;/span>
package aliyun
&lt;span style="color:#204a87">type&lt;/span> SElasticSearch struct &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
// 这里统一实现了Aliyun标签接口，可以减少一些函数声明
multicloud.AliyunTags
// 同上, 但部分IVirtualResource接口依然需要实现
multicloud.SVirtualResourceBase
// 一些计费的基础方法
multicloud.SBillingBase
// 链式结构, 用于对ElasticSearch进行操作
region *SRegion
// 阿里云 ElasticSearch 属性
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 实现获取阿里云 ElasticSearch 资源函数
// 获取 ElasticSearch 资源列表
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SRegion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>size, page int&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">([]&lt;/span>SElasticSearch, int, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 获取单个 ElasticSearch 资源
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SRegion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetElasitcSearch&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>id string&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>*SElasticSearch, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="实现-aliyuncli-命令行用于快速调试">实现 aliyuncli 命令行(用于快速调试)&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">// 创建 pkg/multicloud/aliyun/shell/elk.go 文件
package shell
func init&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87">type&lt;/span> ElkListOptions struct &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
Page int
Size int
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
shellutils.R&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>ElkListOptions&lt;span style="color:#ce5c00;font-weight:bold">{}&lt;/span>, &lt;span style="color:#4e9a06">&amp;#34;elastic-search-list&amp;#34;&lt;/span>, &lt;span style="color:#4e9a06">&amp;#34;List elastic searchs&amp;#34;&lt;/span>, func&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cli *aliyun.SRegion, args *ElkListOptions&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
elks, _, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> cli.GetElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>args.Size, args.Page&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> err
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
printList&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>elks, 0, 0, 0, nil&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil
&lt;span style="color:#ce5c00;font-weight:bold">})&lt;/span>
&lt;span style="color:#204a87">type&lt;/span> ElkIdOptions struct &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
ID string
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
shellutils.R&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>ElkIdOptions&lt;span style="color:#ce5c00;font-weight:bold">{}&lt;/span>, &lt;span style="color:#4e9a06">&amp;#34;elastic-search-show&amp;#34;&lt;/span>, &lt;span style="color:#4e9a06">&amp;#34;Show elasitc search&amp;#34;&lt;/span>, func&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cli *aliyun.SRegion, args *ElkIdOptions&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
elk, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> cli.GetElasitcSearch&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>args.ID&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> err
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
printObject&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>elk&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil
&lt;span style="color:#ce5c00;font-weight:bold">})&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="调试-aliyuncli-命令">调试 aliyuncli 命令&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 克隆cloudmux&lt;/span>
$ git clone https://github.com/yunionio/cloudmux.git &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#204a87">cd&lt;/span> cloudmux
&lt;span style="color:#8f5902;font-style:italic"># 编译 aliyuncli 命令&lt;/span>
$ make cmd/aliyuncli
&lt;span style="color:#8f5902;font-style:italic"># 声明环境变量&lt;/span>
$ &lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">ALIYUN_ACCESS_KEY&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>LTAI5H1wXkXeas1M
$ &lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">ALIYUN_SECRET&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>cByPBQM9zFVgNBMKNJZMYrKFUkvVk8
&lt;span style="color:#8f5902;font-style:italic"># 这里需要根据地域情况自行设置&lt;/span>
$ &lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">ALIYUN_REGION&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>cn-beijing
&lt;span style="color:#8f5902;font-style:italic"># 执行列出 ElasticSearch 资源命令&lt;/span>
$ ./_output/bin/aliyuncli elastic-search-list
$ ./_output/bin/aliyuncli elastic-search-show es-cn-n6w1ptcb30009****
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="补充-elasticsearch-接口">补充 ElasticSearch 接口&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/multicloud/aliyun/elastic_search.go 文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 实现以下接口&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetId&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> string &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 此函数返回值将会存储到数据库的external_id字段里面,请确保能和云上资源一一对应
// 若是Azure资源, 请务必返回时strings.ToLower&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>, 因为Azure资源Id不区分大小写，但id大小写返回不固定，在同步时会引起资源反复增删问题
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetGlobalId&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> string &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 获取ElasticSearch资源名称
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetName&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> string &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 创建删除或其他操作需要循环获取资源状态, 来判定操作是否结束, 此函数主要是刷新状态字段或其他相关字段
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> Refresh&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 获取资源创建时间
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetCreatedAt&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> time.Time &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 获取资源计费方式: 预付费, 后付费?
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetBillingType&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> string &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 获取资源归属项目Id
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetProjectId&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> string &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 获取资源状态
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetStatus&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> string &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="添加区域获取-elasticsearch-接口">添加区域获取 ElasticSearch 接口&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/cloudprovider/resources.go 文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 找到 ICloudRegion 定义, 并补充以下两个接口:&lt;/span>
&lt;span style="color:#204a87">type&lt;/span> ICloudRegion interface &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
GetIElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">([]&lt;/span>ICloudElasticSearch, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
GetIElasticSearchById&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>id string&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ICloudElasticSearch, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/multicloud/region_base.go 实现基础的两个方法&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 这里主要是因为对接往往是从一两个云开始&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 若不实现这两个基础方法，则需要在每一个云的region.go文件实现这两个方法&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SRegion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetIElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">([]&lt;/span>cloudprovider.ICloudElasticSearch, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil, errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cloudprovider.ErrNotImplemented, &lt;span style="color:#4e9a06">&amp;#34;GetIElasticSearchs&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SRegion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetIElasticSearchById&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>id string&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cloudprovider.ICloudElasticSearch, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil, errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cloudprovider.ErrNotImplemented, &lt;span style="color:#4e9a06">&amp;#34;GetIElasticSearchById&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 实现阿里云的这两个方法&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/multicloud/aliyun/elastic_search.go 文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 实现 GetIElasticSearchs 接口&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SRegion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetIElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">([]&lt;/span>cloudprovider.ICloudElasticSearch, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
// 获取当前region的所有elasticsearch实例
ess, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> self.GetElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>...&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> err
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
ret :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[]&lt;/span>cloudprovider.ICloudElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">{}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> i :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> range ess &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
// 这里需要赋值，例如删除, 就可以使用 ess&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>i&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>.region.DeleteElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ess&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>i&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>.InstanceId&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
ess&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>i&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>.region &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> self
&lt;span style="color:#000">ret&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> append&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ret, &lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>ess&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>i&lt;span style="color:#ce5c00;font-weight:bold">])&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> ret, nil
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 实现 GetIElasticSearchById 接口&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SRegion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetIElasticSearchById&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>id string&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cloudprovider.ICloudElasticSearch, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
// 这里没有使用es.region &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> self，是因为在GetElasitcSearch函数里面已经赋值过了
es, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> self.GetElasitcSearch&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>id&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil, err
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> es, nil
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="定义本地资源模型">定义本地资源模型&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-golang" data-lang="golang">&lt;span style="color:#a40000">#&lt;/span> &lt;span style="color:#000">创建&lt;/span> &lt;span style="color:#000">pkg&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">/&lt;/span>&lt;span style="color:#000">apis&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">/&lt;/span>&lt;span style="color:#000">compute&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">/&lt;/span>&lt;span style="color:#000">elastic_search&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#204a87;font-weight:bold">go&lt;/span> &lt;span style="color:#000">文件&lt;/span>
&lt;span style="color:#a40000">#&lt;/span> &lt;span style="color:#000">准备需要的数据结构&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">package&lt;/span> &lt;span style="color:#000">compute&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">import&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/apis&amp;#34;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">const&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>
&lt;span style="color:#000">ELASTIC_SEARCH_STATUS_AVAILABLE&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;available&amp;#34;&lt;/span>
&lt;span style="color:#000">ELASTIC_SEARCH_STATUS_UNAVAILABLE&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;unavailable&amp;#34;&lt;/span>
&lt;span style="color:#000">ELASITC_SEARCH_STATUS_CREATING&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;creating&amp;#34;&lt;/span>
&lt;span style="color:#000">ELASTIC_SEARCH_STATUS_DELETING&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;deleting&amp;#34;&lt;/span>
&lt;span style="color:#000">ELASTIC_SEARCH_STATUS_DELETE_FAILED&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;delete_failed&amp;#34;&lt;/span>
&lt;span style="color:#000">ELASTIC_SEARCH_STATUS_UNKNOWN&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;unknown&amp;#34;&lt;/span>
&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 资源创建参数, 目前仅站位
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">ElasticSearchCreateInput&lt;/span> &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 资源返回详情
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">ElasticSearchDetails&lt;/span> &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">apis&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">VirtualResourceDetails&lt;/span>
&lt;span style="color:#000">ManagedResourceInfo&lt;/span>
&lt;span style="color:#000">CloudregionResourceInfo&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 资源列表请求参数
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">ElasticSearchListInput&lt;/span> &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">apis&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">VirtualResourceListInput&lt;/span>
&lt;span style="color:#000">apis&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ExternalizedResourceBaseListInput&lt;/span>
&lt;span style="color:#000">apis&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">DeletePreventableResourceBaseListInput&lt;/span>
&lt;span style="color:#000">RegionalFilterListInput&lt;/span>
&lt;span style="color:#000">ManagedResourceListInput&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#a40000">#&lt;/span> &lt;span style="color:#000">创建&lt;/span> &lt;span style="color:#000">pkg&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">/&lt;/span>&lt;span style="color:#000">compute&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">/&lt;/span>&lt;span style="color:#000">models&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">/&lt;/span>&lt;span style="color:#000">elastic_search&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#204a87;font-weight:bold">go&lt;/span> &lt;span style="color:#000">文件&lt;/span>
&lt;span style="color:#a40000">#&lt;/span> &lt;span style="color:#000">实现基础manager和model&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">package&lt;/span> &lt;span style="color:#000">models&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">import&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;context&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/jsonutils&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/pkg/errors&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/pkg/util/compare&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/sqlchemy&amp;#34;&lt;/span>
&lt;span style="color:#000">billing_api&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/apis/billing&amp;#34;&lt;/span>
&lt;span style="color:#000">api&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/apis/compute&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/cloudcommon/db&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/cloudcommon/db/lockman&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/cloudprovider&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/httperrors&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/mcclient&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/util/stringutils2&amp;#34;&lt;/span>
&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">SElasticSearchManager&lt;/span> &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#a40000">#&lt;/span> &lt;span style="color:#000">由于资源是用户资源&lt;/span>&lt;span style="color:#a40000">，&lt;/span>&lt;span style="color:#000">因此定义为Virtual资源&lt;/span>
&lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SVirtualResourceBaseManager&lt;/span>
&lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SExternalizedResourceBaseManager&lt;/span>
&lt;span style="color:#000">SDeletePreventableResourceBaseManager&lt;/span>
&lt;span style="color:#000">SCloudregionResourceBaseManager&lt;/span>
&lt;span style="color:#000">SManagedResourceBaseManager&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">var&lt;/span> &lt;span style="color:#000">ElasticSearchManager&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearchManager&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000">init&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">ElasticSearchManager&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">SElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">SVirtualResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">NewVirtualResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>
&lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">{},&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;elastic_searchs_tbl&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;elastic_search&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;elastic_searchs&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000;font-weight:bold">),&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SetVirtualObject&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">SElasticSearch&lt;/span> &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SVirtualResourceBase&lt;/span>
&lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SExternalizedResourceBase&lt;/span>
&lt;span style="color:#000">SManagedResourceBase&lt;/span>
&lt;span style="color:#000">SBillingResourceBase&lt;/span>
&lt;span style="color:#000">SCloudregionResourceBase&lt;/span>
&lt;span style="color:#000">SDeletePreventableResourceBase&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">manager&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">GetContextManagers&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">[][]&lt;/span>&lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IModelManager&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000;font-weight:bold">[][]&lt;/span>&lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IModelManager&lt;/span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#000">CloudregionManager&lt;/span>&lt;span style="color:#000;font-weight:bold">},&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// ElasticSearch实例列表
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">man&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">ListItemFilter&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>
&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">q&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">sqlchemy&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SQuery&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">userCred&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TokenCredential&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">query&lt;/span> &lt;span style="color:#000">api&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ElasticSearchListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">sqlchemy&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SQuery&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">var&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SVirtualResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ListItemFilter&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">VirtualResourceListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SVirtualResourceBaseManager.ListItemFilter&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SExternalizedResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ListItemFilter&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ExternalizedResourceBaseListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SExternalizedResourceBaseManager.ListItemFilter&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SDeletePreventableResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ListItemFilter&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">DeletePreventableResourceBaseListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SDeletePreventableResourceBaseManager.ListItemFilter&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SManagedResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ListItemFilter&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ManagedResourceListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SManagedResourceBaseManager.ListItemFilter&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SCloudregionResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ListItemFilter&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">RegionalFilterListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SCloudregionResourceBaseManager.ListItemFilter&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">man&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">OrderByExtraFields&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>
&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">q&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">sqlchemy&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SQuery&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">userCred&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TokenCredential&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">query&lt;/span> &lt;span style="color:#000">api&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ElasticSearchListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">sqlchemy&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SQuery&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SVirtualResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">OrderByExtraFields&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">VirtualResourceListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SVirtualResourceBaseManager.OrderByExtraFields&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SCloudregionResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">OrderByExtraFields&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">RegionalFilterListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SCloudregionResourceBaseManager.OrderByExtraFields&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SManagedResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">OrderByExtraFields&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ManagedResourceListInput&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SManagedResourceBaseManager.OrderByExtraFields&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">man&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">QueryDistinctExtraField&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">q&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">sqlchemy&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SQuery&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">field&lt;/span> &lt;span style="color:#204a87;font-weight:bold">string&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">sqlchemy&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SQuery&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SVirtualResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">QueryDistinctExtraField&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">field&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">==&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SCloudregionResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">QueryDistinctExtraField&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">field&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">==&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">man&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SManagedResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">QueryDistinctExtraField&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">field&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">==&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">httperrors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ErrNotFound&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">man&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">ValidateCreateData&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TokenCredential&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ownerId&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IIdentityProvider&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span> &lt;span style="color:#000">jsonutils&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">JSONObject&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">input&lt;/span> &lt;span style="color:#000">api&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ElasticSearchCreateInput&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">api&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ElasticSearchCreateInput&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">input&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">httperrors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">NewNotImplementedError&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;Not Implemented&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">manager&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">FetchCustomizeColumns&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>
&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">userCred&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TokenCredential&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">query&lt;/span> &lt;span style="color:#000">jsonutils&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">JSONObject&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">objs&lt;/span> &lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#204a87;font-weight:bold">interface&lt;/span>&lt;span style="color:#000;font-weight:bold">{},&lt;/span>
&lt;span style="color:#000">fields&lt;/span> &lt;span style="color:#000">stringutils2&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SSortedStrings&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">isList&lt;/span> &lt;span style="color:#204a87;font-weight:bold">bool&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#000">api&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ElasticSearchDetails&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">rows&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#204a87">make&lt;/span>&lt;span style="color:#000;font-weight:bold">([]&lt;/span>&lt;span style="color:#000">api&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ElasticSearchDetails&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87">len&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">objs&lt;/span>&lt;span style="color:#000;font-weight:bold">))&lt;/span>
&lt;span style="color:#000">virtRows&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">manager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SVirtualResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">FetchCustomizeColumns&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">objs&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">fields&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">isList&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000">manRows&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">manager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SManagedResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">FetchCustomizeColumns&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">objs&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">fields&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">isList&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000">regRows&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">manager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SCloudregionResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">FetchCustomizeColumns&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">query&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">objs&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">fields&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">isList&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">range&lt;/span> &lt;span style="color:#000">rows&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">rows&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000;font-weight:bold">]&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">api&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ElasticSearchDetails&lt;/span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">VirtualResourceDetails&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000">virtRows&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000;font-weight:bold">],&lt;/span>
&lt;span style="color:#000">ManagedResourceInfo&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000">manRows&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000;font-weight:bold">],&lt;/span>
&lt;span style="color:#000">CloudregionResourceInfo&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000">regRows&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000;font-weight:bold">],&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">rows&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">self&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SCloudregion&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">GetElasticSearchs&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">managerId&lt;/span> &lt;span style="color:#204a87;font-weight:bold">string&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">([]&lt;/span>&lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">q&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Query&lt;/span>&lt;span style="color:#000;font-weight:bold">().&lt;/span>&lt;span style="color:#000">Equals&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;cloudregion_id&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#204a87">len&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">managerId&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">&amp;gt;&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">q&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Equals&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;manager_id&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">managerId&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">ret&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">{}&lt;/span>
&lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">FetchModelObjects&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">ret&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrapf&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;db.FetchModelObjects&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">ret&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">self&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SCloudregion&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">SyncElasticSearchs&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TokenCredential&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SCloudprovider&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">exts&lt;/span> &lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#000">cloudprovider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ICloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">compare&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SyncResult&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 加锁防止重入
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span> &lt;span style="color:#000">lockman&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">LockRawObject&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">KeywordPlural&lt;/span>&lt;span style="color:#000;font-weight:bold">(),&lt;/span> &lt;span style="color:#000">fmt&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Sprintf&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;%s-%s&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>&lt;span style="color:#000;font-weight:bold">))&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">defer&lt;/span> &lt;span style="color:#000">lockman&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ReleaseRawObject&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">KeywordPlural&lt;/span>&lt;span style="color:#000;font-weight:bold">(),&lt;/span> &lt;span style="color:#000">fmt&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Sprintf&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;%s-%s&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>&lt;span style="color:#000;font-weight:bold">))&lt;/span>
&lt;span style="color:#000">result&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">compare&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SyncResult&lt;/span>&lt;span style="color:#000;font-weight:bold">{}&lt;/span>
&lt;span style="color:#000">dbEss&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetElasticSearchs&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">result&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Error&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">result&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">removed&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#204a87">make&lt;/span>&lt;span style="color:#000;font-weight:bold">([]&lt;/span>&lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000">commondb&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#204a87">make&lt;/span>&lt;span style="color:#000;font-weight:bold">([]&lt;/span>&lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000">commonext&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#204a87">make&lt;/span>&lt;span style="color:#000;font-weight:bold">([]&lt;/span>&lt;span style="color:#000">cloudprovider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ICloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000">added&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#204a87">make&lt;/span>&lt;span style="color:#000;font-weight:bold">([]&lt;/span>&lt;span style="color:#000">cloudprovider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ICloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 本地和云上资源列表进行比对
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">compare&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">CompareSets&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">dbEss&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">exts&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">removed&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">commondb&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">commonext&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">added&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">result&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Error&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">result&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 删除云上没有的资源
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span> &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#000;font-weight:bold">&amp;lt;&lt;/span> &lt;span style="color:#204a87">len&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">removed&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span> &lt;span style="color:#000">i&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">++&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">removed&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000;font-weight:bold">].&lt;/span>&lt;span style="color:#000">syncRemoveCloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">result&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">DeleteError&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">continue&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">result&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Delete&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 和云上资源属性进行同步
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span> &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#000;font-weight:bold">&amp;lt;&lt;/span> &lt;span style="color:#204a87">len&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">commondb&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span> &lt;span style="color:#000">i&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">++&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">commondb&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000;font-weight:bold">].&lt;/span>&lt;span style="color:#000">SyncWithCloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">commonext&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000;font-weight:bold">])&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">result&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">UpdateError&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">continue&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">result&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Update&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 创建本地没有的云上资源
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span> &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#000">i&lt;/span> &lt;span style="color:#000;font-weight:bold">&amp;lt;&lt;/span> &lt;span style="color:#204a87">len&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">added&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span> &lt;span style="color:#000">i&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">++&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">_&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">newFromCloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">added&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">i&lt;/span>&lt;span style="color:#000;font-weight:bold">])&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">result&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">AddError&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">continue&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">result&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Add&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">result&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 判断资源是否可以删除
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">self&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">ValidateDeleteCondition&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">DisableDelete&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IsTrue&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">httperrors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">NewInvalidStatusError&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;ElasticSearch is locked, cannot delete&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SStatusStandaloneResourceBase&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ValidateDeleteCondition&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">self&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">syncRemoveCloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TokenCredential&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Delete&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 同步资源属性
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">self&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">SyncWithCloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TokenCredential&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ext&lt;/span> &lt;span style="color:#000">cloudprovider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ICloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">diff&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">UpdateWithLock&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">func&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ExternalId&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetGlobalId&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Status&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetStatus&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">BillingType&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetBillingType&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">BillingType&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">==&lt;/span> &lt;span style="color:#000">billing_api&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">BILLING_TYPE_PREPAID&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">expiredAt&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetExpiredAt&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span> &lt;span style="color:#000;font-weight:bold">!&lt;/span>&lt;span style="color:#000">expiredAt&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IsZero&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ExpiredAt&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">expiredAt&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">AutoRenew&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IsAutoRenew&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">})&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrapf&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;db.Update&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">syncVirtualResourceMetadata&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">provider&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetCloudprovider&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span> &lt;span style="color:#000">provider&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">SyncCloudProject&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetOwnerId&lt;/span>&lt;span style="color:#000;font-weight:bold">(),&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">OpsLog&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">LogSyncUpdate&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">diff&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">self&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SCloudregion&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">newFromCloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TokenCredential&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SCloudprovider&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ext&lt;/span> &lt;span style="color:#000">cloudprovider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ICloudElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">es&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">SElasticSearch&lt;/span>&lt;span style="color:#000;font-weight:bold">{}&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SetModelManager&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ExternalId&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetGlobalId&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">CloudregionId&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">self&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ManagerId&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IsEmulated&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IsEmulated&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Status&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetStatus&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">createdAt&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetCreatedAt&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span> &lt;span style="color:#000;font-weight:bold">!&lt;/span>&lt;span style="color:#000">createdAt&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IsZero&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">CreatedAt&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">createdAt&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">BillingType&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetBillingType&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">BillingType&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">==&lt;/span> &lt;span style="color:#000">billing_api&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">BILLING_TYPE_PREPAID&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">expired&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetExpiredAt&lt;/span>&lt;span style="color:#000;font-weight:bold">();&lt;/span> &lt;span style="color:#000;font-weight:bold">!&lt;/span>&lt;span style="color:#000">expired&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IsZero&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ExpiredAt&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">expired&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">AutoRenew&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">IsAutoRenew&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">var&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>
&lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">func&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 这里加锁是为了防止名称重复
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span> &lt;span style="color:#000">lockman&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">LockRawObject&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Keyword&lt;/span>&lt;span style="color:#000;font-weight:bold">(),&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;name&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">defer&lt;/span> &lt;span style="color:#000">lockman&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ReleaseRawObject&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Keyword&lt;/span>&lt;span style="color:#000;font-weight:bold">(),&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;name&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Name&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GenerateName&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetOwnerId&lt;/span>&lt;span style="color:#000;font-weight:bold">(),&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetName&lt;/span>&lt;span style="color:#000;font-weight:bold">())&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrapf&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;db.GenerateName&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">ElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TableSpec&lt;/span>&lt;span style="color:#000;font-weight:bold">().&lt;/span>&lt;span style="color:#000">Insert&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrapf&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;newFromCloudElasticSearch.Insert&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 同步标签
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span> &lt;span style="color:#000">syncVirtualResourceMetadata&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">// 同步项目归属
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span> &lt;span style="color:#000">SyncCloudProject&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetOwnerId&lt;/span>&lt;span style="color:#000;font-weight:bold">(),&lt;/span> &lt;span style="color:#000">ext&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">provider&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Id&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">OpsLog&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">LogEvent&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">db&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ACT_CREATE&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetShortDesc&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">),&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">es&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">manager&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">SElasticSearchManager&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">ListItemExportKeys&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">q&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">sqlchemy&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SQuery&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">userCred&lt;/span> &lt;span style="color:#000">mcclient&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TokenCredential&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">keys&lt;/span> &lt;span style="color:#000">stringutils2&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SSortedStrings&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">sqlchemy&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SQuery&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">var&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">manager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SVirtualResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ListItemExportKeys&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">keys&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SVirtualResourceBaseManager.ListItemExportKeys&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">keys&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ContainsAny&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">manager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SManagedResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetExportKeys&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">manager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SManagedResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ListItemExportKeys&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">keys&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SManagedResourceBaseManager.ListItemExportKeys&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">keys&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ContainsAny&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">manager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SCloudregionResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">GetExportKeys&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">manager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SCloudregionResourceBaseManager&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ListItemExportKeys&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">userCred&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">keys&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">errors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Wrap&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;SCloudregionResourceBaseManager.ListItemExportKeys&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">q&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="添加-resful-接口">添加 resful 接口&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/compute/service/handlers.go 文件&lt;/span>
func InitHandlers&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>app *appsrv.Application&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> _, manager :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> range &lt;span style="color:#ce5c00;font-weight:bold">[]&lt;/span>db.IModelManager&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
db.RegisterModelManager&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>manager&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> _, manager :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> range &lt;span style="color:#ce5c00;font-weight:bold">[]&lt;/span>db.IModelManager&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
// 加入es manager
models.ElasticSearchManager,
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
db.RegisterModelManager&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>manager&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
handler :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> db.NewModelHandler&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>manager&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
dispatcher.AddModelDispatcher&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&amp;#34;&lt;/span>, app, handler&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="打包镜像重启-region-服务">打包镜像，重启 region 服务&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 打包镜像&lt;/span>
$ &lt;span style="color:#000">ARCH&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>all &lt;span style="color:#000">TAG&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>v3.8.es &lt;span style="color:#000">REGISTRY&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>registry.cn-beijing.aliyuncs.com/你的镜像命名空间 ./scripts/docker_push.sh region
&lt;span style="color:#8f5902;font-style:italic"># 替换镜像，重启服务&lt;/span>
$ kubectl edit deployments. -n onecloud default-region &lt;span style="color:#8f5902;font-style:italic"># 替换配置文件中的image为上面打包的镜像&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="climc-命令编写">climc 命令编写&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 创建 pkg/mcclient/modules/mod_elastic_searchs.go 文件, 注册module&lt;/span>
package modules
import &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/mcclient/modulebase&amp;#34;&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87">type&lt;/span> ElasticSearchManager struct &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
modulebase.ResourceManager
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
var &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>
ElasticSearchs ElasticSearchManager
&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
func init&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">ElasticSearchs&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> ElasticSearchManager&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>NewComputeManager&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;elastic_search&amp;#34;&lt;/span>, &lt;span style="color:#4e9a06">&amp;#34;elastic_searchs&amp;#34;&lt;/span>,
&lt;span style="color:#ce5c00;font-weight:bold">[]&lt;/span>string&lt;span style="color:#ce5c00;font-weight:bold">{}&lt;/span>,
&lt;span style="color:#ce5c00;font-weight:bold">[]&lt;/span>string&lt;span style="color:#ce5c00;font-weight:bold">{})}&lt;/span>
registerCompute&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>ElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 创建 pkg/mcclient/options/compute/elastic_search.go 文件，定义 climc 命令行参数&lt;/span>
package compute
import &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/jsonutils&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/mcclient/options&amp;#34;&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87">type&lt;/span> ElasticSearchListOptions struct &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
options.BaseListOptions
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>opts *ElasticSearchListOptions&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> Params&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>jsonutils.JSONObject, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> options.ListStructToParams&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>opts&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87">type&lt;/span> ElasticSearchIdOption struct &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
ID string &lt;span style="color:#4e9a06">`&lt;/span>help:&lt;span style="color:#4e9a06">&amp;#34;Elasticsearch Id&amp;#34;&lt;/span>&lt;span style="color:#4e9a06">`&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>opts *ElasticSearchIdOption&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetId&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> string &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> opts.ID
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>opts *ElasticSearchIdOption&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> Params&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>jsonutils.JSONObject, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil, nil
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 创建 cmd/climc/shell/compute/elastic_search.go 文件, 添加命令&lt;/span>
package compute
import &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/cmd/climc/shell&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/mcclient/modules&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/mcclient/options/compute&amp;#34;&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
func init&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
cmd :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> shell.NewResourceCmd&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>modules.ElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
cmd.List&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>compute.ElasticSearchListOptions&lt;span style="color:#ce5c00;font-weight:bold">{})&lt;/span>
cmd.Show&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>compute.ElasticSearchIdOption&lt;span style="color:#ce5c00;font-weight:bold">{})&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="调试-climc-命令">调试 climc 命令&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 编译 climc 命令&lt;/span>
$ make cmd/climc
&lt;span style="color:#8f5902;font-style:italic"># 声明环境变量&lt;/span>
$ &lt;span style="color:#204a87">source&lt;/span> &amp;lt;&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ocadm cluster rcadmin&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 执行列出 ElasticSearch 资源命令&lt;/span>
$ ./_output/bin/climc --debug elastic-search-list &lt;span style="color:#8f5902;font-style:italic"># 由于此时还未同步elastic search资源，返回结果为空&lt;/span>
$ ./_output/bin/climc --debug elastic-search-show es-cn-n6w1ptcb30009****
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="同步-elasticsearch-资源">同步 ElasticSearch 资源&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/cloudprovider/consts.go 文件, 定义新资源类型&lt;/span>
const &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>
&lt;span style="color:#000">CLOUD_CAPABILITY_PROJECT&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;project&amp;#34;&lt;/span>
...
&lt;span style="color:#000">CLOUD_CAPABILITY_ES&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;es&amp;#34;&lt;/span> // ElasticSearch
&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/multicloud/aliyun/aliyun.go 文件, 添加云平台对新资源的能力&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>region *SAliyunClient&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetCapabilities&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[]&lt;/span>string &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
caps :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[]&lt;/span>string&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
cloudprovider.CLOUD_CAPABILITY_PROJECT,
...
...
cloudprovider.CLOUD_CAPABILITY_ES,
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> caps
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/compute/models/cloudsync.go 文件, 添加同步逻辑&lt;/span>
func syncPublicCloudProviderInfo&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>
ctx context.Context,
userCred mcclient.TokenCredential,
syncResults SSyncResultSet,
provider *SCloudprovider,
driver cloudprovider.ICloudProvider,
localRegion *SCloudregion,
remoteRegion cloudprovider.ICloudRegion,
syncRange *SSyncRange,
&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
// 若云平台支持ElasticSearch则同步es资源
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> utils.IsInStringArray&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cloudprovider.CLOUD_CAPABILITY_ES, driver.GetCapabilities&lt;span style="color:#ce5c00;font-weight:bold">())&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
syncElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, userCred, syncResults, provider, localRegion, remoteRegion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> cloudprovider.IsSupportCompute&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>driver&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func syncElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, userCred mcclient.TokenCredential, syncResults SSyncResultSet, provider *SCloudprovider, localRegion *SCloudregion, remoteRegion cloudprovider.ICloudRegion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
iEss, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> remoteRegion.GetIElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
msg :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> fmt.Sprintf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;GetIElasticSearchs for region %s failed %s&amp;#34;&lt;/span>, remoteRegion.GetName&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>, err&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
log.Errorf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>msg&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> err
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
result :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> localRegion.SyncElasticSearchs&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, userCred, provider, iEss&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
syncResults.Add&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ElasticSearchManager, result&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
msg :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> result.Result&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
log.Infof&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;SyncElasticSearchs for region %s result: %s&amp;#34;&lt;/span>, localRegion.Name, msg&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> result.IsError&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> result.AllError&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="打包镜像重启服务同步资源">打包镜像，重启服务，同步资源&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 打包镜像&lt;/span>
$ &lt;span style="color:#000">ARCH&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>all &lt;span style="color:#000">TAG&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>v3.8.es &lt;span style="color:#000">REGISTRY&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>registry.cn-beijing.aliyuncs.com/你的镜像命名空间 ./scripts/docker_push.sh region
&lt;span style="color:#8f5902;font-style:italic"># 替换镜像，重启服务&lt;/span>
$ kubectl edit deployments. -n onecloud default-region &lt;span style="color:#8f5902;font-style:italic"># 替换配置文件中的image为上面打包的镜像&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 声明环境变量&lt;/span>
$ &lt;span style="color:#204a87">source&lt;/span> &amp;lt;&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ocadm cluster rcadmin&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
$ climc cloud-account-sync --force --full-sync 阿里云账号id
&lt;span style="color:#8f5902;font-style:italic"># 等待资源同步完成, 查看资源是否同步下来&lt;/span>
$ climc elastic-search-list --scope system
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="添加资源删除操作">添加资源删除操作&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/cloudprovider/resources.go&lt;/span>
&lt;span style="color:#204a87">type&lt;/span> ICloudElasticSearch interface &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
IVirtualResource
IBillingResource
// 添加删除接口
Delete&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/multicloud/aliyun/elastic_search.go 文件，实现Delete操作&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> Delete&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> self.region.DeleteElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self.InstanceId&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SRegion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> DeleteElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>id string&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 添加 aliyuncli 命令&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/multicloud/aliyun/shell/elk.go 文件&lt;/span>
func init&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#204a87">type&lt;/span> ElkIdOptions struct &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
ID string
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
...
shellutils.R&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>ElkIdOptions&lt;span style="color:#ce5c00;font-weight:bold">{}&lt;/span>, &lt;span style="color:#4e9a06">&amp;#34;elastic-search-delete&amp;#34;&lt;/span>, &lt;span style="color:#4e9a06">&amp;#34;Delete elasitc search&amp;#34;&lt;/span>, func&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cli *aliyun.SRegion, args *ElkIdOptions&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> cli.DeleteElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>args.ID&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">})&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/compute/models/elastic_search.go 文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 添加删除逻辑&lt;/span>
...
// 这里重写Delete方法，只有在Delete任务完成后调用RealDelete方法进行真正的删除
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> Delete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, userCred mcclient.TokenCredential&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 只有在资源真正删除后才删除本地数据库资源
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> RealDelete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, userCred mcclient.TokenCredential&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> self.SVirtualResourceBase.Delete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, userCred&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 进入删除任务
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> CustomizeDelete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, userCred mcclient.TokenCredential, query jsonutils.JSONObject, data jsonutils.JSONObject&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> self.StartDeleteTask&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, userCred, &lt;span style="color:#4e9a06">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> StartDeleteTask&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, userCred mcclient.TokenCredential, parentTaskId string&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
task, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> taskman.TaskManager.NewTask&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, &lt;span style="color:#4e9a06">&amp;#34;ElasticSearchDeleteTask&amp;#34;&lt;/span>, self, userCred, nil, parentTaskId, &lt;span style="color:#4e9a06">&amp;#34;&amp;#34;&lt;/span>, nil&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> err
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
self.SetStatus&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>userCred, api.ELASTIC_SEARCH_STATUS_DELETING, &lt;span style="color:#4e9a06">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
task.ScheduleRun&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>nil&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetRegion&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>*SCloudregion, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
region, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> CloudregionManager.FetchById&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self.CloudregionId&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil, errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>err, &lt;span style="color:#4e9a06">&amp;#34;CloudregionManager.FetchById(%s)&amp;#34;&lt;/span>, self.CloudregionId&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> region.&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>*SCloudregion&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>, nil
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetIRegion&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cloudprovider.ICloudRegion, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
region, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> self.GetRegion&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil, errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>err, &lt;span style="color:#4e9a06">&amp;#34;GetRegion&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
provider, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> self.GetDriver&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil, errors.Wrap&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>err, &lt;span style="color:#4e9a06">&amp;#34;self.GetDriver&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> provider.GetIRegionById&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>region.GetExternalId&lt;span style="color:#ce5c00;font-weight:bold">())&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
// 获取云上对应的资源
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> GetIElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cloudprovider.ICloudElasticSearch, error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> len&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self.ExternalId&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">==&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil, errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cloudprovider.ErrNotFound, &lt;span style="color:#4e9a06">&amp;#34;empty externalId&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
iRegion, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> self.GetIRegion&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil, errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>cloudprovider.ErrNotFound, &lt;span style="color:#4e9a06">&amp;#34;GetIRegion&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> iRegion.GetIElasticSearchById&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self.ExternalId&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> syncRemoveCloudElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, userCred mcclient.TokenCredential&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
// 这里需要将之前的self.Delete变更为self.RealDelete, 防止同步时资源没有删除
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> self.RealDelete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, userCred&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 创建 pkg/compute/tasks/elastic_search_delete_task.go 文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编写删除任务&lt;/span>
package tasks
import &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;context&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/jsonutils&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/pkg/errors&amp;#34;&lt;/span>
api &lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/apis/compute&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/cloudcommon/db&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/cloudcommon/db/taskman&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/cloudprovider&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/compute/models&amp;#34;&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;yunion.io/x/onecloud/pkg/util/logclient&amp;#34;&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87">type&lt;/span> ElasticSearchDeleteTask struct &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
taskman.STask
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func init&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
taskman.RegisterTask&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ElasticSearchDeleteTask&lt;span style="color:#ce5c00;font-weight:bold">{})&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *ElasticSearchDeleteTask&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> taskFail&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, es *models.SElasticSearch, err error&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
es.SetStatus&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self.GetUserCred&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>, api.ELASTIC_SEARCH_STATUS_DELETE_FAILED, err.Error&lt;span style="color:#ce5c00;font-weight:bold">())&lt;/span>
db.OpsLog.LogEvent&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>es, db.ACT_DELOCATE_FAIL, err, self.UserCred&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
// 记录删除失败日志
logclient.AddActionLogWithStartable&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self, es, logclient.ACT_DELETE, err, self.UserCred, &lt;span style="color:#204a87">false&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
self.SetStageFailed&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, jsonutils.NewString&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>err.Error&lt;span style="color:#ce5c00;font-weight:bold">()))&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *ElasticSearchDeleteTask&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> OnInit&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, obj db.IStandaloneModel, data jsonutils.JSONObject&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
es :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> obj.&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>*models.SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
iEs, err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> es.GetIElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
// 处理云上资源已删除的情况
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> errors.Cause&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>err&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">==&lt;/span> cloudprovider.ErrNotFound &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
self.taskComplete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, es&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
self.taskFail&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, es, errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>err, &lt;span style="color:#4e9a06">&amp;#34;GetIElasticSearch&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">))&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> iEs.Delete&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
self.taskFail&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, es, errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>err, &lt;span style="color:#4e9a06">&amp;#34;iEs.Delete&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">))&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
self.taskComplete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, es&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *ElasticSearchDeleteTask&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> taskComplete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, es *models.SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
es.RealDelete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, self.GetUserCred&lt;span style="color:#ce5c00;font-weight:bold">())&lt;/span>
self.SetStageComplete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, nil&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 cmd/climc/shell/compute/elastic_search.go 文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 添加 climc 删除命令&lt;/span>
func init&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
cmd.Delete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>compute.ElasticSearchIdOption&lt;span style="color:#ce5c00;font-weight:bold">{})&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 测试删除&lt;/span>
$ climc elastic-search-delete test-elastic-search
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="资源清理云账号删除">资源清理(云账号删除)&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 此步骤仅适用于新资源接入，已有资源不涉及此操作&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/compute/models/purge.go 文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 追加以下内容&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>manager *SElasticSearchManager&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> purgeAll&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, userCred mcclient.TokenCredential, providerId string&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
ess :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[]&lt;/span>SElasticSearch&lt;span style="color:#ce5c00;font-weight:bold">{}&lt;/span>
err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> fetchByManagerId&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>manager, providerId, &lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>ess&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>err, &lt;span style="color:#4e9a06">&amp;#34;fetchByManagerId&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> i :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> range ess &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
lockman.LockObject&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, &lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>ess&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>i&lt;span style="color:#ce5c00;font-weight:bold">])&lt;/span>
defer lockman.ReleaseObject&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, &lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>ess&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>i&lt;span style="color:#ce5c00;font-weight:bold">])&lt;/span>
err :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> ess&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>i&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>.RealDelete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx, userCred&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> err !&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> nil &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> errors.Wrapf&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>err, &lt;span style="color:#4e9a06">&amp;#34;elastic search delete&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> nil
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 编辑 pkg/compute/models/cloudproviders.go 文件&lt;/span>
func &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>self *SCloudprovider&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> RealDelete&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ctx context.Context, userCred mcclient.TokenCredential&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> error &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> _, manager :&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> range &lt;span style="color:#ce5c00;font-weight:bold">[]&lt;/span>IPurgeableManager&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
// 根据资源依赖排序，依赖越小，排的越前
ElasticSearchManager,
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
...
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 接入一个云</title><link>https://www.cloudpods.org/zh/docs/development/resource_sync/add-cloud/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/development/resource_sync/add-cloud/</guid><description>
&lt;p>假设这里要接入的云为测试云(TestCloud)&lt;/p>
&lt;h2 id="基础概念">基础概念&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>平台名称&lt;/p>
&lt;ul>
&lt;li>每接入一个云，都需要定义一个云平台的名称，&lt;a href="https://github.com/yunionio/cloudmux/blob/master/pkg/apis/compute/cloudaccount_const.go">Provider&lt;/a> 这里是目前已经接入的各个云的名称&lt;/li>
&lt;li>这里说明下腾讯云的名称&lt;strong>Qcloud&lt;/strong>, 本身最好的定义是TencentCloud, 但最早登录时用的控制台地址是https://qcloud.com, 所以才定义为&lt;strong>Qcloud&lt;/strong>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>资源接口&lt;/p>
&lt;ul>
&lt;li>为了屏蔽各个云的差异, 我们分离出 &lt;a href="https://github.com/yunionio/cloudmux">Cloudmux&lt;/a> 仓库, 将各个云的资源操作统一放到这个仓库里面&lt;/li>
&lt;li>每一类资源都在 &lt;a href="https://github.com/yunionio/cloudmux/blob/master/pkg/cloudprovider/resources.go">Resource&lt;/a> 可以找到对应的接口&lt;/li>
&lt;li>对于每一个云来说基本实现&lt;strong>Resource&lt;/strong>里面定义的接口，就完成了80%的云平台接入&lt;/li>
&lt;li>这里的实现文件列表为 pkg/multicloud/testcloud/&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>云账号接入&lt;/p>
&lt;ul>
&lt;li>云账号接入类似于资源接口, 接口定义在&lt;a href="https://github.com/yunionio/cloudmux/blob/master/pkg/cloudprovider/cloudprovider.go">ICloudProvider&lt;/a>, 需要实现&lt;strong>ICloudProviderFactory&lt;/strong>和&lt;strong>ICloudProvider&lt;/strong>&lt;/li>
&lt;li>&lt;strong>ICloudProviderFactory&lt;/strong> 是校验云账号及云账号属性的接口&lt;/li>
&lt;li>&lt;strong>ICloudProvider&lt;/strong> 是云账号真正获取及操作云平台资源的入口&lt;/li>
&lt;li>这里的实现文件在 pkg/multicloud/testcloud/provider/&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>快捷操作&lt;/p>
&lt;ul>
&lt;li>为了快捷调试各个云的接口, 每个云平台会有一个对应云平台的cli命令实现, 例如&lt;a href="https://github.com/yunionio/cloudmux/blob/master/cmd/aliyuncli/main.go">aliyuncli&lt;/a>&lt;/li>
&lt;li>aliyuncli启动时会导入&lt;a href="https://github.com/yunionio/cloudmux/tree/master/pkg/multicloud/aliyun/shell">Shell&lt;/a>里面的子命令, 例如: aliyuncli instance-list&lt;/li>
&lt;li>在实现接口初期，可以根据要介入的云平台资源API, 将基础API调用实现, 然后写入shell子命令，可以通过shell命令快速调试API&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="testcli调试命令">testcli调试命令&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>创建 pkg/multicloud/testcloud/test.go 文件&lt;/p>
&lt;ul>
&lt;li>定义 &lt;strong>STestCloudClient&lt;/strong> 结构体, 用于保存aksk&lt;/li>
&lt;li>实现 &lt;strong>NewTestCloudClient&lt;/strong> 方法, 此方法需要验证测试云的aksk是否正确, 并返回*STestCloudClient&lt;/li>
&lt;li>创建 pkg/multicloud/testcloud/region.go 并定义SRegion结构体，实现 GetClient 方法&lt;/li>
&lt;li>实现绑定 GetRegions 方法到 STestCloudClient, 私有云region一般是模拟的, 可以找已经试下的私有云参考&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>创建 pkg/multicloud/testcloud/shell/region.go&lt;/p>
&lt;ul>
&lt;li>实现 region-list 命令, 可参考pkg/multicloud/aliyun/shell/region.go&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>创建 cmd/testcli/main.go 文件&lt;/p>
&lt;ul>
&lt;li>实现命令调试的入口, 可参考cmd/aliyuncli/main.go&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>调试 region-list 命令&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#8f5902;font-style:italic"># 编译testcli二进制文件&lt;/span>
$ make cmd/testcli
&lt;span style="color:#8f5902;font-style:italic"># 通过命令调试接口&lt;/span>
$ ./_output/bin/testcli --debug region-list
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="添加各个资源接口实现">添加各个资源接口实现&lt;/h3>
&lt;p>资源的实现类似于数的生长，自根到枝到叶, 越发扩散，region类似于树根, region底下有vpc, zone&amp;hellip;, zone底下有host, storage&amp;hellip;可依照这个顺序依次实现对应资源的接口&lt;/p>
&lt;ul>
&lt;li>添加各个资源的shell命令&lt;/li>
&lt;li>根据资源接口定义实现各个资源相应的接口&lt;/li>
&lt;/ul>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">说明&lt;/h4>
&lt;p>这里有一些接口及方法实现的注意事项&lt;/p>
&lt;ul>
&lt;li>资源的GetGlobalId要求全局唯一
&lt;ul>
&lt;li>例如region列表不能同时出现两个region-1&lt;/li>
&lt;li>region-1 底下可以有zone1, region-2底下就不能有zone1&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>资源的Refresh
&lt;ul>
&lt;li>资源如果不存在时refresh，需要返回ErrNotFound错误&lt;/li>
&lt;li>在调用jsonutils.Update自身时需要将自身的指针或者切片属性设为nil, 否则这些信息不会被更新&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>资源的IsEmulated
&lt;ul>
&lt;li>这个属性是cloudpods用来显示或者隐藏某些模拟的资源, 例如公有云并没有宿主机这个概念, 因此公有云的宿主机是emulated的&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>GetCapabilities接口
&lt;ul>
&lt;li>此接口定义了这个云实现了哪些资源，包括资源是否只读&lt;/li>
&lt;li>若实现了某些资源接口，需要将这些资源加入到返回列表里面，否则资源存在同步不下来的问题&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/div>
&lt;h3 id="云账号接入">云账号接入&lt;/h3>
&lt;p>首先需要实现上面&lt;strong>基础概念&lt;/strong>定义的&lt;strong>云账号接入&lt;/strong>里面的接口&lt;/p>
&lt;ul>
&lt;li>主要实现以下几个接口
&lt;ul>
&lt;li>ICloudProviderFactory
&lt;ul>
&lt;li>GetProvider&lt;/li>
&lt;li>GetId&lt;/li>
&lt;li>GetName&lt;/li>
&lt;li>ValidateCreateCloudaccountData&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ICloudProvider
&lt;ul>
&lt;li>GetFactory&lt;/li>
&lt;li>GetIRegions&lt;/li>
&lt;li>GetIRegionById&lt;/li>
&lt;li>GetSubAccounts&lt;/li>
&lt;li>GetAccountId&lt;/li>
&lt;li>GetCloudRegionExternalIdPrefix&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>实现完成后，编辑pkg/multicloud/loader/loader.go文件, 将包导入进去&lt;/p>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">说明&lt;/h4>
&lt;p>这里要注意GetSubAccounts实际上是返回了云订阅的信息，有几个SubAccounts就有几个云订阅
判断云订阅个数是根据云订阅的特性决定的, 即使是同一个云账号A, A账号底下的a订阅资源不能关联到A账号底下b订阅的资源, 例如a订阅的eip不能绑定到b订阅的虚拟机上&lt;/p>
&lt;p>GetAccountId是返回这个账号的唯一标识，用来阻止云账号重复导入的&lt;/p>
&lt;/div>
&lt;h3 id="cloudpods-接入">cloudpods 接入&lt;/h3>
&lt;p>资源接口及云账号接入已经实现后即可正式接入cloudpods调试资源&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#8f5902;font-style:italic"># 进入cloudpods代码目录, 导入cloudmux, /path/to/local/cloudmux/path需要替换为本地的cloudmux绝对路径&lt;/span>
$ go mod edit -replace yunion.io/x/cloudmux&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/path/to/local/cloudmux/path
$ make mod
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>添加 pkg/compute/guestdrivers/testcloud.go pkg/compute/hostdrivers/testcloud.go pkg/compute/regiondrivers/testcloud.go 文件, 实现基础的init方法&lt;/li>
&lt;li>编辑 cmd/climc/shell/compute/cloudaccounts.go 文件, 添加create-testcloud子命令&lt;/li>
&lt;li>编辑 pkg/apis/compute/cloudaccount_const.go 文件, 添加云平台名称到对应的变量&lt;/li>
&lt;li>编辑 pkg/apis/compute/host_const.go 文件, 添加对应host_type, 及底下一些变量需要对应添加&lt;/li>
&lt;li>编辑 pkg/apis/compute/guest_const.go 文件, 添加对应的hypersor, 及底下一些变量需要对应添加&lt;/li>
&lt;li>若添加的对应的云子网若是region级别的，需要编辑pkg/apis/compute/network_const.go文件,添加至REGIONAL_NETWORK_PROVIDERS&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#8f5902;font-style:italic"># 编译region二进制, 或者打包region镜像 https://www.cloudpods.org/zh/docs/development/dev-env/#docker-%E9%95%9C%E5%83%8F%E7%BC%96%E8%AF%91%E4%B8%8A%E4%BC%A0&lt;/span>
$ make cmd/region
&lt;span style="color:#8f5902;font-style:italic"># 编译最新的climc命令&lt;/span>
$ make cmd/climc
&lt;span style="color:#8f5902;font-style:italic"># 导入云账号&lt;/span>
$ ./_output/bin/climc cloud-account-create-testcloud --xxx -xxx -xxx -xxx
&lt;/code>&lt;/pre>&lt;/div>&lt;p>监控数据采集&lt;/p>
&lt;ul>
&lt;li>修改 cloudmux 的 pkg/cloudmux/testcloud/provider/provider.go 添加实现GetMetrics接口&lt;/li>
&lt;li>添加 cloudpods 的 pkg/cloudmon/providerdriver/testcloud.go 文件&lt;/li>
&lt;li>go mod edit &amp;ndash;replace &amp;amp;&amp;amp; make mod &amp;amp;&amp;amp; make cmd/cloudmon 打包发布最新的cloudmon镜像调试&lt;/li>
&lt;/ul></description></item></channel></rss>