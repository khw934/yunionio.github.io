<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloudpods –
高可用</title><link>https://www.cloudpods.org/zh/docs/ops/ha/</link><description>Recent content in 高可用 on Cloudpods</description><generator>Hugo -- gohugo.io</generator><lastBuildDate>Wed, 28 Jun 2023 14:45:50 +0800</lastBuildDate><atom:link href="https://www.cloudpods.org/zh/docs/ops/ha/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: 高可用维护</title><link>https://www.cloudpods.org/zh/docs/ops/ha/ha/</link><pubDate>Tue, 08 Nov 2022 18:38:00 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/ops/ha/ha/</guid><description>
&lt;h2 id="高可用vip的主动切换">高可用VIP的主动切换&lt;/h2>
&lt;p>高可用集群通过Keepalived来维护主从节点的切换，平时VIP在主节点，由主节点提供服务。在主节点宕机情况下，会自动切换到备节点，由备节点提供服务。&lt;/p>
&lt;p>在平时运维工作中，存在需要主动切换主从节点的情况，例如要对主节点执行关机维护任务。&lt;/p>
&lt;p>可以通过修改调低主节点的keepalived的优先级并重启keepalived实例的方式主动实现主从切换。&lt;/p>
&lt;p>控制服务的VIP切换的keepavlied配置文件位于 /etc/kubernetes/manifests/keepalived.yaml&lt;/p>
&lt;p>数据库服务的VIP切换的keepalived配置文件位于 /etc/keepalived/keepalived.conf&lt;/p>
&lt;p>EIP网关的VIP切换的keepalvied配置文件位于 /etc/keepalived/eipgw.conf&lt;/p>
&lt;h2 id="高可用节点下线维护步骤">高可用节点下线维护步骤&lt;/h2>
&lt;ol>
&lt;li>如果有VIP，将VIP主动切换到备节点&lt;/li>
&lt;li>如果有虚拟机，迁移虚拟机到其他宿主机&lt;/li>
&lt;li>将容器从该节点驱逐&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubectl cordon &amp;lt;node&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>将kubelet，docker等服务设置为不自动启动&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">systemctl disable kubelet docker keepalived maraidb
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="5">
&lt;li>停止容器&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">docker stop
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="6">
&lt;li>停止所有服务&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">systemctl stop kubelet docker keepalived maraidb
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="7">
&lt;li>维护节点&lt;/li>
&lt;/ol>
&lt;h2 id="高可用节点恢复上线步骤">高可用节点恢复上线步骤&lt;/h2>
&lt;ol>
&lt;li>如果有数据库，先启动数据库&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">systemctl start mariadb
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>检查数据库主从同步状态&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">show slave status&lt;span style="color:#4e9a06">\G&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果有问题，则需优先解决数据库主从同步问题。&lt;/p>
&lt;ol start="3">
&lt;li>启动docker&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">systemctl start docker
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>启动kubelet&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">systemctl start kubelet
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="5">
&lt;li>如果修改了keepavlied的优先级，恢复keepalived的优先级。启动keepalived&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">systemctl start keepalived
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="6">
&lt;li>恢复Kubenetes调度&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubectl uncordon &amp;lt;node&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="7">
&lt;li>恢复以上服务的开机自动启动&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">systemctl &lt;span style="color:#204a87">enable&lt;/span> kubelet docker keepalived maraidb
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 系统自动备份</title><link>https://www.cloudpods.org/zh/docs/ops/ha/auto-backup/</link><pubDate>Fri, 14 Apr 2023 16:03:30 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/ops/ha/auto-backup/</guid><description>
&lt;h2 id="自动备份云管系统的数据库k8s-配置etcd-快照">自动备份云管系统的数据库、K8s 配置、etcd 快照&lt;/h2>
&lt;p>本命令为指定的系统增加自动备份云管系统的数据库、K8s 配置、etcd 快照的功能。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">usage: ocboot.py auto-backup &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>-h&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--user SSH_USER&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--key-file SSH_PRIVATE_FILE&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--port SSH_PORT&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--backup-path BACKUP_PATH&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--light&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--max-backups MAX_BACKUPS&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--max-disk-percentage MAX_DISK_PERCENTAGE&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
TARGET_NODE_HOSTS &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>TARGET_NODE_HOSTS ...&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
positional arguments:
TARGET_NODE_HOSTS target nodes
optional arguments:
-h, --help show this &lt;span style="color:#204a87">help&lt;/span> message and &lt;span style="color:#204a87">exit&lt;/span>
--user SSH_USER, -u SSH_USER
target host ssh user &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>default: root&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
--key-file SSH_PRIVATE_FILE, -k SSH_PRIVATE_FILE
target host ssh private key file &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>default:
/root/.ssh/id_rsa&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
--port SSH_PORT, -p SSH_PORT
target host host ssh port &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>default: 22&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
--backup-path BACKUP_PATH
backup path, default: /opt/yunion/backup
--light ignore yunionmeter and yunionlogger database&lt;span style="color:#000;font-weight:bold">;&lt;/span> ignore
tables start with &lt;span style="color:#4e9a06">&amp;#39;opslog&amp;#39;&lt;/span> and &lt;span style="color:#4e9a06">&amp;#39;task&amp;#39;&lt;/span>.
--max-backups MAX_BACKUPS
how many backups to keep. default: &lt;span style="color:#0000cf;font-weight:bold">10&lt;/span>
--max-disk-percentage MAX_DISK_PERCENTAGE
the max usage percentage of the disk on which the
backup will be &lt;span style="color:#204a87;font-weight:bold">done&lt;/span> allowed to perform backup. the
backup job will not work when the disk&lt;span style="color:#a40000">&amp;#39;&lt;/span>s usage is
above the threshold. default: 75&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>%&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>下面介绍各个参数的作用和注意事项&lt;/p>
&lt;ul>
&lt;li>&lt;code>TARGET_NODE_HOSTS&lt;/code>，此处填写需要部署自动备份的&lt;strong>控制节点&lt;/strong>的IP。如果有多个控制节点，只需输入其中之一即可。&lt;/li>
&lt;li>&lt;code>--user&lt;/code>, &lt;code>--key-file&lt;/code>, &lt;code>--port&lt;/code>这些参数是登录备份机器的ssh配置。一般默认用户名&lt;code>root&lt;/code>、端口号&lt;code>22&lt;/code>。如果自定义，可以在&lt;code>$HOME/.ssh/config&lt;/code>里配置。请确保当前机器可以免密登录到所输入的&lt;code>TARGET_NODE_HOSTS&lt;/code>。&lt;/li>
&lt;li>&lt;code>--backup-path&lt;/code>，备份路径。默认为&lt;code>/opt/yunion/backup&lt;/code>。&lt;/li>
&lt;li>&lt;code>--max-disk-percentage&lt;/code>允许的最大磁盘使用率。默认为&lt;code>75%&lt;/code>。备份过程会检测所输入的&lt;code>--backup-path&lt;/code>所在磁盘的使用率。如果已经达到允许的最大磁盘使用率，就会停止备份，以免备份文件打满磁盘。&lt;/li>
&lt;li>&lt;code>--light&lt;/code>是否为轻量备份。默认为&lt;code>否&lt;/code>，即，全量备份。轻量备份与全量备份的区别是某些（通常可以自由删除的）业务日志。建议日常只选轻量备份，以节约磁盘、加速备份过程。&lt;/li>
&lt;li>&lt;code>--max-backups&lt;/code>保留的备份次数。默认保留最新的10次备份。&lt;/li>
&lt;/ul>
&lt;h2 id="手工恢复备份的数据库和k8s配置">手工恢复备份的数据库和k8s配置&lt;/h2>
&lt;p>ssh登陆控制节点，进入备份目录，以2023-05-28的备份为例，恢复命令如下&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@controller ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># cd /opt/yunion/backup/&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@controller backup&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># tar -xzvf onecloud.bkup.20230528-000001.tar.gz&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@controller backup&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># cd 20230528-000001/&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@controller 20230528-000001&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># ll&lt;/span>
total &lt;span style="color:#0000cf;font-weight:bold">181548&lt;/span>
-rw------- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">185819168&lt;/span> May &lt;span style="color:#0000cf;font-weight:bold">28&lt;/span> 00:00 etcd_snapshot_20230528-000001.db
-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">74493&lt;/span> May &lt;span style="color:#0000cf;font-weight:bold">28&lt;/span> 00:00 oc.20230528-000001.yml
-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">3241&lt;/span> May &lt;span style="color:#0000cf;font-weight:bold">28&lt;/span> 00:00 onecloud-operator.20230528-000001.yml
&lt;span style="color:#8f5902;font-style:italic"># 恢复数据库&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@controller 20230528-000001&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># pv onecloud.sql.20230528-000001.gz | gunzip | mysql -uroot -p$MYSQL_PASSWD -h $MYSQL_HOST&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 恢复k8s各组件服务&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@controller 20230528-000001&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># kubectl apply -f oc.20230528-000001.yml&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@controller 20230528-000001&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># kubectl apply -f onecloud-operator.20230528-000001.yml&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>