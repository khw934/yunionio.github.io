<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloudpods –
操作指南</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/</link><description>Recent content in 操作指南 on Cloudpods</description><generator>Hugo -- gohugo.io</generator><lastBuildDate>Thu, 06 Jan 2022 19:37:32 +0800</lastBuildDate><atom:link href="https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: 新建本地IDC虚拟机</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/create/</link><pubDate>Fri, 19 Jul 2019 15:22:33 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/create/</guid><description>
&lt;h3 id="前提条件">前提条件&lt;/h3>
&lt;ul>
&lt;li>如需创建内置私有云虚拟机，请确保环境中存在启用状态的宿主机。&lt;/li>
&lt;li>如需创建VMware平台虚拟机，请确保环境中已添加了VMware账号。&lt;/li>
&lt;/ul>
&lt;h3 id="界面操作">界面操作&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>单击列表上方 &lt;strong>&lt;em>&amp;ldquo;新建&amp;rdquo;&lt;/em>&lt;/strong> 按钮，进入新建本地IDC虚拟机页面。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>配置以下参数：&lt;/p>
&lt;ul>
&lt;li>指定项目：管理员和域管理员在新建虚拟机时需要指定虚拟机所属的项目。&lt;/li>
&lt;li>区域：选择区域和可用区。&lt;/li>
&lt;li>名称：设置虚拟机的名称。
&lt;ul>
&lt;li>当设置虚拟机数量大于1时，除第一台虚拟机名称外，其他虚拟机名称都以名称-1~N表示。&lt;/li>
&lt;li>虚拟机和裸金属共用名称空间。名称在系统中唯一。在项目中创建虚拟机报名称重复错误的原因为其他项目中已存在该名称的虚拟机或裸金属。&lt;/li>
&lt;li>名称支持有序后缀占位符#，一个#占一个位置，如名称设置为host##，虚拟机数量为2，创建的虚拟机名称为host00和host01。后续创建虚拟机名称仍设置为host##，名称将沿用之前的排序，编号依次往后。&lt;/li>
&lt;li>名称支持表达式，表达式格式为：${变量}，如${host}，则虚拟机名称显示为创建虚拟机的宿主机的名称。详细说明请参考&lt;a href="#%E4%B8%BB%E6%9C%BA%E5%90%8D%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%BE%E4%BE%8B%E8%AF%B4%E6%98%8E">主机名表达式举例说明&lt;/a>。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>备注：设置虚拟机备注。&lt;/li>
&lt;li>到期释放：设置新建虚拟机到期释放前的使用时长，超过设置的时间后虚拟机将会被删除放入回收站。默认不设置到期释放，用户可根据需要设置“1小时”、“6小时”、“1天”、“3天”、“1周”、“1月”或自定义使用时长。&lt;/li>
&lt;li>数量：设置创建虚拟机的数量。&lt;/li>
&lt;li>平台（本地IDC）：选择虚拟机所属的平台为Cloudpods和VMware。&lt;/li>
&lt;li>CPU架构：目前支持x86和aarch64架构。仅 Cloudpods 平台支持aarch64架构，其他平台默认只支持x86架构。&lt;/li>
&lt;li>是否配置GPU：是否为虚拟机配置GPU卡，启用该项后，还需要选择具体GPU卡。&lt;/li>
&lt;li>CPU核数、内存：设置虚拟机的规格。并可以根据虚拟机规格等选择可用套餐。&lt;/li>
&lt;li>套餐：虚拟机套餐为虚拟机CPU、内存规格的组合搭配，不同套餐价格不同。其中本地IDC和私有云套餐可通过云管平台进行维护，用户创建私有云平台的虚拟机时可以选择本地IDC的套餐或私有云平台的套餐。公有云套餐信息同步对应公有云平台上信息。
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
目前已通过套餐中的CPU架构过滤操作系统镜像。
&lt;/div>
&lt;/li>
&lt;li>操作系统：选择虚拟机的镜像，支持从以下方式获取镜像。镜像下拉列表中包括镜像名称、大小、CPU架构、分区方式、引导方式，并支持选中的镜像引导方式自动选择下面的引导方式。
&lt;ul>
&lt;li>VMware平台镜像：支持选择VMware平台上指定VMware账户的镜像，仅VMware平台支持。不在镜像列表中显示。&lt;/li>
&lt;li>公共镜像：对应系统镜像列表中的公共镜像，一般为系统常用镜像，由管理员维护。&lt;/li>
&lt;li>自定义镜像：对应系统镜像列表中的自定义镜像，一般是由用户上传。&lt;/li>
&lt;li>从ISO启动：对应系统镜像列表中的ISO格式的镜像。选择ISO镜像文件时，需要用户为虚拟机安装操作系统。仅Cloudpods和VMware平台支持。&lt;/li>
&lt;li>主机镜像：对应主机镜像列表中的主机镜像，仅Cloudpods平台支持。&lt;/li>
&lt;li>主机快照：对应主机快照列表中的主机快照，仅Cloudpods和VMware平台支持。
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">说明&lt;/h4>
通过挂载ISO安装Windows操作系统的虚拟机，安装完成后，还需要安装Virtio驱动，驱动可在镜像市场-ISO中获取。
&lt;/div>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>系统盘：根据选择的套餐情况显示并设置不同的磁盘类型以及磁盘的容量大小。公有云平台不支持设置调度标签
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ul>
&lt;li>当操作系统选择”从ISO启动“时，虚拟机上的磁盘类型都显示为数据盘。磁盘类型显示不影响虚拟机的正常使用。&lt;/li>
&lt;li>设置系统盘时，系统将会自动检查所选磁盘类型对应的存储容量是否满足需求。
&lt;ul>
&lt;li>当对应存储剩余容量小于100GB时，将会黄框提醒用户。此时仍可以成功创建磁盘，但是建议用户创建完成后去&lt;a href="../../../storage/block">存储-块存储&lt;/a>页面增加新存储或调整存储容量。&lt;/li>
&lt;li>当对应存储剩余容量不能满足设置的系统盘大小时，将显示红框，并提示用户去&lt;a href="../../../storage/block">存储-块存储&lt;/a>页面增加新存储或调整存储容量。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/div>
&lt;ul>
&lt;li>当不设置调度标签及调度偏好以及指定块存储时，系统将按照调度策略以及调度标签的默认偏好自动为虚拟机选择最优的存储。
&lt;ul>
&lt;li>优先检查系统中的调度策略，当有符合的调度策略，将根据调度策略中设置的调度标签及调度标签偏好选择对应存储。调度策略中的调度标签偏好会覆盖调度标签中的默认策略。&lt;/li>
&lt;li>当没有符合的调度策略后，将根据存储设备中绑定的调度标签的默认策略选择最优存储。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>当设置调度标签和调度标签偏好时，设置的调度标签偏好将覆盖调度标签上的默认策略。根据调度偏好以及调度标签选择提供系统盘的存储。
&lt;ul>
&lt;li>尽量使用（prefer）：调度时优先使用拥有这种标签的存储。&lt;/li>
&lt;li>避免使用（avoid）：调度时尽量避免拥有这种标签的存储。&lt;/li>
&lt;li>禁止使用（exclude）：调度时排除拥有这种标签的存储。&lt;/li>
&lt;li>必须使用（require）：调度时必须使用拥有这种标签的存储。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>举例说明：以本地存储为例，本地存储A绑定调度标签A，调度标签A默认策略为尽量使用。本地存储B绑定调度标签B，调度标签B默认策略为禁止使用。调度策略A为当在项目A中创建虚拟机时，选择调度标签B，调度策略偏好为必须使用。
&lt;ul>
&lt;li>当不设置调度标签时，有以下两种情况。
&lt;ul>
&lt;li>若虚拟机属于项目A，系统将优先选择本地存储B为虚拟机系统盘提供存储。&lt;/li>
&lt;li>当虚拟机不属于项目A，系统将优先选本地存储A为虚拟机系统盘提供存储。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>当设置调度标签为A，策略为禁止使用时，系统将会排除本地存储A，选择本地存储B为虚拟机系统盘提供存储。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>指定块存储：用户在管理后台视图下支持为磁盘指定块存储，并支持查看存储的使用情况等，目前仅VMware平台支持。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>数据盘：可选项，可根据需求添加多块数据盘，设置磁盘的类型及容量大小。磁盘可选类型同系统盘。仅第一块数据盘支持选择磁盘类型，后续添加的数据盘类型同第一块数据盘。
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
添加的数据盘仅挂载到虚拟机上，不会自动执行分区操作，需要用户远程连接虚拟机后手动分区。
&lt;/div>
&lt;ul>
&lt;li>仅Cloudpods平台支持支持设置挂载点、快照建磁盘、设置调度标签。私有云如使用本地存储，也支持设置调度标签功能。
&lt;ul>
&lt;li>设置调度标签：同系统盘。&lt;/li>
&lt;li>设置挂载点：设置数据盘的文件类型（ext4、xfs、swap）、数据盘挂载的非系统目录。设置挂载点和快照建磁盘两者只能设置一个。&lt;/li>
&lt;li>快照建磁盘：根据快照创建数据盘。可在本地IDC中查看已存在的快照。设置挂载点和快照建磁盘两者只能设置一个。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>管理员账号：显示虚拟机的管理员账号&lt;/li>
&lt;li>管理员密码：设置管理员密码，在Linux系统中为root用户的密码，在Windows操作系统中为administrator用户的密码。
&lt;ul>
&lt;li>随机生成：随机生成管理员密码，用户可在虚拟机列表密码列查看复制管理员密码&lt;/li>
&lt;li>关联密钥：在关联密钥之前需要先新建密钥。关联密钥后，用户需要使用私钥远程登录虚拟机。&lt;/li>
&lt;li>保留镜像设置：管理员密码为镜像中已有的管理员密码。&lt;/li>
&lt;li>手工输入：可手动设置管理员密码。
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">说明&lt;/h4>
&lt;ul>
&lt;li>当选择从ISO启动时，不支持设置管理员密码，管理员密码需要在用户安装操作系统时进行设置。&lt;/li>
&lt;li>根据虚拟机所在平台不同，设置管理员密码的方式可能为以上方式的其中几种，请以界面为准。&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>网络：设置虚拟机的IP地址。
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ul>
&lt;li>仅Cloudpods虚拟机可以选择default经典网络和VPC网络。&lt;/li>
&lt;li>只有Cloudpods平台虚拟机支持最多添加8个网络，其他平台仅支持一个网络。&lt;/li>
&lt;/ul>
&lt;/div>
&lt;ul>
&lt;li>自动调度：当选择自动调度时，将从启用自动调度的IP子网中为虚拟机分配IP地址。&lt;/li>
&lt;li>指定IP子网：选择VPC和IP子网，如需指定静态IP，可单击 &lt;strong>&lt;em>&amp;ldquo;手动配置IP&amp;rdquo;&lt;/em>&lt;/strong> 按钮，设置IP地址，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮。&lt;/li>
&lt;li>指定调度标签：设置调度标签以及调度标签偏好。设置的调度标签偏好将会覆盖调度标签上的默认策略。根据调度标签及调度偏好选择最优的IP子网。
&lt;ul>
&lt;li>尽量使用（prefer）：调度时优先使用拥有这种标签的IP子网。&lt;/li>
&lt;li>避免使用（avoid）：调度时尽量避免拥有这种标签的IP子网。&lt;/li>
&lt;li>禁止使用（exclude）：调度时排除拥有这种标签的IP子网。&lt;/li>
&lt;li>必须使用（require）：调度时必须使用拥有这种标签的IP子网。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>举例说明：如IP子网A绑定调度标签A，默认策略为禁止使用。IP子网B绑定调度标签B，默认策略为尽量使用。调度策略A为当虚拟机属于项目A，选择调度标签A，调度标签偏好为必须使用。
&lt;ul>
&lt;li>当创建虚拟机时网络选择默认时，有以下两种情况。
&lt;ul>
&lt;li>当虚拟机属于项目A时，系统将选择IP子网A为虚拟机分配IP地址。&lt;/li>
&lt;li>当虚拟机不属于项目A时，系统将选择IP子网B为虚拟机分配IP地址。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>当创建虚拟机时网络选择指定IP子网A，系统将选择IP子网A为虚拟机分配IP地址。&lt;/li>
&lt;li>当创建虚拟机时网络选择调度标签A，且标签偏好为必须使用，则系统会从IP子网A中为虚拟机分配一个未使用的IP地址。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>标签：支持为新建的虚拟机绑定标签。支持选择已有标签和新建标签。
&lt;ul>
&lt;li>新建标签：单击列表上方 &lt;strong>&lt;em>新建&lt;/em>&lt;/strong> 按钮，设置标签键和标签值，单击 &lt;strong>&lt;em>&amp;ldquo;添加&amp;rdquo;&lt;/em>&lt;/strong> 按钮，新建标签并绑定到资源上。&lt;/li>
&lt;li>选择已有标签：单击 &lt;strong>&lt;em>&amp;ldquo;已有标签&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择标签键和值。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>高级配置&lt;/strong>：默认隐藏，可根据需求进行配置。&lt;/p>
&lt;ul>
&lt;li>弹性公网IP：弹性公网IP是一种NAT IP，通过与虚拟机绑定，实现虚拟机与公网之间的通信。默认为暂不绑定，当选择“新建”时，需要配置以下参数：
&lt;ul>
&lt;li>线路类型：可根据需求创建对应线路类型的EIP。&lt;/li>
&lt;li>网络计费方式：设置弹性公网IP的计费方式，包括按流量计费和按带宽计费。
&lt;ul>
&lt;li>按流量计费：按实际传输流量收费，可限制峰值带宽避免意外流量带来的费用，当瞬间带宽超过该值时将丢包，适用于网络波动大的场合。&lt;/li>
&lt;li>按带宽计费：按传输速率计费，选择固定带宽，超过带宽时将丢包，适用于网络波动较小的场景。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>带宽：设置带宽大小。
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;pre>&lt;code>- 本地IDC平台创建VPC网络的虚拟机时支持绑定弹性公网IP，且仅支持按带宽计费；
&lt;/code>&lt;/pre>
&lt;/div>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>主机名：设置虚拟机操作系统内部的计算机名。&lt;/li>
&lt;li>安全组：为虚拟机设置安全组规则，安全组是一种虚拟的包过滤防火墙，通过设置安全组规则来控制关联的虚拟机是否可以被访问，以及虚拟机可访问的外部资源等。一个虚拟机最多支持绑定5个安全组。&lt;/li>
&lt;li>调度策略：通过调度策略可以选择虚拟机所属的宿主机或云账号。
&lt;ul>
&lt;li>默认：系统将根据调度策略以及调度标签为虚拟机选择最优的宿主机。
&lt;ul>
&lt;li>优先检查系统中的调度策略，如有符合的调度策略，将根据调度策略中的调度标签及调度标签偏好选择最优的宿主机。调度策略中的调度标签偏好会覆盖调度标签中的默认策略。&lt;/li>
&lt;li>当没有符合的调度策略，系统将根据宿主机绑定的调度标签的默认策略来选择最优的宿主机。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>指定宿主机：虚拟机将在指定的宿主机上创建。&lt;/li>
&lt;li>指定调度标签：设置调度标签以及调度标签的偏好。设置的调度标签偏好将会覆盖调度标签的默认策略。根据调度标签及调度标签偏好选择对应的宿主机。
&lt;ul>
&lt;li>尽量使用（prefer）：调度时优先使用拥有这种标签的宿主机。&lt;/li>
&lt;li>避免使用（avoid）：调度时尽量避免拥有这种标签的宿主机。&lt;/li>
&lt;li>禁止使用（exclude）：调度时排除拥有这种标签的宿主机。&lt;/li>
&lt;li>必须使用（require）：调度时必须使用拥有这种标签的宿主机。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>举例说明：如宿主机A绑定调度标签A，调度标签A的策略为禁止使用。宿主机B绑定调度标签B，调度标签B的策略为尽量使用。调度策略A为当在项目A中创建虚拟机时，选择调度标签A，调度策略偏好为必须使用。
&lt;ul>
&lt;li>当创建虚拟机时调度策略选择默认时，有以下两种情况。
&lt;ul>
&lt;li>当虚拟机属于项目A时，系统将选择在宿主机A上创建虚拟机。&lt;/li>
&lt;li>当虚拟机不属于项目A时，系统将选择宿主机B上创建虚拟机。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>当选择调度标签A，且设置调度标签偏好为必须使用时，系统将选择在宿主机A上创建虚拟机。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>引导方式：包括BIOS和UEFI模式，仅Cloudpods平台支持，且aarch64架构仅支持UEFI模式。&lt;/li>
&lt;li>远程终端协议：包括VNC和SPICE，仅Cloudpods平台支持。
&lt;ul>
&lt;li>VNC：主要用于linux的服务器的管理，由于无声音和usb传输，不满足于虚拟桌面的使用。&lt;/li>
&lt;li>SPICE：在色彩、音频和usb方面等表现较好，适用于虚拟桌面。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>显卡型号：包括Standard和QXL，当远程终端协议选择VNC时，显卡型号可设置为Standard和QXL，当远程终端协议为SPICE时，显卡型号仅可设置为QXL，仅Cloudpods平台支持。&lt;/li>
&lt;li>主机型号：包括PC和Q35，仅Cloudpods平台支持。&lt;/li>
&lt;li>备份机：仅Cloudpods平台支持且要求虚拟机所在域或共享给虚拟机所在域使用的宿主机不低于2台，通过为虚拟机创建备份机来实现高可用，虚拟机与备份机之间定时同步数据，当虚拟机故障时，业务将切换到备份机上正常使用。可以快速恢复业务，减少因为虚拟机故障造成的业务宕机时间。当启用高可用功能时，需要指定备份机的宿主机。&lt;/li>
&lt;li>反亲和组：选择是否勾选反亲和组，若勾选，则需要选择反亲和组，新创建的虚拟机需要根据反亲和组内的调度规则选择宿主机等，若不满足调度规则，则可能创建失败，仅Cloudpods平台支持。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>设置完成后，用户可单击 &lt;strong>&lt;em>新建&lt;/em>&lt;/strong> 按钮，创建虚拟机。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>若启用了工单，则需要填入申请原因，单击 &lt;strong>&lt;em>&amp;ldquo;提交工单&amp;rdquo;&lt;/em>&lt;/strong> 按钮，提交创建虚拟机的工单，等待审批通过后才会开始创建虚拟机。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="climc操作">climc操作&lt;/h3>
&lt;p>&lt;code>climc server-create&lt;/code> 命令提供创建云主机的操作。 Cloudpods 可以同时管理多个私有云和公有云，不同供应商有各自的认证方式，在创建云主机之前需要做一些不同的准备工作。&lt;/p>
&lt;p>创建机器命令为 &lt;code>server-create&lt;/code>，可以使用 &lt;code>climc help server-create&lt;/code> 查看创建 server 的所有参数，常用的参数如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">参数名称&lt;/th>
&lt;th style="text-align:center">类型&lt;/th>
&lt;th style="text-align:center">作用&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;ncpu&lt;/td>
&lt;td style="text-align:center">int&lt;/td>
&lt;td style="text-align:center">虚拟机 cpu 个数&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;disk&lt;/td>
&lt;td style="text-align:center">[]string&lt;/td>
&lt;td style="text-align:center">指定创建的系统盘镜像，指定多次表示虚拟机创建多块磁盘&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;net&lt;/td>
&lt;td style="text-align:center">[]string&lt;/td>
&lt;td style="text-align:center">指定虚拟机使用的网络，指定多次将在虚拟机里面添加多个网卡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;allow-delete&lt;/td>
&lt;td style="text-align:center">bool&lt;/td>
&lt;td style="text-align:center">允许删除虚拟机&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;auto-start&lt;/td>
&lt;td style="text-align:center">bool&lt;/td>
&lt;td style="text-align:center">创建完自动启动&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;password&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">设置虚拟机密码&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;tenant&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">创建到指定的项目&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;prefer-region&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">创建到指定的 region&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;prefer-zone&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">创建到指定的 zone&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">&amp;ndash;prefer-host&lt;/td>
&lt;td style="text-align:center">string&lt;/td>
&lt;td style="text-align:center">创建到指定的 host&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ol>
&lt;li>名称、内存或者套餐类型在创建主机时必须使用;&lt;/li>
&lt;li>系统盘的镜像通过 &lt;code>image-list&lt;/code> 或者 &lt;code>cached-image-list&lt;/code>，公有云的镜像列表通过 &lt;code>cached-image-list&lt;/code> 接口查询，参考: &lt;a href="../../../image/tutorial/show/#%E6%9F%A5%E8%AF%A2%E9%95%9C%E5%83%8F">查询镜像&lt;/a>;&lt;/li>
&lt;/ol>
&lt;/div>
&lt;p>下面以举例的方式创建机器：&lt;/p>
&lt;p>待创建规格:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>名称&lt;/th>
&lt;th>平台&lt;/th>
&lt;th>套餐&lt;/th>
&lt;th>内存&lt;/th>
&lt;th>cpu&lt;/th>
&lt;th>系统盘&lt;/th>
&lt;th>网络&lt;/th>
&lt;th>其他&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>vm1&lt;/td>
&lt;td>kvm&lt;/td>
&lt;td>-&lt;/td>
&lt;td>4g&lt;/td>
&lt;td>4&lt;/td>
&lt;td>centos7.qcow2 60g&lt;/td>
&lt;td>net1&lt;/td>
&lt;td>2块数据盘， 一块100g ext4 挂载到 /opt，另外一块 50g xfs 挂载到 /data; 自动启动&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>vm2&lt;/td>
&lt;td>esxi&lt;/td>
&lt;td>-&lt;/td>
&lt;td>2g&lt;/td>
&lt;td>2&lt;/td>
&lt;td>ubuntu18.04.qcow2 100g&lt;/td>
&lt;td>net2&lt;/td>
&lt;td>允许删除&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>vm3&lt;/td>
&lt;td>opnstack&lt;/td>
&lt;td>t2.nano&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;td>centos6.qcow2&lt;/td>
&lt;td>net3&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 创建 kvm vm1&lt;/span>
$ climc server-create --hypervisor kvm --disk centos7.qcow2:60g --disk 100g:ext4:/opt --disk 50g:xfs:/data --ncpu &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span> --net net1 --auto-start vm1 4g
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="主机名表达式举例说明">主机名表达式举例说明&lt;/h3>
&lt;p>主机（包括虚拟机和裸金属）名称支持表达式，表达式格式为：${变量名}，变量名需要小写。如${host}，则虚拟机名称显示为创建虚拟机的宿主机的名称；${region}-${zone}，则显示为区域名-可用区名称等。&lt;/p>
&lt;p>支持的变量名如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>变量名&lt;/th>
&lt;th>举例&lt;/th>
&lt;th>说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>brand&lt;/td>
&lt;td>aliyun&lt;/td>
&lt;td>品牌&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>charge_type&lt;/td>
&lt;td>postpaid&lt;/td>
&lt;td>计费方式&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloud_env&lt;/td>
&lt;td>onpremise/public/private&lt;/td>
&lt;td>用于区分本地IDC、私有云和公有云平台&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloudregion_id&lt;/td>
&lt;td>default&lt;/td>
&lt;td>区域id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cpu&lt;/td>
&lt;td>1&lt;/td>
&lt;td>CPU数量&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>host&lt;/td>
&lt;td>gobuild&lt;/td>
&lt;td>主机名&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>host_id&lt;/td>
&lt;td>16f49f8a-88cc-4715-8870-f78130196fa9&lt;/td>
&lt;td>主机id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ip_addr&lt;/td>
&lt;td>192.168.1.1&lt;/td>
&lt;td>IP地址&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>mem&lt;/td>
&lt;td>1024&lt;/td>
&lt;td>内存&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>os_distribution&lt;/td>
&lt;td>操作系统&lt;/td>
&lt;td>CentOS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>os_type&lt;/td>
&lt;td>Linux&lt;/td>
&lt;td>操作系统类型&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>os_version&lt;/td>
&lt;td>6.9&lt;/td>
&lt;td>操作系统版本&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>owner_tenant&lt;/td>
&lt;td>system&lt;/td>
&lt;td>项目&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>owner_tenant_id&lt;/td>
&lt;td>d56f5c37e36a42b782d7f32b19497c4c&lt;/td>
&lt;td>项目id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>provider&lt;/td>
&lt;td>OpenStack&lt;/td>
&lt;td>提供方&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>region&lt;/td>
&lt;td>Default&lt;/td>
&lt;td>区域&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>region_id&lt;/td>
&lt;td>kvm&lt;/td>
&lt;td>虚拟化方式&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>res_name&lt;/td>
&lt;td>server&lt;/td>
&lt;td>资源类别&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>template_id&lt;/td>
&lt;td>5199f56b-01c2-425c-8e29-0179d283e4a3&lt;/td>
&lt;td>模板id&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>zone&lt;/td>
&lt;td>zone1&lt;/td>
&lt;td>可用区&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>zone_id&lt;/td>
&lt;td>00f3f3c6-1d16-4053-81f1-4cb092f418f5&lt;/td>
&lt;td>可用区id&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>Docs: 登录虚拟机</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/connect/</link><pubDate>Fri, 19 Jul 2019 17:38:36 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/connect/</guid><description>
&lt;p>创建好虚拟机后，登录的方式大概分为以下几种：&lt;/p>
&lt;ul>
&lt;li>ssh: linux 通用，要求虚拟机网络可达;&lt;/li>
&lt;li>rdp: windows 远程桌面，要求虚拟机网络可达；可通过RDP对应的客户端连接Windows操作系统的虚拟机。&lt;/li>
&lt;li>vnc: vnc 链接，对虚拟机网络没有要求，只要能链接云平台 vnc proxy 即可;&lt;/li>
&lt;/ul>
&lt;h2 id="界面操作">界面操作&lt;/h2>
&lt;p>该功能用于通过过VNC远程终端或Web SSH远程连接到虚拟机。
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ul>
&lt;li>Windows操作系统的虚拟机只支持通过VNC远程终端；&lt;/li>
&lt;li>在Cloudpods平台经典网络的虚拟机可以直接使用Web SSH和VNC远程终端；Cloudpods平台VPC网络的虚拟机可以直接使用Web SSH和VNC远程终端，也可以绑定EIP后使用EIP的Web SSH。请注意，未绑定EIP的VPC网络的虚拟机只能通过平台的Web SSH连接，无法使用SSH工具进行连接，如需使用SSH工具连接虚拟机，请为虚拟机绑定EIP。&lt;/li>
&lt;li>当VMware的虚拟机所在EXSI低于6.5版本时，无法直接打开VNC远程终端，需要用户在本地下载vmrc（VMware Remote Console）客户端。&lt;/li>
&lt;li>VNC长时间连接黑屏后，按空格键会恢复显示。&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/p>
&lt;ol>
&lt;li>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/li>
&lt;li>单击虚拟机右侧操作列操作列 &lt;strong>&lt;em>&amp;ldquo;远程终端&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择 &lt;strong>&lt;em>&amp;ldquo;VNC远程终端&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，新建Web Console名称的浏览器标签页。
&lt;ul>
&lt;li>发送远程命令：单击 &lt;strong>&lt;em>&amp;ldquo;发送远程命令&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;Ctrl-Alt-F1~F6&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，向虚拟机控制台发送具体的命令。&lt;/li>
&lt;li>Ctrl-Alt-Delete：单击\ &lt;strong>&lt;em>Ctrl-Alt-Delete&lt;/em>&lt;/strong> 按钮，若虚拟机为Windows系统，则向虚拟机控制台发送Ctrl-Alt-Delete命令，若虚拟机为Linux系统，则将弹出重启服务器提示，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮后将重启虚拟机。&lt;/li>
&lt;li>发送文字：单击 &lt;strong>&lt;em>发送文字&lt;/em>&lt;/strong> 按钮，在弹出的发送文字对话框中输入需要发送的内容，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，向虚拟机控制台发送文字，如发送内容为登录密码，在发送文字后，需要键入回车键确认登录。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;远程终端&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择 &lt;strong>&lt;em>&amp;ldquo;SSH IP地址&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，与虚拟机建立web SSH连接。&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>远程终端&lt;/em>&lt;/strong> 按钮，选择 &lt;strong>&lt;em>&amp;ldquo;SSH IP地址:任意端口&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，在弹出的对话框中设置端口号，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，与虚拟机建立web SSH连接。&lt;/li>
&lt;/ol>
&lt;h2 id="climc操作">climc操作&lt;/h2>
&lt;p>针对以上的链接方式，我们提供以下接口链接云虚拟机：&lt;/p>
&lt;h3 id="vnc-连接">vnc 连接&lt;/h3>
&lt;p>&lt;code>climc webconsole-server&lt;/code> 命令提供通过 vnc 的方式链接虚拟机，该方式对裸金属服务器不可用。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc webconsole-server &amp;lt;server_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="ssh-连接">ssh 连接&lt;/h3>
&lt;p>查询 server 的 ip&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 可通过 server-list --search --details 的方式找到虚拟机的 ip&lt;/span>
$ climc server-list --search &amp;lt;server_name&amp;gt; --details
&lt;span style="color:#8f5902;font-style:italic"># 或者通过 server-show &amp;lt;server_id&amp;gt; 的方式得到 ip&lt;/span>
$ climc server-show &amp;lt;server_name&amp;gt; &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep ip
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ips &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10.168.222.226 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>查询 server 的登录信息&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-logininfo &amp;lt;server_name&amp;gt;
+----------+-----------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Field &lt;span style="color:#000;font-weight:bold">|&lt;/span> Value &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------+-----------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> password &lt;span style="color:#000;font-weight:bold">|&lt;/span> @2aWXB6AmCbV &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> updated &lt;span style="color:#000;font-weight:bold">|&lt;/span> 2019-07-03T10:00:20.801716Z &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> username &lt;span style="color:#000;font-weight:bold">|&lt;/span> root &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------+-----------------------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;p>ssh 登录&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ssh root@10.168.222.226
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过 webconsole 登录&lt;/p>
&lt;pre>&lt;code>$ climc webconsole-ssh 10.168.222.226
https://console.yunion.cn/web-console?access_token=y7bjpBwtvJHLHpwOUMzNVvsYiAgY1vskIuVwB-aINfH4mm8MsZqwxKSfHqm2pCvY6O8bBA%3D%3D&amp;amp;api_server=https%3A%2F%2Foffice.yunion.io&amp;amp;protocol=tty
&lt;/code>&lt;/pre>&lt;p>在浏览器打开 webconsole 放回的 url ，就会到对应虚拟机的登录界面&lt;/p>
&lt;p>&lt;img src="../../images/webssh.png" alt="">&lt;/p></description></item><item><title>Docs: 虚拟机状态</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/status/</link><pubDate>Thu, 06 Jan 2022 16:10:36 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/status/</guid><description/></item><item><title>Docs: 虚拟机设置</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/setting/</link><pubDate>Thu, 06 Jan 2022 16:17:36 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/setting/</guid><description/></item><item><title>Docs: 密码密钥管理</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/keypair/</link><pubDate>Thu, 06 Jan 2022 16:32:22 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/keypair/</guid><description/></item><item><title>Docs: 镜像</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/image/</link><pubDate>Thu, 06 Jan 2022 17:59:59 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/image/</guid><description/></item><item><title>Docs: 虚拟机网络管理</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/network/</link><pubDate>Thu, 06 Jan 2022 18:06:50 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/network/</guid><description/></item><item><title>Docs: 虚拟机监控</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/monitor/</link><pubDate>Fri, 19 Jul 2019 17:38:36 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/monitor/</guid><description>
&lt;p>平台支持两种监控宿主机上虚拟机的信息，一是通过宿主机获取虚拟机的监控信息，该方式获取的监控数据误差较大，二是为虚拟机安装Agent，像虚拟机内存使用率、磁盘使用率指标无法直接通过宿主机获取，需要&lt;a href="../../../../monitor_ops/monitor/tutorial/metric/installagent">安装监控Agent&lt;/a>。&lt;/p>
&lt;p>目前虚拟机监控指标分为两类。&lt;/p>
&lt;ul>
&lt;li>基础监控，即支持通过宿主机获取虚拟机的监控信息。监控指标包括CPU使用率、内存使用率、网络入流量、网络出流量、磁盘读速率、磁盘写速率&lt;/li>
&lt;li>Agent监控，即为虚拟机安装Agent后获取的监控信息。监控指标包括CPU使用率、内存使用率、网络入流量、网络出流量、磁盘使用率、磁盘读速率、磁盘写速率&lt;/li>
&lt;/ul>
&lt;p>虚拟机监控查询时间支持查看近1小时、近1天、近1周、近1月、近3月、近6月的性能监控信息，支持设置时间粒度，时间粒度大小与查看的时长有关。&lt;/p></description></item><item><title>Docs: 删除</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/delete/</link><pubDate>Fri, 19 Jul 2019 17:32:09 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/delete/</guid><description>
&lt;h2 id="界面操作">界面操作&lt;/h2>
&lt;h3 id="设置删除保护">设置删除保护&lt;/h3>
&lt;p>该功能用于设置虚拟机的删除保护。当虚拟机启用删除保护后，虚拟机无法被删除；当虚拟机禁用删除保护后，虚拟机才可以被删除。&lt;/p>
&lt;p>&lt;strong>单个虚拟机设置删除保护&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>禁用删除保护：
&lt;ul>
&lt;li>单击虚拟机名称右侧带有&lt;img src="../../../images/delprotect1.png" alt="">图标时，单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;删除-设置删除保护&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置删除保护对话框。&lt;/li>
&lt;li>选择&amp;quot;禁用&amp;quot;删除保护，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>启用删除保护：
&lt;ul>
&lt;li>当虚拟机名称右侧不带&lt;img src="../../../images/delprotect1.png" alt="">图标时，单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;删除-设置删除保护&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置删除保护对话框。&lt;/li>
&lt;li>选择&amp;quot;启用&amp;quot;删除保护，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>批量设置删除保护&lt;/strong>&lt;/p>
&lt;p>批量设置删除保护操作支持选择不同平台的虚拟机。&lt;/p>
&lt;ol>
&lt;li>禁用删除保护：
&lt;ul>
&lt;li>在虚拟机列表中选择一个或多个虚拟机，单击列表上方 &lt;strong>&lt;em>&amp;ldquo;批量操作&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;设置删除保护&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置删除保护对话框。&lt;/li>
&lt;li>选择&amp;quot;禁用&amp;quot;删除保护，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，批量为虚拟机禁用删除保护。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>启用删除保护：
&lt;ul>
&lt;li>在虚拟机列表中选择一个或多个虚拟机，单击列表上方 &lt;strong>&lt;em>&amp;ldquo;批量操作&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;设置删除保护&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置删除保护对话框。&lt;/li>
&lt;li>选择&amp;quot;启用&amp;quot;删除保护，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，批量为虚拟机启用删除保护。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="删除">删除&lt;/h3>
&lt;p>该功能用于删除虚拟机，当虚拟机名称项右侧有&lt;img src="../../../images/delprotect1.png" alt="">图标，表示该虚拟机启用了删除保护，无法删除虚拟机。如需要删除虚拟机，则需要先禁用删除保护再删除虚拟机。若&lt;/p>
&lt;p>批量删除虚拟机操作支持选择不同平台的虚拟机。&lt;/p>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ul>
&lt;li>若虚拟机所在的宿主机状态异常，即使禁用删除保护也无法删除虚拟机。&lt;/li>
&lt;li>若宿主机已经下线无法恢复时，需要管理员在控制节点使用climc的server-purge命令删除虚拟机记录。具体请参考&lt;a href="https://www.cloudpods.org/zh/docs/onpremise/vminstance/faq/purge/">清除虚拟机记录&lt;/a>&lt;/li>
&lt;li>Cloudpods等平台支持删除虚拟机时同时删除快照、后挂载的数据盘、EIP；&lt;/li>
&lt;li>Cloudpods平台删除虚拟机时，若磁盘时ceph盘则必须同时删除快照。若磁盘是本地磁盘，则必须勾选同时删除后挂载的数据盘。&lt;/li>
&lt;/ul>
&lt;/div>
&lt;h4 id="删除虚拟机">删除虚拟机&lt;/h4>
&lt;ol>
&lt;li>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/li>
&lt;li>单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;删除-删除&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出操作确认对话框。&lt;/li>
&lt;li>支持勾选“同时删除快照”、“同时删除后挂载的数据盘”、“同时删除EIP”等。&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，完成操作。&lt;/li>
&lt;li>若开启了工单，则还需要填入申请原因，单击 &lt;strong>&lt;em>&amp;ldquo;提交工单&amp;rdquo;&lt;/em>&lt;/strong> 按钮，提交删除主机工单，等待审批通过后才会成功删除虚拟机。&lt;/li>
&lt;/ol>
&lt;h4 id="批量删除虚拟机">批量删除虚拟机&lt;/h4>
&lt;ol>
&lt;li>在虚拟机列表中选择一个或多个虚拟机，单击列表上方 &lt;strong>&lt;em>&amp;ldquo;批量操作&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;删除&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出操作确认对话框。&lt;/li>
&lt;li>支持勾选“同时删除快照”、“同时删除后挂载的数据盘”、“同时删除EIP”等。&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，完成操作。&lt;/li>
&lt;li>若开启了工单，则还需要填入申请原因，单击 &lt;strong>&lt;em>&amp;ldquo;提交工单&amp;rdquo;&lt;/em>&lt;/strong> 按钮，提交删除主机工单，等待审批通过后才会成功删除虚拟机。&lt;/li>
&lt;/ol>
&lt;h2 id="climc操作">climc操作&lt;/h2>
&lt;h3 id="删除-1">删除&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 删除至回收站&lt;/span>
$ climc server-delete &amp;lt;server_id&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 彻底删除&lt;/span>
$ climc server-delete -f &amp;lt;server_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 主备机</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/backup/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/backup/</guid><description>
&lt;p>Cloudpods平台上的基于本地存储创建的虚拟机支持高可用功能，通过为虚拟机创建备份机来实现高可用，虚拟机与备份机之间互为主备且数据保持实时同步，当主虚拟机故障时，将会自动切换到备份机，快速恢复业务，减少因为虚拟机故障造成的业务宕机时间，同时将会再次为虚拟机创建可用的备份机，使其一直保持高可用的状态。&lt;/p>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
当创建备份机失败或切换备份机失败时，支持手动重试。
&lt;/div>
&lt;h3 id="添加备份机">添加备份机&lt;/h3>
&lt;p>该功能用于为使用本地存储的虚拟机在其它宿主机上创建备份机，创建的备份机与虚拟机配置相同，互为主备，实时保持数据同步等。虚拟机列表中只显示主虚拟机的信息，不显示备份机信息。&lt;/p>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ul>
&lt;li>虚拟机和备份机不可以位于同一宿主机。&lt;/li>
&lt;li>虚拟机添加备份机之后不支持调整配置、创建快照、迁移功能。&lt;/li>
&lt;li>已经创建快照的虚拟机，添加备份机且切换到备份机后，原有快照不可用。&lt;/li>
&lt;/ul>
&lt;/div>
&lt;ol>
&lt;li>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/li>
&lt;li>单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;高可用-添加备份机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出添加备份机对话框。&lt;/li>
&lt;li>选择备份机的宿主机，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮。&lt;/li>
&lt;li>虚拟机名称右侧将出现&lt;img src="../../../images/computing/HA.png" alt="">的图标。&lt;/li>
&lt;/ol>
&lt;h3 id="删除备份机">删除备份机&lt;/h3>
&lt;p>该功能用于删除虚拟机的备份机。&lt;/p>
&lt;ol>
&lt;li>单击名称侧带有&lt;img src="../../../images/computing/HA.png" alt="">图标的虚拟机的 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;高可用-删除备份机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出添加备份机对话框。&lt;/li>
&lt;li>若备份机所在宿主机离线，可勾选“强制清除备份机记录”。&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，删除备份机。&lt;/li>
&lt;/ol></description></item><item><title>Docs: 迁移相关</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/migrate/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/migrate/</guid><description>
&lt;h2 id="介绍">介绍&lt;/h2>
&lt;p>目前迁移功能主要用于 Cloudpods 内置私有云的虚拟机上，该功能用于将虚拟机迁移到其他宿主机上面。当未指定宿主机时，系统将自动选择宿主机。&lt;/p>
&lt;p>迁移的方式分为“冷迁移”和“热迁移”，区别如下：&lt;/p>
&lt;ul>
&lt;li>冷迁移：在虚拟机&lt;strong>关机的状态&lt;/strong>下，将虚拟机磁盘从源宿主机拷贝到目标宿主机。&lt;/li>
&lt;li>热迁移：在虚拟机&lt;strong>运行的状态&lt;/strong>下，将虚拟机的磁盘以及内存状态同步到目标宿主机，当两边数据同步后，再将虚拟机切换到目标宿主机。&lt;/li>
&lt;/ul>
&lt;p>热迁移和冷迁移比起来，能够在不关机，保证业务运行的情况下，将虚拟机从一台宿主机迁移到另一台宿主机。&lt;/p>
&lt;p>但热迁移默认要求目标宿主机和源宿主机的 CPU microcode 一致，可以通过以下命令查看 CPU 的 microcode：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ cat /proc/cpuinfo &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep microcode &lt;span style="color:#000;font-weight:bold">|&lt;/span> uniq
microcode : 0xca
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="界面操作">界面操作&lt;/h2>
&lt;h3 id="迁移">迁移&lt;/h3>
&lt;p>该功能用于将虚拟机迁移到其他宿主机上面。当未指定宿主机时，系统将自动选择宿主机。&lt;/p>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ul>
&lt;li>高可用的虚拟机不支持迁移。&lt;/li>
&lt;li>挂载了GPU设备或光驱设备的虚拟机不支持迁移。&lt;/li>
&lt;/ul>
&lt;/div>
&lt;p>&lt;strong>单个虚拟机迁移&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/li>
&lt;li>单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;高可用-迁移&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出迁移对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>强制迁移：若宿主机宕机，且虚拟机使用共享存储，可勾选“强制迁移”。&lt;/li>
&lt;li>跳过CPU检查：虚拟机迁移时，要求目的宿主机与虚拟机所在宿主机的CPU型号和微码相同，若宿主机CPU型号不一致仍想继续迁移，可开启跳过CPU检查，系统将会尽力而为的进行惹迁移，但是迁移完成后，可能会存在虚拟机在目标宿主机上无法正常运行的情况。&lt;/li>
&lt;li>宿主机：选择目标宿主机，也可留空，留空将由系统自动选择宿主机。平台会预先调度过滤出符合迁移条件的宿主机，如没有满足条件的宿主机，请检查在同一二层网络的宿主机上是否有可用的CPU、内存、存储，以及CPU型号和微码是否一样，若不一样，可先跳过CPU检查后尝试迁移等。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，将虚拟机迁移到其他宿主机上面。&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>批量迁移&lt;/strong>&lt;/p>
&lt;p>可以选择在不同宿主机的虚拟机迁移到同一个宿主机上。&lt;/p>
&lt;ol>
&lt;li>在虚拟机列表中选择一个或多个虚拟机，单击列表上方 &lt;strong>&lt;em>&amp;ldquo;批量操作&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;迁移&amp;rdquo;&lt;/em>&lt;/strong> 菜单项项，弹出迁移对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>强制迁移：若宿主机宕机，且虚拟机使用共享存储，可勾选“强制迁移”。&lt;/li>
&lt;li>跳过CPU检查：虚拟机迁移时，要求目的宿主机与虚拟机所在宿主机的CPU型号和微码相同，若宿主机CPU型号不一致仍想继续迁移，可开启跳过CPU检查，系统将会尽力而为的进行惹迁移，但是迁移完成后，可能会存在虚拟机在目标宿主机上无法正常运行的情况。&lt;/li>
&lt;li>宿主机：选择目标宿主机，也可留空，留空将由系统自动选择宿主机。平台会预先调度过滤出符合迁移条件的宿主机，如没有满足条件的宿主机，请检查在同一二层网络的宿主机上是否有可用的CPU、内存、存储，以及CPU型号和微码是否一样，若不一样，可先跳过CPU检查后尝试迁移等。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，将虚拟机迁移到其他宿主机上面。&lt;/li>
&lt;/ol>
&lt;h2 id="climc">Climc&lt;/h2>
&lt;h3 id="冷迁移">冷迁移&lt;/h3>
&lt;p>虚拟机在关机状态下，可以执行冷迁移操作。&lt;/p>
&lt;h4 id="查看冷迁移帮助信息">查看冷迁移帮助信息&lt;/h4>
&lt;p>冷迁移的命令为 &lt;code>climc server-migrate&lt;/code>，通过下面的命令可以查看参数的说明和帮助信息：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc &lt;span style="color:#204a87">help&lt;/span> server-migrate
Usage: climc server-migrate &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--auto-start&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--rescue-mode&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--prefer-host PREFER_HOST&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &amp;lt;ID&amp;gt;
Migrate server
Positional arguments:
&amp;lt;ID&amp;gt;
ID of server
Optional arguments:
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--auto-start&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Server auto start after migrate
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--rescue-mode&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Migrate server in rescue mode, all disks must reside on shared storage
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--prefer-host PREFER_HOST&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Server migration prefer host id or name
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="冷迁移举例">冷迁移举例&lt;/h4>
&lt;ul>
&lt;li>对已经关机的虚拟机 vm1 进行迁移&lt;/li>
&lt;/ul>
&lt;pre>&lt;code># 先查看虚拟机的信息
$ climc server-list --search vm1 --details
# 执行随机迁移
$ climc server-migrate vm1
# 迁移过程中虚拟机会处于 migrating 的状态
$ climc server-list --search vm1
# 迁移完成后虚拟机状态变为 ready，并且可以发现宿主机信息也发生了变化
$ climc server-list --search vm1 --details
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>迁移到指定宿主机&lt;/li>
&lt;/ul>
&lt;pre>&lt;code># 先列出平台的 kvm 宿主机
$ climc host-list --hypervisor kvm
# 然后指定宿主机名称或者 id 迁移
$ climc server-migrate --prefer-host xxx vm1
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>迁移后自动启动虚拟机&lt;/li>
&lt;/ul>
&lt;pre>&lt;code>$ climc server-migrate --auto-start vm1
$ climc server-migrate --auto-start --prefer-host xxx vm1
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>rescue mode 迁移：当宿主机完全宕机，虚拟机所有的磁盘都使用共享存储（ceph 等分布式块存储）的情况下，可以通过 rescue mode 把元数据迁移到另外的宿主机，然后启动&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-migrate --rescue-mode &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --auto-start &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host &lt;span style="color:#000">$host_name&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> &lt;span style="color:#000">$vm_name&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="热迁移">热迁移&lt;/h3>
&lt;p>虚拟机在运行状态进行的迁移叫做热迁移，热迁移的速度会比冷迁移慢，因为设计磁盘和内存等状态的同步，但好处是在不关机的状态下进行迁移，基本上对虚拟机上运行的业务没有影响。&lt;/p>
&lt;h4 id="查看热迁移帮助信息">查看热迁移帮助信息&lt;/h4>
&lt;p>热迁移的命令为 &lt;code>climc server-live-migrate&lt;/code>，通过下面的命令查看帮助信息：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc &lt;span style="color:#204a87">help&lt;/span> server-live-migrate
Usage: climc server-live-migrate &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--skip-cpu-check&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--prefer-host PREFER_HOST&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &amp;lt;ID&amp;gt;
Live-Migrate server
Positional arguments:
&amp;lt;ID&amp;gt;
ID of server
Optional arguments:
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--skip-cpu-check&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Skip check CPU mode of the target host
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--prefer-host PREFER_HOST&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
Server migration prefer host id or name
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="热迁移举例">热迁移举例&lt;/h4>
&lt;ul>
&lt;li>对虚拟机 vm1 进行热迁移，目标宿主机随机选择&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-live-migrate vm1
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>热迁移默认要求目标宿主机和虚拟机当前所在的宿主机 CPU microcode 一致， 如果不一致该宿主机则会被调度器过滤掉，如果环境里面实在没有 CPU 一致的目标宿主机，可以使用 &lt;code>--skip-cpu-check&lt;/code> 绕过 CPU microcode 的检查&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-live-migrate --skip-cpu-check vm1
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>指定 vm1 热迁移到目标宿主机 host1 ，并且绕过 CPU microcode 检查&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-live-migrate &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host host1 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --skip-cpu-check &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> vm1
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="宿主机宕机自动迁移">宿主机宕机自动迁移&lt;/h3>
&lt;h4 id="原理">原理&lt;/h4>
&lt;p>宿主机宕机自动迁移会自动检测宿主机的在线状况，当控制器（region）检测到宿主机离线，则会自动将宿主机上使用共享存储的虚拟机在别的宿主机上启动起来。宿主机宕机检测原理是 host会维持 etcd 上的一个 key (路径为：/onecloud/kvm/host/health/&amp;lt;host_id&amp;gt;)，region会watch这个key，一旦host离线，这个key会超时删除，region检测到这个事件后，开始把host上的共享存储主机强制迁移到别的宿主机。&lt;/p>
&lt;h4 id="开启宕机自动迁移">开启宕机自动迁移&lt;/h4>
&lt;p>通过如下步骤开启宕机自动迁移：&lt;/p>
&lt;h5 id="修改宿主机host配置">修改宿主机host配置&lt;/h5>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">vi /etc/yunion/host.conf
把
enable_health_checker: &lt;span style="color:#204a87">false&lt;/span>
改为true
enable_health_checker: &lt;span style="color:#204a87">true&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="修改region服务的配置">修改region服务的配置&lt;/h5>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">climc service-config-show region2
climc service-config-edit region2
把
enable_host_health_check: &lt;span style="color:#204a87">false&lt;/span>
改为
enable_host_health_check: &lt;span style="color:#204a87">true&lt;/span>
climc host-auto-migrate-on-host-down --enable &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>宿主机ID&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="重启服务">重启服务&lt;/h5>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubectl -n onecloud rollout restart daemonset default-host
kubectl -n onecloud rollout restart deployment default-region
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: GPU 相关</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/gpu/</link><pubDate>Fri, 19 Jul 2019 18:32:40 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/gpu/</guid><description>
&lt;p>目前仅支持 Cloudpods kvm 虚拟机使用 GPU，使用的 PCI Passthrough 的方式将宿主机上的 Nvidia/AMD GPU 透传给虚拟机使用。&lt;/p>
&lt;h2 id="界面操作">界面操作&lt;/h2>
&lt;h3 id="设置gpu卡">设置GPU卡&lt;/h3>
&lt;p>该功能用于设置为虚拟机绑定或解绑GPU卡，绑定GPU卡之前请确保虚拟机所在宿主机上存在GPU透传设备。当虚拟机用于高性能计算、图形显示等用途时，建议绑定GPU卡。&lt;/p>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ul>
&lt;li>仅Cloudpods平台支持绑定、解绑GPU卡功能。&lt;/li>
&lt;li>当宿主机上存在空闲的GPU设备时，宿主机上的虚拟机才可以绑定GPU卡。&lt;/li>
&lt;li>虚拟机关机状态才可以绑定、解绑GPU卡。&lt;/li>
&lt;li>批量绑定GPU卡操作仅支持关联同种型号的GPU卡，批量解绑会取消所有已关联的GPU卡。&lt;/li>
&lt;li>目前仅管理员支持设置GPU功能。&lt;/li>
&lt;/ul>
&lt;/div>
&lt;p>&lt;strong>单个虚拟机设置GPU卡&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/li>
&lt;li>单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;实例设置-设置GPU卡&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置GPU卡对话框。&lt;/li>
&lt;li>设置GPU卡页面支持绑定和解绑GPU卡。
&lt;ul>
&lt;li>绑定GPU卡：勾选是否绑定，并选择GPU卡，支持选择为虚拟机绑定多个GPU卡，默认勾选设置成功后自动启动，即绑定GPU卡后自动启动虚拟机，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮。&lt;/li>
&lt;li>解绑GPU卡：取消勾选是否绑定，取消后，则解绑虚拟机上的所有GPU卡，默认勾选设置成功后自动启动，即解绑GPU卡后自动启动虚拟机，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>批量为虚拟机设置GPU卡&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在虚拟机列表中选择一个或多个Cloudpods平台上关机状态的虚拟机，单击列表上方 &lt;strong>&lt;em>&amp;ldquo;批量操作&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;设置GPU卡&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置GPU卡对话框。&lt;/li>
&lt;li>设置GPU卡页面支持批量绑定和解绑GPU卡。
&lt;ul>
&lt;li>绑定GPU卡：设置GPU卡选择“关联GPU卡”，选择GPU卡型号，设置每台虚拟机上绑定的GPU卡数量，默认勾选批量绑定GPU后自动启动，即绑定GPU卡后自动启动虚拟机，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮。&lt;/li>
&lt;li>解绑GPU卡：设置GPU卡选择“解绑GPU卡”，默认勾选批量解绑成功后自动启动，即解绑GPU卡后自动启动虚拟机，单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，批量解绑GPU卡。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="在gpu透传设备页面关联虚拟机">在GPU透传设备页面关联虚拟机&lt;/h3>
&lt;ol>
&lt;li>在透传设备页面，单击GPU类型透传设备右侧操作列 &lt;strong>&lt;em>&amp;ldquo;关联虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 按钮，弹出关联虚拟机对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>选择虚拟机：选择需要关联透传设备的虚拟机。&lt;/li>
&lt;li>自动启动：挂载GPU设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，为GPU透传设备关联虚拟机。&lt;/li>
&lt;/ol>
&lt;h3 id="在gpu透传设备页面取消关联虚拟机">在GPU透传设备页面取消关联虚拟机&lt;/h3>
&lt;ol>
&lt;li>在透传设备页面，单击GPU类型透传设备右侧操作列 &lt;strong>&lt;em>&amp;ldquo;取消关联虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 按钮，弹出关联虚拟机对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>自动启动：卸载GPU设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，GPU透传设备取消关联虚拟机。&lt;/li>
&lt;/ol>
&lt;h2 id="climc">Climc&lt;/h2>
&lt;h3 id="创建-gpu-云主机">创建 GPU 云主机&lt;/h3>
&lt;ul>
&lt;li>查询 gpu 列表&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc isolated-device-list --gpu
+--------------------------------------+----------+---------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Dev_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Model &lt;span style="color:#000;font-weight:bold">|&lt;/span> Addr &lt;span style="color:#000;font-weight:bold">|&lt;/span> Vendor_device_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host_id &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+---------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 273f4f72-06b6-49aa-8456-4beceec44997 &lt;span style="color:#000;font-weight:bold">|&lt;/span> GPU-HPC &lt;span style="color:#000;font-weight:bold">|&lt;/span> GeForce GTX &lt;span style="color:#0000cf;font-weight:bold">1050&lt;/span> Ti &lt;span style="color:#000;font-weight:bold">|&lt;/span> 41:00.0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10de:1c82 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 3bce9607-2597-469f-8d9b-977345456739 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> a77333e9-08d9-45c6-87eb-a7d8d902c5f5 &lt;span style="color:#000;font-weight:bold">|&lt;/span> GPU-HPC &lt;span style="color:#000;font-weight:bold">|&lt;/span> Quadro FX &lt;span style="color:#0000cf;font-weight:bold">580&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> 05:00.0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10de:0659 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 3bce9607-2597-469f-8d9b-977345456739 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+---------------------+---------+------------------+--------------------------------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>创建 server&lt;/li>
&lt;/ul>
&lt;p>server-create 中的 &lt;code>--isolated-device&lt;/code> 参数指定透传的设备到云主机，可以重复使用多次，透传多个 gpu 到云主机，但要求透传到同一云主机的 gpu 必须在同一宿主机。其余创建参数和创建普通云主机是一样的。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-create --hypervisor kvm --isolated-device 273f4f72-06b6-49aa-8456-4beceec44997 ...
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="查询-gpu-云主机">查询 GPU 云主机&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-list --gpu
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="关联-gpu">关联 GPU&lt;/h3>
&lt;p>如果云主机所在的宿主机有可用的 gpu，在主机关机的情况下，可以通过 &lt;code>server-attach-isolated-device&lt;/code> 命令将 gpu 和云主机关联起来，下次主机启动后就可以使用该 gpu 。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-attach-isolated-device &amp;lt;server_id&amp;gt; &amp;lt;device_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="卸载-gpu">卸载 GPU&lt;/h3>
&lt;p>如果云主机关联了 gpu，可以通过 &lt;code>server-detach-isolated-device&lt;/code> 卸载主机的某一 gpu。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc server-detach-isolated-device &amp;lt;server_id&amp;gt; &amp;lt;device_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: USB 透传</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/usb-passthrough/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/usb-passthrough/</guid><description>
&lt;p>目前只有内置私有云平台的虚拟机可以使用宿主机上的 USB 设备。前提条件是宿主机需要有 &lt;code>lsusb&lt;/code> 这个工具，如果没有请安装 &lt;code>usbutils&lt;/code> 这个包。&lt;/p>
&lt;h2 id="配置宿主机">配置宿主机&lt;/h2>
&lt;p>查看宿主机上的 USB 设备，命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ lsusb
Bus &lt;span style="color:#0000cf;font-weight:bold">002&lt;/span> Device 002: ID 0951:1666 Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50
Bus &lt;span style="color:#0000cf;font-weight:bold">002&lt;/span> Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus &lt;span style="color:#0000cf;font-weight:bold">001&lt;/span> Device 002: ID 0627:0001 Adomax Technology Co., Ltd
Bus &lt;span style="color:#0000cf;font-weight:bold">001&lt;/span> Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
&lt;/code>&lt;/pre>&lt;/div>&lt;p>默认情况下宿主机透传 USB 设备功能是禁用的，需要在 &lt;code>/etc/yunion/host.conf&lt;/code> 配置文件里面设置 &lt;code>disable_usb: false&lt;/code> 。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ vim /etc/yunion/host.conf
...
disable_usb: &lt;span style="color:#204a87">false&lt;/span>
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>假设宿主机 hostname 为 &lt;code>oc-node-1&lt;/code>，然后重启宿主机服务，登录到控制节点，执行下面的命令：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 先找到对应的宿主机服务&lt;/span>
$ kubectl get pods -n onecloud -o wide &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep host &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep oc-node-1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> egrep -v &lt;span style="color:#4e9a06">&amp;#39;deployer|image&amp;#39;&lt;/span>
default-host-59k76 3/3 Running &lt;span style="color:#0000cf;font-weight:bold">7&lt;/span> 3d22h 192.168.121.21 oc-node-1 &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 删除宿主机上的 pod ，等待重建&lt;/span>
$ kubectl delete pods -n onecloud default-host-59k76
pod &lt;span style="color:#4e9a06">&amp;#34;default-host-59k76&amp;#34;&lt;/span> deleted
&lt;span style="color:#8f5902;font-style:italic"># 查看新创建的 host 服务&lt;/span>
$ kubectl get pods -n onecloud -o wide &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep host &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep oc-node-1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> egrep -v &lt;span style="color:#4e9a06">&amp;#39;deployer|image&amp;#39;&lt;/span>
default-host-6cl8w 3/3 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 17s 192.168.121.21 oc-node-1 &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 确保该服务变成 Running ，然后到云平台查看透传 USB 设备&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果宿主机很多，也可以使用 &lt;code>kubectl -n rollout restart daemonset default-host&lt;/code> 命令来重启所有宿主机上的 host 服务。&lt;/p>
&lt;h2 id="查看-usb-透传设备">查看 USB 透传设备&lt;/h2>
&lt;h3 id="climc-命令行查看透传设备">climc 命令行查看透传设备&lt;/h3>
&lt;p>使用命令行 &lt;code>climc isolated-device-list --details&lt;/code> 查看设备：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc isolated-device-list --details
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+--------------------------+----------+-------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Dev_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Model &lt;span style="color:#000;font-weight:bold">|&lt;/span> Addr &lt;span style="color:#000;font-weight:bold">|&lt;/span> Vendor_device_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host &lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest_status &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+--------------------------+----------+-------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 1541047f-0203-488a-8226-2de740da061f &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Adomax Technology Co., Ltd &lt;span style="color:#000;font-weight:bold">|&lt;/span> 001:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0627:0001 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span> oc-node-1-192-168-121-21 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> a3fa9bd4-236c-4c5b-8056-f7afa807138d &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 002:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0951:1666 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span> oc-node-1-192-168-121-21 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+--------------------------+----------+-------+--------------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="web界面查看透传设备">web界面查看透传设备&lt;/h3>
&lt;ol>
&lt;li>在透传设备页面，可以查看到宿主机上的USB透传设备。&lt;/li>
&lt;/ol>
&lt;p>现在云平台就有了宿主机 oc-node-1 上的 USB 透传设备，接下来就可以把这些设备给虚拟机使用。&lt;/p>
&lt;h2 id="虚拟机挂载-usb">虚拟机挂载 USB&lt;/h2>
&lt;p>USB 可以在虚拟机运行状态下挂载进去，可以在前端的透传设备列表那里把 USB 挂载到虚拟机里面，一个虚拟机可关联多个USB透传设备。但是一个USB透传设备仅可被一个虚拟机使用。&lt;/p>
&lt;h3 id="web界面挂载usb">web界面挂载USB&lt;/h3>
&lt;p>&lt;strong>在虚拟机页面挂载USB透传设备&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/li>
&lt;li>单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;实例设置-设置USB透传&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置USB透传对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>是否绑定：选择绑定USB透传设备。&lt;/li>
&lt;li>USB设备：当启用绑定USB透传设备后，显示该项，并选择具体的透传设备。&lt;/li>
&lt;li>自动启动：挂载USB设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，挂载或取消挂载USB透传设备。&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>在透传设备页面关联虚拟机&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在透传设备页面，单击USB类型透传设备右侧操作列 &lt;strong>&lt;em>&amp;ldquo;关联虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 按钮，弹出关联虚拟机对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>选择虚拟机：选择需要关联透传设备的虚拟机。&lt;/li>
&lt;li>自动启动：挂载USB设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，为USB透传设备关联虚拟机。&lt;/li>
&lt;/ol>
&lt;h3 id="climc命令行挂载usb设备">Climc命令行挂载USB设备&lt;/h3>
&lt;p>对应命令行操作如下 &lt;code>climc server-attach-isolated-device $server_id $device_id&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 比如虚拟机名称为 testvm，透传设备 id 为 a3fa9bd4-236c-4c5b-8056-f7afa807138d&lt;/span>
$ climc server-attach-isolated-device testvm a3fa9bd4-236c-4c5b-8056-f7afa807138d
&lt;span style="color:#8f5902;font-style:italic"># 然后登录到 testvm 虚拟机里面，执行 lsusb 就能看到宿主机的 USB 设备&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@testvm ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># lsusb&lt;/span>
Bus &lt;span style="color:#0000cf;font-weight:bold">002&lt;/span> Device 002: ID 0951:1666 Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="虚拟机卸载-usb">虚拟机卸载 USB&lt;/h2>
&lt;p>USB 可以在虚拟机运行状态下卸载 USB ，可以在前端的透传设备列表那里卸载 USB 对应的虚拟机。&lt;/p>
&lt;h3 id="web界面卸载usb">web界面卸载USB&lt;/h3>
&lt;p>&lt;strong>在虚拟机页面卸载USB透传设备&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在左侧导航栏，选择 &lt;strong>&lt;em>&amp;ldquo;主机/主机/虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，进入虚拟机页面。&lt;/li>
&lt;li>单击虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;实例设置-设置USB透传&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，弹出设置USB透传对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>是否绑定：关闭绑定USB透传设备。&lt;/li>
&lt;li>自动启动：挂载USB设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，挂载或取消挂载USB透传设备。&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>在透传设备页面取消关联虚拟机&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>在透传设备页面，单击USB类型透传设备右侧操作列 &lt;strong>&lt;em>&amp;ldquo;取消关联虚拟机&amp;rdquo;&lt;/em>&lt;/strong> 按钮，弹出关联虚拟机对话框。&lt;/li>
&lt;li>配置以下参数：
&lt;ul>
&lt;li>自动启动：卸载USB设备成功后虚拟机是否自动启动，仅虚拟机关机状态下生效。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>单击 &lt;strong>&lt;em>&amp;ldquo;确定&amp;rdquo;&lt;/em>&lt;/strong> 按钮，USB透传设备取消关联虚拟机。&lt;/li>
&lt;/ol>
&lt;h3 id="climc命令卸载usb">Climc命令卸载USB&lt;/h3>
&lt;p>对应命令行操作如下 &lt;code>climc server-detach-isolated-device $server_id $device_id&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 比如虚拟机名称为 testvm，透传设备 id 为 a3fa9bd4-236c-4c5b-8056-f7afa807138d&lt;/span>
$ climc server-detach-isolated-device testvm a3fa9bd4-236c-4c5b-8056-f7afa807138d
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="宿主机刷新设备">宿主机刷新设备&lt;/h2>
&lt;p>有些情况会频繁在宿主机上插拔 USB 设备，这样会导致云平台记录的 USB 设备信息和宿主机上的实际设备信息不一致，可以使用下面的命令 &lt;code>climc host-probe-isolated-devices $host_id&lt;/code> 进行设备信息同步：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 假设宿主机名称为 oc-node-1-192-168-121-21，看下目前的设备列表&lt;/span>
$ lsusb
Bus &lt;span style="color:#0000cf;font-weight:bold">002&lt;/span> Device 002: ID 0951:1666 Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50
Bus &lt;span style="color:#0000cf;font-weight:bold">001&lt;/span> Device 002: ID 0627:0001 Adomax Technology Co., Ltd
&lt;span style="color:#8f5902;font-style:italic"># 对应云平台的设备列表是一致的&lt;/span>
$ climc isolated-device-list --host oc-node-1-192-168-121-21
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Dev_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Model &lt;span style="color:#000;font-weight:bold">|&lt;/span> Addr &lt;span style="color:#000;font-weight:bold">|&lt;/span> Vendor_device_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host_id &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 1541047f-0203-488a-8226-2de740da061f &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Adomax Technology Co., Ltd &lt;span style="color:#000;font-weight:bold">|&lt;/span> 001:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0627:0001 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> a3fa9bd4-236c-4c5b-8056-f7afa807138d &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Kingston Technology DataTraveler &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> G3/G4/SE9 G2/50 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 002:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0951:1666 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+------------------------------------------------------+---------+------------------+--------------------------------------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;span style="color:#8f5902;font-style:italic"># 从上面看到有两个 USB 设备列表，然后我把 Kingston U 盘拔掉&lt;/span>
$ lsusb
Bus &lt;span style="color:#0000cf;font-weight:bold">001&lt;/span> Device 002: ID 0627:0001 Adomax Technology Co., Ltd
&lt;span style="color:#8f5902;font-style:italic"># 执行命令同步当前宿主机设备信息&lt;/span>
$ climc host-probe-isolated-devices oc-node-1-192-168-121-21
&lt;span style="color:#8f5902;font-style:italic"># 再查看设备列表就只有一个了，Kingston U 盘记录已经被删掉&lt;/span>
$ climc isolated-device-list --host oc-node-1-192-168-121-21
+--------------------------------------+----------+----------------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Dev_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Model &lt;span style="color:#000;font-weight:bold">|&lt;/span> Addr &lt;span style="color:#000;font-weight:bold">|&lt;/span> Vendor_device_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host_id &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+----------------------------+---------+------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> fa3cdbbd-7c54-4d2a-87cd-9362aa590a7d &lt;span style="color:#000;font-weight:bold">|&lt;/span> USB &lt;span style="color:#000;font-weight:bold">|&lt;/span> Adomax Technology Co., Ltd &lt;span style="color:#000;font-weight:bold">|&lt;/span> 001:002 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0627:0001 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 7a11731f-dcc0-41e5-8d64-68eb36defcbe &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+----------------------------+---------+------------------+--------------------------------------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 迁移磁盘存储</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/change-disk-storge/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/change-disk-storge/</guid><description>
&lt;p>在 v3.8.4 版本后可以把虚拟机的磁盘迁移到另一个存储，应用场景如下：&lt;/p>
&lt;ul>
&lt;li>Ceph RBD 磁盘迁移到本地存储&lt;/li>
&lt;li>本地磁盘迁移到 Ceph 存储&lt;/li>
&lt;li>Ceph RBD 磁盘迁移到另一个 Ceph 存储&lt;/li>
&lt;/ul>
&lt;p>另外限制条件如下：&lt;/p>
&lt;ul>
&lt;li>虚拟机必须是关机状态，运行状态迁移磁盘存储功能还未实现&lt;/li>
&lt;li>互相迁移的两个存储必须挂载到虚拟机所在的宿主机&lt;/li>
&lt;/ul>
&lt;p>假设环境中一台名叫 x86-node01-11-10-1-180-11 的宿主机分别挂载了一个 Ceph 存储和一个本地存储，用下面的命令可以查训到这台宿主机上挂载的存储：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc host-storage-list --host x86-node01-11-10-1-180-11 --details
+----------------------------------+----------------------------+-----------+---------------+----------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> Mount_point &lt;span style="color:#000;font-weight:bold">|&lt;/span> Capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Used_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Waste_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+---------------+----------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> wz_rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd:rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">241013618&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1556480&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> host_10.1.180.11_local_storage_0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> /opt/cloud/workspace/disks &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">681664&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">696320&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+---------------+----------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;p>通过上面的 &lt;code>climc host-storage-list&lt;/code> 命令找到 x86-node01-11-10-1-180-11 这台宿主机上面有 2 个存储，Ceph RBD 存储为 wz_rbd，本地存储为 host_10.1.180.11_local_storage_0 。&lt;/p>
&lt;h2 id="ceph-rbd-磁盘迁移到本地存储">Ceph RBD 磁盘迁移到本地存储&lt;/h2>
&lt;p>下面命令测试创建一台虚拟机到 wz_rbd Ceph 存储，然后把磁盘迁移到 host_10.1.180.11_local_storage_0 本地存储。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 首先创建一个名为 tvm-wz 虚拟机，磁盘使用 rbd，指定创建到宿主机&lt;/span>
$ climc server-create --disk CentOS-7.6.1810-20190430.qcow2:rbd &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --net vm-test-net &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --mem-spec 1g &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --ncpu &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --allow-delete &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --auto-start &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host x86-node01-11-10-1-180-11 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> tvm-wz
&lt;span style="color:#8f5902;font-style:italic"># 查看虚拟机的磁盘信息&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 找到对应的磁盘名称为 vdisk-tvm-wz-1636100820075603665&lt;/span>
$ climc server-disk-list --server tvm --details
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm-wz&lt;span style="color:#000;font-weight:bold">|&lt;/span> 65ca88b1-186f-440a-8930-b4914e62cb3d &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-tvm-wz-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 查看磁盘 vdisk-tvm-wz-1636100820075603665 所在的存储为 h3c_blockpool1&lt;/span>
$ climc disk-show vdisk-tvm-wz-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep storage
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> wz_rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在已经创建好使用 wz_rbd Ceph 存储的虚拟机了，接下来把这个 tvm-wz 虚拟机的 vdisk-tvm-wz-1636100820075603665 磁盘迁移到本地存储，命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 将虚拟机关机才能进行磁盘迁移存储&lt;/span>
$ climc server-stop tvm-wz
&lt;span style="color:#8f5902;font-style:italic"># 执行下面的 server-change-disk-storage 命令把 tvm 虚拟机的 vdisk-tvm-1636100820075603665 磁盘迁移到本地存储&lt;/span>
$ climc server-change-disk-storage tvm-wz vdisk-tvm-wz-1636100820075603665 host_10.1.180.11_local_storage_0
&lt;span style="color:#8f5902;font-style:italic"># 然后查看虚拟机的状态，磁盘迁移存储虚拟机会处于 disk_change_storage 的状态&lt;/span>
$ climc server-list --search tvm-wz --details
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 329bfce5-135f-4113-861e-bd44b8aaf9e0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm-wz &lt;span style="color:#000;font-weight:bold">|&lt;/span> postpaid &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10.2.18.252 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> disk_change_storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1024&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> Default &lt;span style="color:#000;font-weight:bold">|&lt;/span> default &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 等待虚拟机状态变为 ready 表示迁移完毕&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 然后再查看虚拟机的磁盘为 vdisk-tvm-wz-1636103786977105704&lt;/span>
$ climc server-disk-list --server tvm-wz --details
+--------+--------------------------------------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------+--------------------------------------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm-wz &lt;span style="color:#000;font-weight:bold">|&lt;/span> 61e4f0e4-597a-4aa9-8cde-0369879b9236 &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-tvm-wz-1636103786977105704 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">local&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------+--------------------------------------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 查看新的磁盘 vdisk-tvm-wz-1636103786977105704 的存储，发现已经变为本地存储了&lt;/span>
$ climc disk-show vdisk-tvm-wz-1636103786977105704 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep storage
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> host_10.1.180.11_local_storage_0 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> 4484274b-8483-4166-8e3f-f3c37c4b4997 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">local&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="本地磁盘迁移到-ceph-rbd-存储">本地磁盘迁移到 Ceph RBD 存储&lt;/h2>
&lt;p>还是利用之前创建好的 tvm-wz 虚拟机，现在虚拟机的磁盘为本地的 vdisk-tvm-wz-1636103786977105704 磁盘，执行下面的命令把该磁盘迁移到 wz_rbd Ceph 存储。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 迁移本地磁盘到 wz_rbd&lt;/span>
$ climc server-change-disk-storage tvm-wz vdisk-tvm-wz-1636103786977105704 wz_rbd
&lt;span style="color:#8f5902;font-style:italic"># 等待迁移完成后，再执行之前的命令查看先在虚拟机的磁盘，发现已经使用 wz_rbd 存储了&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 新的磁盘为 vdisk-tvm-wz-1636104909252150575&lt;/span>
$ climc server-disk-list --server tvm-wz --details
+--------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm-wz &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-tvm-wz-1636104909252150575 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------+----------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
$ climc disk-show vdisk-tvm-wz-1636104909252150575 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep storage
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> wz_rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> 061342a6-8f5a-4bc6-8757-8bb6c12bda83 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>测试迁移完成后，把虚拟机开机，能够正常启动，并且里面没有数据丢失，就没有问题。&lt;/p>
&lt;h2 id="ceph-rbd-磁盘迁移到另一个-ceph-存储">Ceph RBD 磁盘迁移到另一个 Ceph 存储&lt;/h2>
&lt;h3 id="两个-ceph-集群接口兼容">两个 Ceph 集群接口兼容&lt;/h3>
&lt;p>&lt;strong>注意&lt;/strong>：这种方法适用于源 Ceph 和目标 Ceph 集群兼容的情况，依赖的 rbd 动态库一致才行，不然会失败。&lt;/p>
&lt;p>假设环境中有另外一个叫做 wz_rbd 的 Ceph 存储，下面命令测试创建一台虚拟机到 h3c_blockpool1 Ceph 存储，然后把磁盘迁移到一个名为 wz_rbd 的 Ceph 存储。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 首先创建一个名为 tvm 虚拟机，磁盘使用 rbd，指定创建到宿主机&lt;/span>
$ climc server-create --disk CentOS-7.6.1810-20190430.qcow2:rbd &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --net vm-test-net &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --mem-spec 1g &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --ncpu &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --allow-delete &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --auto-start &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --prefer-host x86-node03-13-10-1-180-13 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> tvm
&lt;span style="color:#8f5902;font-style:italic"># 查看虚拟机的磁盘信息&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 找到对应的磁盘名称为 vdisk-tvm-1636100820075603665&lt;/span>
$ climc server-disk-list --server tvm --details
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tvm &lt;span style="color:#000;font-weight:bold">|&lt;/span> 65ca88b1-186f-440a-8930-b4914e62cb3d &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-tvm-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 查看磁盘 vdisk-tvm-1636100820075603665 所在的存储为 h3c_blockpool1&lt;/span>
$ climc disk-show vdisk-tvm-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep storage
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> h3c_blockpool1 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0bf0cf3c-8cc8-47bb-8d1e-ab97f103e267 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>现在已经创建好使用 h3c_blockpool1 Ceph 存储的虚拟机了，接下来把这个 tvm 虚拟机的 vdisk-tvm-1636100820075603665 磁盘迁移到另一个 Ceph 存储 wz_rbd，命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 首先需要把 wz_rbd 存储挂载到虚拟机所在的宿主机 x86-node03-13-10-1-180-13&lt;/span>
$ climc host-storage-attach x86-node03-13-10-1-180-13 wz_rbd
&lt;span style="color:#8f5902;font-style:italic"># 查看宿主机上挂载的存储，会发现多一块存储 wz_rbd&lt;/span>
$ climc host-storage-list --host x86-node03-13-10-1-180-13 --details
+----------------------------------+----------------------------+-----------+---------------+----------------+---------------+----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> Mount_point &lt;span style="color:#000;font-weight:bold">|&lt;/span> Capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Used_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Waste_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> Free_capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span> cmtbound &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+---------------+----------------+---------------+----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> wz_rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd:rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">241018691&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1525760&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">239462208&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> h3c_blockpool1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd:.HDDdisk.rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">192653544&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">122880&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">192530656&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> host_10.1.180.13_local_storage_0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> /opt/cloud/workspace/disks &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">681664&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">61440&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">620224&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+---------------+----------------+---------------+----------+
&lt;span style="color:#8f5902;font-style:italic"># 将虚拟机关机才能进行磁盘迁移存储&lt;/span>
$ climc server-stop tvm
&lt;span style="color:#8f5902;font-style:italic"># 执行下面的 server-change-disk-storage 命令把 tvm 虚拟机的 vdisk-tvm-1636100820075603665 磁盘迁移到 wz_rbd 存储&lt;/span>
$ climc server-change-disk-storage tvm vdisk-tvm-1636100820075603665 wz_rbd
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="两个-ceph-集群不兼容">两个 Ceph 集群不兼容&lt;/h3>
&lt;p>如果两个 Ceph 集群不兼容，比如一边用的开源 Ceph 集群，另外一边用的是商业 Ceph 集群，两套集群的动态库不一致就无法把两个 Ceph 存储挂载到平台的一台宿主机上。&lt;/p>
&lt;p>遇到这种情况可以采取一个利用 NFS 存储作为中转的变通解决方案，假设 host1 计算节点挂载了 Ceph1，上面有台虚拟机 vm 使用了 Ceph1，要把 vm 迁移到 host2 的 Ceph2 集群里面，步骤如下：&lt;/p>
&lt;ol>
&lt;li>自己搭建一个 NFS 服务，在云平台前端创建 NFS 存储&lt;/li>
&lt;li>然后在平台前端把这个 NFS 存储分别挂载到 host1 和 host2&lt;/li>
&lt;li>把 host1 上的 vm 调用 server-change-disk-storage 把 Ceph1 里面的磁盘迁移到 NFS 存储&lt;/li>
&lt;li>然后调用 server-migrate 命令或者去前段进行迁移操作，把 vm 迁移到 host2&lt;/li>
&lt;li>最后再调用 server-change-disk-storage 把 host2 上的 vm 磁盘迁移到 Ceph2&lt;/li>
&lt;/ol>
&lt;p>接下来是操作的命令行步骤：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 假设 NFS 服务器的地址为 172.16.254.124&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 共享的目录为 /opt/nfs_data&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 在平台创建对应的 nfs-store 存储&lt;/span>
$ climc storage-create --storage-type nfs &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --capacity &lt;span style="color:#0000cf;font-weight:bold">1024000&lt;/span> &lt;span style="color:#4e9a06">\ &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 容量根据实际情况填写&lt;/span>
--nfs-host 172.16.254.124 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --nfs-shared-dir &lt;span style="color:#4e9a06">&amp;#39;/opt/nfs_data&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> nfs-store zone0
&lt;span style="color:#8f5902;font-style:italic"># 然后把 nfs-store 挂载到 host1 和 host2 的 /opt/nfs_share 目录&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 需要登录 host1 和 host2 创建 /opt/nfs_share 目录&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@host1&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> $ mkdir -p /opt/nfs_share
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@host2&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> $ mkdir -p /opt/nfs_share
&lt;span style="color:#8f5902;font-style:italic"># 在平台挂载 nfs-store 到 host1 和 host2 &lt;/span>
$ climc host-storage-attach --mount-point /opt/nfs_share host1 nfs-store
$ climc host-storage-attach --mount-point /opt/nfs_share host2 nfs-store
&lt;span style="color:#8f5902;font-style:italic"># 把 host1 上的 vm 磁盘改为 nfs-store&lt;/span>
$ climc server-disk-list --server vm --details
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> vm&lt;span style="color:#000;font-weight:bold">|&lt;/span> 65ca88b1-186f-440a-8930-b4914e62cb3d &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-vm-wz-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 执行下面的 server-change-disk-storage 命令把 vm 虚拟机的磁盘迁移到 nfs-store&lt;/span>
$ climc server-change-disk-storage vm vdisk-vm-wz-1636100820075603665 nfs-store
&lt;span style="color:#8f5902;font-style:italic"># 等待虚拟机 vm 状态变为 ready 后&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 再把虚拟机迁移到 host2&lt;/span>
$ climc server-migrate --prefer-host host2 vm
&lt;span style="color:#8f5902;font-style:italic"># 然后再调用 server-change-disk-storage 把 vm 虚拟机磁盘迁移到 ceph2 存储&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 找到现在磁盘为 vdisk-vm-1636100820075603665，发现类型 Storage_type 为 nfs&lt;/span>
$ climc server-disk-list --server vm --details
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Guest &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Driver &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cache_mode &lt;span style="color:#000;font-weight:bold">|&lt;/span> Index &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> vm&lt;span style="color:#000;font-weight:bold">|&lt;/span> 65ca88b1-186f-440a-8930-b4914e62cb3d &lt;span style="color:#000;font-weight:bold">|&lt;/span> vdisk-vm-1636100820075603665 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> scsi &lt;span style="color:#000;font-weight:bold">|&lt;/span> none &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> ready &lt;span style="color:#000;font-weight:bold">|&lt;/span> sys &lt;span style="color:#000;font-weight:bold">|&lt;/span> nfs &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-------+--------------------------------------+-------------------------------+-----------+--------+------------+-------+--------+-----------+--------------+
&lt;span style="color:#8f5902;font-style:italic"># 查看宿主机 host2 上挂载的存储&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 发现有 nfs-store 和 ceph2&lt;/span>
$ climc host-storage-list --host host2 --details
+----------------------------------+----------------------------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Storage &lt;span style="color:#000;font-weight:bold">|&lt;/span> Mount_point &lt;span style="color:#000;font-weight:bold">|&lt;/span> Capacity &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ceph2 &lt;span style="color:#000;font-weight:bold">|&lt;/span> rbd:rbd &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">241018691&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> nfs &lt;span style="color:#000;font-weight:bold">|&lt;/span> /opt/nfs_share &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1024000&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">122880&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> host_10.1.180.13_local_storage_0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> /opt/cloud/workspace/disks &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">681664&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----------------------------------+----------------------------+-----------++
&lt;span style="color:#8f5902;font-style:italic"># 把虚拟机 vm 磁盘迁移到 ceph2&lt;/span>
$ climc server-change-disk-storage vm vdisk-vm-1636100820075603665 ceph2
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="其他注意事项">其他注意事项&lt;/h2>
&lt;ul>
&lt;li>更改存储的旧磁盘会删除到回收站，会占用实际的物理空间，如果确定这些旧的磁盘不使用了，可以在回收站里面清理。&lt;/li>
&lt;/ul>
&lt;h2 id="磁盘更改存储的原理">磁盘更改存储的原理&lt;/h2>
&lt;p>目前磁盘更改存储底层使用了 &lt;code>qemu-img convert&lt;/code> 的命令来进行磁盘底层存储变更，在云平台执行了 &lt;code>climc server-change-disk-storage&lt;/code> 命令后，可以登录到虚拟机所在的宿主机，执行下面的命令，就可以看到这个 &lt;code>qemu-img convert&lt;/code> 的进程：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ps faux &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep qemu-img &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep convert
root &lt;span style="color:#0000cf;font-weight:bold">3701532&lt;/span> 13.8 0.1 &lt;span style="color:#0000cf;font-weight:bold">1516864&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">102056&lt;/span> ? Ssl 17:35 0:00 &lt;span style="color:#4e9a06">\_&lt;/span> /usr/local/qemu-2.12.1/bin/qemu-img convert -f qcow2 -O raw /opt/cloud/workspace/disks/61e4f0e4-597a-4aa9-8cde-0369879b9236 rbd:rbd/d55671c1-ec1b-4c2c-87cb-aa4aa517744e:mon_host&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>172.16.2.31&lt;span style="color:#4e9a06">\;&lt;/span>172.16.2.32&lt;span style="color:#4e9a06">\;&lt;/span>172.16.2.33:key&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>AQBBi1RhiSvXChAAnFzGrpAGM5N8dWb3rTdQwQ&lt;span style="color:#4e9a06">\=\=&lt;/span>:rados_osd_op_timeout&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1200:client_mount_timeout&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>120:rados_mon_op_timeout&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">5&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 性能测试</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/perf-test/</link><pubDate>Fri, 19 Jul 2019 17:38:36 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/perf-test/</guid><description>
&lt;h3 id="cpu和内存性能测试">CPU和内存性能测试&lt;/h3>
&lt;h4 id="测试环境">测试环境&lt;/h4>
&lt;p>操作系统: CentOS 7
云平台版本: &amp;gt;= v3.7.7
宿主机: Dell PowerEdge R730xd
- CPU: Intel(R) Xeon(R) CPU E5-2678 v3 @ 2.50GHz
- 内存: DDR4 2133 MHz 256GB (16GB x 16)
- 磁盘: 机械盘 20TB PERC H730P Mini (RAID 10)
- 网卡: 10000Mb/s&lt;/p>
&lt;h4 id="安装测试软件">安装测试软件&lt;/h4>
&lt;p>测试工具:&lt;/p>
&lt;ul>
&lt;li>UnixBench: 测试虚拟机CPU性能&lt;/li>
&lt;li>mbw: 测试内存性能&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 安装 UnixBench&lt;/span>
$ yum install -y git gcc autoconf gcc-c++ &lt;span style="color:#204a87">time&lt;/span> perl-Time-HiRes
$ git clone https://github.com/kdlucas/byte-unixbench.git
&lt;span style="color:#8f5902;font-style:italic"># 安装 mbw&lt;/span>
$ git clone https://github.com/raas/mbw.git &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#204a87">cd&lt;/span> mbw
$ make &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> ./mbw &lt;span style="color:#0000cf;font-weight:bold">512&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="cpu-测试">CPU 测试&lt;/h4>
&lt;p>测试命令:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ &lt;span style="color:#204a87">cd&lt;/span> byte-unixbench/UnixBench
$ ./Run -c &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> whetstone-double dhry2reg fsdisk
&lt;/code>&lt;/pre>&lt;/div>&lt;p>结论:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>指标&lt;/th>
&lt;th>物理机&lt;/th>
&lt;th>虚拟机&lt;/th>
&lt;th>虚拟化开销（物理机-虚拟机/ 物理机）&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Dhrystone&lt;/td>
&lt;td>34839728.4 lps&lt;/td>
&lt;td>33964545.0 lps&lt;/td>
&lt;td>2.5%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Double-Precision Whetstone&lt;/td>
&lt;td>4368.3 MWIPS&lt;/td>
&lt;td>4244.3 MWIPS&lt;/td>
&lt;td>2.8%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>File Copy&lt;/td>
&lt;td>1825548.4 KBps&lt;/td>
&lt;td>1788048.3 KBps&lt;/td>
&lt;td>2.1%&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="内存测试">内存测试&lt;/h4>
&lt;p>结论:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>指标&lt;/th>
&lt;th>物理机&lt;/th>
&lt;th>虚拟机&lt;/th>
&lt;th>虚拟化开销（物理机-虚拟机/物理机）&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>MEMCPY AVG&lt;/td>
&lt;td>7578.348 MiB/s&lt;/td>
&lt;td>6254.520 MiB/s&lt;/td>
&lt;td>1.7%&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="本地存储io测试">本地存储IO测试&lt;/h3>
&lt;h4 id="测试方法">测试方法&lt;/h4>
&lt;p>采用fio，分别用如下场景和命令测试：&lt;/p>
&lt;ul>
&lt;li>4KB随机读&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>random-read --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>randread --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4k --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">16&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>4KB随机写&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>random-write --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>randwrite --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4k --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">16&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --end_fsync&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>4K顺序读&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>random-read --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#204a87">read&lt;/span> --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4k --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">16&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>4K顺序写&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>random-write --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>write --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4k --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>4g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">16&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --end_fsync&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>1MB顺序读&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>seq-read --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#204a87">read&lt;/span> --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1m --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>16g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>1MB顺序写&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">fio --name&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>seq-write --ioengine&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>posixaio --rw&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>write --bs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1m --size&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>16g --numjobs&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --iodepth&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --runtime&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> --time_based --direct&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --end_fsync&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="测试环境-1">测试环境&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>物理机&lt;/p>
&lt;p>OS: CentOS Linux release 7.9.2009 (Core)
内核：3.10.0-1062.4.3.el7.yn20191203.x86_64
CPU: Intel(R) Xeon(R) CPU E5-2678 v3 @ 2.50GHz
内存：256G
RAID控制器：Broadcom / LSI MegaRAID SAS-3 3108
RAID Level: RAID10&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Linxu 虚拟机&lt;/p>
&lt;p>OS: CentOS Linux release 7.6.1810 (Core)
内核：3.10.0-957.12.1.el7.x86_64
配置：4核CPU4G内存30G系统盘100G数据盘&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Windows 虚拟机&lt;/p>
&lt;p>OS: Windows Server 2008 R2 Datacenter 6.1
配置：4核CPU4G内存40G系统盘100G数据盘&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="测试结果">测试结果&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>场景&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">随机读&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">随机写&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">顺序读&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">顺序写&lt;/th>
&lt;th style="text-align:right">1MB&lt;/th>
&lt;th style="text-align:left">顺序读&lt;/th>
&lt;th style="text-align:right">1MB&lt;/th>
&lt;th style="text-align:left">顺序写&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>物理机&lt;/td>
&lt;td style="text-align:right">195&lt;/td>
&lt;td style="text-align:left">782KiB/s&lt;/td>
&lt;td style="text-align:right">7349&lt;/td>
&lt;td style="text-align:left">28.7MiB/s&lt;/td>
&lt;td style="text-align:right">22.1k&lt;/td>
&lt;td style="text-align:left">86.3MiB/s&lt;/td>
&lt;td style="text-align:right">24.5k&lt;/td>
&lt;td style="text-align:left">95.8MiB/s&lt;/td>
&lt;td style="text-align:right">1055&lt;/td>
&lt;td style="text-align:left">1056MiB/s&lt;/td>
&lt;td style="text-align:right">1117&lt;/td>
&lt;td style="text-align:left">1118MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;td style="text-align:right">(100%)&lt;/td>
&lt;td style="text-align:left">(100%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Linux 虚拟机&lt;/td>
&lt;td style="text-align:right">245&lt;/td>
&lt;td style="text-align:left">981KiB/s&lt;/td>
&lt;td style="text-align:right">6096&lt;/td>
&lt;td style="text-align:left">23.8MiB/s&lt;/td>
&lt;td style="text-align:right">9458&lt;/td>
&lt;td style="text-align:left">36.9MiB/s&lt;/td>
&lt;td style="text-align:right">6278&lt;/td>
&lt;td style="text-align:left">24.5MiB/s&lt;/td>
&lt;td style="text-align:right">979&lt;/td>
&lt;td style="text-align:left">980MiB/s&lt;/td>
&lt;td style="text-align:right">1058&lt;/td>
&lt;td style="text-align:left">1059MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=none)&lt;/td>
&lt;td style="text-align:right">(126%)&lt;/td>
&lt;td style="text-align:left">(125%)&lt;/td>
&lt;td style="text-align:right">(83%)&lt;/td>
&lt;td style="text-align:left">(83%)&lt;/td>
&lt;td style="text-align:right">(43%)&lt;/td>
&lt;td style="text-align:left">(43%)&lt;/td>
&lt;td style="text-align:right">(26%)&lt;/td>
&lt;td style="text-align:left">(26%)&lt;/td>
&lt;td style="text-align:right">(93%)&lt;/td>
&lt;td style="text-align:left">(93%)&lt;/td>
&lt;td style="text-align:right">(95%)&lt;/td>
&lt;td style="text-align:left">(95%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Linux 虚拟机&lt;/td>
&lt;td style="text-align:right">243&lt;/td>
&lt;td style="text-align:left">973KiB/s&lt;/td>
&lt;td style="text-align:right">7483&lt;/td>
&lt;td style="text-align:left">29.2MiB/s&lt;/td>
&lt;td style="text-align:right">11.5k&lt;/td>
&lt;td style="text-align:left">44.9MiB/s&lt;/td>
&lt;td style="text-align:right">7271&lt;/td>
&lt;td style="text-align:left">28.4MiB/s&lt;/td>
&lt;td style="text-align:right">958&lt;/td>
&lt;td style="text-align:left">959MiB/s&lt;/td>
&lt;td style="text-align:right">1052&lt;/td>
&lt;td style="text-align:left">1052MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=none,queues=4)&lt;/td>
&lt;td style="text-align:right">(125%)&lt;/td>
&lt;td style="text-align:left">(124%)&lt;/td>
&lt;td style="text-align:right">(102%)&lt;/td>
&lt;td style="text-align:left">(102%)&lt;/td>
&lt;td style="text-align:right">(52%)&lt;/td>
&lt;td style="text-align:left">(52%)&lt;/td>
&lt;td style="text-align:right">(30%)&lt;/td>
&lt;td style="text-align:left">(30%)&lt;/td>
&lt;td style="text-align:right">(91%)&lt;/td>
&lt;td style="text-align:left">(91%)&lt;/td>
&lt;td style="text-align:right">(94%)&lt;/td>
&lt;td style="text-align:left">(94%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Linux 虚拟机&lt;/td>
&lt;td style="text-align:right">13.0k&lt;/td>
&lt;td style="text-align:left">54.5MiB/s&lt;/td>
&lt;td style="text-align:right">8360&lt;/td>
&lt;td style="text-align:left">32.7MiB/s&lt;/td>
&lt;td style="text-align:right">13.1k&lt;/td>
&lt;td style="text-align:left">51.3MiB/s&lt;/td>
&lt;td style="text-align:right">8976&lt;/td>
&lt;td style="text-align:left">35.1MiB/s&lt;/td>
&lt;td style="text-align:right">2550&lt;/td>
&lt;td style="text-align:left">2551MiB/s&lt;/td>
&lt;td style="text-align:right">1045&lt;/td>
&lt;td style="text-align:left">1046MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=writeback)&lt;/td>
&lt;td style="text-align:right">(6667%)&lt;/td>
&lt;td style="text-align:left">(6969%)&lt;/td>
&lt;td style="text-align:right">(114%)&lt;/td>
&lt;td style="text-align:left">(114%)&lt;/td>
&lt;td style="text-align:right">(59%)&lt;/td>
&lt;td style="text-align:left">(59%)&lt;/td>
&lt;td style="text-align:right">(37%)&lt;/td>
&lt;td style="text-align:left">(37%)&lt;/td>
&lt;td style="text-align:right">(242%)&lt;/td>
&lt;td style="text-align:left">(242%)&lt;/td>
&lt;td style="text-align:right">(94%)&lt;/td>
&lt;td style="text-align:left">(94%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Linux 虚拟机&lt;/td>
&lt;td style="text-align:right">28.7k&lt;/td>
&lt;td style="text-align:left">112MiB/s&lt;/td>
&lt;td style="text-align:right">12.2k&lt;/td>
&lt;td style="text-align:left">47.5MiB/s&lt;/td>
&lt;td style="text-align:right">29.6k&lt;/td>
&lt;td style="text-align:left">116MiB/s&lt;/td>
&lt;td style="text-align:right">11.2k&lt;/td>
&lt;td style="text-align:left">43.8MiB/s&lt;/td>
&lt;td style="text-align:right">2931&lt;/td>
&lt;td style="text-align:left">2932MiB/s&lt;/td>
&lt;td style="text-align:right">1220&lt;/td>
&lt;td style="text-align:left">1220MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=writeback,queues=4)&lt;/td>
&lt;td style="text-align:right">(14718%)&lt;/td>
&lt;td style="text-align:left">(14322%)&lt;/td>
&lt;td style="text-align:right">(166%)&lt;/td>
&lt;td style="text-align:left">(166%)&lt;/td>
&lt;td style="text-align:right">(134%)&lt;/td>
&lt;td style="text-align:left">(134%)&lt;/td>
&lt;td style="text-align:right">(46%)&lt;/td>
&lt;td style="text-align:left">(46%)&lt;/td>
&lt;td style="text-align:right">(278%)&lt;/td>
&lt;td style="text-align:left">(278%)&lt;/td>
&lt;td style="text-align:right">(109%)&lt;/td>
&lt;td style="text-align:left">(109%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 虚拟机&lt;/td>
&lt;td style="text-align:right">2811&lt;/td>
&lt;td style="text-align:left">11.0MiB/s&lt;/td>
&lt;td style="text-align:right">6002&lt;/td>
&lt;td style="text-align:left">23.4MiB/s&lt;/td>
&lt;td style="text-align:right">11.8k&lt;/td>
&lt;td style="text-align:left">46.1MiB/s&lt;/td>
&lt;td style="text-align:right">4289&lt;/td>
&lt;td style="text-align:left">16.8MiB/s&lt;/td>
&lt;td style="text-align:right">1009&lt;/td>
&lt;td style="text-align:left">1009MiB/s&lt;/td>
&lt;td style="text-align:right">685&lt;/td>
&lt;td style="text-align:left">686MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=none)&lt;/td>
&lt;td style="text-align:right">(1441%)&lt;/td>
&lt;td style="text-align:left">(1407%)&lt;/td>
&lt;td style="text-align:right">(82%)&lt;/td>
&lt;td style="text-align:left">(82%)&lt;/td>
&lt;td style="text-align:right">(53%)&lt;/td>
&lt;td style="text-align:left">(53%)&lt;/td>
&lt;td style="text-align:right">(18%)&lt;/td>
&lt;td style="text-align:left">(18%)&lt;/td>
&lt;td style="text-align:right">(96%)&lt;/td>
&lt;td style="text-align:left">(96%)&lt;/td>
&lt;td style="text-align:right">(61%)&lt;/td>
&lt;td style="text-align:left">(61%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 虚拟机&lt;/td>
&lt;td style="text-align:right">2794&lt;/td>
&lt;td style="text-align:left">10.9MiB/s&lt;/td>
&lt;td style="text-align:right">7448&lt;/td>
&lt;td style="text-align:left">29.1MiB/s&lt;/td>
&lt;td style="text-align:right">21.1k&lt;/td>
&lt;td style="text-align:left">82.6MiB/s&lt;/td>
&lt;td style="text-align:right">25.5k&lt;/td>
&lt;td style="text-align:left">99.7MiB/s&lt;/td>
&lt;td style="text-align:right">930&lt;/td>
&lt;td style="text-align:left">930MiB/s&lt;/td>
&lt;td style="text-align:right">1013&lt;/td>
&lt;td style="text-align:left">1014MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=none,queues=4)&lt;/td>
&lt;td style="text-align:right">(1432%)&lt;/td>
&lt;td style="text-align:left">(1394%)&lt;/td>
&lt;td style="text-align:right">(101%)&lt;/td>
&lt;td style="text-align:left">(101%)&lt;/td>
&lt;td style="text-align:right">(95%)&lt;/td>
&lt;td style="text-align:left">(96%)&lt;/td>
&lt;td style="text-align:right">(104%)&lt;/td>
&lt;td style="text-align:left">(104%)&lt;/td>
&lt;td style="text-align:right">(88%)&lt;/td>
&lt;td style="text-align:left">(88%)&lt;/td>
&lt;td style="text-align:right">(91%)&lt;/td>
&lt;td style="text-align:left">(91%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 虚拟机&lt;/td>
&lt;td style="text-align:right">2483&lt;/td>
&lt;td style="text-align:left">9935KiB/s&lt;/td>
&lt;td style="text-align:right">7430&lt;/td>
&lt;td style="text-align:left">29.0MiB/s&lt;/td>
&lt;td style="text-align:right">10.9k&lt;/td>
&lt;td style="text-align:left">42.8MiB/s&lt;/td>
&lt;td style="text-align:right">13.6k&lt;/td>
&lt;td style="text-align:left">53.0MiB/s&lt;/td>
&lt;td style="text-align:right">1993&lt;/td>
&lt;td style="text-align:left">1994MiB/s&lt;/td>
&lt;td style="text-align:right">920&lt;/td>
&lt;td style="text-align:left">920MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=writeback)&lt;/td>
&lt;td style="text-align:right">(1273%)&lt;/td>
&lt;td style="text-align:left">(1270%)&lt;/td>
&lt;td style="text-align:right">(101%)&lt;/td>
&lt;td style="text-align:left">(101%)&lt;/td>
&lt;td style="text-align:right">(49%)&lt;/td>
&lt;td style="text-align:left">(50%)&lt;/td>
&lt;td style="text-align:right">(56%)&lt;/td>
&lt;td style="text-align:left">(55%)&lt;/td>
&lt;td style="text-align:right">(189%)&lt;/td>
&lt;td style="text-align:left">(189%)&lt;/td>
&lt;td style="text-align:right">(82%)&lt;/td>
&lt;td style="text-align:left">(82%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 虚拟机&lt;/td>
&lt;td style="text-align:right">4520&lt;/td>
&lt;td style="text-align:left">17.7MiB/s&lt;/td>
&lt;td style="text-align:right">18.8k&lt;/td>
&lt;td style="text-align:left">73.6MiB/s&lt;/td>
&lt;td style="text-align:right">23.3k&lt;/td>
&lt;td style="text-align:left">90.8MiB/s&lt;/td>
&lt;td style="text-align:right">21.8k&lt;/td>
&lt;td style="text-align:left">85.1MiB/s&lt;/td>
&lt;td style="text-align:right">2628&lt;/td>
&lt;td style="text-align:left">2628MiB/s&lt;/td>
&lt;td style="text-align:right">1191&lt;/td>
&lt;td style="text-align:left">1192MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>(cache=writeback,queues=4)&lt;/td>
&lt;td style="text-align:right">(2317%)&lt;/td>
&lt;td style="text-align:left">(2263%)&lt;/td>
&lt;td style="text-align:right">(2558%)&lt;/td>
&lt;td style="text-align:left">(2564%)&lt;/td>
&lt;td style="text-align:right">(105%)&lt;/td>
&lt;td style="text-align:left">(105%)&lt;/td>
&lt;td style="text-align:right">(89%)&lt;/td>
&lt;td style="text-align:left">(89%)&lt;/td>
&lt;td style="text-align:right">(249%)&lt;/td>
&lt;td style="text-align:left">(249%)&lt;/td>
&lt;td style="text-align:right">(106%)&lt;/td>
&lt;td style="text-align:left">(106%)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="测试结论">测试结论&lt;/h4>
&lt;ol>
&lt;li>和物理机相比，在4KB随机读写，1MB顺序读写方面，有10%左右的虚拟化开销。可以认为虚拟机性能和物理机相当。由于缓存的作用，虚拟机性能在某些场景甚至超过物理机。&lt;/li>
&lt;li>开启writeback和多队列之后，写性能有明显加速&lt;/li>
&lt;li>在4KB顺序读写性能方面，虚拟机仅有物理机的一半性能。这是因为磁盘采用thin provision方式，虚拟机内的顺序读写转换到物理机其实是随机读写。为了改善虚拟机4KB顺序读写性能，需要将虚拟磁盘文件进行预分配。这样虚拟机内的顺序读写在物理机也是顺序读写。&lt;/li>
&lt;/ol>
&lt;h3 id="共享存储cephio性能测试">共享存储(ceph)IO性能测试&lt;/h3>
&lt;h4 id="测试环境-2">测试环境&lt;/h4>
&lt;p>1、宿主机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.9.2009 (Core)
内核：3.10.0-1062.4.3.el7.yn20191203.x86_64
CPU: Intel(R) Xeon(R) CPU E5-2678 v3 @ 2.50GHz
内存：256GB
&lt;/code>&lt;/pre>
&lt;p>2、虚拟机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.6.1810 (Core)
内核：3.10.0-957.12.1.el7.x86_64
配置：4核CPU4G内存30G系统盘100G数据盘
&lt;/code>&lt;/pre>
&lt;p>3、Ceph存储配置&lt;/p>
&lt;pre>&lt;code>网卡：2x10G双光口存储网 + 2x10G双光口接入网
磁盘：全闪SSD
&lt;/code>&lt;/pre>
&lt;h4 id="测试数据">测试数据&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>场景&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">随机读&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">随机写&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">顺序读&lt;/th>
&lt;th style="text-align:right">4KB&lt;/th>
&lt;th style="text-align:left">顺序写&lt;/th>
&lt;th style="text-align:right">1MB&lt;/th>
&lt;th style="text-align:left">顺序读&lt;/th>
&lt;th style="text-align:right">1MB&lt;/th>
&lt;th style="text-align:left">顺序写&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;td style="text-align:right">IOPS&lt;/td>
&lt;td style="text-align:left">Throughput&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cache=none&lt;/td>
&lt;td style="text-align:right">1054&lt;/td>
&lt;td style="text-align:left">4217KiB/s&lt;/td>
&lt;td style="text-align:right">405&lt;/td>
&lt;td style="text-align:left">1622KiB/s&lt;/td>
&lt;td style="text-align:right">1864&lt;/td>
&lt;td style="text-align:left">7456KiB/s&lt;/td>
&lt;td style="text-align:right">552&lt;/td>
&lt;td style="text-align:left">2209KiB/s&lt;/td>
&lt;td style="text-align:right">159&lt;/td>
&lt;td style="text-align:left">159MiB/s&lt;/td>
&lt;td style="text-align:right">163&lt;/td>
&lt;td style="text-align:left">164MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cache=none,queues=4&lt;/td>
&lt;td style="text-align:right">1152&lt;/td>
&lt;td style="text-align:left">4608KiB/s&lt;/td>
&lt;td style="text-align:right">441&lt;/td>
&lt;td style="text-align:left">1767KiB/s&lt;/td>
&lt;td style="text-align:right">2066&lt;/td>
&lt;td style="text-align:left">8265KiB/s&lt;/td>
&lt;td style="text-align:right">368&lt;/td>
&lt;td style="text-align:left">1472KiB/s&lt;/td>
&lt;td style="text-align:right">168&lt;/td>
&lt;td style="text-align:left">169MiB/s&lt;/td>
&lt;td style="text-align:right">168&lt;/td>
&lt;td style="text-align:left">168MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cache=writeback&lt;/td>
&lt;td style="text-align:right">978&lt;/td>
&lt;td style="text-align:left">3913KiB/s&lt;/td>
&lt;td style="text-align:right">9425&lt;/td>
&lt;td style="text-align:left">36.8MiB/s&lt;/td>
&lt;td style="text-align:right">1623&lt;/td>
&lt;td style="text-align:left">6494KiB/s&lt;/td>
&lt;td style="text-align:right">10.7k&lt;/td>
&lt;td style="text-align:left">41.7MiB/s&lt;/td>
&lt;td style="text-align:right">149&lt;/td>
&lt;td style="text-align:left">149MiB/s&lt;/td>
&lt;td style="text-align:right">474&lt;/td>
&lt;td style="text-align:left">474MiB/s&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cache=writeback,queues=4&lt;/td>
&lt;td style="text-align:right">1071&lt;/td>
&lt;td style="text-align:left">4284KiB/s&lt;/td>
&lt;td style="text-align:right">12.6k&lt;/td>
&lt;td style="text-align:left">49.3MiB/s&lt;/td>
&lt;td style="text-align:right">1711&lt;/td>
&lt;td style="text-align:left">6848KiB/s&lt;/td>
&lt;td style="text-align:right">15.1k&lt;/td>
&lt;td style="text-align:left">59.1MiB/s&lt;/td>
&lt;td style="text-align:right">161&lt;/td>
&lt;td style="text-align:left">161MiB/s&lt;/td>
&lt;td style="text-align:right">475&lt;/td>
&lt;td style="text-align:left">475MiB/s&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="测试结论-1">测试结论&lt;/h4>
&lt;ol>
&lt;li>开启writeback和多队列能够明显提升写性能&lt;/li>
&lt;li>读性能比较难优化，可以调高虚拟机内的 read ahead 缓存（blockdev &amp;ndash;setra /dev/sda）&lt;/li>
&lt;li>Ceph并未把网络打满，也未能用满SSD的性能，性能瓶颈感觉还是在软件层面&lt;/li>
&lt;/ol>
&lt;h3 id="网络测试">网络测试&lt;/h3>
&lt;h4 id="测试条件">测试条件&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>默认情况下虚拟机有流量限制，需要在前端或者用命令行工具 &lt;code>climc server-change-bandwidth&lt;/code> 把带宽改为 0 ，表示取消限速。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>默认情况下，VPC虚拟机的EIP也有带宽限制（默认30Mbps），也需要在前端，或者用climc修改限制为0，表示取消限制。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h4 id="测试方法-1">测试方法:&lt;/h4>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 找一台机器运行 iperf server 模式，假设 ip 是 10.127.100.3&lt;/span>
$ iperf3 -s --bind 10.127.100.3
&lt;span style="color:#8f5902;font-style:italic"># 在另外一台机器作为 iperf client 模式连接 server&lt;/span>
$ iperf3 -c 10.127.100.3 -t &lt;span style="color:#0000cf;font-weight:bold">30&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>以上重复执行三次，取最好的一次。&lt;/p>
&lt;h4 id="经典网络性能测试">经典网络性能测试&lt;/h4>
&lt;h5 id="环境">环境&lt;/h5>
&lt;p>1、宿主机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.9.2009 (Core)
内核：3.10.0-1062.4.3.el7.yn20191203.x86_64
CPU: Intel(R) Xeon(R) CPU E5-2678 v3 @ 2.50GHz
内存：256GB
&lt;/code>&lt;/pre>
&lt;p>2、虚拟机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.6.1810 (Core)
内核：3.10.0-957.12.1.el7.x86_64
配置：2核CPU 2G内存 30G系统盘
&lt;/code>&lt;/pre>
&lt;h5 id="结论">结论&lt;/h5>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>源 \ 目的&lt;/th>
&lt;th>物理机&lt;/th>
&lt;th>虚拟机&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>物理机&lt;/td>
&lt;td>8.35 Gbps (100%)&lt;/td>
&lt;td>8.40 Gbps (101%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>虚拟机&lt;/td>
&lt;td>8.41 Gbps (101%)&lt;/td>
&lt;td>8.33 Gbps (99.7%)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>说明：饱和流量测试，网路虚拟化开销很低（1%量级）。&lt;/p>
&lt;h4 id="vpc网络性能测试">VPC网络性能测试&lt;/h4>
&lt;h5 id="测试环境-3">测试环境&lt;/h5>
&lt;p>1、宿主机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.7.1908 (Core)
内核：5.4.130-1.yn20210710.el7.x86_64
CPU: Intel(R) Xeon(R) Gold 5218R CPU @ 2.10GHz
内存：256GB
&lt;/code>&lt;/pre>
&lt;p>2、虚拟机配置：&lt;/p>
&lt;pre>&lt;code>OS: CentOS Linux release 7.8.2003
内核：3.10.0-1127.el7.x86_64
配置：2核CPU 2G内存 30G系统盘
&lt;/code>&lt;/pre>
&lt;h5 id="结论-1">结论&lt;/h5>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>场景&lt;/th>
&lt;th>物理机到物理机&lt;/th>
&lt;th>虚拟机到虚拟机&lt;/th>
&lt;th>虚拟机EIP到虚拟机EIP&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>性能 (Gbps)&lt;/td>
&lt;td>9.19 (100%)&lt;/td>
&lt;td>8.96 (97%)&lt;/td>
&lt;td>5.83 (63%)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>说明：饱和流量情况下，网络虚拟化开销很低（3%量级）。由于转换路径较长，EIP的性能要差很多（36%损耗）。&lt;/p></description></item><item><title>Docs: 内存大页(Hugepage)</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/hugepage/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/hugepage/</guid><description>
&lt;p>内置私有云支持虚拟机使用内存大页（Hugepage）。使用内存大页有助于减少内存碎片，提高虚拟机访问内存效率，从而提高虚拟机性能。&lt;/p>
&lt;p>通过设置每台宿主机的配置(/etc/yunion/host.conf) hugepages_option 来关闭或开启大页，该选项的值有三个：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>disable: 不开启大页支持&lt;/p>
&lt;/li>
&lt;li>
&lt;p>transparent：开启透明大页支持，该选项为默认选项。启用透明大页支持后，操作系统会尽力而为地为虚拟机使用大页内存，并且自动地将虚拟机的普通内存合并为大页内存。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>native：开启原生大页内存支持，这种模式需要显式地分配大页内存池，并且虚拟机使用的内存需要预先从大页内存池中预留分配，并作为参数传递给虚拟机使用。这种方式能够保证内存的连续性，可以分配1G的大页内存，提供最佳的性能。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>使用透明大页支持比较方便，只需要设置 hugepages_option 为 transparent。但这种方式无法使用1G的大页，并且并不保证虚拟机总是使用大页内存。&lt;/p>
&lt;h2 id="开启native大页内存">开启native大页内存&lt;/h2>
&lt;p>下面介绍启用native大页的方法：&lt;/p>
&lt;p>1、设置/etc/yunion/host.conf的hugepages_options 为native&lt;/p>
&lt;p>2、预留大页内存&lt;/p>
&lt;p>有两种方式: 自动和手动。&lt;/p>
&lt;p>2.1 自动预留大页内存&lt;/p>
&lt;p>重启宿主机，宿主机重启后，host服务会根据该宿主机的物理内存总量，减去预留内存量（mem_reserved），再减去kubelet Evition需要预留的内存（一般为500MB），剩下的内存预留。&lt;/p>
&lt;p>自动预留大页内存只能预留2MB的大页。&lt;/p>
&lt;p>2.2 手动预留大页内存&lt;/p>
&lt;p>手动方式需修改内核启动参数，在系统启动时刻就把大页内存预留出来。这种方式能够保证大页内存的空间连续性，能够域1GB的大页。但是1GB的大页预留后将无法修改。如果采用手动预留大页内存，建议预留1GB的大页。&lt;/p>
&lt;p>注意：使用1GB大页内存的虚拟机的内存必须是1GB的整数倍。&lt;/p>
&lt;p>下面是手动预留1GB大页内存的步骤：&lt;/p>
&lt;p>设置内核启动参数，让宿主机在启动后自动预留大页内存，需要设置如下两个参数：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>hugepagesz：大页内存的大小。对于x86_64的宿主机，一般支持2MB或1GB的大页。可以通过查看/proc/cpuinfo的flags判断宿主机支持哪种大页。如果flags中包含pse，则支持2MB大页。如果flags中包含pdpe1gb，则支持1GB大页。对于arm的宿主机，支持2MB或1GB的大页。推荐使用1GB大页。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>hugepages：预留大页的数量，总预留内存为 hugepagesz x hugepages。由于大页内存无法给操作系统使用，因此需要留足够的普通内存。一般是给操作系统预留至少10G，或10%的内存。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>举例：&lt;/p>
&lt;p>修改 /etc/default/grub，在GRUB_CMDLINE_LINUX末尾添加（宿主机有128GB内存，分配给大页110GB，给操作系统预留18GB内存）：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#000">hugepagesz&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1GB &lt;span style="color:#000">hugepages&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">110&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>然后执行&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">grub2-mkconfig -o /boot/grub2/grub.cfg（BIOS引导执行这个）
grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg（UEFI引导执行这个）
&lt;/code>&lt;/pre>&lt;/div>&lt;p>修改完成后，重启宿主机&lt;/p>
&lt;p>重启后，查看如下参数，确认1GB大页内存是否预留成功&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ cat /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages
&lt;span style="color:#0000cf;font-weight:bold">110&lt;/span>
$ cat /sys/kernel/mm/hugepages/hugepages-1048576kB/free_hugepages
&lt;span style="color:#0000cf;font-weight:bold">110&lt;/span>
$ free -h
total used free shared buff/cache available
Mem: 125G 113G 7.6G 4.5M 4.5G 11G
Swap: 0B 0B 0B
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 调试QEMU参数</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/customize/</link><pubDate>Fri, 19 Jul 2019 18:32:40 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/customize/</guid><description>
&lt;p>本文介绍如何调试 Cloudpods KVM虚拟机的配置参数。&lt;/p>
&lt;h2 id="hahahugoshortcode-s1-hbhb-kvm虚拟机的配置存储位置一般在宿主机的-optcloudworkspaceservers-下该位置可以修改-etcyunionhostconf-的-servers_path">Cloudpods KVM虚拟机的配置存储位置一般在宿主机的 /opt/cloud/workspace/servers 下，该位置可以修改 /etc/yunion/host.conf 的 servers_path&lt;/h2>
&lt;p>在 servers 目录下，每个虚拟机ID的目录存储了该虚拟机相关的配置文件，主要的文件有：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">3114&lt;/span> May &lt;span style="color:#0000cf;font-weight:bold">17&lt;/span> 10:53 desc
-rwx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">344&lt;/span> Jun &lt;span style="color:#0000cf;font-weight:bold">22&lt;/span> 10:07 &lt;span style="color:#204a87;font-weight:bold">if&lt;/span>-down-br0-vnet222-252.sh
-rwx------ &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">1074&lt;/span> Jun &lt;span style="color:#0000cf;font-weight:bold">22&lt;/span> 10:07 &lt;span style="color:#204a87;font-weight:bold">if&lt;/span>-up-br0-vnet222-252.sh
-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">2810&lt;/span> Jun &lt;span style="color:#0000cf;font-weight:bold">22&lt;/span> 10:07 startvm
-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root &lt;span style="color:#0000cf;font-weight:bold">661&lt;/span> Jun &lt;span style="color:#0000cf;font-weight:bold">22&lt;/span> 10:07 stopvm
&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中，startvm 为启动虚拟机的脚本文件，包含了该虚拟机启动的所有命令行参数，可以修改该文件的qemu启动参数来实现调试qemu启动参数的目的。&lt;/p>
&lt;p>一般步骤为：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>停止虚拟机&lt;/p>
&lt;/li>
&lt;li>
&lt;p>修改该虚拟机的startvm脚本参数&lt;/p>
&lt;/li>
&lt;li>
&lt;p>以root身份启动虚拟机：sh startvm&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在前端，对虚拟机执行“同步状态”的操作&lt;/p>
&lt;/li>
&lt;li>
&lt;p>同步状态后，前端显示该虚拟机为运行状态，即可查看该虚拟机的vnc终端，以及进行其他控制操作&lt;/p>
&lt;/li>
&lt;/ol></description></item><item><title>Docs: 查看虚拟机相关信息</title><link>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/show/</link><pubDate>Thu, 06 Jan 2022 18:19:20 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/vminstance/tutorial/show/</guid><description/></item></channel></rss>