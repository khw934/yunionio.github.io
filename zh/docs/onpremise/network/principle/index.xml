<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloudpods –
原理介绍</title><link>https://www.cloudpods.org/zh/docs/onpremise/network/principle/</link><description>Recent content in 原理介绍 on Cloudpods</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://www.cloudpods.org/zh/docs/onpremise/network/principle/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: 宿主机网络</title><link>https://www.cloudpods.org/zh/docs/onpremise/network/principle/host/</link><pubDate>Tue, 03 Aug 2021 10:53:20 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/network/principle/host/</guid><description>
&lt;h2 id="经典网络">经典网络&lt;/h2>
&lt;p>宿主机内通过host服务的配置项networks（/etc/yunion/host.conf）指定宿主机的网络配置，该配置指定宿主机的指定物理网卡对应的二层网络，有两种配置方式：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>网卡名称/网桥名称/网卡IP，例如：eth0/br0/192.168.222.10。这种配置模式告诉系统，宿主机的物理网卡eth0对接了192.168.222.10这个IP对应的IP子网对应的二层网络，并且将该物理网卡和网桥br0桥接。这种模式的物理网卡要被宿主机用来和外界通信，因此要配置一个有效的IP地址。在host服务启动时，会检测该IP是否配置在这个物理网卡上，如果不匹配，host服务会放弃启动。以此避免误配置该网卡。启动成功后，host服务会自动创建网桥，把物理网卡计入该网桥，并且把物理网卡上的IP配置信息迁移到网桥，以维持宿主机的正常网络通信。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>网卡名称/网桥名称/二层网络名称，例如：eth1/brpub/wire1。这种配置模式告诉系统，宿主机的物理网卡eth1对接了二层网络wire1，该网卡不需要配置有效IP地址，并且该物理网卡和网桥brpub桥接。这种模式的物理网卡不被宿主机用来通信，因此不需要显式地配置有效的IP地址。在host服务启动时，会检查该物理网卡是否没有IP，如果有IP，则会放弃启动。以此避免误操作。启动成功后，会自动创建网桥，把物理网卡加入该网桥，并且会自动分配一个169.254.0.0/16的IP给这个网桥。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="宿主机网络配置对调度的影响">宿主机网络配置对调度的影响&lt;/h3>
&lt;p>当创建一台经典网络的虚拟机，调度器会查看虚拟机准备对接的IP子网，根据IP子网的二层网络过滤出对接的宿主机，把这些宿主机作为候选宿主机。&lt;/p>
&lt;h3 id="vlan支持">VLAN支持&lt;/h3>
&lt;p>Cloudpods经典网络支持VLAN（802.1Q）。同一个经典网络下的二层网络的IP子网可以归属于不同的VLAN，这时需要设置IP子网的VLAN ID。IP子网的VLAN ID默认为1。&lt;/p>
&lt;p>当一个IP子网的VLAN ID不为1时，则虚拟机接入该IP子网的网络接口将自动加入该VLAN。其底层实现原理为，在把虚拟机的虚拟网络接口加入OVS网桥时，设置该接口的VLAN tag为指定tag。为了允许一台宿主机上的虚拟机能够加入不同的VLAN，需要将宿主机的物理网口设置为Trunk模式，以允许同一条物理链路上不同VLAN tag的报文能够同时通过。&lt;/p>
&lt;img src="../vm_vlan_access.png" width="500">
&lt;h4 id="host-vlan">Host VLAN&lt;/h4>
&lt;p>为了允许虚拟机接入不同的VLAN，宿主机对应的网络接口必须以TRUNK模式接入交换机。这时，如果宿主机也需要通过该网络接口通信，则需要根据情况进行设置。1）如果宿主机该网络接口的VLAN ID为默认VLAN（VLAN=1）时，则宿主机不需要做特殊配置。2）如果宿主机该网络接口的VLAN ID不为1，则有两种解决方案：&lt;/p>
&lt;p>（1）为该网络接口设置一个VLAN tag为宿主机VLAN的别名网口(Alias Interface)，将宿主机的IP地址配置在该别名网口上，宿主机将使用该别名网口通信。&lt;/p>
&lt;img src="../host_alias_vlan_nic.png" width="500">
&lt;p>以物理机的网口为em1，VLAN ID为100，em1的虚拟机网桥br0为例，以下为配置脚本：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">ip link add link em1 name em1.100 &lt;span style="color:#204a87">type&lt;/span> vlan id &lt;span style="color:#0000cf;font-weight:bold">100&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> ip addr flush dev br0 &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> ip addr add 10.192.4.20/22 dev em1.100 &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> ip link &lt;span style="color:#204a87">set&lt;/span> dev em1.100 up
&lt;/code>&lt;/pre>&lt;/div>&lt;p>（2）在交换机设置该trunk接口的默认VLAN ID为宿主机的VLAN ID。&lt;/p>
&lt;h4 id="brtrunk模式">BRTRUNK模式&lt;/h4>
&lt;p>在某些应用场景，例如用户在虚拟机内通过macvlan或网桥等技术为多个容器提供接入网络，用户可能有需要在虚拟机同一个网口虚拟多个vlan接口，发送多个VLAN tag的报文，这种情况下，需要做如下特殊设置，才能允许虚拟机的一个网口发送携带多个不同VLAN tag的报文：&lt;/p>
&lt;p>1）该网口对应的IP子网的VLAN ID为1（默认VLAN），这样从该网口发出的报文只会被OVS网桥透明转发，不会再打上VLAN tag。
2）该虚拟机需要关闭“源IP和MAC地址检查”（在主机菜单：网络与安全-设置源/目标检查）。
3）宿主机对应网口为trunk模式。
4）交换机在对应网口放行对应的VLAN tag。&lt;/p>
&lt;img src="../brtrunk.png" width="500">
&lt;h2 id="vpc网络">VPC网络&lt;/h2>
&lt;p>在host服务启动后，会在宿主机内创建用于vpc通信的网桥（默认名称为brvpc），所有对接VPC网络的虚拟机的虚拟网卡都要加入这个网桥。&lt;/p></description></item><item><title>Docs: 裸金属网络</title><link>https://www.cloudpods.org/zh/docs/onpremise/network/principle/baremetal/</link><pubDate>Tue, 03 Aug 2021 10:53:20 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/network/principle/baremetal/</guid><description>
&lt;p>目前，裸金属服务器只能使用经典网络。&lt;/p>
&lt;h2 id="经典网络">经典网络&lt;/h2>
&lt;p>一台裸金属服务器有多个网卡，系统需要检测出这台裸金属的每个网口跟哪个二层网络对接，这样在分配裸金属服务器时，才能根据二层网络信息选择正确的IP子网。&lt;/p>
&lt;p>系统通过两种方式探测裸金属的网卡对接的二层网络：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>自动探测：在裸金属的prepare阶段，裸金属会自动设置每个网卡进行dhcp探测，当这个网卡所在网络的交换机配置了dhcp relay，则会把发出的dhcp请求转发到baremetal agent。baremetal Agent根据dhcp报文的来源IP找到匹配的IP子网，从而判断出该物理机网卡归属的二层子网。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>手动设置：通过执行climc命令或者在前端界面，可以设置裸金属服务每个网卡对应的二层网络。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>对应的climc命令为：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">climc host-add-netif &amp;lt;host_id&amp;gt; &amp;lt;wire_id&amp;gt; &amp;lt;mac&amp;gt; &amp;lt;index&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="裸金属网络配置对调度的影响">裸金属网络配置对调度的影响&lt;/h3>
&lt;p>当用户申请一台裸金属服务器，并给定裸金属服务器对接的IP子网信息时，调度器会过滤出物理网口对接了该IP子网对应的二层网络的裸金属，作为候选。&lt;/p>
&lt;p>如果用户申请的裸金属服务器的网卡要做bonding，则调度器会选择同时具有两个网卡，并且两个网卡都对接了指定IP子网对应的二层网络。
如果不存在这样的物理机，则会报调度失败的错误。&lt;/p></description></item><item><title>Docs: 域名设置</title><link>https://www.cloudpods.org/zh/docs/onpremise/network/principle/dns/</link><pubDate>Tue, 03 Aug 2021 10:53:20 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/onpremise/network/principle/dns/</guid><description>
&lt;p>Cloudpods 虚拟机的域名涉及如下几个服务：&lt;/p>
&lt;ul>
&lt;li>region负责生成虚拟机的域名信息&lt;/li>
&lt;li>host负责通过dhcp将域名信息注入到虚拟机内&lt;/li>
&lt;li>region_dns负责虚拟机之间的域名解析，实现基于主机名和主机IP的解析。&lt;/li>
&lt;/ul>
&lt;p>每台虚拟机都需要配置其域名解析服务器和域名解析地址前缀，这两个信息是由region生成，并且同步到host，最后通过dhcp下发到虚拟机内部。&lt;/p>
&lt;p>region服务提供如下两个配置项指定虚拟机的dns服务器地址和搜索域名后缀&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>配置选项&lt;/th>
&lt;th>说明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>dns_server&lt;/td>
&lt;td>全局的dns服务器地址，默认为该集群内region_dns所在节点的IP&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>dns_domain&lt;/td>
&lt;td>全局的dns搜索后缀，默认值为 cloud.onecloud.io&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>同时，每个IP子网都有两个属性，用于override全局的region配置选项，提供个性化的域名服务器和后缀&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>属性&lt;/th>
&lt;th>说明&lt;/th>
&lt;th>默认值&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>guest_dns&lt;/td>
&lt;td>该IP子网的虚拟机的域名解析服务器地址&lt;/td>
&lt;td>region的dns_server选项&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>guest_domain&lt;/td>
&lt;td>该IP子网的虚拟机的域名后缀&lt;/td>
&lt;td>region的dns_domain选项&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item></channel></rss>