<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloudpods –
负载均衡</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/lb/</link><description>Recent content in 负载均衡 on Cloudpods</description><generator>Hugo -- gohugo.io</generator><language>zh</language><lastBuildDate>Fri, 19 Jul 2019 10:27:52 +0800</lastBuildDate><atom:link href="https://www.cloudpods.org/zh/docs/function_principle/onpremise/lb/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: 原理介绍</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/lb/principle/</link><pubDate>Wed, 22 Dec 2021 15:47:12 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/onpremise/lb/principle/</guid><description>
&lt;h2 id="概念">概念&lt;/h2>
&lt;p>在使用Cloudpods提供的负载均衡功能时，会用到以下术语&lt;/p>
&lt;p>负载均衡实例（Load Balancer），有时也简称为“实例”。实例与子网关联，创建实例时需要选择子网，实例的IP地址即从该子网中分配。&lt;/p>
&lt;p>一个实例下可以有多个负载均衡监听（Listener）。监听的类型通常有HTTP、HTTPS、TCP、UDP，每个监听还需指定一个端口。实例和监听联合起来即表达了服务面向外部的地址、协议和端口。&lt;/p>
&lt;p>后端服务器组（Backend Group）、后端服务器（Backend）。每个后端服务器指定了服务后端的IP和端口，同一个服务器组中的多个后端服务器提供相同服务。&lt;/p>
&lt;p>监听可指定后端服务器组，当用户访问监听所在地址时，负载均衡的转发节点会将请求转发给服务器组中的具体后端，从而实现负载均衡的效果。&lt;/p>
&lt;p>负载均衡集群是一组转发节点LBAgent的集合，一般情况下一个集群下配置两个LBAgent节点互为主备即可，同一集群下的LBAgent节点的VRRP路由ID必须相同。&lt;/p>
&lt;p>负载均衡转发节点用于监听负载均衡实例，并将客户端的请求根据监听和转发规则转发给后端服务器。同一个集群下可以有多个转发节点，但同一时刻只有一个节点作为Master节点提供转发服务。属于一个集群的节点的VRRP路由ID必须相同。&lt;/p>
&lt;p>节点生命周期管理：&lt;/p>
&lt;ol>
&lt;li>新建节点：设置节点的配置参数。&lt;/li>
&lt;li>部署节点：将节点的配置文件下发到指定机器，提供转发功能的机器可称为转发实例，当节点状态为Master时，表示集群中的节点可正常提供负载均衡转发服务。&lt;/li>
&lt;li>下线节点：当不需要节点提供服务时，可下线节点，将配置文件从转发实例上删除。&lt;/li>
&lt;li>删除节点：删除节点的配置文件信息等。&lt;/li>
&lt;/ol>
&lt;h3 id="httphttps类型监听">HTTP/HTTPS类型监听&lt;/h3>
&lt;p>对于HTTP/HTTPS类型的监听，我们还可以创建“转发策略（Listener Rule）”，利用HTTP协议的特点，来进一步复用监听的地址和端口。转发策略包含路径、域名属性，用来匹配来自用户的HTTP请求。每个转发策略又可指定自己的后端服务器组，当请求中的路径、域名匹配时，负载均衡会将其转发到此后端组中的服务器。&lt;/p>
&lt;pre>&lt;code> ___ Host: src0.example.com -&amp;gt; srv0 backendGroup
/
HTTP/80
\
--- Host: srv1.example.com -&amp;gt; srv1 backendGroup
&lt;/code>&lt;/pre>
&lt;p>HTTPS类型的监听需要绑定TLS证书。Cloudpods平台支持RSA、EC2证书&lt;/p>
&lt;h3 id="访问控制">访问控制&lt;/h3>
&lt;p>Cloudpods支持创建访问控制列表，列表中指定网络CIDR。监听可与访问控制列表关联，并指定将该列表应用为白名单、黑名单。作为白名单时，仅来源IP为列表中地址的请求被接受，其余请求将被拒绝。黑名单时，列表中的网络将被拒绝服务，列表外的地址可访问。&lt;/p></description></item><item><title>Docs: Lbagent部署</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/lb/lbagent/</link><pubDate>Mon, 20 Feb 2023 15:47:12 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/onpremise/lb/lbagent/</guid><description>
&lt;p>Lbagent是负责负载均衡数据转发的节点，可以部署在经典网络的虚拟机，或者物理机上。&lt;/p>
&lt;p>Lbagent内部署了如下软件，实现高可用的4层和7层负载均衡功能：&lt;/p>
&lt;ul>
&lt;li>haproxy：负责TCP四层负载均衡和http/https七层负责均衡&lt;/li>
&lt;li>gobetween: 负责UDP四层负载均衡转发&lt;/li>
&lt;li>keepalived: 负责主备节点的切换&lt;/li>
&lt;/ul>
&lt;p>一个LB集群一般由两个lbagent组成主备切换的高可用集群，其中通过keepalived实现主备自动切换。&lt;/p>
&lt;p>在使用负载均衡功能前，需要有实现负载均衡转发功能的由Lbagent组成的负载均衡集群。
本文介绍如何部署Lbagent以组成负载均衡集群。&lt;/p>
&lt;h2 id="39含之前版本部署lbagent">3.9（含）之前版本部署Lbagent&lt;/h2>
&lt;p>3.9（含）之前版本负载均衡仅支持经典网络，采用前端界面部署Lbagent，部署流程如下：&lt;/p>
&lt;ol>
&lt;li>创建负载均衡集群（lbcluster）&lt;/li>
&lt;li>为lbcluster创建一对lbagent&lt;/li>
&lt;li>在前端界面的lbagent列表上，点击lbagent的“部署”，输入lbagent所需keystone账号，repo地址等信息，通过后端的ansible脚本自动化实现lbagent的部署。&lt;/li>
&lt;/ol>
&lt;h2 id="310含之后版本部署lbagent">3.10（含）之后版本部署Lbagent&lt;/h2>
&lt;p>自3.10(含）版本之后，负载均衡开始支持VPC内虚拟机的负载均衡，并可以挂载EIP。同时，部署流程更新为：&lt;/p>
&lt;p>1、采用ocboot将已有虚拟机或物理机部署为lbagent节点
2、创建lbcluster
3、将一对lbagent节点和一个lbcluster关联，实现lbagent的自动化配置&lt;/p>
&lt;h3 id="lbagent节点的部署">lbagent节点的部署&lt;/h3>
&lt;p>采用ocboot，采用如下命令将地址为&amp;lt;ip_of_lbagent_node&amp;gt;的经典网络虚拟机或物理机部署为一台lbagent：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>./ocboot add-lbagent &amp;lt;ip_of_master_node&amp;gt; &amp;lt;ip_of_lbagent_node&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>部署成功的lbagent节点是k8s集群的一个节点，并且带有如下label：&lt;/p>
&lt;pre tabindex="0">&lt;code>onecloud.yunion.io/lbagent=enable
&lt;/code>&lt;/pre>&lt;h2 id="将39含之前版本lbagent升级为310">将3.9（含）之前版本lbagent升级为3.10&lt;/h2>
&lt;p>对于已经部署了3.9（含）之前版本的lbagent节点，可以通过如下步骤升级为3.10的lbagent：&lt;/p>
&lt;ul>
&lt;li>安装3.10的yum repo&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>cat &amp;gt; /etc/yum.repos.d/yunion.repo &lt;span style="color:#4e9a06">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">[yunion]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">name=Packages for Yunion- $basearch
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">baseurl=https://iso.yunion.cn/centos/7/3.10/x86_64
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">failovermethod=priority
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">enabled=1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">gpgcheck=0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">sslverify=1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>更新yum数据库：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>yum clean all
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>yum makecache
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>更新节点的内核为最新的计算节点的内核，重启节点使得新内核生效&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>yum install -y kernel-5.4.130 linux-firmware
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>安装ovs和ovn软件包&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>yum install -y openvswitch openvswitch-ovn-common openvswitch-ovn-host kmod-openvswitch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>设置ovs开机自动启动&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>systemctl &lt;span style="color:#204a87">enable&lt;/span> --now openvswitch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>初始化ovn-controller:&lt;/li>
&lt;/ul>
&lt;p>其中：xx 为lbagent的主网口的IP地址，yy为 ovn-northd 容器所在宿主机的IP地址（access_ip）。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 配置ovn&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">ovn_encap_ip&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>xx &lt;span style="color:#8f5902;font-style:italic"># 隧道外层IP地址，EIP网关用它与其它计算节点通信&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">ovn_north_addr&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>yy:32242 &lt;span style="color:#8f5902;font-style:italic"># ovn北向数据库的地址，yy一般选择某台宿主机ip地址；端口默认为32242，对应k8s default-ovn-north service中的端口号&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ovs-vsctl &lt;span style="color:#204a87">set&lt;/span> Open_vSwitch . &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> external_ids:ovn-bridge&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>brvpc &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> external_ids:ovn-encap-type&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>geneve &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> external_ids:ovn-encap-ip&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#000">$ovn_encap_ip&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#4e9a06">&lt;/span> external_ids:ovn-remote&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;tcp:&lt;/span>&lt;span style="color:#000">$ovn_north_addr&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic"># 启动ovn-controller&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>systemctl &lt;span style="color:#204a87">enable&lt;/span> --now ovn-controller
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>修改lbagent配置&lt;/li>
&lt;/ul>
&lt;p>修改 /etc/yunion/lbagent.conf，加入如下两行参数：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">interface&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;eth0&amp;#39;&lt;/span> &lt;span style="color:#8f5902;font-style:italic"># lbagent主网卡的名称，例如 eth0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">access_ip&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;xx.xx.xx.xx&amp;#39;&lt;/span> &lt;span style="color:#8f5902;font-style:italic"># 主网卡的主IP地址&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>安装最新的yunion-lbgent，并重启&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>yum install -y yunion-lbagent
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>systemctl restart yunion-lbagent
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 负载均衡平台配置</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/lb/lbhowto/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/onpremise/lb/lbhowto/</guid><description>
&lt;h2 id="负载均衡工作原理">负载均衡工作原理？&lt;/h2>
&lt;p>负载均衡的功能由负载均衡集群实现，负载均衡集群由多个负载均衡节点组成，每个节点是一台运行负载均衡软件的Linux主机。集群下的节点均部署同样的软件和配置，互为主备，并且同一时刻只有一个主节点。负载均衡节点都运行keepalived高可用软件，keepalived检测每个节点的健康状况，确保只有一个主节点提供服务。&lt;/p>
&lt;p>每个负载均衡节点内部署了开源负载均衡软件 &lt;a href="https://www.haproxy.org/">haproxy&lt;/a> v1.8.19，提供TCP和http/https负载均衡，以及 &lt;a href="">gobetween&lt;/a> v0.7.1 提供UDP负载均衡。&lt;/p>
&lt;h2 id="负载均衡的配置">负载均衡的配置&lt;/h2>
&lt;p>为了让负载均衡功能正常工作，管理员需要在平台进行相关的配置，大概分为两步：&lt;/p>
&lt;h3 id="第一步部署负载均衡节点">第一步：部署负载均衡节点&lt;/h3>
&lt;p>负载均衡节点是流程负载均衡功能的实际执行者，至少需要部署1个负载均衡节点。&lt;/p>
&lt;p>部署一个负载均衡节点的具体步骤请参见&lt;a href="./lbagent">Lbagent部署&lt;/a>。&lt;/p>
&lt;p>一般建议做法是新建一台单网口的经典网络虚拟机，将该虚拟机作为负载均衡节点加入集群。&lt;/p>
&lt;p>建议部署2台负载均衡节点。&lt;/p>
&lt;h3 id="第二步配置负载均衡集群">第二步：配置负载均衡集群&lt;/h3>
&lt;p>新建负载均衡集群，并将第一步部署的负载均衡节点加入该集群。等待大约15分钟后，在节点的服务获取到集群的配置后，集群开始正常工作。&lt;/p>
&lt;p>以上配置步骤完成后，即可开始负载均衡的使用。&lt;/p></description></item></channel></rss>