<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloudpods –
系统镜像</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/</link><description>Recent content in 系统镜像 on Cloudpods</description><generator>Hugo -- gohugo.io</generator><lastBuildDate>Fri, 07 Jan 2022 10:48:49 +0800</lastBuildDate><atom:link href="https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: 上传镜像</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/upload/</link><pubDate>Fri, 19 Jul 2019 11:34:14 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/upload/</guid><description>
&lt;h2 id="获取镜像">获取镜像&lt;/h2>
&lt;p>上传镜像之前需要先获取镜像，途径有多种，比如从发行版官网下载用于云平台的镜像，或者自己制作。&lt;/p>
&lt;h3 id="发行版镜像">发行版镜像&lt;/h3>
&lt;p>根据自己对发行版的需要下载发行版镜像，常用的 Linux 发行版会提供云平台虚拟机使用的镜像，地址如下:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="http://cloud.centos.org/centos/7/images/">centos&lt;/a>: &lt;a href="http://cloud.centos.org/centos/7/images/">http://cloud.centos.org/centos/7/images/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cloud-images.ubuntu.com/">ubuntu&lt;/a>: &lt;a href="https://cloud-images.ubuntu.com/">https://cloud-images.ubuntu.com/&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="制作镜像">制作镜像&lt;/h3>
&lt;p>参考: &lt;a href="../create/">制作镜像&lt;/a>&lt;/p>
&lt;h2 id="上传镜像">上传镜像&lt;/h2>
&lt;p>下载或者制作完镜像后，可以通过界面操作和Climc命令行的形式将镜像上传到平台的 glance 服务。&lt;/p>
&lt;h3 id="climc命令">Climc命令&lt;/h3>
&lt;p>使用 &lt;code>climc image-upload&lt;/code> 上传到云平台的 glance 服务，下面以下载 CentOS 提供的 CentOS-7-x86_64-GenericCloud-1711 举例:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 下载 CentOS-7-x86_64-GenericCloud-1711.qcow2 &lt;/span>
$ wget http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-1711.qcow2
&lt;span style="color:#8f5902;font-style:italic"># 上传镜像到云平台并名为 CentOS-7-x86_64-GenericCloud-1711.qcow2&lt;/span>
$ climc image-upload --format qcow2 --os-type Linux --os-arch x86_64 --standard CentOS-7-x86_64-GenericCloud-1711.qcow2 ./CentOS-7-x86_64-GenericCloud-1711.qcow2
&lt;/code>&lt;/pre>&lt;/div>&lt;p>上传时间长短取决于网络环境和镜像大小，上传完成后需要查询镜像的状态，当状态变为 &amp;lsquo;active&amp;rsquo; 时，就可以拿来使用了。( 更多的关于镜像的查询参考: &lt;a href="../show/#%E6%9F%A5%E8%AF%A2%E9%95%9C%E5%83%8F">镜像查询&lt;/a> )&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc image-show CentOS-7-x86_64-GenericCloud-1711.qcow2 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep status
&lt;span style="color:#000;font-weight:bold">|&lt;/span> status &lt;span style="color:#000;font-weight:bold">|&lt;/span> active &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>使用 &lt;code>climc image-upload --help&lt;/code> 获取各个参数解释。&lt;/p></description></item><item><title>Docs: 制作镜像</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/create/</link><pubDate>Fri, 19 Jul 2019 11:12:40 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/create/</guid><description>
&lt;p>你可能需要自己定制发行版的镜像，用于给不同的业务使用。本文介绍如何制作镜像。&lt;/p>
&lt;p>可以通过下载发行版操作系统的 iso , 然后本地启动虚拟机，将 iso 安装到虚拟机的磁盘，然后保存该磁盘，这个磁盘就可以作为镜像上传到 glance，但是这种方法人工参与的步骤太多，容易出错。&lt;/p>
&lt;p>推荐使用 &lt;a href="https://www.packer.io/intro/getting-started/install.html">packer&lt;/a> 这个工具来自动化制作镜像，详细操作可以参考对应的文档 &lt;a href="https://www.packer.io/docs/index.html">https://www.packer.io/docs/index.html&lt;/a> 。&lt;/p>
&lt;p>&lt;a href="https://github.com/yunionio/service-images">https://github.com/yunionio/service-images&lt;/a> 仓库包含了一些我们使用 packer 制作镜像的配置，可以参考使用。&lt;/p>
&lt;h2 id="镜像制作流程">镜像制作流程&lt;/h2>
&lt;ol>
&lt;li>提前准备好标准ISO镜像，支持用户从镜像市场-ISO界面导入或直接上传ISO镜像。&lt;/li>
&lt;li>在虚拟机列表中新建虚拟机，选择“从ISO启动”并选择对应的ISO镜像，创建成功后，并通过VNC终端进行按照界面提示安装操作系统。&lt;/li>
&lt;/ol>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">说明&lt;/h4>
&lt;ul>
&lt;li>推荐使用CentOS Minimal操作系统。&lt;/li>
&lt;li>Ubuntu/Debian镜像在安装过程中建议选择“No automatic updates”并安装OpenSSH Server软件。&lt;/li>
&lt;/ul>
&lt;/div>
&lt;ol start="3">
&lt;li>根据镜像的操作系统类型进行不同的优化配置。
&lt;ul>
&lt;li>CentOS镜像：请参考&lt;a href="#centos%E9%95%9C%E5%83%8F%E4%BC%98%E5%8C%96">CentOS镜像优化&lt;/a>章节。&lt;/li>
&lt;li>Ubuntu/Debian镜像：请参考&lt;a href="#ubuntu-debian%E9%95%9C%E5%83%8F%E4%BC%98%E5%8C%96">Ubuntu/Debian镜像优化&lt;/a>章节。&lt;/li>
&lt;li>Windows镜像：请参考&lt;a href="#windows%E9%95%9C%E5%83%8F%E4%BC%98%E5%8C%96">Windows镜像优化&lt;/a>章节。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>(可选)多平台通用镜像配置，如制作的镜像需要在公有云平台上使用，除上述优化配置外，还需要在&lt;a href="#linux%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEcloud-init">Linux系统安装配置cloud-init&lt;/a>，&lt;a href="#windows%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEcloudbase-init">Windows系统安装配置Cloudbase-init&lt;/a>。&lt;/li>
&lt;li>镜像优化完成后，需要将虚拟机关机。&lt;/li>
&lt;li>单击关机状态的虚拟机右侧操作列 &lt;strong>&lt;em>&amp;ldquo;更多&amp;rdquo;&lt;/em>&lt;/strong> 按钮，选择下拉菜单 &lt;strong>&lt;em>&amp;ldquo;保存镜像&amp;rdquo;&lt;/em>&lt;/strong> 菜单项，将虚拟机保存为系统镜像。&lt;/li>
&lt;li>镜像保存完成后，用户可在虚拟机列表中新建虚拟机，选择“自定义镜像”并选择上一步骤保存的镜像，使用制作好的镜像创建虚拟机，验证镜像是否制作成功。&lt;/li>
&lt;/ol>
&lt;h3 id="centos镜像优化">CentOS镜像优化&lt;/h3>
&lt;p>以CentOS 7 minimal镜像为例介绍镜像优化方法。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>CentOS 7 Minimal操作系统安装完成后的虚拟机默认不能联网，需要修改/etc/sysconfig/network-scripts/ifcfg-eth0文件，将&amp;quot;ONBOOT=no&amp;quot;改为&amp;quot;ONBOOT=yes&amp;quot;。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 请根据实际网卡名称修改对应的配置文件&lt;/span>
$ vi /etc/sysconfig/network-scripts/ifcfg-eth0 &lt;span style="color:#8f5902;font-style:italic"># 请根据实际网卡名称修改对应的配置文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 修改配置文件内容&lt;/span>
&lt;span style="color:#000">ONBOOT&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>yes
&lt;span style="color:#8f5902;font-style:italic"># CentOS 8 和 CentOS 9 重启网卡: systemctl restart NetworkManager.service&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>禁用selinux，修改/etc/selinux/config文件，将&amp;quot;SELINUX=enforcing&amp;quot;改为&amp;quot;SELINUX=disabled&amp;quot;。修改完成后，重启系统生效。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ vi /etc/selinux/config
&lt;span style="color:#8f5902;font-style:italic"># 修改配置文件内容，修改完成后保存。&lt;/span>
&lt;span style="color:#000">SELINUX&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>disabled
&lt;span style="color:#8f5902;font-style:italic"># 重启使配置生效&lt;/span>
$ reboot
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>将必要的kernel module加入启动initram.img。（centos8的内核已经安装了virtio所以需要在列表删除）&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ vi /etc/dracut.conf
&lt;span style="color:#8f5902;font-style:italic"># 修改配置文件，去掉add_drivers+前面#注释，并在引号中添加如下内容，修改完成后保存。&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 以下为 x86 需要添加的内核驱动&lt;/span>
&lt;span style="color:#000">add_drivers&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34; hpsa mptsas mpt2sas mpt3sas megaraid_sas mptspi virtio virtio_ring virtio_pci virtio_scsi virtio_blk vmw_pvscsi &amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 以下为 arm 需要添加的内核驱动&lt;/span>
&lt;span style="color:#000">add_drivers&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34; mptsas mpt2sas mpt3sas megaraid_sas mptspi virtio virtio_ring virtio_pci virtio_scsi virtio_blk &amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 使配置生效&lt;/span>
$ dracut -f
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>关闭网卡持久化功能，保证CentOS 7中网卡名称为“eth0，eth1”形式。修改/etc/default/grub文件，在GRUB_CMDLINE_LINUX中添加&amp;quot;net.ifnames=0 biosdevname=0&amp;quot;参数。（centos8，centos9略过）&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ vi /etc/default/grub
&lt;span style="color:#8f5902;font-style:italic"># 修改配置文件，修改完成后保存。&lt;/span>
&lt;span style="color:#000">GRUB_CMDLINE_LINUX&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet net.ifnames=0 biosdevname=0&amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 使配置生效&lt;/span>
$ grub2-mkconfig -o /boot/grub2/grub.cfg
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>根据需求安装常用软件。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 仅为举例，请根据实际需求安装常用软件。&lt;/span>
$ yum install net-tools git wget vim pcre-tools ntp epel-release -y
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>禁用firewalld和NetworkManager服务。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ systemctl disable firewalld NetworkManager
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>启用时间网络同步，支持使用ntp或chrony保持时间同步。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 安装ntp或chrony软件&lt;/span>
$ yum install ntp/chrony -y
&lt;span style="color:#8f5902;font-style:italic"># 启用ntp或chronyd服务&lt;/span>
$ systemctl &lt;span style="color:#204a87">enable&lt;/span> ntpd/chronyd
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>修改时区为CST。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ timedatectl set-timezone Asia/Shanghai
&lt;span style="color:#8f5902;font-style:italic"># 查看当前时区&lt;/span>
$ timedatectl status
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>ssh服务优化，修改/etc/ssh/sshd_config文件，将PermitRootLogin属性修改为yes 将UseDNS属性修改为no。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ vi /etc/ssh/sshd_config
&lt;span style="color:#8f5902;font-style:italic">#分别找到PermitRootLogin属性和UseDNS属性&lt;/span>
PermitRootLogin yes
UseDNS no
&lt;/code>&lt;/pre>&lt;/div>&lt;p>systemctl restart sshd&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="ubuntudebian镜像优化">Ubuntu/Debian镜像优化&lt;/h3>
&lt;p>以ubuntu-16.04.6-server-amd64.iso为例，介绍Ubuntu和Debian镜像的优化方法。Ubuntu系统安装完成后，默认使用普通权限用户。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>ssh服务优化，修改/etc/ssh/sshd_config文件，将PermitRootLogin属性修改为yes 将UseDNS属性修改为no，若没有上述属性，请添加属性。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ sudo vi /etc/ssh/sshd_config
&lt;span style="color:#8f5902;font-style:italic"># 分别找到PermitRootLogin属性和UseDNS属性&lt;/span>
PermitRootLogin yes
UseDNS no
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>在/etc/init.d/目录下创建一个名称为ssh-initkey的自启动脚本。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ sudo touch /etc/init.d/ssh-initkey
$ sudo vi /etc/init.d/ssh-initkey
&lt;span style="color:#8f5902;font-style:italic"># 脚本内容如下：&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">#! /bin/sh&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">### BEGIN INIT INFO&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># Provides: ssh-initkey&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># Required-Start:&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># Required-Stop:&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># X-Start-Before: ssh&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># Default-Start: 2 3 4 5&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># Default-Stop:&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># Short-Description: Init ssh host keys&lt;/span>
&lt;span style="color:#8f5902;font-style:italic">### END INIT INFO&lt;/span>
&lt;span style="color:#000">PATH&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/sbin:/usr/sbin:/bin:/usr/bin
. /lib/init/vars.sh
. /lib/lsb/init-functions
do_start&lt;span style="color:#ce5c00;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>
ls /etc/ssh/ssh_host_* &amp;gt; /dev/null 2&amp;gt;&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span> &lt;span style="color:#000">$?&lt;/span> -ne &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">then&lt;/span>
dpkg-reconfigure openssh-server
&lt;span style="color:#204a87;font-weight:bold">fi&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">case&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;&lt;/span>&lt;span style="color:#000">$1&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span> in
start&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
do_start
&lt;span style="color:#000;font-weight:bold">;;&lt;/span>
restart&lt;span style="color:#000;font-weight:bold">|&lt;/span>reload&lt;span style="color:#000;font-weight:bold">|&lt;/span>force-reload&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Error: argument &amp;#39;&lt;/span>&lt;span style="color:#000">$1&lt;/span>&lt;span style="color:#4e9a06">&amp;#39; not supported&amp;#34;&lt;/span> &amp;gt;&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">2&lt;/span>
&lt;span style="color:#204a87">exit&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>
&lt;span style="color:#000;font-weight:bold">;;&lt;/span>
stop&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">;;&lt;/span>
*&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Usage: &lt;/span>&lt;span style="color:#000">$0&lt;/span>&lt;span style="color:#4e9a06"> start|stop&amp;#34;&lt;/span> &amp;gt;&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">2&lt;/span>
&lt;span style="color:#204a87">exit&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>
&lt;span style="color:#000;font-weight:bold">;;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">esac&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>ssh-initkey脚本配置完成后，还需要增加可执行权限，并将脚本添加到系统启动脚本目录。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ sudo chmod +x /etc/init.d/ssh-initkey
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ubuntu 20.04之前版本，请执行以下脚本启用脚本：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ sudo /usr/sbin/update-rc.d ssh-initkey defaults
$ sudo /usr/sbin/update-rc.d ssh-initkey &lt;span style="color:#204a87">enable&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ubuntu 20.04版本以及之后版本，请执行以下脚本启用脚本：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ sudo /lib/systemd/systemd-sysv-install &lt;span style="color:#204a87">enable&lt;/span> ssh-initkey
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>（Ubuntu 16.04以上版本设置）关闭网卡持久化功能，保证网卡名称为“eth0，eth1”形式。修改/etc/default/grub文件，在GRUB_CMDLINE_LINUX中添加&amp;quot;net.ifnames=0 biosdevname=0&amp;quot;参数。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ sudo vi /etc/default/grub
&lt;span style="color:#8f5902;font-style:italic"># 配置GRUB_CMDLINE_LINUX参数&lt;/span>
&lt;span style="color:#000">GRUB_CMDLINE_LINUX&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;net.ifnames=0 biosdevname=0&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 使配置生效&lt;/span>
$ sudo /usr/sbin/update-grub
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>(若Ubuntu未关闭自动更新)关闭自动更新需要修改/etc/apt/apt.conf.d/10periodic文件，将文件中的&amp;quot;Update-Package-Lists&amp;quot;参数设置为0。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ sudo vi /etc/apt/apt.conf.d/10periodic
&lt;span style="color:#8f5902;font-style:italic"># 配置修改&lt;/span>
APT::Periodic::Update-Package-Lists &lt;span style="color:#4e9a06">&amp;#34;0&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>至此，虚拟机优化完成。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="windows镜像优化">Windows镜像优化&lt;/h3>
&lt;h4 id="安装virtio驱动">安装Virtio驱动&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>操作系统版本&lt;/th>
&lt;th>Virtio驱动中对应名称&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Windows XP&lt;/td>
&lt;td>xp&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 7&lt;/td>
&lt;td>w7&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 8&lt;/td>
&lt;td>w8&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 8.1&lt;/td>
&lt;td>w8.1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows 10&lt;/td>
&lt;td>w10&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows Server 2003&lt;/td>
&lt;td>2k3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows Server 2008&lt;/td>
&lt;td>2K8&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows Server 2008 R2&lt;/td>
&lt;td>2k8R2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows Server 2012&lt;/td>
&lt;td>2k12&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows Server 2012 R2&lt;/td>
&lt;td>2k12R2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows Server 2016&lt;/td>
&lt;td>2k16&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ol>
&lt;li>
&lt;p>上传Virtio驱动ISO并挂载到虚拟机上。Virtio驱动可以从以下URL下载：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>如果使用的是企业版，则可以直接从镜像市场的ISO页面导入Virtio驱动。&lt;/p>
&lt;p>需要注意的是，如果是Windows Server 2008及以前版本的Windows，推荐使用版本&lt;a href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.135-2/virtio-win-0.1.135.iso">0.1.135&lt;/a> 的virtio驱动。&lt;/p>
&lt;ol start="2">
&lt;li>
&lt;p>在虚拟机中打开挂载的驱动文件夹，根据虚拟机的操作系统版本（如本例为Windows server 2016），在驱动文件夹页面的搜索框中搜索“2k16”，并将所有包含2k16的文件夹复制到虚拟机的其他文件夹中（如文档文件夹）。&lt;/p>
&lt;p>&lt;img src="../images/image/search2k16.png" alt="">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>在文档文件夹中打开“2k16&amp;gt;amd64”文件夹，该文件夹中包含所有Windows Server 2016中的驱动文件。在该文件夹的地址显示框中输入cmd或同时按“shift”键和鼠标右键，在此处打开命令窗口，打开命令提示符对话框。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>使用以下命令安装全部驱动。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">pnputil -i -a *.inf
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h4 id="禁用快速启动">禁用快速启动&lt;/h4>
&lt;p>（可选）若是Windows 10操作系统的虚拟机需要禁用快速启动。请参考&lt;a href="https://jingyan.baidu.com/article/ca00d56c7a40e6e99febcf4f.html">禁用方法&lt;/a>。&lt;/p>
&lt;h4 id="系统激活">系统激活&lt;/h4>
&lt;p>请通过正规渠道激活Windows系统。&lt;/p>
&lt;h4 id="sysprep封装">sysprep封装&lt;/h4>
&lt;p>运行sysprep，消除个性化信息。&lt;/p>
&lt;ol>
&lt;li>打开%WINDIR%/system32/sysprep目录，并在目录下创建unattend.xml文件，内容如下：&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-xml" data-lang="xml">&lt;span style="color:#8f5902;font-style:italic">&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;utf-8&amp;#34;?&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;unattend&lt;/span> &lt;span style="color:#c4a000">xmlns=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;urn:schemas-microsoft-com:unattend&amp;#34;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;settings&lt;/span> &lt;span style="color:#c4a000">pass=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;generalize&amp;#34;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;component&lt;/span> &lt;span style="color:#c4a000">name=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;Microsoft-Windows-Security-SPP&amp;#34;&lt;/span> &lt;span style="color:#c4a000">processorArchitecture=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;amd64&amp;#34;&lt;/span> &lt;span style="color:#c4a000">publicKeyToken=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;31bf3856ad364e35&amp;#34;&lt;/span> &lt;span style="color:#c4a000">language=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;neutral&amp;#34;&lt;/span> &lt;span style="color:#c4a000">versionScope=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;nonSxS&amp;#34;&lt;/span> &lt;span style="color:#c4a000">xmlns:wcm=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;http://schemas.microsoft.com/WMIConfig/2002/State&amp;#34;&lt;/span> &lt;span style="color:#c4a000">xmlns:xsi=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;http://www.w3.org/2001/XMLSchema-instance&amp;#34;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;SkipRearm&amp;gt;&lt;/span>0&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/SkipRearm&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/component&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;component&lt;/span> &lt;span style="color:#c4a000">name=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;Microsoft-Windows-PnpSysprep&amp;#34;&lt;/span> &lt;span style="color:#c4a000">processorArchitecture=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;amd64&amp;#34;&lt;/span> &lt;span style="color:#c4a000">publicKeyToken=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;31bf3856ad364e35&amp;#34;&lt;/span> &lt;span style="color:#c4a000">language=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;neutral&amp;#34;&lt;/span> &lt;span style="color:#c4a000">versionScope=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;nonSxS&amp;#34;&lt;/span> &lt;span style="color:#c4a000">xmlns:wcm=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;http://schemas.microsoft.com/WMIConfig/2002/State&amp;#34;&lt;/span> &lt;span style="color:#c4a000">xmlns:xsi=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;http://www.w3.org/2001/XMLSchema-instance&amp;#34;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;PersistAllDeviceInstalls&amp;gt;&lt;/span>true&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/PersistAllDeviceInstalls&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;DoNotCleanUpNonPresentDevices&amp;gt;&lt;/span>true&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/DoNotCleanUpNonPresentDevices&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/component&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/settings&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;settings&lt;/span> &lt;span style="color:#c4a000">pass=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;oobeSystem&amp;#34;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;component&lt;/span> &lt;span style="color:#c4a000">name=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;Microsoft-Windows-Shell-Setup&amp;#34;&lt;/span> &lt;span style="color:#c4a000">processorArchitecture=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;amd64&amp;#34;&lt;/span> &lt;span style="color:#c4a000">publicKeyToken=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;31bf3856ad364e35&amp;#34;&lt;/span> &lt;span style="color:#c4a000">language=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;neutral&amp;#34;&lt;/span> &lt;span style="color:#c4a000">versionScope=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;nonSxS&amp;#34;&lt;/span> &lt;span style="color:#c4a000">xmlns:wcm=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;http://schemas.microsoft.com/WMIConfig/2002/State&amp;#34;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;AutoLogon&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;Password&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;Value&amp;gt;&lt;/span>123@yunion&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/Value&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;PlainText&amp;gt;&lt;/span>true&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/PlainText&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/Password&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;Username&amp;gt;&lt;/span>Administrator&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/Username&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;Enabled&amp;gt;&lt;/span>true&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/Enabled&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;LogonCount&amp;gt;&lt;/span>5&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/LogonCount&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/AutoLogon&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;UserAccounts&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;AdministratorPassword&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;Value&amp;gt;&lt;/span>123@yunion&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/Value&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;PlainText&amp;gt;&lt;/span>true&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/PlainText&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/AdministratorPassword&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/UserAccounts&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;Display&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;ColorDepth&amp;gt;&lt;/span>32&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/ColorDepth&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;HorizontalResolution&amp;gt;&lt;/span>1024&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/HorizontalResolution&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;RefreshRate&amp;gt;&lt;/span>60&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/RefreshRate&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;VerticalResolution&amp;gt;&lt;/span>768&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/VerticalResolution&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/Display&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;OOBE&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;HideEULAPage&amp;gt;&lt;/span>true&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/HideEULAPage&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;NetworkLocation&amp;gt;&lt;/span>Work&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/NetworkLocation&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;ProtectYourPC&amp;gt;&lt;/span>1&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/ProtectYourPC&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;SkipMachineOOBE&amp;gt;&lt;/span>true&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/SkipMachineOOBE&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;SkipUserOOBE&amp;gt;&lt;/span>true&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/SkipUserOOBE&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/OOBE&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/component&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/settings&amp;gt;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;lt;/unattend&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">说明&lt;/h4>
由于Windows系统只支持VNC连接，无法直接将内容拷贝到虚拟机，可通过发送文字功能，在虚拟机输入法处于英文模式的时候，发送上述内容。
&lt;/div>
&lt;ol start="2">
&lt;li>在该目录的地址显示框中输入cmd或同时按“shift”键和鼠标右键，在此处打开命令窗口，打开命令提示符对话框。输入以下命令，执行sysprep封装并关闭虚拟机。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&amp;gt; sysprep /generalize /oobe /shutdown /unattend:unattend.xml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>注意&lt;/em>：Windows 10 1803版本之后，存在sysprep失败的情况。一般来说，失败原因主要是如果系统安装了来自Windows store的软件，sysprep卸载来自Windows store的软件时报错。需要逐个手工卸载导致报错的软件包。每个软件包卸载的方法为：&lt;/p>
&lt;ol>
&lt;li>每次sysprep报错后，可以查看报错日志：C:\Windows\System32\Sysprep\Panther\setupact.log 。日志有类似如下的报错信息：&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">2018-06-21 13:35:59, Error SYSPRP Package Microsoft.LanguageExperiencePackhu-hu_17134.2.4.0_neutral__8wekyb3d8bbwe was installed &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> a user, but not provisioned &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> all users. This package will not &lt;span style="color:#204a87;font-weight:bold">function&lt;/span> properly in the sysprep image.
&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中，Package后即为卸载失败的package名称，采用如下命令手工卸载该package：&lt;/p>
&lt;ol start="2">
&lt;li>手工卸载指定的package，其中&lt;packagefullname>替换为第一步找到的package名称。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">remove-appxpackage -allusers -package &lt;span style="color:#4e9a06">&amp;#39;&amp;lt;packagefullname&amp;gt;&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>如此反复尝试执行sysprep，如果失败则执行以上1)和2)步骤删除package，直到sysprep执行成功。&lt;/p>
&lt;p>如果卸载软件后还无法执行sysprep，则请尝试修改unattend.xml，将 &amp;ldquo;PersistAllDeviceInstalls&amp;rdquo; 改为 &amp;ldquo;false&amp;rdquo;。&lt;/p>
&lt;ol start="3">
&lt;li>至此虚拟机优化完成。&lt;/li>
&lt;/ol>
&lt;h3 id="linux系统安装配置cloud-init可选">Linux系统安装配置Cloud-init（可选）&lt;/h3>
&lt;p>Cloud-init用于为Linux操作系统的虚拟机做系统初始化配置。详细介绍内容请参考&lt;a href="https://cloudinit.readthedocs.io/en/latest/?spm=a2c4g.11186623.2.16.2aec3fcaVGJZo7">cloud-init官网&lt;/a>。&lt;/p>
&lt;h4 id="安装cloud-init">安装cloud-init&lt;/h4>
&lt;p>在Linux操作系统中使用软件源上的cloud-init包安装cloud-init，命令如下：&lt;/p>
&lt;ul class="nav nav-tabs" id="cloudinit" role="tablist">&lt;li class="nav-item">&lt;a data-toggle="tab" class="nav-link active" href="#cloudinit-0" role="tab" aria-controls="cloudinit-0" aria-selected="true">CentOS 7&lt;/a>&lt;/li>
&lt;li class="nav-item">&lt;a data-toggle="tab" class="nav-link" href="#cloudinit-1" role="tab" aria-controls="cloudinit-1">Ubuntu/Debian 10&lt;/a>&lt;/li>&lt;/ul>
&lt;div class="tab-content" id="cloudinit">&lt;div id="cloudinit-0" class="tab-pane show active" role="tabpanel" aria-labelledby="cloudinit-0">
&lt;p>&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ yum install cloud-init
&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;div id="cloudinit-1" class="tab-pane" role="tabpanel" aria-labelledby="cloudinit-1">
&lt;p>&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ apt install cloud-init
&lt;/code>&lt;/pre>&lt;/div>&lt;/div>&lt;/div>
&lt;p>Linux操作系统安装Cloud-init更多请参考&lt;a href="https://cloud.tencent.com/document/product/213/12587">腾讯云文档中心-Linux系统安装cloud-init&lt;/a>或&lt;a href="https://help.aliyun.com/document_detail/57803.html?spm=5176.10695662.1996646101.searchclickresult.9b2c5db8X8v4Tq&amp;amp;aly_as=gOLD2vtr">阿里云文档中心-安装cloud-init&lt;/a>等。&lt;/p>
&lt;h4 id="配置cloud-init">配置cloud-init&lt;/h4>
&lt;p>修改/etc/cloud/cloud.cfg文件，将disabled_root设置为0，ssh_pwauth设置为1。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ vi /etc/cloud/cloud.cfg
&lt;span style="color:#8f5902;font-style:italic"># 修改配置文件，修改完成后保存。&lt;/span>
disable_root: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>
ssh_pwauth: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="windows系统安装配置cloudbase-init可选">Windows系统安装配置Cloudbase-init（可选）&lt;/h3>
&lt;p>请参考&lt;a href="https://cloud.tencent.com/document/product/213/30000">腾讯云文档中心-Windows操作系统安装Cloudbase-Init&lt;/a>。&lt;/p></description></item><item><title>Docs: 导出镜像</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/download/</link><pubDate>Thu, 23 Dec 2021 19:25:38 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/download/</guid><description>
&lt;p>&lt;big>&lt;strong>climc操作&lt;/strong>&lt;/big>&lt;/p>
&lt;p>如果需要将云平台的镜像导出到本地，就需要用 &lt;code>climc image-download&lt;/code> 把 glance 存的镜像下载下来。&lt;/p>
&lt;p>参考 &lt;a href="../show/#%E6%9F%A5%E8%AF%A2%E9%95%9C%E5%83%8F">查询镜像&lt;/a> 查询你想要下载的镜像，获取镜像 id 或 name。&lt;/p>
&lt;p>下载镜像:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># OUTPUT 指定镜像的保存路径和文件名称，如/root/test.qcow2&lt;/span>
$ climc image-download &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--output OUTPUT&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &amp;lt;image_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 删除镜像</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/delete/</link><pubDate>Thu, 23 Dec 2021 19:25:43 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/delete/</guid><description>
&lt;h3 id="climc命令删除镜像">Climc命令删除镜像&lt;/h3>
&lt;p>镜像默认启用了删除保护，当镜像确定不用了，需要先通过&lt;code>climc image-update&lt;/code>禁用删除保护，再通过 &lt;code>climc image-delete&lt;/code> 删除镜像。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">
&lt;span style="color:#8f5902;font-style:italic"># 禁用镜像删除保护&lt;/span>
$ climc image-update --unprotected &amp;lt;image_id&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 删除镜像&lt;/span>
$ climc image-delete &amp;lt;image_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 查看镜像详情</title><link>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/show/</link><pubDate>Tue, 04 Jan 2022 17:55:36 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/onpremise/glance/sysimage/show/</guid><description>
&lt;h3 id="查看镜像详情">查看镜像详情&lt;/h3>
&lt;p>&lt;big>&lt;strong>climc操作&lt;/strong>&lt;/big>&lt;/p>
&lt;p>根据 image-list 可以获取镜像的列表，第1、2列包含镜像的 id 和 name，通过 id 或 name 可以获取镜像的详情。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 查询名称包含 CentOS 的镜像&lt;/span>
$ climc image-list --search centos
+--------------------------------------+-----------------------------------------+-------------+-----------+-----------+-----------+-------------+----------+---------+--------+----------------------------------+----------------------------------+--------+----------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_format &lt;span style="color:#000;font-weight:bold">|&lt;/span> Size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Is_public &lt;span style="color:#000;font-weight:bold">|&lt;/span> Protected &lt;span style="color:#000;font-weight:bold">|&lt;/span> Is_Standard &lt;span style="color:#000;font-weight:bold">|&lt;/span> Min_disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Min_ram &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Checksum &lt;span style="color:#000;font-weight:bold">|&lt;/span> Tenant_Id &lt;span style="color:#000;font-weight:bold">|&lt;/span> Tenant &lt;span style="color:#000;font-weight:bold">|&lt;/span> is_guest_image &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-----------------------------------------+-------------+-----------+-----------+-----------+-------------+----------+---------+--------+----------------------------------+----------------------------------+--------+----------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> abf0fd6e-ec40-44ef-8fa2-cfb7187ea656 &lt;span style="color:#000;font-weight:bold">|&lt;/span> CentOS-7-x86_64-GenericCloud-1711.qcow2 &lt;span style="color:#000;font-weight:bold">|&lt;/span> qcow2 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">876740608&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">true&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">true&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">8192&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> active &lt;span style="color:#000;font-weight:bold">|&lt;/span> 317ecf7d1128e0e53cb285b8704dc3d3 &lt;span style="color:#000;font-weight:bold">|&lt;/span> d53ea650bfe144da8ee8f3fba417b904 &lt;span style="color:#000;font-weight:bold">|&lt;/span> system &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-----------------------------------------+-------------+-----------+-----------+-----------+-------------+----------+---------+--------+----------------------------------+----------------------------------+--------+----------------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;span style="color:#8f5902;font-style:italic"># 查看 CentOS-7-x86_64-GenericCloud-1711.qcow2 的详情&lt;/span>
$ climc image-show CentOS-7-x86_64-GenericCloud-1711.qcow2
+--------------------+-------------------------------------------------------------------------------------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Field &lt;span style="color:#000;font-weight:bold">|&lt;/span> Value &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------+-------------------------------------------------------------------------------------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> can_delete &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> can_update &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">true&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> checksum &lt;span style="color:#000;font-weight:bold">|&lt;/span> 317ecf7d1128e0e53cb285b8704dc3d3 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> created_at &lt;span style="color:#000;font-weight:bold">|&lt;/span> 2020-06-16T09:17:57.000000Z &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> delete_fail_reason &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;error&amp;#34;&lt;/span>:&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;class&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;ForbiddenError&amp;#34;&lt;/span>,&lt;span style="color:#4e9a06">&amp;#34;code&amp;#34;&lt;/span>:403,&lt;span style="color:#4e9a06">&amp;#34;data&amp;#34;&lt;/span>:&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;id&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;image is protected&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>,&lt;span style="color:#4e9a06">&amp;#34;details&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;image is protected&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">}}&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> disk_format &lt;span style="color:#000;font-weight:bold">|&lt;/span> qcow2 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> domain_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> default &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> fast_hash &lt;span style="color:#000;font-weight:bold">|&lt;/span> 4c53ba2c464213ddc2a77c9b4c5ad3b7 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> id &lt;span style="color:#000;font-weight:bold">|&lt;/span> abf0fd6e-ec40-44ef-8fa2-cfb7187ea656 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> is_data &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> is_emulated &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> is_guest_image &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> is_public &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> is_standard &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">true&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> is_system &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> min_disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">8192&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> min_ram &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> name &lt;span style="color:#000;font-weight:bold">|&lt;/span> CentOS-7-x86_64-GenericCloud-1711.qcow2 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> oss_checksum &lt;span style="color:#000;font-weight:bold">|&lt;/span> 317ecf7d1128e0e53cb285b8704dc3d3 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> owner &lt;span style="color:#000;font-weight:bold">|&lt;/span> d53ea650bfe144da8ee8f3fba417b904 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> pending_deleted &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> project_domain &lt;span style="color:#000;font-weight:bold">|&lt;/span> Default &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> project_src &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">local&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> properties &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;os_arch&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;x86_64&amp;#34;&lt;/span>,&lt;span style="color:#4e9a06">&amp;#34;os_type&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;Linux&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> protected &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">true&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> public_scope &lt;span style="color:#000;font-weight:bold">|&lt;/span> system &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> size &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">876740608&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> status &lt;span style="color:#000;font-weight:bold">|&lt;/span> active &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tenant &lt;span style="color:#000;font-weight:bold">|&lt;/span> system &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> tenant_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> d53ea650bfe144da8ee8f3fba417b904 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> update_version &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">8&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> updated_at &lt;span style="color:#000;font-weight:bold">|&lt;/span> 2020-06-16T09:19:24.000000Z &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------+-------------------------------------------------------------------------------------------------------------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="查询镜像">查询镜像&lt;/h3>
&lt;p>&lt;big>&lt;strong>climc操作&lt;/strong>&lt;/big>&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 查询所有镜像列表&lt;/span>
$ climc image-list
&lt;span style="color:#8f5902;font-style:italic"># 查询所有缓存的镜像列表&lt;/span>
$ climc cached-image-list
&lt;span style="color:#8f5902;font-style:italic"># 查询包含 ubuntu 关键字的镜像&lt;/span>
$ climc image-list --search ubuntu
&lt;span style="color:#8f5902;font-style:italic"># 查询公有云包含 centos 关键字的缓存&lt;/span>
$ climc cached-image-list --search centos --public-cloud
&lt;span style="color:#8f5902;font-style:italic"># image-list 支持的查询条件&lt;/span>
$ climc image-list --help
&lt;span style="color:#8f5902;font-style:italic"># cached-image-list 支持的查询条件&lt;/span>
$ climc cached-image-list --help
&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>