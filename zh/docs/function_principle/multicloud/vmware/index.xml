<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloudpods –
VMWare纳管</title><link>https://www.cloudpods.org/zh/docs/function_principle/multicloud/vmware/</link><description>Recent content in VMWare纳管 on Cloudpods</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://www.cloudpods.org/zh/docs/function_principle/multicloud/vmware/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: VMware网络原理</title><link>https://www.cloudpods.org/zh/docs/function_principle/multicloud/vmware/vmware_net/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/multicloud/vmware/vmware_net/</guid><description>
&lt;p>VMware是一个虚拟化平台，只提供二层网络交换的功能，不具备完整的网络管理能力。Cloudpods 为VMware补足网络管理的能力，提供IP地址和网络配置信息管理的能力。&lt;/p>
&lt;h2 id="基本概念">基本概念&lt;/h2>
&lt;p>VMware中有以下基本网络概念：&lt;/p>
&lt;h3 id="标准虚拟交换机-standard-vswitch">标准虚拟交换机 (Standard vSwitch)&lt;/h3>
&lt;p>每台ESXi宿主机内可以配置多个虚拟交换机，实现虚拟机之间以及虚拟机和外部物理网络的网络交换。&lt;/p>
&lt;h3 id="分布式虚拟交换机distributed-vswitch">分布式虚拟交换机（Distributed vSwitch）&lt;/h3>
&lt;p>被vCenter纳管的多台宿主机之间可以定义共享的分布式虚拟交换机，实现跨ESXi宿主机的虚拟机之间的统一配置的二层网络交换。&lt;/p>
&lt;h3 id="端口port">端口(Port)&lt;/h3>
&lt;p>虚拟机接入虚拟交换机的虚拟网络端口。&lt;/p>
&lt;h3 id="标准端口组-standard-port-group">标准端口组 (Standard Port Group)&lt;/h3>
&lt;p>标准虚拟机交换机上的一组虚拟端口，共享相同的VLAN，安全策略，冗余等配置。&lt;/p>
&lt;h3 id="分布式端口组distributed-port-group">分布式端口组（Distributed Port Group）&lt;/h3>
&lt;p>分布式虚拟交换机上的一组虚拟端口。&lt;/p>
&lt;h2 id="基本原理">基本原理&lt;/h2>
&lt;p>3.10以及之前版本，VMware中的虚拟交换机和Cloudpods的二层网络一一对应。IP子网和分布式端口组对应。IP子网和分布式端口组通过VLAN ID关联。这种映射方式比较隐晦，不容易配置。&lt;/p>
&lt;p>从3.11开始，VMware中的端口组和Cloudpods 的二层网络一一对应。VMware不负责IP子网的信息维护，因此，每个端口组上可以分配的IP子网信息在 Cloudpods 中维护。&lt;/p>
&lt;p>下面总结了VMware相关概念和 Cloudpods 相关概念的关联关系。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>VMware概念&lt;/th>
&lt;th>Cloudpods 概念&lt;/th>
&lt;th>如何关联&lt;/th>
&lt;th>关联关系&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>虚拟机&lt;/td>
&lt;td>虚拟机&lt;/td>
&lt;td>通过虚拟机UUID关联&lt;/td>
&lt;td>一对一&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ESXi主机&lt;/td>
&lt;td>宿主机&lt;/td>
&lt;td>通过主机管理IP管理&lt;/td>
&lt;td>一对一&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>端口（port）&lt;/td>
&lt;td>虚拟网卡&lt;/td>
&lt;td>通过IP地址和MAC关联&lt;/td>
&lt;td>一对一&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>端口组（portgroup）&lt;/td>
&lt;td>二层网络&lt;/td>
&lt;td>通过端口组的ID关联&lt;/td>
&lt;td>一对一&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>无&lt;/td>
&lt;td>IP子网&lt;/td>
&lt;td>NA&lt;/td>
&lt;td>NA&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;img src="../vmwarenet.png" width="600">
&lt;p>纳管 VMware 云账号时，平台会同步端口组的信息，并自动为每个端口组创建一个一一对应的二层网络。因VMware不负责虚拟机的IP地址管理，因此同步后二层网络上的IP子网信息需要管理员在Cloudpods上维护。&lt;/p>
&lt;h2 id="vmware-ip子网的维护">VMware IP子网的维护&lt;/h2>
&lt;p>Cloudpods平台虚拟机的虚拟网卡包含如下四个信息：关联的虚拟机，对接的IP子网，虚拟网卡的IP地址和MAC地址。因为VMware不负责维护IP子网的信息，因此纳管VMware云账号后，我们只能获知每台虚拟机对接的虚拟网卡的MAC地址，对接的端口组（以及对应的二层网络）。更进一步地，如果VMware虚拟机内安装并运行版本匹配的VMware Tools软件，则VMware平台也能通过VMware tools获得虚拟机内配置的IP地址。但因为IP子网信息的缺失，导致刚纳管后的VMware虚拟机都没有虚拟网卡的记录。为了方便用户使用，如果虚拟机的IP地址可以通过VMware Tools获取，则会把该IP地址信息记录在虚拟机的标签上，但这仅仅是做了一个标记。为了纳管的VMware虚拟机有虚拟网卡的记录，需要在平台创建合适的IP子网。&lt;/p>
&lt;p>IP子网需要创建在二层网络之上。在一个VMware二层网络上创建的IP子网应该包含该二层网络对应的端口组对接的虚拟机的IP地址。因此，为了维护IP子网的方便，建议一个IP子网的网段只在一个VMware端口组内使用。&lt;/p>
&lt;p>创建好IP子网后，再次同步VMware云账号，对于可以探测到IP地址的VMware虚拟机，平台会根据其IP地址查找到对应二层网络上的IP子网，并创建对应的虚拟网卡记录。对于无法探测到IP地址的VMware虚拟机，平台无法自动创建对应的虚拟网卡。此时，用户可以通过修正IP地址的接口，手动指定该虚拟机的IP地址。平台会根据该IP地址，找到虚拟机所在端口组对应的二层网络上的IP子网，创建对应的虚拟网卡记录，把这个IP地址占住。&lt;/p>
&lt;p>平台默认支持一个IP子网仅归属于一个二层网络，但是在实际使用场景中，存在一段连续的IP地址段被分散在多个端口组的虚拟机使用的情况。此时，管理员在创建IP子网时，需要先指定一个默认的二层网络。创建时，平台会自动检测该IP子网是否还被其他VMware二层网络（上的虚拟机）使用。如果存在，则会自动将对应二层网络设置为该IP子网的附属二层网络。创建后，管理员还可以手动地为该IP子网设置附属二层网络。一台归属于一个IP子网的附属二层网络的虚拟机也可以使用该IP子网的IP。&lt;/p>
&lt;h2 id="vmware新建主机的ip地址分配">VMware新建主机的IP地址分配&lt;/h2>
&lt;p>在 Cloudpods 中创建VMware虚拟机时，平台会自动从虚拟机对接的IP子网中为虚拟机分配一个IP地址，同时根据IP子网和二层网络（端口组）以及宿主机的关联关系，将虚拟机分配到可以使用该IP子网的宿主机上。在VMware平台创建该虚拟机时，平台会在VMware中的ESXi宿主机上找到一个跟该IP子网对应的端口组（如果有多个，则选择其中一个）为虚拟机分配一个端口，并且将该虚拟机的虚拟网卡和该端口组关联。在部署配置阶段，在虚拟机内部署上该网卡对应的网络配置，包括IP地址，子网掩码，网关，DNS等配置信息。虚拟机启动后，该虚拟网卡即自动配置好，可以立即使用。&lt;/p>
&lt;h2 id="常用操作">常用操作&lt;/h2>
&lt;h3 id="修正vmware虚拟机的ip地址">修正VMware虚拟机的IP地址&lt;/h3>
&lt;p>在VMware虚拟机内VMware Tools不工作的情况下，无法通过API获得IP地址，这时候就需要通过修正IP地址的接口，人工设置虚拟机的在平台的IP地址。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">climc server-sync-fix-nics &amp;lt;ID&amp;gt; &amp;lt;IP&amp;gt; ...
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="为ip子网指定附属二层网络">为IP子网指定附属二层网络&lt;/h3>
&lt;p>如果一个IP子网的IP地址被分散在多个二层网络的虚拟机使用，则需要为该IP子网设置额外的附属二层网络，这样确保对接到这些二层网络的虚拟机也能从该IP子网分配IP。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">climc network-sync-additional-wires &amp;lt;NETID&amp;gt; --wire-ids &amp;lt;WIRE_ID&amp;gt; ...
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: VMware迁移到KVM</title><link>https://www.cloudpods.org/zh/docs/function_principle/multicloud/vmware/vmware_v2v/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/multicloud/vmware/vmware_v2v/</guid><description>
&lt;h2 id="将纳管的vmware主机迁移到kvm私有云">将纳管的VMware主机迁移到KVM私有云&lt;/h2>
&lt;p>云平台支持将纳管的VMware主机迁移到内置KVM私有云主机。其工作原理为：&lt;/p>
&lt;ol>
&lt;li>前提条件&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>VMware主机对接的经典网络IP子网在KVM私有云中也能分配给虚拟机使用&lt;/li>
&lt;li>KVM内置私有云的宿主机和VMware的ESXi宿主机之间网络可以互相访问&lt;/li>
&lt;li>VMware主机处于关机状态&lt;/li>
&lt;/ul>
&lt;ol start="2">
&lt;li>迁移方法&lt;/li>
&lt;/ol>
&lt;p>通过climc命令迁移，执行&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">climc server-convert-to-kvm &amp;lt;sid&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中，&lt;sid>为纳管的VMware主机的名称或ID。&lt;/p>
&lt;ol start="3">
&lt;li>迁移过程&lt;/li>
&lt;/ol>
&lt;ol>
&lt;li>在KVM平台创建和VMware主机同配置的虚拟机，并且将VMware主机的虚拟网卡卸载，挂载到新建的KVM虚拟机上，创建虚拟磁盘，并且将VMware主机的磁盘作为KVM虚拟机磁盘的backing file
2）启动KVM虚拟机，远程挂载VMware主机的磁盘，作为KVM虚拟机的磁盘的backing file
3）启动成功后，KVM虚拟机的磁盘内容为VMware虚拟机的磁盘，网络IP是VMware主机的IP。同时，将VMware主机设置为Freeze状态，禁止VMware主机启动
4）启动后，开始磁盘数据同步，会将KVM虚拟磁盘底层的VMware虚拟机磁盘数据同步到KVM虚拟机的上层磁盘文件，磁盘数据同步完成后，KVM虚拟机不再依赖VMware虚拟机&lt;/li>
&lt;li>磁盘数据同步完成后，可以删除原来的VMware虚拟机，完成迁移&lt;/li>
&lt;/ol>
&lt;ol start="4">
&lt;li>迁移回滚&lt;/li>
&lt;/ol>
&lt;p>如果迁移失败，则需要删除KVM虚拟机(需确保在回收站清理)。删除后，会自动将虚拟网卡挂载回VMware虚拟机，并且解除VMware主机Freeze状态&lt;/p></description></item><item><title>Docs: VMware</title><link>https://www.cloudpods.org/zh/docs/function_principle/multicloud/vmware/vmware/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/function_principle/multicloud/vmware/vmware/</guid><description>
&lt;h2 id="vmware同步后主机没有ip">VMware同步后主机没有IP&lt;/h2>
&lt;p>可能有两种原因：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>因为VMware主机的IP是通过虚拟机内的vmtools获取的，如果同步的时候虚拟机处于关机状态，或者虚拟机内vmtools未安装，或者虚拟机内vmtools未正确运行，则无法获取IP。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>能正常通过vmtools获取虚拟机的IP，但是该IP在平台没有对应的IP子网，导致无法判定虚拟机归属的IP子网。（此时，会将主机的IP信息保存在主机的标签中。前端会展示该IP，但是提示”该IP地址无归属IP子网！请添加包含该IP地址的IP子网并重新同步云账号“。）&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>因此，为了让VMware的主机在同步后有IP地址，需要满足两个条件：&lt;/p>
&lt;p>1）主机正在运行，且主机内已安装vmtools，并且vmtools正常运行&lt;/p>
&lt;p>2）主机IP在云台有归属的经典网络（Default VPC）的IP子网&lt;/p>
&lt;h2 id="vmware同步后缺少主机">VMware同步后缺少主机&lt;/h2>
&lt;p>云平台同步资源时，要求VMware主机的UUID全局唯一，会自动忽略UUID相同的所有主机。可以从同步日志发现UUID相同的主机同步日志。&lt;/p>
&lt;p>为了让UUID相同的主机能正常同步，需要手动修改主机的UUID，保证全局唯一。方法为：&lt;/p>
&lt;p>在VMware平台，编辑主机的.vmx配置文件，修改bios.uuid字段。&lt;/p></description></item></channel></rss>