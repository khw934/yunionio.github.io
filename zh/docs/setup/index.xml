<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloudpods –
安装部署</title><link>https://www.cloudpods.org/zh/docs/setup/</link><description>Recent content in 安装部署 on Cloudpods</description><generator>Hugo -- gohugo.io</generator><lastBuildDate>Wed, 12 Feb 2020 12:55:46 +0800</lastBuildDate><atom:link href="https://www.cloudpods.org/zh/docs/setup/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: 组件概览</title><link>https://www.cloudpods.org/zh/docs/setup/intro/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/intro/</guid><description>
&lt;p>Cloudpods目前支持在 CentOS 7 (x86_64 或 arm64) 和 Debian 10 (arm64) 上运行，待部署组件/服务如下:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">服务组件&lt;/th>
&lt;th style="text-align:center">用途&lt;/th>
&lt;th style="text-align:center">安装方式&lt;/th>
&lt;th style="text-align:center">运行方式&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">mariadb&lt;/td>
&lt;td style="text-align:center">关系型数据库&lt;/td>
&lt;td style="text-align:center">rpm&lt;/td>
&lt;td style="text-align:center">systemd&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">docker&lt;/td>
&lt;td style="text-align:center">容器运行时&lt;/td>
&lt;td style="text-align:center">rpm&lt;/td>
&lt;td style="text-align:center">systemd&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">kubelet&lt;/td>
&lt;td style="text-align:center">管理 kubernetes pod&lt;/td>
&lt;td style="text-align:center">rpm&lt;/td>
&lt;td style="text-align:center">systemd&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">ansibleserver&lt;/td>
&lt;td style="text-align:center">ansible脚本管理和执行服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">apigateway&lt;/td>
&lt;td style="text-align:center">web前端的API网关&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">baremetal-agent&lt;/td>
&lt;td style="text-align:center">管理物理机&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">cloudevent&lt;/td>
&lt;td style="text-align:center">云上日志和裸金属日志收集服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">cloudid&lt;/td>
&lt;td style="text-align:center">公有云SAML SSO服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">cloudmon&lt;/td>
&lt;td style="text-align:center">公有云监控指标采集服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">devtool&lt;/td>
&lt;td style="text-align:center">运维工具服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">esxi-agent&lt;/td>
&lt;td style="text-align:center">VMware ESXi管理服务代理&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">etcd&lt;/td>
&lt;td style="text-align:center">基础服务，存储服务间推送消息，分布式锁等等信息&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">glance&lt;/td>
&lt;td style="text-align:center">镜像存储&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">host&lt;/td>
&lt;td style="text-align:center">管理虚拟机&lt;/td>
&lt;td style="text-align:center">k8s daemonset&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">sdnagent&lt;/td>
&lt;td style="text-align:center">管理虚拟机流表规则，实现网络安全组和限速等功能&lt;/td>
&lt;td style="text-align:center">k8s daemonset&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">ovn-controller&lt;/td>
&lt;td style="text-align:center">实现ovn数据库到每台宿主机OVS的流表同步&lt;/td>
&lt;td style="text-align:center">k8s daemonset&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">host-deployer&lt;/td>
&lt;td style="text-align:center">虚拟机部署服务，负责挂载虚拟机镜像，进行识别和修改&lt;/td>
&lt;td style="text-align:center">k8s daemonset&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">host-image&lt;/td>
&lt;td style="text-align:center">虚拟机本地磁盘数据传输服务&lt;/td>
&lt;td style="text-align:center">k8s daemonset&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">influxdb&lt;/td>
&lt;td style="text-align:center">监控数据库&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">keystone&lt;/td>
&lt;td style="text-align:center">认证服务, 提供用户认证，服务间的API认证&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">kubeserver&lt;/td>
&lt;td style="text-align:center">容器管理服务，管理多个k8s容器集群，基于主机创建k8s集群&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">logger&lt;/td>
&lt;td style="text-align:center">操作日志服务，存储所有服务的操作日志&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">monitor&lt;/td>
&lt;td style="text-align:center">监控服务，提供监控API，提供报警服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">notify&lt;/td>
&lt;td style="text-align:center">消息通知服务，负责短信，邮件，以及IM的消息发送&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">onecloud-service-operator&lt;/td>
&lt;td style="text-align:center">编排服务控制器&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">ovn-north&lt;/td>
&lt;td style="text-align:center">OVN虚拟网络的数据维护服务，OVN标准组件&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">region&lt;/td>
&lt;td style="text-align:center">云控制器，控制服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">region-dns&lt;/td>
&lt;td style="text-align:center">主机自定义域名服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">s3gateway&lt;/td>
&lt;td style="text-align:center">对象存储统一网关，实现对所有对象存储的统一访问&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">scheduler&lt;/td>
&lt;td style="text-align:center">虚拟机调度服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">telegraf&lt;/td>
&lt;td style="text-align:center">监控代理，采集每个节点的监控数据，并存储到influxdb&lt;/td>
&lt;td style="text-align:center">k8s daemonset&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">vpcagent&lt;/td>
&lt;td style="text-align:center">VPC代理网关，实现云平台和OVN的信息同步&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">web&lt;/td>
&lt;td style="text-align:center">前端服务，是一个nginx容器，内置web前端js代码&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">webconsole&lt;/td>
&lt;td style="text-align:center">云主机和容器的web终端服务&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">yunionconf&lt;/td>
&lt;td style="text-align:center">前端个性化配置信息的存储和管理&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">onecloud-operator&lt;/td>
&lt;td style="text-align:center">整个Cloudpods服务的K8s Operator，负责服务组件的部署管理&lt;/td>
&lt;td style="text-align:center">k8s deployment&lt;/td>
&lt;td style="text-align:center">container&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">climc&lt;/td>
&lt;td style="text-align:center">命令行工具&lt;/td>
&lt;td style="text-align:center">rpm&lt;/td>
&lt;td style="text-align:center">shell&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">ocadm&lt;/td>
&lt;td style="text-align:center">部署服务管理工具&lt;/td>
&lt;td style="text-align:center">rpm&lt;/td>
&lt;td style="text-align:center">shell&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>其中 host 和 baremetal-agent 可以根据需求选择性部署:&lt;/p>
&lt;ul>
&lt;li>管理 kvm 虚拟机: 部署 host 服务&lt;/li>
&lt;li>管理物理机: 部署 baremetal-agent 服务&lt;/li>
&lt;/ul></description></item><item><title>Docs: 配置要求</title><link>https://www.cloudpods.org/zh/docs/setup/config/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/config/</guid><description>
&lt;h3 id="硬件配置要求">硬件配置要求&lt;/h3>
&lt;p>下表为不同场景需要部署的节点及配置要求等。请根据具体使用场景进行规划部署。&lt;/p>
&lt;table>
&lt;tr>
&lt;th>部署场景&lt;/th>
&lt;th>部署组件&lt;/th>
&lt;th>配置需求&lt;/th>
&lt;th>资源占用情况&lt;/th>
&lt;th>备注&lt;/th>
&lt;/tr>
&lt;tr>
&lt;td>多云场景&lt;/td>
&lt;td>控制节点&lt;/td>
&lt;td>
&lt;li>最低配置：8C16G500G（推荐使用SSD硬盘，且系统盘(根分区大小)不低于200GB）；&lt;/li>
&lt;li>服务器：支持部署在虚拟机或物理服务器；&lt;/li>
&lt;li>操作系统：推荐CentOS 7.6~7.8 Minimal；&lt;/li>
&lt;li>配置要求：每增加500台虚拟机，需要增加8C8G200G(/opt分区大小)的系统资源；&lt;/li>
&lt;li>高可用要求：至少需要3台相同配置的服务器&lt;/li>
&lt;/td>
&lt;td>全部资源&lt;/td>
&lt;td>待纳管的云账号具有读写权限的Access Key ID和Access Key Secret&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td rowspan="3">私有云场景&lt;/td>
&lt;td>控制节点&lt;/td>
&lt;td>
&lt;li>最低配置：8C16G500G（推荐使用SSD硬盘，且系统盘(根分区大小)不低于200GB）；&lt;/li>
&lt;li>服务器：支持部署在虚拟机或物理服务器；&lt;/li>
&lt;li>操作系统：推荐CentOS 7.6~7.8 Minimal；&lt;/li>
&lt;li>配置要求：每增加500台虚拟机，需要增加8C8G200G(/opt分区大小)的系统资源；&lt;/li>
&lt;li>高可用要求：至少需要3台相同配置的服务器&lt;/li>
&lt;/td>
&lt;td>全部资源&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>计算节点&lt;/td>
&lt;td>
&lt;li>服务器：带硬件虚拟化特性的通用X86物理服务器；&lt;/li>
&lt;li>操作系统：推荐CentOS 7.6~7.8 Minimal；&lt;/li>
&lt;li>配置要求：CPU需开启VT、32G以上内存、1T以上的硬盘&lt;/li>
&lt;/td>
&lt;td>产品服务需占用2C2G200G的系统资源&lt;/td>
&lt;td>
&lt;li>如使用经典网络则需为虚拟机申请网络可达的内网IP。&lt;/li>
&lt;li>如使用VPC网络则需要申请内网可达的IP地址段作为弹性公网IP&lt;/li>
&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Ceph存储&lt;/td>
&lt;td>
&lt;li>服务器：通用X86物理服务器；&lt;/li>
&lt;li>配置要求：至少32C64G、系统盘使用单独硬盘、数据盘配置4块以上大容量SATA硬盘，且支持直通模式&lt;/li>
&lt;li>网络：万兆及以上&lt;/li>
&lt;/td>
&lt;td>不占用资源&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td rowspan="3">物理机纳管&lt;/td>
&lt;td>
&lt;li>控制节点&lt;/li>
&lt;li>启用Baremetal服务&lt;/li>
&lt;/td>
&lt;td>
&lt;li>最低配置：8C16G500G（推荐使用SSD硬盘，且系统盘(根分区大小)不低于200GB）；&lt;/li>
&lt;li>服务器：支持部署在虚拟机或物理服务器；&lt;/li>
&lt;li>操作系统：推荐CentOS 7.6~7.8 Minimal；&lt;/li>
&lt;li>配置要求：每增加500台虚拟机，需要增加8C8G200G(/opt分区大小)的系统资源；&lt;/li>
&lt;li>高可用要求：至少需要3台相同配置的服务器&lt;/li>
&lt;/td>
&lt;td>全部资源&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>裸金属&lt;/td>
&lt;td>
&lt;li>服务器：通用X86物理服务器；&lt;/li>
&lt;li>配置要求：具备IPMI管理功能；启用方式设置为BIOS PXE启动&lt;/li>
&lt;/td>
&lt;td>不占用资源&lt;/td>
&lt;td>
&lt;li>为物理机单独申请网络可达的IPMI和内网IP子网&lt;/li>
&lt;li>若环境不支持DHCP Relay，则要求服务器支持Redfish&lt;/li>
&lt;/td>
&lt;/tr>
&lt;/table>
&lt;h3 id="公有云主机配置注意事项">公有云主机配置注意事项&lt;/h3>
&lt;p>如在公有云中的云主机上部署Cloudpods平台，请注意以下事项：&lt;/p>
&lt;ul>
&lt;li>由于公有云上的云主机不能设置vip，数据库不是双主模式，因此在公有云上无法安装高可用环境，建议仅配置k8s高可用，Cloudpods平台部署一个控制节点和两个计算节点。&lt;/li>
&lt;li>当在公有云上部署多个节点时，建议云主机之间请放开全部端口。&lt;/li>
&lt;li>在公有云上部署环境时，建议部署Mariadb数据库，不要使用mysql 5.6及以下版本，防止索引长度 bug： Index column size too large. The maximum column size is 767 bytes.&lt;/li>
&lt;/ul></description></item><item><title>Docs: 高可用安装</title><link>https://www.cloudpods.org/zh/docs/setup/ha-ce/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/ha-ce/</guid><description>
&lt;h2 id="环境准备">环境准备&lt;/h2>
&lt;p>关于环境的准备和不同架构 CPU 操作系统的要求，请参考 &lt;a href="../../quickstart/allinone#%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AE%E8%A6%81%E6%B1%82">All in One 安装/机器配置要求&lt;/a>。&lt;/p>
&lt;p>假设准备好了 3 台 CentOS7 机器，以及 1 台 Mariadb/MySQL 的机器，规划如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>role&lt;/th>
&lt;th>ip&lt;/th>
&lt;th>interface&lt;/th>
&lt;th>note&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>k8s primary&lt;/td>
&lt;td>10.127.90.101&lt;/td>
&lt;td>eth0&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s master 1&lt;/td>
&lt;td>10.127.90.102&lt;/td>
&lt;td>eth0&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s master 2&lt;/td>
&lt;td>10.127.90.103&lt;/td>
&lt;td>eth0&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s VIP&lt;/td>
&lt;td>10.127.190.10&lt;/td>
&lt;td>-&lt;/td>
&lt;td>-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DB&lt;/td>
&lt;td>10.127.190.11&lt;/td>
&lt;td>-&lt;/td>
&lt;td>pswd=&amp;ldquo;0neC1oudDB#&amp;rdquo;, port=3306&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>其中 DB 的部署目前是不归 ocboot 部署工具管理的，需要提前手动部署，高可用的数据库部署可以参考文档 &lt;a href="../db-ha">部署 DB HA 环境&lt;/a> 。&lt;/p>
&lt;h2 id="开始安装">开始安装&lt;/h2>
&lt;h3 id="下载-ocboot">下载 ocboot&lt;/h3>
&lt;p>参考 &lt;a href="../../quickstart/allinone/#%E4%B8%8B%E8%BD%BD-ocboot">All in One 安装/下载 ocboot&lt;/a>。&lt;/p>
&lt;h3 id="编写部署配置">编写部署配置&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 填充变量，生成配置&lt;/span>
&lt;span style="color:#000">DB_IP&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;10.127.190.11&amp;#34;&lt;/span>
&lt;span style="color:#000">DB_PORT&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">3306&lt;/span>
&lt;span style="color:#000">DB_PSWD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;0neC1oudDB#&amp;#34;&lt;/span>
&lt;span style="color:#000">DB_USER&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>root
&lt;span style="color:#000">K8S_VIP&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>10.127.190.10
&lt;span style="color:#000">PRIMARY_INTERFACE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;eth0&amp;#34;&lt;/span>
&lt;span style="color:#000">PRIMARY_IP&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>10.127.90.101
&lt;span style="color:#000">MASTER_1_INTERFACE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;eth0&amp;#34;&lt;/span>
&lt;span style="color:#000">MASTER_1_IP&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>10.127.90.102
&lt;span style="color:#000">MASTER_2_INTERFACE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;eth0&amp;#34;&lt;/span>
&lt;span style="color:#000">MASTER_2_IP&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>10.127.90.103
cat &amp;gt; config-k8s-ha.yml &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF
&lt;/span>&lt;span style="color:#4e9a06">primary_master_node:
&lt;/span>&lt;span style="color:#4e9a06"> hostname: $PRIMARY_IP
&lt;/span>&lt;span style="color:#4e9a06"> use_local: false
&lt;/span>&lt;span style="color:#4e9a06"> user: root
&lt;/span>&lt;span style="color:#4e9a06"> onecloud_version: &amp;#34;v3.9.9&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> db_host: $DB_IP
&lt;/span>&lt;span style="color:#4e9a06"> db_user: &amp;#34;$DB_USER&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> db_password: &amp;#34;$DB_PSWD&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> db_port: &amp;#34;$DB_PORT&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> skip_docker_config: true
&lt;/span>&lt;span style="color:#4e9a06"> image_repository: registry.cn-beijing.aliyuncs.com/yunionio
&lt;/span>&lt;span style="color:#4e9a06"> ha_using_local_registry: false
&lt;/span>&lt;span style="color:#4e9a06"> node_ip: &amp;#34;$PRIMARY_IP&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> ip_autodetection_method: &amp;#34;can-reach=$PRIMARY_IP&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_host: $K8S_VIP
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_port: &amp;#34;6443&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> as_host: true
&lt;/span>&lt;span style="color:#4e9a06"> high_availability: true
&lt;/span>&lt;span style="color:#4e9a06"> use_ee: false
&lt;/span>&lt;span style="color:#4e9a06"> enable_minio: true
&lt;/span>&lt;span style="color:#4e9a06"> registry_mirrors:
&lt;/span>&lt;span style="color:#4e9a06"> - https://lje6zxpk.mirror.aliyuncs.com
&lt;/span>&lt;span style="color:#4e9a06"> insecure_registries:
&lt;/span>&lt;span style="color:#4e9a06"> - $PRIMARY_IP:5000
&lt;/span>&lt;span style="color:#4e9a06"> host_networks: &amp;#34;$PRIMARY_INTERFACE/br0/$PRIMARY_IP&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">master_nodes:
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_host: $K8S_VIP
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_port: &amp;#34;6443&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> as_controller: true
&lt;/span>&lt;span style="color:#4e9a06"> as_host: true
&lt;/span>&lt;span style="color:#4e9a06"> ntpd_server: &amp;#34;$PRIMARY_IP&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> registry_mirrors:
&lt;/span>&lt;span style="color:#4e9a06"> - https://lje6zxpk.mirror.aliyuncs.com
&lt;/span>&lt;span style="color:#4e9a06"> high_availability: true
&lt;/span>&lt;span style="color:#4e9a06"> hosts:
&lt;/span>&lt;span style="color:#4e9a06"> - user: root
&lt;/span>&lt;span style="color:#4e9a06"> hostname: &amp;#34;$MASTER_1_IP&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> host_networks: &amp;#34;$MASTER_1_INTERFACE/br0/$MASTER_1_IP&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> - user: root
&lt;/span>&lt;span style="color:#4e9a06"> hostname: &amp;#34;$MASTER_2_IP&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> host_networks: &amp;#34;$MASTER_2_INTERFACE/br0/$MASTER_2_IP&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="开始部署">开始部署&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ./ocboot.py install ./config-k8s-ha.yml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>等待部署完成后，就可以使用浏览器访问 https://10.127.190.10 (VIP), 输入用户名 &lt;code>admin&lt;/code> 和密码 &lt;code>admin@123&lt;/code>，进入前端。&lt;/p>
&lt;p>另外部署完成后，可以给已有集群添加节点，参考文档：&lt;a href="../host">添加计算节点&lt;/a>。&lt;/p>
&lt;h2 id="常见问题">常见问题&lt;/h2>
&lt;h3 id="1-如何手动重新添加控制控制节点">1. 如何手动重新添加控制控制节点？&lt;/h3>
&lt;p>3个控制节点都会运行 kube-apiserver, etcd 这些关键服务，如果遇到某一个节点遇到 etcd 数据不一致，可以将该节点 reset 后重新加入集群，步骤如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 到其他正常的控制节点创建 join token&lt;/span>
$ &lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">KUBECONFIG&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/etc/kubernetes/admin.conf
$ ocadm token create --description &lt;span style="color:#4e9a06">&amp;#34;ocadm-playbook-node-joining-token&amp;#34;&lt;/span> --ttl 90m
2fmpbx.7zikd8sp5uhaxrjr
&lt;span style="color:#8f5902;font-style:italic"># 获取控制节点认证&lt;/span>
$ /opt/yunion/bin/ocadm init phase upload-certs &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -v upload-certs
6150f8da2dcdf3a8a730f407ddce9f1cb9f24b15ffa4e4b3680e16ed40201cf0
&lt;span style="color:#8f5902;font-style:italic">########## 注意下面的命令需要登陆到需要重新加入的节点执行 ###########&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 如果该节点曾经作为计算节点加入过云平台&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 需要备份当前宿主机 /etc/yunion/host.conf 配置&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>your-reset-node&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> $ cp /etc/yunion/host.conf /etc/yunion/host.conf.manual.bk
&lt;span style="color:#8f5902;font-style:italic"># 登陆到需要重新 reset 加入的节点，reset 当前的 kubernetes 环境&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>your-reset-node&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> $ kubeadm reset -f
&lt;span style="color:#8f5902;font-style:italic"># 假设当前的网卡为 bond0(如果不做 bond ，物理网卡一般为 eth0 之类的名称)，ip 为 172.16.84.40，需要加入集群 172.16.84.101:6443 集群&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>your-reset-node&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> $ ocadm join &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --control-plane 172.16.84.101:6443 &lt;span style="color:#4e9a06">\ &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 加入的目标集群&lt;/span>
--token 2fmpbx.7zikd8sp5uhaxrjr --certificate-key 6150f8da2dcdf3a8a730f407ddce9f1cb9f24b15ffa4e4b3680e16ed40201cf0 --discovery-token-unsafe-skip-ca-verification &lt;span style="color:#4e9a06">\ &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 加入认证信息&lt;/span>
--apiserver-advertise-address 172.16.84.40 --node-ip 172.16.84.40 &lt;span style="color:#4e9a06">\ &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 该节点 ip&lt;/span>
--as-onecloud-controller &lt;span style="color:#4e9a06">\ &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 作为 cloudpods 控制节点&lt;/span>
--enable-host-agent &lt;span style="color:#4e9a06">\ &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 作为 cloudpods 计算节点&lt;/span>
--host-networks &lt;span style="color:#4e9a06">&amp;#39;bond0/br0/172.16.84.40&amp;#39;&lt;/span> &lt;span style="color:#4e9a06">\ &lt;/span>&lt;span style="color:#8f5902;font-style:italic"># 计算节点的桥接网络，意思创建 br0 网桥，并把 bond0 加入进来，给 br0 网桥配置 ip 172.16.84.40&lt;/span>
--high-availability-vip 172.16.84.101 --keepalived-version-tag v2.0.25 &lt;span style="color:#8f5902;font-style:italic"># keepalived 的 vip ，保证 kube-apiserver 的高可用性&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 等待加入完成后，还原 /etc/yunion/host.conf.manual.bk 配置&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>your-reset-node&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> $ cp /etc/yunion/host.conf.manual.bk /etc/yunion/host.conf
&lt;span style="color:#8f5902;font-style:italic"># 重启 host 服务&lt;/span>
$ kubectl get pods -n onecloud -o wide &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep host &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep &lt;span style="color:#000">$your&lt;/span>-reset-node
$ kubectl delete pods -n onecloud default-host-xxxx
&lt;/code>&lt;/pre>&lt;/div>&lt;p>以上手动的步骤参考了 ocboot join master-node 的逻辑，可参考 &lt;a href="https://github.com/yunionio/ocboot/blob/master/onecloud/roles/master-node/tasks/main.yml">https://github.com/yunionio/ocboot/blob/master/onecloud/roles/master-node/tasks/main.yml&lt;/a> 。&lt;/p></description></item><item><title>Docs: 部署 DB HA 环境</title><link>https://www.cloudpods.org/zh/docs/setup/db-ha/</link><pubDate>Wed, 12 Feb 2020 12:55:46 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/db-ha/</guid><description>
&lt;p>Cloudpods 平台服务使用 Mariadb，这里使用 keepalived 和 Mariadb 的主主复制功能来实现 DB 的高可用。&lt;/p>
&lt;h2 id="部署">部署&lt;/h2>
&lt;p>keepalived 的主要作用是为 Mariadb 提供 vip，在2个 Mariadb 实例之间切换，不间断的提供服务。&lt;/p>
&lt;h3 id="部署配置-mariadb-主主复制">部署配置 Mariadb 主主复制&lt;/h3>
&lt;p>安装并启动 Mariadb&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ yum install -y mariadb-server
$ systemctl &lt;span style="color:#204a87">enable&lt;/span> --now mariadb
&lt;/code>&lt;/pre>&lt;/div>&lt;p>运行 Mariadb 安全配置向导，设置密码等&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ mysql_secure_installation
... ...
Change the root password? &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>Y/n&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> y
New password:
Re-enter new password:
Password updated successfully!
Reloading privilege tables..
... Success!
... ...
Remove anonymous users? &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>Y/n&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> y
... Success!
... ...
Disallow root login remotely? &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>Y/n&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> y
... Success!
... ...
Remove &lt;span style="color:#204a87">test&lt;/span> database and access to it? &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>Y/n&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> y
- Dropping &lt;span style="color:#204a87">test&lt;/span> database...
... Success!
- Removing privileges on &lt;span style="color:#204a87">test&lt;/span> database...
... Success! ... ...
Reload privilege tables now? &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>Y/n&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> y
... Success!
... ...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>修改 Mariadb 配置文件，准备配置主主复制&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 主节点&lt;/span>
$ cat &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF &amp;gt; /etc/my.cnf
&lt;/span>&lt;span style="color:#4e9a06">[mysqld]
&lt;/span>&lt;span style="color:#4e9a06">datadir=/var/lib/mysql
&lt;/span>&lt;span style="color:#4e9a06">socket=/var/lib/mysql/mysql.sock
&lt;/span>&lt;span style="color:#4e9a06"># Disabling symbolic-links is recommended to prevent assorted security risks
&lt;/span>&lt;span style="color:#4e9a06">symbolic-links=0
&lt;/span>&lt;span style="color:#4e9a06"># Settings user and group are ignored when systemd is used.
&lt;/span>&lt;span style="color:#4e9a06"># If you need to run mysqld under a different user or group,
&lt;/span>&lt;span style="color:#4e9a06"># customize your systemd unit file for mariadb according to the
&lt;/span>&lt;span style="color:#4e9a06"># instructions in http://fedoraproject.org/wiki/Systemd
&lt;/span>&lt;span style="color:#4e9a06"># skip domain name resolve
&lt;/span>&lt;span style="color:#4e9a06">skip_name_resolve
&lt;/span>&lt;span style="color:#4e9a06"># auto delete binlog older than 30 days
&lt;/span>&lt;span style="color:#4e9a06">expire_logs_days=30
&lt;/span>&lt;span style="color:#4e9a06">innodb_file_per_table=ON
&lt;/span>&lt;span style="color:#4e9a06">max_connections = 300
&lt;/span>&lt;span style="color:#4e9a06">max_allowed_packet=20M
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">server-id = 1
&lt;/span>&lt;span style="color:#4e9a06">auto_increment_offset = 1
&lt;/span>&lt;span style="color:#4e9a06">auto_increment_increment = 2
&lt;/span>&lt;span style="color:#4e9a06">log-bin = mysql-bin
&lt;/span>&lt;span style="color:#4e9a06">binlog-format = row
&lt;/span>&lt;span style="color:#4e9a06">log-slave-updates
&lt;/span>&lt;span style="color:#4e9a06">max_binlog_size = 1G
&lt;/span>&lt;span style="color:#4e9a06">replicate-ignore-db = information_schema
&lt;/span>&lt;span style="color:#4e9a06">replicate-ignore-db = performance_schema
&lt;/span>&lt;span style="color:#4e9a06">max_connections = 1000
&lt;/span>&lt;span style="color:#4e9a06">max_connect_errors = 0
&lt;/span>&lt;span style="color:#4e9a06">max_allowed_packet = 1G
&lt;/span>&lt;span style="color:#4e9a06">slave-net-timeout=10
&lt;/span>&lt;span style="color:#4e9a06">master-retry-count=0
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">slow_query_log = 1
&lt;/span>&lt;span style="color:#4e9a06">long_query_time = 2
&lt;/span>&lt;span style="color:#4e9a06">slow_query_log_file = /var/log/mariadb/slow-query.log
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">[mysql]
&lt;/span>&lt;span style="color:#4e9a06">no-auto-rehash
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">[mysqld_safe]
&lt;/span>&lt;span style="color:#4e9a06">log-error=/var/log/mariadb/mariadb.log
&lt;/span>&lt;span style="color:#4e9a06">pid-file=/var/run/mariadb/mariadb.pid
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">#
&lt;/span>&lt;span style="color:#4e9a06"># include all files from the config directory
&lt;/span>&lt;span style="color:#4e9a06">#
&lt;/span>&lt;span style="color:#4e9a06">!includedir /etc/my.cnf.d
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 备节点&lt;/span>
$ cat &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF &amp;gt; /etc/my.cnf
&lt;/span>&lt;span style="color:#4e9a06">[mysqld]
&lt;/span>&lt;span style="color:#4e9a06">datadir=/var/lib/mysql
&lt;/span>&lt;span style="color:#4e9a06">socket=/var/lib/mysql/mysql.sock
&lt;/span>&lt;span style="color:#4e9a06"># Disabling symbolic-links is recommended to prevent assorted security risks
&lt;/span>&lt;span style="color:#4e9a06">symbolic-links=0
&lt;/span>&lt;span style="color:#4e9a06"># Settings user and group are ignored when systemd is used.
&lt;/span>&lt;span style="color:#4e9a06"># If you need to run mysqld under a different user or group,
&lt;/span>&lt;span style="color:#4e9a06"># customize your systemd unit file for mariadb according to the
&lt;/span>&lt;span style="color:#4e9a06"># instructions in http://fedoraproject.org/wiki/Systemd
&lt;/span>&lt;span style="color:#4e9a06"># skip domain name resolve
&lt;/span>&lt;span style="color:#4e9a06">skip_name_resolve
&lt;/span>&lt;span style="color:#4e9a06"># auto delete binlog older than 30 days
&lt;/span>&lt;span style="color:#4e9a06">expire_logs_days=30
&lt;/span>&lt;span style="color:#4e9a06">innodb_file_per_table=ON
&lt;/span>&lt;span style="color:#4e9a06">max_connections = 300
&lt;/span>&lt;span style="color:#4e9a06">max_allowed_packet=20M
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">server-id = 2
&lt;/span>&lt;span style="color:#4e9a06">auto_increment_offset = 2
&lt;/span>&lt;span style="color:#4e9a06">auto_increment_increment = 2
&lt;/span>&lt;span style="color:#4e9a06">log-bin = mysql-bin
&lt;/span>&lt;span style="color:#4e9a06">binlog-format = row
&lt;/span>&lt;span style="color:#4e9a06">log-slave-updates
&lt;/span>&lt;span style="color:#4e9a06">max_binlog_size = 1G
&lt;/span>&lt;span style="color:#4e9a06">replicate-ignore-db = information_schema
&lt;/span>&lt;span style="color:#4e9a06">replicate-ignore-db = performance_schema
&lt;/span>&lt;span style="color:#4e9a06">max_connections = 1000
&lt;/span>&lt;span style="color:#4e9a06">max_connect_errors = 0
&lt;/span>&lt;span style="color:#4e9a06">max_allowed_packet = 1G
&lt;/span>&lt;span style="color:#4e9a06">slave-net-timeout=10
&lt;/span>&lt;span style="color:#4e9a06">master-retry-count=0
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">slow_query_log = 1
&lt;/span>&lt;span style="color:#4e9a06">long_query_time = 2
&lt;/span>&lt;span style="color:#4e9a06">slow_query_log_file = /var/log/mariadb/slow-query.log
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">[mysql]
&lt;/span>&lt;span style="color:#4e9a06">no-auto-rehash
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">[mysqld_safe]
&lt;/span>&lt;span style="color:#4e9a06">log-error=/var/log/mariadb/mariadb.log
&lt;/span>&lt;span style="color:#4e9a06">pid-file=/var/run/mariadb/mariadb.pid
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">#
&lt;/span>&lt;span style="color:#4e9a06"># include all files from the config directory
&lt;/span>&lt;span style="color:#4e9a06">#
&lt;/span>&lt;span style="color:#4e9a06">!includedir /etc/my.cnf.d
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 重启服务&lt;/span>
$ systemctl restart mariadb
&lt;/code>&lt;/pre>&lt;/div>&lt;p>主节点创建只读账号，导出全部数据，导入备节点。记录binlog日志文件名和position。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 以下命令在主节点执行&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 此密码为上面设置的 Mariadb root 密码，为了方便，只读账号也使用此密码&lt;/span>
$ &lt;span style="color:#000">MYSQL_PASSWD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;your-sql-passwd&amp;#39;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 开启 Mariadb 的远程访问&lt;/span>
$ mysql -uroot -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;GRANT ALL PRIVILEGES ON *.* TO &amp;#39;root&amp;#39;@&amp;#39;%&amp;#39; IDENTIFIED BY &amp;#39;&lt;/span>&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span>&lt;span style="color:#4e9a06">&amp;#39; WITH GRANT OPTION;FLUSH PRIVILEGES&amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 创建只读账号&lt;/span>
$ mysql -u root -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;GRANT REPLICATION SLAVE ON *.* TO repl@&amp;#39;%&amp;#39; IDENTIFIED BY &amp;#39;&lt;/span>&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;;FLUSH PRIVILEGES&amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 示例是全新安装的 Mariadb ，还没有使用。如果是正在使用的数据库做主主复制，需要锁表后再导出数据&lt;/span>
$ mysql -uroot -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;SHOW PROCESSLIST&amp;#34;&lt;/span>
+----+------+-----------+------+---------+------+-------+------------------+----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Id &lt;span style="color:#000;font-weight:bold">|&lt;/span> User &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host &lt;span style="color:#000;font-weight:bold">|&lt;/span> db &lt;span style="color:#000;font-weight:bold">|&lt;/span> Command &lt;span style="color:#000;font-weight:bold">|&lt;/span> Time &lt;span style="color:#000;font-weight:bold">|&lt;/span> State &lt;span style="color:#000;font-weight:bold">|&lt;/span> Info &lt;span style="color:#000;font-weight:bold">|&lt;/span> Progress &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----+------+-----------+------+---------+------+-------+------------------+----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> root &lt;span style="color:#000;font-weight:bold">|&lt;/span> localhost &lt;span style="color:#000;font-weight:bold">|&lt;/span> NULL &lt;span style="color:#000;font-weight:bold">|&lt;/span> Query &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> NULL &lt;span style="color:#000;font-weight:bold">|&lt;/span> SHOW PROCESSLIST &lt;span style="color:#000;font-weight:bold">|&lt;/span> 0.000 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+----+------+-----------+------+---------+------+-------+------------------+----------+
&lt;span style="color:#8f5902;font-style:italic"># 记录binlog日志文件名和position&lt;/span>
$ mysql -u root -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;SHOW MASTER STATUS\G&amp;#34;&lt;/span>
*************************** 1. row ***************************
File: mysql-bin.000001
Position: &lt;span style="color:#0000cf;font-weight:bold">2023&lt;/span>
Binlog_Do_DB:
Binlog_Ignore_DB:
&lt;span style="color:#8f5902;font-style:italic"># 导出全部数据&lt;/span>
$ mysqldump --all-databases -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> &amp;gt; alldb.db
&lt;span style="color:#8f5902;font-style:italic"># 拷贝 alldb.db 到备节点&lt;/span>
$ scp alldb.db db2:/root/
&lt;span style="color:#8f5902;font-style:italic"># 以下命令在备节点执行&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 此密码为上面设置的 Mariadb root 密码&lt;/span>
$ &lt;span style="color:#000">MYSQL_PASSWD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;your-sql-passwd&amp;#39;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 导入主节点导出的数据&lt;/span>
mysql -u root -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> &amp;lt; alldb.db
&lt;span style="color:#8f5902;font-style:italic"># 重载权限&lt;/span>
mysql -u root -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;FLUSH PRIVILEGES&amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 记录binlog日志文件名和position&lt;/span>
mysql -u root -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;SHOW MASTER STATUS\G&amp;#34;&lt;/span>
*************************** 1. row ***************************
File: mysql-bin.000001
Position: &lt;span style="color:#0000cf;font-weight:bold">509778&lt;/span>
Binlog_Do_DB:
Binlog_Ignore_DB:
&lt;/code>&lt;/pre>&lt;/div>&lt;p>设置主主复制&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 以下命令在主节点执行&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 修改MASTER_HOST为备节点IP，修改MASTER_LOG_FILE和MASTER_LOG_POS为上面备节点记录的信息&lt;/span>
mysql -u root -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;CHANGE MASTER TO MASTER_HOST=&amp;#39;192.168.199.99&amp;#39;,MASTER_USER=&amp;#39;repl&amp;#39;,MASTER_PASSWORD=&amp;#39;&lt;/span>&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;,MASTER_PORT=3306,MASTER_LOG_FILE=&amp;#39;mysql-bin.000001&amp;#39;,MASTER_LOG_POS=509778,MASTER_CONNECT_RETRY=2;START SLAVE&amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 以下命令在备节点执行&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 修改MASTER_HOST为主节点IP，修改MASTER_LOG_FILE和MASTER_LOG_POS为上面主节点记录的信息&lt;/span>
mysql -u root -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;CHANGE MASTER TO MASTER_HOST=&amp;#39;192.168.199.98&amp;#39;,MASTER_USER=&amp;#39;repl&amp;#39;,MASTER_PASSWORD=&amp;#39;&lt;/span>&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;,MASTER_PORT=3306,MASTER_LOG_FILE=&amp;#39;mysql-bin.000001&amp;#39;,MASTER_LOG_POS=2023,MASTER_CONNECT_RETRY=2;START SLAVE&amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 主备都执行，验证同步状态，都输出2个 Yes 表示正常&lt;/span>
mysql -u root -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;SHOW SLAVE STATUS\G&amp;#34;&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep Running
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
&lt;/code>&lt;/pre>&lt;/div>&lt;p>至此，DB 主主复制部署完成，可以测试在任一节点进行数据库操作，另一节点验证。不过对外提供服务还是需要通过 vip，不然发生切换还需要业务端切换 ip，下面配置 keepalived 对外提供服务。&lt;/p>
&lt;h3 id="部署配置-keepalived">部署配置 keepalived&lt;/h3>
&lt;p>设置相关的环境变量，根据不同的环境自行配置。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># keepalived vip 地址&lt;/span>
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">DB_VIP&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>192.168.199.97
&lt;span style="color:#8f5902;font-style:italic"># keepalived auth toke&lt;/span>
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">DBHA_KA_AUTH&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>onecloud
&lt;span style="color:#8f5902;font-style:italic"># keepalived network interface&lt;/span>
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">DB_NETIF&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>eth0
&lt;/code>&lt;/pre>&lt;/div>&lt;p>设置 sysctl 选项&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ cat &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF &amp;gt;&amp;gt;/etc/sysctl.conf
&lt;/span>&lt;span style="color:#4e9a06">net.ipv4.ip_forward = 1
&lt;/span>&lt;span style="color:#4e9a06">net.ipv4.ip_nonlocal_bind = 1
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
$ sysctl -p
&lt;/code>&lt;/pre>&lt;/div>&lt;p>安装 keepalived nc&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ yum install -y keepalived nc
&lt;/code>&lt;/pre>&lt;/div>&lt;p>添加配置&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 请确保 virtual_router_id 不会和局域网内的其他 keepalived 集群冲突&lt;/span>
$ cat &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF &amp;gt;/etc/keepalived/keepalived.conf
&lt;/span>&lt;span style="color:#4e9a06">global_defs {
&lt;/span>&lt;span style="color:#4e9a06"> router_id onecloud
&lt;/span>&lt;span style="color:#4e9a06">}
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">vrrp_script chk_mysql {
&lt;/span>&lt;span style="color:#4e9a06"> script &amp;#34;/etc/keepalived/chk_mysql&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> interval 1
&lt;/span>&lt;span style="color:#4e9a06">}
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">vrrp_instance VI_1 {
&lt;/span>&lt;span style="color:#4e9a06"> state MASTER
&lt;/span>&lt;span style="color:#4e9a06"> interface $DB_NETIF
&lt;/span>&lt;span style="color:#4e9a06"> virtual_router_id 99
&lt;/span>&lt;span style="color:#4e9a06"> priority 100
&lt;/span>&lt;span style="color:#4e9a06"> advert_int 1
&lt;/span>&lt;span style="color:#4e9a06"> nopreempt
&lt;/span>&lt;span style="color:#4e9a06"> authentication {
&lt;/span>&lt;span style="color:#4e9a06"> auth_type PASS
&lt;/span>&lt;span style="color:#4e9a06"> auth_pass $DBHA_KA_AUTH
&lt;/span>&lt;span style="color:#4e9a06"> }
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06"> track_script {
&lt;/span>&lt;span style="color:#4e9a06"> chk_mysql
&lt;/span>&lt;span style="color:#4e9a06"> }
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06"> virtual_ipaddress {
&lt;/span>&lt;span style="color:#4e9a06"> $DB_VIP
&lt;/span>&lt;span style="color:#4e9a06"> }
&lt;/span>&lt;span style="color:#4e9a06">}
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
$ cat &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF &amp;gt; /etc/keepalived/chk_mysql
&lt;/span>&lt;span style="color:#4e9a06">#!/bin/bash
&lt;/span>&lt;span style="color:#4e9a06">echo | nc 127.0.0.1 3306 &amp;amp;&amp;gt;/dev/null
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
$ chmod +x /etc/keepalived/chk_mysql
&lt;/code>&lt;/pre>&lt;/div>&lt;p>启动 keepalived&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ systemctl &lt;span style="color:#204a87">enable&lt;/span> --now keepalived
$ ip addr show &lt;span style="color:#000">$DB_NETIF&lt;/span>
2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span style="color:#0000cf;font-weight:bold">1500&lt;/span> qdisc pfifo_fast state UP group default qlen &lt;span style="color:#0000cf;font-weight:bold">1000&lt;/span>
link/ether 00:22:cf:40:1e:29 brd ff:ff:ff:ff:ff:ff
inet 192.168.199.99/24 brd 192.168.199.255 scope global dynamic eth0
valid_lft 100651906sec preferred_lft 100651906sec
inet 192.168.199.97/32 scope global eth0
valid_lft forever preferred_lft forever
inet6 fe80::222:cfff:fe40:1e29/64 scope link
valid_lft forever preferred_lft forever
&lt;/code>&lt;/pre>&lt;/div>&lt;p>至此，DB 高可用部署完成，任一节点的 Mariadb 或 keepalived 服务异常，或者任一节点宕机，都不影响对外服务。&lt;/p></description></item><item><title>Docs: 部署集群(已废弃)</title><link>https://www.cloudpods.org/zh/docs/setup/controlplane/</link><pubDate>Sat, 13 Apr 2019 13:01:57 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/controlplane/</guid><description>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;p>本章内容是通过手动在 CentOS 7 上一步一步部署 Cloudpods 服务，已经不建议这么做，本文只是保留作为参考，提供给想要了解部署流程的用户查看。&lt;/p>
&lt;p>实际环境中部署请根据自己使用需求参考: &lt;a href="../../quickstart/allinone">All in One 安装&lt;/a> 或者 &lt;a href="../../quickstart/ha">高可用安装&lt;/a> 部署。&lt;/p>
&lt;/div>
&lt;h2 id="环境准备">环境准备&lt;/h2>
&lt;p>Cloudpods 相关的组件运行在 kubernetes 之上，环境以及相关的软件依赖如下:&lt;/p>
&lt;ul>
&lt;li>操作系统: CentOS 7.6&lt;/li>
&lt;li>最低配置要求: CPU 4核, 内存 8G, 存储 150G&lt;/li>
&lt;li>虚拟机和服务使用的存储路径都在 &lt;strong>/opt&lt;/strong> 目录下，所以理想环境下建议单独给 &lt;strong>/opt&lt;/strong> 目录设置挂载点
&lt;ul>
&lt;li>比如把 /dev/sdb1 单独分区做 ext4 然后通过 /etc/fstab 挂载到 /opt 目录&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>数据库: mariadb (CentOS 7自带的版本：Ver 15.1 Distrib 5.5.56-MariaDB）&lt;/li>
&lt;li>docker: ce-20.10.5&lt;/li>
&lt;li>kubernetes: v1.15.12&lt;/li>
&lt;/ul>
&lt;p>需要能访问如下网址，如果企业有外网隔离规则，则需要打开相应白名单：&lt;/p>
&lt;ul>
&lt;li>CentOS YUM网络安装源&lt;/li>
&lt;li>&lt;a href="https://iso.yunion.cn/">https://iso.yunion.cn/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://registry.cn-beijing.aliyuncs.com">https://registry.cn-beijing.aliyuncs.com&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://meta.yunion.cn">https://meta.yunion.cn&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://yunionmeta.oss-cn-beijing.aliyuncs.com">https://yunionmeta.oss-cn-beijing.aliyuncs.com&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="安装配置-mariadb">安装配置 mariadb&lt;/h3>
&lt;p>mariadb 作为服务数据持久化的数据库，可以部署在其它节点或者使用单独维护的。下面假设还没有部署 mariadb，在控制节点上安装设置 mariadb。&lt;/p>
&lt;p>为了方便运行维护，mariadb推荐打开四个参数设施：&lt;/p>
&lt;ul>
&lt;li>skip_name_resolve：取消域名解析&lt;/li>
&lt;li>expire_logs_days=30：设置binlog的超时时间为30天，超过30天的binglog自动删除&lt;/li>
&lt;li>innodb_file_per_table=ON: 设置innodb的每张表都用一个独立文件存储数据，便于后期数据清理&lt;/li>
&lt;li>max_connections=300: 设置最大连接数为300&lt;/li>
&lt;li>max_allowed_packet=20M: 设置最大数据包大小为20M&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ &lt;span style="color:#000">MYSQL_PASSWD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;your-sql-passwd&amp;#39;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 安装 mariadb&lt;/span>
$ yum install -y epel-release mariadb-server
$ systemctl &lt;span style="color:#204a87">enable&lt;/span> --now mariadb
$ mysqladmin -u root password &lt;span style="color:#4e9a06">&amp;#34;&lt;/span>&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&lt;/span>
$ cat &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF &amp;gt;/etc/my.cnf
&lt;/span>&lt;span style="color:#4e9a06">[mysqld]
&lt;/span>&lt;span style="color:#4e9a06">datadir=/var/lib/mysql
&lt;/span>&lt;span style="color:#4e9a06">socket=/var/lib/mysql/mysql.sock
&lt;/span>&lt;span style="color:#4e9a06"># Disabling symbolic-links is recommended to prevent assorted security risks
&lt;/span>&lt;span style="color:#4e9a06">symbolic-links=0
&lt;/span>&lt;span style="color:#4e9a06"># Settings user and group are ignored when systemd is used.
&lt;/span>&lt;span style="color:#4e9a06"># If you need to run mysqld under a different user or group,
&lt;/span>&lt;span style="color:#4e9a06"># customize your systemd unit file for mariadb according to the
&lt;/span>&lt;span style="color:#4e9a06"># instructions in http://fedoraproject.org/wiki/Systemd
&lt;/span>&lt;span style="color:#4e9a06"># skip domain name resolve
&lt;/span>&lt;span style="color:#4e9a06">skip_name_resolve
&lt;/span>&lt;span style="color:#4e9a06"># auto delete binlog older than 30 days
&lt;/span>&lt;span style="color:#4e9a06">expire_logs_days=30
&lt;/span>&lt;span style="color:#4e9a06">innodb_file_per_table=ON
&lt;/span>&lt;span style="color:#4e9a06">max_connections = 300
&lt;/span>&lt;span style="color:#4e9a06">max_allowed_packet=20M
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">[mysqld_safe]
&lt;/span>&lt;span style="color:#4e9a06">log-error=/var/log/mariadb/mariadb.log
&lt;/span>&lt;span style="color:#4e9a06">pid-file=/var/run/mariadb/mariadb.pid
&lt;/span>&lt;span style="color:#4e9a06">
&lt;/span>&lt;span style="color:#4e9a06">#
&lt;/span>&lt;span style="color:#4e9a06"># include all files from the config directory
&lt;/span>&lt;span style="color:#4e9a06">#
&lt;/span>&lt;span style="color:#4e9a06">!includedir /etc/my.cnf.d
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
$ mysql -uroot -p&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> -e &lt;span style="color:#4e9a06">&amp;#34;GRANT ALL ON *.* to &amp;#39;root&amp;#39;@&amp;#39;%&amp;#39; IDENTIFIED BY &amp;#39;&lt;/span>&lt;span style="color:#000">$MYSQL_PASSWD&lt;/span>&lt;span style="color:#4e9a06">&amp;#39; with grant option; FLUSH PRIVILEGES;&amp;#34;&lt;/span>
$ systemctl restart mariadb
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装配置-docker">安装配置 docker&lt;/h3>
&lt;p>安装 docker&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ yum install -y yum-utils bash-completion
&lt;span style="color:#8f5902;font-style:italic"># 添加 yunion Cloudpods rpm 源&lt;/span>
$ yum-config-manager --add-repo https://iso.yunion.cn/yumrepo-3.8/yunion.repo
$ yum install -y docker-ce docker-ce-cli containerd.io
&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置 docker&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ mkdir -p /etc/docker
$ cat &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF &amp;gt;/etc/docker/daemon.json
&lt;/span>&lt;span style="color:#4e9a06">{
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;bridge&amp;#34;: &amp;#34;none&amp;#34;,
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;iptables&amp;#34;: false,
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;exec-opts&amp;#34;:
&lt;/span>&lt;span style="color:#4e9a06"> [
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;native.cgroupdriver=systemd&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> ],
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;data-root&amp;#34;: &amp;#34;/opt/docker&amp;#34;,
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;live-restore&amp;#34;: true,
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;log-driver&amp;#34;: &amp;#34;json-file&amp;#34;,
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;log-opts&amp;#34;:
&lt;/span>&lt;span style="color:#4e9a06"> {
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;max-size&amp;#34;: &amp;#34;100m&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> },
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;registry-mirrors&amp;#34;:
&lt;/span>&lt;span style="color:#4e9a06"> [
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;https://lje6zxpk.mirror.aliyuncs.com&amp;#34;,
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;https://lms7sxqp.mirror.aliyuncs.com&amp;#34;,
&lt;/span>&lt;span style="color:#4e9a06"> &amp;#34;https://registry.docker-cn.com&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06"> ]
&lt;/span>&lt;span style="color:#4e9a06">}
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>启动 docker&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ systemctl &lt;span style="color:#204a87">enable&lt;/span> --now docker
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装-cloudpods-依赖内核">安装 Cloudpods 依赖内核&lt;/h3>
&lt;p>这里需要安装我们编译的内核，这个内核是基于上游 CentOS 3.10.0-1160 编译的，默认添加了 nbd 模块，nbd 模块用于镜像相关的操作。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 安装内核&lt;/span>
$ yum install -y &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> kernel-3.10.0-1160.6.1.el7.yn20201125 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> kernel-devel-3.10.0-1160.6.1.el7.yn20201125 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> kernel-headers-3.10.0-1160.6.1.el7.yn20201125
&lt;span style="color:#8f5902;font-style:italic"># 重启系统进入内核&lt;/span>
$ reboot
&lt;span style="color:#8f5902;font-style:italic"># 重启完成后，查看当前节点内核信息&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 确保为 3.10.0-1160.6.1.el7.yn20201125.x86_64&lt;/span>
$ uname -r
3.10.0-1160.6.1.el7.yn20201125.x86_64
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安装配置-kubelet">安装配置 kubelet&lt;/h3>
&lt;p>从 Cloudpods rpm 的 yum 源安装 kubernetes 1.15.12，并设置 kubelet 开机自启动&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ yum install -y bridge-utils ipvsadm conntrack-tools &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> jq kubelet-1.15.12-0 kubectl-1.15.12-0 kubeadm-1.15.12-0
$ &lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;source &amp;lt;(kubectl completion bash)&amp;#39;&lt;/span> &amp;gt;&amp;gt; ~/.bashrc &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#204a87">source&lt;/span> ~/.bashrc
$ &lt;span style="color:#204a87">source&lt;/span> /etc/profile
$ systemctl &lt;span style="color:#204a87">enable&lt;/span> kubelet
&lt;/code>&lt;/pre>&lt;/div>&lt;p>安装完 kubernetes 相关的二进制后，还需要对系统做一些配置并启用 ipvs 作为 kube-proxy 内部的 service 负载均衡&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 禁用 swap&lt;/span>
$ swapoff -a
&lt;span style="color:#8f5902;font-style:italic"># 如果设置了自动挂载 swap，需要去 /etc/fstab 里面注释掉挂载 swap 那一行&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 关闭 selinux&lt;/span>
$ setenforce &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>
$ sed -i &lt;span style="color:#4e9a06">&amp;#39;s/SELINUX=enforcing/SELINUX=disabled/&amp;#39;&lt;/span> /etc/selinux/config
&lt;span style="color:#8f5902;font-style:italic"># 禁用 firewalld&lt;/span>
$ systemctl stop firewalld
$ systemctl disable firewalld
&lt;span style="color:#8f5902;font-style:italic"># 禁用 NetworkManager&lt;/span>
$ systemctl stop NetworkManager
$ systemctl disable NetworkManager
$ ps -ef&lt;span style="color:#000;font-weight:bold">|&lt;/span>grep dhcp &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $2}&amp;#39;&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>xargs &lt;span style="color:#204a87">kill&lt;/span> -9
&lt;span style="color:#8f5902;font-style:italic"># 做一些 sysctl 的配置, kubernetes 要求&lt;/span>
$ modprobe br_netfilter
$ cat &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/sysctl.conf
&lt;/span>&lt;span style="color:#4e9a06">net.bridge.bridge-nf-call-iptables=1
&lt;/span>&lt;span style="color:#4e9a06">net.bridge.bridge-nf-call-ip6tables=1
&lt;/span>&lt;span style="color:#4e9a06">net.ipv4.ip_forward=1
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
$ sysctl -p
&lt;span style="color:#8f5902;font-style:italic"># 配置并开启 ipvs&lt;/span>
$ cat &amp;lt;&amp;lt;&lt;span style="color:#4e9a06">&amp;#34;EOF&amp;#34;&lt;/span> &amp;gt; /etc/sysconfig/modules/ipvs.modules
&lt;span style="color:#8f5902;font-style:italic">#!/bin/bash&lt;/span>
&lt;span style="color:#000">ipvs_modules&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack br_netfilter&amp;#34;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> kernel_module in &lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">ipvs_modules&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">do&lt;/span>
/sbin/modinfo -F filename &lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">kernel_module&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span> &amp;gt; /dev/null 2&amp;gt;&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span> &lt;span style="color:#000">$?&lt;/span> -eq &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span> &lt;span style="color:#204a87;font-weight:bold">then&lt;/span>
/sbin/modprobe &lt;span style="color:#4e9a06">${&lt;/span>&lt;span style="color:#000">kernel_module&lt;/span>&lt;span style="color:#4e9a06">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">fi&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">done&lt;/span>
EOF
$ chmod &lt;span style="color:#0000cf;font-weight:bold">755&lt;/span> /etc/sysconfig/modules/ipvs.modules &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> bash /etc/sysconfig/modules/ipvs.modules &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> lsmod &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep ip_vs
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="部署集群">部署集群&lt;/h2>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">提示&lt;/h4>
&lt;blockquote>
&lt;p>如果要部署高可用集群，请先搭建负载均衡集群，参考 &lt;a href="../../setup/controlplane-ha">部署 HA 环境&lt;/a>。&lt;/p>
&lt;/blockquote>
&lt;/div>
&lt;h3 id="安装部署工具">安装部署工具&lt;/h3>
&lt;p>先安装部署工具 ocadm 和云平台的命令行工具 climc:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 安装 climc 云平台命令行工具 和 ocadm 部署工具&lt;/span>
$ yum install -y yunion-climc yunion-ocadm
&lt;span style="color:#8f5902;font-style:italic"># climc 在 /opt/yunion/bin 目录下，根据自己的需要加到 bash 或者 zsh 配置文件里面&lt;/span>
$ &lt;span style="color:#204a87">echo&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;export PATH=$PATH:/opt/yunion/bin&amp;#39;&lt;/span> &amp;gt;&amp;gt; ~/.bashrc &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#204a87">source&lt;/span> ~/.bashrc
&lt;span style="color:#8f5902;font-style:italic"># 安装必要的服务，并启动和设置为开机自启&lt;/span>
$ yum install -y yunion-executor &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> systemctl &lt;span style="color:#204a87">enable&lt;/span> --now yunion-executor
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="部署-kubernetes-集群">部署 kubernetes 集群&lt;/h3>
&lt;p>接下来会现在当前节点启动 v1.15.12 的 kubernetes 服务，然后部署 Cloudpods 控制节点相关的服务到 kubernetes 集群。&lt;/p>
&lt;p>拉取必要的 docker 镜像&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ocadm config images pull
&lt;/code>&lt;/pre>&lt;/div>&lt;p>使用 ocadm 部署 kubernetes 集群&lt;/p>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">提示&lt;/h4>
&lt;blockquote>
&lt;p>如果要进行高可用部署，并已经搭建好了负载均衡集群，需要在 &lt;code>ocadm init&lt;/code> 命令加上 &lt;code>--control-plane-endpoint &amp;lt;vip&amp;gt;:6443&lt;/code> 参数，告诉 kubernetes 集群前端的 LoadBalancer vip，之后生成的配置就会都用这个 vip 当做控制节点的入口。&lt;/p>
&lt;/blockquote>
&lt;/div>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 假设 mariadb 部署在本地，如果是使用已有的数据库，请改变对应的 ip&lt;/span>
$ &lt;span style="color:#000">MYSQL_HOST&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>ip route get &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $NF;exit}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 如果是高可用部署，记得在设置 EXTRA_OPT=&amp;#39; --control-plane-endpoint 10.168.222.18:6443&amp;#39;&lt;/span>
$ &lt;span style="color:#000">EXTRA_OPT&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;&amp;#34;&lt;/span>
$ &lt;span style="color:#8f5902;font-style:italic">#EXTRA_OPT=&amp;#39; --control-plane-endpoint 10.168.222.18:6443&amp;#39;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 开始部署 kubernetes 以及 Cloudpods 必要的控制服务，稍等 3 分钟左右，kubernetes 集群会部署完成&lt;/span>
$ ocadm init --mysql-host &lt;span style="color:#000">$MYSQL_HOST&lt;/span> &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --mysql-user root --mysql-password &lt;span style="color:#000">$MYSQL_PASSWD&lt;/span> &lt;span style="color:#000">$EXTRA_OPT&lt;/span>
...
Your Kubernetes and control-plane has initialized successfully!
...
&lt;/code>&lt;/pre>&lt;/div>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">提示&lt;/h4>
&lt;blockquote>
&lt;p>kubernetes 高可用部署需要 3 个节点，主要是 etcd 需要至少 3 个节点组成高可用集群。如果是高可用部署，请在另外两个节点执行 &lt;code>ocadm join --control-plane &amp;lt;vip&amp;gt;:6443&lt;/code> 部署控制服务，join 的另外两个节点会自动和当前的控制节点组成高可用集群。参考: &lt;a href="../../setup/components/#%E5%8A%A0%E5%85%A5-controlplane">加入控制节点&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;/div>
&lt;p>kubernetes 集群部署完成后，通过以下命令来确保相关的 pod (容器) 都已经启动, 变成 running 的状态。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ mkdir -p &lt;span style="color:#000">$HOME&lt;/span>/.kube
$ sudo cp -i /etc/kubernetes/admin.conf &lt;span style="color:#000">$HOME&lt;/span>/.kube/config
$ sudo chown &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>id -u&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>:&lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>id -g&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> &lt;span style="color:#000">$HOME&lt;/span>/.kube/config
$ kubectl get pods --all-namespaces
NAMESPACE NAME READY STATUS RESTARTS AGE
kube-system calico-kube-controllers-648bb4447c-57gjb 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h1m
kube-system calico-node-j89jg 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h1m
kube-system coredns-69845f69f6-f6wnv 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h1m
kube-system coredns-69845f69f6-sct6n 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h1m
kube-system etcd-lzx-ocadm-test2 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h
kube-system kube-apiserver-lzx-ocadm-test2 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h
kube-system kube-controller-manager-lzx-ocadm-test2 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h
kube-system kube-proxy-2fwgf 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h1m
kube-system kube-scheduler-lzx-ocadm-test2 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h
kube-system traefik-ingress-controller-qwkfb 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h1m
local-path-storage local-path-provisioner-5978cff7b7-7h8df 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 5h1m
onecloud onecloud-operator-6d4bddb8c4-tkjkh 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 3h37m
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="创建-cloudpods-集群">创建 Cloudpods 集群&lt;/h3>
&lt;p>当 kubernetes 集群部署完成后，就可以通过 &lt;code>ocadm cluster create&lt;/code> 创建 Cloudpods 集群，该集群由 onecloud namespace 里面 &lt;strong>onecloud-operator&lt;/strong> deployment 自动部署和维护。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 创建集群&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 如果要部署企业版的组件可以在 cluster create 的时候加上 --use-ee 参数&lt;/span>
$ ocadm cluster create --wait
&lt;/code>&lt;/pre>&lt;/div>&lt;p>执行完 &lt;code>ocadm cluster create --wait&lt;/code> 命令后，&lt;strong>onecloud-operator&lt;/strong> 会自动创建各个服务组件对应的 pod，等待一段该命令执行完毕， 就可以通过访问 &amp;lsquo;https://本机IP:443&amp;rsquo; 登入前端界面。&lt;/p>
&lt;h3 id="创建登录用户">创建登录用户&lt;/h3>
&lt;p>当控制节点部署完成后，需要创建一个用于前端登录的用户。云平台的管理员认证信息由 &lt;code>ocadm cluster rcadmin&lt;/code> 命令可以得到 , 这些认证信息在使用 climc 控制云平台资源时会用到。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 获取连接 Cloudpods 集群的环境变量&lt;/span>
$ ocadm cluster rcadmin
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">OS_AUTH_URL&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>https://10.168.222.218:30357/v3
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">OS_USERNAME&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>sysadmin
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">OS_PASSWORD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>3hV3qAhvxck84srk
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">OS_PROJECT_NAME&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>system
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">YUNION_INSECURE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#204a87">true&lt;/span>
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">OS_REGION_NAME&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>region0
&lt;span style="color:#204a87">export&lt;/span> &lt;span style="color:#000">OS_ENDPOINT_TYPE&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>publicURL
&lt;/code>&lt;/pre>&lt;/div>
&lt;div class="alert alert-primary" role="alert">
&lt;h4 class="alert-heading">提示&lt;/h4>
&lt;blockquote>
&lt;p>如果是高可用部署，这些 endpoint 的 public url 会是 vip，如果要在 kubernetes 集群外访问需要到 haproxy 节点上添加对应的 frontend 和 backend，其中frontend的端口对应 endpoint 里面的端口，backend 对应 3 个 controlplane node 的 ip 和对应端口。&lt;/p>
&lt;/blockquote>
&lt;/div>
&lt;p>创建用户&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 初始化连接集群的管理员认证信息&lt;/span>
$ &lt;span style="color:#204a87">source&lt;/span> &amp;lt;&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>ocadm cluster rcadmin&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 设置想要创建的用户名和密码&lt;/span>
$ &lt;span style="color:#000">OC_USERNAME&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>demo
$ &lt;span style="color:#000">OC_PASSWORD&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>demo@123
&lt;span style="color:#8f5902;font-style:italic"># 创建指定的用户&lt;/span>
$ climc user-create --password &lt;span style="color:#000">$OC_PASSWORD&lt;/span> --enabled &lt;span style="color:#000">$OC_USERNAME&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 将用户加入 system 项目并赋予 admin 角色&lt;/span>
$ climc project-add-user system &lt;span style="color:#000">$OC_USERNAME&lt;/span> admin
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="访问前端">访问前端&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 获取本机 IP&lt;/span>
$ ip route get &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $NF;exit}&amp;#39;&lt;/span>
10.168.222.218
&lt;span style="color:#8f5902;font-style:italic"># 测试连通性&lt;/span>
$ curl -k https://10.168.222.218
&lt;/code>&lt;/pre>&lt;/div>&lt;p>用浏览器访问 &amp;lsquo;https://本机IP&amp;rsquo; 会跳转到 web 界面，使用 &lt;a href="../../setup/controlplane/#%E5%88%9B%E5%BB%BA%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7">创建登录用户&lt;/a> 里面指定的用户名和密码登录后，界面如下:&lt;/p>
&lt;p>&lt;img src="../images/web-login.png" alt="登录页">&lt;/p>
&lt;p>&lt;img src="../images/web-dashboard.png" alt="首页">&lt;/p>
&lt;h3 id="删除环境">删除环境&lt;/h3>
&lt;p>如果安装过程中失败，或者想清理环境，可执行以下命令删除 kubernetes 集群。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ocadm reset --force
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="后续">后续&lt;/h2>
&lt;p>如果没有意外，现在应该已经部署好了 Cloudpods on kubernetes 的集群，以下是一些后续的环节说明，可以根据自己的需要来进行额外的操作。&lt;/p>
&lt;h3 id="添加计算节点">添加计算节点&lt;/h3>
&lt;p>当控制节点搭建完成后，可以参考 &lt;a href="../../setup/host/">计算节点&lt;/a> 一节的内容，添加计算节点，组建一套私有云集群。&lt;/p>
&lt;h3 id="控制节点作为计算节点">控制节点作为计算节点&lt;/h3>
&lt;p>默认情况下 &lt;code>ocadm init&lt;/code> 创建的节点是控制节点，不会运行 onecloud 计算节点的服务。如果需要把控制节点也作为计算节点，需要执行以下步骤:&lt;/p>
&lt;ul>
&lt;li>安装计算节点需要的依赖，参考 &lt;a href="../../setup/host/#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96">&amp;ldquo;计算节点/安装依赖&amp;rdquo;&lt;/a>，这里主要是要安装我们的内核和运行虚拟机的 qemu 等软件。&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 安装rpm包&lt;/span>
$ yum install -y &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> epel-release libaio jq libusb lvm2 nc ntp yunion-fetcherfs fuse fuse-devel fuse-libs &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> oniguruma pciutils spice spice-protocol sysstat tcpdump usbredir &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> yunion-qemu-2.12.1 yunion-executor ceph-common &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> kmod-openvswitch &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> openvswitch net-tools
$ systemctl &lt;span style="color:#204a87">enable&lt;/span> --now yunion-executor
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>在控制节点启用该节点作为计算节点，命令如下:&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 用 kubectl get nodes 拿到当前的节点名称&lt;/span>
$ kubectl get nodes
NAME STATUS ROLES AGE
controller01 Ready master 116d
controller02 Ready master 40d
node01 Ready &amp;lt;none&amp;gt; 25d
&lt;span style="color:#8f5902;font-style:italic"># 假设我要把 controller01 和 controller02 作为计算节点&lt;/span>
$ ocadm node enable-host-agent &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --node controller01 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --node controller02
&lt;span style="color:#8f5902;font-style:italic"># 等待并查看运行在 controller01/02 上的计算节点服务&lt;/span>
$ kubectl get pods -n onecloud -o wide &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep host
default-host-7b5cr 2/2 Running &lt;span style="color:#0000cf;font-weight:bold">218&lt;/span> 18h 192.168.222.4 controller01
default-host-ctx5s 2/2 Running &lt;span style="color:#0000cf;font-weight:bold">218&lt;/span> 18h 192.168.222.5 controller02
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="升级组件版本">升级组件版本&lt;/h3>
&lt;p>请参考 &lt;a href="../upgrade/">升级相关&lt;/a> 进行升级。&lt;/p></description></item><item><title>Docs: 多节点安装(已废弃)</title><link>https://www.cloudpods.org/zh/docs/setup/nodes/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/nodes/</guid><description>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;p>多节点安装的内容已经废弃，不提倡使用这种方式，推荐用户先参考 &lt;a href="../../quickstart/allinone">All in One 安装&lt;/a> 或者 &lt;a href="../ha">高可用安装&lt;/a> 把集群搭建好，然后再使用 &lt;a href="../host">添加计算节点&lt;/a> 的方式添加计算节点到集群。&lt;/p>
&lt;p>以下内容只是作为保留作为参考。&lt;/p>
&lt;/div>
&lt;p>多节点安装和 &lt;a href="../../quickstart/allinone">All in One 安装&lt;/a> 一样，都使用 &lt;a href="https://github.com/yunionio/ocboot">https://github.com/yunionio/ocboot&lt;/a> 这个部署工具，根据配置执行 ansible playbook 部署节点。&lt;/p>
&lt;h2 id="环境准备">环境准备&lt;/h2>
&lt;p>关于环境的准备和不同架构 CPU 操作系统的要求，请参考 &lt;a href="../../quickstart/allinone#%E6%9C%BA%E5%99%A8%E9%85%8D%E7%BD%AE%E8%A6%81%E6%B1%82">All in One 安装/机器配置要求&lt;/a>。&lt;/p>
&lt;p>以下为待部署机器的环境，假设已经准备好了 5 台机器，IP 分别是 10.127.10.156-160 ，各个节点做出以下角色规划：&lt;/p>
&lt;ul>
&lt;li>mariadb_node: 这个角色表示该节点上部署并运行 mariadb 数据库服务，该角色不一定要写在配置中，如果环境中有准备好的数据库，也可以不部署
&lt;ul>
&lt;li>节点: 10.127.10.156&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>primary_master_node: 这个角色表示该节点是第一个部署并运行 k8s master 组件的节点，该角色必须存在于配置中，该角色运行 onecloud 控制服务
&lt;ul>
&lt;li>节点: 10.127.10.156&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>master_nodes: 这个角色表示这些节点运行控制服务，该角色可选，主要作用是和 primary_master_node 一起组成 Kubernetes 的 etcd 3 节点高可用
&lt;ul>
&lt;li>节点: 10.127.10.157-158&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>worker_nodes: 这个角色表示这些节点运行私有云计算服务，该角色可选，如果不需要内置的私有云功能，可以不配置
&lt;ul>
&lt;li>节点: 10.127.10.159-160&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">IP&lt;/th>
&lt;th style="text-align:center">登录用户&lt;/th>
&lt;th>角色&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">10.127.10.156&lt;/td>
&lt;td style="text-align:center">root&lt;/td>
&lt;td>mariadb_node &amp;amp; primary_master_node&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">10.127.10.157-158&lt;/td>
&lt;td style="text-align:center">root&lt;/td>
&lt;td>master_nodes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">10.127.10.159-160&lt;/td>
&lt;td style="text-align:center">root&lt;/td>
&lt;td>worker_nodes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="开始安装">开始安装&lt;/h2>
&lt;h3 id="下载-ocboot">下载 ocboot&lt;/h3>
&lt;p>参考 &lt;a href="../../quickstart/allinone/#%E4%B8%8B%E8%BD%BD-ocboot">All in One 安装/下载 ocboot&lt;/a>。&lt;/p>
&lt;h3 id="编写部署配置">编写部署配置&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 编写 config-nodes.yml 文件&lt;/span>
$ cat &lt;span style="color:#4e9a06">&amp;lt;&amp;lt;EOF &amp;gt;./config-nodes.yml
&lt;/span>&lt;span style="color:#4e9a06">mariadb_node:
&lt;/span>&lt;span style="color:#4e9a06"> hostname: 10.127.10.156
&lt;/span>&lt;span style="color:#4e9a06"> user: root
&lt;/span>&lt;span style="color:#4e9a06"> db_user: root
&lt;/span>&lt;span style="color:#4e9a06"> db_password: your-sql-password
&lt;/span>&lt;span style="color:#4e9a06">primary_master_node:
&lt;/span>&lt;span style="color:#4e9a06"> onecloud_version: v3.9.9
&lt;/span>&lt;span style="color:#4e9a06"> hostname: 10.127.10.156
&lt;/span>&lt;span style="color:#4e9a06"> user: root
&lt;/span>&lt;span style="color:#4e9a06"> db_host: 10.127.10.156
&lt;/span>&lt;span style="color:#4e9a06"> db_user: root
&lt;/span>&lt;span style="color:#4e9a06"> db_password: your-sql-password
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_host: 10.127.10.156
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_port: &amp;#34;6443&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06">master_nodes:
&lt;/span>&lt;span style="color:#4e9a06"> hosts:
&lt;/span>&lt;span style="color:#4e9a06"> - hostname: 10.127.10.157
&lt;/span>&lt;span style="color:#4e9a06"> user: root
&lt;/span>&lt;span style="color:#4e9a06"> - hostname: 10.127.10.158
&lt;/span>&lt;span style="color:#4e9a06"> user: root
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_host: 10.127.10.156
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_port: &amp;#34;6443&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06">worker_nodes:
&lt;/span>&lt;span style="color:#4e9a06"> hosts:
&lt;/span>&lt;span style="color:#4e9a06"> - hostname: 10.127.10.159
&lt;/span>&lt;span style="color:#4e9a06"> user: root
&lt;/span>&lt;span style="color:#4e9a06"> - hostname: 10.127.10.160
&lt;/span>&lt;span style="color:#4e9a06"> user: root
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_host: 10.127.10.156
&lt;/span>&lt;span style="color:#4e9a06"> controlplane_port: &amp;#34;6443&amp;#34;
&lt;/span>&lt;span style="color:#4e9a06">EOF&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="开始部署">开始部署&lt;/h3>
&lt;p>当填写完 config-nodes.yml 部署配置文件后，便可以执行 ocboot 里面的 &lt;code>./run.py ./config-nodes.yml&lt;/code> 部署集群了。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 开始部署&lt;/span>
$ ./run.py ./config-nodes.yml
&lt;/code>&lt;/pre>&lt;/div>&lt;p>等待部署完成后，就可以使用浏览器访问 https://10.168.26.216 (primary_master_node 的 IP), 输入用户名 &lt;code>admin&lt;/code> 和密码 &lt;code>admin@123&lt;/code>，进入前端。&lt;/p>
&lt;p>然后就可以&lt;a href="../../quickstart/allinone/#%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%80%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA">创建私有云虚拟机&lt;/a>或者&lt;a href="../../quickstart/allinone/#%E5%AF%BC%E5%85%A5%E5%85%AC%E6%9C%89%E4%BA%91%E6%88%96%E8%80%85%E5%85%B6%E5%AE%83%E7%A7%81%E6%9C%89%E4%BA%91%E5%B9%B3%E5%8F%B0%E8%B5%84%E6%BA%90">纳管公有云资源&lt;/a>。&lt;/p></description></item><item><title>Docs: 添加计算节点</title><link>https://www.cloudpods.org/zh/docs/setup/host/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/host/</guid><description>
&lt;p>如果需要构建内部私有云，就需要部署计算节点(宿主机)。计算节点主要负责虚拟机、网络和存储的管理，需要安装的组件如下:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:center">组件&lt;/th>
&lt;th style="text-align:center">用途&lt;/th>
&lt;th style="text-align:center">安装方式&lt;/th>
&lt;th style="text-align:center">运行方式&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:center">host&lt;/td>
&lt;td style="text-align:center">管理 kvm 虚拟机和存储&lt;/td>
&lt;td style="text-align:center">-&lt;/td>
&lt;td style="text-align:center">docker&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">host-deployer&lt;/td>
&lt;td style="text-align:center">虚拟机部署服务&lt;/td>
&lt;td style="text-align:center">-&lt;/td>
&lt;td style="text-align:center">docker&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">sdnagent&lt;/td>
&lt;td style="text-align:center">管理虚拟机网络和安全组&lt;/td>
&lt;td style="text-align:center">-&lt;/td>
&lt;td style="text-align:center">docker&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">openvswitch&lt;/td>
&lt;td style="text-align:center">虚拟机网络端口和流表配置&lt;/td>
&lt;td style="text-align:center">rpm&lt;/td>
&lt;td style="text-align:center">systemd&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">qemu&lt;/td>
&lt;td style="text-align:center">运行虚拟机&lt;/td>
&lt;td style="text-align:center">rpm&lt;/td>
&lt;td style="text-align:center">process&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:center">kernel&lt;/td>
&lt;td style="text-align:center">Cloudpods 提供的内核&lt;/td>
&lt;td style="text-align:center">rpm&lt;/td>
&lt;td style="text-align:center">-&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="环境">环境&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>操作系统: CentOS 7.x&lt;/p>
&lt;/li>
&lt;li>
&lt;p>硬件要求:&lt;/p>
&lt;ul>
&lt;li>Virtualization: CPU 要支持虚拟化，用于虚拟机 KVM 加速&lt;/li>
&lt;li>打开 iommu，VT-d: 用于 GPU 透传(不用GPU可以不开)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>网络:&lt;/p>
&lt;ul>
&lt;li>当前可用的网段: 虚拟机可以直接使用和计算节点所在的扁平网段，需要预先划分保留对应端给云平台虚拟机使用，防止被其它设备占用，最后 IP 冲突&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>虚拟机和服务使用的存储路径都在 &lt;strong>/opt&lt;/strong> 目录下，所以理想环境下建议单独给 &lt;strong>/opt&lt;/strong> 目录设置挂载点&lt;/p>
&lt;ul>
&lt;li>比如把 /dev/sdb1 单独分区做 ext4 然后通过 /etc/fstab 挂载到 /opt 目录&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>备注:&lt;/p>
&lt;ul>
&lt;li>如果是以测试为目的，可以拿一台虚拟机部署计算节点的服务，但可能无法使用 KVM 加速和 GPU 透传&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="使用-ocboot-添加对应节点">使用 ocboot 添加对应节点&lt;/h2>
&lt;p>以下操作在控制节点进行，在控制节点使用 &lt;code>ocboot add-node&lt;/code> 命令把对应计算节点添加进来。&lt;/p>
&lt;p>假设要给控制节点 10.168.26.216 添加计算节点 10.168.222.140 首先需要 ssh root 免密码登录对应的计算节点以及控制节点自身。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 将控制节点自己设置成免密登录&lt;/span>
$ ssh-copy-id -i ~/.ssh/id_rsa.pub root@10.168.26.216
&lt;span style="color:#8f5902;font-style:italic"># 尝试免密登录控制节点是否成功&lt;/span>
$ ssh root@10.168.26.216 &lt;span style="color:#4e9a06">&amp;#34;hostname&amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 将生成的 ~/.ssh/id_rsa.pub 公钥拷贝到待部署的计算机器&lt;/span>
$ ssh-copy-id -i ~/.ssh/id_rsa.pub root@10.168.222.140
&lt;span style="color:#8f5902;font-style:italic"># 尝试免密登录待部署机器，应该不需要输入登录密码即可拿到部署机器的 hostname&lt;/span>
$ ssh root@10.168.222.140 &lt;span style="color:#4e9a06">&amp;#34;hostname&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="拉取-ocboot-代码">拉取 ocboot 代码&lt;/h3>
&lt;p>如果本地已经有 ocboot 工具可以跳过此步，只用把代码更新到对应的分支。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 本地安装 ansible&lt;/span>
$ yum install -y python3-pip
$ python3 -m pip install --upgrade pip setuptools wheel
$ python3 -m pip install --upgrade ansible paramiko
&lt;span style="color:#8f5902;font-style:italic"># 下载 ocboot 工具到本地&lt;/span>
$ git clone -b release/3.9 https://github.com/yunionio/ocboot &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#204a87">cd&lt;/span> ./ocboot
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="更新-ocboot-代码">更新 ocboot 代码&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ git fetch
$ git checkout v3.9.9
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="添加节点">添加节点&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 使用 ocboot 添加节点&lt;/span>
$ ./ocboot.py add-node 10.168.26.216 10.168.222.140
&lt;span style="color:#8f5902;font-style:italic"># 默认情况是不允许虚拟机作为计算节点的，如果需要目标虚拟机作为计算节点，需要设置 --enable-host-on-vm 参数&lt;/span>
$ ./ocboot.py add-node --enable-host-on-vm 10.168.26.216 10.168.222.140
&lt;span style="color:#8f5902;font-style:italic"># 其他选项，使用 &amp;#39;--help&amp;#39; 参考帮助&lt;/span>
$ ./ocboot.py add-node --help
usage: ocboot.py add-node &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>-h&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--user SSH_USER&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--key-file SSH_PRIVATE_FILE&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--port SSH_PORT&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--node-port SSH_NODE_PORT&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>--enable-host-on-vm&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
FIRST_MASTER_HOST TARGET_NODE_HOSTS &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>TARGET_NODE_HOSTS ...&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
positional arguments:
FIRST_MASTER_HOST onecloud cluster primary master host, e.g., 10.1.2.56
TARGET_NODE_HOSTS target nodes ip added into cluster
optional arguments:
-h, --help show this &lt;span style="color:#204a87">help&lt;/span> message and &lt;span style="color:#204a87">exit&lt;/span>
--user SSH_USER, -u SSH_USER
primary master host ssh user &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>default: root&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
--key-file SSH_PRIVATE_FILE, -k SSH_PRIVATE_FILE
primary master ssh private key file &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>default: /home/lzx/.ssh/id_rsa&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
--port SSH_PORT, -p SSH_PORT
primary master host ssh port &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>default: 22&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
--node-port SSH_NODE_PORT, -n SSH_NODE_PORT
worker node host ssh port &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>default: 22&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
--enable-host-on-vm
&lt;/code>&lt;/pre>&lt;/div>&lt;p>该命令会使用 ansible-playbook 把对应的计算节点加入进来。&lt;/p>
&lt;h3 id="启用计算节点宿主机">启用计算节点(宿主机)&lt;/h3>
&lt;p>等计算节点添加完成后，需要启用刚才上报的计算节点，只有启用的宿主机才能运行虚拟机。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 使用 climc 查看注册的 host 列表&lt;/span>
$ climc host-list
+--------------------------------------+-------------------------+-------------------+----------------+----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+-------------------------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Access_mac &lt;span style="color:#000;font-weight:bold">|&lt;/span> Access_ip &lt;span style="color:#000;font-weight:bold">|&lt;/span> Manager_URI &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> enabled &lt;span style="color:#000;font-weight:bold">|&lt;/span> host_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> mem_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> cpu_count &lt;span style="color:#000;font-weight:bold">|&lt;/span> node_count &lt;span style="color:#000;font-weight:bold">|&lt;/span> sn &lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> host_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> version &lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_size &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-------------------------+-------------------+----------------+----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+-------------------------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 3830870e-a499-459d-89df-bb6979b5e1ff &lt;span style="color:#000;font-weight:bold">|&lt;/span> lzx-allinone-standalone &lt;span style="color:#000;font-weight:bold">|&lt;/span> 00:22:39:4c:6c:e9 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10.168.222.140 &lt;span style="color:#000;font-weight:bold">|&lt;/span> http://10.168.222.140:8885 &lt;span style="color:#000;font-weight:bold">|&lt;/span> running &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">8192&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> Not Specified &lt;span style="color:#000;font-weight:bold">|&lt;/span> rotate &lt;span style="color:#000;font-weight:bold">|&lt;/span> hypervisor &lt;span style="color:#000;font-weight:bold">|&lt;/span> master&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>7ab047419092301&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">50141&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-------------------------+-------------------+----------------+----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+-------------------------+--------------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;span style="color:#8f5902;font-style:italic"># 启动 host&lt;/span>
$ climc host-enable lzx-allinone-standalone
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="创建虚拟机测试">创建虚拟机测试&lt;/h2>
&lt;h3 id="上传-cirrors-测试镜像">上传 cirrors 测试镜像&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 下载 cirros 测试镜像&lt;/span>
$ wget https://iso.yunion.cn/yumrepo-2.10/images/cirros-0.4.0-x86_64-disk.qcow2
&lt;span style="color:#8f5902;font-style:italic"># 将镜像上传到 glance&lt;/span>
$ climc image-upload --format qcow2 --os-type Linux --min-disk &lt;span style="color:#0000cf;font-weight:bold">10240&lt;/span> cirros-0.4.0-x86_64-disk.qcow2 ./cirros-0.4.0-x86_64-disk.qcow2
&lt;span style="color:#8f5902;font-style:italic"># 查看上传的镜像&lt;/span>
$ climc image-list
+--------------------------------------+--------------------------------+-------------+----------+-----------+----------+---------+--------+----------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk_format &lt;span style="color:#000;font-weight:bold">|&lt;/span> Size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Is_public &lt;span style="color:#000;font-weight:bold">|&lt;/span> Min_disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Min_ram &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Checksum &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+--------------------------------+-------------+----------+-----------+----------+---------+--------+----------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 63f6f2af-4db2-4e30-85f5-0ad3baa27bd9 &lt;span style="color:#000;font-weight:bold">|&lt;/span> cirros-0.4.0-x86_64-disk.qcow2 &lt;span style="color:#000;font-weight:bold">|&lt;/span> qcow2 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">22806528&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">30720&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> active &lt;span style="color:#000;font-weight:bold">|&lt;/span> 76dc07d1a730a92d0db7fb2d3c305ecd &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+--------------------------------+-------------+----------+-----------+----------+---------+--------+----------------------------------+
&lt;span style="color:#8f5902;font-style:italic"># 如果使用虚拟机作为计算节点，存储可能不大，可以把镜像的默认大小30g调整到10g&lt;/span>
$ climc image-update --min-disk &lt;span style="color:#0000cf;font-weight:bold">10240&lt;/span> cirros-0.4.0-x86_64-disk.qcow2
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="创建测试网络">创建测试网络&lt;/h3>
&lt;p>下面是随机创建了一个主机间不可达的网络用于测试，如果有划分好的扁平二层可用网络，可以直接拿来给虚拟机使用。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc network-create --gateway 10.20.30.1 --server-type guest bcast0 vnet0 10.20.30.2 10.20.30.254 &lt;span style="color:#0000cf;font-weight:bold">24&lt;/span>
$ climc network-public vnet0
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="创建虚拟机">创建虚拟机&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 创建虚拟机 testvm01，512M内存, 1个CPU, 系统盘 10g, 第二块磁盘 5g 格式化为 ext4 并挂载到 /opt 的虚拟机&lt;/span>
$ climc server-create --auto-start --allow-delete &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --disk cirros-0.4.0-x86_64-disk.qcow2:10g --disk 5g:ext4:/opt &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --net vnet0 --ncpu &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> --mem-spec 512M testvm01
&lt;span style="color:#8f5902;font-style:italic"># 查看创建的虚拟机，1分钟后应该会变为 running 状态&lt;/span>
$ climc server-list --details
+--------------------------------------+----------+--------------+--------------+-------+---------+------------+-----------+----------+-----------------------------+------------+---------+-------------------------+--------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Billing_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> IPs &lt;span style="color:#000;font-weight:bold">|&lt;/span> Disk &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> vcpu_count &lt;span style="color:#000;font-weight:bold">|&lt;/span> vmem_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> Secgroup &lt;span style="color:#000;font-weight:bold">|&lt;/span> Created_at &lt;span style="color:#000;font-weight:bold">|&lt;/span> Hypervisor &lt;span style="color:#000;font-weight:bold">|&lt;/span> os_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> Host &lt;span style="color:#000;font-weight:bold">|&lt;/span> Tenant &lt;span style="color:#000;font-weight:bold">|&lt;/span> is_system &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+--------------+--------------+-------+---------+------------+-----------+----------+-----------------------------+------------+---------+-------------------------+--------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> bcda7d18-decc-4b5f-8654-2d201a84d1fb &lt;span style="color:#000;font-weight:bold">|&lt;/span> testvm01 &lt;span style="color:#000;font-weight:bold">|&lt;/span> postpaid &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10.20.30.254 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">35840&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> running &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">512&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> Default &lt;span style="color:#000;font-weight:bold">|&lt;/span> 2019-09-23T05:08:49.000000Z &lt;span style="color:#000;font-weight:bold">|&lt;/span> kvm &lt;span style="color:#000;font-weight:bold">|&lt;/span> Linux &lt;span style="color:#000;font-weight:bold">|&lt;/span> lzx-allinone-standalone &lt;span style="color:#000;font-weight:bold">|&lt;/span> system &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------+--------------+--------------+-------+---------+------------+-----------+----------+-----------------------------+------------+---------+-------------------------+--------+-----------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;span style="color:#8f5902;font-style:italic"># 获取虚拟机登录信息&lt;/span>
$ climc server-logininfo testvm01
+-----------+------------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> Field &lt;span style="color:#000;font-weight:bold">|&lt;/span> Value &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-----------+------------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> login_key &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#000">49wqh5OWGW3jSr1A8RfrMoH69iRRECzaMZITBA&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">==&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> password &lt;span style="color:#000;font-weight:bold">|&lt;/span> zS27FwwUFr96 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> updated &lt;span style="color:#000;font-weight:bold">|&lt;/span> 2019-09-23T05:11:29.306403Z &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> username &lt;span style="color:#000;font-weight:bold">|&lt;/span> root &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+-----------+------------------------------------------+
&lt;span style="color:#8f5902;font-style:italic"># 在计算节点联通测试网络(如果你是直接用的二层网络，应该能直接 ping 通虚拟机的 ip 了，不需要做这一步)&lt;/span>
$ ip address add 10.20.30.1/24 dev br0
&lt;span style="color:#8f5902;font-style:italic"># 用之前 server-logininfo 命令获取的用户名密码，直接登录到虚拟机里面&lt;/span>
$ ssh root@10.20.30.254
PING 10.20.30.254 &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>10.20.30.254&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> 56&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>84&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> bytes of data.
&lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> bytes from 10.20.30.254: &lt;span style="color:#000">icmp_seq&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000">ttl&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">64&lt;/span> &lt;span style="color:#000">time&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>1.31 ms
&lt;span style="color:#8f5902;font-style:italic"># 如果网络不通，也可以通过 vnc 的方式打开虚拟机的 tty 登录界面，操作如下&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 打开 vnc 链接，用浏览器打开下面的链接&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 打开 vnc 链接时会出现不安全认证，导致 websocket 无法握手，需要在浏览器信任 webconsole server 对应的 endpoint&lt;/span>
$ climc endpoint-list --details &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep webconsole &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep public
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 3da1e476aa7b4ff68e206754aed72d8f &lt;span style="color:#000;font-weight:bold">|&lt;/span> region0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 16120e8f3eec46dc86c59b3e426b0502 &lt;span style="color:#000;font-weight:bold">|&lt;/span> webconsole &lt;span style="color:#000;font-weight:bold">|&lt;/span> webconsole &lt;span style="color:#000;font-weight:bold">|&lt;/span> https://10.168.222.218:8899 &lt;span style="color:#000;font-weight:bold">|&lt;/span> public &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">true&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 然后用浏览器访问下 https://10.168.222.218:8899 , 信任该链接即可&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 在通过 webconsole-server 命令获取 vnc web 界面的链接地址，然后用浏览器打开该地址&lt;/span>
$ climc webconsole-server testvm01
https://console.yunion.cn/web-console?access_token&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>FI-VXQSAonhzfSnxVTKCCbwHinp7swlRkmi-4p6s-4OfZpg6TG9YhWuwbHEUA1D7XoKu_w%3D%3D&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">api_server&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>https%3A%2F%2F10.168.222.216%3A8899&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">password&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>65xB2kaE&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">protocol&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>vnc
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 下线计算节点</title><link>https://www.cloudpods.org/zh/docs/setup/removehost/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/removehost/</guid><description>
&lt;p>如果需要将一个计算节点（宿主机）从私有云下线，需要执行以下步骤确保一个计算节点干净下线。&lt;/p>
&lt;ol>
&lt;li>
&lt;p>将该宿主机上的虚拟机全部迁移走。确保该宿主机上没有虚拟机，该宿主机上的本地存储没有磁盘&lt;/p>
&lt;/li>
&lt;li>
&lt;p>删除宿主机记录，可以在Web前端操作，或者在控制节点执行 climc 命令&lt;/p>
&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">climc host-delete &amp;lt;host_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意：如果删除宿主机记录失败，可能的原因是宿主机上还有未清理的虚拟机，或者宿主机的本地存储有未清理的磁盘。发生这个情况时，可以通过 climc 容器的 clean_host.sh 脚本自动清理该宿主机上残留的虚拟机和本地磁盘，并且删除宿主机的数据库记录&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubectl &lt;span style="color:#204a87">exec&lt;/span> -ti -n onecloud &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>kubectl get pods -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep climc &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> sh &lt;span style="color:#8f5902;font-style:italic"># 进入climc容器执行如下命令&lt;/span>
&lt;span style="color:#204a87">cd&lt;/span> /opt/yunion/scripts/tools/
clean_host.sh &amp;lt;host_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>删除该节点在ovn中的chassis记录&lt;/li>
&lt;/ol>
&lt;p>首先，停止该宿主机上的openvswitch服务，清理 /etc/openvswitch 目录：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">systemctl stop openvswitch
rm -fr /etc/openvswitch/*
&lt;/code>&lt;/pre>&lt;/div>&lt;p>其次，在控制节点执行：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl -n onecloude &lt;span style="color:#204a87">exec&lt;/span> -it default-ovn-north-xxxxx /bin/sh &lt;span style="color:#8f5902;font-style:italic"># 进入ovn-northd容器执行以下命令&lt;/span>
/ &lt;span style="color:#8f5902;font-style:italic"># ovn-sbctl show # 找到该宿主机对应的chassis id，通过hostname和ip确认&lt;/span>
...
Chassis &lt;span style="color:#4e9a06">&amp;#34;e6268b2e-4311-4f6d-a6e2-ddd09f49beef&amp;#34;&lt;/span>
hostname: taishan
Encap geneve
ip: &lt;span style="color:#4e9a06">&amp;#34;192.168.222.60&amp;#34;&lt;/span>
options: &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#000">csum&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;true&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
...
/ &lt;span style="color:#8f5902;font-style:italic"># ovn-sbctl chassis-del &amp;lt;chassis_id&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>在该宿主机上清理kubelet环境，在该宿主机上执行：&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubeadm reset -f
&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="5">
&lt;li>删除该宿主机对应的k8s节点信息，在控制节点执行：&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">kubectl get nodes &lt;span style="color:#8f5902;font-style:italic"># 查找该节点的k8s node名称&lt;/span>
kubectl delete node &amp;lt;node_name&amp;gt;
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 物理机管理服务</title><link>https://www.cloudpods.org/zh/docs/setup/baremetal/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/baremetal/</guid><description>
&lt;p>当平台部署成功后，需要选择部署环境中的一个 node 来部署 baremetal-agent 服务。&lt;/p>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
目前只能指定一个 node 来部署运行 baremetal-agent 服务，因为 baremetal-agent 服务是有状态的，不能多副本跨节点运行。
&lt;/div>
&lt;h2 id="启用-baremetal-agent">启用 baremetal-agent&lt;/h2>
&lt;p>在通过 pxe 引导流程中，baremetal-agent 只会处理来自 dhcp relay 服务器的请求, 所以你需要事先在交换机配置 dhcp relay 或者使用 Cloudpods host 服务的 dhcp relay 功能。&lt;/p>
&lt;h3 id="如何配置-host-服务-启用-dhcp-relay">如何配置 host 服务 启用 dhcp relay&lt;/h3>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
如果在交换机上配置了 dhcp relay，则不需要在这里配置计算节点的 dhcp_relay 了，可以跳过这一步。
&lt;/div>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 登录到已经部署好计算节点的服务器上修改 /etc/yunion/host.conf，添加 dhcp_relay 配置项：&lt;/span>
dhcp_relay:
- 10.168.222.150 &lt;span style="color:#8f5902;font-style:italic"># baremetal agent dhcp服务监听地址&lt;/span>
- &lt;span style="color:#0000cf;font-weight:bold">67&lt;/span> &lt;span style="color:#8f5902;font-style:italic"># baremetal agent dhcp服务监听端口&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 然后登陆到控制节点，根据上面计算节点的ip，找到对应的pod，并重启host服务&lt;/span>
$ kubectl get pods -n onecloud -o wide &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep 10.168.222.150 &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -vE &lt;span style="color:#4e9a06">&amp;#39;image|deployer&amp;#39;&lt;/span>
default-host-xdc7x 2/2 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 78m 10.168.222.150 k8s-dev2 &amp;lt;none&amp;gt; &amp;lt;none&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 找到对应的 pod 删除等待 host 服务自动重启&lt;/span>
$ kubectl delete pods -n onecloud default-host-xdc7x
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="启用-baremetal-agent-1">启用 baremetal-agent&lt;/h3>
&lt;p>登陆控制节点，然后选择 node 启用 baremetal-agent。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ocadm baremetal &lt;span style="color:#204a87">enable&lt;/span> --node &lt;span style="color:#000">$node_name&lt;/span> --listen-interface &lt;span style="color:#000">$listen_interface&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># $listen_interface 指的是 baremetal-agent 监听的网卡名称，即计算节点ip所在的网卡名称&lt;/span>
$ ip a show &lt;span style="color:#000;font-weight:bold">|&lt;/span>grep 10.168.222.150
inet 10.168.222.150/24 brd 10.168.222.255 scope global br0
&lt;span style="color:#8f5902;font-style:italic"># $node_name 指的是计算节点添加到k8s集群的节点名称，登陆控制节点，通过计算节点的ip找到对应节点名称&lt;/span>
$ kubectl get nodes -o wide &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep 10.168.222.150 &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>
k8s-dev2
$ ocadm baremetal &lt;span style="color:#204a87">enable&lt;/span> --node k8s-dev2 --listen-interface br0
&lt;span style="color:#8f5902;font-style:italic"># 观察 baremetal agent pod 状态查看是否启动成功&lt;/span>
$ watch &lt;span style="color:#4e9a06">&amp;#34;kubectl get pods -n onecloud | grep baremetal&amp;#34;&lt;/span>
default-baremetal-agent-7c84996c9b-hhllw 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 3m10s
&lt;span style="color:#8f5902;font-style:italic"># 启动成功确认 baremetal-agent 注册到控制节点&lt;/span>
$ climc agent-list
+--------------------------------------+--------------------------+----------------+-----------------------------+---------+------------+------------------------------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Access_ip &lt;span style="color:#000;font-weight:bold">|&lt;/span> Manager_URI &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> agent_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> version &lt;span style="color:#000;font-weight:bold">|&lt;/span> zone_id &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+--------------------------+----------------+-----------------------------+---------+------------+------------------------------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> f3c2c671-c41d-4f30-8d04-e022b49bb9b5 &lt;span style="color:#000;font-weight:bold">|&lt;/span> baremetal-10.168.222.150 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10.168.222.150 &lt;span style="color:#000;font-weight:bold">|&lt;/span> https://10.168.222.150:8879 &lt;span style="color:#000;font-weight:bold">|&lt;/span> enabled &lt;span style="color:#000;font-weight:bold">|&lt;/span> baremetal &lt;span style="color:#000;font-weight:bold">|&lt;/span> remotes/origin/master&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>5e415506120011509&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> 6230b485-2e54-480e-8284-33360b8202a8 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+--------------------------+----------------+-----------------------------+---------+------------+------------------------------------------+--------------------------------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;p>部署完成后可以参考 &lt;a href="../../function_principle/onpremise/baremetal">&amp;ldquo;私有云/物理机&amp;rdquo;&lt;/a> 来进行对物理机的注册管理。&lt;/p>
&lt;h2 id="禁用-baremetal-agent">禁用 baremetal-agent&lt;/h2>
&lt;p>可以在启用 baremetal-agent 的节点中选择节点禁止 baremetal-agent 调度到该节点。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">ocadm baremetal disable --node &lt;span style="color:#000">$node_name&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 切换到企业版/开源版</title><link>https://www.cloudpods.org/zh/docs/setup/ce-ee-switch/</link><pubDate>Wed, 12 Feb 2020 12:55:46 +0800</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/ce-ee-switch/</guid><description>
&lt;p>默认情况下部署好的版本是 &lt;strong>开源版本(CE: Community Edition)&lt;/strong>，可以到ocboot所在路径（通常建议安装路径为&lt;code>/opt/ocboot&lt;/code>），执行 &lt;code>python3 ocboot.py ee &amp;lt;IP&amp;gt;&lt;/code> 命令切换成 &lt;strong>企业版本(EE: Enterprise Edition)&lt;/strong>。其中，&lt;code>&amp;lt;IP&amp;gt;&lt;/code>为管理节点的IPv4地址。&lt;/p>
&lt;h2 id="切换操作">切换操作&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 切换到企业版&lt;/span>
$ python3 ocboot.py ee &amp;lt;IP&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 切换到开源版的 web 前端&lt;/span>
$ python3 ocboot.py ce &amp;lt;IP&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;p>上述切换命令会更新替换当前的 &lt;code>default-web deployment&lt;/code>，并删除对应的&lt;code>configmap&lt;/code>，重启&lt;code>web&lt;/code>服务。&lt;/p>
&lt;p>如果web服务不正常，您也可以自行手工执行下面的操作，来确保web服务的彻底更新，或直接联系管理员：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 删除 default-web 的 configmap 文件&lt;/span>
$ kubectl delete configmap -n onecloud default-web
&lt;span style="color:#8f5902;font-style:italic"># 重启 default-web 服务&lt;/span>
$ kubectl rollout restart deployment -n onecloud default-web
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 升级服务</title><link>https://www.cloudpods.org/zh/docs/setup/upgrade/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/upgrade/</guid><description>
&lt;p>本文介绍从 v3.8.x 升级到 v3.9.x 的步骤以及注意事项。&lt;/p>
&lt;p>版本升级建议从相邻的版本升级，比如从 v3.2.x 升级到 v3.8.x 需要以下的步骤：&lt;/p>
&lt;ol>
&lt;li>v3.2.x =&amp;gt; v3.3.x&lt;/li>
&lt;li>v3.3.x =&amp;gt; v3.4.x&lt;/li>
&lt;li>v3.4.x =&amp;gt; v3.6.x&lt;/li>
&lt;li>v3.6.x =&amp;gt; v3.7.x&lt;/li>
&lt;li>v3.7.x =&amp;gt; v3.8.x&lt;/li>
&lt;/ol>
&lt;p>直接跨多个版本升级可能会出现问题，建议参考以下的内容选择升级步骤:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.cloudpods.org/v3.2/docs/setup/upgrade">v3.1.x 升级到 v3.2.x&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.cloudpods.org/v3.3/docs/setup/upgrade">v3.2.x 升级到 v3.3.x&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.cloudpods.org/v3.4/docs/setup/upgrade">v3.3.x 升级到 v3.4.x&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.cloudpods.org/v3.6/zh/docs/setup/upgrade">v3.4.x 升级到 v3.6.x&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.cloudpods.org/v3.7/zh/docs/setup/upgrade">v3.6.x 升级到 v3.7.x&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.cloudpods.org/v3.8/zh/docs/setup/upgrade">v3.7.x 升级到 v3.8.x&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>总体来说，升级的步骤如下:&lt;/p>
&lt;p>使用我们编写的 &lt;a href="https://github.com/yunionio/ocboot">ocboot&lt;/a> 工具进行升级，这个工具主要是调用 ansible 来升级集群里面的所有节点。&lt;/p>
&lt;ol>
&lt;li>使用 git 拉取最新的 &lt;a href="https://github.com/yunionio/ocboot">ocboot&lt;/a> 代码，切换到 v3.9.9 tag&lt;/li>
&lt;li>使用 &lt;a href="https://github.com/yunionio/ocboot">ocboot&lt;/a> 里面的 &lt;code>./ocboot.py upgrade&lt;/code> 命令进行版本升级&lt;/li>
&lt;/ol>
&lt;h2 id="查看当前版本">查看当前版本&lt;/h2>
&lt;p>可以使用 kubectl 查看当前集群的版本&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 使用 kubectl 获得当前集群的版本为 v3.8.17&lt;/span>
$ kubectl -n onecloud get onecloudclusters default -o&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#000">jsonpath&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;{.spec.version}&amp;#39;&lt;/span>
v3.8.17
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="拉取-ocboot-工具">拉取 ocboot 工具&lt;/h2>
&lt;p>如果本地已经有 ocboot 工具可以跳过此步，只用把代码更新到对应的分支。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 本地安装 ansible&lt;/span>
$ yum install -y python3-pip
$ python3 -m pip install --upgrade pip setuptools wheel
$ python3 -m pip install --upgrade ansible paramiko
&lt;span style="color:#8f5902;font-style:italic"># 下载 ocboot 工具到本地&lt;/span>
$ git clone -b release/3.9 https://github.com/yunionio/ocboot &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#204a87">cd&lt;/span> ./ocboot
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="更新-ocboot-代码">更新 ocboot 代码&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ git fetch
$ git checkout v3.9.9
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="升级-cloudpods-服务">升级 Cloudpods 服务&lt;/h2>
&lt;p>更新服务的原理是通过本机 ssh 免密码远程登录到集群的第一个控制节点，获取所有节点的信息后，然后通过 ansible 执行 playbook 更新，所以有以下要求：&lt;/p>
&lt;ol>
&lt;li>本机能够 ssh 远程登录 PRIMARY_MASTER_HOST&lt;/li>
&lt;li>PRIMARY_MASTER_HOST 能够 ssh 免密码登录集群中的其它节点&lt;/li>
&lt;/ol>
&lt;p>如果没有设置免密码登录，请使用 &lt;em>ssh-copy-id -i ~/.ssh/id_rsa.pub root@PRIMARY_MASTER_HOST&lt;/em> 命令把公钥下发到自己环境对应的节点。&lt;/p>
&lt;p>升级的版本号可以到 &lt;a href="../../development/changelog/release-3.9/">CHANGELOG release/3.9 页面&lt;/a> 查询。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 使用 ocboot 相关服务升级到 v3.9.9 版本&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 该步骤会因为拉取 docker 镜像等待较长时间，请耐心等待&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># PRIMARY_MASTER_HOST 是指部署集群的第一个节点的 ip 地址&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 需要本机能够使用 ssh 密钥登录上去&lt;/span>
$ ./ocboot.py upgrade &amp;lt;PRIMARY_MASTER_HOST&amp;gt; v3.9.9
&lt;span style="color:#8f5902;font-style:italic"># 另外可以使用 `./ocboot.py upgrade --help` 查看其它可选参数&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 比如:&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># --user 可以指定其它 ssh 用户&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># --port 指定 ssh 端口&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># --key-file 指定另外的 ssh private key&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># --as-bastion 可以让 PRIMARY_MASTER_HOST 作为堡垒机部署在内网的宿主机&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 另外可以在升级的过程中可以登录到 PRIMARY_MASTER_HOST， 使用 kubectl 查看对应 pods 的升级情况&lt;/span>
$ kubectl get pods -n onecloud --watch
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="降级相关">降级相关&lt;/h2>
&lt;p>如果升级后遇到功能不符合预期或者 bug 之类的问题，可以通过下面的命令降级回滚。&lt;/p>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ul>
&lt;li>一般小版本降级没有问题，比如从 v3.9.9 降级到 v3.9.0&lt;/li>
&lt;li>跨版本降级可能会有问题，比如从 v3.9.9 降级到 v3.8.13&lt;/li>
&lt;/ul>
&lt;p>如果遇到问题请到 &lt;a href="https://github.com/yunionio/cloudpods/issues">GitHub 提 issue&lt;/a> 或者 &lt;a href="https://www.cloudpods.org/zh/docs/contact">联系我们&lt;/a> 获取帮助。
&lt;/div>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 降级的原理是修改各个服务的 image version&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 比如现在的版本是 v3.9.9，然后想要降级到 v3.8.17&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 在第一个控制节点执行如下命令降级会 v3.8.17&lt;/span>
$ /opt/yunion/bin/ocadm cluster update --version v3.8.17 --wait
&lt;span style="color:#8f5902;font-style:italic"># 降级会重新拉取新的镜像，可以再开一个窗口&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 使用下面的命令查看每个 pod 的更新情况&lt;/span>
$ kubectl -n onecloud get pods -w
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="回退操作">回退操作&lt;/h2>
&lt;p>ocboot 从 v3.9.7 版本起，每次升级集群服务的时候，会把 operator 的 deployment yaml 和 onecloudcluster 的 yaml 文件备份到 &lt;code>/opt/yunion/ocboot/_upgrade/&lt;/code> 里面，方便以后手动回滚组件。&lt;/p>
&lt;p>当出现升级失败，或者升级后想要回退到升级前的版本，可以使用以下的操作：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 查看 /opt/yunion/ocboot/_upgrade/ 目录里面的升级备份目录&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 里面的子目录以升级前时间作为目录名&lt;/span>
$ ls /opt/yunion/ocboot/_upgrade/
2023.02.20-10:10:07
&lt;span style="color:#8f5902;font-style:italic"># 比如想要回退到 2023.02.20-10:10:07 前的版本，就进行以下操作&lt;/span>
$ &lt;span style="color:#204a87">cd&lt;/span> /opt/yunion/ocboot/_upgrade/2023.02.20-10&lt;span style="color:#4e9a06">\:&lt;/span>10&lt;span style="color:#4e9a06">\:&lt;/span>07/
&lt;span style="color:#8f5902;font-style:italic"># 查看相关 yaml 文件&lt;/span>
$ ls -lh
-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root 61K Feb &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> 10:10 oc.yml &lt;span style="color:#8f5902;font-style:italic"># oc.yaml 为 onecloudcluster 描述文件&lt;/span>
-rw-r--r-- &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> root root 3.9K Feb &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> 10:10 operator.yml &lt;span style="color:#8f5902;font-style:italic"># operator.yaml 为 operator deployment 描述文件&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 先回退 operator&lt;/span>
$ kubectl apply -f operator.yml
deployment.extensions/onecloud-operator configured
&lt;span style="color:#8f5902;font-style:italic"># 等到新创建的 operator 变成 Running，如果是 ContainerCreating 状态就等待一段时间&lt;/span>
$ kubectl get pods -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep operator
onecloud-operator-5557d86d74-7s5sl 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 2s
&lt;span style="color:#8f5902;font-style:italic"># 再回退 onecloudcluster 就可以了&lt;/span>
$ kubectl apply -f oc.yaml
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 升级内核</title><link>https://www.cloudpods.org/zh/docs/setup/update_kernel/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/update_kernel/</guid><description>
&lt;h2 id="宿主机内核从yn20191203升级yn20201125">宿主机内核从yn20191203升级yn20201125&lt;/h2>
&lt;p>1、查看内核版本&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@yunion ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># uname -r&lt;/span>
3.10.0-1062.4.3.el7.yn20191203.x86_64
&lt;/code>&lt;/pre>&lt;/div>&lt;p>2、升级内核&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@yunion ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># yum install -y kernel-3.10.0-1160.6.1.el7.yn20201125 kernel-devel-3.10.0-1160.6.1.el7.yn20201125 kernel-headers-3.10.0-1160.6.1.el7.yn20201125&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@yunion ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># awk -F\&amp;#39; &amp;#39;$1==&amp;#34;menuentry &amp;#34; {print i++ &amp;#34; : &amp;#34; $2}&amp;#39; /etc/grub2.cfg&lt;/span>
&lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> : CentOS Linux &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>3.10.0-1160.6.1.el7.yn20201125.x86_64&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">7&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>Core&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> : CentOS Linux &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>3.10.0-1062.4.3.el7.yn20191203.x86_64&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">7&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>Core&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> : CentOS Linux &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>3.10.0-957.12.1.el7.x86_64&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">7&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>Core&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#0000cf;font-weight:bold">3&lt;/span> : CentOS Linux &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>0-rescue-c022f8e6249f48fc92f7743f5f6290c9&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">7&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>Core&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>3、切换新内核&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@yunion ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># vim /etc/default/grub # 把GRUB_DEFAULT改为新内核的序号，GRUB_DEFAULT=0&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@yunion ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># grub2-mkconfig -o /boot/grub2/grub.cfg&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@yunion ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># reboot&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>4、查看新内核版本&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>root@yunion ~&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&lt;span style="color:#8f5902;font-style:italic"># uname -r&lt;/span>
3.10.0-1160.6.1.el7.yn20201125.x86_64
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 修改OC更新集群状态</title><link>https://www.cloudpods.org/zh/docs/setup/oc-update/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/oc-update/</guid><description>
&lt;p>cloudpods-operator会在Kubernetes集群中注入CRD资源oc，该CRD定义了一个服务集群的状态，可以通过修改oc来更改集群的状态，达到IaC的效果。&lt;/p>
&lt;h2 id="1修改集群整体状态">1、修改集群整体状态&lt;/h2>
&lt;p>主要几个参数：&lt;/p>
&lt;ul>
&lt;li>disableResourceManagement: true|false&lt;/li>
&lt;/ul>
&lt;p>是否关闭cgroup v1的资源限制，该选项默认关闭。对于一些较新操作系统，如CentOS 8等，只能支持cgroup v2 API，如果开启了资源限制，会导致容器无法启动。此时需要关闭cgroup v1资源限制。&lt;/p>
&lt;ul>
&lt;li>disableLocalVpc: true|false&lt;/li>
&lt;/ul>
&lt;p>是否关闭内置私有云的VPC功能，该选项默认关闭。&lt;/p>
&lt;ul>
&lt;li>enableCloudNet: true|false&lt;/li>
&lt;/ul>
&lt;p>是否开启Cloudnet组件，该选项默认关闭&lt;/p>
&lt;ul>
&lt;li>enableS3Gateway: true|false&lt;/li>
&lt;/ul>
&lt;p>是否开启S3网关服务，该选项默认关闭&lt;/p>
&lt;ul>
&lt;li>productVersion: CMP|Edge|FullStack&lt;/li>
&lt;/ul>
&lt;p>集群的部署模式，三个选项：CMP(只部署云管相关功能组件)，Edge（是部署内置私有云相关功能组件），FullStack（部署云管和内置私有云所有功能组件）&lt;/p>
&lt;ul>
&lt;li>imageRepository: &lt;string>&lt;/li>
&lt;/ul>
&lt;p>指定集群的镜像repo地址，默认是 registry.cn-beijing.aliyuncs.com/yunion&lt;/p>
&lt;ul>
&lt;li>loadBalancerEndpoint: &lt;ip>&lt;/li>
&lt;/ul>
&lt;p>访问集群控制服务的虚拟IP地址或者域名&lt;/p>
&lt;ul>
&lt;li>version: &lt;string>&lt;/li>
&lt;/ul>
&lt;p>集群的主版本号，如v3.8.15。当组件的tag未指定时，默认用version作为镜像的tag。可以通过修该属性实现集群镜像版本的整体切换。&lt;/p>
&lt;ul>
&lt;li>region: &lt;string>&lt;/li>
&lt;/ul>
&lt;p>当前区域，默认为 region0&lt;/p>
&lt;ul>
&lt;li>zone: &lt;string>&lt;/li>
&lt;/ul>
&lt;p>当前可用区，默认为 zone0&lt;/p>
&lt;h2 id="2-修改单个组件的属性">2. 修改单个组件的属性&lt;/h2>
&lt;p>每个组件都可以设置如下属性：&lt;/p>
&lt;ul>
&lt;li>disable: true|false&lt;/li>
&lt;/ul>
&lt;p>该组件是否禁用，默认是false。如果设置为true，则operator不会更新对应的k8s资源（deployment或者daemonset)&lt;/p>
&lt;ul>
&lt;li>imageName: &lt;string>&lt;/li>
&lt;/ul>
&lt;p>镜像的名称&lt;/p>
&lt;ul>
&lt;li>imagePullPolicy: &lt;string>&lt;/li>
&lt;/ul>
&lt;p>镜像的拉取策略，默认为 IfNotPresent, 还可以设置为： Always&lt;/p>
&lt;ul>
&lt;li>repository: &lt;string>&lt;/li>
&lt;/ul>
&lt;p>改组件的镜像地址，该属性override全局的 imageRepository 属性&lt;/p>
&lt;ul>
&lt;li>tag: &lt;string>&lt;/li>
&lt;/ul>
&lt;p>镜像的tag，该属性override全局的 version 属性&lt;/p>
&lt;p>支持的组件列表如下：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>组件名称&lt;/th>
&lt;th>功能&lt;/th>
&lt;th>开源版&lt;/th>
&lt;th>商业版&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>ansibleserver&lt;/td>
&lt;td>ansible管理服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>apiGateway&lt;/td>
&lt;td>API网关服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>autoupdate&lt;/td>
&lt;td>更新服务&lt;/td>
&lt;td>&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>baremetalagent&lt;/td>
&lt;td>裸金属代理，负责裸金属服务器的API和操作&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>climc&lt;/td>
&lt;td>提供climc的容器&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloudevent&lt;/td>
&lt;td>cloudevent服务，提供公有云日志收集&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloudid&lt;/td>
&lt;td>负责CloudSSO功能组件&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloudmon&lt;/td>
&lt;td>监控数据采集服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloudnet&lt;/td>
&lt;td>云间网络服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloudproxy&lt;/td>
&lt;td>ssh代理服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>devtool&lt;/td>
&lt;td>应用部署服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>esxiagent&lt;/td>
&lt;td>VMWare代理&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>glance&lt;/td>
&lt;td>镜像服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>hostagent&lt;/td>
&lt;td>宿主机代理&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>hostdeployer&lt;/td>
&lt;td>磁盘数据部署服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>hostimage&lt;/td>
&lt;td>磁盘数据下载服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>influxdb&lt;/td>
&lt;td>开源监控数据库&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>itsm&lt;/td>
&lt;td>工单流程服务&lt;/td>
&lt;td>&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>keystone&lt;/td>
&lt;td>认证服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>kubeserver&lt;/td>
&lt;td>Kubernetes集群管理代理&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>logger&lt;/td>
&lt;td>操作日志服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>meter&lt;/td>
&lt;td>计费计量服务&lt;/td>
&lt;td>&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>monitor&lt;/td>
&lt;td>监控服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>notify&lt;/td>
&lt;td>通知告警服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>onecloudServiceOperator&lt;/td>
&lt;td>编排服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ovnNorth&lt;/td>
&lt;td>OVN控制服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>regionDNS&lt;/td>
&lt;td>DNS服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>regionServer&lt;/td>
&lt;td>云资源管理服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>report&lt;/td>
&lt;td>报表服务&lt;/td>
&lt;td>&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>s3gateway&lt;/td>
&lt;td>S3代理网关服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>scheduledtask&lt;/td>
&lt;td>定时任务服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>scheduler&lt;/td>
&lt;td>调度器&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>suggestion&lt;/td>
&lt;td>费用优化服务&lt;/td>
&lt;td>&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>telegraf&lt;/td>
&lt;td>监控Agent，开源telegraf&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>vpcAgent&lt;/td>
&lt;td>VPC代理&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>web&lt;/td>
&lt;td>前端nginx&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>webconsole&lt;/td>
&lt;td>H5控制台服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>yunionagent&lt;/td>
&lt;td>企业版授权服务&lt;/td>
&lt;td>&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>yunionconf&lt;/td>
&lt;td>配置管理服务&lt;/td>
&lt;td>(x)&lt;/td>
&lt;td>(x)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>Docs: RPM Repo</title><link>https://www.cloudpods.org/zh/docs/setup/repo/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/repo/</guid><description>
&lt;p>本文各个版本RPM REPO的地址&lt;/p>
&lt;h2 id="39">3.9&lt;/h2>
&lt;ul>
&lt;li>CentOS 7 x86_64: &lt;a href="https://iso.yunion.cn/centos/7/3.9/x86_64">https://iso.yunion.cn/centos/7/3.9/x86_64&lt;/a>&lt;/li>
&lt;li>CentOS 7 arm64: &lt;a href="https://iso.yunion.cn/centos/7/3.9/aarch64">https://iso.yunion.cn/centos/7/3.9/aarch64&lt;/a>&lt;/li>
&lt;li>银河麒麟 V10 SP2 x86_64: &lt;a href="https://iso.yunion.cn/kylin/v10/3.9/x86_64">https://iso.yunion.cn/kylin/v10/3.9/x86_64&lt;/a>&lt;/li>
&lt;li>银河麒麟 V10 SP2 arm64: &lt;a href="https://iso.yunion.cn/kylin/v10/3.9/aarch64">https://iso.yunion.cn/kylin/v10/3.9/aarch64&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="38">3.8&lt;/h2>
&lt;ul>
&lt;li>CentOS 7 x86_64: &lt;a href="https://iso.yunion.cn/3.8/">https://iso.yunion.cn/3.8/&lt;/a>&lt;/li>
&lt;li>CentOS 7 arm64: &lt;a href="https://iso.yunion.cn/centos-7-aarch/">https://iso.yunion.cn/centos-7-aarch/&lt;/a>&lt;/li>
&lt;li>Debian 10 (buster) x86_64: &lt;a href="https://iso.yunion.cn/uos/buster/amd64/3.8/">https://iso.yunion.cn/uos/buster/amd64/3.8/&lt;/a>&lt;/li>
&lt;li>Debian 10 (buster) arm64: &lt;a href="https://iso.yunion.cn/uos/buster/arm64/3.8/">https://iso.yunion.cn/uos/buster/arm64/3.8/&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="37">3.7&lt;/h2>
&lt;ul>
&lt;li>CentOS 7 x86_64: &lt;a href="https://iso.yunion.cn/3.7">https://iso.yunion.cn/3.7&lt;/a>&lt;/li>
&lt;li>Debian 10 (buster) x86_64: &lt;a href="https://iso.yunion.cn/uos/buster/amd64/3.7/">https://iso.yunion.cn/uos/buster/amd64/3.7/&lt;/a>&lt;/li>
&lt;li>Debian 10 (buster) arm64: &lt;a href="https://iso.yunion.cn/uos/buster/arm64/3.7/">https://iso.yunion.cn/uos/buster/arm64/3.7/&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Docs: ARM(AArch64) 部署</title><link>https://www.cloudpods.org/zh/docs/setup/host-aarch64/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/host-aarch64/</guid><description>
&lt;h2 id="简介">简介&lt;/h2>
&lt;p>从 v3.6.10 版本开始，可以将”Cloudpods“部署到 ARM(AArch64) 架构的机器上，目前我们适配的 Linux 发行版是 &lt;a href="https://www.debian.org/releases/stable/arm64/">Debian 10(buster)&lt;/a> 和 &lt;a href="https://www.chinauos.com/">统信 UOS&lt;/a> 。&lt;/p>
&lt;p>因为服务是容器化运行在 Kubernetes 之上的，为了在 ARM 架构的机器上运行容器，我们使用了 &lt;a href="https://github.com/docker/buildx/">docker buildx&lt;/a> 和交叉编译的技术编译打包了同时支持 x86_64 和 arm64 的统一容器镜像。这样的可以让 Kubernetes 屏蔽 CPU 架构的差异性，我们制作的支持多架构的容器镜像可以在不同架构的机器上运行服务，实现 X86 和 ARM 机器混合部署的效果。&lt;/p>
&lt;h2 id="部署">部署&lt;/h2>
&lt;p>部署方式和原来的 X86 部署并没有太大差别，唯一的区别是我们 X86 上使用的 Linux 发行版是 CentOS 7 ，但在 ARM 架构的机器上需要安装 &lt;a href="https://www.debian.org/releases/stable/arm64/">Debian 10(buster)&lt;/a> 或者 &lt;a href="https://www.chinauos.com/">统信 UOS&lt;/a> 发行版。其它部署方式是一致的，使用我们编写的 &lt;a href="https://github.com/yunionio/ocboot">https://github.com/yunionio/ocboot&lt;/a> 部署工具来统一部署，这个工具里面包含了在 Debian 和 UOS 上部署的 ansible playbook 。&lt;/p>
&lt;h3 id="前提条件">前提条件&lt;/h3>
&lt;ul>
&lt;li>ARM 机器必须提前安装好 Debian 10 或者 UOS 操作系统&lt;/li>
&lt;li>ARM 机器能够访问公网&lt;/li>
&lt;li>ARM 机器开启 ssh 服务，保证运行 ocboot 的节点能够免密登录待部署的 ARM 机器&lt;/li>
&lt;/ul>
&lt;h3 id="单节点-all-in-one-部署">单节点 All in One 部署&lt;/h3>
&lt;p>单节点 All in One 部署是指把整个”Cloudpods“全部部署到一个节点，ARM 的部署和 X86 的部署没有任何区别，准备好环境后，直接参考 &lt;a href="../../quickstart/allinone">All in One 安装&lt;/a> 的部署流程即可。&lt;/p>
&lt;h3 id="多节点混合部署">多节点混合部署&lt;/h3>
&lt;p>多节点部署请先参考 &lt;a href="../../quickstart/nodes">多节点安装&lt;/a> 了解多节点安装准备工作和配置。接下来以一台 X86 和一台 ARM 机器演示混合部署的流程。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>架构&lt;/th>
&lt;th>操作系统&lt;/th>
&lt;th>IP&lt;/th>
&lt;th>登录用户&lt;/th>
&lt;th>角色&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>X86_64&lt;/td>
&lt;td>CentOS 7&lt;/td>
&lt;td>10.127.40.252&lt;/td>
&lt;td>root&lt;/td>
&lt;td>mariadb_node &amp;amp; primary_master_node&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ARM64&lt;/td>
&lt;td>Debian 10&lt;/td>
&lt;td>10.127.100.8&lt;/td>
&lt;td>root&lt;/td>
&lt;td>worker_nodes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>编写如下部署配置:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 编写配置&lt;/span>
$ vim ./config-hybrid.yml
&lt;span style="color:#8f5902;font-style:italic"># mariadb_node 表示要在 10.127.40.252 这台节点上部署 mariadb 数据库&lt;/span>
mariadb_node:
hostname: 10.127.40.252
user: root
db_user: root
db_password: your-sql-password
&lt;span style="color:#8f5902;font-style:italic"># primary_master_node 表示将 10.127.40.252 作为第一个部署的 master 节点&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 上面会运行Cloudpods必要的控制服务&lt;/span>
primary_master_node:
onecloud_version: v3.7.0
hostname: 10.127.40.252
user: root
db_host: 10.127.40.252
db_user: root
db_password: your-sql-password
controlplane_host: 10.127.40.252
controlplane_port: &lt;span style="color:#4e9a06">&amp;#34;6443&amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># onecloud 登录用户&lt;/span>
onecloud_user: admin
&lt;span style="color:#8f5902;font-style:italic"># onecloud 登录用户密码&lt;/span>
onecloud_user_password: admin@123
&lt;span style="color:#8f5902;font-style:italic"># as_host 表示将这个 master 节点作为私有云计算节点&lt;/span>
as_host: &lt;span style="color:#204a87">true&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># worker_nodes 表示在 10.127.100.8 上部署内置私有云计算服务&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 同时会将 worker_nodes 角色的节点作为私有云计算节点&lt;/span>
worker_nodes:
hosts:
&lt;span style="color:#8f5902;font-style:italic"># 如果有多台节点，可以在这里按照 YAML 数组的格式填写多个节点的 IP&lt;/span>
- hostname: 10.127.100.8
user: root
controlplane_host: 10.127.40.252
controlplane_port: &lt;span style="color:#4e9a06">&amp;#34;6443&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>使用 ocboot 安装 config-hybrid.yml 配置部署:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ./run.py ./config-hybrid.yml
....
&lt;span style="color:#8f5902;font-style:italic"># 部署完成后会有如下输出，表示运行成功&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 浏览器打开 https://10.127.40.252&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 使用 admin/admin@123 用户密码登录就能访问前端界面&lt;/span>
Initialized successfully!
Web page: https://10.127.40.252
User: admin
Password: admin@123
&lt;/code>&lt;/pre>&lt;/div>&lt;p>部署完成后，登入前端就能发现混合部署的两台 X86 和 ARM 的宿主机，截图如下，aarch64 和 x86_64 分别对应 ARM64 和 X86_64 的 CPU 架构宿主机。&lt;/p>
&lt;p>&lt;img src="../images/host-hybrid-list.png" alt="宿主机前端列表">&lt;/p>
&lt;h2 id="创建-arm-虚拟机">创建 ARM 虚拟机&lt;/h2>
&lt;p>基于 ARM 的机器部署完服务后，请先阅读 &lt;a href="../../quickstart/allinone/#faq">All in One/FAQ&lt;/a> 和 &lt;a href="../../quickstart/allinone/#%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%80%E5%8F%B0%E8%99%9A%E6%8B%9F%E6%9C%BA">All in One/创建第一台虚拟机&lt;/a> 了解创建虚拟机需要创建网络、启用宿主机和导入镜像等步骤。&lt;/p>
&lt;h3 id="导入镜像">导入镜像&lt;/h3>
&lt;p>对于 ARM(AArch64) 虚拟机来说需要使用对应的 ARM(AArch64) 虚拟机镜像，这里分别导入 ARM64 和 X86_64 的 CentOS 7 虚拟机镜像进行测试。&lt;/p>
&lt;ul>
&lt;li>ARM64 镜像 CentOS-7-aarch64-GenericCloud-2003.qcow2: &lt;a href="https://cloud.centos.org/centos/7/images/CentOS-7-aarch64-GenericCloud-2003.qcow2">https://cloud.centos.org/centos/7/images/CentOS-7-aarch64-GenericCloud-2003.qcow2&lt;/a>&lt;/li>
&lt;li>X86_64 镜像 CentOS-7-x86_64-GenericCloud-1503.qcow2: &lt;a href="https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-1503.qcow2">https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-1503.qcow2&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>导入镜像后的截图如下:&lt;/p>
&lt;p>&lt;img src="../images/image-hybrid-list.png" alt="镜像列表">&lt;/p>
&lt;h3 id="创建虚拟机">创建虚拟机&lt;/h3>
&lt;p>镜像和对应的网路准备完成后，就可以到虚拟机创建界面根据需要选择不同 CPU 架构创建虚拟机。创建界面截图如下：&lt;/p>
&lt;p>&lt;img src="../images/vm-hybrid-create.png" alt="虚拟机创建页面">&lt;/p>
&lt;p>分别创建 aarch64 和 x86_64 架构的虚拟机后，可以在虚拟机的列表页面看到每台虚拟机的 CPU 架构，截图如下:&lt;/p>
&lt;p>&lt;img src="../images/vm-hybrid-list.png" alt="虚拟机列表页面">&lt;/p></description></item><item><title>Docs: 更换前端证书</title><link>https://www.cloudpods.org/zh/docs/setup/config-ssl-certs/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/config-ssl-certs/</guid><description>
&lt;p>默认部署完成后，访问前端界面，浏览器会提示不安全的 SSL 连接，原因是前端默认使用的是自签发的证书。本文介绍如何使用自定义证书替换掉前端默认的证书。&lt;/p>
&lt;h2 id="操作步骤">操作步骤&lt;/h2>
&lt;p>假设已经准备好的证书文件为：&lt;code>cert.pem&lt;/code> 和 &lt;code>cert.key&lt;/code>，域名为 &lt;code>foo.bar.com&lt;/code> 。&lt;/p>
&lt;h3 id="1-将证书导入-kubernetes-集群">1. 将证书导入 kubernetes 集群&lt;/h3>
&lt;p>kubernetes 使用 secret 这种资源保存证书内容，然后前端服务使用 ingress 引用对应的证书，提供 HTTPS 连接。为了使用自定证书，需要先把证书保存到集群。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 创建证书&lt;/span>
$ kubectl create secret tls yunion-io-web-secret --key cert.key --cert cert.pem -n onecloud
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="2-编辑-ingress-规则">2. 编辑 ingress 规则&lt;/h3>
&lt;p>编辑 &lt;code>default-web&lt;/code> ingress 规则，引用刚才创建的 yunion-io-web-secret 证书。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl edit ingress -n onecloud default-web
...
tls:
&lt;span style="color:#8f5902;font-style:italic"># 修改这个 secretName 为 yunion-io-web-secret&lt;/span>
- secretName: yunion-io-web-secret
...
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="3-重启-ingress-controller">3. 重启 ingress controller&lt;/h3>
&lt;p>设置完 default-web ingress 规则后，可以重启下 ingress controller 服务，让证书生效。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl get pods -n kube-system &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep traefik &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> xargs kubectl delete pods -n kube-system
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="4-修改服务-api_server-入口配置">4. 修改服务 api_server 入口配置&lt;/h3>
&lt;p>因为使用域名 &lt;code>foo.bar.com&lt;/code> 访问，需要修改云平台的默认 api_server 配置，这个配置会影响前端 VNC 连接的地址。将旧的 https://&lt;ip> 访问地址改为 &lt;code>https://foo.bar.com&lt;/code>，操作如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc service-config-edit common
default:
api_server: https://foo.bar.com
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置完成后就可以通过 &lt;code>https://foo.bar.com&lt;/code> 访问前端了。&lt;/p></description></item><item><title>Docs: nginx配置</title><link>https://www.cloudpods.org/zh/docs/setup/behindnginx/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/behindnginx/</guid><description>
&lt;p>部署完成后，如果要通过nginx将Cloudpods的前端暴露到外网访问，nginx的推荐配置如下。注意需要专门为websocket的流量增加转发规则。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-nginx" data-lang="nginx">&lt;span style="color:#8f5902;font-style:italic"># vi: ft=nginx
&lt;/span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">server&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">server_name&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#204a87;font-weight:bold">{&lt;/span> &lt;span style="color:#4e9a06">public_domain_name&lt;/span> &lt;span style="color:#a40000">}}&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">access_log&lt;/span> &lt;span style="color:#4e9a06">/var/log/nginx/&lt;/span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#204a87;font-weight:bold">{&lt;/span> &lt;span style="color:#4e9a06">public_domain_name&lt;/span> &lt;span style="color:#a40000">}}&lt;/span>&lt;span style="color:#4e9a06">.access.log&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">listen&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">443&lt;/span> &lt;span style="color:#4e9a06">http2&lt;/span> &lt;span style="color:#4e9a06">ssl&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">ssl_certificate&lt;/span> &lt;span style="color:#4e9a06">/etc/ssl/yunion.io/cert.pem&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">ssl_certificate_key&lt;/span> &lt;span style="color:#4e9a06">/etc/ssl/yunion.io/key.pem&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">client_max_body_size&lt;/span> &lt;span style="color:#4e9a06">10g&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">location&lt;/span> &lt;span style="color:#000;font-weight:bold">~&lt;/span> &lt;span style="color:#4e9a06">/.well-known&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">allow&lt;/span> &lt;span style="color:#4e9a06">all&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">location&lt;/span> &lt;span style="color:#4e9a06">/&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_pass&lt;/span> &lt;span style="color:#4e9a06">https://&lt;/span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#204a87;font-weight:bold">{&lt;/span> &lt;span style="color:#4e9a06">backend_address&lt;/span> &lt;span style="color:#a40000">}}&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_read_timeout&lt;/span> &lt;span style="color:#4e9a06">3600s&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_redirect&lt;/span> &lt;span style="color:#000">off&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_set_header&lt;/span> &lt;span style="color:#4e9a06">Host&lt;/span> &lt;span style="color:#000">$host&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_set_header&lt;/span> &lt;span style="color:#4e9a06">X-Real-IP&lt;/span> &lt;span style="color:#000">$remote_addr&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_set_header&lt;/span> &lt;span style="color:#4e9a06">X-Forwarded-For&lt;/span> &lt;span style="color:#000">$proxy_add_x_forwarded_for&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">location&lt;/span> &lt;span style="color:#000;font-weight:bold">~&lt;/span> &lt;span style="color:#4e9a06">^/(websockify|wsproxy|connect)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_pass&lt;/span> &lt;span style="color:#4e9a06">https://&lt;/span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#204a87;font-weight:bold">{&lt;/span> &lt;span style="color:#4e9a06">backend_address&lt;/span> &lt;span style="color:#a40000">}}&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_redirect&lt;/span> &lt;span style="color:#000">off&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_set_header&lt;/span> &lt;span style="color:#4e9a06">Host&lt;/span> &lt;span style="color:#000">$host&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_set_header&lt;/span> &lt;span style="color:#4e9a06">X-Real-IP&lt;/span> &lt;span style="color:#000">$remote_addr&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_set_header&lt;/span> &lt;span style="color:#4e9a06">X-Forwarded-For&lt;/span> &lt;span style="color:#000">$proxy_add_x_forwarded_for&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_http_version&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>&lt;span style="color:#4e9a06">.1&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_set_header&lt;/span> &lt;span style="color:#4e9a06">Upgrade&lt;/span> &lt;span style="color:#000">$http_upgrade&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_set_header&lt;/span> &lt;span style="color:#4e9a06">Connection&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;upgrade&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">proxy_read_timeout&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">86400&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 多可用区服务配置</title><link>https://www.cloudpods.org/zh/docs/setup/multi-zone/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/multi-zone/</guid><description>
&lt;p>平台有个可用区(zone)的概念，可以理解为对应实际环境中的机房，刚部署完服务后会有一个默认的可用区 zone0 。&lt;/p>
&lt;p>云平台的物理机管理服务(baremetal-agent), VMware管理服务(esxi-agent)以及虚拟机管理服务(host)是可用区级别的服务，如果实际环境中的服务器，物理机或者管理的 VMware 集群位于不同的机房，需要创建多个可用区，然后在不同的可用区部署这些服务。&lt;/p>
&lt;p>接下来的文档介绍如何在多个可用区部署这些服务。&lt;/p>
&lt;h2 id="创建可用区">创建可用区&lt;/h2>
&lt;p>可用区的添加使用 onecloud-operator 这个服务来控制，直接修改 onecloud namespace 里面的 default onecloudcluster 资源就行，比如下面的命令添加 &lt;code>my-zone-1&lt;/code> 这个可用区：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 修改 default onecloudcluster 的 spec.customZones&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 添加需要增加的可用区&lt;/span>
$ kubectl edit onecloudcluster -n onecloud default
...
customZones:
- my-zone-1
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>修改完后保存退出，然后使用 &lt;code>climc zone-list&lt;/code> 看下是否有新建的可用区：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc zone-list
+--------------------------------------+-----------+--------+----------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> Cloudregion_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-----------+--------+----------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> d64ccd80-7643-454d-8d40-7f5a0d57107f &lt;span style="color:#000;font-weight:bold">|&lt;/span> my-zone-1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">enable&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> default &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> 04f414a7-ce55-470a-8d64-c6e4e64ccdfc &lt;span style="color:#000;font-weight:bold">|&lt;/span> zone0 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">enable&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> default &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-----------+--------+----------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="物理机管理服务baremetal-agent-和vmware管理服务esxi-agent">物理机管理服务(baremetal-agent) 和VMware管理服务(esxi-agent)&lt;/h2>
&lt;p>发现已经有新建的可用区 my-zone-1 了，operator 服务也会自动创建对应可用区的物理机管理服务(baremetal-agent) 和VMware管理服务(esxi-agent) ，查看对应的 deployment，命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl get deployments. -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep my-zone-1
default-baremetal-agent-my-zone-1 0/0 &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 3m37s
default-esxi-agent-my-zone-1 1/1 &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 3m42s
&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中物理机服务(baremetal-agent)需要选择一个 k8s node 手动开启。&lt;/p>
&lt;h3 id="启用-baremetal-agent">启用 baremetal-agent&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># $listen_interface 指的是 baremetal-agent 监听的网卡名称&lt;/span>
$ ocadm baremetal &lt;span style="color:#204a87">enable&lt;/span> --node &lt;span style="color:#000">$node_name&lt;/span> --listen-interface &lt;span style="color:#000">$listen_interface&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 观察 baremetal agent pod 状态查看是否启动成功&lt;/span>
$ watch &lt;span style="color:#4e9a06">&amp;#34;kubectl get pods -n onecloud | grep baremetal&amp;#34;&lt;/span>
default-baremetal-agent-7c84996c9b-hhllw 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 3m10s
&lt;span style="color:#8f5902;font-style:italic"># 启动成功确认 baremetal-agent 注册到控制节点&lt;/span>
$ climc agent-list
+--------------------------------------+--------------------------+----------------+-----------------------------+---------+------------+------------------------------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Access_ip &lt;span style="color:#000;font-weight:bold">|&lt;/span> Manager_URI &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> agent_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> version &lt;span style="color:#000;font-weight:bold">|&lt;/span> zone_id &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+--------------------------+----------------+-----------------------------+---------+------------+------------------------------------------+--------------------------------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> f3c2c671-c41d-4f30-8d04-e022b49bb9b5 &lt;span style="color:#000;font-weight:bold">|&lt;/span> baremetal-10.168.222.150 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 10.168.222.150 &lt;span style="color:#000;font-weight:bold">|&lt;/span> https://10.168.222.150:8879 &lt;span style="color:#000;font-weight:bold">|&lt;/span> enabled &lt;span style="color:#000;font-weight:bold">|&lt;/span> baremetal &lt;span style="color:#000;font-weight:bold">|&lt;/span> remotes/origin/master&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>5e415506120011509&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> 6230b485-2e54-480e-8284-33360b8202a8 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+--------------------------+----------------+-----------------------------+---------+------------+------------------------------------------+--------------------------------------+
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="宿主机服务">宿主机服务&lt;/h2>
&lt;p>宿主机服务(host)管理一台宿主机上的虚拟机，默认情况下的宿主机属于可用区zone0，如果有其它机房的宿主机，需要新建可用区，然后创建一个属于这个可用区的二层网络(wire)，再基于这个二层网络(wire)创建包含注册宿主机IP的子网(network)，最后把宿主机添加进来就可以了。&lt;/p>
&lt;h3 id="创建二层网络">创建二层网络&lt;/h3>
&lt;p>直接基于之前创建的可用区 my-zone-1 创建二层网络 my-wire-1，命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 10000 表示的是带宽，假设是万兆的网络&lt;/span>
$ climc wire-create my-zone-1 my-wire-1 &lt;span style="color:#0000cf;font-weight:bold">10000&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 查看新建的二层网络&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 能看到二层网络在 my-zone-1 可用区下面&lt;/span>
$ climc wire-list --details
+--------------------------------------+-----------+-----------+--------------------------------------+-----------+----------+---------+---------+--------------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Bandwidth &lt;span style="color:#000;font-weight:bold">|&lt;/span> Zone_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Zone &lt;span style="color:#000;font-weight:bold">|&lt;/span> Networks &lt;span style="color:#000;font-weight:bold">|&lt;/span> VPC &lt;span style="color:#000;font-weight:bold">|&lt;/span> VPC_ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> public_scope &lt;span style="color:#000;font-weight:bold">|&lt;/span> domain_id &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-----------+-----------+--------------------------------------+-----------+----------+---------+---------+--------------+-----------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> f0582003-8a11-4200-8ffd-025bbe7bfc5a &lt;span style="color:#000;font-weight:bold">|&lt;/span> my-wire-1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">10000&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> d64ccd80-7643-454d-8d40-7f5a0d57107f &lt;span style="color:#000;font-weight:bold">|&lt;/span> my-zone-1 &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> Default &lt;span style="color:#000;font-weight:bold">|&lt;/span> default &lt;span style="color:#000;font-weight:bold">|&lt;/span> system &lt;span style="color:#000;font-weight:bold">|&lt;/span> default &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+-----------+-----------+--------------------------------------+-----------+----------+---------+---------+--------------+-----------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="创建-ip-子网">创建 IP 子网&lt;/h3>
&lt;p>根据上一步，已经创建好了二层网络 my-wire-1，接下来我们创建包含注册宿主机 IP 的子网，假设待注册宿主机的网络信息如下：&lt;/p>
&lt;ul>
&lt;li>IP: 192.168.121.61&lt;/li>
&lt;li>默认网关：192.168.121.1&lt;/li>
&lt;li>掩码：24&lt;/li>
&lt;/ul>
&lt;p>根据需要注册的宿主机信息，创建一个 my-hostnet-1，网段为 192.168.121.61-192.168.121.62，这里也可以根据自己的环境变更网络的范围，对应命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc network-create &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --server-type baremetal &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> --gateway 192.168.121.21 &lt;span style="color:#4e9a06">\
&lt;/span>&lt;span style="color:#4e9a06">&lt;/span> my-wire-1 my-hostnet-1 192.168.121.61 192.168.121.62 &lt;span style="color:#0000cf;font-weight:bold">24&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="添加计算节点">添加计算节点&lt;/h3>
&lt;p>子网创建好后，就可以使用部署工具 ocboot 的 &lt;code>add-node&lt;/code> 命令添加目标宿主机到平台了，详细添加方法可以参考&lt;a href="../host">添加计算节点&lt;/a>，假设目标宿主机 IP 为 192.168.121.61 ，控制节点 IP 为 192.168.121.21，对应命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ./ocboot.py add-node 192.168.121.21 192.168.121.61
&lt;/code>&lt;/pre>&lt;/div>&lt;p>等待命令执行完成后，查看宿主机所属的可用区是否为 my-zone-1：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc host-list --zone my-zone-1
+--------------------------------------+----------------------+-------------------+----------------+-----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+--------------------------------+--------------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> ID &lt;span style="color:#000;font-weight:bold">|&lt;/span> Name &lt;span style="color:#000;font-weight:bold">|&lt;/span> Access_mac &lt;span style="color:#000;font-weight:bold">|&lt;/span> Access_ip &lt;span style="color:#000;font-weight:bold">|&lt;/span> Manager_URI &lt;span style="color:#000;font-weight:bold">|&lt;/span> Status &lt;span style="color:#000;font-weight:bold">|&lt;/span> enabled &lt;span style="color:#000;font-weight:bold">|&lt;/span> host_status &lt;span style="color:#000;font-weight:bold">|&lt;/span> mem_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> cpu_count &lt;span style="color:#000;font-weight:bold">|&lt;/span> node_count &lt;span style="color:#000;font-weight:bold">|&lt;/span> sn &lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> host_type &lt;span style="color:#000;font-weight:bold">|&lt;/span> version &lt;span style="color:#000;font-weight:bold">|&lt;/span> storage_size &lt;span style="color:#000;font-weight:bold">|&lt;/span> domain_id &lt;span style="color:#000;font-weight:bold">|&lt;/span> public_scope &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------------------+-------------------+----------------+-----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+--------------------------------+--------------+-----------+--------------+
&lt;span style="color:#000;font-weight:bold">|&lt;/span> d80a4163-5466-43e3-8876-6bbcb042c911 &lt;span style="color:#000;font-weight:bold">|&lt;/span> node2-192-168-121-61 &lt;span style="color:#000;font-weight:bold">|&lt;/span> 52:54:00:e0:ed:9d &lt;span style="color:#000;font-weight:bold">|&lt;/span> 192.168.121.61 &lt;span style="color:#000;font-weight:bold">|&lt;/span> https://192.168.121.61:8885 &lt;span style="color:#000;font-weight:bold">|&lt;/span> running &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#204a87">false&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> online &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">3686&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> Not Specified &lt;span style="color:#000;font-weight:bold">|&lt;/span> rotate &lt;span style="color:#000;font-weight:bold">|&lt;/span> hypervisor &lt;span style="color:#000;font-weight:bold">|&lt;/span> release/3.8&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>4064385d922011109&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">29405&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> default &lt;span style="color:#000;font-weight:bold">|&lt;/span> system &lt;span style="color:#000;font-weight:bold">|&lt;/span>
+--------------------------------------+----------------------+-------------------+----------------+-----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+--------------------------------+--------------+-----------+--------------+
*** Total: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Pages: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Limit: &lt;span style="color:#0000cf;font-weight:bold">20&lt;/span> Offset: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> Page: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> ***
&lt;/code>&lt;/pre>&lt;/div>&lt;p>发现 192.168.121.61 的宿主机已经添加到新建的可用区 my-zone-1 了。&lt;/p></description></item><item><title>Docs: 前端双向认证配置</title><link>https://www.cloudpods.org/zh/docs/setup/traefik-mutual-tls/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/traefik-mutual-tls/</guid><description>
&lt;p>平台部署后默认打开了 TLS 服务端(单向)认证，本文介绍如何在已有服务端认证的情况下，开启客户端验证(双向)认证。&lt;/p>
&lt;p>整个云平台运行在 Kubernetes 之上，前端服务通过 ingress 暴露出来，我们使用了开源的 &lt;a href="https://doc.traefik.io/traefik/v1.7">traefik&lt;/a> 组件来负责 ingress 的实现，所以在 traefik 上设置客户端认证。&lt;/p>
&lt;h2 id="生成证书">生成证书&lt;/h2>
&lt;p>下面使用生成自签名证书的方式来配置，如果已经有证书机构签发的服务端和客户端证书，可以忽略这个步骤。&lt;/p>
&lt;h3 id="生成-ca">生成 CA&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ openssl req -x509 -sha256 -newkey rsa:4096 -keyout ca.key -out ca.crt -days &lt;span style="color:#0000cf;font-weight:bold">356&lt;/span> -nodes -subj &lt;span style="color:#4e9a06">&amp;#39;/CN=My Cert Authority&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="生成-server-服务端证书">生成 Server 服务端证书&lt;/h3>
&lt;p>基于上面生成的 CA 签发 server 证书：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ openssl req -new -newkey rsa:4096 -keyout server.key -out server.csr -nodes -subj &lt;span style="color:#4e9a06">&amp;#39;/CN=mydomain.com&amp;#39;&lt;/span>
$ openssl x509 -req -sha256 -days &lt;span style="color:#0000cf;font-weight:bold">365&lt;/span> -in server.csr -CA ca.crt -CAkey ca.key -set_serial &lt;span style="color:#0000cf;font-weight:bold">01&lt;/span> -out server.crt
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="生成-client-客户端证书">生成 Client 客户端证书&lt;/h3>
&lt;p>基于上面生成的 CA 签发 client 证书：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ openssl req -new -newkey rsa:4096 -keyout client.key -out client.csr -nodes -subj &lt;span style="color:#4e9a06">&amp;#39;/CN=My Client&amp;#39;&lt;/span>
$ openssl x509 -req -sha256 -days &lt;span style="color:#0000cf;font-weight:bold">365&lt;/span> -in client.csr -CA ca.crt -CAkey ca.key -set_serial &lt;span style="color:#0000cf;font-weight:bold">02&lt;/span> -out client.crt
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="上传证书到-kubernetes">上传证书到 Kubernetes&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 上传 ca 到 kube-system 命令空间&lt;/span>
$ kubectl -n kube-system create secret generic ca-secret --from-file&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>ca.crt&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>ca.crt
&lt;span style="color:#8f5902;font-style:italic"># 上传 server 证书到 onecloud 命名空间&lt;/span>
$ kubectl -n onecloud create secret generic tls-secret --from-file&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>tls.crt&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>server.crt --from-file&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>tls.key&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>server.key
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改前端-default-web-ingress">修改前端 default-web ingress&lt;/h2>
&lt;p>前端是通过 onecloud 命令空间里面的 default-web ingress 访问的，把前端使用的 tls 证书换成 tls-secret 。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl edit ingress -n onecloud default-web
...
tls:
&lt;span style="color:#8f5902;font-style:italic"># 修改这个 secretName 为 tls-secret&lt;/span>
- secretName: tls-secret
...
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="修改-traefik-配置">修改 traefik 配置&lt;/h2>
&lt;h3 id="修改-traefik-configmap">修改 traefik configmap&lt;/h3>
&lt;p>traefik 的配置在 kube-system 命名空间的 traefik-ingress-lb config 里面，开启客户端验证主要是配置 &lt;strong>entryPoints.https.tls.ClientCA&lt;/strong> 。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl edit configmaps -n kube-system traefik-ingress-lb
...
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>entryPoints.https&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#000">address&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;:443&amp;#34;&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 添加如下的 ClientCA 配置&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>entryPoints.https.tls&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>entryPoints.https.tls.ClientCA&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#000">files&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;/tests/ca.crt&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>
&lt;span style="color:#000">optional&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87">false&lt;/span>
...
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="修改-traefik-daemonset">修改 traefik daemonset&lt;/h3>
&lt;p>然后修改 kube-system 命令空间里面的 traefik-ingress-controller daemonset ，主要是把刚才创建的 ca-secret 挂载到配置的 &lt;strong>/tests/ca.crt&lt;/strong> 目录。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl edit daemonsets -n kube-system traefik-ingress-controller
...
volumeMounts:
- mountPath: /config
name: config
&lt;span style="color:#8f5902;font-style:italic"># 添加这个 volume mount，名称为 ca&lt;/span>
- mountPath: /tests
name: ca
...
volumes:
- configMap:
defaultMode: &lt;span style="color:#0000cf;font-weight:bold">420&lt;/span>
name: traefik-ingress-lb
name: config
- name: ca
secret:
defaultMode: &lt;span style="color:#0000cf;font-weight:bold">420&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 这里引用之前创建的 ca-secret&lt;/span>
secretName: ca-secret
...
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="重启-traefik-服务">重启 traefik 服务&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl get pods -n kube-system &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep traefik &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> xargs kubectl delete pods -n kube-system
&lt;/code>&lt;/pre>&lt;/div>&lt;p>等待 traefik 容器变成 Running。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl get pods -n kube-system &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep traefik
traefik-ingress-controller-fk54h 1/1 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 9s
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="使用-curl-进行测试">使用 curl 进行测试&lt;/h2>
&lt;p>假设部署的前端访问地址是 https://192.168.121.21 ，下面验证客户端认证是否开启：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 不使用 client 证书访问失败，符合预期&lt;/span>
$ curl -k https://192.168.121.21
curl: &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>58&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> NSS: client certificate not found &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>nickname not specified&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 使用 client 证书访问成功&lt;/span>
$ curl -k --cert ./client.crt --key ./client.key https://192.168.121.21
&amp;lt;!DOCTYPE html&amp;gt;&amp;lt;html &lt;span style="color:#000">lang&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>en &lt;span style="color:#000">translate&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>no&amp;gt;&amp;lt;head&amp;gt;&amp;lt;meta &lt;span style="color:#000">charset&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>utf-8&amp;gt;&amp;lt;meta http-equiv&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>X-UA-Compatible &lt;span style="color:#000">content&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;IE=edge&amp;#34;&lt;/span>&amp;gt;&amp;lt;meta &lt;span style="color:#000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>viewport &lt;span style="color:#000">content&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;width=device-width,initial-scale=1&amp;#34;&lt;/span>&amp;gt;&amp;lt;meta &lt;span style="color:#000">name&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>google &lt;span style="color:#000">content&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>notranslate&amp;gt;&amp;lt;link &lt;span style="color:#000">rel&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>icon &lt;span style="color:#000">href&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/favicon.ico&amp;gt;&amp;lt;title&amp;gt;云联壹云&amp;lt;/title&amp;gt;&amp;lt;link &lt;span style="color:#000">href&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/js/chunk-2d216214.5f7b7e0c.js &lt;span style="color:#000">rel&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>prefetch&amp;gt;&amp;lt;link &lt;span style="color:#000">href&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/js/chunk-39bb5eb4.8512e62d.js &lt;span style="color:#000">rel&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>prefetch&amp;gt;&amp;lt;link &lt;span style="color:#000">href&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/css/app.fb52a32e.css &lt;span style="color:#000">rel&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>preload &lt;span style="color:#000">as&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>style&amp;gt;&amp;lt;link &lt;span style="color:#000">href&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/css/chunk-vendors.09e9c25d.css &lt;span style="color:#000">rel&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>preload &lt;span style="color:#000">as&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>style&amp;gt;&amp;lt;link &lt;span style="color:#000">href&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/js/app.74cda7af.js &lt;span style="color:#000">rel&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>preload &lt;span style="color:#000">as&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>script&amp;gt;&amp;lt;link &lt;span style="color:#000">href&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/js/chunk-vendors.a7b5c015.js &lt;span style="color:#000">rel&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>preload &lt;span style="color:#000">as&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>script&amp;gt;&amp;lt;link &lt;span style="color:#000">href&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/css/chunk-vendors.09e9c25d.css &lt;span style="color:#000">rel&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>stylesheet&amp;gt;&amp;lt;link &lt;span style="color:#000">href&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/css/app.fb52a32e.css &lt;span style="color:#000">rel&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>stylesheet&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt;&amp;lt;noscript&amp;gt;&amp;lt;strong&amp;gt;We&lt;span style="color:#4e9a06">&amp;#39;re sorry but OneCloud doesn&amp;#39;&lt;/span>t work properly without JavaScript enabled. Please &lt;span style="color:#204a87">enable&lt;/span> it to &lt;span style="color:#204a87;font-weight:bold">continue&lt;/span>.&amp;lt;/strong&amp;gt;&amp;lt;/noscript&amp;gt;&amp;lt;div &lt;span style="color:#000">id&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>app&amp;gt;&amp;lt;/div&amp;gt;&amp;lt;script &lt;span style="color:#000">src&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/vendor.b82688a471b737ceddd1.js&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script &lt;span style="color:#000">src&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/js/chunk-vendors.a7b5c015.js&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script &lt;span style="color:#000">src&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>/js/app.74cda7af.js&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="浏览器配置">浏览器配置&lt;/h2>
&lt;p>通过以上的配置，发现客户端配置已经成功，但通过浏览器访问，还需要把客户端的证书放到浏览器里面，否则访问就会出现下面的界面：&lt;/p>
&lt;p>&lt;img src="../images/chrome-bad-ssl-client.png" alt="">&lt;/p>
&lt;p>下面以 Chrome 浏览器为例， 需要把之前生成的 client.crt 和 client.key 装换成 pfx/pkcs12 格式，就能导入浏览器，命令如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 把 client.crt 和 client.key 组合到一起&lt;/span>
$ cat client.crt client.key &amp;gt; pkcs12.pem
&lt;span style="color:#8f5902;font-style:italic"># 转换成 pkcs12 格式&lt;/span>
$ openssl pkcs12 -in pkcs12.pem -export -out pkcs12.p12
&lt;/code>&lt;/pre>&lt;/div>&lt;p>把 pkcs12.p12 导入到浏览器：&lt;/p>
&lt;p>&lt;img src="../images/chrome-certs.png" alt="">&lt;/p>
&lt;p>选择刚才生成的 pkcs12.p12 证书：&lt;/p>
&lt;p>&lt;img src="../images/chrome-import-pkcs12.png" alt="">&lt;/p>
&lt;p>导入后再刷新访问前端，就可以成功访问界面。&lt;/p>
&lt;p>&lt;img src="../images/chrome-web.png" alt="">&lt;/p></description></item><item><title>Docs: 数据库记录一致性校验</title><link>https://www.cloudpods.org/zh/docs/setup/db-record-consistency/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/db-record-consistency/</guid><description>
&lt;p>数据库记录一致性校验的原理是计算表里面每条记录的 md5 值，如果人工修改字段，平台的服务在读取，更新或者删除的时候就会发现计算的 md5 checksum 不一致，禁止接下来的操作。&lt;/p>
&lt;h2 id="配置">配置&lt;/h2>
&lt;p>开启改选项会产生额外的计算量。默认开启以下服务的配置表：&lt;/p>
&lt;ul>
&lt;li>keystone 服务:
&lt;ul>
&lt;li>user 表: 保存用户信息的表&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>region 服务:
&lt;ul>
&lt;li>guests_tbl 表: 保存虚拟机信息&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>logger 服务:
&lt;ul>
&lt;li>actionlog_tbl 表: 保存操作日志&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>分别编辑这两个服务的配置 configmap default-keystone 和 default-region 里面的 enable_db_checksum_tables 这个参数：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 配置 keystone 服务配置&lt;/span>
$ kubectl -n onecloud edit configmaps default-keystone
...
enable_db_checksum_tables: &lt;span style="color:#204a87">true&lt;/span>
...
&lt;span style="color:#8f5902;font-style:italic"># 重启 keystone 服务&lt;/span>
$ kubectl -n onecloud rollout restart deployment default-keystone
&lt;span style="color:#8f5902;font-style:italic"># 配置 region 服务配置&lt;/span>
$ kubectl -n onecloud edit configmaps default-region
...
enable_db_checksum_tables: &lt;span style="color:#204a87">true&lt;/span>
...
&lt;span style="color:#8f5902;font-style:italic"># 重启 region 服务&lt;/span>
$ kubectl -n onecloud rollout restart deployment default-region
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="测试">测试&lt;/h2>
&lt;p>当开启 enable_db_checksum_tables 的配置后，每条记录就会有一个 record_checksum 的字段，这里以 keystone 数据库的 user 表来测试，看看如果手动修改了记录会发生什么情况：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 查看 cloudadmin 用户的 record_checksum, id 和 last_login_ip&lt;/span>
$ climc user-show cloudadmin &lt;span style="color:#000;font-weight:bold">|&lt;/span> egrep -w &lt;span style="color:#4e9a06">&amp;#39;record_checksum|id|last_login_ip&amp;#39;&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> id &lt;span style="color:#000;font-weight:bold">|&lt;/span> 475925c93c344a54837fe49f852c5086 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> last_login_ip &lt;span style="color:#000;font-weight:bold">|&lt;/span> 192.168.121.1 &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#000;font-weight:bold">|&lt;/span> record_checksum &lt;span style="color:#000;font-weight:bold">|&lt;/span> 3d953f46c400ba3bd9562be8ae2a9d9c &lt;span style="color:#000;font-weight:bold">|&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 找到当前集群的数据库密码&lt;/span>
$ kubectl get oc -n onecloud -o yaml &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -A &lt;span style="color:#0000cf;font-weight:bold">4&lt;/span> mysql
mysql:
host: 192.168.121.21
password: y4uzCV37gZEr
port: &lt;span style="color:#0000cf;font-weight:bold">3306&lt;/span>
username: root
&lt;span style="color:#8f5902;font-style:italic"># 连上 keystone 数据库，把 cloudadmin 的 last_login_ip 字段改成 192.168.121.2&lt;/span>
$ mysql -u root -py4uzCV37gZEr -h 192.168.121.21 keystone
MariaDB &lt;span style="color:#ce5c00;font-weight:bold">[&lt;/span>keystone&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span>&amp;gt; update user &lt;span style="color:#204a87">set&lt;/span> &lt;span style="color:#000">last_login_ip&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;192.168.121.2&amp;#39;&lt;/span> where &lt;span style="color:#000">id&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;475925c93c344a54837fe49f852c5086&amp;#39;&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
Query OK, &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> row affected &lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>0.00 sec&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span>
Rows matched: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Changed: &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> Warnings: &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 再次查看 cloudadmin user，会提示记录被修改，checksum 不一致的报错&lt;/span>
$ climc user-show cloudadmin
&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;error&amp;#34;&lt;/span>:&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;class&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;UnclassifiedError&amp;#34;&lt;/span>,&lt;span style="color:#4e9a06">&amp;#34;code&amp;#34;&lt;/span>:500,&lt;span style="color:#4e9a06">&amp;#34;details&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;Record user(475925c93c344a54837fe49f852c5086) checksum changed, expected(3d953f46c400ba3bd9562be8ae2a9d9c) != calculated(701f345054c8fee78cebb130730c8ba0)&amp;#34;&lt;/span>,&lt;span style="color:#4e9a06">&amp;#34;request&amp;#34;&lt;/span>:&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;headers&amp;#34;&lt;/span>:&lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;User-Agent&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;yunioncloud-go/201708&amp;#34;&lt;/span>,&lt;span style="color:#4e9a06">&amp;#34;X-Auth-Token&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;*&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>,&lt;span style="color:#4e9a06">&amp;#34;method&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;GET&amp;#34;&lt;/span>,&lt;span style="color:#4e9a06">&amp;#34;url&amp;#34;&lt;/span>:&lt;span style="color:#4e9a06">&amp;#34;http://192.168.121.21:30500/v3/users/cloudadmin&amp;#34;&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">}}}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="注意事项">注意事项&lt;/h2>
&lt;p>为了兼容性，这个 db_checksum_tables 里面配置的表每次服务启动都会计算，如果数据量很大，可能会导致服务启动很慢，当第一次服务初始完每条记录的 checksum 后，可以配置 &lt;code>db_checksum_skip_init: true&lt;/code> 参数跳过初始化 checksum 。比如关闭 keystone 服务第一次初始化 checksum 操作如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl -n onecloud edit configmaps default-keystone
...
db_checksum_skip_init: &lt;span style="color:#204a87">true&lt;/span>
...
&lt;span style="color:#8f5902;font-style:italic"># 重启 keystone 服务&lt;/span>
$ kubectl -n onecloud rollout restart deployment default-keystone
&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: 前端使用 HTTP</title><link>https://www.cloudpods.org/zh/docs/setup/web-use-http/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/web-use-http/</guid><description>
&lt;p>平台部署后默认打开了 TLS 服务端(单向)认证，使用 HTTPS 协议进行浏览器访问前端界面。本文介绍如何配置使用 HTTP 协议访问前端。&lt;/p>
&lt;h2 id="编辑-onecloudcluster-spec">编辑 onecloudcluster spec&lt;/h2>
&lt;p>首先需要编辑 oc.spec.web.useHTTP 属性，该属性默认为 false ，需要设置为 true ，操作如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl edit oc -n onecloud
&lt;/code>&lt;/pre>&lt;/div>&lt;p>搜 useHTTP 关键字，进行如下编辑：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-diff" data-lang="diff"> spec:
web:
&lt;span style="color:#800080;font-weight:bold">@@ -1122,7 +1122,7 @@
&lt;/span>&lt;span style="color:#800080;font-weight:bold">&lt;/span> key: node-role.kubernetes.io/master
- effect: NoSchedule
key: node-role.kubernetes.io/controlplane
&lt;span style="color:#a40000">- useHTTP: false
&lt;/span>&lt;span style="color:#a40000">&lt;/span>&lt;span style="color:#00a000">+ useHTTP: true
&lt;/span>&lt;span style="color:#00a000">&lt;/span> webconsole:
affinity:
nodeAffinity:
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="删除旧的-web-configmap">删除旧的 web configmap&lt;/h2>
&lt;p>web 组件的 configmap 其实是一个 nginx 配置，该配置不会重新生成，需要删除后由 operator 新建，操作如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 删除 web 组件的 configmap&lt;/span>
$ kubectl delete configmap -n onecloud &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>kubectl get configmap -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep web &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -v console &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
configmap &lt;span style="color:#4e9a06">&amp;#34;default-web&amp;#34;&lt;/span> deleted
&lt;span style="color:#8f5902;font-style:italic"># 等待 15s 后，该 configmap 会新建，查看生成的内容&lt;/span>
$ kubectl get configmap -n onecloud &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>kubectl get configmap -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep web &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -v console &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
NAME DATA AGE
default-web &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> 28s
&lt;span style="color:#8f5902;font-style:italic"># 查看其中是否有 80 端口配置，有的话就没有问题了&lt;/span>
$ kubectl get configmap -n onecloud &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>kubectl get configmap -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep web &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -v console &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> -o yaml &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep &lt;span style="color:#4e9a06">&amp;#39;listen 80&amp;#39;&lt;/span>
listen &lt;span style="color:#0000cf;font-weight:bold">80&lt;/span> default_server&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="重启-web-组件">重启 web 组件&lt;/h2>
&lt;p>更新完 web 组件的 configmap 后，需要重启 web 组件的 deployment ，命令为：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 重启 web deployment&lt;/span>
$ kubectl rollout restart deployment -n onecloud &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>kubectl get deployment -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep web &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -v console &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
deployment.extensions/default-web restarted
&lt;span style="color:#8f5902;font-style:italic"># 等待 pod 变为 Running&lt;/span>
$ kubectl get pods -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep web &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -v console
default-web-5bfb6c578b-mdh9w 3/3 Running &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> 58s
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="更新-ingress">更新 ingress&lt;/h2>
&lt;p>web 组件的 service 是使用 ingress 暴露出去的，ingress 默认也不会刷新，需要删除再次创建，操作如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl delete ingress -n onecloud &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>kubectl get ingress -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep web &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
ingress.extensions &lt;span style="color:#4e9a06">&amp;#34;default-web&amp;#34;&lt;/span> deleted
&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看重建的 ingress 规则，已经路由到 80 端口即可：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl get ingress -n onecloud &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>kubectl get ingress -n onecloud &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep web &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> -o yaml &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep -i port
onecloud.yunion.io/last-applied-configuration: &lt;span style="color:#4e9a06">&amp;#39;{&amp;#34;rules&amp;#34;:[{&amp;#34;http&amp;#34;:{&amp;#34;paths&amp;#34;:[{&amp;#34;backend&amp;#34;:{&amp;#34;serviceName&amp;#34;:&amp;#34;default-web&amp;#34;,&amp;#34;servicePort&amp;#34;:80},&amp;#34;path&amp;#34;:&amp;#34;/&amp;#34;}]}}],&amp;#34;tls&amp;#34;:[{&amp;#34;secretName&amp;#34;:&amp;#34;default-certs&amp;#34;}]}&amp;#39;&lt;/span>
servicePort: &lt;span style="color:#0000cf;font-weight:bold">80&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="配置-traefik-ingress-controller">配置 traefik ingress controller&lt;/h2>
&lt;p>如果是使用 helm 部署的集群，就不用执行该步骤了，ingress controller 的实现和具体的 k8s 部署平台有关，现在 web 服务已经是使用 HTTP 协议了。&lt;/p>
&lt;p>下面的步骤仅适用于使用 ocboot 部署的平台，需要设置 traefik ingress controller ，把 http 重定向到 https 这个配置关掉，操作如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl edit configmaps -n kube-system traefik-ingress-lb
&lt;/code>&lt;/pre>&lt;/div>&lt;p>注释掉 entryPoints.http.redirect 配置：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-diff" data-lang="diff">&lt;span style="color:#800080;font-weight:bold">@@ -14,8 +14,8 @@
&lt;/span>&lt;span style="color:#800080;font-weight:bold">&lt;/span> [entryPoints]
[entryPoints.http]
address = &amp;#34;:80&amp;#34;
&lt;span style="color:#a40000">- [entryPoints.http.redirect]
&lt;/span>&lt;span style="color:#a40000">- entryPoint = &amp;#34;https&amp;#34;
&lt;/span>&lt;span style="color:#a40000">&lt;/span>&lt;span style="color:#00a000">+ #[entryPoints.http.redirect]
&lt;/span>&lt;span style="color:#00a000">+ #entryPoint = &amp;#34;https&amp;#34;
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>重启 traefik ingress controller：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl delete pods -n kube-system &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>kubectl get pods -n kube-system &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep traefik-ingress-controller &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span>
pod &lt;span style="color:#4e9a06">&amp;#34;traefik-ingress-controller-xkmct&amp;#34;&lt;/span> deleted
&lt;/code>&lt;/pre>&lt;/div>&lt;p>至此 HTTP 所有配置完成。&lt;/p></description></item><item><title>Docs: 隐藏功能配置</title><link>https://www.cloudpods.org/zh/docs/setup/feature-config/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/feature-config/</guid><description>
&lt;p>由 ocboot 部署的 Cloudpods 是基于 Cloudpods 开源代码构建的社区免费版。这个版本方便用户体验 Cloudpods 的功能。&lt;/p>
&lt;p>Cloudpods 自2017年开始开发，有较长时间积累。但代码量大，功能繁多，有部分代码已经较长时间没有迭代维护。因此，我们在社区免费版的前端选择性地隐藏具备以下特性的部分功能：&lt;/p>
&lt;ol>
&lt;li>不够成熟;&lt;/li>
&lt;li>缺人维护;&lt;/li>
&lt;li>少有人使用;&lt;/li>
&lt;li>复杂度比较高较难理解使用的功能组件；&lt;/li>
&lt;/ol>
&lt;p>这样可以降低维护支持成本，同时提升使用体验。&lt;/p>
&lt;p>隐藏功能的代码依然在开源项目的代码仓库中维护。&lt;/p>
&lt;p>基于这些原因，从 v3.8.7 版本，我们陆续隐藏了一些功能。如果用户这些功能有需求，可以选择如下的方式打开这些功能：&lt;/p>
&lt;ol>
&lt;li>提issue申请打开这个功能；&lt;/li>
&lt;li>部分功能可以通过climc打开功能；&lt;/li>
&lt;li>fork自己的前端版本，把此功能打开。&lt;/li>
&lt;/ol>
&lt;h2 id="使用-climc-打开隐藏功能特性">使用 climc 打开隐藏功能特性&lt;/h2>
&lt;p>比如在 3.9 版本中，我们默认隐藏了 k8s 容器集群管理、京东公有云管理等功能；默认打开了常用的阿里云、AWS 等公有云管理功能。用户可以通过 climc 命令行工具根据自身需要打开或者关闭对应的功能。&lt;/p>
&lt;h3 id="举例">举例&lt;/h3>
&lt;p>子命令的格式和参数如下：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ climc feature-config-&lt;span style="color:#000">$feature&lt;/span> --switch &lt;span style="color:#ce5c00;font-weight:bold">{&lt;/span>on&lt;span style="color:#000;font-weight:bold">|&lt;/span>off&lt;span style="color:#ce5c00;font-weight:bold">}&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># $feature: 表示具体的功能名，比如: k8s, s3, jdcloud 等&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># on: 表示打开&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># off: 表示关闭&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>比如开关 k8s 容器集群管理功能命令为：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 打开&lt;/span>
$ climc feature-config-k8s --switch on
&lt;span style="color:#8f5902;font-style:italic"># 关闭&lt;/span>
$ climc feature-config-k8s --switch off
&lt;/code>&lt;/pre>&lt;/div>&lt;p>比如开关 京东云 管理功能命令为：&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 打开&lt;/span>
$ climc feature-config-jdcloud --switch on
&lt;span style="color:#8f5902;font-style:italic"># 关闭&lt;/span>
$ climc feature-config-jdcloud --switch off
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="功能参照表">功能参照表&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>名称&lt;/th>
&lt;th>功能&lt;/th>
&lt;th>climc 子命令&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>onestack&lt;/td>
&lt;td>KVM虚拟化管理&lt;/td>
&lt;td>feature-config-onestack&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>baremetal&lt;/td>
&lt;td>裸金属管理&lt;/td>
&lt;td>feature-config-baremetal&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>lb&lt;/td>
&lt;td>负载均衡管理&lt;/td>
&lt;td>feature-config-lb&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>aliyun&lt;/td>
&lt;td>阿里公有云管理&lt;/td>
&lt;td>feature-config-aliyun&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>aws&lt;/td>
&lt;td>AWS 亚马逊公有云管理&lt;/td>
&lt;td>feature-config-aws&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>azure&lt;/td>
&lt;td>Azure 微软公有云管理&lt;/td>
&lt;td>feature-config-azure&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>google&lt;/td>
&lt;td>Google 公有云管理&lt;/td>
&lt;td>feature-config-google&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>qcloud&lt;/td>
&lt;td>腾讯公有云管理&lt;/td>
&lt;td>feature-config-qcloud&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ctyun&lt;/td>
&lt;td>天翼公有云管理&lt;/td>
&lt;td>feature-config-ctyun&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>huawei&lt;/td>
&lt;td>华为公有云管理&lt;/td>
&lt;td>feature-config-huawei&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ucloud&lt;/td>
&lt;td>ucloud 公有云管理&lt;/td>
&lt;td>feature-config-ucloud&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ecloud&lt;/td>
&lt;td>移动公有云管理&lt;/td>
&lt;td>feature-config-ecloud&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>jdcloud&lt;/td>
&lt;td>京东公有云管理&lt;/td>
&lt;td>feature-config-jdcloud&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>vmware&lt;/td>
&lt;td>VMWare 管理&lt;/td>
&lt;td>feature-config-vmware&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>openstack&lt;/td>
&lt;td>openstack 私有云管理&lt;/td>
&lt;td>feature-config-openstack&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>zstack&lt;/td>
&lt;td>zstack 私有云管理&lt;/td>
&lt;td>feature-config-zstack&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>apsara&lt;/td>
&lt;td>阿里飞天专有云管理&lt;/td>
&lt;td>feature-config-apsara&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cloudpods&lt;/td>
&lt;td>Cloudpods私有云管理&lt;/td>
&lt;td>feature-config-cloudpods&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>hcso&lt;/td>
&lt;td>华为HCSO私有云管理&lt;/td>
&lt;td>feature-config-hcso&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>nutanix&lt;/td>
&lt;td>Nutanix超融合管理&lt;/td>
&lt;td>feature-config-nutanix&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>s3&lt;/td>
&lt;td>通用S3对象存储管理&lt;/td>
&lt;td>feature-config-s3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ceph&lt;/td>
&lt;td>Ceph rados对象存储管理&lt;/td>
&lt;td>feature-config-ceph&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>xsky&lt;/td>
&lt;td>Xsky 存储管理&lt;/td>
&lt;td>feature-config-xsky&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>k8s&lt;/td>
&lt;td>K8S 容器集群管理&lt;/td>
&lt;td>feature-config-k8s&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>Docs: 更换节点IP</title><link>https://www.cloudpods.org/zh/docs/setup/changeip/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudpods.org/zh/docs/setup/changeip/</guid><description>
&lt;p>本文介绍更换集群控制节点和计算节点IP的方法步骤.&lt;/p>
&lt;p>由于Kubernetes的节点IP无法动态更换，更换后必须重新部署Kubelet服务，因此更换节点IP后，需要将节点上Kubelet实例重置，并重新部署节点。&lt;/p>
&lt;p>下面分几种情况讨论：&lt;/p>
&lt;h2 id="allinone节点更换ip">AllInOne节点更换IP&lt;/h2>
&lt;h3 id="1-清理kubelet">1. 清理Kubelet&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ocadm reset -f
$ kubeadm reset -f
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="2-修改旧的configyml">2. 修改旧的config.yml&lt;/h3>
&lt;div class="alert alert-warning" role="alert">
&lt;h4 class="alert-heading">注意&lt;/h4>
&lt;ul>
&lt;li>如果第一次部署是直接运行的 &lt;code>./run.py $ip&lt;/code> 这种方式，生成的配置文件就在 ocboot 目录下的 config-allinone-current.yml 文件&lt;/li>
&lt;li>如果第一次部署是用的自定义配置文件，请使用相关配置文件&lt;/li>
&lt;li>如果第一次部署是用的商业版本 iso 部署的，配置文件在 opt/yunion/upgrade/config.yml 路径&lt;/li>
&lt;/ul>
&lt;/div>
&lt;p>下面假设第一次部署运行的命令为 &lt;code>./run.py $ip&lt;/code> 这种形式，所以生成的配置文件在运行 ocboot 目录下的 config-allinone-current.yml 文件。&lt;/p>
&lt;p>在第一次运行 ocboot 目录下保存有当时部署时使用的 config-allinone-current.yml 配置文件。备份该 yaml 文件，并修改文件，将旧的 IP 地址替换为新的 IP 地址。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ cp ./config-allinone-current.yml config.yml
$ vim config.yml
&lt;span style="color:#8f5902;font-style:italic"># 修改里面节点的 ip 地址，包括 primary_master_node 下面的 hostname，controlplane_host&lt;/span>
&lt;span style="color:#8f5902;font-style:italic"># 如果当时部署的 mariadb 也在该节点上，还要修改 mariadb_node 里面的 hostname 以及 primary_master_node 里面的 db_host&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="3-重新部署">3. 重新部署&lt;/h3>
&lt;p>使用 ocboot 重新部署 AllInOne 节点&lt;/p>
&lt;pre>&lt;code>$ ./ocboot.py install config.yml
&lt;/code>&lt;/pre>&lt;h3 id="4-开启operator-sync-user模式">4. 开启operator sync-user模式&lt;/h3>
&lt;p>重新部署会重新生成各个服务在mysql的账号的密码，以及各个服务账号的密码。这些信息都存储在数据库中。重新部署之后，新的Kubernetes中configmaps中留下的密码和旧的配置不一致，会导致服务无法正常启动。解决的办法是：修改onecloud-opeartor服务的启动参数，添加-sync-user参数，这样operator会自动更新数据库中保存的密码，确保和Kubernetes的configmaps中的密码一致。&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ kubectl -n onecloud edit deployment onecloud-operator
&lt;span style="color:#8f5902;font-style:italic"># 找到 .spec..containers[0].command 路径，添加 &amp;#39;-sync-user&amp;#39; 参数&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>修改后的结果如下图：&lt;/p>
&lt;p>&lt;img src="../../quickstart/images/oo_syncuser.png" alt="">&lt;/p>
&lt;h2 id="私有云计算节点更换ip">私有云计算节点更换IP&lt;/h2>
&lt;p>计算节点更换IP的流程同AllInOne，但是需要在控制节点删除清理该节点信息，包括k8s的node信息和云平台的宿主机信息。删除干净后，再运行上述命令，重置计算节点的Kubenetes，流程如下：&lt;/p>
&lt;h3 id="1-清理kubelet-1">1. 清理Kubelet&lt;/h3>
&lt;p>下面命令在计算节点上运行，清理节点上的 kubelet&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ocadm reset -f
$ kubeadm reset -f
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="2-删除-node-信息">2. 删除 node 信息&lt;/h3>
&lt;p>下面命令在控制节点运行&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 假设要删除的节点为 node1&lt;/span>
$ &lt;span style="color:#000">nodename&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>node1
$ kubectl delete node &lt;span style="color:#000">$nodename&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="3-使用-ocboot-重新加入节点">3. 使用 ocboot 重新加入节点&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">$ ./ocboot.py add-node &lt;span style="color:#000">$primary_master_ip&lt;/span> &lt;span style="color:#000">$target_node_ip&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="faq">FAQ&lt;/h2>
&lt;h3 id="1-计算节点-host-服务运行异常或者平台对应的宿主机记录状态未知怎样查看计算节点上-host-服务的日志">1. 计算节点 host 服务运行异常或者平台对应的宿主机记录状态未知，怎样查看计算节点上 host 服务的日志？&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-bash" data-lang="bash">&lt;span style="color:#8f5902;font-style:italic"># 先确定有问题的计算节点在当前 k8s 里面的节点名称&lt;/span>
$ kubectl get nodes
NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP
ceph-01 Ready &amp;lt;none&amp;gt; 127d v1.15.12 192.168.222.111 &amp;lt;none&amp;gt;
ceph-02 Ready &amp;lt;none&amp;gt; 127d v1.15.12 192.168.222.112 &amp;lt;none&amp;gt;
&lt;span style="color:#8f5902;font-style:italic"># 比如现在要查看 ceph-02 上的 host 服务日志，命令如下&lt;/span>
$ kubectl logs -n onecloud &lt;span style="color:#204a87;font-weight:bold">$(&lt;/span>kubectl get pods -n onecloud -o wide &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep host &lt;span style="color:#000;font-weight:bold">|&lt;/span> egrep -v &lt;span style="color:#4e9a06">&amp;#39;image|deployer&amp;#39;&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep ceph-02 &lt;span style="color:#000;font-weight:bold">|&lt;/span> awk &lt;span style="color:#4e9a06">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">)&lt;/span> -c host
&lt;span style="color:#8f5902;font-style:italic"># 然后查看 host 服务里面相应的报错日志&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>若日志报错信息中包含“register failed: try create network: find_matched == false”，则表示未成功创建包含宿主机的IP子网，导致宿主机注册失败，请创建包含宿主机网段的IP子网。&lt;/li>
&lt;li>若日志报错信息中包含“name starts with letter, and contains letter, number and - only”，则表示宿主机的主机名不合规，应改成以字母开头的hostname&lt;/li>
&lt;/ul></description></item></channel></rss>