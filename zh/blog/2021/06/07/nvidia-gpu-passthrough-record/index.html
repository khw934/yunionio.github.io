<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>使用Linux vfio将Nvidia GPU透传给QEMU虚拟机</title><meta property="og:title" content="使用Linux vfio将Nvidia GPU透传给QEMU虚拟机"><meta property="og:description" content="作者: 李泽玺
Linux 上虚拟机 GPU 透传需要使用 vfio 的方式。主要是因为在 vfio 方式下对虚拟设备的权限和 DMA 隔离上做的更好。但是这么做也有个缺点，这个物理设备在主机和其他虚拟机都不能使用了。
qemu 直接使用物理设备本身命令行是很简单的，关键在于事先在主机上对系统、内核和物理设备的一些配置。
单纯从 qemu 的命令行来看，其实和普通虚拟机启动就差了最后那个 -device 的选项。这个选项也比较容易理解，就是把主机上的设备 0000:00:01.0 传给了虚拟机使用。
$ qemu-system-x86_64 -m 4096 -smp 4 --enable-kvm \  -drive file=~/guest/fedora.img \  -device vfio-pci,host=0000:00:01.0 系统及硬件准备 BIOS中打开IOMMU 设备直通在 x86 平台上需要打开 iommu 功能。这是 Intel 虚拟技术 VT-d(Virtualization Technology for Device IO) 中的一个部分。有时候这部分的功能没有被打开。
打开的方式在 BIOS 设置中 Security->Virtualization->VT-d 这个位置。当然不同的 BIOS 位置可能会略有不同。记得在使用直通设备前要将这个选项打开。
内核配置勾选IOMMU INTEL_IOMMU │ Location: │ │ -> Device Drivers │ │ (2) -> IOMMU Hardware Support (IOMMU_SUPPORT [=y]) 内核启动参数enable IOMMU BIOS 中打开，内核编译选项勾选还不够。还需要在引导程序中添加上内核启动参数"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cloudpods.org/zh/blog/2021/06/07/nvidia-gpu-passthrough-record/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-06-07T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-07T00:00:00+00:00"><meta property="og:site_name" content="Cloudpods"><meta itemprop=name content="使用Linux vfio将Nvidia GPU透传给QEMU虚拟机"><meta itemprop=description content="作者: 李泽玺
Linux 上虚拟机 GPU 透传需要使用 vfio 的方式。主要是因为在 vfio 方式下对虚拟设备的权限和 DMA 隔离上做的更好。但是这么做也有个缺点，这个物理设备在主机和其他虚拟机都不能使用了。
qemu 直接使用物理设备本身命令行是很简单的，关键在于事先在主机上对系统、内核和物理设备的一些配置。
单纯从 qemu 的命令行来看，其实和普通虚拟机启动就差了最后那个 -device 的选项。这个选项也比较容易理解，就是把主机上的设备 0000:00:01.0 传给了虚拟机使用。
$ qemu-system-x86_64 -m 4096 -smp 4 --enable-kvm \  -drive file=~/guest/fedora.img \  -device vfio-pci,host=0000:00:01.0 系统及硬件准备 BIOS中打开IOMMU 设备直通在 x86 平台上需要打开 iommu 功能。这是 Intel 虚拟技术 VT-d(Virtualization Technology for Device IO) 中的一个部分。有时候这部分的功能没有被打开。
打开的方式在 BIOS 设置中 Security->Virtualization->VT-d 这个位置。当然不同的 BIOS 位置可能会略有不同。记得在使用直通设备前要将这个选项打开。
内核配置勾选IOMMU INTEL_IOMMU │ Location: │ │ -> Device Drivers │ │ (2) -> IOMMU Hardware Support (IOMMU_SUPPORT [=y]) 内核启动参数enable IOMMU BIOS 中打开，内核编译选项勾选还不够。还需要在引导程序中添加上内核启动参数"><meta itemprop=datePublished content="2021-06-07T00:00:00+00:00"><meta itemprop=dateModified content="2021-06-07T00:00:00+00:00"><meta itemprop=wordCount content="1240"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="使用Linux vfio将Nvidia GPU透传给QEMU虚拟机"><meta name=twitter:description content="作者: 李泽玺
Linux 上虚拟机 GPU 透传需要使用 vfio 的方式。主要是因为在 vfio 方式下对虚拟设备的权限和 DMA 隔离上做的更好。但是这么做也有个缺点，这个物理设备在主机和其他虚拟机都不能使用了。
qemu 直接使用物理设备本身命令行是很简单的，关键在于事先在主机上对系统、内核和物理设备的一些配置。
单纯从 qemu 的命令行来看，其实和普通虚拟机启动就差了最后那个 -device 的选项。这个选项也比较容易理解，就是把主机上的设备 0000:00:01.0 传给了虚拟机使用。
$ qemu-system-x86_64 -m 4096 -smp 4 --enable-kvm \  -drive file=~/guest/fedora.img \  -device vfio-pci,host=0000:00:01.0 系统及硬件准备 BIOS中打开IOMMU 设备直通在 x86 平台上需要打开 iommu 功能。这是 Intel 虚拟技术 VT-d(Virtualization Technology for Device IO) 中的一个部分。有时候这部分的功能没有被打开。
打开的方式在 BIOS 设置中 Security->Virtualization->VT-d 这个位置。当然不同的 BIOS 位置可能会略有不同。记得在使用直通设备前要将这个选项打开。
内核配置勾选IOMMU INTEL_IOMMU │ Location: │ │ -> Device Drivers │ │ (2) -> IOMMU Hardware Support (IOMMU_SUPPORT [=y]) 内核启动参数enable IOMMU BIOS 中打开，内核编译选项勾选还不够。还需要在引导程序中添加上内核启动参数"><link rel=preload href=/scss/main.min.cb7e4d75313a8182176f2b28b0ce364c4cd309f2387eb9f5a98b59f902ffd8b3.css as=style><link href=/scss/main.min.cb7e4d75313a8182176f2b28b0ce364c4cd309f2387eb9f5a98b59f902ffd8b3.css rel=stylesheet integrity><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/fuse.js@6.6.2></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LX0MD5KG60"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-LX0MD5KG60')</script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark navbar-ce flex-column flex-md-row td-navbar"><a id=cloudpods-top href=/zh/ class="logo flex-shrink-0 navbar-brand"><img src=https://www.cloudpods.org/images/cloudpods_logo_white.png height=46></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/quickstart/><span>快速开始</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://www.yunion.cn/subscription/index.html target=_blank><span>服务订阅</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/blog/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/yunionio/cloudpods target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/swagger><span>API</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>3.10</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>v3.10 (latest)</a>
<a class=dropdown-item href=/v3.9>v3.9</a>
<a class=dropdown-item href=/v3.8>v3.8</a>
<a class=dropdown-item href=/v3.7>v3.7</a>
<a class=dropdown-item href=/v3.6>v3.6</a>
<a class=dropdown-item href=/v3.4>v3.4</a>
<a class=dropdown-item href=/v3.3>v3.3</a>
<a class=dropdown-item href=/v3.2>v3.2</a></div></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.2d73c8ecd9c283f4e3822c77f1f7db31.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhblog-li><a href=/zh/blog/ title="Cloudpods 博客" class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-zhblog><span>博客</span>
<span class=td-sidebar-section_icon-wrapper></span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20230523refactoring-bash-scripts-to-comply-with-the-google-coding-style-li><a href=/zh/blog/2023/05/23/refactoring-bash-scripts-to-comply-with-the-google-coding-style/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20230523refactoring-bash-scripts-to-comply-with-the-google-coding-style><span>记一次符合 Google Coding Style 的 Bash 脚本重构</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20230515introduction-to-the-skypilot-open-source-project-li><a href=/zh/blog/2023/05/15/introduction-to-the-skypilot-open-source-project/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20230515introduction-to-the-skypilot-open-source-project><span>SkyPilot：构建在多云之上的 ML 和数据科学，可节约 3 倍以上成本</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20221129cloudpods-k8s-experience-sharing-li><a href=/zh/blog/2022/11/29/cloudpods-k8s-experience-sharing/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20221129cloudpods-k8s-experience-sharing><span>Cloudpods容器化经验分享</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220202cloudpods-golang-li><a href=/zh/blog/2022/02/02/cloudpods-golang/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220202cloudpods-golang><span>Cloudpods Golang实践</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220121skycomputing-li><a href=/zh/blog/2022/01/21/skycomputing/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220121skycomputing><span>天空计算——云计算的下一个时代？</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20211009rook-ceph-with-cloudpods-li><a href=/zh/blog/2021/10/09/rook-ceph-with-cloudpods/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20211009rook-ceph-with-cloudpods><span>Cloudpods + Rook + Ceph: 轻松实现云原生的超融合私有云</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210925calico-customized-node-firewall-li><a href=/zh/blog/2021/09/25/calico-customized-node-firewall/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210925calico-customized-node-firewall><span>用Calico网络策略设置主机node防火墙规则</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210702ocfs2-as-san-filesystem-li><a href=/zh/blog/2021/07/02/ocfs2-as-san-filesystem/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210702ocfs2-as-san-filesystem><span>QEMU+OCFS2: 使用OCFS2作为虚拟机磁盘文件的SAN存储文件系统</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210701cloudpods-lb-application-intro-li><a href=/zh/blog/2021/07/01/cloudpods-lb-application-intro/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210701cloudpods-lb-application-intro><span>问题分析：为什么keystone的本地用户认证接口压测性能很差？</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210625cgroups-kubernetes-pid-limits-li><a href=/zh/blog/2021/06/25/cgroups-kubernetes-pid-limits/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210625cgroups-kubernetes-pid-limits><span>使用 Cgroups 限制 Kubernetes Pod 进程数</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-zhblog20210607nvidia-gpu-passthrough-record-li><a href=/zh/blog/2021/06/07/nvidia-gpu-passthrough-record/ class="td-sidebar-section_flex pl-0 active td-sidebar-link td-sidebar-link__page" id=m-zhblog20210607nvidia-gpu-passthrough-record><span class=td-sidebar-nav-active-item>使用Linux vfio将Nvidia GPU透传给QEMU虚拟机</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210531cloudpods-37-new-feature-introduction-li><a href=/zh/blog/2021/05/31/cloudpods-3.7-new-feature-introduction/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210531cloudpods-37-new-feature-introduction><span>直播回顾：Cloudpods 3.7版本新功能介绍</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210531cloudpods-lb-application-intro-li><a href=/zh/blog/2021/05/31/cloudpods-lb-application-intro/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210531cloudpods-lb-application-intro><span>直播回顾：Cloudpods负载均衡的功能介绍</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20190613unified-iaas-for-future-li><a href=/zh/blog/2019/06/13/unified-iaas-for-future/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20190613unified-iaas-for-future><span>面向未来的 IT 基础设施管理架构——融合云（Unified IaaS）</span></a></li></ul></li></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/yunionio/docs/edit/master/content/zh/blog/_posts/2021-06-07-nvida-gpu-passthrough-record.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/yunionio/docs/new/master/content/zh/blog/_posts/2021-06-07-nvida-gpu-passthrough-record.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href=https://github.com/yunionio/cloudpods/issues/new/choose target=_blank><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a>
<a href="https://github.com/yunionio/cloudpods/issues/new?title=[Docs]%20%e4%bd%bf%e7%94%a8Linux%20vfio%e5%b0%86Nvidia%20GPU%e9%80%8f%e4%bc%a0%e7%bb%99QEMU%e8%99%9a%e6%8b%9f%e6%9c%ba" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a></div><div id=toc-hidden><nav id=TableOfContents><ul><li><a href=#系统及硬件准备>系统及硬件准备</a><ul><li><a href=#bios中打开iommu>BIOS中打开IOMMU</a></li><li><a href=#内核配置勾选iommu>内核配置勾选IOMMU</a></li><li><a href=#内核启动参数enable-iommu>内核启动参数enable IOMMU</a></li><li><a href=#找到-nvidia-gpu-busid>找到 nvidia GPU BusID</a></li><li><a href=#使用-vfio-管理-gpu>使用 vfio 管理 GPU</a></li><li><a href=#使用-qemu-透传-nvidia-gpu>使用 qemu 透传 nvidia GPU</a></li></ul></li><li><a href=#安装nvidia-驱动和-cuda>安装nvidia 驱动和 Cuda</a><ul><li><a href=#安装-nvidia-驱动>安装 nvidia 驱动</a></li><li><a href=#安装-cuda>安装 cuda</a></li></ul></li></ul></nav></div><script>let tocNode=document.getElementById('toc-hidden'),list=clectionLis1(),ul=createList(list);tocNode.innerHTML='',tocNode.appendChild(ul),setTimeout(()=>{initActiveToc(),addEventListener()},0);function addEventListener(){document.getElementById('toc-hidden').onclick=function(c){let a=c||window.event,b=a.target||a.srcElement;b.nodeName.toLowerCase()=='a'&&setTimeout(()=>{changeTocActive(b.parentNode)},0)},window.onscroll=function(a){initActiveToc()}}function initActiveToc(){let a=getBoundingClientNode('h2'),b=getBoundingClientNode('h3'),c=a.currentNode||b.currentNode;if(a.currentNode&&b.currentNode&&(c=Math.abs(a.y)<Math.abs(b.y)?a.currentNode:b.currentNode),!c)return;changeTocActive(c)}function changeTocActive(c){let d=c.getAttribute('id')||c.getAttribute('text')?.replace('#',''),a=document.getElementsByClassName('li1-item'),b=document.getElementsByClassName('li2-item');for(let b=0;b<a.length;b++){let c=a[b].getAttribute('text')||'';c.replace('#','')==d?a[b].classList.add('active'):a[b].classList.remove('active')}for(let a=0;a<b.length;a++){let c=b[a].getAttribute('text')||'';c.replace('#','')==d?b[a].classList.add('active'):b[a].classList.remove('active')}}function getBoundingClientNode(c){let a={nodes:[],currentNode:null,index:-1,y:0},b=Array.from(document.getElementsByTagName(c));a.nodes=b;for(let c=0;c<b.length;c++){let d=b[c].getBoundingClientRect();if(d.y<=0&&(a.y=d.y,a.currentNode=b[c],a.index=c),d.y>0&&d.y<window.innerHeight){a.y=d.y,a.currentNode=b[c],a.index=c;break}}return a}function createList(a){let b=createNode('ul');return a.map((c,i)=>{let f=['li1-item'],g=['li1-item-topborder'];i!==0&&g.push('show');let h=['li1-item-bottomborder'];i!==a.length-1?h.push('show'):f.push('no-border');let e=createNode('li',{classList:f,text:c.href}),j=createNode('a',{href:c.href,innerHTML:c.text}),d=createNode('div',{classList:['li1-item-style']}),k=createNode('div',{classList:g}),l=createNode('div',{classList:h}),m=createNode('div',{classList:['mask-line']}),n=createNode('div',{classList:['li1-item-style-dotted']});if(d.appendChild(k),d.appendChild(l),d.appendChild(m),d.appendChild(n),e.appendChild(j),e.appendChild(d),c.ul.length){let a=createNode('ul');c.ul.map((b,f)=>{let c=createNode('li',{classList:['li2-item'],text:b.href}),d=createNode('a',{href:b.href,innerHTML:b.text}),e=createNode('div',{classList:['li2-item-style']});c.appendChild(d),c.appendChild(e),a.appendChild(c)}),e.appendChild(a)}b.appendChild(e)}),b}function createNode(g,f={}){let a=document.createElement(g);const{classList:c,innerHTML:d,href:e,text:b}=f;return c&&c.map(b=>{a.classList.add(b)}),d&&(a.innerHTML=d),e&&(a.href=e),b&&a.setAttribute('text',b),a}function clectionLis1(){let b=[],a=document.getElementById('TableOfContents')?.firstElementChild||{children:[]};for(let c=0;c<a.children.length;c++){let e=a.children[c].firstElementChild,g=a.children[c].lastChild,d=a.children[c].children[1]||'',f={text:e.innerHTML,href:e.getAttribute('href'),ul:[]};if(d)for(let a=0;a<d.children.length;a++){let b=d.children[a].firstElementChild;f.ul.push({text:b.innerHTML,href:b.getAttribute('href')})}b.push(f)}return b}</script></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=https://www.cloudpods.org/zh/blog/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>使用Linux vfio将Nvidia GPU透传给QEMU虚拟机</h1><div class="td-byline mb-4"><time datetime=2021-06-07 class=text-muted>07.06.2021</time></div><p><strong>作者:</strong> 李泽玺</p><p>Linux 上虚拟机 GPU 透传需要使用 vfio 的方式。主要是因为在 vfio 方式下对虚拟设备的权限和 DMA 隔离上做的更好。但是这么做也有个缺点，这个物理设备在主机和其他虚拟机都不能使用了。</p><p>qemu 直接使用物理设备本身命令行是很简单的，关键在于事先在主机上对系统、内核和物理设备的一些配置。</p><p>单纯从 qemu 的命令行来看，其实和普通虚拟机启动就差了最后那个 <code>-device</code> 的选项。这个选项也比较容易理解，就是把主机上的设备 0000:00:01.0 传给了虚拟机使用。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ qemu-system-x86_64 -m <span style=color:#0000cf;font-weight:700>4096</span> -smp <span style=color:#0000cf;font-weight:700>4</span> --enable-kvm <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  -drive <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>~/guest/fedora.img <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  -device vfio-pci,host<span style=color:#ce5c00;font-weight:700>=</span>0000:00:01.0
</code></pre></div><h2 id=系统及硬件准备>系统及硬件准备</h2><h3 id=bios中打开iommu>BIOS中打开IOMMU</h3><p>设备直通在 x86 平台上需要打开 iommu 功能。这是 Intel 虚拟技术 VT-d(Virtualization Technology for Device IO) 中的一个部分。有时候这部分的功能没有被打开。</p><p>打开的方式在 BIOS 设置中 Security->Virtualization->VT-d 这个位置。当然不同的 BIOS 位置可能会略有不同。记得在使用直通设备前要将这个选项打开。</p><h3 id=内核配置勾选iommu>内核配置勾选IOMMU</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>INTEL_IOMMU
│ Location: │
│ -&gt; Device Drivers │
│ <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> -&gt; IOMMU Hardware Support <span style=color:#ce5c00;font-weight:700>(</span>IOMMU_SUPPORT <span style=color:#ce5c00;font-weight:700>[=</span>y<span style=color:#ce5c00;font-weight:700>])</span>
</code></pre></div><h3 id=内核启动参数enable-iommu>内核启动参数enable IOMMU</h3><p>BIOS 中打开，内核编译选项勾选还不够。还需要在引导程序中添加上内核启动参数</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 对应编辑 /etc/default/grub, 设置 GRUB_CMDLINE_LINUX=</span>
$ cat /etc/default/grub
...
<span style=color:#000>GRUB_CMDLINE_LINUX</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;intel_iommu=on iommu=pt vfio_iommu_type1.allow_unsafe_interrupts=1 rdblacklist=nouveau nouveau.modeset=0&#34;</span>
...
 
<span style=color:#8f5902;font-style:italic># 重新生成 grub 引导配置文件</span>
$ grub2-mkconfig -o /boot/grub2/grub.cfg
 
<span style=color:#8f5902;font-style:italic># 将vfio相关 module 设置为开机load</span>
$ cat /etc/modules-load.d/vfio.conf
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
</code></pre></div><p><a href=https://wiki.archlinux.org/index.php/PCI_passthrough_via_OVMF#Setting_up_IOMMU>Setting up IOMMU</a>
<a href=https://wiki.archlinux.org/index.php/Kernel_parameters>Kernel parameters</a></p><h3 id=找到-nvidia-gpu-busid>找到 nvidia GPU BusID</h3><p>record PCI addresses and hardware IDs of the GPU</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ lspci -k <span style=color:#000;font-weight:700>|</span> grep -i nvidia -A <span style=color:#0000cf;font-weight:700>3</span>                   
41:00.0 VGA compatible controller: NVIDIA Corporation GP107 <span style=color:#ce5c00;font-weight:700>[</span>GeForce GTX <span style=color:#0000cf;font-weight:700>1050</span> Ti<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
        Subsystem: Device 1b4c:11bf
        Kernel driver in use: vfio-pci
        Kernel modules: nouveau
41:00.1 Audio device: NVIDIA Corporation GP107GL High Definition Audio Controller <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
        Subsystem: Device 1b4c:11bf
        Kernel driver in use: snd_hda_intel
        Kernel modules: snd_hda_intel
<span style=color:#8f5902;font-style:italic># pci address =&gt; 41:00.0,41:00.1</span>
<span style=color:#8f5902;font-style:italic># device id =&gt; 1b4c:11bf</span>
 
<span style=color:#8f5902;font-style:italic># 这里找到了两张 nvidia 卡，它们的 device id 都是 1b4c:11bf, 一张是 Audio device</span>
<span style=color:#8f5902;font-style:italic># 这样是不能 passthrough 进去的，因为:</span>
<span style=color:#8f5902;font-style:italic># vfio-pci use your vendor and device id pair to identify which device they need to bind to at boot,</span>
<span style=color:#8f5902;font-style:italic># if you have two GPUs sharing such an ID pair you will not be able to get your passthough driver to bind with just one of them</span>
<span style=color:#8f5902;font-style:italic># 使用下面的脚本解决这种情况：</span>
 
$ cat /usr/bin/vfio-pci-override.sh
<span style=color:#8f5902;font-style:italic>#!/bin/sh</span>
 
<span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#204a87;font-weight:700>$(</span>find /sys/devices/pci* -name boot_vga<span style=color:#204a87;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> <span style=color:#204a87;font-weight:700>$(</span>cat <span style=color:#4e9a06>&#34;</span><span style=color:#000>$i</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>)</span> -eq <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
        <span style=color:#000>GPU</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>%/boot_vga</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
        <span style=color:#000>AUDIO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;</span><span style=color:#204a87;font-weight:700>$(</span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$GPU</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> sed -e <span style=color:#4e9a06>&#34;s/0</span>$<span style=color:#4e9a06>/1/&#34;</span><span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
        <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;vfio-pci&#34;</span> &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#000>$GPU</span><span style=color:#4e9a06>/driver_override&#34;</span>
        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> -d <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AUDIO</span><span style=color:#4e9a06>&#34;</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;vfio-pci&#34;</span> &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#000>$AUDIO</span><span style=color:#4e9a06>/driver_override&#34;</span>
        <span style=color:#204a87;font-weight:700>fi</span>
    <span style=color:#204a87;font-weight:700>fi</span>
<span style=color:#204a87;font-weight:700>done</span>
 
modprobe -i vfio-pci
 
<span style=color:#8f5902;font-style:italic># 把脚本传入 /etc/modprobe.d/vfio.conf</span>
$ cat /etc/modprobe.d/vfio.conf
install vfio-pci /usr/bin/vfio-pci-override.sh
options vfio-pci <span style=color:#000>ids</span><span style=color:#ce5c00;font-weight:700>=</span>10de:1c82 <span style=color:#000>disable_vga</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><h3 id=使用-vfio-管理-gpu>使用 vfio 管理 GPU</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># /etc/modprobe.d/vfio.conf, ids 为 lspci 找到的 hardware id, 多个设备的话用&#39;,&#39;分割</span>
$ cat /etc/modprobe.d/vfio.conf
options vfio-pci <span style=color:#000>ids</span><span style=color:#ce5c00;font-weight:700>=</span>10de:134d <span style=color:#000>disable_vga</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
 
<span style=color:#8f5902;font-style:italic># 禁用NVIDIA nouveau 开源驱动, /etc/modprobe.d/blacklist.conf</span>
$ cat /etc/modprobe.d/blacklist.conf
blacklist nouveau
 
<span style=color:#8f5902;font-style:italic># kvm 模块配置, /etc/modprobe.d/kvm.conf</span>
$ cat /etc/modprobe.d/kvm.conf
options kvm <span style=color:#000>ignore_msrs</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
</code></pre></div><p>重启系统，启动完成后查看当前的 nvidia GPU 是否被 vfio-pci 模块使用, 确认IOMMU功能确实打开。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dmesg <span style=color:#000;font-weight:700>|</span> grep -e DMAR -e IOMMU <span style=color:#000;font-weight:700>|</span> grep enabled
 
<span style=color:#8f5902;font-style:italic># 如果能搜索到</span>
DMAR: IOMMU enabled
<span style=color:#8f5902;font-style:italic># 表示上述配置成功。</span>
 
<span style=color:#8f5902;font-style:italic># 查看 GPU 是否被 vfio-pci 使用</span>
<span style=color:#8f5902;font-style:italic># 另外注意检查看看 41:00.1 Audio device 是否也被 vfio-pci 使用</span>
$ lspci -k <span style=color:#000;font-weight:700>|</span> grep -i -e nvidia -A <span style=color:#0000cf;font-weight:700>3</span>
41:00.0 VGA compatible controller: NVIDIA Corporation GP107 <span style=color:#ce5c00;font-weight:700>[</span>GeForce GTX <span style=color:#0000cf;font-weight:700>1050</span> Ti<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
    Subsystem: Device 1b4c:11bf
    Kernel driver in use: vfio-pci <span style=color:#8f5902;font-style:italic># GTX 1050 Ti GPU 被 vfio-pci 使用</span>
    Kernel modules: nouveau
41:00.1 Audio device: NVIDIA Corporation GP107GL High Definition Audio Controller <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
    Subsystem: Device 1b4c:11bf
    Kernel driver in use: vfio-pci <span style=color:#8f5902;font-style:italic># 发现 Audio device 也被 vfio-pci 使用了</span>
    Kernel modules: snd_hda_intel
...
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># list GPU IOMMU group</span>
$ find /sys/kernel/iommu_groups/ -type l <span style=color:#000;font-weight:700>|</span> grep 41:00
/sys/kernel/iommu_groups/27/devices/0000:41:00.0
/sys/kernel/iommu_groups/27/devices/0000:41:00.1
 
<span style=color:#8f5902;font-style:italic># 找到IOMMU Group 管理的 PCI 设备</span>
<span style=color:#8f5902;font-style:italic>#!/bin/bash</span>
<span style=color:#204a87>shopt</span> -s nullglob
<span style=color:#204a87;font-weight:700>for</span> d in /sys/kernel/iommu_groups/*/devices/*<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span>
  <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>#*/iommu_groups/*</span><span style=color:#4e9a06>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>n</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>n</span><span style=color:#000;font-weight:700>%%/*</span><span style=color:#4e9a06>}</span>
  <span style=color:#204a87>printf</span> <span style=color:#4e9a06>&#39;IOMMU Group %s &#39;</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$n</span><span style=color:#4e9a06>&#34;</span>
  lspci -nns <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>d</span><span style=color:#000;font-weight:700>##*/</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
<span style=color:#204a87;font-weight:700>done</span>
</code></pre></div><h3 id=使用-qemu-透传-nvidia-gpu>使用 qemu 透传 nvidia GPU</h3><p>准备好centos7镜像，然后在虚拟机里面安装 nvidia 官方闭源驱动和 cuda SDK</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 我从服务器上拷贝过来的是 vmdk 的镜像，先把它转换成 qcow2 的格式</span>
$ /usr/local/qemu-2.9.0/bin/qemu-img convert -f vmdk -O qcow2 centos-7.3.1611-20180104.vmdk centos-7.3.1611-20180104.qcow2
 
<span style=color:#8f5902;font-style:italic># 使用 qemu 启动，注意-cpu 需要 kvm=off 参数</span>
<span style=color:#8f5902;font-style:italic># kvm=off will hide the kvm hypervisor signature, this is required for NVIDIA cards</span>
<span style=color:#8f5902;font-style:italic># since its driver will refuse to work on an hypervisor and result in Code 43 on windows</span>
$ cat startvm.sh
<span style=color:#8f5902;font-style:italic>#!/bin/sh</span>
/usr/local/qemu-2.9.0/bin/qemu-system-x86_64 -enable-kvm <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>-m <span style=color:#0000cf;font-weight:700>4096</span> -cpu host,kvm<span style=color:#ce5c00;font-weight:700>=</span>off -smp 4,sockets<span style=color:#ce5c00;font-weight:700>=</span>1,cores<span style=color:#ce5c00;font-weight:700>=</span>4,threads<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>-drive <span style=color:#000>file</span><span style=color:#ce5c00;font-weight:700>=</span>./centos-7.3.1611-20180104.qcow2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>-device vfio-pci,host<span style=color:#ce5c00;font-weight:700>=</span>41:00.0,multifunction<span style=color:#ce5c00;font-weight:700>=</span>on,addr<span style=color:#ce5c00;font-weight:700>=</span>0x16 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>-device vfio-pci,host<span style=color:#ce5c00;font-weight:700>=</span>41:00.1 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>-net nic,model<span style=color:#ce5c00;font-weight:700>=</span>e1000 -net user,hostfwd<span style=color:#ce5c00;font-weight:700>=</span>tcp::5022-:22 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>-vnc :1
 
<span style=color:#8f5902;font-style:italic># 这台虚拟机开了vnc和ssh 端口转发，可以使用vnc或者ssh访问</span>
 
<span style=color:#8f5902;font-style:italic># 从host进入虚拟机</span>
$ ssh 127.0.0.1 -p <span style=color:#0000cf;font-weight:700>5022</span>
 
<span style=color:#8f5902;font-style:italic># 查看虚拟机透传进来的显卡</span>
$ lspci -k <span style=color:#000;font-weight:700>|</span> grep -i nvidia -A <span style=color:#0000cf;font-weight:700>3</span>
00:04.0 Audio device: NVIDIA Corporation Device 0fb9 <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
    Subsystem: Device 1b4c:11bf
    Kernel driver in use: snd_hda_intel
    Kernel modules: snd_hda_intel
00:16.0 VGA compatible controller: NVIDIA Corporation GP107 <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
    Subsystem: Device 1b4c:11bf
    Kernel modules: nouveau
</code></pre></div><h2 id=安装nvidia-驱动和-cuda>安装nvidia 驱动和 Cuda</h2><p>nvidia 驱动需要从官方下载，如果先安装 cuda 的话会一同安装 nvidia 驱动。
接下来采用虚拟机先安装驱动再安装 cuda 的步骤。</p><p>参考：
<a href=http://www.advancedclustering.com/act_kb/installing-nvidia-drivers-rhel-centos-7/>installing-nvidia-drivers-centos-7</a>
<a href=https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html>NVIDIA CUDA GETTINGS STARTED GUIDE FOR LINUX</a></p><h3 id=安装-nvidia-驱动>安装 nvidia 驱动</h3><p>下载地址：http://www.nvidia.com/object/unix.html</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># update 后如果更新内核，需要重启</span>
$ yum -y update
 
<span style=color:#8f5902;font-style:italic># 安装 gcc、make、glibc等工具和库</span>
$ yum -y groupinstall <span style=color:#4e9a06>&#34;Development Tools&#34;</span>
$ yum -y install kernel-devel
 
<span style=color:#8f5902;font-style:italic># Download the latest NVIDIA driver for unix.</span>
$ wget http://us.download.nvidia.com/XFree86/Linux-x86_64/390.42/NVIDIA-Linux-x86_64-390.42.run
$ yum -y install epel-release
$ yum -y install dkms
 
<span style=color:#8f5902;font-style:italic># Edit /etc/default/grub. Append the following  to “GRUB_CMDLINE_LINUX”</span>
rd.driver.blacklist<span style=color:#ce5c00;font-weight:700>=</span>nouveau nouveau.modeset<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
 
<span style=color:#8f5902;font-style:italic># Generate a new grub configuration to include the above changes.</span>
$ grub2-mkconfig -o /boot/grub2/grub.cfg
 
<span style=color:#8f5902;font-style:italic># Edit/create /etc/modprobe.d/blacklist.conf and append:</span>
blacklist nouveau
 
<span style=color:#8f5902;font-style:italic># Backup your old initramfs and then build a new one</span>
$ mv /boot/initramfs-<span style=color:#204a87;font-weight:700>$(</span>uname -r<span style=color:#204a87;font-weight:700>)</span>.img /boot/initramfs-<span style=color:#204a87;font-weight:700>$(</span>uname -r<span style=color:#204a87;font-weight:700>)</span>-nouveau.img
$ dracut /boot/initramfs-<span style=color:#204a87;font-weight:700>$(</span>uname -r<span style=color:#204a87;font-weight:700>)</span>.img <span style=color:#204a87;font-weight:700>$(</span>uname -r<span style=color:#204a87;font-weight:700>)</span>
 
<span style=color:#8f5902;font-style:italic># 重启again</span>
 
<span style=color:#8f5902;font-style:italic># Run the NVIDIA driver installer and enter yes to all options.</span>
$ sh NVIDIA-Linux-x86_64-*.run
 
<span style=color:#8f5902;font-style:italic># 装好后再一次重启，lspci -k 看下gpu使用的驱动是否是nvidia</span>
$ lspci -k <span style=color:#000;font-weight:700>|</span> grep -i nvidia -A <span style=color:#0000cf;font-weight:700>3</span>
00:04.0 Audio device: NVIDIA Corporation GP107GL High Definition Audio Controller <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
00:16.0 VGA compatible controller: NVIDIA Corporation GP107 <span style=color:#ce5c00;font-weight:700>[</span>GeForce GTX <span style=color:#0000cf;font-weight:700>1050</span> Ti<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span>rev a1<span style=color:#ce5c00;font-weight:700>)</span>
    Kernel driver in use: nvidia <span style=color:#8f5902;font-style:italic># 发现已经使用nvidia驱动</span>
    Kernel modules: nouveau, nvidia_drm, nvidia
 
<span style=color:#8f5902;font-style:italic># 执行 nvidia-smi 看下输出和温度</span>
$ nvidia-smi
Thu Mar <span style=color:#0000cf;font-weight:700>15</span> 01:31:09 <span style=color:#0000cf;font-weight:700>2018</span>      
+-----------------------------------------------------------------------------+
<span style=color:#000;font-weight:700>|</span> NVIDIA-SMI 390.42                 Driver Version: 390.42                    <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>-------------------------------+----------------------+----------------------+
<span style=color:#000;font-weight:700>|</span> GPU  Name        Persistence-M<span style=color:#000;font-weight:700>|</span> Bus-Id        Disp.A <span style=color:#000;font-weight:700>|</span> Volatile Uncorr. ECC <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span> Fan  Temp  Perf  Pwr:Usage/Cap<span style=color:#000;font-weight:700>|</span>         Memory-Usage <span style=color:#000;font-weight:700>|</span> GPU-Util  Compute M. <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span><span style=color:#ce5c00;font-weight:700>===============================</span>+<span style=color:#ce5c00;font-weight:700>======================</span>+<span style=color:#ce5c00;font-weight:700>======================</span><span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>   <span style=color:#0000cf;font-weight:700>0</span>  GeForce GTX 105...  Off  <span style=color:#000;font-weight:700>|</span> 00000000:00:16.0 Off <span style=color:#000;font-weight:700>|</span>                  N/A <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span> 40%   32C    P0    N/A / 100W <span style=color:#000;font-weight:700>|</span>      0MiB /  4040MiB <span style=color:#000;font-weight:700>|</span>      0%      Default <span style=color:#000;font-weight:700>|</span>
+-------------------------------+----------------------+----------------------+
 
+-----------------------------------------------------------------------------+
<span style=color:#000;font-weight:700>|</span> Processes:                                                       GPU Memory <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  GPU       PID   Type   Process name                             Usage      <span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span><span style=color:#ce5c00;font-weight:700>=============================================================================</span><span style=color:#000;font-weight:700>|</span>
<span style=color:#000;font-weight:700>|</span>  No running processes found                                                 <span style=color:#000;font-weight:700>|</span>
+-----------------------------------------------------------------------------+
 
$ nvidia-smi -q -d <span style=color:#000>TEMPERATURE</span>
 
<span style=color:#ce5c00;font-weight:700>==============</span>NVSMI <span style=color:#000>LOG</span><span style=color:#ce5c00;font-weight:700>==============</span>
 
Timestamp                           : Thu Mar <span style=color:#0000cf;font-weight:700>15</span> 01:32:42 <span style=color:#0000cf;font-weight:700>2018</span>
Driver Version                      : 390.42
 
Attached GPUs                       : <span style=color:#0000cf;font-weight:700>1</span>
GPU 00000000:00:16.0
    Temperature
        GPU Current Temp            : <span style=color:#0000cf;font-weight:700>32</span> C
        GPU Shutdown Temp           : <span style=color:#0000cf;font-weight:700>102</span> C
        GPU Slowdown Temp           : <span style=color:#0000cf;font-weight:700>99</span> C
        GPU Max Operating Temp      : N/A
        Memory Current Temp         : N/A
        Memory Max Operating Temp   : N/A
</code></pre></div><h3 id=安装-cuda>安装 cuda</h3><p>下载地址： <a href=https://developer.nvidia.com/cuda-downloads>https://developer.nvidia.com/cuda-downloads</a>
这里选择 runfile，以后为了方便也可以选择 rpm(network)的方式，会自动帮我们安装 nvidia 驱动</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ wget https://developer.nvidia.com/compute/cuda/9.1/Prod/local_installers/cuda_9.1.85_387.26_linux
 
<span style=color:#8f5902;font-style:italic># Say no to installing the NVIDIA driver.</span>
<span style=color:#8f5902;font-style:italic># The standalone driver you already installed is typically newer than what is packaged with CUDA.</span>
<span style=color:#8f5902;font-style:italic># Use the default option for all other choices.</span>
$ sh cuda_*.run
 
<span style=color:#8f5902;font-style:italic># 添加 CUDA 相关的环境变量</span>
<span style=color:#204a87>export</span> <span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$PATH</span>:/usr/local/cuda/bin
<span style=color:#204a87>export</span> <span style=color:#000>LD_LIBRARY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span>/usr/local/cuda/lib64:<span style=color:#000>$LD_LIBRARY_PATH</span>
 
<span style=color:#8f5902;font-style:italic># make samples</span>
$ <span style=color:#204a87>cd</span> ~/NVIDIA_CUDA-9.1_Samples<span style=color:#000;font-weight:700>;</span> make -j <span style=color:#0000cf;font-weight:700>4</span>
$ <span style=color:#204a87>cd</span> bin/x86_64/linux/release
$ ./deviceQuery <span style=color:#8f5902;font-style:italic># 查询gpu信息</span>
./deviceQuery Starting...
 
 CUDA Device Query <span style=color:#ce5c00;font-weight:700>(</span>Runtime API<span style=color:#ce5c00;font-weight:700>)</span> version <span style=color:#ce5c00;font-weight:700>(</span>CUDART static linking<span style=color:#ce5c00;font-weight:700>)</span>
 
Detected <span style=color:#0000cf;font-weight:700>1</span> CUDA Capable device<span style=color:#ce5c00;font-weight:700>(</span>s<span style=color:#ce5c00;font-weight:700>)</span>
 
Device 0: <span style=color:#4e9a06>&#34;GeForce GTX 1050 Ti&#34;</span>
  CUDA Driver Version / Runtime Version          9.1 / 9.1
  CUDA Capability Major/Minor version number:    6.1
  Total amount of global memory:                 <span style=color:#0000cf;font-weight:700>4040</span> MBytes <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4236312576</span> bytes<span style=color:#ce5c00;font-weight:700>)</span>
  <span style=color:#ce5c00;font-weight:700>(</span> 6<span style=color:#ce5c00;font-weight:700>)</span> Multiprocessors, <span style=color:#ce5c00;font-weight:700>(</span>128<span style=color:#ce5c00;font-weight:700>)</span> CUDA Cores/MP:     <span style=color:#0000cf;font-weight:700>768</span> CUDA Cores
  GPU Max Clock rate:                            <span style=color:#0000cf;font-weight:700>1481</span> MHz <span style=color:#ce5c00;font-weight:700>(</span>1.48 GHz<span style=color:#ce5c00;font-weight:700>)</span>
  Memory Clock rate:                             <span style=color:#0000cf;font-weight:700>3504</span> Mhz
  Memory Bus Width:                              128-bit
  L2 Cache Size:                                 <span style=color:#0000cf;font-weight:700>1048576</span> bytes
...
 
$ ./bandwidtTest <span style=color:#8f5902;font-style:italic># 使用 cuda 测试gpu bandwidth</span>
Running on...
 
 Device 0: GeForce GTX <span style=color:#0000cf;font-weight:700>1050</span> Ti
 Quick Mode
 
 Host to Device Bandwidth, <span style=color:#0000cf;font-weight:700>1</span> Device<span style=color:#ce5c00;font-weight:700>(</span>s<span style=color:#ce5c00;font-weight:700>)</span>
 PINNED Memory Transfers
   Transfer Size <span style=color:#ce5c00;font-weight:700>(</span>Bytes<span style=color:#ce5c00;font-weight:700>)</span>    Bandwidth<span style=color:#ce5c00;font-weight:700>(</span>MB/s<span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#0000cf;font-weight:700>33554432</span>            9719.0
 
 Device to Host Bandwidth, <span style=color:#0000cf;font-weight:700>1</span> Device<span style=color:#ce5c00;font-weight:700>(</span>s<span style=color:#ce5c00;font-weight:700>)</span>
 PINNED Memory Transfers
   Transfer Size <span style=color:#ce5c00;font-weight:700>(</span>Bytes<span style=color:#ce5c00;font-weight:700>)</span>    Bandwidth<span style=color:#ce5c00;font-weight:700>(</span>MB/s<span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#0000cf;font-weight:700>33554432</span>            9215.8
 
 Device to Device Bandwidth, <span style=color:#0000cf;font-weight:700>1</span> Device<span style=color:#ce5c00;font-weight:700>(</span>s<span style=color:#ce5c00;font-weight:700>)</span>
 PINNED Memory Transfers
   Transfer Size <span style=color:#ce5c00;font-weight:700>(</span>Bytes<span style=color:#ce5c00;font-weight:700>)</span>    Bandwidth<span style=color:#ce5c00;font-weight:700>(</span>MB/s<span style=color:#ce5c00;font-weight:700>)</span>
   <span style=color:#0000cf;font-weight:700>33554432</span>            95525.1
 
<span style=color:#000>Result</span> <span style=color:#ce5c00;font-weight:700>=</span> PASS
 
NOTE: The CUDA Samples are not meant <span style=color:#204a87;font-weight:700>for</span> performance measurements. Results may vary when GPU Boost is enabled.
</code></pre></div><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/zh/blog/2021/05/31/cloudpods-3.7-new-feature-introduction/ class="btn btn-primary"><span class=mr-1>←</span> 上一页</a></li><a href=/zh/blog/2021/06/25/cgroups-kubernetes-pid-limits/ class="btn btn-primary">下一页 <span class=ml-1>→</span></a></li></ul></div></main></div></div><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?3c5253cd6530122d0f774cab69e3c07f",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script><footer class="bg-dark pt-4 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>Copyright &copy; 2017-2023 The Cloudpods Authors.</small>
<a href=https://beian.miit.gov.cn/ style=text-decoration:none;color:inherit;display:block class=text-white>京ICP备2021005745号-3</a></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.97bb03aa99e8cdba0d042be465704afbbf612fb5b518003fe3cb7df2f0d43362.js integrity="sha256-l7sDqpnozboNBCvkZXBK+79hL7W1GAA/48t98vDUM2I=" crossorigin=anonymous></script></body></html>