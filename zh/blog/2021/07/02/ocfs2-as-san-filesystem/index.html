<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.120.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>QEMU+OCFS2: 使用OCFS2作为虚拟机磁盘文件的SAN存储文件系统
</title><meta property="og:title" content="QEMU+OCFS2: 使用OCFS2作为虚拟机磁盘文件的SAN存储文件系统"><meta property="og:description" content="作者: 小助手
本文介绍OCFS2共享集群文件系统，如何配置以及如何在线扩容。
什么是OCFS2文件系统？ OCFS2是 Oracle Cluster File System Version 2 的缩写，是Oracle公司内部开发的共享磁盘文件系统，于2011年开源，使用GNU GPL协议。
什么是共享磁盘文件系统呢？我们下面通过解释三个概念的对比来说明：
磁盘文件系统 这是最常见的文件系统，构建在本地的磁盘（块存储，Block Storage）之上。通过磁盘文件系统，磁盘上的内容以文件目录的形式进行组织，方便了用户有效使用磁盘上的存储空间。磁盘文件系统的例子有：ext4, xfs等。
共享文件系统 共享文件系统通过远端服务器上运行的服务程序访问挂载在远端服务器上的文件系统。例子为：NFS（Network File System），Samba（CIFS）。
共享磁盘文件系统 共享磁盘文件系统又叫集群文件系统（Cluster File System），是专门构建在网络共享的磁盘上的文件系统。网络共享磁盘通过SAN（Storage Area Network）被多台主机共同访问，和磁盘文件系统相比，共享磁盘文件系统除了要解决磁盘空间的有效管理问题之外，还要解决文件系统被多台主机同时访问的并发修改问题。因此分布式锁机制是共享磁盘文件系统共有的机制。
从使用场景来看，三种文件系统的差别很明显：磁盘文件系统直接访问本地磁盘，共享文件系统需要通过共享文件服务访问挂载在服务器上的文件系统，而共享磁盘文件系统则直接访问共享磁盘。
因此，在网络共享的场景下，通过共享磁盘文件系统访问SAN存储，可以直接访问共享存储设备。访问路径短，效率高，并且能解决多主机并发访问共享存储的问题。
QEMU通过OCFS2使用共享SAN存储 QEMU使用共享SAN存储有多种方案。常见方案是在需要新建虚拟机磁盘时，使用SAN存储的管理API，分配出卷（LUN）之后，直接将卷挂载给QEMU虚拟机使用。这种方案的优点是QEMU虚拟机直接访问LUN，损耗低，性能好。而缺点是需要使用存储设备特定的API，和设备绑定，不够通用。
本文介绍通过OCFS2共享磁盘文件系统，将一个大容量的SAN存储卷作为存储QEMU虚拟机虚拟磁盘文件的存储，达到QEMU使用共享储存的目的。
OCFS2文件系统的配置 准备环境 这一步安装和配置软件
下载和安装ocfs2-tools的rpm包安装（也依赖net-tools） $ wget http://public-yum.oracle.com/public-yum-ol7.repo -O /etc/yum.repos.d/public-yum-ol7.repo $ rpm --import http://public-yum.oracle.com/RPM-GPG-KEY-oracle-ol7 $ yum install yum-plugin-downloadonly -y $ mkdir /tmp/ocfs2 && cd /tmp/ocfs2/ $ yum install --downloadonly --downloaddir=/tmp/ocfs2/ ocfs2-tools net-tools -y 具体操作步骤见官方文档：https://docs.oracle.com/cd/E52668_01/E54669/E54669.pdf, Chapter 23 Oracle Cluster File System Version 2"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cloudpods.org/zh/blog/2021/07/02/ocfs2-as-san-filesystem/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-07-02T00:00:00+00:00"><meta property="article:modified_time" content="2021-07-02T00:00:00+00:00"><meta itemprop=name content="QEMU+OCFS2: 使用OCFS2作为虚拟机磁盘文件的SAN存储文件系统"><meta itemprop=description content="作者: 小助手
本文介绍OCFS2共享集群文件系统，如何配置以及如何在线扩容。
什么是OCFS2文件系统？ OCFS2是 Oracle Cluster File System Version 2 的缩写，是Oracle公司内部开发的共享磁盘文件系统，于2011年开源，使用GNU GPL协议。
什么是共享磁盘文件系统呢？我们下面通过解释三个概念的对比来说明：
磁盘文件系统 这是最常见的文件系统，构建在本地的磁盘（块存储，Block Storage）之上。通过磁盘文件系统，磁盘上的内容以文件目录的形式进行组织，方便了用户有效使用磁盘上的存储空间。磁盘文件系统的例子有：ext4, xfs等。
共享文件系统 共享文件系统通过远端服务器上运行的服务程序访问挂载在远端服务器上的文件系统。例子为：NFS（Network File System），Samba（CIFS）。
共享磁盘文件系统 共享磁盘文件系统又叫集群文件系统（Cluster File System），是专门构建在网络共享的磁盘上的文件系统。网络共享磁盘通过SAN（Storage Area Network）被多台主机共同访问，和磁盘文件系统相比，共享磁盘文件系统除了要解决磁盘空间的有效管理问题之外，还要解决文件系统被多台主机同时访问的并发修改问题。因此分布式锁机制是共享磁盘文件系统共有的机制。
从使用场景来看，三种文件系统的差别很明显：磁盘文件系统直接访问本地磁盘，共享文件系统需要通过共享文件服务访问挂载在服务器上的文件系统，而共享磁盘文件系统则直接访问共享磁盘。
因此，在网络共享的场景下，通过共享磁盘文件系统访问SAN存储，可以直接访问共享存储设备。访问路径短，效率高，并且能解决多主机并发访问共享存储的问题。
QEMU通过OCFS2使用共享SAN存储 QEMU使用共享SAN存储有多种方案。常见方案是在需要新建虚拟机磁盘时，使用SAN存储的管理API，分配出卷（LUN）之后，直接将卷挂载给QEMU虚拟机使用。这种方案的优点是QEMU虚拟机直接访问LUN，损耗低，性能好。而缺点是需要使用存储设备特定的API，和设备绑定，不够通用。
本文介绍通过OCFS2共享磁盘文件系统，将一个大容量的SAN存储卷作为存储QEMU虚拟机虚拟磁盘文件的存储，达到QEMU使用共享储存的目的。
OCFS2文件系统的配置 准备环境 这一步安装和配置软件
下载和安装ocfs2-tools的rpm包安装（也依赖net-tools） $ wget http://public-yum.oracle.com/public-yum-ol7.repo -O /etc/yum.repos.d/public-yum-ol7.repo $ rpm --import http://public-yum.oracle.com/RPM-GPG-KEY-oracle-ol7 $ yum install yum-plugin-downloadonly -y $ mkdir /tmp/ocfs2 && cd /tmp/ocfs2/ $ yum install --downloadonly --downloaddir=/tmp/ocfs2/ ocfs2-tools net-tools -y 具体操作步骤见官方文档：https://docs.oracle.com/cd/E52668_01/E54669/E54669.pdf, Chapter 23 Oracle Cluster File System Version 2"><meta itemprop=datePublished content="2021-07-02T00:00:00+00:00"><meta itemprop=dateModified content="2021-07-02T00:00:00+00:00"><meta itemprop=wordCount content="635"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="QEMU+OCFS2: 使用OCFS2作为虚拟机磁盘文件的SAN存储文件系统"><meta name=twitter:description content="作者: 小助手
本文介绍OCFS2共享集群文件系统，如何配置以及如何在线扩容。
什么是OCFS2文件系统？ OCFS2是 Oracle Cluster File System Version 2 的缩写，是Oracle公司内部开发的共享磁盘文件系统，于2011年开源，使用GNU GPL协议。
什么是共享磁盘文件系统呢？我们下面通过解释三个概念的对比来说明：
磁盘文件系统 这是最常见的文件系统，构建在本地的磁盘（块存储，Block Storage）之上。通过磁盘文件系统，磁盘上的内容以文件目录的形式进行组织，方便了用户有效使用磁盘上的存储空间。磁盘文件系统的例子有：ext4, xfs等。
共享文件系统 共享文件系统通过远端服务器上运行的服务程序访问挂载在远端服务器上的文件系统。例子为：NFS（Network File System），Samba（CIFS）。
共享磁盘文件系统 共享磁盘文件系统又叫集群文件系统（Cluster File System），是专门构建在网络共享的磁盘上的文件系统。网络共享磁盘通过SAN（Storage Area Network）被多台主机共同访问，和磁盘文件系统相比，共享磁盘文件系统除了要解决磁盘空间的有效管理问题之外，还要解决文件系统被多台主机同时访问的并发修改问题。因此分布式锁机制是共享磁盘文件系统共有的机制。
从使用场景来看，三种文件系统的差别很明显：磁盘文件系统直接访问本地磁盘，共享文件系统需要通过共享文件服务访问挂载在服务器上的文件系统，而共享磁盘文件系统则直接访问共享磁盘。
因此，在网络共享的场景下，通过共享磁盘文件系统访问SAN存储，可以直接访问共享存储设备。访问路径短，效率高，并且能解决多主机并发访问共享存储的问题。
QEMU通过OCFS2使用共享SAN存储 QEMU使用共享SAN存储有多种方案。常见方案是在需要新建虚拟机磁盘时，使用SAN存储的管理API，分配出卷（LUN）之后，直接将卷挂载给QEMU虚拟机使用。这种方案的优点是QEMU虚拟机直接访问LUN，损耗低，性能好。而缺点是需要使用存储设备特定的API，和设备绑定，不够通用。
本文介绍通过OCFS2共享磁盘文件系统，将一个大容量的SAN存储卷作为存储QEMU虚拟机虚拟磁盘文件的存储，达到QEMU使用共享储存的目的。
OCFS2文件系统的配置 准备环境 这一步安装和配置软件
下载和安装ocfs2-tools的rpm包安装（也依赖net-tools） $ wget http://public-yum.oracle.com/public-yum-ol7.repo -O /etc/yum.repos.d/public-yum-ol7.repo $ rpm --import http://public-yum.oracle.com/RPM-GPG-KEY-oracle-ol7 $ yum install yum-plugin-downloadonly -y $ mkdir /tmp/ocfs2 && cd /tmp/ocfs2/ $ yum install --downloadonly --downloaddir=/tmp/ocfs2/ ocfs2-tools net-tools -y 具体操作步骤见官方文档：https://docs.oracle.com/cd/E52668_01/E54669/E54669.pdf, Chapter 23 Oracle Cluster File System Version 2"><link rel=preload href=/scss/main.min.aea6ad3ec7f0b24389e66dfa218753b8c929ea950fe25dbfd511bfa2ef067e56.css as=style><link href=/scss/main.min.aea6ad3ec7f0b24389e66dfa218753b8c929ea950fe25dbfd511bfa2ef067e56.css rel=stylesheet integrity><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/fuse.js@6.6.2></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LX0MD5KG60"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LX0MD5KG60")</script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark navbar-ce flex-column flex-md-row td-navbar"><a id=cloudpods-top href=/zh/ class="logo flex-shrink-0 navbar-brand"><img src=https://www.cloudpods.org/images/cloudpods_logo_white.png height=46></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/quickstart/><span>快速开始</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://www.yunion.cn/subscription/index.html target=_blank><span>服务订阅</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/blog/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/yunionio/cloudpods target=_blank><span>GitHub</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/docs/swagger><span>API</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>3.10</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>v3.10 (latest)</a>
<a class=dropdown-item href=/v3.9>v3.9</a></div></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></li></ul></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.9e80894069a0db0fd1559c324e7cd40c.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/en/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhblog-li><a href=/zh/blog/ title="Cloudpods 博客" class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-zhblog><span>博客</span>
<span class=td-sidebar-section_icon-wrapper></span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20230523refactoring-bash-scripts-to-comply-with-the-google-coding-style-li><a href=/zh/blog/2023/05/23/refactoring-bash-scripts-to-comply-with-the-google-coding-style/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20230523refactoring-bash-scripts-to-comply-with-the-google-coding-style><span>记一次符合 Google Coding Style 的 Bash 脚本重构</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20230515introduction-to-the-skypilot-open-source-project-li><a href=/zh/blog/2023/05/15/introduction-to-the-skypilot-open-source-project/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20230515introduction-to-the-skypilot-open-source-project><span>SkyPilot：构建在多云之上的 ML 和数据科学，可节约 3 倍以上成本</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20221129cloudpods-k8s-experience-sharing-li><a href=/zh/blog/2022/11/29/cloudpods-k8s-experience-sharing/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20221129cloudpods-k8s-experience-sharing><span>Cloudpods容器化经验分享</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220202cloudpods-golang-li><a href=/zh/blog/2022/02/02/cloudpods-golang/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220202cloudpods-golang><span>Cloudpods Golang实践</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20220121skycomputing-li><a href=/zh/blog/2022/01/21/skycomputing/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20220121skycomputing><span>天空计算——云计算的下一个时代？</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20211009rook-ceph-with-cloudpods-li><a href=/zh/blog/2021/10/09/rook-ceph-with-cloudpods/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20211009rook-ceph-with-cloudpods><span>Cloudpods + Rook + Ceph: 轻松实现云原生的超融合私有云</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210925calico-customized-node-firewall-li><a href=/zh/blog/2021/09/25/calico-customized-node-firewall/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210925calico-customized-node-firewall><span>用Calico网络策略设置主机node防火墙规则</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210702ocfs2-as-san-filesystem-li><a href=/zh/blog/2021/07/02/ocfs2-as-san-filesystem/ class="td-sidebar-section_flex pl-0 active td-sidebar-link td-sidebar-link__page" id=m-zhblog20210702ocfs2-as-san-filesystem><span class=td-sidebar-nav-active-item>QEMU+OCFS2: 使用OCFS2作为虚拟机磁盘文件的SAN存储文件系统</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210701cloudpods-lb-application-intro-li><a href=/zh/blog/2021/07/01/cloudpods-lb-application-intro/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210701cloudpods-lb-application-intro><span>问题分析：为什么keystone的本地用户认证接口压测性能很差？</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210625cgroups-kubernetes-pid-limits-li><a href=/zh/blog/2021/06/25/cgroups-kubernetes-pid-limits/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210625cgroups-kubernetes-pid-limits><span>使用 Cgroups 限制 Kubernetes Pod 进程数</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210607nvidia-gpu-passthrough-record-li><a href=/zh/blog/2021/06/07/nvidia-gpu-passthrough-record/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210607nvidia-gpu-passthrough-record><span>使用Linux vfio将Nvidia GPU透传给QEMU虚拟机</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210531cloudpods-37-new-feature-introduction-li><a href=/zh/blog/2021/05/31/cloudpods-3.7-new-feature-introduction/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210531cloudpods-37-new-feature-introduction><span>直播回顾：Cloudpods 3.7版本新功能介绍</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20210531cloudpods-lb-application-intro-li><a href=/zh/blog/2021/05/31/cloudpods-lb-application-intro/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20210531cloudpods-lb-application-intro><span>直播回顾：Cloudpods负载均衡的功能介绍</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhblog20190613unified-iaas-for-future-li><a href=/zh/blog/2019/06/13/unified-iaas-for-future/ class="td-sidebar-section_flex pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhblog20190613unified-iaas-for-future><span>面向未来的 IT 基础设施管理架构——融合云（Unified IaaS）</span></a></li></ul></li></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/yunionio/docs/edit/master/content/zh/blog/_posts/2021-07-02-ocfs2-as-san-filesystem/index.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/yunionio/docs/new/master/content/zh/blog/_posts/2021-07-02-ocfs2-as-san-filesystem/index.md?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href=https://github.com/yunionio/cloudpods/issues/new/choose target=_blank><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a>
<a href="https://github.com/yunionio/cloudpods/issues/new?title=[Docs]%20QEMU+OCFS2:%20%e4%bd%bf%e7%94%a8OCFS2%e4%bd%9c%e4%b8%ba%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%a3%81%e7%9b%98%e6%96%87%e4%bb%b6%e7%9a%84SAN%e5%ad%98%e5%82%a8%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a></div><div id=toc-hidden><nav id=TableOfContents><ul><li><a href=#什么是ocfs2文件系统>什么是OCFS2文件系统？</a></li><li><a href=#qemu通过ocfs2使用共享san存储>QEMU通过OCFS2使用共享SAN存储</a></li><li><a href=#ocfs2文件系统的配置>OCFS2文件系统的配置</a><ul><li><a href=#准备环境>准备环境</a></li><li><a href=#挂载ocfs2文件系统>挂载OCFS2文件系统</a></li></ul></li><li><a href=#cloudpods使用ocfs2文件系统>Cloudpods使用OCFS2文件系统</a><ul><li><a href=#注册ocfs2块存储>注册OCFS2块存储</a></li><li><a href=#使用ocfs2创建主机虚拟磁盘>使用OCFS2创建主机虚拟磁盘</a></li></ul></li><li><a href=#ocfs2文件系统的扩容>OCFS2文件系统的扩容</a></li></ul></nav></div><script>let tocNode=document.getElementById("toc-hidden"),list=clectionLis1(),ul=createList(list);tocNode.innerHTML="",tocNode.appendChild(ul),setTimeout(()=>{initActiveToc(),addEventListener()},0);function addEventListener(){document.getElementById("toc-hidden").onclick=function(e){let t=e||window.event,n=t.target||t.srcElement;n.nodeName.toLowerCase()=="a"&&setTimeout(()=>{changeTocActive(n.parentNode)},0)},window.onscroll=function(){initActiveToc()}}function initActiveToc(){let e=getBoundingClientNode("h2"),t=getBoundingClientNode("h3"),n=e.currentNode||t.currentNode;if(e.currentNode&&t.currentNode&&(n=Math.abs(e.y)<Math.abs(t.y)?e.currentNode:t.currentNode),!n)return;changeTocActive(n)}function changeTocActive(e){let s=e.getAttribute("id")||e.getAttribute("text")?.replace("#",""),t=document.getElementsByClassName("li1-item"),n=document.getElementsByClassName("li2-item");for(let e=0;e<t.length;e++){let n=t[e].getAttribute("text")||"";n.replace("#","")==s?t[e].classList.add("active"):t[e].classList.remove("active")}for(let e=0;e<n.length;e++){let t=n[e].getAttribute("text")||"";t.replace("#","")==s?n[e].classList.add("active"):n[e].classList.remove("active")}}function getBoundingClientNode(e){let t={nodes:[],currentNode:null,index:-1,y:0},n=Array.from(document.getElementsByTagName(e));t.nodes=n;for(let e=0;e<n.length;e++){let s=n[e].getBoundingClientRect();if(s.y<=0&&(t.y=s.y,t.currentNode=n[e],t.index=e),s.y>0&&s.y<window.innerHeight){t.y=s.y,t.currentNode=n[e],t.index=e;break}}return t}function createList(e){let t=createNode("ul");return e.map((n,s)=>{let a=["li1-item"],r=["li1-item-topborder"];s!==0&&r.push("show");let c=["li1-item-bottomborder"];s!==e.length-1?c.push("show"):a.push("no-border");let i=createNode("li",{classList:a,text:n.href}),l=createNode("a",{href:n.href,innerHTML:n.text}),o=createNode("div",{classList:["li1-item-style"]}),d=createNode("div",{classList:r}),u=createNode("div",{classList:c}),h=createNode("div",{classList:["mask-line"]}),m=createNode("div",{classList:["li1-item-style-dotted"]});if(o.appendChild(d),o.appendChild(u),o.appendChild(h),o.appendChild(m),i.appendChild(l),i.appendChild(o),n.ul.length){let e=createNode("ul");n.ul.map((t)=>{let s=createNode("li",{classList:["li2-item"],text:t.href}),o=createNode("a",{href:t.href,innerHTML:t.text}),i=createNode("div",{classList:["li2-item-style"]});s.appendChild(o),s.appendChild(i),e.appendChild(s)}),i.appendChild(e)}t.appendChild(i)}),t}function createNode(e,t={}){let n=document.createElement(e);const{classList:s,innerHTML:o,href:i,text:a}=t;return s&&s.map(e=>{n.classList.add(e)}),o&&(n.innerHTML=o),i&&(n.href=i),a&&n.setAttribute("text",a),n}function clectionLis1(){let t=[],e=document.getElementById("TableOfContents")?.firstElementChild||{children:[]};for(let n=0;n<e.children.length;n++){let o=e.children[n].firstElementChild,a=e.children[n].lastChild,s=e.children[n].children[1]||"",i={text:o.innerHTML,href:o.getAttribute("href"),ul:[]};if(s)for(let e=0;e<s.children.length;e++){let t=s.children[e].firstElementChild;i.ul.push({text:t.innerHTML,href:t.getAttribute("href")})}t.push(i)}return t}</script></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=https://www.cloudpods.org/zh/blog/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>QEMU+OCFS2: 使用OCFS2作为虚拟机磁盘文件的SAN存储文件系统</h1><div class="td-byline mb-4"><time datetime=2021-07-02 class=text-muted>02.07.2021</time></div><p><strong>作者:</strong> 小助手</p><p>本文介绍OCFS2共享集群文件系统，如何配置以及如何在线扩容。</p><h2 id=什么是ocfs2文件系统>什么是OCFS2文件系统？</h2><p>OCFS2是 Oracle Cluster File System Version 2 的缩写，是Oracle公司内部开发的共享磁盘文件系统，于2011年开源，使用GNU GPL协议。</p><p>什么是共享磁盘文件系统呢？我们下面通过解释三个概念的对比来说明：</p><ul><li>磁盘文件系统</li></ul><p>这是最常见的文件系统，构建在<strong>本地</strong>的磁盘（块存储，Block Storage）之上。通过磁盘文件系统，磁盘上的内容以文件目录的形式进行组织，方便了用户有效使用磁盘上的存储空间。磁盘文件系统的例子有：ext4, xfs等。</p><ul><li>共享文件系统</li></ul><p>共享文件系统通过远端服务器上运行的服务程序访问挂载在远端服务器上的文件系统。例子为：NFS（Network File System），Samba（CIFS）。</p><ul><li>共享磁盘文件系统</li></ul><p>共享磁盘文件系统又叫集群文件系统（Cluster File System），是专门构建在网络共享的磁盘上的文件系统。网络共享磁盘通过SAN（Storage Area Network）被多台主机共同访问，和磁盘文件系统相比，共享磁盘文件系统除了要解决磁盘空间的有效管理问题之外，还要解决文件系统被多台主机同时访问的并发修改问题。因此分布式锁机制是共享磁盘文件系统共有的机制。</p><p>从使用场景来看，三种文件系统的差别很明显：磁盘文件系统直接访问本地磁盘，共享文件系统需要通过共享文件服务访问挂载在服务器上的文件系统，而共享磁盘文件系统则直接访问共享磁盘。</p><p>因此，在网络共享的场景下，通过共享磁盘文件系统访问SAN存储，可以直接访问共享存储设备。访问路径短，效率高，并且能解决多主机并发访问共享存储的问题。</p><h2 id=qemu通过ocfs2使用共享san存储>QEMU通过OCFS2使用共享SAN存储</h2><p>QEMU使用共享SAN存储有多种方案。常见方案是在需要新建虚拟机磁盘时，使用SAN存储的管理API，分配出卷（LUN）之后，直接将卷挂载给QEMU虚拟机使用。这种方案的优点是QEMU虚拟机直接访问LUN，损耗低，性能好。而缺点是需要使用存储设备特定的API，和设备绑定，不够通用。</p><p>本文介绍通过OCFS2共享磁盘文件系统，将一个大容量的SAN存储卷作为存储QEMU虚拟机虚拟磁盘文件的存储，达到QEMU使用共享储存的目的。</p><h2 id=ocfs2文件系统的配置>OCFS2文件系统的配置</h2><h3 id=准备环境>准备环境</h3><p>这一步安装和配置软件</p><h4 id=下载和安装ocfs2-tools的rpm包安装也依赖net-tools>下载和安装ocfs2-tools的rpm包安装（也依赖net-tools）</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ wget http://public-yum.oracle.com/public-yum-ol7.repo -O /etc/yum.repos.d/public-yum-ol7.repo
</span></span><span style=display:flex><span>$ rpm --import http://public-yum.oracle.com/RPM-GPG-KEY-oracle-ol7
</span></span><span style=display:flex><span>$ yum install yum-plugin-downloadonly -y
</span></span><span style=display:flex><span>$ mkdir /tmp/ocfs2 <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>cd</span> /tmp/ocfs2/
</span></span><span style=display:flex><span>$ yum install --downloadonly --downloaddir<span style=color:#ce5c00;font-weight:700>=</span>/tmp/ocfs2/ ocfs2-tools net-tools -y
</span></span></code></pre></div><p>具体操作步骤见官方文档：https://docs.oracle.com/cd/E52668_01/E54669/E54669.pdf, Chapter 23 Oracle Cluster File System Version 2</p><h4 id=安装cloudpods内核自带编译了ocfs2文件系统的内核模块>安装Cloudpods内核，自带编译了ocfs2文件系统的内核模块</h4><p>由于OCFS2使用场景较少，在常见发行版的内核中都不会启用OCFS2的内核模块。我们提供了预先编译好的启用了OCFS2的内核安装包：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ yum install -y yum-utils
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 添加 yunion Cloudpods rpm 源</span>
</span></span><span style=display:flex><span>$ yum-config-manager --add-repo https://iso.yunion.cn/yumrepo-3.6/yunion.repo
</span></span><span style=display:flex><span>$ yum install -y kernel-3.10.0-1062.4.3.el7.yn20191203
</span></span></code></pre></div><p>同时，部署时写配置文件到/etc/modules-load.d/ocfs2.conf，确保内核的ocfs2模块自动加载</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Load ocfs2.ko at boot</span>
</span></span><span style=display:flex><span>ocfs2
</span></span></code></pre></div><p>安装内核后需要重启生效，重启后检查新的内核已经生效</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ uname -r
</span></span><span style=display:flex><span>3.10.0-1062.4.3.el7.yn20191203.x86_64
</span></span></code></pre></div><h4 id=ocfs2配置文件>OCFS2配置文件</h4><p>OCFS2配置简单，只需要在每个要挂载OCFS2的节点上都配置相同的配置文件，申明成员节点即可。</p><p>以下为示例配置文件:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /etc/ocfs2/cluster.conf 
</span></span><span style=display:flex><span>cluster:
</span></span><span style=display:flex><span>        <span style=color:#000>node_count</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span>            &lt;<span style=color:#ce5c00;font-weight:700>==</span> 集群节点数目
</span></span><span style=display:flex><span>        <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> ocfs2              &lt;<span style=color:#ce5c00;font-weight:700>==</span> 集群名字
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>node:
</span></span><span style=display:flex><span>        <span style=color:#000>ip_port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7777</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ip_address</span> <span style=color:#ce5c00;font-weight:700>=</span> 192.168.7.10
</span></span><span style=display:flex><span>        <span style=color:#000>number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>                &lt;<span style=color:#ce5c00;font-weight:700>==</span> 节点编号
</span></span><span style=display:flex><span>        <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> client01           &lt;<span style=color:#ce5c00;font-weight:700>==</span> 节点名字
</span></span><span style=display:flex><span>        <span style=color:#000>cluster</span> <span style=color:#ce5c00;font-weight:700>=</span> ocfs2
</span></span><span style=display:flex><span>node:
</span></span><span style=display:flex><span>        <span style=color:#000>ip_port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7777</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ip_address</span> <span style=color:#ce5c00;font-weight:700>=</span> 192.168.7.11
</span></span><span style=display:flex><span>        <span style=color:#000>number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>        <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> client02
</span></span><span style=display:flex><span>        <span style=color:#000>cluster</span> <span style=color:#ce5c00;font-weight:700>=</span> ocfs2
</span></span><span style=display:flex><span>node:
</span></span><span style=display:flex><span>        <span style=color:#000>ip_port</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>7777</span>
</span></span><span style=display:flex><span>        <span style=color:#000>ip_address</span> <span style=color:#ce5c00;font-weight:700>=</span> 192.168.7.12
</span></span><span style=display:flex><span>        <span style=color:#000>number</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>        <span style=color:#000>name</span> <span style=color:#ce5c00;font-weight:700>=</span> client03
</span></span><span style=display:flex><span>        <span style=color:#000>cluster</span> <span style=color:#ce5c00;font-weight:700>=</span> ocfs2
</span></span></code></pre></div><h4 id=初始化ocfs2的配置>初始化ocfs2的配置</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ o2cb.init configure      第一项选yes，集群名称填上面配置文件里的，默认是ocfs2
</span></span></code></pre></div><h4 id=确保o2cb-ocfs2服务启动并设置为开机自启>确保o2cb ocfs2服务启动并设置为开机自启</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl <span style=color:#204a87>enable</span> o2cb ocfs2
</span></span></code></pre></div><p>至此，OCFS2的软件和配置完成，下一步将格式化磁盘，挂载OCFS2文件系统</p><h3 id=挂载ocfs2文件系统>挂载OCFS2文件系统</h3><p>这一步使用OCFS2格式化网络共享磁盘，并且挂载到各台宿主机上</p><p>在此之前可能要配置SAN存储的多路径multipath(由于行文原因，细节在此省略)，在此之后使用parted分区，格式化成ocfs2（只在一台机器分区格式化，其他机器partprobe就能看到格式化后的分区）并挂载到多台机器</p><p>以下命令在第一个节点执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看多路径multipath磁盘情况</span>
</span></span><span style=display:flex><span>$ multipath -l
</span></span></code></pre></div><p>使用mkfs.ocfs2格式化分区</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ parted /dev/dm-0
</span></span><span style=display:flex><span>$ mkfs.ocfs2 /dev/dm-1
</span></span><span style=display:flex><span>$ mount /dev/dm-1 /data
</span></span></code></pre></div><p>持久化磁盘挂载到/etc/fstab</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/fstab</span>
</span></span><span style=display:flex><span>/dev/dm-1  /opt/cloud/workspace/disks  ocfs2     _netdev,defaults  <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><p>在其他节点，则只需要执行partprobe探测分区变化，并且挂载分区。也应该修改/etc/fstab，持久化分区的挂载。</p><h2 id=cloudpods使用ocfs2文件系统>Cloudpods使用OCFS2文件系统</h2><p>在Cloudpods中，通过OCFS2挂载的共享文件系统可以作为GPFS类型的共享存储类型进行管理。通过以下步骤将OCFS2的共享存储注册到Cloudpods，并且用来存储虚拟机用的虚拟磁盘文件。</p><h3 id=注册ocfs2块存储>注册OCFS2块存储</h3><p>在【存储-块存储】界面，新建一个GPFS类型的共享存储。</p><img src=ocfs2-create.png alt width=800><p>存储记录创建成功后，选择该存储的“管理宿主机”菜单按钮，在关联存储的宿主机列表，选择“关联宿主机”，将挂载该存储的宿主机节点都注册关联，让Cloudpods平台知道这个共享存储挂载到哪些宿主机的哪个目录下。</p><h3 id=使用ocfs2创建主机虚拟磁盘>使用OCFS2创建主机虚拟磁盘</h3><p>以上配置完成后，在新建虚拟机时，就可以选择新建的OCFS2存储作为虚拟磁盘的存储。</p><h2 id=ocfs2文件系统的扩容>OCFS2文件系统的扩容</h2><p>首先需要将OCFS2只挂载在第一个节点，将其他节点都卸载。以下操作都只在第一个节点上执行。</p><p>首先，需要在SAN存储扩容该物理卷，这一步在SAN设备上操作，在此不详叙述。</p><p>其次，针对multipath设备，需要rescan该设备下的每个磁盘，让操作系统感知到设备的扩容。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 首先执行 multipath -l 查看multipath设备底层的磁盘设备</span>
</span></span><span style=display:flex><span>$ multipath -ll
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> ignoring extra data starting with <span style=color:#4e9a06>&#39;}&#39;</span> on line <span style=color:#0000cf;font-weight:700>16</span> of /etc/multipath.conf
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdi: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdb: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdc: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdd: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sde: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdf: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdg: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdh: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdq: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdj: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdm: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdn: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdo: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdp: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdk: alua not supported
</span></span><span style=display:flex><span>Jun <span style=color:#0000cf;font-weight:700>24</span> 15:09:16 <span style=color:#000;font-weight:700>|</span> sdl: alua not supported
</span></span><span style=display:flex><span>36488eef100d71ed122ace06c00000001 dm-0 HUAWEI  ,XSG1
</span></span><span style=display:flex><span><span style=color:#000>size</span><span style=color:#ce5c00;font-weight:700>=</span>15T <span style=color:#000>features</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;1 queue_if_no_path&#39;</span> <span style=color:#000>hwhandler</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;0&#39;</span> <span style=color:#000>wp</span><span style=color:#ce5c00;font-weight:700>=</span>rw
</span></span><span style=display:flex><span><span style=color:#4e9a06>`</span>-+- <span style=color:#000>policy</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;service-time 0&#39;</span> <span style=color:#000>prio</span><span style=color:#ce5c00;font-weight:700>=</span>-1 <span style=color:#000>status</span><span style=color:#ce5c00;font-weight:700>=</span>active
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 1:0:7:1 sdi 8:128 active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 1:0:0:1 sdb 8:16  active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 1:0:1:1 sdc 8:32  active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 1:0:2:1 sdd 8:48  active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 1:0:3:1 sde 8:64  active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 1:0:4:1 sdf 8:80  active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 1:0:5:1 sdg 8:96  active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 1:0:6:1 sdh 8:112 active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 2:0:7:1 sdq 65:0  active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 2:0:3:1 sdj 8:144 active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 2:0:6:1 sdm 8:192 active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 2:0:0:1 sdn 8:208 active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 2:0:2:1 sdo 8:224 active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 2:0:5:1 sdp 8:240 active ready running
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>|</span>- 2:0:1:1 sdk 8:160 active ready running
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>`</span>- 2:0:4:1 sdl 8:176 active ready running
</span></span></code></pre></div><p>对每个设备执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>1</span> &gt; /sys/class/block/sdi/device/rescan
</span></span></code></pre></div><p>再执行下面的命令，让操作系统感知到multipath设备的容量变化：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ multipathd -k
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># multipathd&gt; resize map 36488eef100d71ed122ace06c00000001</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ok</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># multipathd&gt; exit</span>
</span></span></code></pre></div><p>经过上面步骤，操作系统已经感知到设备的容量变化，这时候需要使用parted扩大分区表，方法是使用parted删除分区再重建分区</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ parted /dev/dm-0
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span>parted<span style=color:#ce5c00;font-weight:700>)</span> unit s
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span>parted<span style=color:#ce5c00;font-weight:700>)</span> p
</span></span><span style=display:flex><span>Model: Linux device-mapper <span style=color:#ce5c00;font-weight:700>(</span>multipath<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>dm<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Disk /dev/dm-0: 32212254720s
</span></span><span style=display:flex><span>Sector size <span style=color:#ce5c00;font-weight:700>(</span>logical/physical<span style=color:#ce5c00;font-weight:700>)</span>: 512B/512B
</span></span><span style=display:flex><span>Partition Table: gpt
</span></span><span style=display:flex><span>Disk Flags:
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>Number  Start  End           Size          File system  Name   Flags
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>1</span>      2048s  10737416191s  10737414144s               disks
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span>parted<span style=color:#ce5c00;font-weight:700>)</span> rm <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span>parted<span style=color:#ce5c00;font-weight:700>)</span> mkpart
</span></span><span style=display:flex><span>Partition name?  <span style=color:#ce5c00;font-weight:700>[]</span>?
</span></span><span style=display:flex><span>File system type?  <span style=color:#ce5c00;font-weight:700>[</span>ext2<span style=color:#ce5c00;font-weight:700>]</span>?
</span></span><span style=display:flex><span>Start? <span style=color:#0000cf;font-weight:700>2048</span>
</span></span><span style=display:flex><span>End? 100%
</span></span><span style=display:flex><span>device-mapper: create ioctl on 36488eef100d71ed122ace06c00000001p1 part1-mpath-36488eef100d71ed122ace06c00000001 failed: Device or resource busy
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span>parted<span style=color:#ce5c00;font-weight:700>)</span> p
</span></span><span style=display:flex><span>Model: Linux device-mapper <span style=color:#ce5c00;font-weight:700>(</span>multipath<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>dm<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Disk /dev/dm-0: 32212254720s
</span></span><span style=display:flex><span>Sector size <span style=color:#ce5c00;font-weight:700>(</span>logical/physical<span style=color:#ce5c00;font-weight:700>)</span>: 512B/512B
</span></span><span style=display:flex><span>Partition Table: gpt
</span></span><span style=display:flex><span>Disk Flags:
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>Number  Start  End           Size          File system  Name  Flags
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>1</span>      2048s  32212252671s  32212250624s
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span>parted<span style=color:#ce5c00;font-weight:700>)</span> quit
</span></span></code></pre></div><p>扩容分区表之后，再使用 tunefs.ocfs2 扩容文件系统</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 扩容文件系统</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># tunefs.ocfs2 -S /dev/dm-1</span>
</span></span></code></pre></div><p>经过以上步骤后，文件系统扩容完毕。最后，在其余节点执行partprobe感知设备的容量变化，再重新挂载分区就可以了。</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/zh/blog/2021/07/01/cloudpods-lb-application-intro/ class="btn btn-primary"><span class=mr-1>←</span> 上一页</a></li><a href=/zh/blog/2021/09/25/calico-customized-node-firewall/ class="btn btn-primary">下一页 <span class=ml-1>→</span></a></li></ul></div></main></div></div><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?3c5253cd6530122d0f774cab69e3c07f",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><footer class="bg-dark pt-4 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>Copyright &copy; 2017-2023 The Cloudpods Authors.</small>
<a href=https://beian.miit.gov.cn/ style=text-decoration:none;color:inherit;display:block class=text-white>京ICP备2021005745号-3</a></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.e38614a3d7988ac625b9f049be3f42dc3a8de71254a9c6ffd5850eac7849597a.js integrity="sha256-44YUo9eYisYlufBJvj9C3DqN5xJUqcb/1YUOrHhJWXo=" crossorigin=anonymous></script></body></html>