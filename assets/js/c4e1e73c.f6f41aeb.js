"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[838],{17064:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>r,default:()=>l,frontMatter:()=>o,metadata:()=>c,toc:()=>d});var s=t(74848),a=t(28453);const o={sidebar_position:2},r="\u53ea\u8bfb\u5bfc\u5165",c={id:"guides/k8s/readonly-import",title:"\u53ea\u8bfb\u5bfc\u5165",description:"\u5982\u679c\u53ea\u60f3\u901a\u8fc7 cloudpods kubeserver \u670d\u52a1\u67e5\u770b Kubernetes \u96c6\u7fa4\u7684\u8d44\u6e90\uff0c\u53ef\u4ee5\u521b\u5efa\u53ea\u8bfb\u7684 RBAC \uff0c\u7136\u540e\u5bfc\u5165\u76f8\u5173 ServiceAccount \u7684 kubeconfig \uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u8fd9\u79cd\u573a\u666f\u3002",source:"@site/docs/guides/k8s/readonly-import.md",sourceDirName:"guides/k8s",slug:"/guides/k8s/readonly-import",permalink:"/guides/k8s/readonly-import",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/guides/k8s/readonly-import.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"\u5185\u7f6e\u79c1\u6709\u4e91\u96c6\u7fa4",permalink:"/guides/k8s/onprimise-pre-env"},next:{title:"\u76d1\u63a7\u4e0e\u8fd0\u7ef4",permalink:"/guides/monitor_ops/"}},i={},d=[{value:"\u521b\u5efa\u76f8\u5173 RBAC \u8d44\u6e90",id:"\u521b\u5efa\u76f8\u5173-rbac-\u8d44\u6e90",level:2},{value:"\u751f\u6210 kubeconfig",id:"\u751f\u6210-kubeconfig",level:2},{value:"\u66f4\u65b0\u5df2\u6709\u96c6\u7fa4\u7684 kubeconfig",id:"\u66f4\u65b0\u5df2\u6709\u96c6\u7fa4\u7684-kubeconfig",level:2}];function u(e){const n={code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"\u53ea\u8bfb\u5bfc\u5165",children:"\u53ea\u8bfb\u5bfc\u5165"}),"\n",(0,s.jsx)(n.p,{children:"\u5982\u679c\u53ea\u60f3\u901a\u8fc7 cloudpods kubeserver \u670d\u52a1\u67e5\u770b Kubernetes \u96c6\u7fa4\u7684\u8d44\u6e90\uff0c\u53ef\u4ee5\u521b\u5efa\u53ea\u8bfb\u7684 RBAC \uff0c\u7136\u540e\u5bfc\u5165\u76f8\u5173 ServiceAccount \u7684 kubeconfig \uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u8fd9\u79cd\u573a\u666f\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u64cd\u4f5c\u5982\u4e0b\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u521b\u5efa\u76f8\u5173-rbac-\u8d44\u6e90",children:"\u521b\u5efa\u76f8\u5173 RBAC \u8d44\u6e90"}),"\n",(0,s.jsxs)(n.p,{children:["\u7528 ",(0,s.jsx)(n.code,{children:"kubectl apply"})," \u521b\u5efa\u4e0b\u9762\u7684 RBAC \u8d44\u6e90\uff0c\u5305\u62ec ServiceAccount(cloudpods-reader)\u3001ClusterRole(cloudpods-read-only)\u3001ClusterRoleBinding(cloudpods-reader-binding)\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u628a\u4e0b\u9762\u7684\u5185\u5bb9\u4fdd\u5b58\u5728 readonly-res.yaml \u6587\u4ef6\u4e2d\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: cloudpods-reader\n  namespace: default\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: "true"\n  labels:\n  name: cloudpods-read-only\n  namespace: default\nrules:\n  - apiGroups:\n      - "*"\n    resources: ["*"]\n    verbs:\n      - get\n      - list\n      - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: cloudpods-reader-binding\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cloudpods-read-only\nsubjects:\n  - kind: ServiceAccount\n    name: cloudpods-reader\n    namespace: default\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u5c06\u4e0a\u9762\u7684 readonly-res.yaml \u5185\u5bb9\u521b\u5efa\u5230\u8981\u5bfc\u5165\u7684 Kubernetes \u96c6\u7fa4\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl apply -f readonly-res.yaml\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u751f\u6210-kubeconfig",children:"\u751f\u6210 kubeconfig"}),"\n",(0,s.jsx)(n.p,{children:"\u4e0b\u9762\u662f\u751f\u6210 kubeconfig \u7684\u811a\u672c\uff0c\u5c06\u5185\u5bb9\u4fdd\u5b58\u5728 readonly-config.sh \u6587\u4ef6\u4e2d\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"#!/bin/bash\n\nserver=$(kubectl config view --minify --output jsonpath='{.clusters[*].cluster.server}')\nname=$(kubectl get secrets --namespace=default -o json | jq -r '.items[] | select(.metadata.name | test(\"cloudpods-reader-token-\")).metadata.name')\nca=$(kubectl get secret/$name --namespace=default -o jsonpath='{.data.ca\\.crt}')\ntoken=$(kubectl get secret/$name --namespace=default -o jsonpath='{.data.token}' | base64 --decode)\nnamespace=$(kubectl get secret/$name --namespace=default -o jsonpath='{.data.namespace}' | base64 --decode)\n\necho \"\napiVersion: v1\nkind: Config\nclusters:\n- name: default-cluster\n  cluster:\n    certificate-authority-data: ${ca}\n    server: ${server}\ncontexts:\n- name: default-context\n  context:\n    cluster: default-cluster\n    namespace: default\n    user: default-user\ncurrent-context: default-context\nusers:\n- name: default-user\n  user:\n    token: ${token}\n\"\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6267\u884c readonly-config.sh \u811a\u672c\uff0c\u628a\u8f93\u51fa\u7684 kubeconfig \u7c98\u8d34\u4e0b\u6765\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ bash readonly-config.sh\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u7136\u540e\u628a\u751f\u6210\u7684 kubeconfig \u5185\u5bb9\u4ece\u524d\u7aef\u5bfc\u5165\u5373\u53ef\uff0c\u8fd9\u6837\u53ea\u6709\u53ea\u8bfb\u7684\u64cd\u4f5c\u53ef\u4ee5\u6267\u884c\uff0c\u5176\u4ed6\u5199\u64cd\u4f5c\u90fd\u4f1a\u88ab Kubernetes \u96c6\u7fa4\u90a3\u8fb9\u62d2\u7edd\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u66f4\u65b0\u5df2\u6709\u96c6\u7fa4\u7684-kubeconfig",children:"\u66f4\u65b0\u5df2\u6709\u96c6\u7fa4\u7684 kubeconfig"}),"\n",(0,s.jsx)(n.p,{children:"\u5982\u679c\u662f\u5df2\u7ecf\u5bfc\u5165\u7684\u96c6\u7fa4\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u66f4\u65b0\u5bf9\u5e94 Kubernetes \u96c6\u7fa4\u7684 kubeconfig\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# \u628a readonly-config.sh \u751f\u6210\u7684 kubeconfig \u5185\u5bb9\u4fdd\u5b58\u5230\u6587\u4ef6\n$ bash readonly-config.sh > kubeconfig-ro.conf\n\n# \u5148\u5217\u51fa\u6240\u6709\u7684 K8s \u96c6\u7fa4\n$ climc k8s-cluster-list --scope system --limit 0\n+----------+--------------------------------------+---------+--------------+----------------+---------+---------------+---------+-----------+----------+-------------+\n|   Name   |                  Id                  | Status  | Cluster_Type | Cloudregion_Id | Vpc_Id  | Resource_Type | Version |   Mode    | Provider | Sync_Status |\n+----------+--------------------------------------+---------+--------------+----------------+---------+---------------+---------+-----------+----------+-------------+\n| t3       | 66bf3f7e-5ddd-4fef-8905-b4c380942352 | running | default      | default        | default | guest         | v1.17.0 | customize | onecloud | idle        |\n| test122  | 2c136bb7-aab8-42f6-89d4-ed921278456c | running | default      | default        | default | guest         | v1.22.9 | customize | onecloud | idle        |\n| lzx-test | a83fdc32-586f-4fad-82c6-51af34e2be76 | running | default      | default        | default | guest         | v1.17.0 | customize | onecloud | idle        |\n+----------+--------------------------------------+---------+--------------+----------------+---------+---------------+---------+-----------+----------+-------------+\n***  Total: 3 Pages: 1 Limit: 2048 Offset: 0 Page: 1  ***\n\n# \u5047\u8bbe\u8981\u66f4\u65b0\u96c6\u7fa4 test122 \u7684 kubeconfig\n$ climc k8s-cluster-set-kubeconfig 2c136bb7-aab8-42f6-89d4-ed921278456c ./kubeconfig-ro.conf\n"})})]})}function l(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>c});var s=t(96540);const a={},o=s.createContext(a);function r(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);