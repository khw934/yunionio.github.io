"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[7848],{97097:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var r=s(74848),t=s(28453);const o={sidebar_position:15},i="\u6dfb\u52a0\u4e00\u4e2aAPI\u7684\u8fc7\u7a0b",l={id:"development/add-api",title:"\u6dfb\u52a0\u4e00\u4e2aAPI\u7684\u8fc7\u7a0b",description:"\u672c\u6587\u4ee5DNS\u8bb0\u5f55\u5bfc\u51faZone\u683c\u5f0f\u6587\u4ef6\u4e3a\u4f8b\uff0c\u4ecb\u7ecd\u5982\u4f55\u6dfb\u52a0\u4e00\u4e2aAPI\u3002",source:"@site/docs/development/add-api.md",sourceDirName:"development",slug:"/development/add-api",permalink:"/docs/development/add-api",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/development/add-api.md",tags:[],version:"current",sidebarPosition:15,frontMatter:{sidebar_position:15},sidebar:"tutorialSidebar",previous:{title:"\u5b9a\u4f4d\u540e\u7aef\u4ee3\u7801",permalink:"/docs/development/loc-api-model"},next:{title:"\u591a\u4e91\u8d44\u6e90\u5bf9\u63a5",permalink:"/docs/development/resource_sync/"}},c={},d=[{value:"\u539f\u7406",id:"\u539f\u7406",level:2},{value:"\u5b9e\u73b0",id:"\u5b9e\u73b0",level:2},{value:"\u5b9e\u73b0GetDetailsExports\u65b9\u6cd5",id:"\u5b9e\u73b0getdetailsexports\u65b9\u6cd5",level:3},{value:"\u5b9e\u73b0ToZoneLine\u65b9\u6cd5",id:"\u5b9e\u73b0tozoneline\u65b9\u6cd5",level:3},{value:"climc\u547d\u4ee4\u7f16\u5199",id:"climc\u547d\u4ee4\u7f16\u5199",level:3},{value:"\u6d4b\u8bd5",id:"\u6d4b\u8bd5",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"\u6dfb\u52a0\u4e00\u4e2aapi\u7684\u8fc7\u7a0b",children:"\u6dfb\u52a0\u4e00\u4e2aAPI\u7684\u8fc7\u7a0b"}),"\n",(0,r.jsx)(n.p,{children:"\u672c\u6587\u4ee5DNS\u8bb0\u5f55\u5bfc\u51faZone\u683c\u5f0f\u6587\u4ef6\u4e3a\u4f8b\uff0c\u4ecb\u7ecd\u5982\u4f55\u6dfb\u52a0\u4e00\u4e2aAPI\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u539f\u7406",children:"\u539f\u7406"}),"\n",(0,r.jsx)(n.p,{children:"\u5b9e\u73b0Zone\u683c\u5f0f\u6587\u4ef6\u5bfc\u51faDNS\u8d44\u6e90\u8bb0\u5f55\uff1a\u5c06\u67d0\u4e2adns zone\u5728\u6570\u636e\u5e93\u4e2d\u7684dns\u8bb0\u5f55\u8bfb\u51fa\uff0c\u6309Zone\u6587\u4ef6\u7684\u683c\u5f0f\u7ec4\u7ec7\u6210\u5b57\u7b26\u4e32\uff0c\u5e76\u8fd4\u56dejson\u683c\u5f0f\u7684\u7ed3\u679c\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u6839\u636e",(0,r.jsx)(n.a,{href:"./backend-framework/",children:"\u540e\u7aef\u670d\u52a1\u6846\u67b6"}),"\uff1a"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"REST API \u8d1f\u8d23\u89e3\u6790\u5ba2\u6237\u7aef\u53d1\u9001\u7684 CRUD http \u8bf7\u6c42\uff0c\u5c06\u4e0d\u540c\u7684\u8bf7\u6c42\u5bf9\u5e94\u5230 Model Dispatcher \u6a21\u5757\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"Model Dispatcher \u5c06\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u5206\u53d1\u5230\u5bf9\u5e94\u8d44\u6e90\u7684\u4e1a\u52a1\u64cd\u4f5c\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"Model \u5b9a\u4e49\u4e91\u5e73\u53f0\u5404\u79cd\u8d44\u6e90\uff0c\u4f1a\u8fdb\u884c\u6570\u636e\u5e93\u8bfb\u5199\u76f8\u5173\u64cd\u4f5c\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u56e0\u6b64\u6839\u636e",(0,r.jsx)(n.a,{href:"./codestruct/",children:"\u540e\u7aef\u4ee3\u7801\u7ed3\u6784"}),"\uff1a"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["pkg/compute/models\u4e3a\u670d\u52a1\u8d44\u6e90\u6a21\u578b\u4ee3\u7801\uff0c\u4e00\u822c\u4e00\u4e2amodel\u5bf9\u5e94\u6570\u636e\u5e93\u4e2d\u7684\u4e00\u5f20\u8868\u3002\u7531\u4e8e\u8981\u5904\u7406\u67d0\u4e2azone\u4e0b\u7684\u6240\u6709dns\u8bb0\u5f55\uff0c\u6240\u4ee5\u5728dns_zones.go\u6587\u4ef6\u4e2d\u7ed9SDnsZone\u589e\u52a0",(0,r.jsx)(n.strong,{children:"GetDetailsExports"}),"\u65b9\u6cd5\uff0c\u5fc5\u8981\u65f6\u4e5f\u53ef\u4ee5\u5728dns_recordsets.go\u6587\u4ef6\u4e2d\u5411SDnsRecordSet\u589e\u52a0\u5904\u7406\u4e00\u6761dns\u8bb0\u5f55\u7684\u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"func (self *SDnsZone) GetDetailsExports(ctx context.Context, userCred mcclient.TokenCredential, query jsonutils.JSONObject) (jsonutils.JSONObject, error) {\n    // TODO\n}\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["pkg/cloudcommon/db\u4e3a\u670d\u52a1models\u901a\u7528\u4ee3\u7801\uff0c\u5728db_dispatcher.go\u6587\u4ef6\u7684",(0,r.jsx)(n.strong,{children:"GetSpecific"}),"\u65b9\u6cd5\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\u5bf9\u4e0a\u8ff0GetDetailsXXX\u65b9\u6cd5\u8fdb\u884c\u4e86\u53cd\u5c04\u8c03\u7528\u3002"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["cmd/climc/shell\u4e3a\u5404\u4e2a\u670d\u52a1\u5bf9\u5e94\u7684\u547d\u4ee4\u884c\u5de5\u5177\u4ee3\u7801\uff0c\u5728cmd/climc/shell/compute/dnszone.go\u6587\u4ef6\u4e2d\u8c03\u7528",(0,r.jsx)(n.strong,{children:"GetWithCustomShow"}),"\u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u4f1a\u8c03\u7528\u4e0a\u8ff0GetSpecific\u65b9\u6cd5\uff0c\u7528\u4e8e\u6d4b\u8bd5dns-zone-exports\u547d\u4ee4\u8fd4\u56de\u7684\u7ed3\u679c\u3002GetWithCustomShow\u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u662fGetDetailsXXX\u7684XXX\u7684\u5c0f\u5199\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a\u5904\u7406GetDetailsXXX\u8fd4\u56de\u7ed3\u679c\u7684\u51fd\u6570\uff0c\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a\u8be5\u6d4b\u8bd5\u547d\u4ee4\u7684\u53c2\u6570\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'cmd.GetWithCustomShow("exports", func(result jsonutils.JSONObject) {\n    // TODO\t\n}, &options.SDnsZoneIdOptions{})\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5b9e\u73b0",children:"\u5b9e\u73b0"}),"\n",(0,r.jsx)(n.h3,{id:"\u5b9e\u73b0getdetailsexports\u65b9\u6cd5",children:"\u5b9e\u73b0GetDetailsExports\u65b9\u6cd5"}),"\n",(0,r.jsx)(n.p,{children:"\u7f16\u8f91 pkg/compute/models/dns_zones.go \u6587\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'// \u5c06dns\u8bb0\u5f55\u8f6c\u6362\u6210zone\u683c\u5f0f\uff0c\u8fd4\u56dejson\nfunc (self *SDnsZone) GetDetailsExports(ctx context.Context, userCred mcclient.TokenCredential, query jsonutils.JSONObject) (jsonutils.JSONObject, error) {\n        // \u83b7\u53d6\u6570\u636e\u5e93\u4e2ddns\u8bb0\u5f55\n        records, err := self.GetDnsRecordSets()\n        if err != nil {\n                return nil, errors.Wrapf(err, "GetDnsRecordSets")\n        }\n        // zone\u6587\u4ef6\u5185\u5bb9\n        result := "$ORIGIN " + self.Name + ".\\n"\n        lines := []string{}\n        for _, record := range records {\n                lines = append(lines, record.ToZoneLine())\n        }\n        result += strings.Join(lines, "\\n")\n        // \u5c06string\u5199\u6210map\uff0c\u5e76\u8f6c\u6362\u6210json\u8fd4\u56de\n        rr := make(map[string]string)\n        rr["zone"] = result\n        return jsonutils.Marshal(rr), nil\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u5b9e\u73b0tozoneline\u65b9\u6cd5",children:"\u5b9e\u73b0ToZoneLine\u65b9\u6cd5"}),"\n",(0,r.jsx)(n.p,{children:"\u7f16\u8f91 pkg/compute/models/dns_recordsets.go \u6587\u4ef6\uff0c\u5b9e\u73b0\u4e0a\u6587\u7684 ToZoneLine() \u65b9\u6cd5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'// \u5c06\u4e00\u6761dns\u8bb0\u5f55\u8f6c\u6362\u6210zone\u683c\u5f0f\uff0c\u8fd4\u56destring\nfunc (self *SDnsRecordSet) ToZoneLine() string {\n        result := self.Name + "\\t" + fmt.Sprint(self.TTL) + "\\tIN\\t" + self.DnsType + "\\t"\n        if self.MxPriority != 0 {\n                result += fmt.Sprint(self.MxPriority) + "\\t"\n        }\n        result += self.DnsValue\n        if self.DnsType == "CNAME" || self.DnsType == "MX" || self.DnsType == "SRV" {\n                result += "."\n        }\n        return result\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"climc\u547d\u4ee4\u7f16\u5199",children:"climc\u547d\u4ee4\u7f16\u5199"}),"\n",(0,r.jsx)(n.p,{children:"\u7f16\u8f91 cmd/climc/shell/compute/dnszone.go \u6587\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'// \u7528\u4e8e\u547d\u4ee4\u884c\u6d4b\u8bd5\nfunc init() {\n        cmd := shell.NewResourceCmd(&modules.DnsZones).WithKeyword("dns-zone")\n    \n        ...\n    \n        // \u6dfb\u52a0dns-zone-exports\u547d\u4ee4\n        cmd.GetWithCustomShow("exports", func(result jsonutils.JSONObject) {\n                // \u5c06 GetDetailsExports \u8fd4\u56de\u7684json\u8f6c\u6362\u6210map\n                rr := make(map[string]string)\n                err := result.Unmarshal(&rr)\n                if err != nil {\n                        log.Errorf("error: %v", err)\n                        return\n                }\n                // \u8f93\u51fa\u7ed3\u679c\n                for _, v := range rr {\n                        fmt.Printf("%s\\n", v)\n                }\n        }, &options.SDnsZoneIdOptions{})\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u6d4b\u8bd5",children:"\u6d4b\u8bd5"}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u91cc\u6ce8\u610f\u7f16\u8bd1\u6700\u65b0\u7684region\u670d\u52a1\u540e\u9700\u8981\u66ff\u6362\u73af\u5883\u4e2d\u7684\u670d\u52a1"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./dev-env#docker-%E9%95%9C%E5%83%8F%E7%BC%96%E8%AF%91%E4%B8%8A%E4%BC%A0",children:"\u5bb9\u5668\u90e8\u7f72"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"./single_service_dev#%E8%AE%A1%E7%AE%97%E6%9C%8D%E5%8A%A1region%E5%88%9D%E5%A7%8B%E5%8C%96",children:"\u624b\u52a8\u90e8\u7f72"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u7f16\u8bd1 climc \u548c region\n$ make cmd/climc cmd/region\n\n# \u6267\u884cclimc\n$ cd cloudpods/_output/bin\n$ ./climc\n\n# \u6d4b\u8bd5\u547d\u4ee4\nclimc> dns-zone-exports <zone id>\n\n# \u9000\u51fa\nclimc> exit\n"})})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>l});var r=s(96540);const t={},o=r.createContext(t);function i(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);