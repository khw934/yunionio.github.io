"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[5729],{3577:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>c,metadata:()=>s,toc:()=>o});var t=n(74848),r=n(28453);const c={sidebar_position:2},l="\u5207\u6362 Influxdb \u5230 VictoriaMetrics",s={id:"operations/monitoring/migrating-to-vm",title:"\u5207\u6362 Influxdb \u5230 VictoriaMetrics",description:"VictoriaMetrics \u76f8\u6bd4\u8f83 Influxdb \u6709\u66f4\u5c11\u7684\u8d44\u6e90\u5360\u7528\u548c\u66f4\u5feb\u7684\u67e5\u8be2\u901f\u5ea6\u3002 \u4ece v3.10.8 \u7248\u672c\u5f00\u59cb\uff0c\u76d1\u63a7\u540e\u7aef TSDB(\u65f6\u5e8f\u6570\u636e\u5e93) \u53ef\u4ee5\u4ece Influxdb \u5207\u6362\u5230 VictoriaMetrics\u3002",source:"@site/docs/operations/monitoring/migrating-to-vm.md",sourceDirName:"operations/monitoring",slug:"/operations/monitoring/migrating-to-vm",permalink:"/operations/monitoring/migrating-to-vm",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/operations/monitoring/migrating-to-vm.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"\u76d1\u63a7\u8fd0\u7ef4",permalink:"/operations/monitoring/"},next:{title:"\u9690\u85cf\u529f\u80fd\u914d\u7f6e",permalink:"/operations/hidden-feature-config"}},d={},o=[{value:"\u90e8\u7f72 VictoriaMetrics",id:"\u90e8\u7f72-victoriametrics",level:2},{value:"\u5207\u6362",id:"\u5207\u6362",level:2},{value:"\u7981\u7528 operator \u7ba1\u7406 influxdb \u670d\u52a1",id:"\u7981\u7528-operator-\u7ba1\u7406-influxdb-\u670d\u52a1",level:3},{value:"\u5220\u9664 influxdb \u5728\u5e73\u53f0\u7684\u6ce8\u518c\u5730\u5740",id:"\u5220\u9664-influxdb-\u5728\u5e73\u53f0\u7684\u6ce8\u518c\u5730\u5740",level:3},{value:"\u91cd\u542f\u5e73\u53f0\u670d\u52a1",id:"\u91cd\u542f\u5e73\u53f0\u670d\u52a1",level:3},{value:"\u8fc1\u79fb Influxdb \u76d1\u63a7\u6570\u636e\uff08\u53ef\u9009\uff09",id:"\u8fc1\u79fb-influxdb-\u76d1\u63a7\u6570\u636e\u53ef\u9009",level:2},{value:"\u4e0b\u8f7d vmctl \u8fc1\u79fb\u5de5\u5177",id:"\u4e0b\u8f7d-vmctl-\u8fc1\u79fb\u5de5\u5177",level:3},{value:"\u8fc1\u79fb\u6570\u636e",id:"\u8fc1\u79fb\u6570\u636e",level:3},{value:"\u5220\u9664 influxdb \u670d\u52a1",id:"\u5220\u9664-influxdb-\u670d\u52a1",level:2},{value:"\u8bbf\u95ee VictoriaMetrics \u524d\u7aef",id:"\u8bbf\u95ee-victoriametrics-\u524d\u7aef",level:2}];function a(e){const i={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.h1,{id:"\u5207\u6362-influxdb-\u5230-victoriametrics",children:"\u5207\u6362 Influxdb \u5230 VictoriaMetrics"}),"\n",(0,t.jsx)(i.p,{children:"VictoriaMetrics \u76f8\u6bd4\u8f83 Influxdb \u6709\u66f4\u5c11\u7684\u8d44\u6e90\u5360\u7528\u548c\u66f4\u5feb\u7684\u67e5\u8be2\u901f\u5ea6\u3002 \u4ece v3.10.8 \u7248\u672c\u5f00\u59cb\uff0c\u76d1\u63a7\u540e\u7aef TSDB(\u65f6\u5e8f\u6570\u636e\u5e93) \u53ef\u4ee5\u4ece Influxdb \u5207\u6362\u5230 VictoriaMetrics\u3002"}),"\n",(0,t.jsx)(i.admonition,{type:"tip",children:(0,t.jsx)(i.p,{children:"\u6211\u4eec\u5c06\u5728 3.11 \u7248\u672c\u9ed8\u8ba4\u4f7f\u7528 VictoriaMetrics \u4f5c\u4e3a TSDB\u3002\n\u6240\u4ee5\u4e0b\u9762\u7684\u64cd\u4f5c\u53ea\u5bf9 3.11 \u4e4b\u524d\u7684\u7248\u672c\u751f\u6548\u3002"})}),"\n",(0,t.jsx)(i.h2,{id:"\u90e8\u7f72-victoriametrics",children:"\u90e8\u7f72 VictoriaMetrics"}),"\n",(0,t.jsx)(i.p,{children:"\u53ea\u8981\u5347\u7ea7\u5230 v3.10.8\uff0c\u4f7f\u7528 ocboot \u90e8\u7f72\u7684 kubernetes \u96c6\u7fa4\u91cc\u9762\u5c31\u4f1a\u81ea\u52a8\u90e8\u7f72\u597d VictoriaMetrics \u670d\u52a1\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b pod \u8fd0\u884c\u60c5\u51b5\uff1a"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ kubectl get pods -n onecloud | grep victoria\ndefault-victoria-metrics-6d6fcc68d5-q68mj            1/1     Running            0          25d\n"})}),"\n",(0,t.jsxs)(i.p,{children:["\u5982\u679c ",(0,t.jsx)(i.code,{children:"default-victoria-metrics-"})," \u5f00\u5934\u7684 pod \u72b6\u6001\u4e3a Running\uff0c\u5219\u8868\u793a VictoriaMetrics \u670d\u52a1\u90e8\u7f72\u5b8c\u6210\u3002"]}),"\n",(0,t.jsx)(i.h2,{id:"\u5207\u6362",children:"\u5207\u6362"}),"\n",(0,t.jsx)(i.p,{children:"\u73b0\u5728\u96c6\u7fa4\u91cc\u9762\u540c\u65f6\u5b58\u5728 Influxdb \u548c VictoriaMetrics \u670d\u52a1\uff0c\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b pod \u8fd0\u884c\u60c5\u51b5\uff1a"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ kubectl get pods -n onecloud | egrep 'victoria|influxdb'\ndefault-influxdb-5dcfc8964d-5csrw                    1/1     Running            0          23d\ndefault-victoria-metrics-6d6fcc68d5-q68mj            1/1     Running            0          25d\n"})}),"\n",(0,t.jsx)(i.p,{children:"\u73b0\u5728\u901a\u8fc7\u4e0b\u9762\u7684\u6b65\u9aa4\u8ba9\u5e73\u53f0\u4f7f\u7528 VictoriaMetrics \u4f5c\u4e3a\u9ed8\u8ba4 TSDB\u3002"}),"\n",(0,t.jsx)(i.h3,{id:"\u7981\u7528-operator-\u7ba1\u7406-influxdb-\u670d\u52a1",children:"\u7981\u7528 operator \u7ba1\u7406 influxdb \u670d\u52a1"}),"\n",(0,t.jsx)(i.p,{children:"\u9996\u5148\u7981\u7528 operator \u670d\u52a1\u5bf9 influxdb \u7684\u7ba1\u7406\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ kubectl patch onecloudcluster -n onecloud default --type='json' -p='[{op: replace, path: /spec/influxdb/disable, value: true}]'\n"})}),"\n",(0,t.jsx)(i.h3,{id:"\u5220\u9664-influxdb-\u5728\u5e73\u53f0\u7684\u6ce8\u518c\u5730\u5740",children:"\u5220\u9664 influxdb \u5728\u5e73\u53f0\u7684\u6ce8\u518c\u5730\u5740"}),"\n",(0,t.jsx)(i.p,{children:"\u7136\u540e\u5220\u9664\u5e73\u53f0\u91cc\u9762\u7684 influxdb endpoint\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ climc endpoint-list --service influxdb | awk '{print $2}' | xargs -I {} sh -c 'climc endpoint-update --disable {} && climc endpoint-delete {}'\n"})}),"\n",(0,t.jsx)(i.p,{children:"\u5220\u9664\u5e73\u53f0\u7684 influxdb service\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ climc service-update --disabled influxdb && climc service-delete influxdb\n"})}),"\n",(0,t.jsx)(i.h3,{id:"\u91cd\u542f\u5e73\u53f0\u670d\u52a1",children:"\u91cd\u542f\u5e73\u53f0\u670d\u52a1"}),"\n",(0,t.jsxs)(i.p,{children:["\u5f53\u5e73\u53f0\u91cc\u9762\u53ea\u6709 ",(0,t.jsx)(i.code,{children:"victoria-metrics"})," \u7684 endpoint \u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u81ea\u52a8\u4f7f\u7528 endpoint \u5bf9\u5e94\u7684 VictoriaMetrics \u4f5c\u4e3a TSDB \u540e\u7aef\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b VictoriaMetrics \u5728\u5e73\u53f0\u6ce8\u518c\u7684 endpoint\uff1a"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ climc endpoint-list --search victoria-metrics --details\n"})}),"\n",(0,t.jsxs)(i.admonition,{type:"warning",children:[(0,t.jsx)(i.p,{children:"\u8fd9\u91cc\u4e00\u5b9a\u8981\u786e\u4fdd endpoint \u6ca1\u6709 infludb \u7c7b\u578b\u7684\u5730\u5740\uff0c\u5426\u5219\u5e73\u53f0\u4f1a\u9ed8\u8ba4\u4f18\u5148\u4f7f\u7528 influxdb \u4f5c\u4e3a\u540e\u7aef TSDB\u3002\n\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u6709\u6ca1\u6709 influxdb \u7c7b\u578b\u7684 endpoint\u3002"}),(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ climc endpoint-list --search influxdb --details\n"})})]}),"\n",(0,t.jsx)(i.p,{children:"\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u91cd\u542f\u4f1a\u8fde\u63a5 TSDB \u7684\u5e73\u53f0\u670d\u52a1\uff1a"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ kubectl get deployment -n onecloud | egrep 'region|monitor|meter|cloudmon|suggestion' | awk '{print $1}' | xargs kubectl rollout restart deployment -n onecloud\n"})}),"\n",(0,t.jsx)(i.p,{children:"\u91cd\u542f host \u670d\u52a1\uff0c(\u5982\u679c\u662f\u591a\u4e91\u7ba1\u7406\u7248\u672c\uff0c\u4e0d\u7528\u6267\u884c\u6b64\u6b65\u9aa4) \uff1a"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ kubectl -n onecloud rollout restart daemonset default-host\n"})}),"\n",(0,t.jsx)(i.p,{children:"\u6700\u540e\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b monitor \u670d\u52a1\u662f\u5426\u4f7f\u7528 VictoriaMetrics \u4f5c\u4e3a\u540e\u7aef TSDB\uff1a"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ kubectl logs -n onecloud $(kubectl get pods -n onecloud | grep monitor | awk '{print $1}') | grep 'TSDB data source'\n"})}),"\n",(0,t.jsx)(i.p,{children:"\u5982\u679c\u51fa\u73b0\u4e0b\u9762\u7684\u65e5\u5fd7\uff0c\u5219\u8bf4\u660e monitor \u670d\u52a1\u5df2\u7ecf\u6210\u529f\u4f7f\u7528 VictoriaMetrics \u4f5c\u4e3a\u540e\u7aef TSDB\u3002"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:'[info 2023-12-04 07:01:53 datasource.(*dataSourceManager).setDataSource(datasource.go:116)] set TSDB data source "victoria-metrics": "https://default-victoria-metrics:30428"\n'})}),"\n",(0,t.jsx)(i.h2,{id:"\u8fc1\u79fb-influxdb-\u76d1\u63a7\u6570\u636e\u53ef\u9009",children:"\u8fc1\u79fb Influxdb \u76d1\u63a7\u6570\u636e\uff08\u53ef\u9009\uff09"}),"\n",(0,t.jsxs)(i.admonition,{type:"tip",children:[(0,t.jsx)(i.p,{children:"\u5982\u679c\u4e4b\u524d\u5728 Influxdb \u91cc\u9762\u7684\u76d1\u63a7\u6570\u636e\u4e0d\u91cd\u8981\uff0c\u53ef\u4ee5\u4e0d\u505a\u6570\u636e\u7684\u8fc1\u79fb\u3002\u4e0b\u9762\u7684\u64cd\u4f5c\u9002\u7528\u4e8e\u60f3\u8981\u628a Influxdb \u5386\u53f2\u76d1\u63a7\u6570\u636e\u8fc1\u79fb\u5230 VictoriaMetrics \u7684\u73af\u5883\u3002"}),(0,t.jsx)(i.p,{children:"\u53e6\u5916\u8fc1\u79fb\u6570\u636e\u5fc5\u987b\u4fdd\u8bc1 Influxdb \u548c VictoriaMetrics \u4e24\u4e2a\u670d\u52a1\u540c\u65f6\u8fd0\u884c\u3002"})]}),"\n",(0,t.jsx)(i.h3,{id:"\u4e0b\u8f7d-vmctl-\u8fc1\u79fb\u5de5\u5177",children:"\u4e0b\u8f7d vmctl \u8fc1\u79fb\u5de5\u5177"}),"\n",(0,t.jsx)(i.p,{children:"\u4e3b\u8981\u662f\u4e0b\u8f7d vmctl \u5de5\u5177\uff0c\u7528\u4e8e\u628a Influxdb \u7684\u5386\u53f2\u6570\u636e\u5bfc\u5165\u5230 VictoriaMetrics\uff0c\u8bf7\u6839\u636e\u81ea\u5df1\u7684\u73af\u5883\u4e0b\u8f7d\u5bf9\u5e94\u7684\u7248\u672c\uff0c\u4e0b\u8f7d\u5730\u5740\u5982\u4e0b\uff1a"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["x86_64: ",(0,t.jsx)(i.a,{href:"https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-amd64",children:"https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-amd64"})]}),"\n",(0,t.jsxs)(i.li,{children:["arm64: ",(0,t.jsx)(i.a,{href:"https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-arm64",children:"https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-arm64"})]}),"\n"]}),"\n",(0,t.jsx)(i.p,{children:"\u4e0b\u9762\u4ee5 x86_64 \u73af\u5883\u4e3e\u4f8b\uff1a"}),"\n",(0,t.jsx)(i.admonition,{type:"tip",children:(0,t.jsx)(i.p,{children:"\u4ee5\u4e0b\u7684\u6240\u6709\u547d\u4ee4\u90fd\u662f\u767b\u5f55\u5230\u5e73\u53f0\u7684\u63a7\u5236\u8282\u70b9\u4e0a\u6267\u884c\u3002"})}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"# \u4e0b\u8f7d vmctl-linux-amd64 \u5de5\u5177\n$ wget https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-amd64\n\n# \u6dfb\u52a0\u53ef\u6267\u884c\u6743\u9650\n$ chmod a+x ./vmctl-linux-amd64\n\n# \u653e\u5230 /opt/yunion/bin \u76ee\u5f55\n$ mv ./vmctl-linux-amd64 /opt/yunion/bin\n"})}),"\n",(0,t.jsx)(i.h3,{id:"\u8fc1\u79fb\u6570\u636e",children:"\u8fc1\u79fb\u6570\u636e"}),"\n",(0,t.jsx)(i.p,{children:"\u7f16\u5199\u4e0b\u9762\u7684\u8fc1\u79fb\u811a\u672c\uff0c\u5047\u8bbe\u63a7\u5236\u8282\u70b9\u7684 ip \u4e3a 192.168.222.171\uff0c\u90a3\u4e48\u73af\u5883\u4e2d Influxdb \u548c VictoriaMetrics \u670d\u52a1\u7684\u5730\u5740\u5c31\u4e3a\uff1a"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:["Influxdb: ",(0,t.jsx)(i.a,{href:"https://192.168.222.171:30086",children:"https://192.168.222.171:30086"})]}),"\n",(0,t.jsxs)(i.li,{children:["VictoriaMetrics: ",(0,t.jsx)(i.a,{href:"https://192.168.222.171:30428",children:"https://192.168.222.171:30428"})]}),"\n"]}),"\n",(0,t.jsxs)(i.p,{children:["\u5c06\u4e0b\u9762\u7684 shell \u811a\u672c\u4fdd\u5b58\u5230 ",(0,t.jsx)(i.code,{children:"./vm-mig.sh"})," \u6587\u4ef6\u3002"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"#!/bin/bash\n\n# \u6307\u5b9a Influxdb \u548c VictoriaMetrics \u7684\u670d\u52a1\u5730\u5740\nIP=192.168.222.171\nVM_URL=\"https://$IP:30428\"\nINFLUX_URL=\"https://$IP:30086\"\n\n# \u6307\u5b9a\u8981\u8fc1\u79fb Influxdb \u8fc1\u79fb\u6570\u636e\u7684\u8d77\u59cb\u65f6\u95f4\u6bb5\nSTART_TIME='2023-11-10T00:00:00Z'\nEND_TIME='2023-12-10T00:00:00Z'\n\n/opt/yunion/bin/vmctl-linux-amd64 influx -s \\\n        --influx-retention-policy 30day_only \\\n        --influx-addr $INFLUX_URL --influx-database telegraf \\\n        --influx-concurrency 4 \\\n        --influx-filter-time-start $START_TIME \\\n        --influx-filter-time-end $END_TIME \\\n        --vm-addr $VM_URL\n"})}),"\n",(0,t.jsx)(i.p,{children:"\u6700\u540e\u6267\u884c\u8fc1\u79fb\u811a\u672c\uff0c\u8fc1\u79fb\u65f6\u95f4\u7684\u957f\u77ed\u53d6\u51b3\u4e8e Influxdb \u91cc\u9762\u7684\u6570\u636e\u91cf\u3002"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ bash -x ./vm-mig.sh\n"})}),"\n",(0,t.jsx)(i.h2,{id:"\u5220\u9664-influxdb-\u670d\u52a1",children:"\u5220\u9664 influxdb \u670d\u52a1"}),"\n",(0,t.jsx)(i.p,{children:"\u4f7f\u7528 VictoriaMetrics \u4f5c\u4e3a TSDB \u540e\uff0c\u5c31\u53ef\u4ee5\u5220\u9664 Influxdb \u670d\u52a1\u4e86\uff0c\u64cd\u4f5c\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-bash",children:"$ kubectl delete deployment -n onecloud default-influxdb\n"})}),"\n",(0,t.jsx)(i.h2,{id:"\u8bbf\u95ee-victoriametrics-\u524d\u7aef",children:"\u8bbf\u95ee VictoriaMetrics \u524d\u7aef"}),"\n",(0,t.jsxs)(i.p,{children:["\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7 ",(0,t.jsx)(i.code,{children:"https://\u63a7\u5236\u8282\u70b9IP:30428/vmui/"})," \u8bbf\u95ee VictoriaMetrics \u524d\u7aef web \u754c\u9762\uff0c\u53ef\u4ee5\u67e5\u770b\u4e0b\u6570\u636e\u662f\u5426\u6709\u4e0a\u62a5\u4e0a\u6765\u3002"]}),"\n",(0,t.jsxs)(i.p,{children:["\u5177\u4f53\u4f7f\u7528\u65b9\u5f0f\u53ef\u4ee5\u53c2\u8003\u6587\u6863\uff1a",(0,t.jsx)(i.a,{href:"/development/monitor/query#query-victoric-metrics-data",children:"\u67e5\u8be2 VictoriaMetrics \u6570\u636e"}),"\u3002"]})]})}function u(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},28453:(e,i,n)=>{n.d(i,{R:()=>l,x:()=>s});var t=n(96540);const r={},c=t.createContext(r);function l(e){const i=t.useContext(c);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function s(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(c.Provider,{value:i},e.children)}}}]);