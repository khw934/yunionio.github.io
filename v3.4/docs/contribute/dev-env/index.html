<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/v3.4/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/v3.4/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/v3.4/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/v3.4/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/v3.4/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/v3.4/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/v3.4/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/v3.4/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/v3.4/favicons/android-192x192.png sizes=192x192><title>搭建开发环境 | 云联壹云</title><meta property="og:title" content="搭建开发环境"><meta property="og:description" content="介绍如何搭建开发环境，编译和部署相关组件
"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cloudpods.org/v3.4/docs/contribute/dev-env/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2021-06-29T21:14:36+08:00"><meta property="og:site_name" content="云联壹云"><meta itemprop=name content="搭建开发环境"><meta itemprop=description content="介绍如何搭建开发环境，编译和部署相关组件
"><meta itemprop=dateModified content="2021-06-29T21:14:36+08:00"><meta itemprop=wordCount content="1222"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="搭建开发环境"><meta name=twitter:description content="介绍如何搭建开发环境，编译和部署相关组件
"><link rel=preload href=/v3.4/scss/main.min.7922bf78d159b48b339c1bb63cb6c8dc7aaccc12d1af3ff68a146bd3a6a06db3.css as=style><link href=/v3.4/scss/main.min.7922bf78d159b48b339c1bb63cb6c8dc7aaccc12d1af3ff68a146bd3a6a06db3.css rel=stylesheet integrity><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/fuse.js@6.4.3></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a href=/v3.4/ class="logo flex-shrink-0 navbar-brand"><img src=https://www.cloudpods.org/v3.4/images/logo.svg></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>v3.4</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>v3.7 (latest)</a>
<a class=dropdown-item href=/v3.6>v3.6</a>
<a class=dropdown-item href=/v3.4>v3.4</a>
<a class=dropdown-item href=/v3.3>v3.3</a>
<a class=dropdown-item href=/v3.2>v3.2</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/v3.4/docs/quickstart/><span>快速开始</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/v3.4/docs/><span class=active>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/v3.4/blog/><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/yunionio/onecloud target=_blank><span>Github</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/v3.4/docs/changelog><span>CHANGELOG</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/v3.4/docs/contact><span>联系我们</span></a></li></ul></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/v3.4/offline-search-index.311fecb3da58a7a05f9dd4e94bdddad6.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a></li><ul><li class="collapse show" id=v34docs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/quickstart/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">快速开始</a></li><ul><li class=collapse id=v34docsquickstart><a class="td-sidebar-link td-sidebar-link__page" id=m-v34docsquickstartallinone href=/v3.4/docs/quickstart/allinone/>All in One 安装</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docsquickstartminikube href=/v3.4/docs/quickstart/minikube/>MiniKube 安装</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/setup/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">安装部署</a></li><ul><li class=collapse id=v34docssetup><a class="td-sidebar-link td-sidebar-link__page" id=m-v34docssetupintro href=/v3.4/docs/setup/intro/>组件概览</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docssetupcontrolplane-ha href=/v3.4/docs/setup/controlplane-ha/>部署 HA 环境</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docssetupdb-ha href=/v3.4/docs/setup/db-ha/>部署 DB HA 环境</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docssetupcontrolplane href=/v3.4/docs/setup/controlplane/>部署集群</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docssetupcomponents href=/v3.4/docs/setup/components/>添加 K8S 节点</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docssetuphost href=/v3.4/docs/setup/host/>添加计算节点</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docssetupbaremetal href=/v3.4/docs/setup/baremetal/>物理机管理服务</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docssetupce-ee-switch href=/v3.4/docs/setup/ce-ee-switch/>切换到企业版</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docssetupupgrade href=/v3.4/docs/setup/upgrade/>升级相关</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/contribute/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">开发相关</a></li><ul><li class="collapse show" id=v34docscontribute><a class="td-sidebar-link td-sidebar-link__page active" id=m-v34docscontributedev-env href=/v3.4/docs/contribute/dev-env/>搭建开发环境</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docscontributecontrib href=/v3.4/docs/contribute/contrib/>提交贡献代码</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docscontributegit-convention href=/v3.4/docs/contribute/git-convention/>Git 提交内容规范</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docscontributeservices href=/v3.4/docs/contribute/services/>服务组件介绍</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docscontributeframework href=/v3.4/docs/contribute/framework/>后端服务框架</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docscontributeoperator-intro href=/v3.4/docs/contribute/operator-intro/>Operator 相关</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">操作管理</a></li><ul><li class=collapse id=v34docshowto><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/climc/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">命令行工具</a></li><ul><li class=collapse id=v34docshowtoclimc></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/image/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">镜像</a></li><ul><li class=collapse id=v34docshowtoimage><a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoimageupload href=/v3.4/docs/howto/image/upload/>上传镜像</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoimagequery href=/v3.4/docs/howto/image/query/>查询镜像</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoimagecreate href=/v3.4/docs/howto/image/create/>制作镜像</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoimageoperation href=/v3.4/docs/howto/image/operation/>其他操作</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/server/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云主机</a></li><ul><li class=collapse id=v34docshowtoserver><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/server/create/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">创建云主机</a></li><ul><li class=collapse id=v34docshowtoservercreate></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoserverconnect href=/v3.4/docs/howto/server/connect/>登录云主机</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoserverothers href=/v3.4/docs/howto/server/others/>其他操作</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoserverimport href=/v3.4/docs/howto/server/import/>libvirt管理虚机导入</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoservergpu href=/v3.4/docs/howto/server/gpu/>GPU相关</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoservermigrate href=/v3.4/docs/howto/server/migrate/>迁移相关</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtoserverbackup href=/v3.4/docs/howto/server/backup/>主备机</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/host/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">宿主机</a></li><ul><li class=collapse id=v34docshowtohost><a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtohostkvm href=/v3.4/docs/howto/host/kvm/>KVM 宿主机</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/baremetal/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">物理机</a></li><ul><li class=collapse id=v34docshowtobaremetal><a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtobaremetalintro href=/v3.4/docs/howto/baremetal/intro/>介绍</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtobaremetaloperator href=/v3.4/docs/howto/baremetal/operator/>操作相关</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/network/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">网络</a></li><ul><li class=collapse id=v34docshowtonetwork></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/lb/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">负载均衡</a></li><ul><li class=collapse id=v34docshowtolb></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/storage/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">存储</a></li><ul><li class=collapse id=v34docshowtostorage></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/multicloud/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">多云管理</a></li><ul><li class=collapse id=v34docshowtomulticloud><a class="td-sidebar-link td-sidebar-link__page" id=m-v34docshowtomulticloudcloudaccount href=/v3.4/docs/howto/multicloud/cloudaccount/>云账号</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/auth/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">认证与权限</a></li><ul><li class=collapse id=v34docshowtoauth></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/container/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">容器集群</a></li><ul><li class=collapse id=v34docshowtocontainer></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/howto/scheduler/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">资源调度</a></li><ul><li class=collapse id=v34docshowtoscheduler></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/contact/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">联系我们</a></li><ul><li class=collapse id=v34docscontact></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/changelog/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">CHANGELOG</a></li><ul><li class=collapse id=v34docschangelog><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/changelog/release-3.4/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">release/3.4</a></li><ul><li class=collapse id=v34docschangelogrelease-34><a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-12 href=/v3.4/docs/changelog/release-3.4/3-4-12/>v3.4.12</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-11 href=/v3.4/docs/changelog/release-3.4/3-4-11/>v3.4.11</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-10 href=/v3.4/docs/changelog/release-3.4/3-4-10/>v3.4.10</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-9 href=/v3.4/docs/changelog/release-3.4/3-4-9/>v3.4.9</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-8 href=/v3.4/docs/changelog/release-3.4/3-4-8/>v3.4.8</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-7 href=/v3.4/docs/changelog/release-3.4/3-4-7/>v3.4.7</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-6 href=/v3.4/docs/changelog/release-3.4/3-4-6/>v3.4.6</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-5 href=/v3.4/docs/changelog/release-3.4/3-4-5/>v3.4.5</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-4 href=/v3.4/docs/changelog/release-3.4/3-4-4/>v3.4.4</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-3 href=/v3.4/docs/changelog/release-3.4/3-4-3/>v3.4.3</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-2 href=/v3.4/docs/changelog/release-3.4/3-4-2/>v3.4.2</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-1 href=/v3.4/docs/changelog/release-3.4/3-4-1/>v3.4.1</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-343-4-0 href=/v3.4/docs/changelog/release-3.4/3-4-0/>v3.4.0</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/changelog/release-3.3/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">release/3.3</a></li><ul><li class=collapse id=v34docschangelogrelease-33><a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-333-3-8 href=/v3.4/docs/changelog/release-3.3/3-3-8/>v3.3.8</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-333-3-7 href=/v3.4/docs/changelog/release-3.3/3-3-7/>v3.3.7</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-333-3-6 href=/v3.4/docs/changelog/release-3.3/3-3-6/>v3.3.6</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-333-3-5 href=/v3.4/docs/changelog/release-3.3/3-3-5/>v3.3.5</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-333-3-4 href=/v3.4/docs/changelog/release-3.3/3-3-4/>v3.3.4</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-333-3-3 href=/v3.4/docs/changelog/release-3.3/3-3-3/>v3.3.3</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-333-3-2 href=/v3.4/docs/changelog/release-3.3/3-3-2/>v3.3.2</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-333-3-1 href=/v3.4/docs/changelog/release-3.3/3-3-1/>v3.3.1</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v34docschangelogrelease-333-3-0 href=/v3.4/docs/changelog/release-3.3/3-3-0/>v3.3.0</a></li></ul></ul></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.4/docs/roadmap/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">ROADMAP</a></li><ul><li class=collapse id=v34docsroadmap></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/yunionio/docs/edit/master/content/zh/docs/contribute/dev-env.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/yunionio/docs/new/master/content/zh/docs/contribute/dev-env.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/yunionio/docs/issues/new?title=%e6%90%ad%e5%bb%ba%e5%bc%80%e5%8f%91%e7%8e%af%e5%a2%83" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a href=https://github.com/yunionio/onecloud/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a></div><nav id=TableOfContents><ul><li><a href=#部署云联壹云服务>部署云联壹云服务</a></li><li><a href=#安装-go>安装 Go</a></li><li><a href=#安装配置-docker>安装配置 Docker</a><ul><li><a href=#安装-docker>安装 Docker</a></li><li><a href=#配置-docker>配置 Docker</a></li></ul></li><li><a href=#编译-云联壹云-组件>编译 云联壹云 组件</a><ul><li><a href=#fork-仓库>Fork 仓库</a></li><li><a href=#clone-源码>Clone 源码</a></li><li><a href=#二进制编译>二进制编译</a></li><li><a href=#docker-镜像编译上传>Docker 镜像编译上传</a></li></ul></li><li><a href=#开发调试>开发调试</a><ul><li><a href=#将镜像发布到-kubernetes-集群>将镜像发布到 Kubernetes 集群</a></li><li><a href=#查看服务输出日志>查看服务输出日志</a></li><li><a href=#安装配置-climc>安装配置 climc</a></li></ul></li><li><a href=#快速开发调试>快速开发调试</a><ul><li><a href=#安装配置-kubectl>安装配置 kubectl</a></li><li><a href=#安装-telepresence>安装 telepresence</a></li><li><a href=#使用>使用</a></li></ul></li><li><a href=#faq>FAQ</a><ul><li><a href=#1-开发环境是-windows-或者-macos怎么开发>1. 开发环境是 windows 或者 macOS，怎么开发？</a></li><li><a href=#2-本地调试启动-region-服务报以下错误>2. 本地调试启动 region 服务，报以下错误</a></li><li><a href=#3-使用-telepresence-时上次未正常退出再次使用一直报错>3. 使用 telepresence 时，上次未正常退出，再次使用一直报错</a></li><li><a href=#4-本地直接运行-make-cmdhost-会出现-ceph-依赖的报错>4. 本地直接运行 <code>make cmd/host</code> 会出现 ceph 依赖的报错</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://www.cloudpods.org/v3.4/docs/>文档</a></li><li class=breadcrumb-item><a href=https://www.cloudpods.org/v3.4/docs/contribute/>开发相关</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://www.cloudpods.org/v3.4/docs/contribute/dev-env/>搭建开发环境</a></li></ol></nav><div class=td-content><h1>搭建开发环境</h1><div class=lead>介绍如何搭建开发环境，编译和部署相关组件</div><div class="alert alert-primary" role=alert><h4 class=alert-heading>说明</h4><ul><li>服务是以容器的方式运行在 Kubernetes(K8S) 集群里面的，所以开发调试需要部署一个 Kubernetes 集群</li><li>后端服务都是用 Golang 编写，所以需要在开发环境安装 Golang</li><li>为了把开发的服务发布到 Kubernetes 集群，需要在本地把相关服务构建成 docker 镜像</li><li>开发环境最好都是在 Linux 上进行，安装使用 docker 和编译源码都很方便</li></ul></div><p>接下来介绍如何搭建开发环境。</p><h2 id=部署云联壹云服务>部署云联壹云服务</h2><p>在开始开发之前，请先参考 <a href=../../quickstart/allinone>All in One 安装</a> 或者 <a href=../../quickstart/minikube>MiniKube 安装</a> 部署云联壹云服务。我们的服务全部使用容器的方式运行在 Kubernetes 集群里面，所以需要先搭建好我们的服务，把这个环境作为自己的开发环境。</p><p>这里建议使用一个单独的 CentOS 7 虚拟机，配置(至少 4C8G + 100G 系统盘)，安装部署我们的服务。</p><h2 id=安装-go>安装 Go</h2><p>Golang 版本要求 1.15 以上</p><p>安装 Golang 环境请参考： <a href=https://golang.org/doc/install>Install Golang</a></p><h2 id=安装配置-docker>安装配置 Docker</h2><p>因为要把服务打包成容器镜像，所以需要先安装 docker，这里的 docker 版本需要是 docker-ce 19.03 以上的版本。</p><p>下面是不同操作系统和 Linux 发行版的安装方式，这里还是建议开发环境是 Linux 。</p><h3 id=安装-docker>安装 Docker</h3><ul class="nav nav-tabs" id=docker_install role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#docker_install-0 role=tab aria-controls=docker_install-0 aria-selected=true>CentOS 7</a></li></ul><div class=tab-content id=docker_install><div id=docker_install-0 class="tab-pane show active" role=tabpanel aria-labelledby=docker_install-0><p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 1. 安装必要的一些系统工具</span>
sudo yum install -y yum-utils
<span style=color:#8f5902;font-style:italic># 2. 添加软件源信息</span>
sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span style=color:#8f5902;font-style:italic># 3. 更新并安装 Docker CE</span>
sudo yum -y install docker-ce
</code></pre></div></div></div><h3 id=配置-docker>配置 Docker</h3><p>后续的代码编译和打包使用了 <a href=https://github.com/docker/buildx/>docker buildx</a> 的功能，需要做在让 docker daemon 开启 experimental 特性。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 在 docker daemon 的配置里面打开 experimental 特性</span>
$ cat /etc/docker/daemon.json
<span style=color:#ce5c00;font-weight:700>{</span>
  <span style=color:#4e9a06>&#34;experimental&#34;</span>: <span style=color:#204a87>true</span>
<span style=color:#ce5c00;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic># 重启 docker 服务</span>
$ systemctl restart docker

<span style=color:#8f5902;font-style:italic># 创建 buildx context</span>
$ docker buildx create --use --name build --node build --driver-opt <span style=color:#000>network</span><span style=color:#ce5c00;font-weight:700>=</span>host
</code></pre></div><h2 id=编译-云联壹云-组件>编译 云联壹云 组件</h2><h3 id=fork-仓库>Fork 仓库</h3><p>访问 <a href=https://github.com/yunionio/onecloud>https://github.com/yunionio/onecloud</a> ，将仓库 fork 到自己的 github 用户下。</p><h3 id=clone-源码>Clone 源码</h3><p>git clone 前确保 GOPATH 等环境变量已经设置好，clone 你自己 fork 的仓库</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ git clone https://github.com/&lt;your_name&gt;/onecloud <span style=color:#000>$GOPATH</span>/src/yunion.io/x/onecloud
$ <span style=color:#204a87>cd</span> <span style=color:#000>$GOPATH</span>/src/yunion.io/x/onecloud
$ git remote add upstream https://github.com/yunionio/onecloud
</code></pre></div><h3 id=二进制编译>二进制编译</h3><p>编译是直接调用 go 编译器在本地编译出二进制，对应的 Makefile 规则为 <code>make cmd/%</code> ，<code>%</code> 对应的是 <code>cmd</code> 目录里面的组件名称。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#8f5902;font-style:italic># cmd 目录下面存放着所有的组件:</span>
$ ls cmd
...
ansibleserver    climc      glance      keystone  qcloudcli     ucloudcli
awscli           cloudir    host        lbagent   region        webconsole

<span style=color:#8f5902;font-style:italic># 可以编译cmd下指定的组件，比如：编译 climc 和 region 组件</span>
$ make cmd/climc cmd/region

<span style=color:#8f5902;font-style:italic># 编译好的二进制会直接在 _output/bin 目录下面，查看编译好的二进制文件</span>
$ ls _output/bin
climc region

<span style=color:#8f5902;font-style:italic># 编译所有组件</span>
$ make
</code></pre></div><h3 id=docker-镜像编译上传>Docker 镜像编译上传</h3><p>通常我们的开发流程是写完代码，把相应服务打包生成 docker 镜像，然后发布到自己搭建的 Kubernetes 集群里面测试。
下面说明如何生成 docker 镜像。</p><p>生成好的 docker 镜像需要上传的镜像仓库，这里以 <a href=https://cn.aliyun.com/product/acr>Aliyun 的容器镜像服务</a> 为例，比如我在 aliyun 创建了一个公开的命令空间，仓库地址为: <code>registry.cn-beijing.aliyuncs.com/zexi</code> 。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 在本地登录镜像仓库，这里以你自己的镜像仓库为准</span>
<span style=color:#8f5902;font-style:italic># 需要先用自己的 aliyun 帐号登录下，后面容器镜像的上传就不需要密码了</span>
$ docker login registry.cn-beijing.aliyuncs.com/zexi
......
Login Succeeded
</code></pre></div><p>准备好镜像仓库后，就可以开始打包上传镜像了，这些步骤是通过 Makefile 的 image 规则来执行的。</p><p>这里有以下环境变量用来控制制作镜像的内容：</p><ul><li>REGISTRY: 对应镜像上传的仓库</li><li>VERSION: 用于生成镜像的 tag</li><li>ARCH: 对应 docker 镜像的 arch，可设置成 &lsquo;arm64&rsquo; 或者 &lsquo;all&rsquo;<ul><li>arm64: 编译打包制作 arm64 的 docker 镜像</li><li>all: 编译打包制作 amd64 和 arm64 的镜像</li></ul></li><li>DEBUG: 如果设置为 true 会显示打包步骤</li></ul><p>根据 REGISTRY 和 VERSION 这两个环境变量，会生成各个组件的镜像地址，格式是:
<code>$(REGISTRY)/$(component):$VERSION</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 将 region 服务编译并制作成 docker 镜像</span>
<span style=color:#8f5902;font-style:italic># 然后上传到 registry.cn-beijing.aliyuncs.com/zexi/region:dev</span>
$ <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>dev <span style=color:#000>REGISTRY</span><span style=color:#ce5c00;font-weight:700>=</span>registry.cn-beijing.aliyuncs.com/zexi make image region

<span style=color:#8f5902;font-style:italic># 编译多个组件，并上传，以下命令会上传以下的组件</span>
<span style=color:#8f5902;font-style:italic># - registry.cn-beijing.aliyuncs.com/zexi/ansibleserver:dev</span>
<span style=color:#8f5902;font-style:italic># - registry.cn-beijing.aliyuncs.com/zexi/apigateway:dev</span>
<span style=color:#8f5902;font-style:italic># - registry.cn-beijing.aliyuncs.com/zexi/region:dev</span>
$ <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>dev <span style=color:#000>REGISTRY</span><span style=color:#ce5c00;font-weight:700>=</span>registry.cn-beijing.aliyuncs.com/zexi make image <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>     ansibleserver apigateway region

<span style=color:#8f5902;font-style:italic># 编译 arm64 的镜像，如果指定了 ARCH=arm64 ，则会在对应镜像的末尾加上 &#39;-arm64&#39; 的后缀</span>
<span style=color:#8f5902;font-style:italic># - registry.cn-beijing.aliyuncs.com/yunionio/scheduler:dev-arm64</span>
$ <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>dev <span style=color:#000>REGISTRY</span><span style=color:#ce5c00;font-weight:700>=</span>registry.cn-beijing.aliyuncs.com/zexi <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span>arm64 make image scheduler

<span style=color:#8f5902;font-style:italic># 编译 amd64 + arm64 的镜像，指定 ARCH=all，这里不会添加后缀，会在镜像名里面包含两个架构的版本</span>
<span style=color:#8f5902;font-style:italic># - registry.cn-beijing.aliyuncs.com/yunionio/cloudid:dev</span>
$ <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>dev <span style=color:#000>REGISTRY</span><span style=color:#ce5c00;font-weight:700>=</span>registry.cn-beijing.aliyuncs.com/zexi <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span>all make image cloudid

<span style=color:#8f5902;font-style:italic># 同时编译多个多架构的组件，并上传</span>
$ <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>dev <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span>all <span style=color:#000>REGISTRY</span><span style=color:#ce5c00;font-weight:700>=</span>registry.cn-beijing.aliyuncs.com/zexi make image <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>     ansibleserver apigateway baremetal-agent climc cloudevent <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>     cloudnet devtool esxi-agent glance host host-deployer keystone <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>     logger notify region s3gateway scheduler webconsole yunionconf <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>     vpcagent monitor region-dns cloudid
</code></pre></div><h2 id=开发调试>开发调试</h2><p>开发调试的通常步骤是，写好代码后，使用之前说的 <a href=#docker-%E9%95%9C%E5%83%8F%E7%BC%96%E8%AF%91%E4%B8%8A%E4%BC%A0>make image</a> 规则打包上传对应服务的 docker 镜像，然后将镜像发布到自己的 Kubernetes 集群进行测试。</p><h3 id=将镜像发布到-kubernetes-集群>将镜像发布到 Kubernetes 集群</h3><p>后端的服务都运行在 Kubernetes 的 onecloud namespace 里面，可以通过以下命令查看对应的 Kubernetes 资源。我们的服务使用以下的 Kubernetes 资源进行服务的管理。</p><ul><li>deployment: 管理大部分的服务，这种服务会在 Kubernetes 的任意一个 master 节点启动，比如: region, apigateway 服务等</li><li>daemonset: 管理需要在每个 Kubernetes 节点都启动的服务，比如: host 服务(私有云计算节点服务)</li></ul><div class="alert alert-primary" role=alert><h4 class=alert-heading>说明</h4><p>另外需要简单了解下 Kubernetes pod 这种资源，pod 是实际运行容器的集合，是 Kubernetes 里面运行容器化服务的最小单元，一个 pod 里面可以运行多个容器，每个容器都有自己对应的镜像。</p><p>其它 Kubernetes 资源介绍可参考官方的 <a href=https://kubernetes.io/zh/docs/concepts/workloads/>工作负载介绍</a>。</p></div><p>下面是使用 kubectl(Kubernetes 命令行工具) 查看各个服务对应资源的命令：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 查看 onecloud 命令空间下面的 deployment</span>
$ kubectl -n onecloud get deployment

<span style=color:#8f5902;font-style:italic># 查看 onecloud 命令空间下面的 daemonset</span>
$ kubectl -n onecloud get daemonset

<span style=color:#8f5902;font-style:italic># 查看 onecloud 命名空间下面的 pods</span>
$ kubectl -n onecloud get pod 
</code></pre></div><p>对 Kubernetes 资源有了大概了解后，接下来的步骤就是把刚才打包的服务镜像发布到集群里面对应的服务，这里以 region 这个服务为例。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 先在本地编译打包 region 镜像</span>
<span style=color:#8f5902;font-style:italic># 会在 aliyun 生成镜像: registry.cn-beijing.aliyuncs.com/zexi/region:dev-test</span>
$ <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>dev-test <span style=color:#000>REGISTRY</span><span style=color:#ce5c00;font-weight:700>=</span>registry.cn-beijing.aliyuncs.com/zexi make image region

<span style=color:#8f5902;font-style:italic># 找到 region 服务对应的 kubernetes 资源名称</span>
$ kubectl get deployment -n onecloud <span style=color:#000;font-weight:700>|</span> grep region
default-region                      1/1     <span style=color:#0000cf;font-weight:700>1</span>            <span style=color:#0000cf;font-weight:700>1</span>           90d

<span style=color:#8f5902;font-style:italic># 更新 default-region deployment 资源里面 image 属性</span>
<span style=color:#8f5902;font-style:italic># 然后对应的 default-region 的 pod 就会自动拉取镜像重启</span>
$ kubectl -n onecloud edit deployment default-region
</code></pre></div><p>使用 <code>kubectl -n onecloud edit deployment default-region</code> 命令后，进入编辑资源 YAML 属性的步骤，只需要将里面的 <code>image</code> 属性修改成 aliyun 对应镜像地址，截图如下：</p><p><img src=../images/kubectl-edit-image.png alt></p><p>修改完后保存退出，就会拉取刚才指定的镜像创建新的 region pod，删除旧的。可以再次查看 region pod 的当前状态。</p><p><img src=../images/kubectl-get-region-pod.png alt></p><h3 id=查看服务输出日志>查看服务输出日志</h3><p>可以使用 <code>kubectl log</code> 命令查看对应 pod 的输出日志，这里以刚才发布的 region pod 为例。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 先找到 region 服务对应的 pod</span>
$ kubectl get pods -n onecloud <span style=color:#000;font-weight:700>|</span> grep region
default-region-6bd8c54d68-sq4gq                     1/1     Running            <span style=color:#0000cf;font-weight:700>0</span>          101m

<span style=color:#8f5902;font-style:italic># 查看日志</span>
$ kubectl logs -n onecloud default-region-6bd8c54d68-sq4gq

<span style=color:#8f5902;font-style:italic># 把日志重定向到文件 /tmp/region.log</span>
$ kubectl logs -n onecloud default-region-6bd8c54d68-sq4gq &gt; /tmp/region.log

<span style=color:#8f5902;font-style:italic># 流式查看日志，类似于 &#39;tail -f&#39;</span>
$ kubectl logs -n onecloud default-region-6bd8c54d68-sq4gq -f

<span style=color:#8f5902;font-style:italic># 查看 5 分钟前的日志</span>
$ kubectl logs -n onecloud default-region-6bd8c54d68-sq4gq -f --since 5m
</code></pre></div><h3 id=安装配置-climc>安装配置 climc</h3><p>climc 是访问后端的命令行工具，可以通过该工具向后端各个服务发送API请求，日常开发中会使用改命令行工具进行功能验证和调试，安装和使用方法参考下面的连接。</p><p>climc 的本地安装参考: <a href=../../howto/climc/#%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85>源码编译安装</a></p><p>climc 的本地配置参考: <a href=../../howto/climc/#%E9%9D%9E%E6%8E%A7%E5%88%B6%E8%8A%82%E7%82%B9%E8%AE%A4%E8%AF%81%E9%85%8D%E7%BD%AE>非控制节点认证配置</a></p><p>climc 的使用简介参考: <a href=../../howto/climc/#%E4%BD%BF%E7%94%A8>climc 使用</a></p><h2 id=快速开发调试>快速开发调试</h2><p>我们的服务都已经容器化运行在 Kubernetes 集群中，使用上面说的 <strong>&ldquo;制作docker镜像->发布到集群&rdquo;</strong> 的开发流程有些长，对于快速开发调试并不方便。</p><p>通过 <a href=https://www.telepresence.io>Telepresence</a> 提供远程 Kubernetes 连接信息上下文，可以在本地开发调试。下面介绍使用 Telepresence 进行本地快速开发。</p><h3 id=安装配置-kubectl>安装配置 kubectl</h3><p>需要在本地安装 <a href=https://kubernetes.io/zh/docs/tasks/tools/install-kubectl/>kubectl</a>。</p><p>需要在本地配置好集群信息，以通过 kubectl 访问；将云联壹云控制节点上的<code>$KUBECONFIG</code>文件拷贝到本地<code>~/.kube/config</code>;
如果本地已经有此文件，参考 <a href=https://kubernetes.io/zh/docs/tasks/access-application-cluster/configure-access-multiple-clusters/>配置多集群访问</a> 进行合并。</p><h3 id=安装-telepresence>安装 telepresence</h3><p>这里介绍 CentOS 7 的本地环境安装，其他发行版可参考官方文档：<a href=https://www.telepresence.io/reference/install>Installing Telepresence</a>。</p><blockquote><p>不建议K8S集群的部署和开发在同一个环境，使用Telepresence会有端口冲突。</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 安装依赖</span>
$ yum install -y python3 sshfs conntrack iptables torsocks sshuttle sudo yum-utils
<span style=color:#8f5902;font-style:italic># 安装 kubectl 用于连接 K8S 集群</span>
$ cat <span style=color:#4e9a06>&lt;&lt;EOF &gt;/etc/yum.repos.d/kubernetes.repo
</span><span style=color:#4e9a06>[kubernetes]
</span><span style=color:#4e9a06>name=Kubernetes
</span><span style=color:#4e9a06>baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span><span style=color:#4e9a06>enabled=1
</span><span style=color:#4e9a06>gpgcheck=0
</span><span style=color:#4e9a06>repo_gpgcheck=0
</span><span style=color:#4e9a06>gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span><span style=color:#4e9a06>EOF</span>
$ yum install -y kubectl-1.15.8-0
<span style=color:#8f5902;font-style:italic># 需要自行配置kubctl config</span>
<span style=color:#8f5902;font-style:italic># 测试kubctl可以访问之前部署的K8S集群</span>
$ kubctl version
<span style=color:#8f5902;font-style:italic># 源码安装 telepresence 到 /usr/local/bin/telepresence</span>
$ git clone https://github.com/telepresenceio/telepresence
$ <span style=color:#204a87>cd</span> telepresence
$ sudo env <span style=color:#000>PREFIX</span><span style=color:#ce5c00;font-weight:700>=</span>/usr/local ./install.sh
</code></pre></div><h3 id=使用>使用</h3><p>利用 telepresence 本地连通远端 K8S 的特性，我们就可以做到在本地编译运行 region，keystone 等服务，同时又能访问远端 K8S 其它服务的环境。</p><p><strong>macOS 或 linux 中本地编译运行 region 服务</strong></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 切换到 云联壹云 代码目录</span>
$ <span style=color:#204a87>cd</span> <span style=color:#000>$GOPATH</span>/src/yunion.io/x/onecloud
 
<span style=color:#8f5902;font-style:italic># 编译 region 服务</span>
$ make cmd/region
 
<span style=color:#8f5902;font-style:italic># 使用 telepresence 替换 K8S 里面的 default-region deployment</span>
<span style=color:#8f5902;font-style:italic># 该命令在 K8S 集群中启动一个 deployment 替换掉原来的 default-regoin</span>
<span style=color:#8f5902;font-style:italic># 然后把流量的访问导向本地</span>
<span style=color:#8f5902;font-style:italic># 如果想要使用特定的 shell，比如 zsh，可以在后面加上&#34;--run /bin/zsh&#34;</span>
$ telepresence --swap-deployment default-region --namespace onecloud
</code></pre></div><p>到这里已经进入到 telepresence 隔离的 namespace 里面了，
$TELEPRESENCE_ROOT 这个目录 是通过 sshfs 挂载的远端 K8S pod 的文件系统。
接下来我们就可以在这个 namespace 里面运行 region 服务了：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ sudo chmod <span style=color:#0000cf;font-weight:700>777</span> /etc
 
<span style=color:#8f5902;font-style:italic># 将 $TELEPRESENCE_ROOT/etc/yunion 链接到本地的 /etc</span>
$ ln -s <span style=color:#000>$TELEPRESENCE_ROOT</span>/etc/yunion /etc
 
<span style=color:#8f5902;font-style:italic># 启动 region 服务</span>
$ ./_output/bin/region --config /etc/yunion/region.conf
</code></pre></div><p>这个时候如果我们在外部调用 climc 就会发现相关的请求已经被转发到本地开发机启动 region 服务了。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ climc network-list
</code></pre></div><p>调试完成后需要进行清理操作</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 退出 telepresence</span>
$ <span style=color:#204a87>exit</span>
<span style=color:#8f5902;font-style:italic># 会看到类似下面的输出</span>
T: Your process exited with <span style=color:#204a87;font-weight:700>return</span> code 127.
T: Exit cleanup in progress
T: Cleaning up Pod

<span style=color:#8f5902;font-style:italic># 删除链接文件</span>
$ rm /etc/yunion
</code></pre></div><p><strong>Linux系统中本地编译运行 region 服务</strong></p><p>这种方式相比上一种方式，更加干净；但是相对复杂</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 切换到 云联壹云 代码目录</span>
$ <span style=color:#204a87>cd</span> <span style=color:#000>$GOPATH</span>/src/yunion.io/x/onecloud
 
<span style=color:#8f5902;font-style:italic># 编译 region 服务</span>
$ make cmd/region
 
<span style=color:#8f5902;font-style:italic># 使用 telepresence 替换 K8S 里面的 default-region deployment</span>
<span style=color:#8f5902;font-style:italic># 该命令在 K8S 集群中启动一个 deployment 替换掉原来的 default-regoin</span>
<span style=color:#8f5902;font-style:italic># 然后把流量的访问导向本地</span>
<span style=color:#8f5902;font-style:italic># 如果想要使用特定的 shell，比如 zsh，可以在后面加上&#34;--run /bin/zsh&#34;</span>
$ telepresence --swap-deployment default-region --namespace onecloud
</code></pre></div><p>到这里已经进入到 telepresence 隔离的 namespace 里面了，
$TELEPRESENCE_ROOT 这个目录 是通过 sshfs 挂载的远端 K8S pod 的文件系统。
接下来我们就可以在这个 namespace 里面运行 region 服务了：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 设置 max_user_namespaces</span>
$ cat /proc/sys/user/max_user_namespaces
<span style=color:#0000cf;font-weight:700>0</span>
<span style=color:#8f5902;font-style:italic># 如果 max_user_namespaces 为 0，需要设置下 user_namespaces</span>
$ <span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>640</span> &gt; /proc/sys/user/max_user_namespaces
 
<span style=color:#8f5902;font-style:italic># 启动一个新的 namespace , 但不共享 mount namespace，这样接下来的 mount bind 操作就不会影响到宿主机</span>
$ unshare --map-root-user --mount
<span style=color:#8f5902;font-style:italic># bind K8S /var/run/secrets</span>
$ mount --bind <span style=color:#000>$TELEPRESENCE_ROOT</span>/var/run /var/run
$ ls /var/run/
secrets
<span style=color:#8f5902;font-style:italic># bind 云联壹云 config</span>
$ mkdir /etc/yunion
$ mount --bind <span style=color:#000>$TELEPRESENCE_ROOT</span>/etc/yunion /etc/yunion
$ ls /etc/yunion/
pki  region.conf
 
<span style=color:#8f5902;font-style:italic># 启动 region 服务</span>
$ ./_output/bin/region --config /etc/yunion/region.conf
<span style=color:#8f5902;font-style:italic># 这个时候如果我们在外部调用 climc</span>
$ climc network-list
<span style=color:#8f5902;font-style:italic># 就会发现相关的请求已经被转发到本地开发机启动 region 服务了</span>
</code></pre></div><p>更多用法，以及 telepresence 的原理请参考<a href=https://www.telepresence.io/discussion/overview>官方文档</a>。</p><h2 id=faq>FAQ</h2><h3 id=1-开发环境是-windows-或者-macos怎么开发>1. 开发环境是 windows 或者 macOS，怎么开发？</h3><p>因为我们的服务最后会运行在基于 CentOS 7 搭建的 K8S 集群里面，所以日常的开发和打包中一般都是在 CentOS 7 里面做的。</p><p>如果开发环境是 windows ，可以在 windows 里面写代码，然后创建一个 CentOS 7 的虚拟机，在虚拟机里面把开发环境搭建好，写完代码利用 <code>rsync</code> 等同步工具，把修改的代码增量拷贝到虚拟机中，然后进行打包发布等流程。</p><p>对于 Mac 上的 macOS 也是类似的，可以使用和 windows 开发一样的流程。但 macOS 里开发和 Linux 里面开发差异没有很大，在 macOS 里面安装好对应的命令行工具和 docker 后，就可以直接使用 <code>make image</code> 相关的规则打包生成 docker 镜像了。</p><h3 id=2-本地调试启动-region-服务报以下错误>2. 本地调试启动 region 服务，报以下错误</h3><p><img src=../images/region_error.png alt></p><p>使用<code>climc service-config-edit region2</code>编辑 region 服务的配置，修改参数：</p><blockquote><pre><code>fetch_etcd_service_info_and_use_etcd_lock: false 
enable_host_health_check: false
</code></pre></blockquote><h3 id=3-使用-telepresence-时上次未正常退出再次使用一直报错>3. 使用 telepresence 时，上次未正常退出，再次使用一直报错</h3><p>尝试手动清理:</p><ol><li>使用 kubectl 删除 onecloud namespace 下除 default-region-dns-xxxxx 外，所有以 default-region 开头的Pod；</li><li>使用<code>kubectl edit deployment default-region -n onecloud</code>，将 spec 下的 replicas 从0改为1.</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 可以编译cmd下制定的组件，比如：编译 region 和 host 组件</span>
$ make cmd/region cmd/host

<span style=color:#8f5902;font-style:italic># 查看编译好的二进制文件</span>
$ ls _output/bin
region host
</code></pre></div><h3 id=4-本地直接运行-make-cmdhost-会出现-ceph-依赖的报错>4. 本地直接运行 <code>make cmd/host</code> 会出现 ceph 依赖的报错</h3><p>host 组件是私有云里面管理虚拟机的一个关键组件，依赖了 cephfs, rbd 和 rados 相关的库，如果是本地直接编译，则需要安装对应的依赖，操作如下：</p><ul class="nav nav-tabs" id=host_dep_install role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#host_dep_install-0 role=tab aria-controls=host_dep_install-0 aria-selected=true>CentOS 7</a></li><li class=nav-item><a data-toggle=tab class=nav-link href=#host_dep_install-1 role=tab aria-controls=host_dep_install-1>Ubuntu 20.04</a></li></ul><div class=tab-content id=host_dep_install><div id=host_dep_install-0 class="tab-pane show active" role=tabpanel aria-labelledby=host_dep_install-0><p><p>On rpm based systems (dnf, yum, etc):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo rpm --import https://download.ceph.com/keys/release.asc
sudo yum install -y https://download.ceph.com/rpm-luminous/el7/noarch/ceph-release-1-1.el7.noarch.rpm
sudo yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
sudo yum install -y libcephfs-devel librbd-devel librados-devel
</code></pre></div></div><div id=host_dep_install-1 class=tab-pane role=tabpanel aria-labelledby=host_dep_install-1><p><p>On debian systems (apt):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>wget -q -O- <span style=color:#4e9a06>&#39;https://download.ceph.com/keys/release.asc&#39;</span> <span style=color:#000;font-weight:700>|</span> sudo apt-key add -
<span style=color:#204a87>echo</span> deb https://download.ceph.com/debian-luminous/ <span style=color:#204a87;font-weight:700>$(</span>lsb_release -sc<span style=color:#204a87;font-weight:700>)</span> main <span style=color:#000;font-weight:700>|</span> sudo tee /etc/apt/sources.list.d/ceph.list
apt-get update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> apt-get install -y libcephfs-dev librbd-dev librados-dev
</code></pre></div></div></div><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/yunionio/docs/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/yunionio/docs/issues/new>tell us how we can improve</a>.</p><script>const yesButton=document.querySelector('.feedback--answer-yes'),noButton=document.querySelector('.feedback--answer-no'),yesResponse=document.querySelector('.feedback--response-yes'),noResponse=document.querySelector('.feedback--response-no'),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=b=>{if(typeof ga!='function')return;const a={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:b};ga(a.command,a.hitType,a.category,a.action,a.label,a.value)};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(1)}),noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible'),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">最后修改 29.06.2021: <a href=https://github.com/yunionio/docs/commit/21d9f518e5a431976160192b7504ded276bd7318>Merge common files to release/3.4 (21d9f51)</a></div></div></main></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/v3.4/js/main.min.850adc61a285d99ce101da9e59e623e62775ccafff57d900b719ecf4669196b4.js integrity="sha256-hQrcYaKF2ZzhAdqeWeYj5id1zK//V9kAtxns9GaRlrQ=" crossorigin=anonymous></script></body></html>