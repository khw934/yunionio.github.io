<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/v3.2/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/v3.2/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/v3.2/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/v3.2/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/v3.2/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/v3.2/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/v3.2/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/v3.2/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/v3.2/favicons/android-192x192.png sizes=192x192><title>使用 Cgroups 限制 Kubernetes Pod 进程数 | Cloudpods</title><meta property="og:title" content="使用 Cgroups 限制 Kubernetes Pod 进程数"><meta property="og:description" content="作者: 李泽玺
Kubernetes 里面的 Pod 资源是最小的计算单元，抽象了一组（一个或多个）容器。容器也是 Linux 系统上的进程，但基于 Namespace 和 Cgroups(Control groups) 等技术实现了不同程度的隔离。 简单来说 Namespace 可以让每个进程有独立的 PID, IPC 和网络空间。Cgroups 可以控制进程的资源占用，比如 CPU ，内存和允许的最大进程数等等。
今天主要介绍如何通过 Cgroups 里面的 pids 控制器限制 Kubernetes Pod 容器的最大进程数量。
场景介绍 之前遇到过这样一个问题，我们的服务会调用执行外部的命令，每调用一次外部命令就会 fork 产生子进程。但是由于代码上的 bug ，没有及时对子进程回收，然后这个容器不断 fork 产生子进程，耗尽了宿主机的进程表空间，最终导致整个系统不响应，影响了其它的服务。
这种问题除了让开发人员修复 bug 外，也需要在系统层面对进程数量进行限制。所以，如果一个容器里面运行的服务会 fork 产生子进程，就很有必要使用 Cgroups 的 pids 控制器限制这个容器能运行的最大进程数量。
解决方法 Kubelet 开启 PodPidsLimit 功能 Kubernetes 里面的每个节点都会运行一个叫做 Kubelet 的服务，负责节点上容器的状态和生命周期，比如创建和删除容器。根据 Kubernetes 的官方文档 Process ID Limits And Reservations 内容，可以设置 Kubelet 服务的 &ndash;pod-max-pids 配置选项，之后在该节点上创建的容器，最终都会使用 Cgroups pid 控制器限制容器的进程数量。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cloudpods.org//v3.2/blog/2021/06/25/cgroups-kubernetes-pid-limits/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-06-25T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-25T00:00:00+00:00"><meta property="og:site_name" content="Cloudpods"><meta itemprop=name content="使用 Cgroups 限制 Kubernetes Pod 进程数"><meta itemprop=description content="作者: 李泽玺
Kubernetes 里面的 Pod 资源是最小的计算单元，抽象了一组（一个或多个）容器。容器也是 Linux 系统上的进程，但基于 Namespace 和 Cgroups(Control groups) 等技术实现了不同程度的隔离。 简单来说 Namespace 可以让每个进程有独立的 PID, IPC 和网络空间。Cgroups 可以控制进程的资源占用，比如 CPU ，内存和允许的最大进程数等等。
今天主要介绍如何通过 Cgroups 里面的 pids 控制器限制 Kubernetes Pod 容器的最大进程数量。
场景介绍 之前遇到过这样一个问题，我们的服务会调用执行外部的命令，每调用一次外部命令就会 fork 产生子进程。但是由于代码上的 bug ，没有及时对子进程回收，然后这个容器不断 fork 产生子进程，耗尽了宿主机的进程表空间，最终导致整个系统不响应，影响了其它的服务。
这种问题除了让开发人员修复 bug 外，也需要在系统层面对进程数量进行限制。所以，如果一个容器里面运行的服务会 fork 产生子进程，就很有必要使用 Cgroups 的 pids 控制器限制这个容器能运行的最大进程数量。
解决方法 Kubelet 开启 PodPidsLimit 功能 Kubernetes 里面的每个节点都会运行一个叫做 Kubelet 的服务，负责节点上容器的状态和生命周期，比如创建和删除容器。根据 Kubernetes 的官方文档 Process ID Limits And Reservations 内容，可以设置 Kubelet 服务的 &ndash;pod-max-pids 配置选项，之后在该节点上创建的容器，最终都会使用 Cgroups pid 控制器限制容器的进程数量。"><meta itemprop=datePublished content="2021-06-25T00:00:00+00:00"><meta itemprop=dateModified content="2021-06-25T00:00:00+00:00"><meta itemprop=wordCount content="1320"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Cgroups 限制 Kubernetes Pod 进程数"><meta name=twitter:description content="作者: 李泽玺
Kubernetes 里面的 Pod 资源是最小的计算单元，抽象了一组（一个或多个）容器。容器也是 Linux 系统上的进程，但基于 Namespace 和 Cgroups(Control groups) 等技术实现了不同程度的隔离。 简单来说 Namespace 可以让每个进程有独立的 PID, IPC 和网络空间。Cgroups 可以控制进程的资源占用，比如 CPU ，内存和允许的最大进程数等等。
今天主要介绍如何通过 Cgroups 里面的 pids 控制器限制 Kubernetes Pod 容器的最大进程数量。
场景介绍 之前遇到过这样一个问题，我们的服务会调用执行外部的命令，每调用一次外部命令就会 fork 产生子进程。但是由于代码上的 bug ，没有及时对子进程回收，然后这个容器不断 fork 产生子进程，耗尽了宿主机的进程表空间，最终导致整个系统不响应，影响了其它的服务。
这种问题除了让开发人员修复 bug 外，也需要在系统层面对进程数量进行限制。所以，如果一个容器里面运行的服务会 fork 产生子进程，就很有必要使用 Cgroups 的 pids 控制器限制这个容器能运行的最大进程数量。
解决方法 Kubelet 开启 PodPidsLimit 功能 Kubernetes 里面的每个节点都会运行一个叫做 Kubelet 的服务，负责节点上容器的状态和生命周期，比如创建和删除容器。根据 Kubernetes 的官方文档 Process ID Limits And Reservations 内容，可以设置 Kubelet 服务的 &ndash;pod-max-pids 配置选项，之后在该节点上创建的容器，最终都会使用 Cgroups pid 控制器限制容器的进程数量。"><link rel=preload href=/v3.2/scss/main.min.179f2a0cebe6c26066f5b26018cacc453d89d47132e3f6f1faddf3f26a090071.css as=style><link href=/v3.2/scss/main.min.179f2a0cebe6c26066f5b26018cacc453d89d47132e3f6f1faddf3f26a090071.css rel=stylesheet integrity><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/fuse.js@6.4.3></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LX0MD5KG60"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-LX0MD5KG60')</script><title>使用 Cgroups 限制 Kubernetes Pod 进程数 | Cloudpods</title></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a id=cloudpods-top href=/v3.2/ class="logo flex-shrink-0 navbar-brand"><img src=/images/cloudpods_logo_white.png height=46></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/v3.2/docs/quickstart/><span>快速开始</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/v3.2/docs/><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/v3.2/blog/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/yunionio/onecloud target=_blank><span>Github</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/v3.2/docs/swagger><span>API</span></a></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>3.2</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/>v3.8 (latest)</a>
<a class=dropdown-item href=/v3.7>v3.7</a>
<a class=dropdown-item href=/v3.6>v3.6</a>
<a class=dropdown-item href=/v3.4>v3.4</a>
<a class=dropdown-item href=/v3.3>v3.3</a>
<a class=dropdown-item href=/v3.2>v3.2</a></div></li><li class="nav-item dropdown d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/v3.2/en/></a></div></li></ul></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/v3.2/offline-search-index.1fa61e68690e6bf35d208a40b5d0db5f.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>Chinese</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/v3.2/en/></a></div></div><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/v3.2/blog/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">博客</a></li><ul><li class="collapse show" id=v32blog><a class="td-sidebar-link td-sidebar-link__page" id=m-v32blog20210702ocfs2-as-san-filesystem href=/v3.2/blog/2021/07/02/ocfs2-as-san-filesystem/>QEMU+OCFS2: 使用OCFS2作为虚拟机磁盘文件的SAN存储文件系统</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v32blog20210701cloudpods-lb-application-intro href=/v3.2/blog/2021/07/01/cloudpods-lb-application-intro/>问题分析：为什么keystone的本地用户认证接口压测性能很差？</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-v32blog20210625cgroups-kubernetes-pid-limits href=/v3.2/blog/2021/06/25/cgroups-kubernetes-pid-limits/>使用 Cgroups 限制 Kubernetes Pod 进程数</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v32blog20210607nvidia-gpu-passthrough-record href=/v3.2/blog/2021/06/07/nvidia-gpu-passthrough-record/>使用Linux vfio将Nvidia GPU透传给QEMU虚拟机</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v32blog20210531cloudpods-37-new-feature-introduction href=/v3.2/blog/2021/05/31/cloudpods-3.7-new-feature-introduction/>直播回顾：Cloudpods 3.7版本新功能介绍</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v32blog20210531cloudpods-lb-application-intro href=/v3.2/blog/2021/05/31/cloudpods-lb-application-intro/>直播回顾：Cloudpods负载均衡的功能介绍</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-v32blog20190613unified-iaas-for-future href=/v3.2/blog/2019/06/13/unified-iaas-for-future/>面向未来的 IT 基础设施管理架构——融合云（Unified IaaS）</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/yunionio/docs/edit/master/content/zh/blog/_posts/2021-06-25-k8s-kubelet-pid-limits.md target=_blank><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/yunionio/docs/new/master/content/zh/blog/_posts/2021-06-25-k8s-kubelet-pid-limits.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/yunionio/docs/issues/new?title=%e4%bd%bf%e7%94%a8%20Cgroups%20%e9%99%90%e5%88%b6%20Kubernetes%20Pod%20%e8%bf%9b%e7%a8%8b%e6%95%b0" target=_blank><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>
<a href=https://github.com/yunionio/cloudpods/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a></div><nav id=TableOfContents><ul><li><a href=#场景介绍>场景介绍</a></li><li><a href=#解决方法>解决方法</a><ul><li><a href=#kubelet-开启-podpidslimit-功能>Kubelet 开启 PodPidsLimit 功能</a></li><li><a href=#验证-podpidslimit>验证 PodPidsLimit</a></li></ul></li><li><a href=#原理实现>原理实现</a><ul><li><a href=#kubelet-代码调用>Kubelet 代码调用</a></li><li><a href=#systemd-cgroup-slice>Systemd Cgroup slice</a></li><li><a href=#cgroup-fs>Cgroup FS</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href=https://www.cloudpods.org//v3.2/blog/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=td-content><h1>使用 Cgroups 限制 Kubernetes Pod 进程数</h1><div class="td-byline mb-4"><time datetime=2021-06-25 class=text-muted>25.06.2021</time></div><p><strong>作者:</strong> 李泽玺</p><p>Kubernetes 里面的 Pod 资源是最小的计算单元，抽象了一组（一个或多个）容器。容器也是 Linux 系统上的进程，但基于 Namespace 和 Cgroups(Control groups) 等技术实现了不同程度的隔离。
简单来说 Namespace 可以让每个进程有独立的 PID, IPC 和网络空间。Cgroups 可以控制进程的资源占用，比如 CPU ，内存和允许的最大进程数等等。</p><p>今天主要介绍如何通过 Cgroups 里面的 pids 控制器限制 Kubernetes Pod 容器的最大进程数量。</p><h2 id=场景介绍>场景介绍</h2><p>之前遇到过这样一个问题，我们的服务会调用执行外部的命令，每调用一次外部命令就会 fork 产生子进程。但是由于代码上的 bug ，没有及时对子进程回收，然后这个容器不断 fork 产生子进程，耗尽了宿主机的进程表空间，最终导致整个系统不响应，影响了其它的服务。</p><p>这种问题除了让开发人员修复 bug 外，也需要在系统层面对进程数量进行限制。所以，如果一个容器里面运行的服务会 fork 产生子进程，就很有必要使用 Cgroups 的 pids 控制器限制这个容器能运行的最大进程数量。</p><h2 id=解决方法>解决方法</h2><h3 id=kubelet-开启-podpidslimit-功能>Kubelet 开启 PodPidsLimit 功能</h3><p>Kubernetes 里面的每个节点都会运行一个叫做 Kubelet 的服务，负责节点上容器的状态和生命周期，比如创建和删除容器。根据 Kubernetes 的官方文档 <a href=https://kubernetes.io/docs/concepts/policy/pid-limiting/>Process ID Limits And Reservations</a> 内容，可以设置 Kubelet 服务的 <strong>&ndash;pod-max-pids</strong> 配置选项，之后在该节点上创建的容器，最终都会使用 Cgroups pid 控制器限制容器的进程数量。</p><p>我们 Kubernetes 是在 CentOS 7 上使用 kubeadm 部署的 v1.15.9 版本，需要额外设置 <strong>SupportPodPidsLimit</strong> 的 feature-gate，对应操作如下（其它发行版应该也类似）：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># kubelet 使用 systemd 启动的，可以通过编辑 /etc/sysconfig/kubelet</span>
<span style=color:#8f5902;font-style:italic># 添加额外的启动参数，设置 pod 最大进程数为 1024</span>
$ vim /etc/sysconfig/kubelet
<span style=color:#000>KUBELET_EXTRA_ARGS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;--pod-max-pids=1024 --feature-gates=\&#34;SupportPodPidsLimit=true\&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># 重启 kubelet 服务</span>
$ systemctl restart kubelet

<span style=color:#8f5902;font-style:italic># 查看参数是否生效</span>
$ ps faux <span style=color:#000;font-weight:700>|</span> grep kubelet <span style=color:#000;font-weight:700>|</span> grep pod-max-pids
root     <span style=color:#0000cf;font-weight:700>104865</span> 10.5  0.6 <span style=color:#0000cf;font-weight:700>1731392</span> <span style=color:#0000cf;font-weight:700>107368</span> ?      Ssl  11:56   0:30 /usr/bin/kubelet ... --pod-max-pids<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>10</span> --feature-gates<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>SupportPodPidsLimit</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</code></pre></div><h3 id=验证-podpidslimit>验证 PodPidsLimit</h3><p>通过配置 Kubelet 的 <strong>&ndash;pod-max-pids=1024</strong> 选项，限制了一个容器内允许的最大进程数为 1024 个。现在来测试下如果容器内不断 fork 子进程，数目到达 1024 个时会触发什么行为。</p><p>参考 <a href=https://en.wikipedia.org/wiki/Fork_bomb>Fork bomb</a> 的内容，可以创建一个 pod，不断 fork 子进程。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 创建普通的 nginx pod yaml</span>
$ cat <span style=color:#4e9a06>&lt;&lt;EOF &gt; test-nginx.yaml
</span><span style=color:#4e9a06>apiVersion: v1
</span><span style=color:#4e9a06>kind: Pod
</span><span style=color:#4e9a06>metadata:
</span><span style=color:#4e9a06>  name: test-nginx
</span><span style=color:#4e9a06>spec:
</span><span style=color:#4e9a06>  containers:
</span><span style=color:#4e9a06>  - name: nginx
</span><span style=color:#4e9a06>    image: nginx
</span><span style=color:#4e9a06>EOF</span>

<span style=color:#8f5902;font-style:italic># 创建到 Kubernetes 集群</span>
$ kubectl apply -f test-nginx.yaml

<span style=color:#8f5902;font-style:italic># 进入 nginx 容器模拟 fork bomb </span>
$ kubectl <span style=color:#204a87>exec</span> -ti test-nginx bash
root@test-nginx:/# bash -c <span style=color:#4e9a06>&#34;fork() { fork | fork &amp;  }; fork&#34;</span>
environment: fork: retry: Resource temporarily unavailable
environment: fork: retry: Resource temporarily unavailable
environment: fork: retry: Resource temporarily unavailable
</code></pre></div><p>通过进入一个 nginx 容器里面使用 bash 运行 fork bomb 命令，我们会发现当 fork 的子进程达到限制的上限数目后，会报 <strong>retry: Resource temporarily unavailable</strong> 的错误，这个时候再看下宿主机的 fork 进程数目。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 通过在外部宿主机执行下面的命令，会发现 fork 的进程数目接近 1024 个</span>
$ ps faux <span style=color:#000;font-weight:700>|</span> grep fork <span style=color:#000;font-weight:700>|</span> wc -l
<span style=color:#0000cf;font-weight:700>1019</span>
</code></pre></div><p>通过以上的实验，发现能够通过设置 Kubelet 的 <strong>&ndash;pod-max-pids</strong> 选项，限制容器类的进程数，避免容器进程数不断上升最终耗尽宿主机资源，拖垮整个宿主机系统。</p><h2 id=原理实现>原理实现</h2><p>通过之前描述的解决方法，已经能够限制容器的进程数了。</p><p>现在从代码的层面看下 Kubelet 如何设置 Cgroups pids 控制器。</p><h3 id=kubelet-代码调用>Kubelet 代码调用</h3><p>首先来看下 Kubelet 代码里面 <strong>&ndash;pod-max-pids</strong> 是怎么生效的，Kubernetes 的版本为 v1.15.9。</p><p><strong>&ndash;pid-max-pids</strong> 选项是在 <code>cmd/kubelet/app/options/options.go</code> 里面的 <code>AddKubeletConfigFlags</code> 函数设置的，对应代码如下。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// cmd/kubelet/app/options/options.go
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>AddKubeletConfigFlags</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>mainfs</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>pflag</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FlagSet</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>kubeletconfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>KubeletConfiguration</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#8f5902;font-style:italic>// 这里定义了 &#39;--pod-max-pids&#39; 的选项
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 对应参数的值通过命令行解析到 kubeletconfig.KubeletConfiguration.PodPidsLimit 里面
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>fs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Int64Var</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PodPidsLimit</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;pod-max-pids&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PodPidsLimit</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Set the maximum number of processes per pod.  If -1, the kubelet defaults to the node allocatable pid capacity.&#34;</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p><code>PodPidsLimit</code> 配置参数解析完成后，kubelet 会在启动的时候把值设置到 ContainerManager 里面，对应代码在 <code>cmd/kubelet/app/server.go</code> 里面的 <code>run</code> 函数，注释如下。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// cmd/kubelet/app/server.go
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>run</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>options</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>KubeletServer</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>kubeDeps</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>kubelet</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Dependencies</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>stopCh</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>...</span>
        <span style=color:#000>kubeDeps</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ContainerManager</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewContainerManager</span><span style=color:#000;font-weight:700>(</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
            <span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NodeConfig</span><span style=color:#000;font-weight:700>{</span>
                <span style=color:#ce5c00;font-weight:700>...</span>
                <span style=color:#8f5902;font-style:italic>// 容器 runtime，默认使用 docker
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ContainerRuntime</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ContainerRuntime</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#8f5902;font-style:italic>// 使用 Cgroups 控制 pod 的服务质量
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>CgroupsPerQOS</span><span style=color:#000;font-weight:700>:</span>         <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CgroupsPerQOS</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#8f5902;font-style:italic>// 操作 Cgroups 的驱动，有 cgroupfs 和 systemd 两种
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 我们默认配置使用 systemd 来控制 Cgroups
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>CgroupDriver</span><span style=color:#000;font-weight:700>:</span>          <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CgroupDriver</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#ce5c00;font-weight:700>...</span>
                <span style=color:#8f5902;font-style:italic>// 这里就是 PodPidsLimit 的设置了，通过刚才 options 的解析
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#8f5902;font-style:italic>// 赋值到了 ContainerManager.ExperimentalPodPidsLimit 属性
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>ExperimentalPodPidsLimit</span><span style=color:#000;font-weight:700>:</span>              <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PodPidsLimit</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#8f5902;font-style:italic>// 限制容器 CPU 使用率的参数
</span><span style=color:#8f5902;font-style:italic></span>                <span style=color:#000>EnforceCPULimits</span><span style=color:#000;font-weight:700>:</span>                      <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CPUCFSQuota</span><span style=color:#000;font-weight:700>,</span>
                <span style=color:#000>CPUCFSQuotaPeriod</span><span style=color:#000;font-weight:700>:</span>                     <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CPUCFSQuotaPeriod</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#000;font-weight:700>},</span>
            <span style=color:#ce5c00;font-weight:700>...</span>
            <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>初始化 ContainerManager 后，会在 <code>pkg/kubelet/cm/container_manager_linux.go</code> 里面调用 <code>NewPodContainerManager</code> 创建 PodContainerManager，代码如下。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// pkg/kubelet/cm/container_manager_linux.go
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>containerManagerImpl</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>NewPodContainerManager</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>PodContainerManager</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 默认情况下已经打开了 CgroupsPerQOS 的选项
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NodeConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CgroupsPerQOS</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 这里返回 PodContainerManager 接口的实现
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>podContainerManagerImpl</span><span style=color:#000;font-weight:700>{</span>
            <span style=color:#000>qosContainersInfo</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GetQOSContainersInfo</span><span style=color:#000;font-weight:700>(),</span>
            <span style=color:#000>subsystems</span><span style=color:#000;font-weight:700>:</span>        <span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>subsystems</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#000>cgroupManager</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cgroupManager</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#8f5902;font-style:italic>// 这里设置 podPidsLimit
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>podPidsLimit</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ExperimentalPodPidsLimit</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#000>enforceCPULimits</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>EnforceCPULimits</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#000>cpuCFSQuotaPeriod</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>uint64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CPUCFSQuotaPeriod</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Microsecond</span><span style=color:#000;font-weight:700>),</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>podContainerManagerNoop</span><span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>cgroupRoot</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cgroupRoot</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>从之前的代码能发现 PodContainerManager 是一个接口，对应的实现在 <code>pkg/kubelet/cm/pod_container_manager_linux.go</code> 里面，与 Cgroup 相关的函数则是 <code>podContainerManagerImpl.EnsureExists</code> 函数。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// pkg/kubelet/cm/pod_container_manager_linux.go
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#8f5902;font-style:italic>// podContainerManagerImpl 就是实现 PodContainerManager 接口的结构体
</span><span style=color:#8f5902;font-style:italic>// EnsureExists 会根据 api 里面 Pod 的定义，在当前系统创建对应容器的 cgroup 配置
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>podContainerManagerImpl</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>EnsureExists</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pod</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Pod</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// podContainerName 也会作为 cgroup name，根据 pod 的 QOS 级别和 UUID 生成
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 查看容器是否存在
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>alreadyExists</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Exists</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pod</span><span style=color:#000;font-weight:700>)</span>                                                                                  
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>alreadyExists</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 创建 pod 对应容器的 cgroup
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>containerConfig</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>CgroupConfig</span><span style=color:#000;font-weight:700>{</span>
            <span style=color:#000>Name</span><span style=color:#000;font-weight:700>:</span>               <span style=color:#000>podContainerName</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#000>ResourceParameters</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>ResourceConfigForPod</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pod</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>enforceCPULimits</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cpuCFSQuotaPeriod</span><span style=color:#000;font-weight:700>),</span>
        <span style=color:#000;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 如果启用了 SupportPodPidsLimit feature-gate ，并且 podPidsLimit 大于 0
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>utilfeature</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DefaultFeatureGate</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Enabled</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>kubefeatures</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SupportPodPidsLimit</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>podPidsLimit</span> <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic>// 这里就会配置 PidsLimit
</span><span style=color:#8f5902;font-style:italic></span>            <span style=color:#000>containerConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResourceParameters</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PidsLimit</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>podPidsLimit</span>
        <span style=color:#000;font-weight:700>}</span>
        <span style=color:#8f5902;font-style:italic>// 调用 cgroupManager 根据 containerConfig 创建对应的 cgroup
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cgroupManager</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Create</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>containerConfig</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Errorf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;failed to create container for %v : %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>podContainerName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>接下来看 cgroupManager.Create 函数的实现，对应代码实现在 <code>pkg/kubelet/cm/cgroup_manager_linux.go</code> 里面的 <code>cgroupManagerImpl.Create</code>。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>cgroupManagerImpl</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Create</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cgroupConfig</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>CgroupConfig</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
<span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#000>resources</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>toResources</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cgroupConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResourceParameters</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>libcontainerCgroupConfig</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>libcontainerconfigs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cgroup</span><span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>Resources</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>resources</span><span style=color:#000;font-weight:700>,</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#8f5902;font-style:italic>// libcontainer consumes a different field and expects a different syntax
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// depending on the cgroup driver in use, so we need this conditional here.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>adapter</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>cgroupManagerType</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>libcontainerSystemd</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 我们使用 systemd 管理 cgroup ，所以这里会更新下 systemd 对应 cgroup 的配置
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>updateSystemdCgroupInfo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>libcontainerCgroupConfig</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cgroupConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#000>libcontainerCgroupConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Path</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cgroupConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ToCgroupfs</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>utilfeature</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DefaultFeatureGate</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Enabled</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>kubefeatures</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SupportPodPidsLimit</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>cgroupConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResourceParameters</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>cgroupConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResourceParameters</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PidsLimit</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 设置 libcontainerCgroupConfig 里面的 PidsLimit
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 这里 PidsLimit 就是一开始参数指定的 --pod-max-pids 的值
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>libcontainerCgroupConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PidsLimit</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>cgroupConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResourceParameters</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PidsLimit</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 这里根据 cgroup 的配置返回 libcontainercgroups.Manager 接口的实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 这里的实现是 systemd 的实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>manager</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>adapter</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>newManager</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>libcontainerCgroupConfig</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>err</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 调用 libcontainer 里面的 cgroups manager Apply 接口把 pod 的 cgroup 配置应用到系统
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// 在我们的环境中，这个 Apply 函数会由 libcontainer/cgroupfs/systemd.Manager 实现
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>manager</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Apply</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>err</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#ce5c00;font-weight:700>...</span>

    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><p>在看下最后的 <code>Apply</code> 函数，该函数会调用到 <code>vendor/github.com/opencontainers/runc/libcontainer/cgroups/systemd/apply_systemd.go</code> 里面的 systemd 实现。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// vendor/github.com/opencontainers/runc/libcontainer/cgroups/systemd/apply_systemd.go
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>m</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Manager</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Apply</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pid</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// 初始化 systemd cgroup 需要的一些变量
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000;font-weight:700>(</span>
        <span style=color:#000>c</span>          <span style=color:#000;font-weight:700>=</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cgroups</span>
        <span style=color:#8f5902;font-style:italic>// systemd unit name
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>unitName</span>   <span style=color:#000;font-weight:700>=</span> <span style=color:#000>getUnitName</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>)</span>
        <span style=color:#000>slice</span>      <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;system.slice&#34;</span>
        <span style=color:#8f5902;font-style:italic>// systemd unit 里面的配置属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>properties</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>systemdDbus</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Property</span>
    <span style=color:#000;font-weight:700>)</span>
<span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#8f5902;font-style:italic>// Always enable accounting, this gets us the same behaviour as the fs implementation,
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic>// plus the kernel has some problems with joining the memory cgroup at a later time.
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>properties</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#000;font-weight:700>,</span>
        <span style=color:#000>newProp</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;MemoryAccounting&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>),</span>
        <span style=color:#000>newProp</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;CPUAccounting&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>),</span>
        <span style=color:#000>newProp</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;BlockIOAccounting&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Resources</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Memory</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 设置 cgroup memory limit
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>properties</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#000>newProp</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;MemoryLimit&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>uint64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Resources</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Memory</span><span style=color:#000;font-weight:700>)))</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Resources</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CpuShares</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 设置 cgroup cpu shares
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>properties</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#000>newProp</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;CPUShares&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Resources</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CpuShares</span><span style=color:#000;font-weight:700>))</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Resources</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BlkioWeight</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 设置 cgroup block io weight
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>properties</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#000>newProp</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;BlockIOWeight&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>uint64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Resources</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BlkioWeight</span><span style=color:#000;font-weight:700>)))</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Resources</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PidsLimit</span> <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic>// 这里设置了本文关注的 PidsLimit 参数
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic>// 发现会对应 systemd 里面的 TasksAccounting 和 TasksMax 属性
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000>properties</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>properties</span><span style=color:#000;font-weight:700>,</span>
            <span style=color:#000>newProp</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;TasksAccounting&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>true</span><span style=color:#000;font-weight:700>),</span>
            <span style=color:#000>newProp</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;TasksMax&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>uint64</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Resources</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PidsLimit</span><span style=color:#000;font-weight:700>)))</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#8f5902;font-style:italic>// 通过 systemdDbus 根据之前的 cgroup 设置创建对应的 unit
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>theConn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StartTransientUnit</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>unitName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;replace&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>properties</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>statusChan</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#ce5c00;font-weight:700>...</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#8f5902;font-style:italic>// 最后加入 Cgroups
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>joinCgroups</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>pid</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>err</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#ce5c00;font-weight:700>...</span>
</code></pre></div><h3 id=systemd-cgroup-slice>Systemd Cgroup slice</h3><p>通过对 Kubelet 调用 libcontainer，最后由 systemd 创建 pod 容器对应 cgroup unit 的代码调用分析，在这里看下对应 pod 的 systemd unit 配置。</p><p>从之前代码看，最终生成的 systemd unit 和 cgroup 和 pod 的 <code>uid</code> 和 <code>qosClass</code> 有关系，所以先通过以下的命令拿到 pod 的 <code>uid</code> 和 <code>qosClass</code>。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kubectl get pods test-nginx -o yaml <span style=color:#000;font-weight:700>|</span> grep -E <span style=color:#4e9a06>&#39;uid|qos&#39;</span>
  uid: 2ac1e32c-d8d6-4533-8eab-d04d60465065
  qosClass: BestEffort
</code></pre></div><p>然后找到对应的 systemd unit .slice 文件。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># uid 取前 8 位，qosClass 小写</span>
<span style=color:#8f5902;font-style:italic># 找到对应的 kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice</span>
$ systemctl <span style=color:#000;font-weight:700>|</span> grep 2ac1e32c <span style=color:#000;font-weight:700>|</span> grep besteffort
kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice      loaded active active    libcontainer container kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice

<span style=color:#8f5902;font-style:italic># 查看对应 slice 的配置</span>
$ systemctl status kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice
● kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice - libcontainer container kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice
   Loaded: loaded <span style=color:#ce5c00;font-weight:700>(</span>/run/systemd/system/kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice<span style=color:#000;font-weight:700>;</span> static<span style=color:#000;font-weight:700>;</span> vendor preset: disabled<span style=color:#ce5c00;font-weight:700>)</span>
  Drop-In: /run/systemd/system/kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice.d
           └─50-BlockIOAccounting.conf, 50-CPUAccounting.conf, 50-CPUShares.conf, 50-DefaultDependencies.conf, 50-Delegate.conf, 50-Description.conf, 50-MemoryAccounting.conf, 50-TasksAccounting.conf, 50-TasksMax.conf, 50-Wants-kubepods-besteffort<span style=color:#4e9a06>\x</span>2eslice.conf
   Active: active since Fri 2021-06-25 16:21:25 CST<span style=color:#000;font-weight:700>;</span> 7min ago
    Tasks: <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#ce5c00;font-weight:700>(</span>limit: 1024<span style=color:#ce5c00;font-weight:700>)</span>
   Memory: 6.8M
   CGroup: /kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice
           ├─docker-2d151786c9985db74632c09412207fa99755473fde93d09920604e097f25a2b7.scope
           │ ├─32662 nginx: master process nginx -g daemon off<span style=color:#000;font-weight:700>;</span>
           │ ├─32703 nginx: worker process
           │ ├─32704 nginx: worker process
           │ ├─32705 nginx: worker process
           │ └─32706 nginx: worker process
           └─docker-966047566d9e90d9ef64126b605101c174d750ec0cde3d3a83c5b313c7af9a21.scope
             └─32544 /pause

Jun <span style=color:#0000cf;font-weight:700>25</span> 16:21:25 centos7-oc-dev systemd<span style=color:#ce5c00;font-weight:700>[</span>1<span style=color:#ce5c00;font-weight:700>]</span>: Created slice libcontainer container kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice.

<span style=color:#8f5902;font-style:italic># 通过 systemctl status 能发现 50-TasksMax.conf 的文件</span>
<span style=color:#8f5902;font-style:italic># 从之前的代码分析，发现 PodPidsLimit 会对应到 systemd 的 TasksMax 属性</span>
<span style=color:#8f5902;font-style:italic># 现在在看下这个文件的内容</span>
$ cat /run/systemd/system/kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice.d/50-TasksMax.conf
<span style=color:#ce5c00;font-weight:700>[</span>Slice<span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>TasksMax</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1024</span>
<span style=color:#8f5902;font-style:italic># TasksMax 设置为了 1024 ，限制了这个进程最大子进程（Task）数量</span>
</code></pre></div><h3 id=cgroup-fs>Cgroup FS</h3><p>查看之前的 <code>vendor/github.com/opencontainers/runc/libcontainer/cgroups/systemd/apply_systemd.go</code> 代码，发现在创建完 pod 容器对应的 systemd cgroup slice 后，还会调用一次 <code>joinCgroups</code> 这个函数。这个函数会使用 Cgroup FS 原生的方法，在 <code>/sys/fs/cgroup</code> 里面创建对应 pod 容器的 group 。</p><p>所以再看下 Cgroup FS 里面 pod 设置 pid limit 的配置。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 找到 Cgroup FS pids 控制器的挂载点</span>
$ cgroup on /sys/fs/cgroup/pids <span style=color:#204a87>type</span> cgroup <span style=color:#ce5c00;font-weight:700>(</span>rw,nosuid,nodev,noexec,relatime,pids<span style=color:#ce5c00;font-weight:700>)</span>

<span style=color:#8f5902;font-style:italic># 看下 /sys/fs/cgroup/pids 目录下的文件</span>
$ ls -alh /sys/fs/cgroup/pids
...
<span style=color:#8f5902;font-style:italic># 发现有一个由 Kubelet 创建的 kubepods.slice</span>
drwxr-xr-x   <span style=color:#0000cf;font-weight:700>4</span> root root   <span style=color:#0000cf;font-weight:700>0</span> Jun <span style=color:#0000cf;font-weight:700>25</span> 04:49 kubepods.slice
...

<span style=color:#8f5902;font-style:italic># 再通过查看 /sys/fs/cgroup/pids/kubepods.slice 目录</span>
<span style=color:#8f5902;font-style:italic># 会发现 kubepods-besteffort.slice 和 kubepods-burstable.slice 两个目录</span>
<span style=color:#8f5902;font-style:italic># 分别对应 pod 容器的 QOS 级别</span>
$ ls -alh /sys/fs/cgroup/pids/kubepods.slice
...
drwxr-xr-x <span style=color:#0000cf;font-weight:700>42</span> root root <span style=color:#0000cf;font-weight:700>0</span> Jun <span style=color:#0000cf;font-weight:700>25</span> 16:21 kubepods-besteffort.slice
drwxr-xr-x  <span style=color:#0000cf;font-weight:700>8</span> root root <span style=color:#0000cf;font-weight:700>0</span> Jun <span style=color:#0000cf;font-weight:700>25</span> 04:49 kubepods-burstable.slice
...

<span style=color:#8f5902;font-style:italic># 结合刚才的代码片段，也可以想到原生 Cgroup FS 的目录和 systemd 的应该是差不多的层级</span>
<span style=color:#8f5902;font-style:italic># 现在直接用 find 命令查看 pids 控制器下面的 cgroup 设置</span>
$ find /sys/fs/cgroup/pids/kubepods.slice -type f <span style=color:#000;font-weight:700>|</span> grep pod2ac1e32c
...
<span style=color:#8f5902;font-style:italic># 能发现 pids.current 和 pids.max 两个 cgroup 的配置</span>
<span style=color:#8f5902;font-style:italic># pids.current 表示当前 pod 里面的进程（Task）数量</span>
/sys/fs/cgroup/pids/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice/pids.current
<span style=color:#8f5902;font-style:italic># pids.max 则表示 pod 里面能运行的进程（Task）上限</span>
/sys/fs/cgroup/pids/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice/pids.max
...

<span style=color:#8f5902;font-style:italic># 查看 pod pids.max 设置，结果为 1024</span>
$ cat /sys/fs/cgroup/pids/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod2ac1e32c_d8d6_4533_8eab_d04d60465065.slice/pids.max
<span style=color:#0000cf;font-weight:700>1024</span> 
</code></pre></div><p>另外这篇内核文档 <a href=https://www.kernel.org/doc/Documentation/cgroup-v1/pids.txt>Process Number Controller</a> 对 cgroup pids 控制器的使用进行了介绍，可以了解下。</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/v3.2/blog/2021/06/07/nvidia-gpu-passthrough-record/ class="btn btn-primary"><span class=mr-1>←</span> Previous</a></li><a href=/v3.2/blog/2021/07/01/cloudpods-lb-application-intro/ class="btn btn-primary">Next <span class=ml-1>→</span></a></li></ul></div></main></div></div><script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?3c5253cd6530122d0f774cab69e3c07f",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script><footer class="bg-dark pt-4 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>Copyright &copy; 2017-2022 The Cloudpods Authors.</small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/v3.2/js/main.min.850adc61a285d99ce101da9e59e623e62775ccafff57d900b719ecf4669196b4.js integrity="sha256-hQrcYaKF2ZzhAdqeWeYj5id1zK//V9kAtxns9GaRlrQ=" crossorigin=anonymous></script></body></html>