"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[6484],{80510:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>d});var o=t(74848),s=t(28453);const i={sidebar_position:3,edition:"ce"},l="Installation on Kubernetes",r={id:"getting-started/cmp/quickstart-k8s-helm",title:"Installation on Kubernetes",description:"Deploy the Cloudpods CMP multi-cloud management version on Kubernetes using Helm.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/getting-started/cmp/quickstart-k8s-helm.md",sourceDirName:"getting-started/cmp",slug:"/getting-started/cmp/quickstart-k8s-helm",permalink:"/en/docs/getting-started/cmp/quickstart-k8s-helm",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/getting-started/cmp/quickstart-k8s-helm.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,edition:"ce"},sidebar:"tutorialSidebar",previous:{title:"Quick Installation via Docker Compose",permalink:"/en/docs/getting-started/cmp/quickstart-docker-compose"},next:{title:"\u7269\u7406\u673a\u7ba1\u7406",permalink:"/en/docs/getting-started/baremetal/"}},a={},d=[{value:"Environment Preparation",id:"environment-preparation",level:2},{value:"Deployment",id:"deployment",level:2},{value:"Clone Chart",id:"clone-chart",level:3},{value:"Test Environment Installation",id:"test-environment-installation",level:3},{value:"Production Environment Installation",id:"production-environment-installation",level:3},{value:"Check deployment status",id:"check-deployment-status",level:2},{value:"Create default management user",id:"create-default-management-user",level:2},{value:"Create account to log in to Web UI",id:"create-account-to-log-in-to-web-ui",level:3},{value:"Create user",id:"create-user",level:3},{value:"Access the Frontend",id:"access-the-frontend",level:2},{value:"Change the api_server access url",id:"change-the-api_server-access-url",level:2},{value:"Upgrade",id:"upgrade",level:2},{value:"Deletion",id:"deletion",level:2},{value:"Other issues",id:"other-issues",level:2},{value:"1. Missing keystone, glance, region pods in onecloud namespace",id:"1-missing-keystone-glance-region-pods-in-onecloud-namespace",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"installation-on-kubernetes",children:"Installation on Kubernetes"}),"\n",(0,o.jsxs)(n.p,{children:["Deploy the Cloudpods CMP multi-cloud management version on Kubernetes using ",(0,o.jsx)(n.a,{href:"https://helm.sh/",children:"Helm"}),"."]}),"\n",(0,o.jsxs)(n.admonition,{title:"Note",type:"tip",children:[(0,o.jsx)(n.p,{children:"This solution automatically deploys the Cloudpods multi-cloud management version on an existing Kubernetes cluster using Helm."}),(0,o.jsxs)(n.p,{children:["This deployment method may result in compatibility issues due to different configurations of CSI, CNI, and Ingress Controller for different Kubernetes distributions. If deployment fails and you want to quickly experience the product features, it is recommended to use the ",(0,o.jsx)(n.a,{href:"./quickstart-docker-compose",children:"Quick Installation via Docker Compose"})," method for deployment."]}),(0,o.jsx)(n.p,{children:"Kubernetes distributions that have been verified include:"}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Alibaba Cloud ACK"}),"\n",(0,o.jsx)(n.li,{children:"Tencent Cloud TKE"}),"\n",(0,o.jsx)(n.li,{children:"Azure AKS"}),"\n",(0,o.jsx)(n.li,{children:"AWS ECS"}),"\n"]}),(0,o.jsx)(n.p,{children:"This deployment method is only suitable for using multi-cloud management functions, such as managing public clouds (AWS, Alibaba Cloud, Tencent Cloud, etc.) or other private clouds (zstack, openstack, etc.), and cannot be used with built-in private cloud-related functions (because built-in private clouds require the installation and configuration of various virtualization software such as QEMU and Open vSwitch on the nodes)."})]}),"\n",(0,o.jsx)(n.h2,{id:"environment-preparation",children:"Environment Preparation"}),"\n",(0,o.jsx)(n.p,{children:"Cloudpods components run on top of Kubernetes, and the environment and related software dependencies are as follows:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Kubernetes cluster configuration requirements:\n\xa0\xa0- Kubernetes version: 1.15 ~ 1.24\n\xa0\xa0- System configuration: at least 4 CPUs, 8G memory, and 100G node storage\n\xa0\xa0- Nodes need to be able to access the public network\n\xa0\xa0- Provide ingress controller\n\xa0\xa0- Internal coredns resolution\n\xa0\xa0- Support Helm, please refer to ",(0,o.jsx)(n.a,{href:"https://helm.sh/docs/intro/install/",children:"https://helm.sh/docs/intro/install/"})," for installation of helm tools"]}),"\n",(0,o.jsx)(n.li,{children:"Provide a Mysql database (optional): You can choose whether to use a database connected within the Kubernetes cluster or externally. It is recommended to use a separately managed Mysql in production environment (if using public cloud RDS services)"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"deployment",children:"Deployment"}),"\n",(0,o.jsx)(n.h3,{id:"clone-chart",children:"Clone Chart"}),"\n",(0,o.jsxs)(n.p,{children:["The Cloudpods Helm Chart is located at ",(0,o.jsx)(n.a,{href:"https://github.com/yunionio/ocboot",children:"https://github.com/yunionio/ocboot"}),", and can be downloaded locally using the following command:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ git clone https://github.com/yunionio/ocboot && cd charts/cloudpods\n"})}),"\n",(0,o.jsxs)(n.admonition,{title:"Note",type:"tip",children:[(0,o.jsxs)(n.p,{children:["Next, we will use helm to install the cloudpods chart. When using ",(0,o.jsx)(n.code,{children:"helm install"}),", it is necessary to specify ",(0,o.jsx)(n.code,{children:"--namespace onecloud"})," and cannot use another namespace."]}),(0,o.jsx)(n.p,{children:"The reason for this is that the operator service does not yet support deploying platform services to other namespaces, which will be improved later."})]}),"\n",(0,o.jsx)(n.h3,{id:"test-environment-installation",children:"Test Environment Installation"}),"\n",(0,o.jsx)(n.p,{children:"The test environment installation method is as follows. This method will deploy mysql and the local-path-provisioner CSI dependent plug-in in the Kubernetes cluster, and does not need to connect to mysql outside the cluster."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# Note that `--namespace onecloud` cannot be changed to another value, it must be onecloud\n$ helm install --name-template default --namespace onecloud --debug  . -f values-dev.yaml  --create-namespace\n"})}),"\n",(0,o.jsx)(n.h3,{id:"production-environment-installation",children:"Production Environment Installation"}),"\n",(0,o.jsxs)(n.p,{children:["The previously deployed method is only for testing because there are few dependencies and the installation process is fast. However, if you use this method in a production environment, please modify the parameters in ",(0,o.jsx)(n.code,{children:"./values-prod.yaml"})," according to your needs, and then create a Helm Release using this file."]}),"\n",(0,o.jsx)(n.p,{children:"The recommended modifications are as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-diff",children:'--- a/charts/cloudpods/values-prod.yaml\n+++ b/charts/cloudpods/values-prod.yaml\n localPathCSI:\n+  # Depending on the CSI deployment of the k8s cluster, select whether you want to deploy the default local-path CSI\n+  # If the k8s cluster already has a stable CSI, you can set this value to false and not deploy this component\n   enabled: true\n   helperPod:\n     image: registry.cn-beijing.aliyuncs.com/yunionio/busybox:1.35.0\n@@ -60,11 +62,16 @@ localPathCSI:\n\n cluster:\n   mysql:\n+    # external mysql address\n     host: 1.2.3.4\n+    # external mysql port\n     port: 3306\n+    # the external mysql user, need to use a user with root privileges, because the cloudpods operator creates database users for other services.\n     user: root\n+    # external mysql user password\n     password: your-db-password\n     statefulset:\n+      # This needs to be set to false for production deployments, otherwise a mysql will be deployed inside the k8s cluster and the connection will use this statefulset mysql\n       enabled: false\n       image:\n         repository: "registry.cn-beijing.aliyuncs.com/yunionio/mysql"\n@@ -91,15 +98,20 @@ cluster:\n   # imageRepository defines default image registry\n   imageRepository: registry.cn-beijing.aliyuncs.com/yunion\n   # publicEndpoint is upstream ingress virtual ip address or DNS domain\n+  # Domain name or ip address accessible from outside the cluster\n   publicEndpoint: foo.bar.com\n   # edition choose from:\n   # - ce: community edition\n   # - ee: enterprise edition\n   edition: ce\n   # storageClass for stateful component\n+  # storageClass used by stateful services, if not set it will use local-path CSI\n+  # This can be adjusted according to the k8s cluster.\n   storageClass: ""\n   ansibleserver:\n     service:\n+      # Specify the nodePort to which the service is exposed, if it conflicts with an existing service in the cluster\n       nodePort: 30890\n   apiGateway:\n     apiService:\n@@ -193,6 +205,7 @@ cluster:\n     service:\n       nodePort: 30889\n\n+# Setting ingress\n ingress:\n   enabled: true\n+  # \u8bbe\u7f6e ingress \u7684 className\uff0c\u6bd4\u5982\u96c6\u7fa4\u91cc\u9762\u4f7f\u7528 nginx-ingress-controller\n+  # \u8fd9\u91cc\u7684 className \u5c31\u5199 nginx\n+  # className: nginx\n   className: ""\n'})}),"\n",(0,o.jsx)(n.p,{children:"After modifying the values-prod.yaml file, deploy with the following command:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# Note that `--namespace onecloud` cannot be changed. It must be onecloud\n$ helm install --name-template default --namespace onecloud . -f values-prod.yaml  --create-namespace\n"})}),"\n",(0,o.jsx)(n.h2,{id:"check-deployment-status",children:"Check deployment status"}),"\n",(0,o.jsx)(n.p,{children:"After installing the cloudpods chart using helm install, use the following command to check the deployment status of pods:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# Under normal circumstances, there will be these pods in the onecloud namespace\n$ kubectl get pods -n onecloud\nNAME                                               READY   STATUS    RESTARTS   AGE\ndefault-cloudpods-ansibleserver-779bcbc875-nzj6k   1/1     Running   0          140m\ndefault-cloudpods-apigateway-7877c64f5c-vljrs      1/1     Running   0          140m\ndefault-cloudpods-climc-6f4bf8c474-nj276           1/1     Running   0          139m\ndefault-cloudpods-cloudevent-79c894bbfc-zdqcs      1/1     Running   0          139m\ndefault-cloudpods-cloudid-67c7894db7-86czj         1/1     Running   0          139m\ndefault-cloudpods-cloudmon-5cd9866bdf-c27fc        1/1     Running   0          68m\ndefault-cloudpods-cloudproxy-6679d94fc7-gm5tx      1/1     Running   0          139m\ndefault-cloudpods-devtool-6db6f4d454-ldw69         1/1     Running   0          139m\ndefault-cloudpods-esxi-agent-7bcc56987b-lgpnf      1/1     Running   0          139m\ndefault-cloudpods-etcd-q8j5c29tm2                  1/1     Running   0          145m\ndefault-cloudpods-glance-7547c455d5-fnzqq          1/1     Running   0          140m\ndefault-cloudpods-influxdb-c9947bdc8-x8xth         1/1     Running   0          139m\ndefault-cloudpods-keystone-6cc64bdcc7-xhh7m        1/1     Running   0          145m\ndefault-cloudpods-kubeserver-5544d59c98-l9d74      1/1     Running   0          140m\ndefault-cloudpods-logger-8f56cd9b5-f9kbp           1/1     Running   0          139m\ndefault-cloudpods-monitor-746985b5cf-l8sqm         1/1     Running   0          139m\ndefault-cloudpods-notify-dd566cfd6-hxzr4           10/10   Running   0          139m\ndefault-cloudpods-operator-7478b6c64b-wbg26        1/1     Running   0          72m\ndefault-cloudpods-region-7dfd9b888-hsvv8           1/1     Running   0          144m\ndefault-cloudpods-scheduledtask-7d69b877f7-4ltm6   1/1     Running   0          139m\ndefault-cloudpods-scheduler-8495f85798-zgvq2       1/1     Running   0          140m\ndefault-cloudpods-web-5bc6fcf78d-4f7lw             1/1     Running   0          140m\ndefault-cloudpods-webconsole-584cfb4796-4mtnj      1/1     Running   0          139m\ndefault-cloudpods-yunionconf-677b4448b6-tz62m      1/1     Running   0          139m\n"})}),"\n",(0,o.jsx)(n.h2,{id:"create-default-management-user",children:"Create default management user"}),"\n",(0,o.jsx)(n.h3,{id:"create-account-to-log-in-to-web-ui",children:"Create account to log in to Web UI"}),"\n",(0,o.jsx)(n.p,{children:"If you are using the Enterprise Edition, the front-end will prompt you to register and obtain a license. The following steps apply only to the open-source version:### Enter the climc command line pod"}),"\n",(0,o.jsx)(n.p,{children:"If you're deploying the community open-source version (ce), use the platform command line tools to create a default user and perform related operations. The corresponding commands are as follows. First, enter the climc pod container:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"#Enter the climc pod\n$ kubectl exec -ti -n onecloud $(kubectl get pods -n onecloud | grep climc | awk '{print $1}') -- bash\nWelcome to Cloud Shell :-) You may execute climc and other command tools in this shell.\nPlease exec 'climc' to get started\n\nbash-5.1#\n"})}),"\n",(0,o.jsx)(n.h3,{id:"create-user",children:"Create user"}),"\n",(0,o.jsx)(n.p,{children:"Create an admin user inside the climc pod, the command is as follows:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# Create an admin user with the password 'admin@123', adjust as needed\n[in-climc-pod]$ climc user-create --password 'admin@123' --enabled admin\n\n# Allow web login\n[in-climc-pod]$ climc user-update --allow-web-console admin\n\n# Add the admin user to the system project and give it administrator privileges\n[in-climc-pod]$ climc project-add-user system admin admin\n"})}),"\n",(0,o.jsx)(n.h2,{id:"access-the-frontend",children:"Access the Frontend"}),"\n",(0,o.jsx)(n.p,{children:"Access the platform-exposed frontend according to the created ingress. Check the ingress using the following command:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"#The ingress information of my test cluster is as follows, different k8s clusters have different implementations according to the ingress plugin\n$ kubectl get ingresses -n onecloud\nNAME                    HOSTS   ADDRESS                 PORTS     AGE\ndefault-cloudpods-web   *       10.127.100.207          80, 443   7h52m\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Visit the platform frontend at ",(0,o.jsx)(n.a,{href:"https://10.127.100.207",children:"https://10.127.100.207"})," using a browser, and then log in with the admin user created earlier."]}),"\n",(0,o.jsx)(n.h2,{id:"change-the-api_server-access-url",children:"Change the api_server access url"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"api_server"})," option is the address of the access point for the entire platform, which affects the front-end vnc or web ssh connection."]}),"\n",(0,o.jsxs)(n.p,{children:["You need to modify it manually according to your environment, refer to the document: ",(0,o.jsx)(n.a,{href:"../../operations/fe/config-ssl-certs#change-api-server-via-climc",children:"Change service api_server configuration"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"upgrade",children:"Upgrade"}),"\n",(0,o.jsx)(n.p,{children:"Upgrade can be done by modifying the corresponding values yaml file and then performing upgrade configuration. For example, if there is a port conflict with the cluster.regionServer.service.nodePort 30888 port and you need to change it to another port such as 30001, modify the corresponding values in values-prod.yaml:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-diff",children:"--- a/charts/cloudpods/values-prod.yaml\n+++ b/charts/cloudpods/values-prod.yaml\n@@ -170,7 +170,7 @@ cluster:\n       nodePort: 30885\n   regionServer:\n     service:\n-      nodePort: 30888\n+      nodePort: 30001\n   report:\n     service:\n       nodePort: 30967\n"})}),"\n",(0,o.jsx)(n.p,{children:"Then use the helm upgrade command to upgrade:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ helm upgrade -n onecloud default . -f values-prod.yaml\n"})}),"\n",(0,o.jsx)(n.p,{children:"Then, check the onecloudcluster resource, and you will find that the spec.regionServer.service.nodePort has changed to 30001, and the corresponding service nodePort will also change:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'# Look up the regionServer\'s properties in onecloudcluster\n$ kubectl get oc -n onecloud default-cloudpods -o yaml | grep -A 15 regionServer\n  regionServer:\n    affinity: {}\n    disable: false\n    dnsDomain: cloud.onecloud.io\n    dnsServer: 10.127.100.207\n    image: registry.cn-beijing.aliyuncs.com/yunion/region:v3.9.2\n    imagePullPolicy: IfNotPresent\n    limits:\ncpu: "1.333333"\nmemory: 2045Mi\nreplicas: 1\nrequests:\n  cpu: 10m\n  memory: 10Mi\nservice:\n  nodePort: 30001\n\n# View the nodePort of the default-cloudpods-region service\n$ kubectl get svc -n onecloud | grep region\ndefault-cloudpods-region          NodePort    10.110.105.228   <none>        30001:30001/TCP                   7h30m\n'})}),"\n",(0,o.jsx)(n.p,{children:"Check if the cluster.regionServer.service.nodePort that was changed previously has changed in the platform endpoints:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# Use the climc pod to specify the endpoint-list command to view\n$ kubectl exec -ti -n onecloud $(kubectl get pods -n onecloud | grep climc | awk '{print $1}') -- climc endpoint-list --search compute\n+----------------------------------+-----------+----------------------------------+----------------------------------------+-----------+---------+\n|                ID                | Region_ID |            Service_ID            |                  URL                   | Interface | Enabled |\n+----------------------------------+-----------+----------------------------------+----------------------------------------+-----------+---------+\n| c88e03490c2543a987d86d733b918a2d | region0   | a9abfdd204e9487c8c4d6d85defbfaef | https://10.127.100.207:30001           | public    | true    |\n| a04e161ee71346ac88ddd04fcebfe5ce | region0   | a9abfdd204e9487c8c4d6d85defbfaef | https://default-cloudpods-region:30001 | internal  | true    |\n+----------------------------------+-----------+----------------------------------+----------------------------------------+-----------+---------+\n*** Total: 2 Pages: 1 Limit: 20 Offset: 0 Page: 1 ***\n"})}),"\n",(0,o.jsx)(n.h2,{id:"deletion",children:"Deletion"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ helm delete -n onecloud default\n"})}),"\n",(0,o.jsx)(n.h2,{id:"other-issues",children:"Other issues"}),"\n",(0,o.jsx)(n.h3,{id:"1-missing-keystone-glance-region-pods-in-onecloud-namespace",children:"1. Missing keystone, glance, region pods in onecloud namespace"}),"\n",(0,o.jsxs)(n.p,{children:["If you execute ",(0,o.jsx)(n.code,{children:"helm install"})," and execute ",(0,o.jsx)(n.code,{children:"kubectl get pods -n onecloud"})," and find only the operator pod and no keystone, glance, or region pods related to the platform services appear, use the following command to check the operator pod's logs for troubleshooting."]}),"\n",(0,o.jsx)(n.p,{children:"The reason for this situation is generally that the operator encountered an error when creating platform-related services such as keystone and region. Common problems include the operator's inability to create users and databases using related mysql users, or the creation of the keystone service, but unable to access the keystone pod through the K8s internal service domain name."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"# Redirect all operator logs to a file```\n$ kubectl logs -n onecloud $(kubectl get pods -n onecloud | grep operator | awk '{print $1}') > /tmp/operator.log\n# Then check if there are any related errors in /tmp/operator.log\n\n\n# Check if there is a keyword \"requeuing\" in the operator log, general errors will be reflected here\n$ kubectl logs -n onecloud $(kubectl get pods -n onecloud | grep operator | awk '{print $1}') | grep requeuing\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>r});var o=t(96540);const s={},i=o.createContext(s);function l(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);