"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[5188],{77265:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>l});var o=t(74848),s=t(28453);const i={edition:"ce",sidebar_position:22},c="Offline Private Cloud Computing Nodes",r={id:"operations/remove-host",title:"Offline Private Cloud Computing Nodes",description:"If you need to take a computing node (host) offline from a private cloud, you need to take the following steps to ensure a clean offline for a computing node.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/operations/remove-host.md",sourceDirName:"operations",slug:"/operations/remove-host",permalink:"/en/docs/operations/remove-host",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/operations/remove-host.md",tags:[],version:"current",sidebarPosition:22,frontMatter:{edition:"ce",sidebar_position:22},sidebar:"tutorialSidebar",previous:{title:"Multi-Availability Zone Service Configuration",permalink:"/en/docs/operations/multi-zone-config"},next:{title:"\u6e05\u7406\u672a\u4f7f\u7528\u7684\u5b89\u5168\u7ec4",permalink:"/en/docs/operations/clean-kvm-security-groups"}},a={},l=[];function h(e){const n={code:"code",h1:"h1",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"offline-private-cloud-computing-nodes",children:"Offline Private Cloud Computing Nodes"}),"\n",(0,o.jsx)(n.p,{children:"If you need to take a computing node (host) offline from a private cloud, you need to take the following steps to ensure a clean offline for a computing node."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Migrate all virtual machines on the host away. Ensure that there are no virtual machines on the host, and that there are no disks in the local storage of the host."}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Delete the host record, which can be done through the web frontend or by executing the climc command on the control node."}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ climc host-delete <host_id>\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Note: If the deletion of the host record fails, the reason may be that there are virtual machines that have not been cleared on the host, or there is local storage that has not been cleared. In this case, you can use the ",(0,o.jsx)(n.code,{children:"clean_host.sh"})," script of the climc container to automatically clean up the remaining virtual machines and local disks on the host and delete the host's database record."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ kubectl exec -ti -n onecloud $(kubectl get pods -n onecloud | grep climc | awk '{print $1}') sh # Enter the climc container and execute the following command\n$ cd /opt/yunion/scripts/tools/\n$ ./clean_host.sh <host_id>\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"3",children:["\n",(0,o.jsx)(n.li,{children:"Delete the chassis record of the node in ovn."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"First, stop the openvswitch service on the host and clean up the /etc/openvswitch directory."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ systemctl stop openvswitch\n$ rm -fr /etc/openvswitch/*\n"})}),"\n",(0,o.jsx)(n.p,{children:"Next, execute on the control node:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:'$ kubectl -n onecloud exec -it default-ovn-north-xxxxx /bin/sh # Enter the ovn-northd container and execute the following command\n/ $ ovn-sbctl show # Find the chassis ID corresponding to the host and confirm it with the hostname and IP.\n...\nChassis "e6268b2e-4311-4f6d-a6e2-ddd09f49beef"\n    hostname: taishan\n    Encap geneve\n        ip: "192.168.222.60"\n        options: {csum="true"}\n...\n/ $ ovn-sbctl chassis-del <chassis_id>\n'})}),"\n",(0,o.jsxs)(n.ol,{start:"4",children:["\n",(0,o.jsx)(n.li,{children:"Clean up the kubelet environment on the host, and execute the following command on the host:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ kubeadm reset -f\n"})}),"\n",(0,o.jsxs)(n.ol,{start:"5",children:["\n",(0,o.jsx)(n.li,{children:"Delete the k8s node information corresponding to the host, and execute the following command on the control node:"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"$ kubectl get nodes # Look for the k8s node name of the host.\n$ kubectl delete node <node_name>\n"})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>r});var o=t(96540);const s={},i=o.createContext(s);function c(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);