"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[6646],{45382:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>c,metadata:()=>a,toc:()=>o});var t=s(85893),r=s(11151);const c={sidebar_position:4},i="\u524d\u7aef\u53cc\u5411\u8ba4\u8bc1\u914d\u7f6e",a={id:"operations/fe/traefik-mutual-tls",title:"\u524d\u7aef\u53cc\u5411\u8ba4\u8bc1\u914d\u7f6e",description:"\u5e73\u53f0\u90e8\u7f72\u540e\u9ed8\u8ba4\u6253\u5f00\u4e86 TLS \u670d\u52a1\u7aef(\u5355\u5411)\u8ba4\u8bc1\uff0c\u672c\u6587\u4ecb\u7ecd\u5982\u4f55\u5728\u5df2\u6709\u670d\u52a1\u7aef\u8ba4\u8bc1\u7684\u60c5\u51b5\u4e0b\uff0c\u5f00\u542f\u5ba2\u6237\u7aef\u9a8c\u8bc1(\u53cc\u5411)\u8ba4\u8bc1\u3002",source:"@site/docs/operations/fe/traefik-mutual-tls.md",sourceDirName:"operations/fe",slug:"/operations/fe/traefik-mutual-tls",permalink:"/en/docs/operations/fe/traefik-mutual-tls",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/operations/fe/traefik-mutual-tls.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"\u524d\u7aef\u4f7f\u7528 HTTP",permalink:"/en/docs/operations/fe/web-use-http"},next:{title:"\u65e5\u5fd7\u8fd0\u7ef4",permalink:"/en/docs/operations/log/"}},l={},o=[{value:"\u751f\u6210\u8bc1\u4e66",id:"\u751f\u6210\u8bc1\u4e66",level:2},{value:"\u751f\u6210 CA",id:"\u751f\u6210-ca",level:3},{value:"\u751f\u6210 Server \u670d\u52a1\u7aef\u8bc1\u4e66",id:"\u751f\u6210-server-\u670d\u52a1\u7aef\u8bc1\u4e66",level:3},{value:"\u751f\u6210 Client \u5ba2\u6237\u7aef\u8bc1\u4e66",id:"\u751f\u6210-client-\u5ba2\u6237\u7aef\u8bc1\u4e66",level:3},{value:"\u4e0a\u4f20\u8bc1\u4e66\u5230 Kubernetes",id:"\u4e0a\u4f20\u8bc1\u4e66\u5230-kubernetes",level:2},{value:"\u4fee\u6539\u524d\u7aef default-web ingress",id:"\u4fee\u6539\u524d\u7aef-default-web-ingress",level:2},{value:"\u4fee\u6539 traefik \u914d\u7f6e",id:"\u4fee\u6539-traefik-\u914d\u7f6e",level:2},{value:"\u4fee\u6539 traefik configmap",id:"\u4fee\u6539-traefik-configmap",level:3},{value:"\u4fee\u6539 traefik daemonset",id:"\u4fee\u6539-traefik-daemonset",level:3},{value:"\u91cd\u542f traefik \u670d\u52a1",id:"\u91cd\u542f-traefik-\u670d\u52a1",level:3},{value:"\u4f7f\u7528 curl \u8fdb\u884c\u6d4b\u8bd5",id:"\u4f7f\u7528-curl-\u8fdb\u884c\u6d4b\u8bd5",level:2},{value:"\u6d4f\u89c8\u5668\u914d\u7f6e",id:"\u6d4f\u89c8\u5668\u914d\u7f6e",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",strong:"strong",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"\u524d\u7aef\u53cc\u5411\u8ba4\u8bc1\u914d\u7f6e",children:"\u524d\u7aef\u53cc\u5411\u8ba4\u8bc1\u914d\u7f6e"}),"\n",(0,t.jsx)(n.p,{children:"\u5e73\u53f0\u90e8\u7f72\u540e\u9ed8\u8ba4\u6253\u5f00\u4e86 TLS \u670d\u52a1\u7aef(\u5355\u5411)\u8ba4\u8bc1\uff0c\u672c\u6587\u4ecb\u7ecd\u5982\u4f55\u5728\u5df2\u6709\u670d\u52a1\u7aef\u8ba4\u8bc1\u7684\u60c5\u51b5\u4e0b\uff0c\u5f00\u542f\u5ba2\u6237\u7aef\u9a8c\u8bc1(\u53cc\u5411)\u8ba4\u8bc1\u3002"}),"\n",(0,t.jsxs)(n.p,{children:["\u6574\u4e2a\u4e91\u5e73\u53f0\u8fd0\u884c\u5728 Kubernetes \u4e4b\u4e0a\uff0c\u524d\u7aef\u670d\u52a1\u901a\u8fc7 ingress \u66b4\u9732\u51fa\u6765\uff0c\u6211\u4eec\u4f7f\u7528\u4e86\u5f00\u6e90\u7684 ",(0,t.jsx)(n.a,{href:"https://doc.traefik.io/traefik/v1.7",children:"traefik"})," \u7ec4\u4ef6\u6765\u8d1f\u8d23 ingress \u7684\u5b9e\u73b0\uff0c\u6240\u4ee5\u5728 traefik \u4e0a\u8bbe\u7f6e\u5ba2\u6237\u7aef\u8ba4\u8bc1\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"\u751f\u6210\u8bc1\u4e66",children:"\u751f\u6210\u8bc1\u4e66"}),"\n",(0,t.jsx)(n.p,{children:"\u4e0b\u9762\u4f7f\u7528\u751f\u6210\u81ea\u7b7e\u540d\u8bc1\u4e66\u7684\u65b9\u5f0f\u6765\u914d\u7f6e\uff0c\u5982\u679c\u5df2\u7ecf\u6709\u8bc1\u4e66\u673a\u6784\u7b7e\u53d1\u7684\u670d\u52a1\u7aef\u548c\u5ba2\u6237\u7aef\u8bc1\u4e66\uff0c\u53ef\u4ee5\u5ffd\u7565\u8fd9\u4e2a\u6b65\u9aa4\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"\u751f\u6210-ca",children:"\u751f\u6210 CA"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ openssl req -x509 -sha256 -newkey rsa:4096 -keyout ca.key -out ca.crt -days 356 -nodes -subj '/CN=My Cert Authority'\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u751f\u6210-server-\u670d\u52a1\u7aef\u8bc1\u4e66",children:"\u751f\u6210 Server \u670d\u52a1\u7aef\u8bc1\u4e66"}),"\n",(0,t.jsx)(n.p,{children:"\u57fa\u4e8e\u4e0a\u9762\u751f\u6210\u7684 CA \u7b7e\u53d1 server \u8bc1\u4e66\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ openssl req -new -newkey rsa:4096 -keyout server.key -out server.csr -nodes -subj '/CN=mydomain.com'\n$ openssl x509 -req -sha256 -days 365 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server.crt\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u751f\u6210-client-\u5ba2\u6237\u7aef\u8bc1\u4e66",children:"\u751f\u6210 Client \u5ba2\u6237\u7aef\u8bc1\u4e66"}),"\n",(0,t.jsx)(n.p,{children:"\u57fa\u4e8e\u4e0a\u9762\u751f\u6210\u7684 CA \u7b7e\u53d1 client \u8bc1\u4e66\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ openssl req -new -newkey rsa:4096 -keyout client.key -out client.csr -nodes -subj '/CN=My Client'\n$ openssl x509 -req -sha256 -days 365 -in client.csr -CA ca.crt -CAkey ca.key -set_serial 02 -out client.crt\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u4e0a\u4f20\u8bc1\u4e66\u5230-kubernetes",children:"\u4e0a\u4f20\u8bc1\u4e66\u5230 Kubernetes"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u4e0a\u4f20 ca \u5230 kube-system \u547d\u4ee4\u7a7a\u95f4\n$ kubectl -n kube-system create secret generic ca-secret --from-file=ca.crt=ca.crt\n\n# \u4e0a\u4f20 server \u8bc1\u4e66\u5230 onecloud \u547d\u540d\u7a7a\u95f4\n$ kubectl -n onecloud create secret generic tls-secret --from-file=tls.crt=server.crt --from-file=tls.key=server.key\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u4fee\u6539\u524d\u7aef-default-web-ingress",children:"\u4fee\u6539\u524d\u7aef default-web ingress"}),"\n",(0,t.jsx)(n.p,{children:"\u524d\u7aef\u662f\u901a\u8fc7 onecloud \u547d\u4ee4\u7a7a\u95f4\u91cc\u9762\u7684 default-web ingress \u8bbf\u95ee\u7684\uff0c\u628a\u524d\u7aef\u4f7f\u7528\u7684 tls \u8bc1\u4e66\u6362\u6210 tls-secret \u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ kubectl edit ingress -n onecloud default-web\n...\n  tls:\n  # \u4fee\u6539\u8fd9\u4e2a secretName \u4e3a tls-secret\n  - secretName: tls-secret\n...\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u4fee\u6539-traefik-\u914d\u7f6e",children:"\u4fee\u6539 traefik \u914d\u7f6e"}),"\n",(0,t.jsx)(n.h3,{id:"\u4fee\u6539-traefik-configmap",children:"\u4fee\u6539 traefik configmap"}),"\n",(0,t.jsxs)(n.p,{children:["traefik \u7684\u914d\u7f6e\u5728 kube-system \u547d\u540d\u7a7a\u95f4\u7684 traefik-ingress-lb config \u91cc\u9762\uff0c\u5f00\u542f\u5ba2\u6237\u7aef\u9a8c\u8bc1\u4e3b\u8981\u662f\u914d\u7f6e ",(0,t.jsx)(n.strong,{children:"entryPoints.https.tls.ClientCA"})," \u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'$ kubectl edit configmaps -n kube-system traefik-ingress-lb\n...\n     [entryPoints.https]\n        address = ":443"\n        # \u6dfb\u52a0\u5982\u4e0b\u7684 ClientCA \u914d\u7f6e\n        [entryPoints.https.tls]\n          [entryPoints.https.tls.ClientCA]\n          files = ["/tests/ca.crt"]\n          optional = false\n...\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u4fee\u6539-traefik-daemonset",children:"\u4fee\u6539 traefik daemonset"}),"\n",(0,t.jsxs)(n.p,{children:["\u7136\u540e\u4fee\u6539 kube-system \u547d\u4ee4\u7a7a\u95f4\u91cc\u9762\u7684 traefik-ingress-controller daemonset \uff0c\u4e3b\u8981\u662f\u628a\u521a\u624d\u521b\u5efa\u7684 ca-secret \u6302\u8f7d\u5230\u914d\u7f6e\u7684 ",(0,t.jsx)(n.strong,{children:"/tests/ca.crt"})," \u76ee\u5f55\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ kubectl edit daemonsets -n kube-system traefik-ingress-controller\n...\n        volumeMounts:\n        - mountPath: /config\n          name: config\n        # \u6dfb\u52a0\u8fd9\u4e2a volume mount\uff0c\u540d\u79f0\u4e3a ca\n        - mountPath: /tests\n          name: ca\n...\n      volumes:\n      - configMap:\n          defaultMode: 420\n          name: traefik-ingress-lb\n        name: config\n      - name: ca\n        secret:\n          defaultMode: 420\n          # \u8fd9\u91cc\u5f15\u7528\u4e4b\u524d\u521b\u5efa\u7684 ca-secret\n          secretName: ca-secret\n...\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u91cd\u542f-traefik-\u670d\u52a1",children:"\u91cd\u542f traefik \u670d\u52a1"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ kubectl get pods -n kube-system | grep traefik | awk '{print $1}' | xargs kubectl delete pods -n kube-system\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u7b49\u5f85 traefik \u5bb9\u5668\u53d8\u6210 Running\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"$ kubectl get pods -n kube-system | grep traefik\ntraefik-ingress-controller-fk54h           1/1     Running       0          9s\n"})}),"\n",(0,t.jsx)(n.h2,{id:"\u4f7f\u7528-curl-\u8fdb\u884c\u6d4b\u8bd5",children:"\u4f7f\u7528 curl \u8fdb\u884c\u6d4b\u8bd5"}),"\n",(0,t.jsxs)(n.p,{children:["\u5047\u8bbe\u90e8\u7f72\u7684\u524d\u7aef\u8bbf\u95ee\u5730\u5740\u662f ",(0,t.jsx)(n.a,{href:"https://192.168.121.21",children:"https://192.168.121.21"})," \uff0c\u4e0b\u9762\u9a8c\u8bc1\u5ba2\u6237\u7aef\u8ba4\u8bc1\u662f\u5426\u5f00\u542f\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'# \u4e0d\u4f7f\u7528 client \u8bc1\u4e66\u8bbf\u95ee\u5931\u8d25\uff0c\u7b26\u5408\u9884\u671f\n$ curl -k https://192.168.121.21\ncurl: (58) NSS: client certificate not found (nickname not specified)\n\n# \u4f7f\u7528 client \u8bc1\u4e66\u8bbf\u95ee\u6210\u529f\n$ curl -k --cert ./client.crt --key ./client.key https://192.168.121.21\n<!DOCTYPE html><html lang=en translate=no><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=google content=notranslate><link rel=icon href=/favicon.ico><title>\u4e91\u8054\u58f9\u4e91</title><link href=/js/chunk-2d216214.5f7b7e0c.js rel=prefetch><link href=/js/chunk-39bb5eb4.8512e62d.js rel=prefetch><link href=/css/app.fb52a32e.css rel=preload as=style><link href=/css/chunk-vendors.09e9c25d.css rel=preload as=style><link href=/js/app.74cda7af.js rel=preload as=script><link href=/js/chunk-vendors.a7b5c015.js rel=preload as=script><link href=/css/chunk-vendors.09e9c25d.css rel=stylesheet><link href=/css/app.fb52a32e.css rel=stylesheet></head><body><noscript><strong>We\'re sorry but OneCloud doesn\'t work properly without JavaScript enabled. Please enable it to continue.</strong></noscript><div id=app></div><script src=/vendor.b82688a471b737ceddd1.js><\/script><script src=/js/chunk-vendors.a7b5c015.js><\/script><script src=/js/app.74cda7af.js><\/script></body></html>\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u6d4f\u89c8\u5668\u914d\u7f6e",children:"\u6d4f\u89c8\u5668\u914d\u7f6e"}),"\n",(0,t.jsx)(n.p,{children:"\u901a\u8fc7\u4ee5\u4e0a\u7684\u914d\u7f6e\uff0c\u53d1\u73b0\u5ba2\u6237\u7aef\u914d\u7f6e\u5df2\u7ecf\u6210\u529f\uff0c\u4f46\u901a\u8fc7\u6d4f\u89c8\u5668\u8bbf\u95ee\uff0c\u8fd8\u9700\u8981\u628a\u5ba2\u6237\u7aef\u7684\u8bc1\u4e66\u653e\u5230\u6d4f\u89c8\u5668\u91cc\u9762\uff0c\u5426\u5219\u8bbf\u95ee\u5c31\u4f1a\u51fa\u73b0\u4e0b\u9762\u7684\u754c\u9762\uff1a"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(54019).Z+"",width:"1950",height:"815"})}),"\n",(0,t.jsx)(n.p,{children:"\u4e0b\u9762\u4ee5 Chrome \u6d4f\u89c8\u5668\u4e3a\u4f8b\uff0c \u9700\u8981\u628a\u4e4b\u524d\u751f\u6210\u7684 client.crt \u548c client.key \u88c5\u6362\u6210 pfx/pkcs12 \u683c\u5f0f\uff0c\u5c31\u80fd\u5bfc\u5165\u6d4f\u89c8\u5668\uff0c\u547d\u4ee4\u5982\u4e0b\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# \u628a client.crt \u548c client.key \u7ec4\u5408\u5230\u4e00\u8d77\n$ cat client.crt client.key > pkcs12.pem \n\n# \u8f6c\u6362\u6210 pkcs12 \u683c\u5f0f\n$ openssl pkcs12 -in pkcs12.pem -export -out pkcs12.p12\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u628a pkcs12.p12 \u5bfc\u5165\u5230\u6d4f\u89c8\u5668\uff1a"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(59216).Z+"",width:"2289",height:"994"})}),"\n",(0,t.jsx)(n.p,{children:"\u9009\u62e9\u521a\u624d\u751f\u6210\u7684 pkcs12.p12 \u8bc1\u4e66\uff1a"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(75208).Z+"",width:"2550",height:"696"})}),"\n",(0,t.jsx)(n.p,{children:"\u5bfc\u5165\u540e\u518d\u5237\u65b0\u8bbf\u95ee\u524d\u7aef\uff0c\u5c31\u53ef\u4ee5\u6210\u529f\u8bbf\u95ee\u754c\u9762\u3002"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:s(59275).Z+"",width:"2504",height:"1141"})})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},54019:(e,n,s)=>{s.d(n,{Z:()=>t});const t=s.p+"assets/images/chrome-bad-ssl-client-26bf6720cd8d878eb57877bec2cc3da9.png"},59216:(e,n,s)=>{s.d(n,{Z:()=>t});const t=s.p+"assets/images/chrome-certs-f93ceb904377b4d130ff9b9a814923e4.png"},75208:(e,n,s)=>{s.d(n,{Z:()=>t});const t=s.p+"assets/images/chrome-import-pkcs12-68cc0a641debbbad9c262ecd844ca5be.png"},59275:(e,n,s)=>{s.d(n,{Z:()=>t});const t=s.p+"assets/images/chrome-web-b360c61a5cfbc973576d9e3384c88c5a.png"},11151:(e,n,s)=>{s.d(n,{Z:()=>a,a:()=>i});var t=s(67294);const r={},c=t.createContext(r);function i(e){const n=t.useContext(c);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(c.Provider,{value:n},e.children)}}}]);