"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[419],{81243:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var a=t(85893),i=t(11151);const r={sidebar_position:1},o="Deploy Mariadb HA",s={id:"getting-started/misc/db-ha",title:"Deploy Mariadb HA",description:"Use keepalived and Mariadb's master-master replication feature to achieve high availability of DB.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/getting-started/misc/db-ha.md",sourceDirName:"getting-started/misc",slug:"/getting-started/misc/db-ha",permalink:"/en/docs/getting-started/misc/db-ha",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/getting-started/misc/db-ha.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Miscellaneous",permalink:"/en/docs/getting-started/misc/"},next:{title:"User Guides",permalink:"/en/docs/guides/"}},l={},d=[{value:"Deployment",id:"deployment",level:2},{value:"Configure Mariadb master-master replication",id:"configure-mariadb-master-master-replication",level:3},{value:"Deploy and configure keepalived",id:"deploy-and-configure-keepalived",level:3},{value:"Configure <code>keepalived</code> to switch network adapter automatically",id:"configure-keepalived-to-switch-network-adapter-automatically",level:3}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"deploy-mariadb-ha",children:"Deploy Mariadb HA"}),"\n",(0,a.jsx)(n.p,{children:"Use keepalived and Mariadb's master-master replication feature to achieve high availability of DB."}),"\n",(0,a.jsx)(n.h2,{id:"deployment",children:"Deployment"}),"\n",(0,a.jsx)(n.p,{children:"The main function of keepalived is to provide vip for Mariadb, switching between 2 Mariadb instances to provide uninterrupted service."}),"\n",(0,a.jsx)(n.p,{children:"In the following example:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"DB VIP: 192.168.199.97"}),"\n",(0,a.jsx)(n.li,{children:"Primary node IP: 192.168.199.98"}),"\n",(0,a.jsx)(n.li,{children:"Backup node IP: 192.168.199.99"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"configure-mariadb-master-master-replication",children:"Configure Mariadb master-master replication"}),"\n",(0,a.jsx)(n.p,{children:"Install and start Mariadb"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ yum install -y mariadb-server\n$ systemctl enable --now mariadb\n"})}),"\n",(0,a.jsx)(n.p,{children:"Run the Mariadb Security Configuration Wizard to set passwords, etc."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ mysql_secure_installation\n ... ...\nChange the root password? [Y/n] y\nNew password:\nRe-enter new password:\nPassword updated successfully!\nReloading privilege tables..\n ... Success!\n ... ...\nRemove anonymous users? [Y/n] y\n ... Success!\n ... ...\nDisallow root login remotely? [Y/n] y\n ... Success!\n ... ...\nRemove test database and access to it? [Y/n] y\n - Dropping test database...\n ... Success!\n - Removing privileges on test database...\n ... Success! ... ...\nReload privilege tables now? [Y/n] y\n ... Success!\n ... ...\n"})}),"\n",(0,a.jsx)(n.p,{children:"Modify the Mariadb configuration file to prepare for configuring the master-master replication."}),"\n",(0,a.jsxs)(n.p,{children:["Note: The difference between primary and secondary is the ",(0,a.jsx)(n.code,{children:"confserver-id"})," and ",(0,a.jsx)(n.code,{children:"auto_increment_offset"})," fields."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Primary node\n$ cat <<EOF > /etc/my.cnf\n[mysqld]\ndatadir=/var/lib/mysql\nsocket=/var/lib/mysql/mysql.sock\n# Disabling symbolic-links is recommended to prevent assorted security risks\nsymbolic-links=0\n# Settings user and group are ignored when systemd is used.\n# If you need to run mysqld under a different user or group,\n# customize your systemd unit file for mariadb according to the\n# instructions in http://fedoraproject.org/wiki/Systemd\n# skip domain name resolve\nskip_name_resolve\n# auto delete binlog older than 30 days\nexpire_logs_days=30\ninnodb_file_per_table=ON\nmax_connections = 300\nmax_allowed_packet=20M\n\nserver-id = 1\nauto_increment_offset = 1\nauto_increment_increment = 2\nlog-bin = mysql-bin\nbinlog-format = row\nlog-slave-updates\nmax_binlog_size = 1G\nreplicate-ignore-db = information_schema\nreplicate-ignore-db = performance_schema\nmax_connections = 1000\nmax_connect_errors = 0\nmax_allowed_packet = 1G\nslave-net-timeout=10\nmaster-retry-count=0\n\nslow_query_log = 1\nlong_query_time = 2\nslow_query_log_file = /var/log/mariadb/slow-query.log\n\n[mysql]\nno-auto-rehash\n\n[mysqld_safe]\nlog-error=/var/log/mariadb/mariadb.log\npid-file=/var/run/mariadb/mariadb.pid\n\n#\n# include all files from the config directory\n#\n!includedir /etc/my.cnf.d\nEOF\n\n# Backup Node\n$ cat <<EOF > /etc/my.cnf\n[mysqld]\ndatadir=/var/lib/mysql\nsocket=/var/lib/mysql/mysql.sock\n# Disabling symbolic-links is recommended to prevent assorted security risks\nsymbolic-links=0\n# Settings user and group are ignored when systemd is used.\n# If you need to run mysqld under a different user or group,\n# customize your systemd unit file for mariadb according to the\n# instructions in http://fedoraproject.org/wiki/Systemd\n# skip domain name resolve\nskip_name_resolve\n# auto delete binlog older than 30 days\nexpire_logs_days=30\ninnodb_file_per_table=ON\nmax_connections = 300\nmax_allowed_packet=20M\n\nserver-id = 2\nauto_increment_offset = 2\nauto_increment_increment = 2\nlog-bin = mysql-bin\nbinlog-format = row\nlog-slave-updates\nmax_binlog_size = 1G\nreplicate-ignore-db = information_schema\nreplicate-ignore-db = performance_schema\nmax_connections = 1000\nmax_connect_errors = 0\nmax_allowed_packet = 1G\nslave-net-timeout=10\nmaster-retry-count=0\n\nslow_query_log = 1\nlong_query_time = 2\nslow_query_log_file = /var/log/mariadb/slow-query.log\n\n[mysql]\nno-auto-rehash\n\n[mysqld_safe]\nlog-error=/var/log/mariadb/mariadb.log\npid-file=/var/run/mariadb/mariadb.pid\n\n#\n# include all files from the config directory\n#\n!includedir /etc/my.cnf.d\nEOF\n\n# Restart the service\n$ systemctl restart mariadb\n"})}),"\n",(0,a.jsx)(n.p,{children:"On the primary node, create a read-only account, export all data, and import it into the backup node. Record the name and position of the binlog log file."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# The following commands are executed on the primary node\n\n# This password is for the Mariadb root set above. For convenience, the read-only account also uses this password\n$ MYSQL_PASSWD='your-sql-passwd'\n\n# Enable remote access to Mariadb\n$ mysql -uroot -p$MYSQL_PASSWD -e \"GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '$MYSQL_PASSWD' WITH GRANT OPTION;FLUSH PRIVILEGES\"\n\n# Create a read-only account\n$ mysql -u root -p$MYSQL_PASSWD -e \"GRANT REPLICATION SLAVE ON *.* TO repl@'%' IDENTIFIED BY '$MYSQL_PASSWD';FLUSH PRIVILEGES\"\n\n# This example is for a fresh installation of Mariadb that hasn't been used yet. If you're doing master-master replication of a database that's already in use, you need to lock the table before exporting data. \n``````bash\n$ mysql -uroot -p$MYSQL_PASSWD -e \"SHOW PROCESSLIST\"\n+----+------+-----------+------+---------+------+-------+------------------+----------+\n| Id | User | Host      | db   | Command | Time | State | Info             | Progress |\n+----+------+-----------+------+---------+------+-------+------------------+----------+\n|  4 | root | localhost | NULL | Query   |    0 | NULL  | SHOW PROCESSLIST |    0.000 |\n+----+------+-----------+------+---------+------+-------+------------------+----------+\n\n# Record the binlog file name and position\n$ mysql -u root -p$MYSQL_PASSWD -e \"SHOW MASTER STATUS\\G\"\n*************************** 1. row ***************************\n            File: mysql-bin.000001\n        Position: 2023\n    Binlog_Do_DB:\nBinlog_Ignore_DB:\n\n# Export all data\n$ mysqldump --all-databases -p$MYSQL_PASSWD > alldb.db\n\n# Copy alldb.db to the backup node\n$ scp alldb.db db2:/root/\n\n\n# Execute the following commands on the backup node\n\n# This password is the MariaDB root password set above\n$ MYSQL_PASSWD='your-sql-passwd'\n\n# Import the data exported from the primary node\nmysql -u root -p$MYSQL_PASSWD < alldb.db\n\n# Reload privileges\nmysql -u root -p$MYSQL_PASSWD -e \"FLUSH PRIVILEGES\"\n\n# Record the binlog file name and position\nmysql -u root -p$MYSQL_PASSWD -e \"SHOW MASTER STATUS\\G\"\n*************************** 1. row ***************************\n            File: mysql-bin.000001\n        Position: 509778\n    Binlog_Do_DB:\nBinlog_Ignore_DB:\n"})}),"\n",(0,a.jsx)(n.p,{children:"Set up master-slave replication"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# Execute the following commands on the primary node\n\n# Modify MASTER_HOST to the IP address of the backup node, and modify MASTER_LOG_FILE and MASTER_LOG_POS based on the information recorded on the backup node\nmysql -u root -p$MYSQL_PASSWD -e \"CHANGE MASTER TO MASTER_HOST='192.168.199.99',MASTER_USER='repl',MASTER_PASSWORD='$MYSQL_PASSWD',MASTER_PORT=3306,MASTER_LOG_FILE='mysql-bin.000001',MASTER_LOG_POS=509778,MASTER_CONNECT_RETRY=2;START SLAVE\"\n\n\n# Execute the following commands on the backup node\n\n# Modify MASTER_HOST to the IP address of the primary node, and modify MASTER_LOG_FILE and MASTER_LOG_POS based on the information recorded on the primary node\nmysql -u root -p$MYSQL_PASSWD -e \"CHANGE MASTER TO MASTER_HOST='192.168.199.98',MASTER_USER='repl',MASTER_PASSWORD='$MYSQL_PASSWD',MASTER_PORT=3306,MASTER_LOG_FILE='mysql-bin.000001',MASTER_LOG_POS=2023,MASTER_CONNECT_RETRY=2;START SLAVE\"\n\n\n# Execute this command on both primary and backup nodes, verify synchronization status, and output 2 Yes to indicate normal status\nmysql -u root -p$MYSQL_PASSWD -e \"SHOW SLAVE STATUS\\G\" | grep Running\nSlave_IO_Running: Yes\nSlave_SQL_Running: Yes\n\n# If this step fails, for example, if Slave_SQL_Running is connecting, it's highly likely that the firewall has not been turned off. Please execute the following command to turn off the firewall, and then redo the previous step of checking the two Yes.\nsystemctl is-active firewalld >/dev/null && systemctl disable --now firewalld\n"})}),"\n",(0,a.jsx)(n.p,{children:"The DB master-master replication deployment is now complete. You can test database operations on any node and verify them on the other node. However, it is still necessary to provide services externally through the VIP, otherwise if a switch occurs, the business side will need to switch IPs. Next, configure keepalived to provide external services."}),"\n",(0,a.jsx)(n.h3,{id:"deploy-and-configure-keepalived",children:"Deploy and configure keepalived"}),"\n",(0,a.jsx)(n.p,{children:"Set the relevant environment variables and configure them according to different environments."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"# keepalived vip address\nexport DB_VIP=192.168.199.97\n\n# keepalived auth toke\nexport DBHA_KA_AUTH=onecloud\n\n# keepalived network interface\nexport DB_NETIF=eth0\n"})}),"\n",(0,a.jsx)(n.p,{children:"Set sysctl options"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ cat <<EOF >>/etc/sysctl.conf\nnet.ipv4.ip_forward=1\nnet.ipv4.ip_nonlocal_bind=1\nEOF\n\n$ sysctl -p\n"})}),"\n",(0,a.jsx)(n.p,{children:"Install keepalived nc"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ yum install -y keepalived nc\n"})}),"\n",(0,a.jsx)(n.p,{children:"Add configuration"}),"\n",(0,a.jsx)(n.p,{children:"The following is the configuration for the primary node:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# Make sure virtual_router_id doesn\'t conflict with other keepalived clusters on the local network\n$ cat <<EOF >/etc/keepalived/keepalived.conf\nglobal_defs {\n    router_id onecloud\n}\n\nvrrp_script chk_mysql {\n    script "/etc/keepalived/chk_mysql"\n    interval 1\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface $DB_NETIF\n    virtual_router_id 99\n    priority 100\n    advert_int 1\n    nopreempt\n    authentication {\n        auth_type PASS\n        auth_pass $DBHA_KA_AUTH\n    }\n\n    track_script {\n        chk_mysql\n    }\n\n    virtual_ipaddress {\n        $DB_VIP\n    }\n}\nEOF\n\n$ cat <<EOF > /etc/keepalived/chk_mysql\n#!/bin/bash\necho | nc 127.0.0.1 3306 &>/dev/null\nEOF\n\n$ chmod +x /etc/keepalived/chk_mysql\n'})}),"\n",(0,a.jsx)(n.p,{children:"The following is the configuration for the backup node:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# Make sure the virtual_router_id of the backup node is the same as that of the primary node\n$ cat <<EOF >/etc/keepalived/keepalived.conf\nglobal_defs {\n    router_id onecloud\n}\n\nvrrp_script chk_mysql {\n    script "/etc/keepalived/chk_mysql"\n    interval 1\n}\n\nvrrp_instance VI_1 {\n    state BACKUP\n    interface $DB_NETIF\n    virtual_router_id 99\n    priority 99\n    advert_int 1\n    nopreempt\n    authentication {\n        auth_type PASS\n        auth_pass $DBHA_KA_AUTH\n    }\n\n    track_script {\n        chk_mysql\n    }\n\n    virtual_ipaddress {\n        $DB_VIP \n    }\n}\nEOF\n\n$ cat <<EOF > /etc/keepalived/chk_mysql\n#!/bin/bash\necho | nc 127.0.0.1 3306 &>/dev/null\nEOF\n\n$ chmod +x /etc/keepalived/chk_mysql\n'})}),"\n",(0,a.jsxs)(n.p,{children:["After the configuration is complete, start ",(0,a.jsx)(n.code,{children:"keepalived"})," on the master and standby nodes respectively using the following command:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ systemctl enable --now keepalived\n$ ip addr show $DB_NETIF\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 00:22:cf:40:1e:29 brd ff:ff:ff:ff:ff:ff\n    inet 192.168.199.99/24 brd 192.168.199.255 scope global dynamic eth0\n       valid_lft 100651906sec preferred_lft 100651906sec\n    inet 192.168.199.97/32 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::222:cfff:fe40:1e29/64 scope link\n       valid_lft forever preferred_lft forever\n"})}),"\n",(0,a.jsxs)(n.h3,{id:"configure-keepalived-to-switch-network-adapter-automatically",children:["Configure ",(0,a.jsx)(n.code,{children:"keepalived"})," to switch network adapter automatically"]}),"\n",(0,a.jsxs)(n.p,{children:["In this solution, ",(0,a.jsx)(n.code,{children:"k8s"})," and ",(0,a.jsx)(n.code,{children:"mysql"})," share the same network adapter. If ",(0,a.jsx)(n.code,{children:"k8s"})," uses the ",(0,a.jsx)(n.code,{children:"host"})," feature, it will automatically enable the ",(0,a.jsx)(n.code,{children:"br0"})," network adapter. When ",(0,a.jsx)(n.code,{children:"host"})," starts or switches network adapters, it may affect the high availability of ",(0,a.jsx)(n.code,{children:"mysql"}),". The following auxiliary script can enhance the stability of ",(0,a.jsx)(n.code,{children:"k8s+mysql"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Run the following scripts respectively on the primary and standby nodes of ",(0,a.jsx)(n.code,{children:"db"}),". Be sure to replace the ",(0,a.jsx)(n.code,{children:"node_ip"})," variable in the first line with the machine's own IP address."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'# Replace the variable DB_NODE_IP in this script with the local IP address\nnode_ip=$DB_NODE_IP\n[[ -z "$node_ip" ]] && echo "please export variable \'node_ip\' first! "\n\ncat <<EOF_CK1 >/etc/keepalived/check_interface.sh\n#!/usr/bin/env bash\n\ndatestr="\\$(date +"%F %T")"\nenv_interface=\\$(cat /etc/keepalived/keepalived.conf| grep -w interface |awk \'{print \\$2}\')\necho "[\\$datestr] The interface keepalived is currently listening on: \\$env_interface"\nrouter_interface=\\$(/usr/sbin/ip a show | grep $node_ip | awk \'{ print \\$NF}\')\necho "[\\$datestr] The name of the interface where the ip is located: [\\$router_interface]"\n\nif [[ -n "\\$router_interface" ]] && [[ "\\$router_interface" != "\\$env_interface" ]]; then\n    echo "[\\$datestr] updating keepalived.conf interface"\n    sed -i -e "s#\\$env_interface#\\$router_interface#g" /etc/keepalived/keepalived.conf\n    systemctl restart keepalived\nelse\n    echo "[\\$datestr] No need to update interface. "\nfi\nEOF_CK1\n\ncat <<EOF_CK2 >/etc/keepalived/check_interface2.sh\n#!/usr/bin/env bash\nfor i in {1..3}; do\n    /etc/keepalived/check_interface.sh >> /var/log/keepalived.log\n    sleep 20\ndone\nEOF_CK2\n\ncat <<EOF_CRON >/etc/cron.d/update_keepalived_interface\n* * * * * root /etc/keepalived/check_interface2.sh >/dev/null 2>&1\nEOF_CRON\nsystemctl restart crond\nchmod +x /etc/keepalived/chk_mysql\nchmod +x /etc/keepalived/check_interface.sh\nchmod +x /etc/keepalived/check_interface2.sh\n\nsystemctl enable --now keepalived\nsystemctl restart keepalived\nchmod +x /etc/rc.d/rc.local\nif ! grep -q /etc/keepalived/check_interface.sh /etc/rc.d/rc.local; then\n    sed -i \'$a bash /etc/keepalived/check_interface.sh >> /var/log/keepalived.log\' /etc/rc.d/rc.local\nfi\n'})}),"\n",(0,a.jsx)(n.p,{children:"Thus, the high availability deployment of DB is completed. The Mariadb or keepalived service of any node can be down without affecting external services in case of a node failure."})]})}function p(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>o});var a=t(67294);const i={},r=a.createContext(i);function o(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);