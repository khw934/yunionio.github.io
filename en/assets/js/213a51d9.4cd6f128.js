"use strict";(self.webpackChunkdocs_new=self.webpackChunkdocs_new||[]).push([[4519],{89021:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var n=i(74848),o=i(28453);const r={sidebar_position:2},s="Switching Influxdb to VictoriaMetrics",a={id:"operations/monitoring/migrating-to-vm",title:"Switching Influxdb to VictoriaMetrics",description:"VictoriaMetrics has fewer resource requirements and faster query speed than Influxdb. Starting from version v3.10.8, the monitoring backend TSDB (time-series database) can be switched from Influxdb to VictoriaMetrics.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/operations/monitoring/migrating-to-vm.md",sourceDirName:"operations/monitoring",slug:"/operations/monitoring/migrating-to-vm",permalink:"/en/docs/operations/monitoring/migrating-to-vm",draft:!1,unlisted:!1,editUrl:"https://github.com/yunionio/website/tree/master/docs/operations/monitoring/migrating-to-vm.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"\u76d1\u63a7\u8fd0\u7ef4",permalink:"/en/docs/operations/monitoring/"},next:{title:"Hidden Feature Configuration",permalink:"/en/docs/operations/hidden-feature-config"}},l={},c=[{value:"Deploy VictoriaMetrics",id:"deploy-victoriametrics",level:2},{value:"Switching",id:"switching",level:2},{value:"Disable operator management of the influxdb service",id:"disable-operator-management-of-the-influxdb-service",level:3},{value:"Delete the registration address of influxdb in the platform",id:"delete-the-registration-address-of-influxdb-in-the-platform",level:3},{value:"Restart platform services",id:"restart-platform-services",level:3},{value:"Migrating Influxdb monitoring data (optional)",id:"migrating-influxdb-monitoring-data-optional",level:2},{value:"Download vmctl migration tool",id:"download-vmctl-migration-tool",level:3},{value:"Migrate data",id:"migrate-data",level:3},{value:"Delete the Influxdb Service",id:"delete-the-influxdb-service",level:2},{value:"Access VictoriaMetrics Frontend",id:"access-victoriametrics-frontend",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"switching-influxdb-to-victoriametrics",children:"Switching Influxdb to VictoriaMetrics"}),"\n",(0,n.jsx)(t.p,{children:"VictoriaMetrics has fewer resource requirements and faster query speed than Influxdb. Starting from version v3.10.8, the monitoring backend TSDB (time-series database) can be switched from Influxdb to VictoriaMetrics."}),"\n",(0,n.jsx)(t.admonition,{type:"tip",children:(0,n.jsx)(t.p,{children:"We will use VictoriaMetrics as the default TSDB starting from version 3.11. So the following steps only apply to versions before 3.11."})}),"\n",(0,n.jsx)(t.h2,{id:"deploy-victoriametrics",children:"Deploy VictoriaMetrics"}),"\n",(0,n.jsx)(t.p,{children:"Once upgraded to v3.10.8, the VictoriaMetrics service will be automatically deployed in the kubernetes cluster deployed using ocboot. You can use the following command to check the status of the pod:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ kubectl get pods -n onecloud | grep victoria\ndefault-victoria-metrics-6d6fcc68d5-q68mj            1/1     Running            0          25d\n"})}),"\n",(0,n.jsxs)(t.p,{children:["If the pod starting with ",(0,n.jsx)(t.code,{children:"default-victoria-metrics-"})," has the status of Running, then the VictoriaMetrics service has been deployed successfully."]}),"\n",(0,n.jsx)(t.h2,{id:"switching",children:"Switching"}),"\n",(0,n.jsx)(t.p,{children:"Both Influxdb and VictoriaMetrics services now exist in the cluster. You can run the following command to check the status of the pods:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ kubectl get pods -n onecloud | egrep 'victoria|influxdb'\ndefault-influxdb-5dcfc8964d-5csrw                    1/1     Running            0          23d\ndefault-victoria-metrics-6d6fcc68d5-q68mj            1/1     Running            0          25d\n"})}),"\n",(0,n.jsx)(t.p,{children:"Now follow these steps to make VictoriaMetrics the default TSDB for the platform."}),"\n",(0,n.jsx)(t.h3,{id:"disable-operator-management-of-the-influxdb-service",children:"Disable operator management of the influxdb service"}),"\n",(0,n.jsx)(t.p,{children:"First, disable the operator's management of the influxdb service as follows:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ kubectl patch onecloudcluster -n onecloud default --type='json' -p='[{op: replace, path: /spec/influxdb/disable, value: true}]'\n"})}),"\n",(0,n.jsx)(t.h3,{id:"delete-the-registration-address-of-influxdb-in-the-platform",children:"Delete the registration address of influxdb in the platform"}),"\n",(0,n.jsx)(t.p,{children:"Then delete the influxdb endpoint in the platform as follows:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ climc endpoint-list --service influxdb | awk '{print $2}' | xargs -I {} sh -c 'climc endpoint-update --disable {} && climc endpoint-delete {}'\n"})}),"\n",(0,n.jsx)(t.p,{children:"Delete the influxdb service in the platform as follows:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ climc service-update --disabled influxdb && climc service-delete influxdb\n"})}),"\n",(0,n.jsx)(t.h3,{id:"restart-platform-services",children:"Restart platform services"}),"\n",(0,n.jsxs)(t.p,{children:["When there is only the ",(0,n.jsx)(t.code,{children:"victoria-metrics"})," endpoint in the platform, the platform will automatically use the VictoriaMetrics corresponding to the endpoint as the TSDB backend. You can use the following command to check the endpoint registered in the platform for VictoriaMetrics:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ climc endpoint-list --search victoria-metrics --details\n"})}),"\n",(0,n.jsxs)(t.admonition,{type:"warning",children:[(0,n.jsx)(t.p,{children:"Make sure there are no endpoints with an influxdb type address here. Otherwise, the platform will default to using influxdb as the TSDB backend. You can run the following command to check if there are any endpoints with an influxdb type address."}),(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ climc endpoint-list --search influxdb --details\n"})})]}),"\n",(0,n.jsx)(t.p,{children:"Use the following command to restart the platform service that connects to the TSDB:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"kubectl get deployment -n onecloud | egrep 'region|monitor|meter|cloudmon|suggestion' | awk '{print $1}' | xargs kubectl rollout restart deployment -n onecloud\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Restart the ",(0,n.jsx)(t.code,{children:"host"})," service (if it is a multi-cloud deployment, skip this step):"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ kubectl -n onecloud rollout restart daemonset default-host\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Finally, you can check whether the ",(0,n.jsx)(t.code,{children:"monitor"})," service is using VictoriaMetrics as its backend TSDB with the command below:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ kubectl logs -n onecloud $(kubectl get pods -n onecloud | grep monitor | awk '{print $1}') | grep 'TSDB data source'\n"})}),"\n",(0,n.jsxs)(t.p,{children:["If the following log appears, it indicates that the ",(0,n.jsx)(t.code,{children:"monitor"})," service has successfully used VictoriaMetrics as its backend TSDB."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:'[info 2023-12-04 07:01:53 datasource.(*dataSourceManager).setDataSource(datasource.go:116)] set TSDB data source "victoria-metrics": "https://default-victoria-metrics:30428"\n'})}),"\n",(0,n.jsx)(t.h2,{id:"migrating-influxdb-monitoring-data-optional",children:"Migrating Influxdb monitoring data (optional)"}),"\n",(0,n.jsxs)(t.admonition,{type:"tip",children:[(0,n.jsx)(t.p,{children:"If the monitoring data in Influxdb is not important, you can skip this step. The following operation is to migrate historical monitoring data in Influxdb to the environment where VictoriaMetrics is located."}),(0,n.jsx)(t.p,{children:"In addition, the migration of data must ensure that both Influxdb and VictoriaMetrics services are running at the same time."})]}),"\n",(0,n.jsx)(t.h3,{id:"download-vmctl-migration-tool",children:"Download vmctl migration tool"}),"\n",(0,n.jsxs)(t.p,{children:["The main purpose is to download the ",(0,n.jsx)(t.code,{children:"vmctl"})," tool, which is used to import historical data from Influxdb to VictoriaMetrics. Please download the corresponding version according to your own environment from the following download address:"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["x86_64: ",(0,n.jsx)(t.a,{href:"https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-amd64",children:"https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-amd64"})]}),"\n",(0,n.jsxs)(t.li,{children:["arm64: ",(0,n.jsx)(t.a,{href:"https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-arm64",children:"https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-arm64"})]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Here, we take x86_64 environment as an example:"}),"\n",(0,n.jsx)(t.admonition,{type:"tip",children:(0,n.jsx)(t.p,{children:"All the following commands should be executed on the control node of the platform."})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"# Download vmctl-linux-amd64 tool\n$ wget https://github.com/zexi/VictoriaMetrics/releases/download/v1.94.0-vmctl-https-import/vmctl-linux-amd64\n\n# Add executable permission\n$ chmod a+x ./vmctl-linux-amd64\n\n# Place it under the /opt/yunion/bin directory\n$ mv ./vmctl-linux-amd64 /opt/yunion/bin\n"})}),"\n",(0,n.jsx)(t.h3,{id:"migrate-data",children:"Migrate data"}),"\n",(0,n.jsxs)(t.p,{children:["Write the migration script below. Assuming the IP of the control node is ",(0,n.jsx)(t.code,{children:"192.168.222.171"}),", the addresses of Influxdb and VictoriaMetrics services in the environment are:"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Influxdb: ",(0,n.jsx)(t.a,{href:"https://192.168.222.171:30086",children:"https://192.168.222.171:30086"})]}),"\n",(0,n.jsxs)(t.li,{children:["VictoriaMetrics: ",(0,n.jsx)(t.a,{href:"https://192.168.222.171:30428",children:"https://192.168.222.171:30428"})]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["Save the following shell script to the ",(0,n.jsx)(t.code,{children:"./vm-mig.sh"})," file."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"#!/bin/bash\n\n# Specify the service address of Influxdb and VictoriaMetrics\nIP=192.168.222.171\nVM_URL=\"https://$IP:30428\"\nINFLUX_URL=\"https://$IP:30086\"\n\n# Specify the start and end time periods for migrating Influxdb data\nSTART_TIME='2023-11-10T00:00:00Z'\nEND_TIME='2023-12-10T00:00:00Z'\n\n/opt/yunion/bin/vmctl-linux-amd64 influx -s \\\n        --influx-retention-policy 30day_only \\\n        --influx-addr $INFLUX_URL --influx-database telegraf \\\n        --influx-concurrency 4 \\\n        --influx-filter-time-start $START_TIME \\\n        --influx-filter-time-end $END_TIME \\\n        --vm-addr $VM_URL\n"})}),"\n",(0,n.jsx)(t.p,{children:"Finally, run the migration script, the length of time taken for migration depends on the amount of data in Influxdb."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ bash -x ./vm-mig.sh\n"})}),"\n",(0,n.jsx)(t.h2,{id:"delete-the-influxdb-service",children:"Delete the Influxdb Service"}),"\n",(0,n.jsx)(t.p,{children:"After using VictoriaMetrics as TSDB, the Influxdb service can be deleted, as follows:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"$ kubectl delete deployment -n onecloud default-influxdb\n"})}),"\n",(0,n.jsx)(t.h2,{id:"access-victoriametrics-frontend",children:"Access VictoriaMetrics Frontend"}),"\n",(0,n.jsxs)(t.p,{children:["By default, you can access the VictoriaMetrics frontend web interface through ",(0,n.jsx)(t.code,{children:"https://control node IP:30428/vmui/"}),", and check whether the data has been reported."]}),"\n",(0,n.jsxs)(t.p,{children:["For specific usage, please refer to the documentation: ",(0,n.jsx)(t.a,{href:"/en/docs/development/monitor/query#query-victoriametrics-data",children:"Query VictoriaMetrics Data"}),"."]})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},28453:(e,t,i)=>{i.d(t,{R:()=>s,x:()=>a});var n=i(96540);const o={},r=n.createContext(o);function s(e){const t=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),n.createElement(r.Provider,{value:t},e.children)}}}]);