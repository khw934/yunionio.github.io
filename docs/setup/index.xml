<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>OneCloud – 安装部署</title>
    <link>https://docs.yunion.io/docs/setup/</link>
    <description>Recent content in 安装部署 on OneCloud</description>
    <generator>Hugo -- gohugo.io</generator>
    
	  <atom:link href="https://docs.yunion.io/docs/setup/index.xml" rel="self" type="application/rss+xml" />
    
    
      
        
      
    
    
    <item>
      <title>Docs: 组件概览</title>
      <link>https://docs.yunion.io/docs/setup/intro/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>https://docs.yunion.io/docs/setup/intro/</guid>
      <description>
        
        
        &lt;p&gt;OneCloud 目前仅支持在 Centos 7 上运行，待部署组件/服务如下:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;服务组件&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;用途&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;安装方式&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;运行方式&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;mariadb&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;关系型数据库&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;docker&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;容器运行时&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;kubelet&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理 kubernetes pod&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;keystone&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;认证服务&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;region&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;api 控制器&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;scheduler&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;调度服务&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;glance&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;镜像存储&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;webconsole&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;虚拟机访问界面&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;influxdb&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;监控数据库&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;host&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理虚拟机&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;sdnagent&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理虚拟机网络&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;baremetal&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理物理机&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;kubernetes deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;climc&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;命令行工具&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;shell&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ocadm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;部署服务管理工具&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;shell&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;其中 host 和 baremetal-agent 可以根据需求选择性部署:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;管理 kvm 虚拟机: 部署 host 和 sdnagent 服务&lt;/li&gt;
&lt;li&gt;管理物理机: 部署 baremetal-agent 服务&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Docs: 部署 HA 环境</title>
      <link>https://docs.yunion.io/docs/setup/controlplane-ha/</link>
      <pubDate>Sat, 13 Apr 2019 13:01:57 +0800</pubDate>
      
      <guid>https://docs.yunion.io/docs/setup/controlplane-ha/</guid>
      <description>
        
        
        

&lt;p&gt;在部署生产可用的 kubernetes 集群之前，需要先部署 LoadBalancer 环境，这里使用 &lt;strong&gt;keepalived + haproxy&lt;/strong&gt; 的方式实现负载均衡和高可用。&lt;/p&gt;

&lt;h2 id=&#34;环境说明&#34;&gt;环境说明&lt;/h2&gt;

&lt;p&gt;单独拿两个节点部署 keepalived 和 haproxy 作为后端 kubernetes 控制平面的负载均衡器，拓扑结构如下:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;../images/k8s.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;

&lt;p&gt;两个节点上面分别部署 keepalived 和 haproxy 组成负载均衡集群，haproxy 的 backend 为后端的 kubernetes control plane node，vip(虚ip) 在这两个节点之间漂移形成高可用。&lt;/p&gt;

&lt;h2 id=&#34;部署&#34;&gt;部署&lt;/h2&gt;

&lt;p&gt;keepalived 的主要作用是为 haproxy 提供 vip，在2个 haproxy 实例之间提供主备，降低当其中一个haproxy失效的时对服务的影响。&lt;/p&gt;

&lt;h3 id=&#34;部署配置-keepalived&#34;&gt;部署配置 keepalived&lt;/h3&gt;

&lt;p&gt;设置相关的环境变量，根据不同的环境自行配置。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# keepalived vip 地址&lt;/span&gt;
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;K8SHA_VIP&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.18

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# keepalived auth toke&lt;/span&gt;
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;K8SHA_KA_AUTH&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;412f7dc3bfed32194d1600c483e10ad1d

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# keepalived network interface&lt;/span&gt;
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;K8SHA_NETIF&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;eth0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;设置 sysctl 选项&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;&amp;gt;/etc/sysctl.conf
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;net.ipv4.ip_forward = 1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;net.ipv4.ip_nonlocal_bind = 1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

$ sysctl -p&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;安装 keepalived&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ yum install -y keepalived&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;添加配置&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/keepalived/keepalived.conf
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;! Configuration File for keepalived
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;global_defs {
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    router_id LVS_DEVEL
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;vrrp_script check_haproxy {
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    script &amp;#34;pidof haproxy&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    interval 3
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    weight -2
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    fall 10
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    rise 2
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;vrrp_instance VI_1 {
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    state MASTER
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    interface $K8SHA_NETIF
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    virtual_router_id 51
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    priority 250
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    advert_int 1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    authentication {
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;        auth_type PASS
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;        auth_pass $K8SHA_KA_AUTH
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    }
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    virtual_ipaddress {
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;        $K8SHA_VIP
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    }
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    track_script {
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;        check_haproxy
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    }
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;启动 keepalived&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; --now keepalived
$ ip addr show &lt;span style=&#34;color:#000&#34;&gt;$K8SHA_NETIF&lt;/span&gt;
&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1500&lt;/span&gt; qdisc mq state UP qlen &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1000&lt;/span&gt;
    link/ether &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;00&lt;/span&gt;:22:ff:95:87:f7 brd ff:ff:ff:ff:ff:ff
    inet &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.189/24 brd &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.18/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::222:ffff:fe95:87f7/64 scope link
       valid_lft forever preferred_lft forever&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;部署配置-haproxy&#34;&gt;部署配置 haproxy&lt;/h3&gt;

&lt;p&gt;此处的 haproxy 为 apiserver 提供反向代理，haproxy 将所有请求轮询转发到每个master节点上。&lt;/p&gt;

&lt;p&gt;系统配置&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;K8S_MASTER0&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.218
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;K8S_MASTER1&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.197
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;K8S_MASTER2&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.207&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;安装 haproxy&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ yum install -y haproxy&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;配置 haproxy&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/haproxy/haproxy.cfg
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# Global settings
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;global
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    # to have these messages end up in /var/log/haproxy.log you will
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    # need to:
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    #
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    # 1) configure syslog to accept network log events.  This is done
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    #    by adding the &amp;#39;-r&amp;#39; option to the SYSLOGD_OPTIONS in
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    #    /etc/sysconfig/syslog
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    #
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    # 2) configure local2 events to go to the /var/log/haproxy.log
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    #   file. A line like the following can be added to
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    #   /etc/sysconfig/syslog
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    #
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    #    local2.*                       /var/log/haproxy.log
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    #
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    log         127.0.0.1 local2
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    chroot      /var/lib/haproxy
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    pidfile     /var/run/haproxy.pid
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    maxconn     4000
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    user        haproxy
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    group       haproxy
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    daemon
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    # turn on stats unix socket
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    stats socket /var/lib/haproxy/stats
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# common defaults that all the &amp;#39;listen&amp;#39; and &amp;#39;backend&amp;#39; sections will
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# use if not designated in their block
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;defaults
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    mode                    http
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    log                     global
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    option                  httplog
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    option                  dontlognull
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    option http-server-close
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    option forwardfor       except 127.0.0.0/8
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    option                  redispatch
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    retries                 3
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    timeout http-request    10s
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    timeout queue           1m
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    timeout connect         10s
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    timeout client          1m
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    timeout server          1m
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    timeout http-keep-alive 10s
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    timeout check           10s
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    maxconn                 3000
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# kubernetes apiserver frontend which proxys to the backends
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;frontend kubernetes-apiserver
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    mode                 tcp
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    bind                 *:6443
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    option               tcplog
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    default_backend      kubernetes-apiserver
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# round robin balancing between the various backends
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;backend kubernetes-apiserver
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    mode        tcp
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    balance     roundrobin
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    server  master-0 $K8S_MASTER0:6443 check
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    server  master-1 $K8S_MASTER1:6443 check
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    server  master-2 $K8S_MASTER2:6443 check
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# collection haproxy statistics message
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#---------------------------------------------------------------------
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;listen stats
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    bind                 *:1080
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    stats auth           admin:awesomePassword
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    stats refresh        5s
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    stats realm          HAProxy\ Statistics
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    stats uri            /admin?stats
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;启动并检测服务&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; haproxy.service --now
$ systemctl status haproxy.service
$ netstat -tulnp &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; egrep &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;6443|1080&amp;#39;&lt;/span&gt;
tcp        &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;      &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;.0.0.0:6443            &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;.0.0.0:*               LISTEN      &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10033&lt;/span&gt;/haproxy
tcp        &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;      &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;.0.0.0:1080            &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;.0.0.0:*               LISTEN      &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10033&lt;/span&gt;/haproxy&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1 id=&#34;部署-kubernetes-集群&#34;&gt;部署 kubernetes 集群&lt;/h1&gt;

&lt;p&gt;参考 &lt;a href=&#34;https://docs.yunion.io/docs/setup/controlplane&#34;&gt;部署集群&lt;/a&gt; 。&lt;/p&gt;

      </description>
    </item>
    
    <item>
      <title>Docs: 部署集群</title>
      <link>https://docs.yunion.io/docs/setup/controlplane/</link>
      <pubDate>Sat, 13 Apr 2019 13:01:57 +0800</pubDate>
      
      <guid>https://docs.yunion.io/docs/setup/controlplane/</guid>
      <description>
        
        
        

&lt;h2 id=&#34;环境准备&#34;&gt;环境准备&lt;/h2&gt;

&lt;p&gt;OneCloud 相关的组件运行在 kubernetes 之上，环境以及相关的软件依赖如下:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;操作系统: Centos 7.x&lt;/li&gt;
&lt;li&gt;最低配置要求: 4核4G&lt;/li&gt;
&lt;li&gt;数据库: mariadb (CentOS 7自带的版本：Ver 15.1 Distrib 5.5.56-MariaDB）&lt;/li&gt;
&lt;li&gt;docker: ce-18.09.1&lt;/li&gt;
&lt;li&gt;kubernetes: v1.14.3&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;需要能访问如下网址，如果企业有外网隔离规则，则需要打开相应白名单：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;CentOS YUM网络安装源&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://mirrors.aliyun.com&#34; target=&#34;_blank&#34;&gt;http://mirrors.aliyun.com&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://iso.yunion.cn/&#34; target=&#34;_blank&#34;&gt;https://iso.yunion.cn/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://registry.cn-beijing.aliyuncs.com&#34; target=&#34;_blank&#34;&gt;https://registry.cn-beijing.aliyuncs.com&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://meta.yunion.cn&#34; target=&#34;_blank&#34;&gt;https://meta.yunion.cn&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://yunionmeta.oss-cn-beijing.aliyuncs.com&#34; target=&#34;_blank&#34;&gt;https://yunionmeta.oss-cn-beijing.aliyuncs.com&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;安装配置-mariadb&#34;&gt;安装配置 mariadb&lt;/h3&gt;

&lt;p&gt;mariadb 作为服务数据持久化的数据库，可以部署在其它节点或者使用单独维护的。下面假设还没有部署 mariadb，在控制节点上安装设置 mariadb。&lt;/p&gt;

&lt;p&gt;为了方便运行维护，mariadb推荐打开两个参数设施：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;skip_name_resolve：取消域名解析&lt;/li&gt;
&lt;li&gt;expire_logs_days=30：设置binlog的超时时间为30天，超过30天的binglog自动删除&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ &lt;span style=&#34;color:#000&#34;&gt;MYSQL_PASSWD&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;your-sql-passwd&amp;#39;&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 安装 mariadb&lt;/span&gt;
$ yum install -y epel-release mariadb-server
$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; --now mariadb
$ mysqladmin -u root password &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$MYSQL_PASSWD&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&lt;/span&gt;
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/my.cnf
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;[mysqld]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;datadir=/var/lib/mysql
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;socket=/var/lib/mysql/mysql.sock
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# Disabling symbolic-links is recommended to prevent assorted security risks
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;symbolic-links=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# Settings user and group are ignored when systemd is used.
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# If you need to run mysqld under a different user or group,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# customize your systemd unit file for mariadb according to the
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# instructions in http://fedoraproject.org/wiki/Systemd
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# skip domain name resolve
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;skip_name_resolve
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# auto delete binlog older than 30 days
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;expire_logs_days=30
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;[mysqld_safe]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;log-error=/var/log/mariadb/mariadb.log
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;pid-file=/var/run/mariadb/mariadb.pid
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# include all files from the config directory
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;!includedir /etc/my.cnf.d
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

$ mysql -uroot -p&lt;span style=&#34;color:#000&#34;&gt;$MYSQL_PASSWD&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  -e &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;GRANT ALL ON *.* to &amp;#39;root&amp;#39;@&amp;#39;%&amp;#39; IDENTIFIED BY &amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$MYSQL_PASSWD&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39; with grant option; FLUSH PRIVILEGES;&amp;#34;&lt;/span&gt;

$ systemctl restart mariadb&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;安装配置-docker&#34;&gt;安装配置 docker&lt;/h3&gt;

&lt;p&gt;安装 docker&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ yum install -y yum-utils bash-completion
$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
$ yum install -y docker-ce-18.09.1 docker-ce-cli-18.09.1 containerd.io&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;配置 docker&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ mkdir -p /etc/docker
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/docker/daemon.json
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;{
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;bridge&amp;#34;: &amp;#34;none&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;iptables&amp;#34;: false,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;exec-opts&amp;#34;:
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    [
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;native.cgroupdriver=systemd&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    ],
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;data-root&amp;#34;: &amp;#34;/opt/docker&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;live-restore&amp;#34;: true,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;log-driver&amp;#34;: &amp;#34;json-file&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;log-opts&amp;#34;:
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    {
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;max-size&amp;#34;: &amp;#34;100m&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    },
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;registry-mirrors&amp;#34;:
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    [
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;https://lje6zxpk.mirror.aliyuncs.com&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;https://lms7sxqp.mirror.aliyuncs.com&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;https://registry.docker-cn.com&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    ],
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;storage-driver&amp;#34;: &amp;#34;overlay2&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;启动 docker&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; --now docker&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;安装配置-kubelet&#34;&gt;安装配置 kubelet&lt;/h3&gt;

&lt;p&gt;从 aliyun 的 yum 源安装 kubernetes 1.14.3，并设置 kubelet 开机自启动&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/yum.repos.d/kubernetes.repo
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;[kubernetes]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;name=Kubernetes
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;enabled=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;gpgcheck=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;repo_gpgcheck=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;
$ yum install -y bridge-utils ipvsadm conntrack-tools jq kubelet-1.14.3-0 kubectl-1.14.3-0 kubeadm-1.14.3-0
$ &lt;span style=&#34;color:#204a87&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;source &amp;lt;(kubectl completion bash)&amp;#39;&lt;/span&gt; &amp;gt;&amp;gt; ~/.bashrc &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;source&lt;/span&gt; ~/.bashrc
$ &lt;span style=&#34;color:#204a87&#34;&gt;source&lt;/span&gt; /etc/profile
$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; kubelet&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;安装完 kubernetes 相关的二进制后，还需要对系统做一些配置并启用 ipvs 作为 kube-proxy 内部的 service 负载均衡&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 禁用 swap&lt;/span&gt;
$ swapoff -a
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 如果设置了自动挂载 swap，需要去 /etc/fstab 里面注释掉挂载 swap 那一行&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 关闭 selinux&lt;/span&gt;
$ setenforce  &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;
$ sed -i &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;s/SELINUX=enforcing/SELINUX=disabled/&amp;#39;&lt;/span&gt; /etc/selinux/config

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 禁用 firewalld&lt;/span&gt;
$ systemctl stop firewalld
$ systemctl disable firewalld

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 禁用 NetworkManager&lt;/span&gt;
$ systemctl stop NetworkManager
$ systemctl disable NetworkManager

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 做一些 sysctl 的配置, kubernetes 要求&lt;/span&gt;
$ modprobe br_netfilter

$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/sysctl.conf
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;net.bridge.bridge-nf-call-iptables=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;net.bridge.bridge-nf-call-ip6tables=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;net.ipv4.ip_forward=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

$ sysctl -p

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 配置并开启 ipvs&lt;/span&gt;
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt; /etc/sysconfig/modules/ipvs.modules
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#!/bin/bash
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;ipvs_modules=&amp;#34;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;for kernel_module in \${ipvs_modules}; do
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    /sbin/modinfo -F filename \${kernel_module} &amp;gt; /dev/null 2&amp;gt;&amp;amp;1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    if [ $? -eq 0 ]; then
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;        /sbin/modprobe \${kernel_module}
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    fi
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;done
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

$ chmod &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;755&lt;/span&gt; /etc/sysconfig/modules/ipvs.modules &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; bash /etc/sysconfig/modules/ipvs.modules &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; lsmod &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; grep ip_vs&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;部署集群&#34;&gt;部署集群&lt;/h2&gt;



&lt;div class=&#34;alert alert-primary&#34; role=&#34;alert&#34;&gt;
&lt;h4 class=&#34;alert-heading&#34;&gt;提示&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;如果要部署高可用集群，请先搭建负载均衡集群，参考 &lt;a href=&#34;https://docs.yunion.io/docs/setup/controlplane-ha&#34;&gt;部署 HA 环境&lt;/a&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;


&lt;h3 id=&#34;安装部署工具&#34;&gt;安装部署工具&lt;/h3&gt;

&lt;p&gt;先安装部署工具 ocadm 和云平台的命令行工具 climc:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 安装 climc 云平台命令行工具 和 ocadm 部署工具&lt;/span&gt;
$ yum-config-manager --add-repo https://iso.yunion.cn/yumrepo-2.10/yunion.repo
$ yum install -y yunion-climc yunion-ocadm
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# climc 在 /opt/yunion/bin 目录下，根据自己的需要加到 bash 或者 zsh 配置文件里面&lt;/span&gt;
$ &lt;span style=&#34;color:#204a87&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;export PATH=$PATH:/opt/yunion/bin&amp;#39;&lt;/span&gt; &amp;gt;&amp;gt; ~/.bashrc &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;source&lt;/span&gt; ~/.bashrc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;部署-kubernetes-集群&#34;&gt;部署 kubernetes 集群&lt;/h3&gt;

&lt;p&gt;接下来会现在当前节点启动 v1.14.3 的 kubernetes 服务，然后部署 OneCloud 控制节点相关的服务到 kubernetes 集群。&lt;/p&gt;

&lt;p&gt;拉取必要的 docker 镜像&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ ocadm config images pull&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;使用 ocadm 部署 kubernetes 集群&lt;/p&gt;



&lt;div class=&#34;alert alert-primary&#34; role=&#34;alert&#34;&gt;
&lt;h4 class=&#34;alert-heading&#34;&gt;提示&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;如果要进行高可用部署，并已经搭建好了负载均衡集群，需要在 &lt;code&gt;ocadm init&lt;/code&gt; 命令加上 &lt;code&gt;--control-plane-endpoint &amp;lt;vip&amp;gt;:6443&lt;/code&gt; 参数，告诉 kubernetes 集群前端的 LoadBalancer vip，之后生成的配置就会都用这个 vip 当做控制节点的入口。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 假设 mariadb 部署在本地，如果是使用已有的数据库，请改变对应的 ip&lt;/span&gt;
$ &lt;span style=&#34;color:#000&#34;&gt;MYSQL_HOST&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;$(&lt;/span&gt;ip route get &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; awk &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;{print $NF;exit}&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 如果是高可用部署，记得在设置 EXTRA_OPT=&amp;#39; --control-plane-endpoint 10.168.222.18:6443&amp;#39;&lt;/span&gt;
$ &lt;span style=&#34;color:#000&#34;&gt;EXTRA_OPT&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;
$ &lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;#EXTRA_OPT=&amp;#39; --control-plane-endpoint 10.168.222.18:6443&amp;#39;&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 开始部署 kubernetes 以及 onecloud 必要的控制服务，稍等 3 分钟左右，kubernetes 集群会部署完成&lt;/span&gt;
$ ocadm init --mysql-host &lt;span style=&#34;color:#000&#34;&gt;$MYSQL_HOST&lt;/span&gt; --mysql-user root --mysql-password &lt;span style=&#34;color:#000&#34;&gt;$MYSQL_PASSWD&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;$EXTRA_OPT&lt;/span&gt;

...
Your Kubernetes and Onecloud control-plane has initialized successfully!
...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;div class=&#34;alert alert-primary&#34; role=&#34;alert&#34;&gt;
&lt;h4 class=&#34;alert-heading&#34;&gt;提示&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;kubernetes 高可用部署需要 3 个节点，主要是 etcd 需要至少 3 个节点组成高可用集群。如果是高可用部署，请在另外两个节点执行 &lt;code&gt;ocadm join --control-plane &amp;lt;vip&amp;gt;:6443&lt;/code&gt; 部署控制服务，join 的另外两个节点会自动和当前的控制节点组成高可用集群。参考: &lt;a href=&#34;https://docs.yunion.io/docs/setup/components/#%E5%8A%A0%E5%85%A5-controlplane&#34;&gt;加入控制节点&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;


&lt;p&gt;kubernetes 集群部署完成后，通过以下命令来确保相关的 pod (容器) 都已经启动, 变成 running 的状态。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ mkdir -p &lt;span style=&#34;color:#000&#34;&gt;$HOME&lt;/span&gt;/.kube
$ sudo cp -i /etc/kubernetes/admin.conf &lt;span style=&#34;color:#000&#34;&gt;$HOME&lt;/span&gt;/.kube/config
$ sudo chown &lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;$(&lt;/span&gt;id -u&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;)&lt;/span&gt;:&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;$(&lt;/span&gt;id -g&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;$HOME&lt;/span&gt;/.kube/config
$ kubectl get pods --all-namespaces
NAMESPACE            NAME                                       READY   STATUS    RESTARTS   AGE
kube-system          calico-kube-controllers-648bb4447c-57gjb   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          calico-node-j89jg                          &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          coredns-69845f69f6-f6wnv                   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          coredns-69845f69f6-sct6n                   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          etcd-lzx-ocadm-test2                       &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h
kube-system          kube-apiserver-lzx-ocadm-test2             &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h
kube-system          kube-controller-manager-lzx-ocadm-test2    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h
kube-system          kube-proxy-2fwgf                           &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          kube-scheduler-lzx-ocadm-test2             &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h
kube-system          traefik-ingress-controller-qwkfb           &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
local-path-storage   local-path-provisioner-5978cff7b7-7h8df    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
onecloud             onecloud-operator-6d4bddb8c4-tkjkh         &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          3h37m&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;创建-onecloud-集群&#34;&gt;创建 onecloud 集群&lt;/h3&gt;

&lt;p&gt;当 kubernetes 集群部署完成后，就可以通过 &lt;code&gt;ocadm cluster create&lt;/code&gt; 创建 onecloud 集群，该集群由 onecloud namespace 里面 &lt;strong&gt;onecloud-operator&lt;/strong&gt; deployment 自动部署和维护。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 创建集群&lt;/span&gt;
$ ocadm cluster create&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;执行完 &lt;code&gt;ocadm cluster create&lt;/code&gt; 命令后，&lt;strong&gt;onecloud-operator&lt;/strong&gt; 会自动创建各个服务组件对应的 pod，等待一段时间后，确保 onecloud namespace 里面的 keystone, region 和 glance 等 pod 都处于 running 状态。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 可以通过 watch 的方式查看各个服务 pod 的创建过程&lt;/span&gt;
$ kubectl get pods --namespace onecloud -w

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 当发现 web 相关的 pod 创建完成后，就可通过前端 web 界面访问云平台了&lt;/span&gt;
$ kubectl get pods --namespace onecloud &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; egrep &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;apigateway|web&amp;#39;&lt;/span&gt;
default-apigateway-f657c55c8-9tzpm     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;/2     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          118m
default-web-7778d95cb8-2xv6n           &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          118m
default-webconsole-5855c8b64f-jtqwn    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          119m&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;等待 &lt;strong&gt;default-web-&lt;/strong&gt; 相关的 pod 状态变为 Running 后，就可以通过访问 &amp;lsquo;https://本机IP:443&amp;rsquo; 登入前端界面。&lt;/p&gt;

&lt;h3 id=&#34;创建登录用户&#34;&gt;创建登录用户&lt;/h3&gt;

&lt;p&gt;当控制节点部署完成后，需要创建一个用于前端登录的用户。云平台的管理员认证信息由 &lt;code&gt;ocadm cluster rcadmin&lt;/code&gt; 命令可以得到 , 这些认证信息在使用 climc 控制云平台资源时会用到。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 获取连接 onecloud 集群的环境变量&lt;/span&gt;
$ ocadm cluster rcadmin
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_AUTH_URL&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;https://10.168.222.218:35357/v3
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_USERNAME&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;sysadmin
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_PASSWORD&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;3hV3qAhvxck84srk
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_PROJECT_NAME&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;system
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;YUNION_INSECURE&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt;
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_REGION_NAME&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;region0
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_ENDPOINT_TYPE&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;publicURL&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;div class=&#34;alert alert-primary&#34; role=&#34;alert&#34;&gt;
&lt;h4 class=&#34;alert-heading&#34;&gt;提示&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;如果是高可用部署，这些 endpoint 的 public url 会是 vip，如果要在 kubernetes 集群外访问需要到 haproxy 节点上添加对应的 frontend 和 backend，其中frontend的端口对应 endpoint 里面的端口，backend 对应 3 个 controlplane node 的 ip 和对应端口。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;


&lt;p&gt;创建用户&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 初始化连接集群的管理员认证信息&lt;/span&gt;
$ &lt;span style=&#34;color:#204a87&#34;&gt;source&lt;/span&gt; &amp;lt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;ocadm cluster rcadmin&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 设置想要创建的用户名和密码&lt;/span&gt;
$ &lt;span style=&#34;color:#000&#34;&gt;OC_USERNAME&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;demo
$ &lt;span style=&#34;color:#000&#34;&gt;OC_PASSWORD&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;demo@123

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 创建指定的用户&lt;/span&gt;
$ climc user-create --password &lt;span style=&#34;color:#000&#34;&gt;$OC_PASSWORD&lt;/span&gt; --enabled &lt;span style=&#34;color:#000&#34;&gt;$OC_USERNAME&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 将用户加入 system 项目并赋予 admin 角色&lt;/span&gt;
$ climc project-add-user system &lt;span style=&#34;color:#000&#34;&gt;$OC_USERNAME&lt;/span&gt; admin&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;访问前端&#34;&gt;访问前端&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 获取本机 IP&lt;/span&gt;
$ ip route get &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; awk &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;{print $NF;exit}&amp;#39;&lt;/span&gt;
&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.218

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 测试连通性&lt;/span&gt;
$ curl -k https://10.168.222.218&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;用浏览器访问 &amp;lsquo;https://本机IP&amp;rsquo; 会跳转到 web 界面，使用 &lt;a href=&#34;https://docs.yunion.io/docs/setup/controlplane/#创建登录用户&#34;&gt;创建登录用户&lt;/a&gt; 里面指定的用户名和密码登录后，界面如下:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;../images/web-login.png&#34; alt=&#34;登录页&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;../images/web-dashboard.png&#34; alt=&#34;首页&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;删除环境&#34;&gt;删除环境&lt;/h3&gt;

&lt;p&gt;如果安装过程中失败，或者想清理环境，可执行以下命令删除 kubernetes 集群。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ ocadm reset --force&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;后续&#34;&gt;后续&lt;/h2&gt;

&lt;p&gt;如果没有意外，现在应该已经部署好了 onecloud on kubernetes 的集群，以下是一些后续的环节说明，可以根据自己的需要来进行额外的操作。&lt;/p&gt;

&lt;h3 id=&#34;添加计算节点&#34;&gt;添加计算节点&lt;/h3&gt;

&lt;p&gt;当控制节点搭建完成后，可以参考 &lt;a href=&#34;https://docs.yunion.io/docs/setup/host/&#34;&gt;计算节点&lt;/a&gt; 一节的内容，添加计算节点，组建一套私有云集群。&lt;/p&gt;

&lt;h3 id=&#34;切换企业版前端&#34;&gt;切换企业版前端&lt;/h3&gt;

&lt;p&gt;默认情况下使用的 web 前端是开源版的，我们也提供企业版的 web 前端，可以使用 &lt;code&gt;ocadm component web&lt;/code&gt; 命令来切换前端:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 切换到企业版的 web 前端&lt;/span&gt;
$ ocadm component web use-ee

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 切换到开源版的 web 前端&lt;/span&gt;
$ ocadm component web use-ce&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;ocadm component web use-ee/use-ce&lt;/code&gt; 命令会更新替换当前的 default-web deployment，执行该命令后等到新的 pod 启动后，重新刷新前端页面，即可进入(开源版/企业版)前端。&lt;/p&gt;

&lt;h3 id=&#34;额外插件&#34;&gt;额外插件&lt;/h3&gt;

&lt;p&gt;onecloud 系统有一些非核心的额外组件可以通过 &lt;code&gt;ocadm component&lt;/code&gt; 命令来启用或者禁用，对应组件列表说明如下:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;名称&lt;/th&gt;
&lt;th&gt;功能&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;cloudmon&lt;/td&gt;
&lt;td&gt;多云监控组件&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;cloudwatcher&lt;/td&gt;
&lt;td&gt;优化建议组件&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;itsm&lt;/td&gt;
&lt;td&gt;流程工单组件&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;meter&lt;/td&gt;
&lt;td&gt;计费组件&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;meter-cloud&lt;/td&gt;
&lt;td&gt;计费组件&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;meter-service&lt;/td&gt;
&lt;td&gt;计费组件&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;meter-traffic&lt;/td&gt;
&lt;td&gt;计费组件&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;meteralert&lt;/td&gt;
&lt;td&gt;计费组件&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;这些组件并不是必需的，如果有需要，可以使用下面命令来管理:&lt;/p&gt;



&lt;div class=&#34;alert alert-warning&#34; role=&#34;alert&#34;&gt;
&lt;h4 class=&#34;alert-heading&#34;&gt;注意&lt;/h4&gt;
这些额外插件大部分是 java 编写，每个组件以 pod 的方式启动，会占用 1g 以上的内存，如果要启用，建议先参考 &lt;a href=&#34;https://docs.yunion.io/docs/setup/components/&#34;&gt;添加节点&lt;/a&gt; 添加更多的 kubernetes node 节点然后再启用这些组件。
&lt;/div&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启用所有组件，会占用更多 cpu/memory 的资源&lt;/span&gt;
$ ocadm component &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; all

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 禁用所有组件&lt;/span&gt;
$ ocadm component disable all

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启用某个组件，以 cloudmon 为例&lt;/span&gt;
$ ocadm component &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; cloudmon

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 禁用某个组件，以 cloudwatcher 为例&lt;/span&gt;
$ ocadm component disable cloudwatcher&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
      </description>
    </item>
    
    <item>
      <title>Docs: 添加节点</title>
      <link>https://docs.yunion.io/docs/setup/components/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>https://docs.yunion.io/docs/setup/components/</guid>
      <description>
        
        
        

&lt;p&gt;部署完集群后，整个 kubernetes 集群只有一个节点，onecloud 相关服务都运行在了该节点上，为了服务的高可用，我们可以继续添加节点到 kubernetes 集群。&lt;/p&gt;

&lt;h3 id=&#34;环境准备&#34;&gt;环境准备&lt;/h3&gt;

&lt;p&gt;参考 &lt;a href=&#34;https://docs.yunion.io/docs/setup/controlplane/#安装配置-docker&#34;&gt;&amp;ldquo;部署集群/环境准备&amp;rdquo;&lt;/a&gt; 的流程，安装好 docker 和 kubelet。&lt;/p&gt;

&lt;h3 id=&#34;获取加入集群-token&#34;&gt;获取加入集群 token&lt;/h3&gt;

&lt;p&gt;然后在控制节点使用 ocadm 拿到加入集群的 token，在待部署节点使用 ocadm 加入集群，操作如下:&lt;/p&gt;

&lt;p&gt;在&lt;strong&gt;控制节点&lt;/strong&gt;获取加入节点的 token&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ ocadm token list &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; grep bootstrap
4s4meb.xvgk2bwpmbospn3s   23h       &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2019&lt;/span&gt;-07-10T15:41:10+08:00   authentication,signing   The default bootstrap token generated by &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;ocadm init&amp;#39;&lt;/span&gt;.   system:bootstrappers:kubeadm:default-node-token&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;


&lt;div class=&#34;alert alert-primary&#34; role=&#34;alert&#34;&gt;
&lt;h4 class=&#34;alert-heading&#34;&gt;提示&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;如果 token 过期了，可以在管理节点使用 &lt;code&gt;ocadm token create&lt;/code&gt; 创建新的 token 。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;


&lt;h3 id=&#34;加入节点&#34;&gt;加入节点&lt;/h3&gt;

&lt;p&gt;加入已有 kubernetes 集群的节点有两种角色，&amp;rsquo;controlplane&amp;rsquo; 和 &amp;lsquo;node&amp;rsquo;。&lt;/p&gt;

&lt;p&gt;controlplane 角色的节点会运行 kube-apiserver、kube-controller-manager、kube-scheduler 和 etcd，加入 controlplane 节点的好处是让 kubernetes 控制相关服务和 etcd 变为高可用。&lt;/p&gt;

&lt;p&gt;node 角色的节点只会运行 kubelet，运行负载容器。&lt;/p&gt;

&lt;h4 id=&#34;加入-controlplane&#34;&gt;加入 controlplane&lt;/h4&gt;

&lt;p&gt;加入控制节点需要从已有的 kubernetes 集群下载证书，证书使用 certificate key 加密，通过以下方法获取 certificate-key&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ ocadm init phase upload-certs
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;upload-certs&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; Storing the certificates in Secret &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;kubeadm-certs&amp;#34;&lt;/span&gt; in the &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;kube-system&amp;#34;&lt;/span&gt; Namespace
&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;upload-certs&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt; Using certificate key:
afa5e18bacb3f50b424cbf815fce6d1bd916fe91b58ba467053dc6b460198c55&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 这里的 10.168.222.18 是控制节点的 ip，如果是高可用部署则为负载均衡器的 vip，请根据你的环境修改&lt;/span&gt;
$ ocadm join --control-plane &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.18:6443 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  --token 4s4meb.xvgk2bwpmbospn3s &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  --certificate-key afa5e18bacb3f50b424cbf815fce6d1bd916fe91b58ba467053dc6b460198c55 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  --discovery-token-unsafe-skip-ca-verification&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&#34;加入-node&#34;&gt;加入 node&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 这里的 10.168.222.18 是控制节点的 ip，如果是高可用部署则为负载均衡器的 vip, 请根据你的环境修改&lt;/span&gt;
$ ocadm join &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.18:6443 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  --token 4s4meb.xvgk2bwpmbospn3s &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  --discovery-token-unsafe-skip-ca-verification
...
This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;kubectl get nodes&amp;#39;&lt;/span&gt; on the control-plane to see this node join the cluster.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
      </description>
    </item>
    
    <item>
      <title>Docs: 计算节点</title>
      <link>https://docs.yunion.io/docs/setup/host/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>https://docs.yunion.io/docs/setup/host/</guid>
      <description>
        
        
        

&lt;p&gt;如果需要构建内部私有云，就需要部署计算节点(宿主机)。计算节点主要负责虚拟机、网络和存储的管理，需要安装的组件如下:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;组件&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;用途&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;安装方式&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;运行方式&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;host&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理 kvm 虚拟机和存储&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;-&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;docker&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;host-deployer&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;虚拟机部署服务&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;-&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;docker&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;sdnagent&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理虚拟机网络和安全组&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;openvswitch&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;虚拟机网络端口和流表配置&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;qemu&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;运行虚拟机&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;process&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;kernel&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;onecloud 提供的内核&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;-&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&#34;环境&#34;&gt;环境&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;操作系统: Centos 7.x&lt;/li&gt;
&lt;li&gt;硬件要求:

&lt;ul&gt;
&lt;li&gt;Virtualization: CPU 要支持虚拟化，用于虚拟机 KVM 加速&lt;/li&gt;
&lt;li&gt;打开 iommu，VT-d: 用于 GPU 透传(不用GPU可以不开)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;网络:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;当前可用的网段: 虚拟机可以直接使用和计算节点所在的扁平网段，需要预先划分保留对应端给云平台虚拟机使用，防止被其它设备占用，最后 IP 冲突&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;备注:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;如果是以测试为目的，可以拿一台虚拟机部署计算节点的服务，但可能无法使用 KVM 加速和 GPU 透传&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;安装依赖&#34;&gt;安装依赖&lt;/h2&gt;

&lt;p&gt;计算节点所需的依赖以 rpm 的方式安装&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 添加 yum 源&lt;/span&gt;
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/yum.repos.d/yunion.repo
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;[yunion]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;name=Packages for Yunion Multi-Cloud Platform
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;baseurl=https://iso.yunion.cn/yumrepo-2.10
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;sslverify=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;failovermethod=priority
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;enabled=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;gpgcheck=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 禁用防火墙和selinux&lt;/span&gt;
$ systemctl disable firewalld
$ sed -i &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;s/SELINUX=enforcing/SELINUX=disabled/g&amp;#39;&lt;/span&gt; /etc/selinux/config&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;安装 rpm 包&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ yum install -y &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  epel-release libaio jq libusb lvm2 nc &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  oniguruma pciutils spice spice-protocol sysstat tcpdump telegraf usbredir &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  yunion-qemu-2.12.1 yunion-host-image yunion-sdnagent yunion-executor-server &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  kernel-3.10.0-1062.4.3.el7.yn20191203 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  kernel-devel-3.10.0-1062.4.3.el7.yn20191203 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  kernel-headers-3.10.0-1062.4.3.el7.yn20191203 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  kmod-openvswitch-2.9.6-1.el7 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  openvswitch-2.9.6-1.el7

$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; --now yunion-host-sdnagent yunion-executor yunion-host-image

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 安装完成后需要重启进入我们的内核&lt;/span&gt;
$ reboot

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重启完成后，查看当前节点内核信息，确保为 yn 内核&lt;/span&gt;
$ uname -r
&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt;.10.0-862.14.4.el7.yn20190712.x86_64&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;安装-docker-和-kubelet&#34;&gt;安装 docker 和 kubelet&lt;/h3&gt;

&lt;p&gt;参考 &lt;a href=&#34;https://docs.yunion.io/docs/setup/controlplane/#安装配置-docker&#34;&gt;&amp;ldquo;部署集群/环境准备&amp;rdquo;&lt;/a&gt; 的流程，安装好 docker 和 kubelet。&lt;/p&gt;

&lt;h2 id=&#34;控制节点操作&#34;&gt;控制节点操作&lt;/h2&gt;

&lt;p&gt;以下操作在控制节点进行。&lt;/p&gt;

&lt;h3 id=&#34;创建计算节点所在的网段&#34;&gt;创建计算节点所在的网段&lt;/h3&gt;

&lt;p&gt;我的环境&lt;strong&gt;计算节点&lt;/strong&gt;的 ip 为 10.168.222.140，就创建一个对应的 &lt;strong&gt;计算节点(host)网段&lt;/strong&gt;。&lt;/p&gt;



&lt;div class=&#34;alert alert-primary&#34; role=&#34;alert&#34;&gt;
&lt;h4 class=&#34;alert-heading&#34;&gt;提示&lt;/h4&gt;
需要根据自己的计算节点环境创建对应的网段，如果不创建该网段，计算节点就没发注册进来。
&lt;/div&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 查看当前环境的 zone&lt;/span&gt;
$ climc zone-list
+--------------------------------------+-------+--------+----------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; ID                                   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Name  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Status &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Cloudregion_ID &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+-------+--------+----------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; f73a2120-1206-45fa-8d43-de374ab0f494 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; zone0 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; default        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+-------+--------+----------------+

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在 zone0 里面创建一个 wire bcast0，该资源抽象计算节点所在的二层广播域信息&lt;/span&gt;
$ climc wire-create zone0 bcast0 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1000&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在 wire bcast0 之上创建一个计算节点的网络，计算节点的 host 服务注册会用到，如果 host 注册时没有在云平台找到对应的网络，将会注册失败&lt;/span&gt;
$ climc network-create --gateway &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.1 --server-type baremetal bcast0 inf0 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.140 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.140 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;24&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;计算节点-host-操作&#34;&gt;计算节点(host)操作&lt;/h2&gt;

&lt;p&gt;以下操作在计算节点进行，计算节点也叫 host，私有云计算节点上面会运行 host 服务来管理 kvm 虚拟机。&lt;/p&gt;

&lt;h3 id=&#34;配置-host-服务&#34;&gt;配置 host 服务&lt;/h3&gt;

&lt;p&gt;参考 &lt;a href=&#34;https://docs.yunion.io/docs/setup/components/#获取加入集群-token&#34;&gt;&amp;ldquo;添加节点/获取加入集群token&amp;rdquo;&lt;/a&gt; 的流程获取join所需的信息&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 使用 ocadm join 来创建一台计算节点&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 可选参数 --host-networks: 配置host服务的网络，example: &amp;#39;eth0/br0/10.168.222.140&amp;#39;, eth0是物理网卡，br0是网桥名称，10.168.222.140是宿主机的ip&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 获取计算节点 IP&lt;/span&gt;
$ &lt;span style=&#34;color:#000&#34;&gt;host_addr&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;$(&lt;/span&gt;ip route get &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; awk &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;{print $NF;exit}&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;)&lt;/span&gt;
$ &lt;span style=&#34;color:#204a87&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;$host_addr&lt;/span&gt;
&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.140
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 可选参数 --host-local-image-path: 配置host服务磁盘的存储路径，example: &amp;#39;/opt/cloud/workspace/disks&amp;#39;&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 可选参数 --host-hostname: 配置宿主机的hostname, example: &amp;#39;node1&amp;#39;&lt;/span&gt;
$ ./ocadm join &lt;span style=&#34;color:#000&#34;&gt;$api_server_addr&lt;/span&gt; --token &lt;span style=&#34;color:#000&#34;&gt;$token&lt;/span&gt; --discovery-token-ca-cert-hash &lt;span style=&#34;color:#000&#34;&gt;$token_hash&lt;/span&gt; --enable-host-agent

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 然后等待宿主机上的host pod和host-deployer pod为running状态&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;控制节点启用-host&#34;&gt;控制节点启用 host&lt;/h2&gt;

&lt;p&gt;回到控制节点，启用刚才上报的计算节点，只有启用的宿主机才能运行虚拟机。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 使用 climc 查看注册的 host 列表&lt;/span&gt;
$ climc host-list
+--------------------------------------+-------------------------+-------------------+----------------+----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+-------------------------+--------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;                  ID                  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;          Name           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    Access_mac     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;   Access_ip    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;        Manager_URI         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Status  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; enabled &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; host_status &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; mem_size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; cpu_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; node_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;      sn       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; storage_type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; host_type  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         version         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; storage_size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+-------------------------+-------------------+----------------+----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+-------------------------+--------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 3830870e-a499-459d-89df-bb6979b5e1ff &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; lzx-allinone-standalone &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;00&lt;/span&gt;:22:39:4c:6c:e9 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.140 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; http://10.168.222.140:8885 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; running &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;false&lt;/span&gt;   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; online      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;8192&lt;/span&gt;     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;          &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Not Specified &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; rotate       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; hypervisor &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; master&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;7ab047419092301&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;50141&lt;/span&gt;        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+-------------------------+-------------------+----------------+----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+-------------------------+--------------+
***  Total: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; Pages: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; Limit: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;20&lt;/span&gt; Offset: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; Page: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;  ***

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动 host&lt;/span&gt;
$ climc host-enable lzx-allinone-standalone&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;创建虚拟机测试&#34;&gt;创建虚拟机测试&lt;/h2&gt;

&lt;h3 id=&#34;上传-cirrors-测试镜像&#34;&gt;上传 cirrors 测试镜像&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 下载 cirros 测试镜像&lt;/span&gt;
$ wget https://iso.yunion.cn/yumrepo-2.10/images/cirros-0.4.0-x86_64-disk.qcow2

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 将镜像上传到 glance&lt;/span&gt;
$ climc image-upload --format qcow2 --os-type Linux --min-disk &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10240&lt;/span&gt; cirros-0.4.0-x86_64-disk.qcow2 ./cirros-0.4.0-x86_64-disk.qcow2

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 查看上传的镜像&lt;/span&gt;
$ climc image-list
+--------------------------------------+--------------------------------+-------------+----------+-----------+----------+---------+--------+----------------------------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;                  ID                  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;              Name              &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Disk_format &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;   Size   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Is_public &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Min_disk &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Min_ram &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Status &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             Checksum             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+--------------------------------+-------------+----------+-----------+----------+---------+--------+----------------------------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 63f6f2af-4db2-4e30-85f5-0ad3baa27bd9 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; cirros-0.4.0-x86_64-disk.qcow2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; qcow2       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;22806528&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;false&lt;/span&gt;     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;30720&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; active &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 76dc07d1a730a92d0db7fb2d3c305ecd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+--------------------------------+-------------+----------+-----------+----------+---------+--------+----------------------------------+

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 如果使用虚拟机作为计算节点，存储可能不大，可以把镜像的默认大小30g调整到10g&lt;/span&gt;
$ climc image-update --min-disk &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10240&lt;/span&gt; cirros-0.4.0-x86_64-disk.qcow2&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;创建测试网络&#34;&gt;创建测试网络&lt;/h3&gt;

&lt;p&gt;下面是随机创建了一个主机间不可达的网络用于测试，如果有划分好的扁平二层可用网络，可以直接拿来给虚拟机使用。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ climc network-create --gateway &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.1 --server-type guest bcast0 vnet0 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.2 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.254 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;24&lt;/span&gt;
$ climc network-public vnet0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;创建虚拟机&#34;&gt;创建虚拟机&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 创建虚拟机 testvm01，512M内存, 1个CPU, 系统盘 10g, 第二块磁盘 5g 格式化为 ext4 并挂载到 /opt 的虚拟机&lt;/span&gt;
$ climc server-create  --auto-start --allow-delete &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;		--disk cirros-0.4.0-x86_64-disk.qcow2:10g --disk 5g:ext4:/opt &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;		--net vnet0 --ncpu &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; --mem-spec 512M testvm01

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 查看创建的虚拟机，1分钟后应该会变为 running 状态&lt;/span&gt;
$ climc server-list --details
+--------------------------------------+----------+--------------+--------------+-------+---------+------------+-----------+----------+-----------------------------+------------+---------+-------------------------+--------+-----------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;                  ID                  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;   Name   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Billing_type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;     IPs      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Disk  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Status  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; vcpu_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; vmem_size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Secgroup &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         Created_at          &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Hypervisor &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; os_type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;          Host           &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Tenant &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; is_system &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+----------+--------------+--------------+-------+---------+------------+-----------+----------+-----------------------------+------------+---------+-------------------------+--------+-----------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; bcda7d18-decc-4b5f-8654-2d201a84d1fb &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; testvm01 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; postpaid     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.254 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;35840&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; running &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;          &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;512&lt;/span&gt;       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Default  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2019&lt;/span&gt;-09-23T05:08:49.000000Z &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; kvm        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Linux   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; lzx-allinone-standalone &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; system &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;false&lt;/span&gt;     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+----------+--------------+--------------+-------+---------+------------+-----------+----------+-----------------------------+------------+---------+-------------------------+--------+-----------+
***  Total: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; Pages: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; Limit: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;20&lt;/span&gt; Offset: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; Page: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;  ***

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 获取虚拟机登录信息&lt;/span&gt;
$ climc server-logininfo testvm01
+-----------+------------------------------------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;   Field   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;                  Value                   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+-----------+------------------------------------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; login_key &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;49wqh5OWGW3jSr1A8RfrMoH69iRRECzaMZITBA&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; password  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; zS27FwwUFr96                             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; updated   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2019&lt;/span&gt;-09-23T05:11:29.306403Z              &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; username  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; root                                     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+-----------+------------------------------------------+

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在计算节点联通测试网络(如果你是直接用的二层网络，应该能直接 ping 通虚拟机的 ip 了，不需要做这一步)&lt;/span&gt;
$ ip address add &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.1/24 dev br0

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 用之前 server-logininfo 命令获取的用户名密码，直接登录到虚拟机里面&lt;/span&gt;
$ ssh root@10.20.30.254
PING &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.254 &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.254&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;56&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;84&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; bytes of data.
&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;64&lt;/span&gt; bytes from &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.254: &lt;span style=&#34;color:#000&#34;&gt;icmp_seq&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ttl&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;64&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;.31 ms

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 如果网络不通，也可以通过 vnc 的方式打开虚拟机的 tty 登录界面，操作如下&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 打开 vnc 链接，用浏览器打开下面的链接&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 打开 vnc 链接时会出现不安全认证，导致 websocket 无法握手，需要在浏览器信任 webconsole server 对应的 endpoint&lt;/span&gt;
$ climc endpoint-list --details &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; grep webconsole &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; grep public
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 3da1e476aa7b4ff68e206754aed72d8f &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; region0   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 16120e8f3eec46dc86c59b3e426b0502 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; webconsole      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; webconsole      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; https://10.168.222.218:8899         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; public    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 然后用浏览器访问下 https://10.168.222.218:8899 , 信任该链接即可&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在通过 webconsole-server 命令获取 vnc web 界面的链接地址，然后用浏览器打开该地址&lt;/span&gt;
$ climc webconsole-server testvm01
https://console.yunion.cn/web-console?access_token&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;FI-VXQSAonhzfSnxVTKCCbwHinp7swlRkmi-4p6s-4OfZpg6TG9YhWuwbHEUA1D7XoKu_w%3D%3D&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api_server&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;https%3A%2F%2F10.168.222.216%3A8899&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;65xB2kaE&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;vnc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
      </description>
    </item>
    
  </channel>
</rss>
