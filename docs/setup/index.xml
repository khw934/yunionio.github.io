<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Yunion Onecloud Documentation – 安装部署</title>
    <link>/docs/setup/</link>
    <description>Recent content in 安装部署 on Yunion Onecloud Documentation</description>
    <generator>Hugo -- gohugo.io</generator>
    
	  <atom:link href="/docs/setup/index.xml" rel="self" type="application/rss+xml" />
    
    
      
        
      
    
    
    <item>
      <title>Docs: 组件概览</title>
      <link>/docs/setup/intro/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>/docs/setup/intro/</guid>
      <description>
        
        
        &lt;p&gt;OneCloud 目前仅支持在 Centos 7 上运行，待部署组件/服务如下:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;服务组件&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;用途&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;安装方式&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;运行方式&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;mariadb&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;关系型数据库&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;docker&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;容器运行时&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;kubelet&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理 kubernetes pod&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;keystone&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;认证服务&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;region&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;api 控制器&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;scheduler&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;调度服务&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;glance&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;镜像存储&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;webconsole&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;虚拟机访问界面&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;influxdb&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;监控数据库&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;k8s deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;host&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理虚拟机&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;sdnagent&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理虚拟机网络&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;baremetal&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理物理机&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;kubernetes deployment&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;container&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;climc&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;命令行工具&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;shell&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ocadm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;部署服务管理工具&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;shell&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;其中 host 和 baremetal-agent 可以根据需求选择性部署:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;管理 kvm 虚拟机: 部署 host 和 sdnagent 服务&lt;/li&gt;
&lt;li&gt;管理物理机: 部署 baremetal-agent 服务&lt;/li&gt;
&lt;/ul&gt;

      </description>
    </item>
    
    <item>
      <title>Docs: 部署集群</title>
      <link>/docs/setup/controlplane/</link>
      <pubDate>Sat, 13 Apr 2019 13:01:57 +0800</pubDate>
      
      <guid>/docs/setup/controlplane/</guid>
      <description>
        
        
        

&lt;h2 id=&#34;环境准备&#34;&gt;环境准备&lt;/h2&gt;

&lt;p&gt;OneCloud 相关的组件运行在 kubernetes 之上，环境以及相关的软件依赖如下:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;操作系统: Centos 7.x&lt;/li&gt;
&lt;li&gt;数据库: mariadb (CentOS 7自带的版本：Ver 15.1 Distrib 5.5.56-MariaDB）&lt;/li&gt;
&lt;li&gt;docker: ce-18.09.1&lt;/li&gt;
&lt;li&gt;kubernetes: v1.14.3&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;安装配置-mariadb&#34;&gt;安装配置 mariadb&lt;/h3&gt;

&lt;p&gt;mariadb 作为服务数据持久化的数据库，可以部署在其它节点或者使用单独维护的。下面假设还没有部署 mariadb，在控制节点上安装设置 mariadb。&lt;/p&gt;

&lt;p&gt;为了方便运行维护，mariadb推荐打开两个参数设施：&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;skip_name_resolve：取消域名解析&lt;/li&gt;

&lt;li&gt;&lt;p&gt;expire_logs_days=30：设置binlog的超时时间为30天，超过30天的binglog自动删除&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ &lt;span style=&#34;color:#000&#34;&gt;MYSQL_PASSWD&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;your-sql-passwd&amp;#39;&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 安装 mariadb&lt;/span&gt;
$ yum install -y epel-release mariadb-server
$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; --now mariadb
$ mysqladmin -u root password &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$MYSQL_PASSWD&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;&lt;/span&gt;
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/my.cnf
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;[mysqld]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;datadir=/var/lib/mysql
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;socket=/var/lib/mysql/mysql.sock
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# Disabling symbolic-links is recommended to prevent assorted security risks
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;symbolic-links=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# Settings user and group are ignored when systemd is used.
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# If you need to run mysqld under a different user or group,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# customize your systemd unit file for mariadb according to the
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# instructions in http://fedoraproject.org/wiki/Systemd
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# skip domain name resolve
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;skip_name_resolve
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# auto delete binlog older than 30 days
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;expire_logs_days=30
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;[mysqld_safe]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;log-error=/var/log/mariadb/mariadb.log
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;pid-file=/var/run/mariadb/mariadb.pid
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;# include all files from the config directory
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;!includedir /etc/my.cnf.d
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

$ mysql -uroot -p&lt;span style=&#34;color:#000&#34;&gt;$MYSQL_PASSWD&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;-e &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#34;GRANT ALL ON *.* to &amp;#39;root&amp;#39;@&amp;#39;%&amp;#39; IDENTIFIED BY &amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;$MYSQL_PASSWD&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39; with grant option; FLUSH PRIVILEGES;&amp;#34;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;安装配置-docker&#34;&gt;安装配置 docker&lt;/h3&gt;

&lt;p&gt;安装 docker&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ yum install -y yum-utils
$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
$ yum install -y docker-ce-18.09.1 docker-ce-cli-18.09.1 containerd.io&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;配置 docker&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ mkdir /etc/docker
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/docker/daemon.json
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;{
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;bridge&amp;#34;: &amp;#34;none&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;iptables&amp;#34;: false,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;exec-opts&amp;#34;:
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    [
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;native.cgroupdriver=cgroupfs&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    ],
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;data-root&amp;#34;: &amp;#34;/opt/docker&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;live-restore&amp;#34;: true,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;log-driver&amp;#34;: &amp;#34;json-file&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;log-opts&amp;#34;:
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    {
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;max-size&amp;#34;: &amp;#34;100m&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    },
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;registry-mirrors&amp;#34;:
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    [
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;https://lje6zxpk.mirror.aliyuncs.com&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;https://lms7sxqp.mirror.aliyuncs.com&amp;#34;,
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;      &amp;#34;https://registry.docker-cn.com&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    ],
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;  &amp;#34;storage-driver&amp;#34;: &amp;#34;overlay2&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;}
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;启动 docker&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; --now docker&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;安装配置-kubelet&#34;&gt;安装配置 kubelet&lt;/h3&gt;

&lt;p&gt;从 aliyun 的 yum 源安装 kubernetes 1.14.3，并设置 kubelet 开机自启动&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/yum.repos.d/kubernetes.repo
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;[kubernetes]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;name=Kubernetes
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;enabled=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;gpgcheck=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;repo_gpgcheck=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;
$ yum install -y bridge-utils ipvsadm conntrack-tools jq kubelet-1.14.3-0 kubectl-1.14.3-0 kubeadm-1.14.3-0
$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; kubelet&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;安装完 kubernetes 相关的二进制后，还需要对系统做一些配置并启用 ipvs 作为 kube-proxy 内部的 service 负载均衡&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 禁用 swap&lt;/span&gt;
$ swapoff -a
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 如果设置了自动挂载 swap，需要去 /etc/fstab 里面注释掉挂载 swap 那一行&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 做一些 sysctl 的配置, kubernetes 要求&lt;/span&gt;
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt; /etc/sysctl.d/bridge.conf
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;net.bridge.bridge-nf-call-iptables=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;net.bridge.bridge-nf-call-ip6tables=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

$ modprobe br_netfilter

$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt; /etc/sysctl.d/ip_forward.conf
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;net.ipv4.ip_forward=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

$ sysctl -p

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 配置并开启 ipvs&lt;/span&gt;
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt; /etc/sysconfig/modules/ipvs.modules
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;#!/bin/bash
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;ipvs_modules=&amp;#34;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;for kernel_module in \${ipvs_modules}; do
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    /sbin/modinfo -F filename \${kernel_module} &amp;gt; /dev/null 2&amp;gt;&amp;amp;1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    if [ $? -eq 0 ]; then
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;        /sbin/modprobe \${kernel_module}
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;    fi
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;done
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

$ chmod &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;755&lt;/span&gt; /etc/sysconfig/modules/ipvs.modules &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; bash /etc/sysconfig/modules/ipvs.modules &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; lsmod &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; grep ip_vs&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;部署集群&#34;&gt;部署集群&lt;/h2&gt;

&lt;h3 id=&#34;安装部署工具&#34;&gt;安装部署工具&lt;/h3&gt;

&lt;p&gt;先安装部署工具 ocadm 和云平台的命令行工具 climc:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 安装 climc 云平台命令行工具&lt;/span&gt;
$ yum-config-manager --add-repo https://iso.yunion.cn/yumrepo-2.10/yunion.repo
$ yum install -y yunion-climc
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# climc 在 /opt/yunion/bin 目录下，根据自己的需要加到 bash 或者 zsh 配置文件里面&lt;/span&gt;
$ &lt;span style=&#34;color:#204a87&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;export PATH=$PATH:/opt/yunion/bin&amp;#39;&lt;/span&gt; &amp;gt;&amp;gt; ~/.bashrc &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;source&lt;/span&gt; ~/.bashrc

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 安装 ocadm&lt;/span&gt;
$ wget https://github.com/yunionio/ocadm/releases/download/v0.0.1/ocadm -P /opt/yunion/bin
$ chmod a+x /opt/yunion/bin/ocadm&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;部署-kubernetes-集群&#34;&gt;部署 kubernetes 集群&lt;/h3&gt;

&lt;p&gt;接下来会现在当前节点启动 v1.14.3 的 kubernetes 服务，然后部署 OneCloud 控制节点相关的服务到 kubernetes 集群。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 假设 mariadb 部署在本地，如果是使用已有的数据库，请改变对应的 ip&lt;/span&gt;
$ &lt;span style=&#34;color:#000&#34;&gt;MYSQL_HOST&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;$(&lt;/span&gt;ip route get &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; awk &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;{print $NF;exit}&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#204a87;font-weight:bold&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 拉取必要的 docker 镜像&lt;/span&gt;
$ ocadm config images pull

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 开始部署 kubernetes 以及 onecloud 必要的控制服务，稍等 3 分钟左右，kubernetes 集群会部署完成&lt;/span&gt;
$ ocadm init --mysql-host &lt;span style=&#34;color:#000&#34;&gt;$MYSQL_HOST&lt;/span&gt; --mysql-user root --mysql-password &lt;span style=&#34;color:#000&#34;&gt;$MYSQL_PASSWD&lt;/span&gt;
...
Your Kubernetes and Onecloud control-plane has initialized successfully!
...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;kubernetes 集群部署完成后，通过以下命令来确保相关的 pod (容器) 都已经启动, 变成 running 的状态。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ &lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;KUBECONFIG&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;/etc/kubernetes/admin.conf
$ kubectl get pods --all-namespaces
NAMESPACE            NAME                                       READY   STATUS    RESTARTS   AGE
kube-system          calico-kube-controllers-648bb4447c-57gjb   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          calico-node-j89jg                          &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          coredns-69845f69f6-f6wnv                   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          coredns-69845f69f6-sct6n                   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          etcd-lzx-ocadm-test2                       &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h
kube-system          kube-apiserver-lzx-ocadm-test2             &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h
kube-system          kube-controller-manager-lzx-ocadm-test2    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h
kube-system          kube-proxy-2fwgf                           &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
kube-system          kube-scheduler-lzx-ocadm-test2             &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h
kube-system          traefik-ingress-controller-qwkfb           &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
local-path-storage   local-path-provisioner-5978cff7b7-7h8df    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          5h1m
onecloud             onecloud-operator-6d4bddb8c4-tkjkh         &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          3h37m&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;创建-onecloud-集群&#34;&gt;创建 onecloud 集群&lt;/h3&gt;

&lt;p&gt;当 kubernetes 集群部署完成后，就可以通过 &lt;code&gt;ocadm cluster create&lt;/code&gt; 创建 onecloud 集群，该集群由 onecloud namespace 里面 &lt;strong&gt;onecloud-operator&lt;/strong&gt; deployment 自动部署和维护。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 创建集群&lt;/span&gt;
$ ocadm cluster create&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;执行完 &lt;code&gt;ocadm cluster create&lt;/code&gt; 命令后，&lt;strong&gt;onecloud-operator&lt;/strong&gt; 会自动创建各个服务组件对应的 pod，等待一段时间后，确保 onecloud namespace 里面的 keystone, region 和 glance 等 pod 都处于 running 状态。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 可以通过 watch 的方式查看各个服务 pod 的创建过程&lt;/span&gt;
$ kubectl get pods --namespace onecloud -w

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 当发现 web 相关的 pod 创建完成后，就可通过前端 web 界面访问云平台了&lt;/span&gt;
$ kubectl get pods --namespace onecloud &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; egrep &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;apigateway|web&amp;#39;&lt;/span&gt;
default-apigateway-f657c55c8-9tzpm     &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2&lt;/span&gt;/2     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          118m
default-web-7778d95cb8-2xv6n           &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          118m
default-webconsole-5855c8b64f-jtqwn    &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;/1     Running   &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;          119m&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;等待 &lt;strong&gt;default-web-&lt;/strong&gt; 相关的 pod 状态变为 Running 后，就可以通过访问 &amp;lsquo;https://本机IP:443&amp;rsquo; 登入前端界面。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 获取本机 IP&lt;/span&gt;
$ ip route get &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; awk &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;{print $NF;exit}&amp;#39;&lt;/span&gt;
&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.218

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 测试连通性&lt;/span&gt;
$ curl -k https://10.168.222.218&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;用浏览器访问 &amp;lsquo;https://本机IP&amp;rsquo; 会跳转到 web 界面，如果是第一次访问需要注册设置 cloudadmin 用户的密码，注册完成后登录的界面如下:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;../images/web.png&#34; alt=&#34;nnn&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;环境检查&#34;&gt;环境检查&lt;/h3&gt;

&lt;p&gt;当控制节点部署完成后，云平台的管理员认证信息由 &lt;code&gt;ocadm cluster rcadmin&lt;/code&gt; 命令可以得到 , 这些认证信息在使用 climc 控制云平台资源时会用到。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 获取连接 onecloud 集群的环境变量&lt;/span&gt;
$ ocadm cluster rcadmin
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_AUTH_URL&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;https://10.168.222.218:35357/v3
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_USERNAME&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;sysadmin
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_PASSWORD&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;3hV3qAhvxck84srk
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_PROJECT_NAME&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;system
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;YUNION_INSECURE&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt;
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_REGION_NAME&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;region0
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_ENDPOINT_TYPE&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;publicURL

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 测试链接&lt;/span&gt;
$ &lt;span style=&#34;color:#204a87&#34;&gt;source&lt;/span&gt; &amp;lt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;ocadm cluster rcadmin&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt;
$ climc endpoint-list
+----------------------------------+-----------+----------------------------------+----------------------------------+-----------+---------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;                ID                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Region_ID &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;            Service_ID            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;               URL                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Interface &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Enabled &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+----------------------------------+-----------+----------------------------------+----------------------------------+-----------+---------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; aa266549bbd743f4882fa1b1e98e409a &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; region0   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 106f7cf2410b4187879d4a44a737df0b &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; https://default-influxdb:8086    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; internal  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; ba59f23951e6452984b9d2036d303ade &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; region0   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 106f7cf2410b4187879d4a44a737df0b &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; https://10.168.222.218:8086      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; public    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 5b2981d751624c6b86a757e30676c528 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; region0   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; ee302d70e261452282ca66c86f85f2f7 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; https://default-webconsole:8899  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; internal  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 81c79509449f4f4581140adc030e5e57 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; region0   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; ee302d70e261452282ca66c86f85f2f7 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; https://10.168.222.218:8899      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; public    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;删除环境&#34;&gt;删除环境&lt;/h3&gt;

&lt;p&gt;如果安装过程中失败，或者想清理环境，可执行以下命令删除 kubernetes 集群。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ ocadm reset --force&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
      </description>
    </item>
    
    <item>
      <title>Docs: 添加节点</title>
      <link>/docs/setup/components/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>/docs/setup/components/</guid>
      <description>
        
        
        

&lt;p&gt;部署完集群后，整个 kubernetes 集群只有一个节点，onecloud 相关服务都运行在了该节点上，为了服务的高可用，我们可以继续添加节点到 kubernetes 集群。&lt;/p&gt;

&lt;h3 id=&#34;环境准备&#34;&gt;环境准备&lt;/h3&gt;

&lt;p&gt;参考 &lt;a href=&#34;/docs/setup/controlplane/##安装配置-docker&#34;&gt;&amp;ldquo;部署集群/环境准备&amp;rdquo;&lt;/a&gt; 的流程，安装好 docker 和 kubelet。&lt;/p&gt;

&lt;h3 id=&#34;获取加入集群-token&#34;&gt;获取加入集群 token&lt;/h3&gt;

&lt;p&gt;然后在控制节点使用 ocadm 拿到加入集群的 token，在待部署节点使用 ocadm 加入集群，操作如下:&lt;/p&gt;

&lt;p&gt;在&lt;strong&gt;控制节点&lt;/strong&gt;获取加入节点的 token&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ ocadm token list &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; grep bootstrap
4s4meb.xvgk2bwpmbospn3s   23h       &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2019&lt;/span&gt;-07-10T15:41:10+08:00   authentication,signing   The default bootstrap token generated by &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;ocadm init&amp;#39;&lt;/span&gt;.   system:bootstrappers:kubeadm:default-node-token&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;加入节点&#34;&gt;加入节点&lt;/h3&gt;

&lt;p&gt;加入已有 kubernetes 集群的节点有两种角色，&amp;rsquo;controlplane&amp;rsquo; 和 &amp;lsquo;node&amp;rsquo;。&lt;/p&gt;

&lt;p&gt;controlplane 角色的节点会运行 kube-apiserver、kube-controller-manager、kube-scheduler 和 etcd，加入 controlplane 节点的好处是让 kubernetes 控制相关服务和 etcd 变为高可用。&lt;/p&gt;

&lt;p&gt;node 角色的节点只会运行 kubelet，运行负载容器。&lt;/p&gt;

&lt;h4 id=&#34;加入-controlplane&#34;&gt;加入 controlplane&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 这里的 10.168.222.216 是控制节点的 ip，请根据你的环境修改&lt;/span&gt;
$ ocadm join --token 4s4meb.xvgk2bwpmbospn3s --discovery-token-unsafe-skip-ca-verification --control-plane &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.216:6443&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&#34;加入-node&#34;&gt;加入 node&lt;/h4&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 这里的 10.168.222.216 是控制节点的 ip，请根据你的环境修改&lt;/span&gt;
$ ocadm join &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.216:6443 --token 4s4meb.xvgk2bwpmbospn3s --discovery-token-unsafe-skip-ca-verification
...
This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;kubectl get nodes&amp;#39;&lt;/span&gt; on the control-plane to see this node join the cluster.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
      </description>
    </item>
    
    <item>
      <title>Docs: 计算节点</title>
      <link>/docs/setup/host/</link>
      <pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate>
      
      <guid>/docs/setup/host/</guid>
      <description>
        
        
        

&lt;p&gt;如果需要构建内部私有云，就需要部署计算节点(宿主机)。计算节点主要负责虚拟机、网络和存储的管理，需要安装的组件如下:&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;组件&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;用途&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;安装方式&lt;/th&gt;
&lt;th align=&#34;center&#34;&gt;运行方式&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;host&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理 kvm 虚拟机和存储&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;sdnagent&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;管理虚拟机网络和安全组&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;openvswitch&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;虚拟机网络端口和流表配置&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;systemd&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;qemu&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;运行虚拟机&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;process&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;kernel&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;onecloud 提供的内核&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;rpm&lt;/td&gt;
&lt;td align=&#34;center&#34;&gt;-&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&#34;环境&#34;&gt;环境&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;操作系统: Centos 7.x&lt;/li&gt;
&lt;li&gt;硬件要求:

&lt;ul&gt;
&lt;li&gt;Virtualization: CPU 要支持虚拟化，用于虚拟机 KVM 加速&lt;/li&gt;
&lt;li&gt;打开 iommu，VT-d: 用于 GPU 透传&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;网络:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;当前可用的网段: 虚拟机可以直接使用和计算节点所在的扁平网段，需要预先划分保留对应端给云平台虚拟机使用，防止被其它设备占用，最后 IP 冲突&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;备注:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;如果是以测试为目的，可以拿一台虚拟机部署计算节点的服务，但可能无法使用 KVM 加速和 GPU 透传&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;安装依赖&#34;&gt;安装依赖&lt;/h2&gt;

&lt;p&gt;计算节点所有的服务都以 rpm 的方式安装，因为虚拟机会用到内核 vfio 和 nbd 等特性，所以没有容器化部署。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 添加 yum 源&lt;/span&gt;
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/yum.repos.d/yunion.repo
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;[yunion]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;name=Packages for Yunion Multi-Cloud Platform
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;baseurl=https://iso.yunion.cn/yumrepo-2.10
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;sslverify=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;failovermethod=priority
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;enabled=1
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;gpgcheck=0
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 禁用防火墙和selinux&lt;/span&gt;
$ systemctl disable firewalld
$ sed -i &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;#39;s/SELINUX=enforcing/SELINUX=disabled/g&amp;#39;&lt;/span&gt; /etc/selinux/config&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;安装 rpm 包&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ yum install -y &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  epel-release chntpw dosfstools ethtool fetchclient fuse fuse-devel fuse-libs gdisk &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  libaio jq libusb lvm2 lxcfs lz4 nc ntfs-3g_ntfsprogs zerofree &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  oniguruma parted pciutils spice spice-protocol sshpass sysstat &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  tcpdump telegraf usbredir vmware-vddk xfsprogs &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  yunion-qemu-2.12.1 yunion-host yunion-host-image yunion-sdnagent &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  kernel-3.10.0-862.14.4.el7.yn20190116 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  kernel-devel-3.10.0-862.14.4.el7.yn20190116 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  kernel-headers-3.10.0-862.14.4.el7.yn20190116 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  kmod-openvswitch-2.9.3-1.el7 &lt;span style=&#34;color:#4e9a06&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;&lt;/span&gt;  openvswitch-2.9.3-1

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 安装完成后需要重启进入我们的内核&lt;/span&gt;
$ reboot

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 重启完成后，查看当前节点内核信息，确保为 yn 内核&lt;/span&gt;
$ uname -r
&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;3&lt;/span&gt;.10.0-862.14.4.el7.yn20190116.x86_64&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;控制节点操作&#34;&gt;控制节点操作&lt;/h2&gt;

&lt;h3 id=&#34;创建-host-服务的认证用户&#34;&gt;创建 host 服务的认证用户&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ &lt;span style=&#34;color:#204a87&#34;&gt;source&lt;/span&gt; /etc/yunion/rc_admin

$ cat /etc/yunion/rc_admin
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 这个是云平台 keystone 的认证地址，后面配置会用到&lt;/span&gt;
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_AUTH_URL&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;https://10.168.222.216:5000/v3
...
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 这个 region0 也会在配置中用到&lt;/span&gt;
&lt;span style=&#34;color:#204a87&#34;&gt;export&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;OS_REGION_NAME&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;region0

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 这里记住自己的用户密码，后面配置会用到&lt;/span&gt;
$ climc user-create --enabled --password hostadminpasswd hostadmin
$ climc project-add-user system hostadmin admin&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;创建计算节点所在的网段&#34;&gt;创建计算节点所在的网段&lt;/h3&gt;

&lt;p&gt;我的环境控制节点的 ip 为 10.168.222.218，就创建一个对应的 host 网段。需要根据自己的环境创建对应的网段。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 查看当前环境的 zone&lt;/span&gt;
$ climc zone-list
+--------------------------------------+-------+--------+----------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; ID &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Name &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Status &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Cloudregion_ID &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+-------+--------+----------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; f73a2120-1206-45fa-8d43-de374ab0f494 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; zone0 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; default        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+-------+--------+----------------+

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在 zone0 里面创建一个 wire bcast0，该资源抽象计算节点所在的二层广播域信息&lt;/span&gt;
$ climc wire-create zone0 bcast0 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1000&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在 wire bcast0 之上创建一个计算节点的网络，计算节点的 host 服务注册会用到，如果 host 注册时没有在云平台找到对应的网络，将会注册失败&lt;/span&gt;
$ climc network-create --gateway &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.1 --server-type baremetal bcast0 inf0 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.218 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.218 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;24&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;配置-host-服务&#34;&gt;配置 host 服务&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ mkdir -p /etc/yunion
$ cat &lt;span style=&#34;color:#4e9a06&#34;&gt;&amp;lt;&amp;lt;EOF &amp;gt;/etc/yunion/host.conf
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;region = &amp;#39;region0&amp;#39;   # 记得把这些认证信息参考控制节点的 rc_amdin 配置对应过来
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;address =  &amp;#39;10.168.222.218&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;port = 8885
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;auth_uri = &amp;#39;https://10.168.222.216:5000/v3&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;admin_user = &amp;#39;hostadmin&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;admin_password = &amp;#39;hostadminpasswd&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;admin_tenant_name = &amp;#39;system&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;networks = [&amp;#39;eth0/br0/10.168.222.218&amp;#39;]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;hostname = &amp;#39;$(hostname -s)&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;bridge_driver = &amp;#39;openvswitch&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;servers_path = &amp;#39;/opt/cloud/workspace/servers&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;snapshot_path = &amp;#39;/opt/cloud/workspace/disks/snapshots&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;local_image_path = [&amp;#39;/opt/cloud/workspace/disks&amp;#39;]
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;image_cache_path = &amp;#39;/opt/cloud/workspace/disks/image_cache&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;agent_temp_path = &amp;#39;/opt/cloud/workspace/disks/agent_tmp&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;rack  = &amp;#39;rack0&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;slots = &amp;#39;slot0&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;linux_default_root_user = True
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;allow_inter_tenant_broadcast = True
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;allow_inter_tenant_multicast = True
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;allow_inter_tenant_unicast = True
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;block_io_scheduler = &amp;#39;cfq&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;enable_template_backing = True
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;default_qemu_version = &amp;#39;2.12.1&amp;#39;
&lt;/span&gt;&lt;span style=&#34;color:#4e9a06&#34;&gt;EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;启动-host&#34;&gt;启动 host&lt;/h2&gt;

&lt;p&gt;配置完成后就可以使用 systemctl 启动 host 服务了，命令如下:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动&lt;/span&gt;
$ systemctl &lt;span style=&#34;color:#204a87&#34;&gt;enable&lt;/span&gt; yunion-host --now

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 观察启动日志&lt;/span&gt;
$ journalctl -u yunion-host -f
...
Jul &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;09&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;18&lt;/span&gt;:23:34 lzx-ocadm-test2 host&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4216&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;]&lt;/span&gt;: &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;[&lt;/span&gt;I &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;190709&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;18&lt;/span&gt;:23:34 metadata.StartService&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;metadatahandler.go:268&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)]&lt;/span&gt; Host Metadata Start listen on http://10.168.222.218:9885
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 出现上述信息表示 host 已经成功注册到了控制节点&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;控制节点启动-host&#34;&gt;控制节点启动 host&lt;/h2&gt;

&lt;p&gt;回到控制节点，启用刚才上报的计算节点&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 使用 climc 查看注册的 host 列表&lt;/span&gt;
$ climc host-list
+--------------------------------------+-----------------+-------------------+----------------+----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+-----------------+--------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;                  ID                  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;      Name       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;    Access_mac     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;   Access_ip    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;        Manager_URI         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Status  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; enabled &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; host_status &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; mem_size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; cpu_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; node_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;      sn       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; storage_type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; host_type  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;     version     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; storage_size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+-----------------+-------------------+----------------+----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+-----------------+--------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; cc053d7c-1456-4c72-8198-adc1f487df9d &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; lzx-ocadm-test2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;00&lt;/span&gt;:22:1b:c4:a4:81 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.168.222.218 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; http://10.168.222.218:8885 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; running &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;false&lt;/span&gt;   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; online      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4096&lt;/span&gt;     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;         &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;4&lt;/span&gt;          &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Not Specified &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; rotate       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; hypervisor &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; HEAD&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;5c8f4b19a&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;29982&lt;/span&gt;        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+-----------------+-------------------+----------------+----------------------------+---------+---------+-------------+----------+-----------+------------+---------------+--------------+------------+-----------------+--------------+
***  Total: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; Pages: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; Limit: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;20&lt;/span&gt; Offset: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt; Page: &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;  ***

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 启动 host&lt;/span&gt;
$ climc host-enable lzx-ocadm-test2&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&#34;创建虚拟机测试&#34;&gt;创建虚拟机测试&lt;/h2&gt;

&lt;h3 id=&#34;上传-cirrors-测试镜像&#34;&gt;上传 cirrors 测试镜像&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 下载 cirros 测试镜像&lt;/span&gt;
$ wget https://iso.yunion.cn/yumrepo-2.10/images/cirros-0.4.0-x86_64-disk.qcow2

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 将镜像上传到 glance&lt;/span&gt;
$ climc image-upload --format qcow2 --os-type Linux --min-disk &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10240&lt;/span&gt; cirros-0.4.0-x86_64-disk.qcow2 ./cirros-0.4.0-x86_64-disk.qcow2

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 查看上传的镜像&lt;/span&gt;
$ climc image-list
+--------------------------------------+--------------------------------+-------------+----------+-----------+----------+---------+--------+----------------------------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;                  ID                  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;              Name              &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Disk_format &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;   Size   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Is_public &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Min_disk &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Min_ram &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Status &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;             Checksum             &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+--------------------------------+-------------+----------+-----------+----------+---------+--------+----------------------------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 63f6f2af-4db2-4e30-85f5-0ad3baa27bd9 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; cirros-0.4.0-x86_64-disk.qcow2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; qcow2       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;22806528&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;false&lt;/span&gt;     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;30720&lt;/span&gt;    &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; active &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 76dc07d1a730a92d0db7fb2d3c305ecd &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+--------------------------------+-------------+----------+-----------+----------+---------+--------+----------------------------------+

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 如果使用虚拟机作为计算节点，存储可能不大，可以把镜像的默认大小30g调整到10g&lt;/span&gt;
$ climc image-update --min-disk &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10240&lt;/span&gt; cirros-0.4.0-x86_64-disk.qcow2&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;创建测试网络&#34;&gt;创建测试网络&lt;/h3&gt;

&lt;p&gt;下面是随机创建了一个主机间不可达的网络用于测试，如果有划分好的扁平二层可用网络，可以直接拿来给虚拟机使用。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ climc network-create --gateway &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.1 --server-type guest bcast0 vnet0 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.2 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.254 &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;24&lt;/span&gt;
$ climc network-public vnet0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&#34;创建虚拟机&#34;&gt;创建虚拟机&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 创建虚拟机 testvm01，512M内存, 1个CPU, 系统盘 10g, 第二块磁盘 5g 格式化为 ext4 并挂载到 /opt 的虚拟机&lt;/span&gt;
$ climc server-create --disk cirros-0.4.0-x86_64-disk.qcow2:10g --disk 5g:ext4:/opt --net vnet0 --auto-start --allow-delete --ncpu &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; testvm01 512M

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 查看创建的虚拟机，1分钟后应该会变为 running 状态&lt;/span&gt;
$ climc server-list --details
+--------------------------------------+----------+--------------+--------------+-------+---------+------------+-----------+----------+-----------------------------+------------+---------+-----------------+--------+-----------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;                  ID                  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;   Name   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Billing_type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;     IPs      &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Disk  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Status  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; vcpu_count &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; vmem_size &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Secgroup &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;         Created_at          &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Hypervisor &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; os_type &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;      Host       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Tenant &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; is_system &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+----------+--------------+--------------+-------+---------+------------+-----------+----------+-----------------------------+------------+---------+-----------------+--------+-----------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; f10c0083-9ee8-4353-86e2-67b9ac16f732 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; testvm01 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; postpaid     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.253 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;30720&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; running &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt;          &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;512&lt;/span&gt;       &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Default  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2019&lt;/span&gt;-07-09T13:12:16.000000Z &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; kvm        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Linux   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; lzx-ocadm-test2 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; system &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;false&lt;/span&gt;     &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+--------------------------------------+----------+--------------+--------------+-------+---------+------------+-----------+----------+-----------------------------+------------+---------+-----------------+--------+-----------+

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 获取虚拟机登录信息&lt;/span&gt;
$ climc server-logininfo testvm01
+----------+-----------------------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;  Field   &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;            Value            &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+----------+-----------------------------+
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; password &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; Bs5Zn6%Ry?9h                &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; updated  &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;2019&lt;/span&gt;-07-09T13:12:22.785767Z &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; username &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; root                        &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;
+----------+-----------------------------+

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在计算节点联通测试网络(如果你是直接用的二层网络，应该能直接 ping 通虚拟机的 ip 了，不需要做这一步)&lt;/span&gt;
$ ip address add &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.1/24 dev br0
$ ping &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.253
PING &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.253 &lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.253&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;56&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;84&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;)&lt;/span&gt; bytes of data.
&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;64&lt;/span&gt; bytes from &lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;10&lt;/span&gt;.20.30.253: &lt;span style=&#34;color:#000&#34;&gt;icmp_seq&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;ttl&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;64&lt;/span&gt; &lt;span style=&#34;color:#000&#34;&gt;time&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#0000cf;font-weight:bold&#34;&gt;0&lt;/span&gt;.984 ms

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 用之前 server-logininfo 命令获取的用户名密码，直接登录到虚拟机里面&lt;/span&gt;
$ ssh root@10.20.30.253

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 如果网络不通，也可以通过 vnc 的方式打开虚拟机的 tty 登录界面，操作如下&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 打开 vnc 链接，用浏览器打开下面的链接&lt;/span&gt;
&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 打开 vnc 链接时会出现不安全认证，导致 websocket 无法握手，需要在浏览器信任 webconsole server 对应的 endpoint&lt;/span&gt;
$ climc endpoint-list --details &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; grep webconsole
&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 67dcd7e163524526867d2a67c2162389 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; region0 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; 0c79be9a91f840c38d02930e9aa24dce &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; webconsole &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; webconsole &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; https://10.168.222.216:8899 &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; internal &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt; &lt;span style=&#34;color:#204a87&#34;&gt;true&lt;/span&gt; &lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;|&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 然后用浏览器访问下 https://10.168.222.216:8899 , 信任该链接即可&lt;/span&gt;

&lt;span style=&#34;color:#8f5902;font-style:italic&#34;&gt;# 在通过 webconsole-server 命令获取 vnc web 界面的链接地址&lt;/span&gt;
$ climc webconsole-server testvm01
https://console.yunion.cn/web-console?access_token&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;FI-VXQSAonhzfSnxVTKCCbwHinp7swlRkmi-4p6s-4OfZpg6TG9YhWuwbHEUA1D7XoKu_w%3D%3D&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;api_server&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;https%3A%2F%2F10.168.222.216%3A8899&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;65xB2kaE&lt;span style=&#34;color:#000;font-weight:bold&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span style=&#34;color:#000&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color:#ce5c00;font-weight:bold&#34;&gt;=&lt;/span&gt;vnc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
      </description>
    </item>
    
  </channel>
</rss>
