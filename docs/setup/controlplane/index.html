<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.57.2" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<title>部署集群 | Yunion Onecloud Documentation</title><meta property="og:title" content="部署集群" />
<meta property="og:description" content="部署 kubernetes 和 onecloud 服务，创建第一个控制节点
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/setup/controlplane/" />
<meta property="article:published_time" content="2019-04-13T13:01:57+08:00" />
<meta property="article:modified_time" content="2019-08-13T17:01:05+08:00" /><meta property="og:site_name" content="Yunion Onecloud Documentation" />
<meta itemprop="name" content="部署集群">
<meta itemprop="description" content="部署 kubernetes 和 onecloud 服务，创建第一个控制节点
">


<meta itemprop="datePublished" content="2019-04-13T13:01:57&#43;08:00" />
<meta itemprop="dateModified" content="2019-08-13T17:01:05&#43;08:00" />
<meta itemprop="wordCount" content="893">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="部署集群"/>
<meta name="twitter:description" content="部署 kubernetes 和 onecloud 服务，创建第一个控制节点
"/>





<link rel="preload" href="/scss/main.min.c3c3c588c0b1655ed632c9bef184b2845802123f5399eb013042e16252467639.css" as="style">
<link href="/scss/main.min.c3c3c588c0b1655ed632c9bef184b2845802123f5399eb013042e16252467639.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>


    <title>部署集群 | Yunion Onecloud Documentation</title>
  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-light  nav-shadow flex-column flex-md-row td-navbar">

	<a href="/" class="logo flex-shrink-0 navbar-brand">
		<img src="/images/logo.svg" alt="">
		<b>OneCloud</b>
	</a>

	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-lg-0">
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				<a class="nav-link" href="/docs/setup/controlplane/">快速开始</a>
			</li>
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				<a class="nav-link" href="/docs">文档</a>
			</li>
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				<a class="nav-link" href="https://github.com/yunionio/onecloud">Github</a>
			</li>
		</ul>
	</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <div class="td-sidebar__search d-flex align-items-center">
    
 <input type="input" class="form-control search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete="off">


 
  
 


<script type="text/javascript" src="/js/search.js"></script>


    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </div>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">文档</a>
  </li>
  <ul>
    <li class="collapse show" id="docs">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/setup/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">安装部署</a>
  </li>
  <ul>
    <li class="collapse show" id="docs-setup">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-setup-intro" href="/docs/setup/intro/">组件概览</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-setup-controlplane-ha" href="/docs/setup/controlplane-ha/">部署 HA 环境</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-docs-setup-controlplane" href="/docs/setup/controlplane/">部署集群</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-setup-components" href="/docs/setup/components/">添加节点</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-setup-host" href="/docs/setup/host/">计算节点</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/contribute/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">开发相关</a>
  </li>
  <ul>
    <li class="collapse " id="docs-contribute">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-contribute-contrib" href="/docs/contribute/contrib/">开发贡献</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-contribute-services" href="/docs/contribute/services/">服务组件介绍</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-contribute-framework" href="/docs/contribute/framework/">后端服务框架</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">操作管理</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/climc/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">命令行工具</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-climc">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/image/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">镜像</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-image">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-image-upload" href="/docs/howto/image/upload/">上传镜像</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-image-query" href="/docs/howto/image/query/">查询镜像</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-image-create" href="/docs/howto/image/create/">制作镜像</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-image-operation" href="/docs/howto/image/operation/">其他操作</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/server/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">云主机</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-server">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/server/create/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">创建云主机</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-server-create">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-server-connect" href="/docs/howto/server/connect/">登录云主机</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-server-others" href="/docs/howto/server/others/">其他操作</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-server-gpu" href="/docs/howto/server/gpu/">GPU相关</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-server-migrate" href="/docs/howto/server/migrate/">迁移相关</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-server-backup" href="/docs/howto/server/backup/">主备机</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/host/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">宿主机</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-host">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-host-kvm" href="/docs/howto/host/kvm/">KVM 宿主机</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/baremetal/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">物理机</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-baremetal">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-baremetal-intro" href="/docs/howto/baremetal/intro/">介绍</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-docs-howto-baremetal-operator" href="/docs/howto/baremetal/operator/">操作相关</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/network/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">网络</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-network">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/lb/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">负载均衡</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-lb">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/storage/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">存储</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-storage">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/multicloud/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">多云管理</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-multicloud">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/auth/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">认证与权限</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-auth">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/container/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">容器集群</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-container">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/scheduler/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">资源调度</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-scheduler">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/monitor/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Monitor</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-monitor">
      
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/docs/howto/meter/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Meter</a>
  </li>
  <ul>
    <li class="collapse " id="docs-howto-meter">
      
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
    
    
    
    
    
    <a href="https://github.com/yunionio/docs/edit/master/content/zh/docs/setup/controlplane.md" target="_blank"><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
    <a href="https://github.com/yunionio/docs/issues/new?title=%e9%83%a8%e7%bd%b2%e9%9b%86%e7%be%a4" target="_blank"><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>
    
    
    <a href="https://github.com/yunionio/onecloud/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a>
    
</div>






<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#环境准备">环境准备</a>
<ul>
<li><a href="#安装配置-mariadb">安装配置 mariadb</a></li>
<li><a href="#安装配置-docker">安装配置 docker</a></li>
<li><a href="#安装配置-kubelet">安装配置 kubelet</a></li>
</ul></li>
<li><a href="#部署集群">部署集群</a>
<ul>
<li><a href="#安装部署工具">安装部署工具</a></li>
<li><a href="#部署-kubernetes-集群">部署 kubernetes 集群</a></li>
<li><a href="#创建-onecloud-集群">创建 onecloud 集群</a></li>
<li><a href="#环境检查">环境检查</a></li>
<li><a href="#删除环境">删除环境</a></li>
</ul></li>
</ul></li>
</ul>
</nav>




          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="/docs/">文档</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/setup/">安装部署</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/setup/controlplane/">部署集群</a>
</li>

	</ol>
</nav	>

            
<div class="td-content">
	<h1>部署集群</h1>
	<div class="lead">部署 kubernetes 和 onecloud 服务，创建第一个控制节点</div>
	

<h2 id="环境准备">环境准备</h2>

<p>OneCloud 相关的组件运行在 kubernetes 之上，环境以及相关的软件依赖如下:</p>

<ul>
<li>操作系统: Centos 7.x</li>
<li>数据库: mariadb (CentOS 7自带的版本：Ver 15.1 Distrib 5.5.56-MariaDB）</li>
<li>docker: ce-18.09.1</li>
<li>kubernetes: v1.14.3</li>
</ul>

<h3 id="安装配置-mariadb">安装配置 mariadb</h3>

<p>mariadb 作为服务数据持久化的数据库，可以部署在其它节点或者使用单独维护的。下面假设还没有部署 mariadb，在控制节点上安装设置 mariadb。</p>

<p>为了方便运行维护，mariadb推荐打开两个参数设施：</p>

<ul>
<li>skip_name_resolve：取消域名解析</li>

<li><p>expire_logs_days=30：设置binlog的超时时间为30天，超过30天的binglog自动删除</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#000">MYSQL_PASSWD</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;your-sql-passwd&#39;</span>
<span style="color:#8f5902;font-style:italic"># 安装 mariadb</span>
$ yum install -y epel-release mariadb-server
$ systemctl <span style="color:#204a87">enable</span> --now mariadb
$ mysqladmin -u root password <span style="color:#4e9a06">&#34;</span><span style="color:#000">$MYSQL_PASSWD</span><span style="color:#4e9a06">&#34;</span>
$ cat <span style="color:#4e9a06">&lt;&lt;EOF &gt;/etc/my.cnf
</span><span style="color:#4e9a06">[mysqld]
</span><span style="color:#4e9a06">datadir=/var/lib/mysql
</span><span style="color:#4e9a06">socket=/var/lib/mysql/mysql.sock
</span><span style="color:#4e9a06"># Disabling symbolic-links is recommended to prevent assorted security risks
</span><span style="color:#4e9a06">symbolic-links=0
</span><span style="color:#4e9a06"># Settings user and group are ignored when systemd is used.
</span><span style="color:#4e9a06"># If you need to run mysqld under a different user or group,
</span><span style="color:#4e9a06"># customize your systemd unit file for mariadb according to the
</span><span style="color:#4e9a06"># instructions in http://fedoraproject.org/wiki/Systemd
</span><span style="color:#4e9a06"># skip domain name resolve
</span><span style="color:#4e9a06">skip_name_resolve
</span><span style="color:#4e9a06"># auto delete binlog older than 30 days
</span><span style="color:#4e9a06">expire_logs_days=30
</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">[mysqld_safe]
</span><span style="color:#4e9a06">log-error=/var/log/mariadb/mariadb.log
</span><span style="color:#4e9a06">pid-file=/var/run/mariadb/mariadb.pid
</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">#
</span><span style="color:#4e9a06"># include all files from the config directory
</span><span style="color:#4e9a06">#
</span><span style="color:#4e9a06">!includedir /etc/my.cnf.d
</span><span style="color:#4e9a06">EOF</span>

$ mysql -uroot -p<span style="color:#000">$MYSQL_PASSWD</span> <span style="color:#4e9a06">\
</span><span style="color:#4e9a06"></span>-e <span style="color:#4e9a06">&#34;GRANT ALL ON *.* to &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;</span><span style="color:#000">$MYSQL_PASSWD</span><span style="color:#4e9a06">&#39; with grant option; FLUSH PRIVILEGES;&#34;</span></code></pre></div></li>
</ul>

<h3 id="安装配置-docker">安装配置 docker</h3>

<p>安装 docker</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ yum install -y yum-utils
$ yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
$ yum install -y docker-ce-18.09.1 docker-ce-cli-18.09.1 containerd.io</code></pre></div>
<p>配置 docker</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir /etc/docker
$ cat <span style="color:#4e9a06">&lt;&lt;EOF &gt;/etc/docker/daemon.json
</span><span style="color:#4e9a06">{
</span><span style="color:#4e9a06">  &#34;bridge&#34;: &#34;none&#34;,
</span><span style="color:#4e9a06">  &#34;iptables&#34;: false,
</span><span style="color:#4e9a06">  &#34;exec-opts&#34;:
</span><span style="color:#4e9a06">    [
</span><span style="color:#4e9a06">      &#34;native.cgroupdriver=cgroupfs&#34;
</span><span style="color:#4e9a06">    ],
</span><span style="color:#4e9a06">  &#34;data-root&#34;: &#34;/opt/docker&#34;,
</span><span style="color:#4e9a06">  &#34;live-restore&#34;: true,
</span><span style="color:#4e9a06">  &#34;log-driver&#34;: &#34;json-file&#34;,
</span><span style="color:#4e9a06">  &#34;log-opts&#34;:
</span><span style="color:#4e9a06">    {
</span><span style="color:#4e9a06">      &#34;max-size&#34;: &#34;100m&#34;
</span><span style="color:#4e9a06">    },
</span><span style="color:#4e9a06">  &#34;registry-mirrors&#34;:
</span><span style="color:#4e9a06">    [
</span><span style="color:#4e9a06">      &#34;https://lje6zxpk.mirror.aliyuncs.com&#34;,
</span><span style="color:#4e9a06">      &#34;https://lms7sxqp.mirror.aliyuncs.com&#34;,
</span><span style="color:#4e9a06">      &#34;https://registry.docker-cn.com&#34;
</span><span style="color:#4e9a06">    ],
</span><span style="color:#4e9a06">  &#34;storage-driver&#34;: &#34;overlay2&#34;
</span><span style="color:#4e9a06">}
</span><span style="color:#4e9a06">EOF</span></code></pre></div>
<p>启动 docker</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ systemctl <span style="color:#204a87">enable</span> --now docker</code></pre></div>
<h3 id="安装配置-kubelet">安装配置 kubelet</h3>

<p>从 aliyun 的 yum 源安装 kubernetes 1.14.3，并设置 kubelet 开机自启动</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat <span style="color:#4e9a06">&lt;&lt;EOF &gt;/etc/yum.repos.d/kubernetes.repo
</span><span style="color:#4e9a06">[kubernetes]
</span><span style="color:#4e9a06">name=Kubernetes
</span><span style="color:#4e9a06">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span><span style="color:#4e9a06">enabled=1
</span><span style="color:#4e9a06">gpgcheck=0
</span><span style="color:#4e9a06">repo_gpgcheck=0
</span><span style="color:#4e9a06">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span><span style="color:#4e9a06">EOF</span>
$ yum install -y bridge-utils ipvsadm conntrack-tools jq kubelet-1.14.3-0 kubectl-1.14.3-0 kubeadm-1.14.3-0
$ systemctl <span style="color:#204a87">enable</span> kubelet</code></pre></div>
<p>安装完 kubernetes 相关的二进制后，还需要对系统做一些配置并启用 ipvs 作为 kube-proxy 内部的 service 负载均衡</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># 禁用 swap</span>
$ swapoff -a
<span style="color:#8f5902;font-style:italic"># 如果设置了自动挂载 swap，需要去 /etc/fstab 里面注释掉挂载 swap 那一行</span>

<span style="color:#8f5902;font-style:italic"># 做一些 sysctl 的配置, kubernetes 要求</span>
$ cat <span style="color:#4e9a06">&lt;&lt;EOF &gt; /etc/sysctl.d/bridge.conf
</span><span style="color:#4e9a06">net.bridge.bridge-nf-call-iptables=1
</span><span style="color:#4e9a06">net.bridge.bridge-nf-call-ip6tables=1
</span><span style="color:#4e9a06">EOF</span>

$ modprobe br_netfilter

$ cat <span style="color:#4e9a06">&lt;&lt;EOF &gt; /etc/sysctl.d/ip_forward.conf
</span><span style="color:#4e9a06">net.ipv4.ip_forward=1
</span><span style="color:#4e9a06">EOF</span>

$ sysctl -p

<span style="color:#8f5902;font-style:italic"># 配置并开启 ipvs</span>
$ cat <span style="color:#4e9a06">&lt;&lt;EOF &gt; /etc/sysconfig/modules/ipvs.modules
</span><span style="color:#4e9a06">#!/bin/bash
</span><span style="color:#4e9a06">ipvs_modules=&#34;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4&#34;
</span><span style="color:#4e9a06">for kernel_module in \${ipvs_modules}; do
</span><span style="color:#4e9a06">    /sbin/modinfo -F filename \${kernel_module} &gt; /dev/null 2&gt;&amp;1
</span><span style="color:#4e9a06">    if [ $? -eq 0 ]; then
</span><span style="color:#4e9a06">        /sbin/modprobe \${kernel_module}
</span><span style="color:#4e9a06">    fi
</span><span style="color:#4e9a06">done
</span><span style="color:#4e9a06">EOF</span>

$ chmod <span style="color:#0000cf;font-weight:bold">755</span> /etc/sysconfig/modules/ipvs.modules <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> bash /etc/sysconfig/modules/ipvs.modules <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> lsmod <span style="color:#000;font-weight:bold">|</span> grep ip_vs</code></pre></div>
<h2 id="部署集群">部署集群</h2>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">提示</h4>
<blockquote>
<p>如果要部署高可用集群，请先搭建负载均衡集群，参考 <a href="/docs/setup/controlplane-ha">部署 HA 环境</a>。</p>
</blockquote>
</div>


<h3 id="安装部署工具">安装部署工具</h3>

<p>先安装部署工具 ocadm 和云平台的命令行工具 climc:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># 安装 climc 云平台命令行工具</span>
$ yum-config-manager --add-repo https://iso.yunion.cn/yumrepo-2.10/yunion.repo
$ yum install -y yunion-climc
<span style="color:#8f5902;font-style:italic"># climc 在 /opt/yunion/bin 目录下，根据自己的需要加到 bash 或者 zsh 配置文件里面</span>
$ <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;export PATH=$PATH:/opt/yunion/bin&#39;</span> &gt;&gt; ~/.bashrc <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">source</span> ~/.bashrc

<span style="color:#8f5902;font-style:italic"># 安装 ocadm</span>
$ wget https://github.com/yunionio/ocadm/releases/download/v0.0.1/ocadm -P /opt/yunion/bin
$ chmod a+x /opt/yunion/bin/ocadm</code></pre></div>
<h3 id="部署-kubernetes-集群">部署 kubernetes 集群</h3>

<p>接下来会现在当前节点启动 v1.14.3 的 kubernetes 服务，然后部署 OneCloud 控制节点相关的服务到 kubernetes 集群。</p>

<p>拉取必要的 docker 镜像</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ocadm config images pull</code></pre></div>
<p>使用 ocadm 部署 kubernetes 集群</p>



<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">提示</h4>
<blockquote>
<p>如果要进行高可用部署，并已经搭建好了负载均衡集群，需要在 <code>ocadm init</code> 命令加上 <code>--control-plane-endpoint &lt;vip&gt;:6443</code> 参数，告诉 kubernetes 集群前端的 LoadBalancer vip，之后生成的配置就会都用这个 vip 当做控制节点的入口。</p>
</blockquote>
</div>

<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># 假设 mariadb 部署在本地，如果是使用已有的数据库，请改变对应的 ip</span>
$ <span style="color:#000">MYSQL_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>ip route get <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $NF;exit}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>

<span style="color:#8f5902;font-style:italic"># 如果是高可用部署，记得在设置 EXTRA_OPT=&#39; --control-plane-endpoint 10.168.222.18:6443&#39;</span>
$ <span style="color:#000">EXTRA_OPT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>
$ <span style="color:#8f5902;font-style:italic">#EXTRA_OPT=&#39; --control-plane-endpoint 10.168.222.18:6443&#39;</span>

<span style="color:#8f5902;font-style:italic"># 开始部署 kubernetes 以及 onecloud 必要的控制服务，稍等 3 分钟左右，kubernetes 集群会部署完成</span>
$ ocadm init --mysql-host <span style="color:#000">$MYSQL_HOST</span> --mysql-user root --mysql-password <span style="color:#000">$MYSQL_PASSWD</span> <span style="color:#000">$EXTRA_OPT</span>

...
Your Kubernetes and Onecloud control-plane has initialized successfully!
...</code></pre></div>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">提示</h4>
<blockquote>
<p>kubernetes 高可用部署需要 3 个节点，主要是 etcd 需要至少 3 个节点组成高可用集群。如果是高可用部署，请在另外两个节点执行 <code>ocadm join --control-plane &lt;vip&gt;:6443</code> 部署控制服务，join 的另外两个节点会自动和当前的控制节点组成高可用集群。参考: <a href="/docs/setup/components/#%E5%8A%A0%E5%85%A5-controlplane">加入控制节点</a></p>
</blockquote>
</div>


<p>kubernetes 集群部署完成后，通过以下命令来确保相关的 pod (容器) 都已经启动, 变成 running 的状态。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#204a87">export</span> <span style="color:#000">KUBECONFIG</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/admin.conf
$ kubectl get pods --all-namespaces
NAMESPACE            NAME                                       READY   STATUS    RESTARTS   AGE
kube-system          calico-kube-controllers-648bb4447c-57gjb   <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h1m
kube-system          calico-node-j89jg                          <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h1m
kube-system          coredns-69845f69f6-f6wnv                   <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h1m
kube-system          coredns-69845f69f6-sct6n                   <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h1m
kube-system          etcd-lzx-ocadm-test2                       <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h
kube-system          kube-apiserver-lzx-ocadm-test2             <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h
kube-system          kube-controller-manager-lzx-ocadm-test2    <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h
kube-system          kube-proxy-2fwgf                           <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h1m
kube-system          kube-scheduler-lzx-ocadm-test2             <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h
kube-system          traefik-ingress-controller-qwkfb           <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h1m
local-path-storage   local-path-provisioner-5978cff7b7-7h8df    <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5h1m
onecloud             onecloud-operator-6d4bddb8c4-tkjkh         <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          3h37m</code></pre></div>
<h3 id="创建-onecloud-集群">创建 onecloud 集群</h3>

<p>当 kubernetes 集群部署完成后，就可以通过 <code>ocadm cluster create</code> 创建 onecloud 集群，该集群由 onecloud namespace 里面 <strong>onecloud-operator</strong> deployment 自动部署和维护。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># 创建集群</span>
$ ocadm cluster create</code></pre></div>
<p>执行完 <code>ocadm cluster create</code> 命令后，<strong>onecloud-operator</strong> 会自动创建各个服务组件对应的 pod，等待一段时间后，确保 onecloud namespace 里面的 keystone, region 和 glance 等 pod 都处于 running 状态。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># 可以通过 watch 的方式查看各个服务 pod 的创建过程</span>
$ kubectl get pods --namespace onecloud -w

<span style="color:#8f5902;font-style:italic"># 当发现 web 相关的 pod 创建完成后，就可通过前端 web 界面访问云平台了</span>
$ kubectl get pods --namespace onecloud <span style="color:#000;font-weight:bold">|</span> egrep <span style="color:#4e9a06">&#39;apigateway|web&#39;</span>
default-apigateway-f657c55c8-9tzpm     <span style="color:#0000cf;font-weight:bold">2</span>/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          118m
default-web-7778d95cb8-2xv6n           <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          118m
default-webconsole-5855c8b64f-jtqwn    <span style="color:#0000cf;font-weight:bold">1</span>/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          119m</code></pre></div>
<p>等待 <strong>default-web-</strong> 相关的 pod 状态变为 Running 后，就可以通过访问 &lsquo;https://本机IP:443&rsquo; 登入前端界面。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># 获取本机 IP</span>
$ ip route get <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $NF;exit}&#39;</span>
<span style="color:#0000cf;font-weight:bold">10</span>.168.222.218

<span style="color:#8f5902;font-style:italic"># 测试连通性</span>
$ curl -k https://10.168.222.218</code></pre></div>
<p>用浏览器访问 &lsquo;https://本机IP&rsquo; 会跳转到 web 界面，如果是第一次访问需要注册设置 cloudadmin 用户的密码，注册完成后登录的界面如下:</p>

<p><img src="../images/web.png" alt="nnn" /></p>

<h3 id="环境检查">环境检查</h3>

<p>当控制节点部署完成后，云平台的管理员认证信息由 <code>ocadm cluster rcadmin</code> 命令可以得到 , 这些认证信息在使用 climc 控制云平台资源时会用到。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8f5902;font-style:italic"># 获取连接 onecloud 集群的环境变量</span>
$ ocadm cluster rcadmin
<span style="color:#204a87">export</span> <span style="color:#000">OS_AUTH_URL</span><span style="color:#ce5c00;font-weight:bold">=</span>https://10.168.222.218:35357/v3
<span style="color:#204a87">export</span> <span style="color:#000">OS_USERNAME</span><span style="color:#ce5c00;font-weight:bold">=</span>sysadmin
<span style="color:#204a87">export</span> <span style="color:#000">OS_PASSWORD</span><span style="color:#ce5c00;font-weight:bold">=</span>3hV3qAhvxck84srk
<span style="color:#204a87">export</span> <span style="color:#000">OS_PROJECT_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>system
<span style="color:#204a87">export</span> <span style="color:#000">YUNION_INSECURE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
<span style="color:#204a87">export</span> <span style="color:#000">OS_REGION_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>region0
<span style="color:#204a87">export</span> <span style="color:#000">OS_ENDPOINT_TYPE</span><span style="color:#ce5c00;font-weight:bold">=</span>publicURL</code></pre></div>


<div class="alert alert-primary" role="alert">
<h4 class="alert-heading">提示</h4>
<blockquote>
<p>如果是高可用部署，这些 endpoint 的 public url 会是 vip，如果要在 kubernetes 集群外访问需要到 haproxy 节点上添加对应的 frontend 和 backend，其中frontend的端口对应 endpoint 里面的端口，backend 对应 3 个 controlplane node 的 ip 和对应端口。</p>
</blockquote>
</div>


<p>测试链接</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ <span style="color:#204a87">source</span> &lt;<span style="color:#ce5c00;font-weight:bold">(</span>ocadm cluster rcadmin<span style="color:#ce5c00;font-weight:bold">)</span>
$ climc endpoint-list
+----------------------------------+-----------+----------------------------------+----------------------------------+-----------+---------+
<span style="color:#000;font-weight:bold">|</span>                ID                <span style="color:#000;font-weight:bold">|</span> Region_ID <span style="color:#000;font-weight:bold">|</span>            Service_ID            <span style="color:#000;font-weight:bold">|</span>               URL                <span style="color:#000;font-weight:bold">|</span> Interface <span style="color:#000;font-weight:bold">|</span> Enabled <span style="color:#000;font-weight:bold">|</span>
+----------------------------------+-----------+----------------------------------+----------------------------------+-----------+---------+
<span style="color:#000;font-weight:bold">|</span> aa266549bbd743f4882fa1b1e98e409a <span style="color:#000;font-weight:bold">|</span> region0   <span style="color:#000;font-weight:bold">|</span> 106f7cf2410b4187879d4a44a737df0b <span style="color:#000;font-weight:bold">|</span> https://default-influxdb:8086    <span style="color:#000;font-weight:bold">|</span> internal  <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">true</span>    <span style="color:#000;font-weight:bold">|</span>
<span style="color:#000;font-weight:bold">|</span> ba59f23951e6452984b9d2036d303ade <span style="color:#000;font-weight:bold">|</span> region0   <span style="color:#000;font-weight:bold">|</span> 106f7cf2410b4187879d4a44a737df0b <span style="color:#000;font-weight:bold">|</span> https://10.168.222.218:8086      <span style="color:#000;font-weight:bold">|</span> public    <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">true</span>    <span style="color:#000;font-weight:bold">|</span>
<span style="color:#000;font-weight:bold">|</span> 5b2981d751624c6b86a757e30676c528 <span style="color:#000;font-weight:bold">|</span> region0   <span style="color:#000;font-weight:bold">|</span> ee302d70e261452282ca66c86f85f2f7 <span style="color:#000;font-weight:bold">|</span> https://default-webconsole:8899  <span style="color:#000;font-weight:bold">|</span> internal  <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">true</span>    <span style="color:#000;font-weight:bold">|</span>
<span style="color:#000;font-weight:bold">|</span> 81c79509449f4f4581140adc030e5e57 <span style="color:#000;font-weight:bold">|</span> region0   <span style="color:#000;font-weight:bold">|</span> ee302d70e261452282ca66c86f85f2f7 <span style="color:#000;font-weight:bold">|</span> https://10.168.222.218:8899      <span style="color:#000;font-weight:bold">|</span> public    <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">true</span>    <span style="color:#000;font-weight:bold">|</span>
...</code></pre></div>
<h3 id="删除环境">删除环境</h3>

<p>如果安装过程中失败，或者想清理环境，可执行以下命令删除 kubernetes 集群。</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ocadm reset --force</code></pre></div>
	
		<style>
  .feedback--answer {
    display: inline-block;
  }
  .feedback--answer-no {
    margin-left: 1em;
  }
  .feedback--response {
    display: none;
    margin-top: 1em;
  }
  .feedback--response__visible {
    display: block;
  }
</style>
<h2 class="feedback--title">Feedback</h2>
<p class="feedback--question">Was this page helpful?</p>
<button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
  Glad to hear it! Please <a href="https://github.com/yunionio/docs/issues/new">tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
  Sorry to hear that. Please <a href="https://github.com/yunionio/docs/issues/new">tell us how we can improve</a>.
</p>
<script>
  const yesButton = document.querySelector('.feedback--answer-yes');
  const noButton = document.querySelector('.feedback--answer-no');
  const yesResponse = document.querySelector('.feedback--response-yes');
  const noResponse = document.querySelector('.feedback--response-no');
  const disableButtons = () => {
    yesButton.disabled = true;
    noButton.disabled = true;
  };
  const sendFeedback = (value) => {
    if (typeof ga !== 'function') return;
    const args = {
      command: 'send',
      hitType: 'event',
      category: 'Helpful',
      action: 'click',
      label: window.location.pathname,
      value: value
    };
    ga(args.command, args.hitType, args.category, args.action, args.label, args.value);
  };
  yesButton.addEventListener('click', () => {
    yesResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(1);
  });
  noButton.addEventListener('click', () => {
    noResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(0);
  });
</script>

		<br />
	
	
	<div class="text-muted mt-5 pt-3 border-top">Last modified 13.08.2019: <a  href="https://github.com/yunionio/docs/commit/6844a40af27768f5a9bb46c2782180c219fee3b1">添加 ha 部署，服务框架介绍的文档 (6844a40)</a>
</div>
</div>


          </main>
        </div>
      </div>
      

    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>





<script src="/js/main.min.7b50e46a4d678dead3e0004b8f665cd640085d2539954f51d57c7346b9a92d74.js" integrity="sha256-e1Dkak1njerT4ABLj2Zc1kAIXSU5lU9R1XxzRrmpLXQ="></script>



  </body>
</html>